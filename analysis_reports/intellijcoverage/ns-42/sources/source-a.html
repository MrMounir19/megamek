


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ScenarioLoader</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.server</a>
</div>

<h1>Coverage Summary for Class: ScenarioLoader (megamek.server)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ScenarioLoader</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/492)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ScenarioLoader$1</td>
  </tr>
  <tr>
    <td class="name">ScenarioLoader$CritHit</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ScenarioLoader$CritHitPlan</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ScenarioLoader$DamagePlan</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ScenarioLoader$ScenarioLoaderException</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ScenarioLoader$SetAmmoPlan</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ScenarioLoader$SetAmmoTo</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ScenarioLoader$SetAmmoType</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ScenarioLoader$SpecDam</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ScenarioLoader$StringMultiMap</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/576)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek - Copyright (C) 2003, 2004, 2005 Ben Mazur (bmazur@sev.org)
&nbsp; * ScenarioLoader - Copyright (C) 2002 Josh Yockey
&nbsp; * Copyright © 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;package megamek.server;
&nbsp;
&nbsp;import java.io.BufferedReader;
&nbsp;import java.io.File;
&nbsp;import java.io.FileInputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStreamReader;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Collection;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.IllegalFormatException;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.LinkedList;
&nbsp;import java.util.List;
&nbsp;import java.util.Locale;
&nbsp;import java.util.Map;
&nbsp;import java.util.Queue;
&nbsp;import java.util.regex.Matcher;
&nbsp;import java.util.regex.Pattern;
&nbsp;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.client.generator.RandomGenderGenerator;
&nbsp;import megamek.client.ui.swing.tileset.MMStaticDirectoryManager;
&nbsp;import megamek.client.ui.swing.util.PlayerColour;
&nbsp;import megamek.common.AmmoType;
&nbsp;import megamek.common.BattleArmor;
&nbsp;import megamek.common.Board;
&nbsp;import megamek.common.Compute;
&nbsp;import megamek.common.Configuration;
&nbsp;import megamek.common.Coords;
&nbsp;import megamek.common.Crew;
&nbsp;import megamek.common.CriticalSlot;
&nbsp;import megamek.common.Entity;
&nbsp;import megamek.common.EquipmentType;
&nbsp;import megamek.common.Game;
&nbsp;import megamek.common.HitData;
&nbsp;import megamek.common.IAero;
&nbsp;import megamek.common.IArmorState;
&nbsp;import megamek.common.IBoard;
&nbsp;import megamek.common.IGame;
&nbsp;import megamek.common.IPlayer;
&nbsp;import megamek.common.IStartingPositions;
&nbsp;import megamek.common.Infantry;
&nbsp;import megamek.common.MapSettings;
&nbsp;import megamek.common.Mech;
&nbsp;import megamek.common.MechFileParser;
&nbsp;import megamek.common.MechSummary;
&nbsp;import megamek.common.MechSummaryCache;
&nbsp;import megamek.common.Mounted;
&nbsp;import megamek.common.Player;
&nbsp;import megamek.common.Protomech;
&nbsp;import megamek.common.SimpleTechLevel;
&nbsp;import megamek.common.Tank;
&nbsp;import megamek.common.TechConstants;
&nbsp;import megamek.common.ToHitData;
&nbsp;import megamek.common.WeaponType;
&nbsp;import megamek.common.enums.Gender;
&nbsp;import megamek.common.icons.AbstractIcon;
&nbsp;import megamek.common.icons.Camouflage;
&nbsp;import megamek.common.loaders.EntityLoadingException;
&nbsp;import megamek.common.options.IOption;
&nbsp;import megamek.common.options.OptionsConstants;
&nbsp;import megamek.common.util.BoardUtilities;
&nbsp;import megamek.common.util.StringUtil;
&nbsp;import megamek.common.util.fileUtils.MegaMekFile;
&nbsp;
&nbsp;public class ScenarioLoader {
&nbsp;    private static final String COMMENT_MARK = &quot;#&quot;;
&nbsp;    
&nbsp;    private static final String SEPARATOR_PROPERTY = &quot;=&quot;;
&nbsp;    private static final String SEPARATOR_COMMA = &quot;,&quot;;
&nbsp;    private static final String SEPARATOR_SPACE = &quot; &quot;;
&nbsp;    private static final String SEPARATOR_COLON = &quot;:&quot;;
&nbsp;    private static final String SEPARATOR_UNDERSCORE = &quot;_&quot;;
&nbsp;
&nbsp;    private static final String FILE_SUFFIX_BOARD = &quot;.board&quot;;
&nbsp;
&nbsp;    private static final String PARAM_MMSVERSION = &quot;MMSVersion&quot;;
&nbsp;    private static final String PARAM_GAME_OPTIONS_FILE = &quot;GameOptionsFile&quot;;
&nbsp;    private static final String PARAM_GAME_EXTERNAL_ID = &quot;ExternalId&quot;;
&nbsp;    private static final String PARAM_FACTIONS = &quot;Factions&quot;;
&nbsp;
&nbsp;    private static final String PARAM_MAP_WIDTH = &quot;MapWidth&quot;;
&nbsp;    private static final String PARAM_MAP_HEIGHT = &quot;MapHeight&quot;;
&nbsp;    private static final String PARAM_BOARD_WIDTH = &quot;BoardWidth&quot;;
&nbsp;    private static final String PARAM_BOARD_HEIGHT = &quot;BoardHeight&quot;;
&nbsp;    private static final String PARAM_BRIDGE_CF = &quot;BridgeCF&quot;;
&nbsp;    private static final String PARAM_MAPS = &quot;Maps&quot;;
&nbsp;    private static final String PARAM_MAP_DIRECTORIES = &quot;RandomDirs&quot;;
&nbsp;
&nbsp;    private static final String PARAM_TEAM = &quot;Team&quot;;
&nbsp;    private static final String PARAM_LOCATION = &quot;Location&quot;;
&nbsp;    private static final String PARAM_MINEFIELDS = &quot;Minefields&quot;;
&nbsp;    private static final String PARAM_DAMAGE = &quot;Damage&quot;;
&nbsp;    private static final String PARAM_SPECIFIC_DAMAGE = &quot;DamageSpecific&quot;;
&nbsp;    private static final String PARAM_CRITICAL_HIT = &quot;CritHit&quot;;
&nbsp;    private static final String PARAM_AMMO_AMOUNT = &quot;SetAmmoTo&quot;;
&nbsp;    private static final String PARAM_AMMO_TYPE = &quot;SetAmmoType&quot;;
&nbsp;    private static final String PARAM_PILOT_HITS = &quot;PilotHits&quot;;
&nbsp;    private static final String PARAM_EXTERNAL_ID = &quot;ExternalID&quot;;
&nbsp;    private static final String PARAM_ADVANTAGES = &quot;Advantages&quot;;
&nbsp;    private static final String PARAM_AUTO_EJECT = &quot;AutoEject&quot;;
&nbsp;    private static final String PARAM_COMMANDER = &quot;Commander&quot;;
&nbsp;    private static final String PARAM_DEPLOYMENT_ROUND = &quot;DeploymentRound&quot;;
&nbsp;    private static final String PARAM_CAMO = &quot;Camo&quot;;
&nbsp;    private static final String PARAM_ALTITUDE = &quot;Altitude&quot;;
&nbsp;
&nbsp;    private static final String MAP_RANDOM = &quot;RANDOM&quot;;
&nbsp;
&nbsp;    private final File scenarioFile;
&nbsp;    // copied from ChatLounge.java
<b class="nc">&nbsp;    private final List&lt;DamagePlan&gt; damagePlans = new ArrayList&lt;&gt;();</b>
&nbsp;    // Used to store Crit Hits
<b class="nc">&nbsp;    private final List&lt;CritHitPlan&gt; critHitPlans = new ArrayList&lt;&gt;();</b>
&nbsp;    // Used to set ammo Spec Ammounts
<b class="nc">&nbsp;    private final List&lt;SetAmmoPlan&gt; ammoPlans = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;    public ScenarioLoader(File f) {</b>
<b class="nc">&nbsp;        scenarioFile = f;</b>
&nbsp;    }
&nbsp;    
&nbsp;    // TODO: legal/valid ammo type handling and game options, since they are set at this point
&nbsp;    private AmmoType getValidAmmoType(IGame game, Mounted mounted, String ammoString) {
<b class="nc">&nbsp;        final Entity e = mounted.getEntity();</b>
<b class="nc">&nbsp;        final int year = game.getOptions().intOption(OptionsConstants.ALLOWED_YEAR);</b>
<b class="nc">&nbsp;        final EquipmentType currentAmmoType = mounted.getType();</b>
<b class="nc">&nbsp;        final Mounted currentWeapon = mounted.getLinkedBy();</b>
<b class="nc">&nbsp;        final EquipmentType currentWeaponType = (null != currentWeapon) ? currentWeapon.getType() : null;</b>
<b class="nc">&nbsp;        final EquipmentType newAmmoType = EquipmentType.get(ammoString);</b>
<b class="nc">&nbsp;        if (newAmmoType == null) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(String.format(&quot;Ammo type &#39;%s&#39; not found&quot;, ammoString));</b>
<b class="nc">&nbsp;            return null;</b>
<b class="nc">&nbsp;        } else if (!(newAmmoType instanceof AmmoType)) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(String.format(&quot;Equipment %s is not an ammo type&quot;, newAmmoType.getName()));</b>
<b class="nc">&nbsp;            return null;</b>
<b class="nc">&nbsp;        } else if (!newAmmoType.isLegal(year, SimpleTechLevel.getGameTechLevel(game), e.isClan(), e.isMixedTech())) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().warning(String.format(&quot;Ammo %s (TL %d) is not legal for year %d (TL %d)&quot;,</b>
<b class="nc">&nbsp;                    newAmmoType.getName(), newAmmoType.getTechLevel(year), year,</b>
<b class="nc">&nbsp;                    TechConstants.getGameTechLevel(game, e.isClan())));</b>
<b class="nc">&nbsp;            return null;</b>
<b class="nc">&nbsp;        } else if (e.isClan() &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ALLOWED_CLAN_IGNORE_EQ_LIMITS)) {</b>
&nbsp;            // Check for clan weapon restrictions
<b class="nc">&nbsp;            final long muniType = ((AmmoType) newAmmoType).getMunitionType() &amp; ~AmmoType.M_INCENDIARY_LRM;</b>
<b class="nc">&nbsp;            if ((muniType == AmmoType.M_SEMIGUIDED) || (muniType == AmmoType.M_SWARM_I)</b>
&nbsp;                || (muniType == AmmoType.M_THUNDER_AUGMENTED) || (muniType == AmmoType.M_THUNDER_INFERNO)
&nbsp;                || (muniType == AmmoType.M_THUNDER_VIBRABOMB) || (muniType == AmmoType.M_THUNDER_ACTIVE)
&nbsp;                || (muniType == AmmoType.M_INFERNO_IV) || (muniType == AmmoType.M_VIBRABOMB_IV)
&nbsp;                || (muniType == AmmoType.M_LISTEN_KILL) || (muniType == AmmoType.M_ANTI_TSM)
&nbsp;                || (muniType == AmmoType.M_DEAD_FIRE) || (muniType == AmmoType.M_MINE_CLEARANCE)) {
<b class="nc">&nbsp;                MegaMek.getLogger().warning(String.format(&quot;Ammo type %s not allowed by Clan rules&quot;, newAmmoType.getName()));</b>
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (AmmoType.canDeliverMinefield((AmmoType) newAmmoType)</b>
<b class="nc">&nbsp;                &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVANCED_MINEFIELDS)) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().warning(String.format(&quot;Minefield-creating ammo type %s forbidden by game rules&quot;,</b>
<b class="nc">&nbsp;                    newAmmoType.getName()));</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int weaponAmmoType = (currentWeaponType instanceof WeaponType) ? ((WeaponType) currentWeaponType).getAmmoType() : 0;</b>
<b class="nc">&nbsp;        if ((((AmmoType) newAmmoType).getRackSize() == ((AmmoType) currentAmmoType).getRackSize())</b>
<b class="nc">&nbsp;                &amp;&amp; (newAmmoType.hasFlag(AmmoType.F_BATTLEARMOR) == currentAmmoType.hasFlag(AmmoType.F_BATTLEARMOR))</b>
<b class="nc">&nbsp;                &amp;&amp; (newAmmoType.hasFlag(AmmoType.F_ENCUMBERING) == currentAmmoType.hasFlag(AmmoType.F_ENCUMBERING))</b>
<b class="nc">&nbsp;                &amp;&amp; (newAmmoType.getTonnage(e) == currentAmmoType.getTonnage(e))</b>
<b class="nc">&nbsp;                &amp;&amp; (((AmmoType) newAmmoType).getAmmoType() == weaponAmmoType)) {</b>
<b class="nc">&nbsp;            return (AmmoType) newAmmoType;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * The damage procedures are built into a server object, so we delay dealing
&nbsp;     * the random damage until a server is made available to us.
&nbsp;     */
&nbsp;    public void applyDamage(Server s) {
<b class="nc">&nbsp;        for (DamagePlan damagePlan : damagePlans) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().debug(String.format(&quot;Applying damage to %s&quot;, damagePlan.entity.getShortName()));</b>
<b class="nc">&nbsp;            for (int y = 0; y &lt; damagePlan.nBlocks; ++ y) {</b>
<b class="nc">&nbsp;                HitData hit = damagePlan.entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</b>
<b class="nc">&nbsp;                MegaMek.getLogger().debug(&quot;[s.damageEntity(dp.entity, hit, 5)]&quot;);</b>
<b class="nc">&nbsp;                s.damageEntity(damagePlan.entity, hit, 5);</b>
&nbsp;            }
&nbsp;
&nbsp;            // Apply Spec Damage
<b class="nc">&nbsp;            for (SpecDam specDamage : damagePlan.specificDammage) {</b>
<b class="nc">&nbsp;                if (damagePlan.entity.locations() &lt;= specDamage.loc) {</b>
&nbsp;                    // location is valid
<b class="nc">&nbsp;                    MegaMek.getLogger().error(String.format(&quot;\tInvalid location specified %d&quot;, specDamage.loc));</b>
&nbsp;                } else {
&nbsp;                    // Infantry only take damage to &quot;internal&quot;
<b class="nc">&nbsp;                    if (specDamage.internal</b>
&nbsp;                        || ((damagePlan.entity instanceof Infantry) &amp;&amp; !(damagePlan.entity instanceof BattleArmor))) {
<b class="nc">&nbsp;                        if (damagePlan.entity.getOInternal(specDamage.loc) &gt; specDamage.setArmorTo) {</b>
<b class="nc">&nbsp;                            damagePlan.entity.setInternal(specDamage.setArmorTo, specDamage.loc);</b>
<b class="nc">&nbsp;                            MegaMek.getLogger().debug(String.format(&quot;\tSet armor value for (internal %s) to %d&quot;,</b>
<b class="nc">&nbsp;                                    damagePlan.entity.getLocationName(specDamage.loc), specDamage.setArmorTo));</b>
<b class="nc">&nbsp;                            if (specDamage.setArmorTo == 0) {</b>
<b class="nc">&nbsp;                                MegaMek.getLogger().debug(String.format(&quot;\tSection destoyed %s&quot;,</b>
<b class="nc">&nbsp;                                        damagePlan.entity.getLocationName(specDamage.loc)));</b>
<b class="nc">&nbsp;                                damagePlan.entity.destroyLocation(specDamage.loc);</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    } else {
<b class="nc">&nbsp;                        if (specDamage.rear &amp;&amp; damagePlan.entity.hasRearArmor(specDamage.loc)) {</b>
<b class="nc">&nbsp;                            if (damagePlan.entity.getOArmor(specDamage.loc, true) &gt; specDamage.setArmorTo) {</b>
<b class="nc">&nbsp;                                MegaMek.getLogger().debug(String.format(&quot;\tSet armor value for (rear %s) to %d&quot;,</b>
<b class="nc">&nbsp;                                        damagePlan.entity.getLocationName(specDamage.loc), specDamage.setArmorTo));</b>
<b class="nc">&nbsp;                                damagePlan.entity.setArmor(specDamage.setArmorTo, specDamage.loc, true);</b>
&nbsp;                            }
&nbsp;                        } else {
<b class="nc">&nbsp;                            if (damagePlan.entity.getOArmor(specDamage.loc, false) &gt; specDamage.setArmorTo) {</b>
<b class="nc">&nbsp;                                MegaMek.getLogger().debug(String.format(&quot;\tSet armor value for (%s) to %d&quot;,</b>
<b class="nc">&nbsp;                                        damagePlan.entity.getLocationName(specDamage.loc), specDamage.setArmorTo));</b>
&nbsp;
&nbsp;                                // Battle Armor Handled Differently
&nbsp;                                // If armor set to Zero kill the Armor sport
&nbsp;                                // which represents one member of the squad
<b class="nc">&nbsp;                                if (damagePlan.entity instanceof BattleArmor) {</b>
<b class="nc">&nbsp;                                    if (specDamage.setArmorTo == 0) {</b>
<b class="nc">&nbsp;                                        damagePlan.entity.setArmor(IArmorState.ARMOR_DOOMED, specDamage.loc, false);</b>
<b class="nc">&nbsp;                                        damagePlan.entity.setInternal(IArmorState.ARMOR_DOOMED, specDamage.loc);</b>
&nbsp;                                    } else {
&nbsp;                                        // For some reason setting armor to 1 will result in 2 armor points
&nbsp;                                        // left on the GUI. Dont know why but adjust here!
<b class="nc">&nbsp;                                        damagePlan.entity.setArmor(specDamage.setArmorTo - 1, specDamage.loc);</b>
&nbsp;                                    }
&nbsp;                                } else {
<b class="nc">&nbsp;                                    damagePlan.entity.setArmor(specDamage.setArmorTo, specDamage.loc);</b>
&nbsp;                                }
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // Loop throught Crit Hits
<b class="nc">&nbsp;        for (CritHitPlan chp : critHitPlans) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().debug(&quot;Applying critical hits to &quot; + chp.entity.getShortName());</b>
<b class="nc">&nbsp;            for (CritHit critHit : chp.critHits) {</b>
&nbsp;                // Apply a critical hit to the indicated slot.
<b class="nc">&nbsp;                if (chp.entity.locations() &lt;= critHit.loc) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(&quot;Invalid location specified &quot; + critHit.loc);</b>
&nbsp;                } else {
&nbsp;                    // Make sure that we have crit spot to hit
<b class="nc">&nbsp;                    if ((chp.entity instanceof Mech) || (chp.entity instanceof Protomech)) {</b>
&nbsp;                        // Is this a torso weapon slot?
<b class="nc">&nbsp;                        CriticalSlot cs = null;</b>
<b class="nc">&nbsp;                        if ((chp.entity instanceof Protomech)</b>
&nbsp;                                &amp;&amp; (Protomech.LOC_TORSO == critHit.loc)
&nbsp;                                &amp;&amp; ((Protomech.SYSTEM_TORSO_WEAPON_A == critHit.slot) || (Protomech.SYSTEM_TORSO_WEAPON_B == critHit.slot))) {
<b class="nc">&nbsp;                            cs = new CriticalSlot(CriticalSlot.TYPE_SYSTEM, critHit.slot);</b>
&nbsp;                        }
&nbsp;                        // Is this a valid slot number?
<b class="nc">&nbsp;                        else if ((critHit.slot &lt; 0)</b>
<b class="nc">&nbsp;                                || (critHit.slot &gt; chp.entity.getNumberOfCriticals(critHit.loc))) {</b>
<b class="nc">&nbsp;                            MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</b>
<b class="nc">&nbsp;                                    chp.entity.getShortName(), critHit.loc, (critHit.slot + 1)));</b>
&nbsp;                        }
&nbsp;                        // Get the slot from the entity.
&nbsp;                        else {
<b class="nc">&nbsp;                            cs = chp.entity.getCritical(critHit.loc, critHit.slot);</b>
&nbsp;                        }
&nbsp;
&nbsp;                        // Ignore invalid, unhittable, and damaged slots.
<b class="nc">&nbsp;                        if ((null == cs) || !cs.isHittable()) {</b>
<b class="nc">&nbsp;                            MegaMek.getLogger().error(String.format(&quot;%s - slot not hittable %d: %d&quot;,</b>
<b class="nc">&nbsp;                                    chp.entity.getShortName(), critHit.loc, (critHit.slot + 1)));</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            MegaMek.getLogger().debug(&quot;[s.applyCriticalHit(chp.entity, ch.loc, cs, false)]&quot;);</b>
<b class="nc">&nbsp;                            s.applyCriticalHit(chp.entity, critHit.loc, cs, false, 0, false);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
&nbsp;                    // Handle Tanks differently.
<b class="nc">&nbsp;                    else if (chp.entity instanceof Tank) {</b>
<b class="nc">&nbsp;                        if ((critHit.slot &lt; 0) || (critHit.slot &gt;= 6)) {</b>
<b class="nc">&nbsp;                            MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</b>
<b class="nc">&nbsp;                                    chp.entity.getShortName(), critHit.loc, (critHit.slot + 1)));</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            CriticalSlot cs = new CriticalSlot(CriticalSlot.TYPE_SYSTEM, critHit.slot + 1);</b>
<b class="nc">&nbsp;                            MegaMek.getLogger().debug(&quot;[s.applyCriticalHit(chp.entity, ch.loc, cs, false)]&quot;);</b>
<b class="nc">&nbsp;                            s.applyCriticalHit(chp.entity, Entity.NONE, cs, false, 0, false);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // Loop throught Set Ammo To
<b class="nc">&nbsp;        for (SetAmmoPlan sap : ammoPlans) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().debug(&quot;Applying ammo adjustment to &quot; + sap.entity.getShortName());</b>
<b class="nc">&nbsp;            for (SetAmmoType sa : sap.ammoSetType) {</b>
&nbsp;                // Limit to &#39;Mechs for now (needs to be extended later)
<b class="nc">&nbsp;                if (sap.entity instanceof Mech) {</b>
<b class="nc">&nbsp;                    if (sa.slot &lt; sap.entity.getNumberOfCriticals(sa.loc)) {</b>
<b class="nc">&nbsp;                        CriticalSlot cs = sap.entity.getCritical(sa.loc, sa.slot);</b>
<b class="nc">&nbsp;                        if (cs != null) {</b>
<b class="nc">&nbsp;                            Mounted ammo = sap.entity.getCritical(sa.loc, sa.slot).getMount();</b>
<b class="nc">&nbsp;                            if (ammo == null) {</b>
<b class="nc">&nbsp;                                MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</b>
<b class="nc">&nbsp;                                        sap.entity.getShortName(), sa.loc, sa.slot + 1));</b>
<b class="nc">&nbsp;                            } else if (ammo.getType() instanceof AmmoType) {</b>
<b class="nc">&nbsp;                                AmmoType newAmmoType = getValidAmmoType(s.getGame(), ammo, sa.type);</b>
<b class="nc">&nbsp;                                if (newAmmoType != null) {</b>
<b class="nc">&nbsp;                                    ammo.changeAmmoType(newAmmoType);</b>
&nbsp;                                } else {
<b class="nc">&nbsp;                                    MegaMek.getLogger().warning(String.format(&quot;Illegal ammo type &#39;%s&#39; for unit %s, slot %s&quot;,</b>
<b class="nc">&nbsp;                                            sa.type, sap.entity.getDisplayName(), ammo.getName()));</b>
&nbsp;                                }
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            for (SetAmmoTo sa : sap.ammoSetTo) {</b>
&nbsp;                // Only can be done against Mechs
<b class="nc">&nbsp;                if (sap.entity instanceof Mech) {</b>
<b class="nc">&nbsp;                    if (sa.slot &lt; sap.entity.getNumberOfCriticals(sa.loc)) {</b>
&nbsp;                        // Get the piece of equipment and check to make sure it
&nbsp;                        // is a ammo item then set its amount!
<b class="nc">&nbsp;                        CriticalSlot cs = sap.entity.getCritical(sa.loc, sa.slot);</b>
<b class="nc">&nbsp;                        if (cs != null) {</b>
<b class="nc">&nbsp;                            Mounted ammo = sap.entity.getCritical(sa.loc, sa.slot).getMount();</b>
<b class="nc">&nbsp;                            if (ammo == null) {</b>
<b class="nc">&nbsp;                                MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</b>
<b class="nc">&nbsp;                                        sap.entity.getShortName(), sa.loc, sa.slot + 1));</b>
<b class="nc">&nbsp;                            } else if (ammo.getType() instanceof AmmoType) {</b>
&nbsp;                                // Also make sure we dont exceed the max allowed
<b class="nc">&nbsp;                                ammo.setShotsLeft(Math.min(sa.setAmmoTo, ammo.getBaseShotsLeft()));</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public IGame createGame() throws Exception {
<b class="nc">&nbsp;        MegaMek.getLogger().info(&quot;Loading scenario from &quot; + scenarioFile);</b>
<b class="nc">&nbsp;        StringMultiMap p = load();</b>
&nbsp;
<b class="nc">&nbsp;        String sCheck = p.getString(PARAM_MMSVERSION);</b>
<b class="nc">&nbsp;        if (sCheck == null) {</b>
<b class="nc">&nbsp;            throw new ScenarioLoaderException(&quot;missingMMSVersion&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Game g = new Game();</b>
&nbsp;
&nbsp;        // build the board
<b class="nc">&nbsp;        g.board = createBoard(p);</b>
&nbsp;
&nbsp;        // build the faction players
<b class="nc">&nbsp;        Collection&lt;Player&gt; players = createPlayers(p);</b>
<b class="nc">&nbsp;        for (Player player : players) {</b>
<b class="nc">&nbsp;            g.addPlayer(player.getId(), player);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // build the entities
<b class="nc">&nbsp;        int entityId = 0;</b>
<b class="nc">&nbsp;        for (Player player : players) {</b>
<b class="nc">&nbsp;            Collection&lt;Entity&gt; entities = buildFactionEntities(p, player);</b>
<b class="nc">&nbsp;            for (Entity entity : entities) {</b>
<b class="nc">&nbsp;                entity.setOwner(player);</b>
<b class="nc">&nbsp;                entity.setId(entityId);</b>
<b class="nc">&nbsp;                ++ entityId;</b>
<b class="nc">&nbsp;                g.addEntity(entity);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        // game&#39;s ready
<b class="nc">&nbsp;        g.getOptions().initialize();</b>
<b class="nc">&nbsp;        String optionFile = p.getString(PARAM_GAME_OPTIONS_FILE);</b>
<b class="nc">&nbsp;        if (optionFile == null) {</b>
<b class="nc">&nbsp;            g.getOptions().loadOptions();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            g.getOptions().loadOptions(new MegaMekFile(scenarioFile.getParentFile(), optionFile).getFile(), true);</b>
&nbsp;        }
&nbsp;
&nbsp;        // set wind
<b class="nc">&nbsp;        g.getPlanetaryConditions().determineWind();</b>
&nbsp;
&nbsp;        // Set up the teams (for initiative)
<b class="nc">&nbsp;        g.setupTeams();</b>
&nbsp;
<b class="nc">&nbsp;        g.setPhase(IGame.Phase.PHASE_STARTING_SCENARIO);</b>
&nbsp;
<b class="nc">&nbsp;        g.setupRoundDeployment();</b>
&nbsp;
&nbsp;        // Read the external game id from the scenario file
<b class="nc">&nbsp;        g.setExternalGameId(parseExternalGameId(p));</b>
&nbsp;
<b class="nc">&nbsp;        g.setVictoryContext(new HashMap&lt;&gt;());</b>
<b class="nc">&nbsp;        g.createVictoryConditions();</b>
&nbsp;
<b class="nc">&nbsp;        return g;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Collection&lt;Entity&gt; buildFactionEntities(StringMultiMap p, IPlayer player) throws ScenarioLoaderException {
<b class="nc">&nbsp;        String faction = player.getName();</b>
<b class="nc">&nbsp;        Pattern unitPattern = Pattern.compile(String.format(&quot;^Unit_\\Q%s\\E_[^_]+$&quot;, faction));</b>
<b class="nc">&nbsp;        Pattern unitDataPattern = Pattern.compile(String.format(&quot;^(Unit_\\Q%s\\E_[^_]+)_([A-Z][^_]+)$&quot;, faction));</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, Entity&gt; entities = new HashMap&lt;&gt;();</b>
&nbsp;        
&nbsp;        // Gather all defined units
<b class="nc">&nbsp;        for (String key : p.keySet()) {</b>
<b class="nc">&nbsp;            if (unitPattern.matcher(key).matches() &amp;&amp; (p.getNumValues(key) &gt; 0)) {</b>
<b class="nc">&nbsp;                if (p.getNumValues(key) &gt; 1) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(String.format(&quot;Scenario loading: Unit declaration %s found %d times&quot;,</b>
<b class="nc">&nbsp;                            key, p.getNumValues(key)));</b>
<b class="nc">&nbsp;                    throw new ScenarioLoaderException(&quot;multipleUnitDeclarations&quot;, key);</b>
&nbsp;                }
<b class="nc">&nbsp;                entities.put(key, parseEntityLine(p.getString(key)));</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        
&nbsp;        // Add other information
<b class="nc">&nbsp;        for (String key: p.keySet()) {</b>
<b class="nc">&nbsp;            Matcher dataMatcher = unitDataPattern.matcher(key);</b>
<b class="nc">&nbsp;            if (dataMatcher.matches()) {</b>
<b class="nc">&nbsp;                String unitKey = dataMatcher.group(1);</b>
<b class="nc">&nbsp;                if (!entities.containsKey(unitKey)) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().warning(&quot;Scenario loading: Data for undeclared unit encountered, ignoring: &quot; + key);</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                Entity e = entities.get(unitKey);</b>
<b class="nc">&nbsp;                switch (dataMatcher.group(2)) {</b>
&nbsp;                    case PARAM_DAMAGE:
<b class="nc">&nbsp;                        for (String val : p.get(key)) {</b>
<b class="nc">&nbsp;                            damagePlans.add(new DamagePlan(e, Integer.parseInt(val)));</b>
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_SPECIFIC_DAMAGE:
<b class="nc">&nbsp;                        DamagePlan dp = new DamagePlan(e);</b>
<b class="nc">&nbsp;                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</b>
<b class="nc">&nbsp;                            dp.addSpecificDamage(val);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        damagePlans.add(dp);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_CRITICAL_HIT:
<b class="nc">&nbsp;                        CritHitPlan chp = new CritHitPlan(e);</b>
<b class="nc">&nbsp;                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</b>
<b class="nc">&nbsp;                            chp.addCritHit(val);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        critHitPlans.add(chp);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_AMMO_AMOUNT:
<b class="nc">&nbsp;                        SetAmmoPlan amountSap = new SetAmmoPlan(e);</b>
<b class="nc">&nbsp;                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</b>
<b class="nc">&nbsp;                            amountSap.addSetAmmoTo(val);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        ammoPlans.add(amountSap);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_AMMO_TYPE:
<b class="nc">&nbsp;                        SetAmmoPlan typeSap = new SetAmmoPlan(e);</b>
<b class="nc">&nbsp;                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</b>
<b class="nc">&nbsp;                            typeSap.addSetAmmoType(val);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        ammoPlans.add(typeSap);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_PILOT_HITS:
<b class="nc">&nbsp;                        int hits = Integer.parseInt(p.getString(key));</b>
<b class="nc">&nbsp;                        e.getCrew().setHits(Math.min(hits, 5), 0);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_EXTERNAL_ID:
<b class="nc">&nbsp;                        e.setExternalIdAsString(p.getString(key));</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_ADVANTAGES:
<b class="nc">&nbsp;                        parseAdvantages(e, p.getString(key, SEPARATOR_SPACE));</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_AUTO_EJECT:
<b class="nc">&nbsp;                        parseAutoEject(e, p.getString(key));</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_COMMANDER:
<b class="nc">&nbsp;                        parseCommander(e, p.getString(key));</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_DEPLOYMENT_ROUND:
<b class="nc">&nbsp;                        int round = Integer.parseInt(p.getString(key));</b>
<b class="nc">&nbsp;                        if (round &gt; 0) {</b>
<b class="nc">&nbsp;                            MegaMek.getLogger().debug(String.format(&quot;%s will be deployed before round %d&quot;,</b>
<b class="nc">&nbsp;                                e.getDisplayName(), round));</b>
<b class="nc">&nbsp;                            e.setDeployRound(round);</b>
<b class="nc">&nbsp;                            e.setDeployed(false);</b>
<b class="nc">&nbsp;                            e.setNeverDeployed(false);</b>
<b class="nc">&nbsp;                            e.setPosition(null);</b>
&nbsp;                        }
&nbsp;                        break;
&nbsp;                    case PARAM_CAMO:
<b class="nc">&nbsp;                        parseCamo(e, p.getString(key));</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case PARAM_ALTITUDE:
<b class="nc">&nbsp;                        int altitude = Math.min(Integer.parseInt(p.getString(key)), 10);</b>
<b class="nc">&nbsp;                        if (e.isAero()) {</b>
<b class="nc">&nbsp;                            e.setAltitude(altitude);</b>
<b class="nc">&nbsp;                            if (altitude &lt;= 0) {</b>
<b class="nc">&nbsp;                                ((IAero) e).land();</b>
&nbsp;                            }
&nbsp;                        } else {
<b class="nc">&nbsp;                            MegaMek.getLogger().warning(String.format(&quot;Altitude setting for a non-aerospace unit %s; ignoring&quot;,</b>
<b class="nc">&nbsp;                                    e.getShortName()));</b>
&nbsp;                        }
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    default:
<b class="nc">&nbsp;                        MegaMek.getLogger().error(&quot;Scenario loading: Unknown unit data key &quot; + key);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        
<b class="nc">&nbsp;        return entities.values();</b>
&nbsp;    }
&nbsp;
&nbsp;    private Entity parseEntityLine(String s) throws ScenarioLoaderException {
&nbsp;        try {
<b class="nc">&nbsp;            String[] parts = s.split(SEPARATOR_COMMA, -1);</b>
&nbsp;            int i;
<b class="nc">&nbsp;            MechSummary ms = MechSummaryCache.getInstance().getMech(parts[0]);</b>
<b class="nc">&nbsp;            if (ms == null) {</b>
<b class="nc">&nbsp;                throw new ScenarioLoaderException(&quot;missingRequiredEntity&quot;, parts[0]);</b>
&nbsp;            }
<b class="nc">&nbsp;            MegaMek.getLogger().debug(String.format(&quot;Loading %s&quot;, ms.getName()));</b>
<b class="nc">&nbsp;            Entity e = new MechFileParser(ms.getSourceFile(), ms.getEntryName()).getEntity();</b>
&nbsp;
&nbsp;            // The following section is used to determine if part 4 of the string includes gender or not
&nbsp;            // The regex is used to match a number that might be negative. As the direction is never
&nbsp;            // a number, if a number is found it must be gender.
&nbsp;            // The i value must be included to ensure that the correct indexes are used for the
&nbsp;            // direction calculation below.
<b class="nc">&nbsp;            if ((parts.length &gt; 4) &amp;&amp; parts[4].matches(&quot;-?\\d+&quot;)) {</b>
<b class="nc">&nbsp;                e.setCrew(new Crew(e.getCrew().getCrewType(), parts[1], 1,</b>
<b class="nc">&nbsp;                        Integer.parseInt(parts[2]), Integer.parseInt(parts[3]),</b>
<b class="nc">&nbsp;                        Gender.parseFromString(parts[4]), null));</b>
<b class="nc">&nbsp;                i = 5; // direction will be part 5, as the scenario has the gender of its pilots included</b>
&nbsp;            } else {
<b class="nc">&nbsp;                e.setCrew(new Crew(e.getCrew().getCrewType(), parts[1], 1,</b>
<b class="nc">&nbsp;                        Integer.parseInt(parts[2]), Integer.parseInt(parts[3]),</b>
<b class="nc">&nbsp;                        RandomGenderGenerator.generate(), null));</b>
<b class="nc">&nbsp;                i = 4; // direction will be part 4, as the scenario does not contain gender</b>
&nbsp;            }
&nbsp;
&nbsp;            // This uses the i value to ensure it is calculated correctly
<b class="nc">&nbsp;            if (parts.length &gt;= 7) {</b>
<b class="nc">&nbsp;                String direction = parts[i++].toUpperCase(Locale.ROOT); //grab value at i, then increment</b>
<b class="nc">&nbsp;                switch (direction) {</b>
&nbsp;                    case &quot;N&quot;:
<b class="nc">&nbsp;                        e.setFacing(0);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case &quot;NW&quot;:
<b class="nc">&nbsp;                        e.setFacing(5);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case &quot;SW&quot;:
<b class="nc">&nbsp;                        e.setFacing(4);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case &quot;S&quot;:
<b class="nc">&nbsp;                        e.setFacing(3);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case &quot;SE&quot;:
<b class="nc">&nbsp;                        e.setFacing(2);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case &quot;NE&quot;:
<b class="nc">&nbsp;                        e.setFacing(1);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    default:
&nbsp;                        break;
&nbsp;                }
<b class="nc">&nbsp;                int x = Integer.parseInt(parts[i++]) - 1;</b>
<b class="nc">&nbsp;                int y = Integer.parseInt(parts[i]) - 1;</b>
<b class="nc">&nbsp;                e.setPosition(new Coords(x, y));</b>
<b class="nc">&nbsp;                e.setDeployed(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            return e;</b>
<b class="nc">&nbsp;        } catch (NumberFormatException | IndexOutOfBoundsException | EntityLoadingException ex) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(ex);</b>
<b class="nc">&nbsp;            throw new ScenarioLoaderException(&quot;unparsableEntityLine&quot;, s);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void parseAdvantages(Entity entity, String adv) {
<b class="nc">&nbsp;        String[] advantages = adv.split(SEPARATOR_SPACE, -1);</b>
&nbsp;
<b class="nc">&nbsp;        for (String curAdv : advantages) {</b>
<b class="nc">&nbsp;            String[] advantageData = curAdv.split(SEPARATOR_COLON, -1);</b>
<b class="nc">&nbsp;            IOption option = entity.getCrew().getOptions().getOption(advantageData[0]);</b>
<b class="nc">&nbsp;            if (option == null) {</b>
<b class="nc">&nbsp;                MegaMek.getLogger().error(String.format(&quot;Ignoring invalid pilot advantage &#39;%s&#39;&quot;, curAdv));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                MegaMek.getLogger().debug(String.format(&quot;Adding pilot advantage &#39;%s&#39; to %s&quot;,</b>
<b class="nc">&nbsp;                        curAdv, entity.getDisplayName()));</b>
<b class="nc">&nbsp;                if (advantageData.length &gt; 1) {</b>
<b class="nc">&nbsp;                    option.setValue(advantageData[1]);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    option.setValue(true);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void parseAutoEject(Entity entity, String eject) {
<b class="nc">&nbsp;        if (entity instanceof Mech) {</b>
<b class="nc">&nbsp;            Mech mech = (Mech) entity;</b>
<b class="nc">&nbsp;            mech.setAutoEject(Boolean.parseBoolean(eject));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void parseCommander(Entity entity, String commander) {
<b class="nc">&nbsp;        entity.setCommander(Boolean.parseBoolean(commander));</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getValidCamoGroup(String camoGroup) {
&nbsp;        // Translate base categories for userfriendliness.
<b class="nc">&nbsp;        if (camoGroup.equals(&quot;No Camo&quot;) || camoGroup.equals(&quot;None&quot;)) {</b>
<b class="nc">&nbsp;            camoGroup = Camouflage.NO_CAMOUFLAGE;</b>
<b class="nc">&nbsp;        } else if (camoGroup.equals(&quot;General&quot;)) {</b>
<b class="nc">&nbsp;            camoGroup = AbstractIcon.ROOT_CATEGORY;</b>
&nbsp;        } else {
&nbsp;            // If CamoGroup does not have a trailing slash, add one, since all
&nbsp;            // subdirectories require it
<b class="nc">&nbsp;            if (camoGroup.charAt(camoGroup.length() - 1) != &#39;/&#39;) {</b>
<b class="nc">&nbsp;                camoGroup += &quot;/&quot;; //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        boolean validGroup = false;</b>
&nbsp;
<b class="nc">&nbsp;        if (Camouflage.NO_CAMOUFLAGE.equals(camoGroup) || AbstractIcon.ROOT_CATEGORY.equals(camoGroup)) {</b>
<b class="nc">&nbsp;            validGroup = true;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Iterator&lt;String&gt; catNames = MMStaticDirectoryManager.getCamouflage().getCategoryNames();</b>
<b class="nc">&nbsp;            while (catNames.hasNext()) {</b>
<b class="nc">&nbsp;                String s = catNames.next();</b>
<b class="nc">&nbsp;                if (s.equals(camoGroup)) {</b>
<b class="nc">&nbsp;                    validGroup = true;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return validGroup ? camoGroup : null;</b>
&nbsp;    }
&nbsp;    
&nbsp;    private String getValidCamoName(String camoGroup, String camoName) {
<b class="nc">&nbsp;        boolean validName = false;</b>
&nbsp;
&nbsp;        // Validate CamoName
<b class="nc">&nbsp;        if (Camouflage.NO_CAMOUFLAGE.equals(camoGroup) &amp;&amp; !StringUtil.isNullOrEmpty(camoGroup)) {</b>
<b class="nc">&nbsp;            return PlayerColour.parseFromString(camoName).name();</b>
&nbsp;        } else {
&nbsp;            Iterator&lt;String&gt; camoNames;
<b class="nc">&nbsp;            if (AbstractIcon.ROOT_CATEGORY.equals(camoGroup)) {</b>
<b class="nc">&nbsp;                camoNames = MMStaticDirectoryManager.getCamouflage().getItemNames(&quot;&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                camoNames = MMStaticDirectoryManager.getCamouflage().getItemNames(camoGroup);</b>
&nbsp;            }
<b class="nc">&nbsp;            while (camoNames.hasNext()) {</b>
<b class="nc">&nbsp;                String s = camoNames.next();</b>
<b class="nc">&nbsp;                if (s.equals(camoName)) {</b>
<b class="nc">&nbsp;                    validName = true;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        return validName ? camoName : null;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /*
&nbsp;     * Camo Parser/Validator for Individual Entity Camo
&nbsp;     */
&nbsp;    private void parseCamo(Entity entity, String camoString) throws ScenarioLoaderException {
<b class="nc">&nbsp;        String[] camoData = camoString.split(SEPARATOR_COMMA, -1);</b>
<b class="nc">&nbsp;        String camoGroup = getValidCamoGroup(camoData[0]);</b>
<b class="nc">&nbsp;        if (camoGroup == null) {</b>
<b class="nc">&nbsp;            throw new ScenarioLoaderException(&quot;invalidIndividualCamoGroup&quot;,</b>
<b class="nc">&nbsp;                camoData[0], entity.getDisplayName());</b>
&nbsp;        }
<b class="nc">&nbsp;        String camoName = getValidCamoName(camoGroup, camoData[1]);</b>
<b class="nc">&nbsp;        if (camoName == null) {</b>
<b class="nc">&nbsp;            throw new ScenarioLoaderException(&quot;invalidIndividualCamoName&quot;,</b>
<b class="nc">&nbsp;                camoData[1], camoGroup, entity.getDisplayName());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        entity.setCamoCategory(camoGroup);</b>
<b class="nc">&nbsp;        entity.setCamoFileName(camoName);</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * Camo Parser/Validator for Faction Camo
&nbsp;     */
&nbsp;    private void parseCamo(IPlayer player, String camoString) throws ScenarioLoaderException {
<b class="nc">&nbsp;        String[] camoData = camoString.split(SEPARATOR_COMMA, -1);</b>
<b class="nc">&nbsp;        String camoGroup = getValidCamoGroup(camoData[0]);</b>
<b class="nc">&nbsp;        if (camoGroup == null) {</b>
<b class="nc">&nbsp;            throw new ScenarioLoaderException(&quot;invalidFactionCamoGroup&quot;,</b>
<b class="nc">&nbsp;                camoData[0], player.getName());</b>
&nbsp;        }
<b class="nc">&nbsp;        String camoName = getValidCamoName(camoGroup, camoData[1]);</b>
<b class="nc">&nbsp;        if (camoName == null) {</b>
<b class="nc">&nbsp;            throw new ScenarioLoaderException(&quot;invalidFactionCamoName&quot;,</b>
<b class="nc">&nbsp;                camoData[1], camoGroup, player.getName());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        player.setCamoCategory(camoGroup);</b>
<b class="nc">&nbsp;        player.setCamoFileName(camoName);</b>
&nbsp;    }
&nbsp;
&nbsp;    private int findIndex(String[] sa, String s) {
<b class="nc">&nbsp;        for (int x = 0; x &lt; sa.length; x++) {</b>
<b class="nc">&nbsp;            if (sa[x].equalsIgnoreCase(s)) {</b>
<b class="nc">&nbsp;                return x;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return -1;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getFactionParam(String faction, String param) {
<b class="nc">&nbsp;        return param + SEPARATOR_UNDERSCORE + faction;</b>
&nbsp;    }
&nbsp;    
&nbsp;    private Collection&lt;Player&gt; createPlayers(StringMultiMap p) throws ScenarioLoaderException {
<b class="nc">&nbsp;        String sFactions = p.getString(PARAM_FACTIONS);</b>
<b class="nc">&nbsp;        if ((sFactions == null) || sFactions.isEmpty()) {</b>
<b class="nc">&nbsp;            throw new ScenarioLoaderException(&quot;missingFactions&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        String[] factions = sFactions.split(SEPARATOR_COMMA, -1);</b>
<b class="nc">&nbsp;        List&lt;Player&gt; result = new ArrayList&lt;&gt;(factions.length);</b>
&nbsp;
<b class="nc">&nbsp;        int playerId = 0;</b>
<b class="nc">&nbsp;        int teamId = 0;</b>
<b class="nc">&nbsp;        for (String faction : factions) {</b>
<b class="nc">&nbsp;            Player player = new Player(playerId, faction);</b>
<b class="nc">&nbsp;            result.add(player);</b>
<b class="nc">&nbsp;            playerId++;</b>
&nbsp;
&nbsp;            // scenario players start out as ghosts to be logged into
<b class="nc">&nbsp;            player.setGhost(true);</b>
&nbsp;            
<b class="nc">&nbsp;            String loc = p.getString(getFactionParam(faction, PARAM_LOCATION));</b>
<b class="nc">&nbsp;            if (loc == null) {</b>
<b class="nc">&nbsp;                loc = &quot;Any&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            int dir = Math.max(findIndex(IStartingPositions.START_LOCATION_NAMES, loc), 0);</b>
<b class="nc">&nbsp;            player.setStartingPos(dir);</b>
&nbsp;            
<b class="nc">&nbsp;            String camo = p.getString(getFactionParam(faction, PARAM_CAMO));</b>
<b class="nc">&nbsp;            if ((camo != null) &amp;&amp; !camo.isEmpty()) {</b>
<b class="nc">&nbsp;                parseCamo(player, camo);</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            String team = p.getString(getFactionParam(faction, PARAM_TEAM));</b>
<b class="nc">&nbsp;            if ((team != null) &amp;&amp; !team.isEmpty()) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    teamId = Integer.parseInt(team);</b>
<b class="nc">&nbsp;                } catch(NumberFormatException ignored) {</b>
<b class="nc">&nbsp;                    teamId++;</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            } else {
<b class="nc">&nbsp;                teamId++;</b>
&nbsp;            }
<b class="nc">&nbsp;            player.setTeam(Math.min(teamId, IPlayer.MAX_TEAMS - 1));</b>
&nbsp;            
<b class="nc">&nbsp;            String minefields = p.getString(getFactionParam(faction, PARAM_MINEFIELDS));</b>
<b class="nc">&nbsp;            if ((minefields != null) &amp;&amp; !minefields.isEmpty()) {</b>
<b class="nc">&nbsp;                String[] mines = minefields.split(SEPARATOR_COMMA, -1);</b>
<b class="nc">&nbsp;                if (mines.length &gt;= 3) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        int minesConventional = Integer.parseInt(mines[0]);</b>
<b class="nc">&nbsp;                        int minesCommand = Integer.parseInt(mines[1]);</b>
<b class="nc">&nbsp;                        int minesVibra = Integer.parseInt(mines[2]);</b>
<b class="nc">&nbsp;                        player.setNbrMFConventional(minesConventional);</b>
<b class="nc">&nbsp;                        player.setNbrMFCommand(minesCommand);</b>
<b class="nc">&nbsp;                        player.setNbrMFVibra(minesVibra);</b>
<b class="nc">&nbsp;                    } catch (NumberFormatException nfex) {</b>
<b class="nc">&nbsp;                        MegaMek.getLogger().error(String.format(&quot;Format error with minefields string &#39;%s&#39; for %s&quot;,</b>
&nbsp;                                minefields, faction));
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Load board files and create the megaboard.
&nbsp;     */
&nbsp;    private IBoard createBoard(StringMultiMap p) throws ScenarioLoaderException {
<b class="nc">&nbsp;        int mapWidth = 16, mapHeight = 17;</b>
<b class="nc">&nbsp;        if (p.getString(PARAM_MAP_WIDTH) == null) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().info(&quot;No map width specified; using &quot; + mapWidth);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            mapWidth = Integer.parseInt(p.getString(PARAM_MAP_WIDTH));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (p.getString(PARAM_MAP_HEIGHT) == null) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().info(&quot;No map height specified; using &quot; + mapHeight);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            mapHeight = Integer.parseInt(p.getString(PARAM_MAP_HEIGHT));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int nWidth = 1, nHeight = 1;</b>
<b class="nc">&nbsp;        if (p.getString(PARAM_BOARD_WIDTH) == null) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().info(&quot;No board width specified; using &quot; + nWidth);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            nWidth = Integer.parseInt(p.getString(PARAM_BOARD_WIDTH));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (p.getString(PARAM_BOARD_HEIGHT) == null) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().info(&quot;No board height specified; using &quot; + nHeight);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            nHeight = Integer.parseInt(p.getString(PARAM_BOARD_HEIGHT));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        MegaMek.getLogger().debug(String.format(&quot;Mapsheets are %d by %d hexes.&quot;, mapWidth, mapHeight));</b>
<b class="nc">&nbsp;        MegaMek.getLogger().debug(String.format(&quot;Constructing %d by %d board.&quot;, nWidth, nHeight));</b>
<b class="nc">&nbsp;        int cf = 0;</b>
<b class="nc">&nbsp;        if (p.getString(PARAM_BRIDGE_CF) == null) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().debug(&quot;No CF for bridges defined. Using map file defaults.&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            cf = Integer.parseInt(p.getString(PARAM_BRIDGE_CF));</b>
<b class="nc">&nbsp;            MegaMek.getLogger().debug(&quot;Overriding map-defined bridge CFs with &quot; + cf);</b>
&nbsp;        }
&nbsp;        // load available boards
&nbsp;        // basically copied from Server.java. Should get moved somewhere neutral
<b class="nc">&nbsp;        List&lt;String&gt; boards = new ArrayList&lt;&gt;();</b>
&nbsp;
&nbsp;        // Find subdirectories given in the scenario file
<b class="nc">&nbsp;        List&lt;String&gt; allDirs = new LinkedList&lt;&gt;();</b>
&nbsp;        // &quot;&quot; entry stands for the boards base directory 
<b class="nc">&nbsp;        allDirs.add(&quot;&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        if (p.getString(PARAM_MAP_DIRECTORIES) != null) {</b>
<b class="nc">&nbsp;            allDirs = Arrays.asList(p.getString(PARAM_MAP_DIRECTORIES)</b>
<b class="nc">&nbsp;                    .split(SEPARATOR_COMMA, -1));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        for (String dir: allDirs) {</b>
<b class="nc">&nbsp;            File curDir = new File(Configuration.boardsDir(), dir);</b>
<b class="nc">&nbsp;            if (curDir.exists()) {</b>
<b class="nc">&nbsp;                for (String file : curDir.list()) {</b>
<b class="nc">&nbsp;                    if (file.toLowerCase(Locale.ROOT).endsWith(FILE_SUFFIX_BOARD)) {</b>
<b class="nc">&nbsp;                        boards.add(dir+&quot;/&quot;+file.substring(0, file.length() - FILE_SUFFIX_BOARD.length()));</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        IBoard[] ba = new IBoard[nWidth * nHeight];</b>
<b class="nc">&nbsp;        Queue&lt;String&gt; maps = new LinkedList&lt;&gt;(</b>
<b class="nc">&nbsp;            Arrays.asList(p.getString(PARAM_MAPS).split(SEPARATOR_COMMA, -1)));</b>
<b class="nc">&nbsp;        List&lt;Boolean&gt; rotateBoard = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int x = 0; x &lt; nWidth; x++) {</b>
<b class="nc">&nbsp;            for (int y = 0; y &lt; nHeight; y++) {</b>
<b class="nc">&nbsp;                int n = (y * nWidth) + x;</b>
<b class="nc">&nbsp;                String board = MAP_RANDOM;</b>
<b class="nc">&nbsp;                if (!maps.isEmpty()) {</b>
<b class="nc">&nbsp;                    board = maps.poll();</b>
&nbsp;                }
<b class="nc">&nbsp;                MegaMek.getLogger().debug(String.format(&quot;(%d,%d) %s&quot;, x, y, board));</b>
&nbsp;
<b class="nc">&nbsp;                boolean isRotated = false;</b>
<b class="nc">&nbsp;                if (board.startsWith(Board.BOARD_REQUEST_ROTATION)) {</b>
<b class="nc">&nbsp;                    isRotated = true;</b>
<b class="nc">&nbsp;                    board = board.substring(Board.BOARD_REQUEST_ROTATION.length());</b>
&nbsp;                }
&nbsp;
&nbsp;                String sBoardFile;
<b class="nc">&nbsp;                if (board.equals(MAP_RANDOM)) {</b>
<b class="nc">&nbsp;                    sBoardFile = (boards.get(Compute.randomInt(boards.size()))) + FILE_SUFFIX_BOARD;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    sBoardFile = board + FILE_SUFFIX_BOARD;</b>
&nbsp;                }
<b class="nc">&nbsp;                File fBoard = new MegaMekFile(Configuration.boardsDir(), sBoardFile).getFile();</b>
<b class="nc">&nbsp;                if (!fBoard.exists()) {</b>
<b class="nc">&nbsp;                    throw new ScenarioLoaderException(&quot;nonexistantBoard&quot;, board);</b>
&nbsp;                }
<b class="nc">&nbsp;                ba[n] = new Board();</b>
<b class="nc">&nbsp;                ba[n].load(new MegaMekFile(Configuration.boardsDir(), sBoardFile).getFile());</b>
<b class="nc">&nbsp;                if (cf &gt; 0) {</b>
<b class="nc">&nbsp;                    ba[n].setBridgeCF(cf);</b>
&nbsp;                }
<b class="nc">&nbsp;                BoardUtilities.flip(ba[n], isRotated, isRotated);</b>
<b class="nc">&nbsp;                rotateBoard.add(isRotated);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // if only one board just return it.
<b class="nc">&nbsp;        if (ba.length == 1) {</b>
<b class="nc">&nbsp;            return ba[0];</b>
&nbsp;        }
&nbsp;        // construct the big board
<b class="nc">&nbsp;        return BoardUtilities.combine(mapWidth, mapHeight, nWidth, nHeight, ba, rotateBoard, MapSettings.MEDIUM_GROUND);</b>
&nbsp;    }
&nbsp;
&nbsp;    private StringMultiMap load() throws ScenarioLoaderException {
<b class="nc">&nbsp;        StringMultiMap props = new StringMultiMap();</b>
<b class="nc">&nbsp;        try (BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(scenarioFile), StandardCharsets.UTF_8))) {</b>
&nbsp;            String line;
<b class="nc">&nbsp;            int lineNum = 0;</b>
<b class="nc">&nbsp;            while ((line = reader.readLine()) != null) {</b>
<b class="nc">&nbsp;                lineNum++;</b>
<b class="nc">&nbsp;                line = line.trim();</b>
<b class="nc">&nbsp;                if (line.startsWith(COMMENT_MARK) || (line.length() == 0)) {</b>
<b class="nc">&nbsp;                    continue;</b>
<b class="nc">&nbsp;                } else if (!line.contains(SEPARATOR_PROPERTY)) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(String.format(&quot;Equality sign in scenario file %s on line %d missing; ignoring&quot;,</b>
<b class="nc">&nbsp;                            scenarioFile, lineNum));</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                String[] elements = line.split(SEPARATOR_PROPERTY, -1);</b>
<b class="nc">&nbsp;                if (elements.length &gt; 2) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(String.format(&quot;Multiple equality signs in scenario file %s on line %d; ignoring&quot;,</b>
<b class="nc">&nbsp;                            scenarioFile, lineNum));</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                props.put(elements[0].trim(), elements[1].trim());</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(e);</b>
<b class="nc">&nbsp;            throw new ScenarioLoaderException(&quot;exceptionReadingFile&quot;, scenarioFile);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return props;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parses out the external game id from the scenario file
&nbsp;     */
&nbsp;    private int parseExternalGameId(StringMultiMap p) {
<b class="nc">&nbsp;        String sExternalId = p.getString(PARAM_GAME_EXTERNAL_ID);</b>
<b class="nc">&nbsp;        int ExternalGameId = 0;</b>
<b class="nc">&nbsp;        if (sExternalId != null) {</b>
<b class="nc">&nbsp;            ExternalGameId = Integer.parseInt(sExternalId);</b>
&nbsp;        }
<b class="nc">&nbsp;        return ExternalGameId;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static void main(String[] saArgs) throws Exception {
<b class="nc">&nbsp;        ScenarioLoader sl = new ScenarioLoader(new File(saArgs[0]));</b>
<b class="nc">&nbsp;        IGame g = sl.createGame();</b>
<b class="nc">&nbsp;        if (g != null) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().info(&quot;Successfully loaded.&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This is used specify the critical hit location
&nbsp;     */
&nbsp;    private static class CritHit {
&nbsp;        public int loc;
&nbsp;        public int slot;
&nbsp;
<b class="nc">&nbsp;        public CritHit(int l, int s) {</b>
<b class="nc">&nbsp;            loc = l;</b>
<b class="nc">&nbsp;            slot = s;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This class is used to store the critical hit plan for a entity it is
&nbsp;     * loaded from the scenario file. It contains a vector of CritHit.
&nbsp;     */
&nbsp;    private class CritHitPlan {
&nbsp;        public Entity entity;
<b class="nc">&nbsp;        List&lt;CritHit&gt; critHits = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        public CritHitPlan(Entity e) {</b>
<b class="nc">&nbsp;            entity = e;</b>
&nbsp;        }
&nbsp;
&nbsp;        public void addCritHit(String s) {
<b class="nc">&nbsp;            int ewSpot = s.indexOf(&#39;:&#39;);</b>
<b class="nc">&nbsp;            int loc = Integer.parseInt(s.substring(0, ewSpot));</b>
<b class="nc">&nbsp;            int slot = Integer.parseInt(s.substring(ewSpot + 1));</b>
&nbsp;            
<b class="nc">&nbsp;            critHits.add(new CritHit(loc, slot - 1));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This is used to store the armor to change ammo at a given location
&nbsp;     */
&nbsp;    private static class SetAmmoTo {
&nbsp;        public final int loc;
&nbsp;        public final int slot;
&nbsp;        public final int setAmmoTo;
&nbsp;
<b class="nc">&nbsp;        public SetAmmoTo(int loc, int slot, int setAmmoTo) {</b>
<b class="nc">&nbsp;            this.loc = loc;</b>
<b class="nc">&nbsp;            this.slot = slot;</b>
<b class="nc">&nbsp;            this.setAmmoTo = setAmmoTo;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private static class SetAmmoType {
&nbsp;        public final int loc;
&nbsp;        public final int slot;
&nbsp;        public final String type;
&nbsp;        
<b class="nc">&nbsp;        public SetAmmoType(int loc, int slot, String type) {</b>
<b class="nc">&nbsp;            this.loc = loc;</b>
<b class="nc">&nbsp;            this.slot = slot;</b>
<b class="nc">&nbsp;            this.type = type;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This class is used to store the ammo Adjustments it is loaded from the
&nbsp;     * scenario file. It contains a vector of SetAmmoTo.
&nbsp;     */
&nbsp;    private class SetAmmoPlan {
&nbsp;        public final Entity entity;
<b class="nc">&nbsp;        public final List&lt;SetAmmoTo&gt; ammoSetTo = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        public final List&lt;SetAmmoType&gt; ammoSetType = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        public SetAmmoPlan(Entity e) {</b>
<b class="nc">&nbsp;            entity = e;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Converts 2:1-34 to Location 2 Slot 1 set Ammo to 34
&nbsp;         */
&nbsp;        public void addSetAmmoTo(String s) {
<b class="nc">&nbsp;            int ewSpot = s.indexOf(&#39;:&#39;);</b>
<b class="nc">&nbsp;            int amSpot = s.indexOf(&#39;-&#39;);</b>
<b class="nc">&nbsp;            if (s.isEmpty() || (ewSpot &lt; 1) || (amSpot &lt; ewSpot)) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            int loc = Integer.parseInt(s.substring(0, ewSpot));</b>
<b class="nc">&nbsp;            int slot = Integer.parseInt(s.substring(ewSpot + 1, amSpot));</b>
<b class="nc">&nbsp;            int setTo = Integer.parseInt(s.substring(amSpot + 1));</b>
&nbsp;
<b class="nc">&nbsp;            ammoSetTo.add(new SetAmmoTo(loc, slot - 1, setTo));</b>
&nbsp;        }
&nbsp;        
&nbsp;        public void addSetAmmoType(String s) {
<b class="nc">&nbsp;            int ewSpot = s.indexOf(&#39;:&#39;);</b>
<b class="nc">&nbsp;            int atSpot = s.indexOf(&#39;-&#39;);</b>
<b class="nc">&nbsp;            if (s.isEmpty() || (ewSpot &lt; 1) || (atSpot &lt; ewSpot)) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            int loc = Integer.parseInt(s.substring(0, ewSpot));</b>
<b class="nc">&nbsp;            int slot = Integer.parseInt(s.substring(ewSpot + 1, atSpot));</b>
&nbsp;            
<b class="nc">&nbsp;            ammoSetType.add(new SetAmmoType(loc, slot - 1, s.substring(atSpot + 1)));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This is used specify the one damage location
&nbsp;     */
&nbsp;    private static class SpecDam {
&nbsp;        public final int loc;
&nbsp;        public final int setArmorTo;
&nbsp;        public final boolean rear;
&nbsp;        public final boolean internal;
&nbsp;
<b class="nc">&nbsp;        public SpecDam(int Location, int SetArmorTo, boolean RearHit, boolean Internal) {</b>
<b class="nc">&nbsp;            loc = Location;</b>
<b class="nc">&nbsp;            setArmorTo = SetArmorTo;</b>
<b class="nc">&nbsp;            rear = RearHit;</b>
<b class="nc">&nbsp;            internal = Internal;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This class is used to store the damage plan for a entity it is loaded
&nbsp;     * from the scenario file. It contains a vector of SpecDam.
&nbsp;     */
&nbsp;    private class DamagePlan {
&nbsp;        public final Entity entity;
&nbsp;        public final int nBlocks;
<b class="nc">&nbsp;        public final List&lt;SpecDam&gt; specificDammage = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        public DamagePlan(Entity e, int n) {</b>
<b class="nc">&nbsp;            entity = e;</b>
<b class="nc">&nbsp;            nBlocks = n;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        public DamagePlan(Entity e) {</b>
<b class="nc">&nbsp;            entity = e;</b>
<b class="nc">&nbsp;            nBlocks = 0;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Converts N2:1 to Nornam hit to location 2 set armor to 1!
&nbsp;         */
&nbsp;        public void addSpecificDamage(String s) {
<b class="nc">&nbsp;            int ewSpot = s.indexOf(&#39;:&#39;);</b>
<b class="nc">&nbsp;            if (s.isEmpty() || (ewSpot &lt; 1)) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            int loc = Integer.parseInt(s.substring(1, ewSpot));</b>
<b class="nc">&nbsp;            int setTo = Integer.parseInt(s.substring(ewSpot + 1));</b>
<b class="nc">&nbsp;            boolean rear = (s.charAt(0) == &#39;R&#39;);</b>
<b class="nc">&nbsp;            boolean internal = (s.charAt(0) == &#39;I&#39;);</b>
&nbsp;            
<b class="nc">&nbsp;            specificDammage.add(new SpecDam(loc, setTo, rear, internal));</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private static class ScenarioLoaderException extends Exception {
&nbsp;        private static final long serialVersionUID = 8622648319531348199L;
&nbsp;        
&nbsp;        private final Object[] params;
&nbsp;
&nbsp;        public ScenarioLoaderException(String errorKey) {
<b class="nc">&nbsp;            super(errorKey);</b>
<b class="nc">&nbsp;            this.params = null;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public ScenarioLoaderException(String errorKey, Object... params) {
<b class="nc">&nbsp;            super(errorKey);</b>
<b class="nc">&nbsp;            this.params = params;</b>
&nbsp;        }
&nbsp;        
&nbsp;        @Override
&nbsp;        public String getMessage() {
<b class="nc">&nbsp;            String result = Messages.getString(&quot;ScenarioLoaderException.&quot; + super.getMessage());</b>
<b class="nc">&nbsp;            if (params != null) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    return String.format(result, params);</b>
<b class="nc">&nbsp;                } catch (IllegalFormatException ignored) {</b>
&nbsp;                    // Ignore, return the base translation instead
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return result;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
<b class="nc">&nbsp;    private static class StringMultiMap extends HashMap&lt;String, Collection&lt;String&gt;&gt; {</b>
&nbsp;        private static final long serialVersionUID = 2171662843329151622L;
&nbsp;
&nbsp;        public void put(String key, String value) {
<b class="nc">&nbsp;            Collection&lt;String&gt; values = get(key);</b>
<b class="nc">&nbsp;            if (values == null) {</b>
<b class="nc">&nbsp;                values = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                put(key, values);</b>
&nbsp;            }
<b class="nc">&nbsp;            values.add(value);</b>
&nbsp;        }
&nbsp;
&nbsp;        public String getString(String key) {
<b class="nc">&nbsp;            return getString(key, SEPARATOR_COMMA);</b>
&nbsp;        }
&nbsp;
&nbsp;        public String getString(String key, String separator) {
<b class="nc">&nbsp;            Collection&lt;String&gt; values = get(key);</b>
<b class="nc">&nbsp;            if ((values == null) || (values.size() == 0)) {</b>
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            boolean firstElement = true;</b>
<b class="nc">&nbsp;            StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;            for (String val : values) {</b>
<b class="nc">&nbsp;                if (firstElement) {</b>
<b class="nc">&nbsp;                    firstElement = false;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    sb.append(separator);</b>
&nbsp;                }
<b class="nc">&nbsp;                sb.append(val);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            return sb.toString();</b>
&nbsp;        }
&nbsp;        
&nbsp;        /** @return the number of values for this key in the file */
&nbsp;        public int getNumValues(String key) {
<b class="nc">&nbsp;            Collection&lt;String&gt; values = get(key);</b>
<b class="nc">&nbsp;            return (values == null) ? 0 : values.size();</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
