


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > WeaponPanel</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ui.swing.unitDisplay</a>
</div>

<h1>Coverage Summary for Class: WeaponPanel (megamek.client.ui.swing.unitDisplay)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">WeaponPanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1642)
  </span>
</td>
</tr>
  <tr>
    <td class="name">WeaponPanel$1</td>
  </tr>
  <tr>
    <td class="name">WeaponPanel$WeaponListModel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/76)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">WeaponPanel$WeaponListMouseAdapter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/43)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1749)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package megamek.client.ui.swing.unitDisplay;
&nbsp;
&nbsp;import java.awt.Color;
&nbsp;import java.awt.Dimension;
&nbsp;import java.awt.Font;
&nbsp;import java.awt.GridBagConstraints;
&nbsp;import java.awt.GridBagLayout;
&nbsp;import java.awt.Image;
&nbsp;import java.awt.Rectangle;
&nbsp;import java.awt.event.ActionEvent;
&nbsp;import java.awt.event.ActionListener;
&nbsp;import java.awt.event.KeyListener;
&nbsp;import java.awt.event.MouseEvent;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.List;
&nbsp;import java.util.Vector;
&nbsp;
&nbsp;import javax.swing.AbstractListModel;
&nbsp;import javax.swing.DefaultComboBoxModel;
&nbsp;import javax.swing.DefaultListModel;
&nbsp;import javax.swing.JComboBox;
&nbsp;import javax.swing.JComponent;
&nbsp;import javax.swing.JLabel;
&nbsp;import javax.swing.JList;
&nbsp;import javax.swing.JScrollPane;
&nbsp;import javax.swing.JTextArea;
&nbsp;import javax.swing.SwingConstants;
&nbsp;import javax.swing.SwingUtilities;
&nbsp;import javax.swing.event.ListSelectionEvent;
&nbsp;import javax.swing.event.ListSelectionListener;
&nbsp;import javax.swing.event.MouseInputAdapter;
&nbsp;
&nbsp;import megamek.client.event.MechDisplayEvent;
&nbsp;import megamek.client.ui.GBC;
&nbsp;import megamek.client.ui.Messages;
&nbsp;import megamek.client.ui.swing.ClientGUI;
&nbsp;import megamek.client.ui.swing.FiringDisplay;
&nbsp;import megamek.client.ui.swing.MovementDisplay;
&nbsp;import megamek.client.ui.swing.TargetingPhaseDisplay;
&nbsp;import megamek.client.ui.swing.widget.BackGroundDrawer;
&nbsp;import megamek.client.ui.swing.widget.PMUtil;
&nbsp;import megamek.client.ui.swing.widget.PicMap;
&nbsp;import megamek.client.ui.swing.widget.SkinXMLHandler;
&nbsp;import megamek.client.ui.swing.widget.UnitDisplaySkinSpecification;
&nbsp;import megamek.common.Aero;
&nbsp;import megamek.common.AmmoType;
&nbsp;import megamek.common.BattleArmor;
&nbsp;import megamek.common.Compute;
&nbsp;import megamek.common.Configuration;
&nbsp;import megamek.common.Coords;
&nbsp;import megamek.common.Entity;
&nbsp;import megamek.common.FighterSquadron;
&nbsp;import megamek.common.IGame;
&nbsp;import megamek.common.IHex;
&nbsp;import megamek.common.ILocationExposureStatus;
&nbsp;import megamek.common.Infantry;
&nbsp;import megamek.common.Jumpship;
&nbsp;import megamek.common.LandAirMech;
&nbsp;import megamek.common.Mech;
&nbsp;import megamek.common.Mounted;
&nbsp;import megamek.common.RangeType;
&nbsp;import megamek.common.SmallCraft;
&nbsp;import megamek.common.Targetable;
&nbsp;import megamek.common.Terrains;
&nbsp;import megamek.common.WeaponComparatorArc;
&nbsp;import megamek.common.WeaponComparatorCustom;
&nbsp;import megamek.common.WeaponComparatorDamage;
&nbsp;import megamek.common.WeaponComparatorNum;
&nbsp;import megamek.common.WeaponComparatorRange;
&nbsp;import megamek.common.WeaponType;
&nbsp;import megamek.common.options.OptionsConstants;
&nbsp;import megamek.common.util.fileUtils.MegaMekFile;
&nbsp;import megamek.common.weapons.bayweapons.BayWeapon;
&nbsp;import megamek.common.weapons.gaussrifles.HAGWeapon;
&nbsp;import megamek.common.weapons.infantry.InfantryWeapon;
&nbsp;
&nbsp;/**
&nbsp; * This class contains the all the gizmos for firing the mech&#39;s weapons.
&nbsp; */
<b class="nc">&nbsp;public class WeaponPanel extends PicMap implements ListSelectionListener,</b>
&nbsp;        ActionListener {
&nbsp;    
&nbsp;    /**
&nbsp;     * Mouse adaptor for the weapon list.  Supports rearranging the weapons
&nbsp;     * to define a custom ordering.
&nbsp;     *
&nbsp;     * @author arlith
&nbsp;     *
&nbsp;     */
<b class="nc">&nbsp;    private class WeaponListMouseAdapter extends MouseInputAdapter {</b>
&nbsp;
<b class="nc">&nbsp;        private boolean mouseDragging = false;</b>
&nbsp;        private int dragSourceIndex;
&nbsp;
&nbsp;        @Override
&nbsp;        public void mousePressed(MouseEvent e) {
<b class="nc">&nbsp;            if (SwingUtilities.isLeftMouseButton(e)) {</b>
<b class="nc">&nbsp;                Object src = e.getSource();</b>
<b class="nc">&nbsp;                if (src instanceof JList) {</b>
<b class="nc">&nbsp;                    dragSourceIndex = ((JList&lt;?&gt;) src).getSelectedIndex();</b>
<b class="nc">&nbsp;                    mouseDragging = true;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void mouseReleased(MouseEvent e) {
<b class="nc">&nbsp;            mouseDragging = false;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void mouseDragged(MouseEvent e) {
<b class="nc">&nbsp;            removeListeners();</b>
&nbsp;            
<b class="nc">&nbsp;            Object src = e.getSource();</b>
&nbsp;            // Check to see if we are in a state we care about
<b class="nc">&nbsp;            if (!mouseDragging || !(src instanceof JList)) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            JList&lt;?&gt; srcList = (JList&lt;?&gt;) src;</b>
<b class="nc">&nbsp;            WeaponListModel srcModel = (WeaponListModel) srcList.getModel();</b>
<b class="nc">&nbsp;            int currentIndex = srcList.locationToIndex(e.getPoint());</b>
<b class="nc">&nbsp;            if (currentIndex != dragSourceIndex) {</b>
<b class="nc">&nbsp;                int dragTargetIndex = srcList.getSelectedIndex();</b>
<b class="nc">&nbsp;                Mounted weap1 = srcModel.getWeaponAt(dragSourceIndex);</b>
<b class="nc">&nbsp;                srcModel.swapIdx(dragSourceIndex, dragTargetIndex);</b>
<b class="nc">&nbsp;                dragSourceIndex = currentIndex;</b>
<b class="nc">&nbsp;                Entity ent = weap1.getEntity();</b>
&nbsp;                // Is the sort order custom?
<b class="nc">&nbsp;                int customId = Entity.WeaponSortOrder.CUSTOM.ordinal();</b>
&nbsp;                // Update weap sort order drop down
<b class="nc">&nbsp;                if (weapSortOrder.getSelectedIndex() != customId) {</b>
&nbsp;                    // Set the order to custom
<b class="nc">&nbsp;                    ent.setWeaponSortOrder(Entity.WeaponSortOrder.CUSTOM);</b>
<b class="nc">&nbsp;                    weapSortOrder.setSelectedIndex(customId);</b>
&nbsp;                }
&nbsp;                // Update custom order
<b class="nc">&nbsp;                for (int i = 0; i &lt; srcModel.getSize(); i++) {</b>
<b class="nc">&nbsp;                    Mounted m = srcModel.getWeaponAt(i);</b>
<b class="nc">&nbsp;                    ent.setCustomWeaponOrder(m, i);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (unitDisplay.getClientGUI() != null) {</b>
<b class="nc">&nbsp;                    unitDisplay.getClientGUI().getMenuBar()</b>
<b class="nc">&nbsp;                            .updateSaveWeaponOrderMenuItem();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            addListeners();</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * ListModel implementation that supports keeping track of a list of Mounted
&nbsp;     * instantiations, how to display them in the JList, and an ability to sort
&nbsp;     * the Mounteds given WeaponComparators.
&nbsp;     *
&nbsp;     * @author arlith
&nbsp;     *
&nbsp;     */
&nbsp;    class WeaponListModel extends AbstractListModel&lt;String&gt; {
&nbsp;
&nbsp;        /**
&nbsp;         *
&nbsp;         */
&nbsp;        private static final long serialVersionUID = 6312003196674512339L;
&nbsp;
&nbsp;        /**
&nbsp;         * A collection of Mounted instantiations.
&nbsp;         */
&nbsp;        private ArrayList&lt;Mounted&gt; weapons;
&nbsp;
&nbsp;        /**
&nbsp;         * The Entity that owns the collection of Mounteds.
&nbsp;         */
&nbsp;        private Entity en;
&nbsp;
<b class="nc">&nbsp;        WeaponListModel(Entity e) {</b>
<b class="nc">&nbsp;            en = e;</b>
<b class="nc">&nbsp;            weapons = new ArrayList&lt;Mounted&gt;();</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Add a new weapon to the list.
&nbsp;         *
&nbsp;         * @param w
&nbsp;         */
&nbsp;        public void addWeapon(Mounted w) {
<b class="nc">&nbsp;            weapons.add(w);</b>
<b class="nc">&nbsp;            fireIntervalAdded(this,weapons.size()-1, weapons.size()-1);</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Given the equipment (weapon) id, return the index in the (possibly
&nbsp;         * sorted) list of Mounteds.
&nbsp;         *
&nbsp;         * @param weaponId
&nbsp;         * @return
&nbsp;         */
&nbsp;        public int getIndex(int weaponId) {
<b class="nc">&nbsp;            Mounted mount = en.getEquipment(weaponId);</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; weapons.size(); i++) {</b>
<b class="nc">&nbsp;                if (weapons.get(i).equals(mount)) {</b>
<b class="nc">&nbsp;                    return i;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
&nbsp;
&nbsp;        public void removeAllElements() {
<b class="nc">&nbsp;            int numWeapons = weapons.size() - 1;</b>
<b class="nc">&nbsp;            weapons.clear();</b>
<b class="nc">&nbsp;            fireIntervalRemoved(this, 0, numWeapons);</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Swap the Mounteds at the two specified index values.
&nbsp;         *
&nbsp;         * @param idx1
&nbsp;         * @param idx2
&nbsp;         */
&nbsp;        public void swapIdx(int idx1, int idx2) {
&nbsp;            // Bounds checking
<b class="nc">&nbsp;            if ((idx1 &gt;= weapons.size()) || (idx2 &gt;= weapons.size())</b>
&nbsp;                    || (idx1 &lt; 0) || (idx2 &lt; 0)) {
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            Mounted m1 = weapons.get(idx1);</b>
<b class="nc">&nbsp;            weapons.set(idx1, weapons.get(idx2));</b>
<b class="nc">&nbsp;            weapons.set(idx2, m1);</b>
<b class="nc">&nbsp;            fireContentsChanged(this, idx1, idx1);</b>
<b class="nc">&nbsp;            fireContentsChanged(this, idx2, idx2);</b>
&nbsp;        }
&nbsp;
&nbsp;        public Mounted getWeaponAt(int index) {
<b class="nc">&nbsp;            return weapons.get(index);</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Given an index into the (possibly sorted) list of Mounted, return a
&nbsp;         * text description.  This consists of the Mounted&#39;s description, as
&nbsp;         * well as additional information like location, whether the Mounted is
&nbsp;         * shot/jammed/destroyed, etc.  This is what the JList will display.
&nbsp;         */
&nbsp;        @Override
&nbsp;        public String getElementAt(int index) {
<b class="nc">&nbsp;            final Mounted mounted = weapons.get(index);</b>
<b class="nc">&nbsp;            final WeaponType wtype = (WeaponType) mounted.getType();</b>
<b class="nc">&nbsp;            IGame game = null;</b>
<b class="nc">&nbsp;            if (unitDisplay.getClientGUI() != null) {</b>
<b class="nc">&nbsp;                game = unitDisplay.getClientGUI().getClient().getGame();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            StringBuilder wn = new StringBuilder(mounted.getDesc());</b>
<b class="nc">&nbsp;            wn.append(&quot; [&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            wn.append(en.getLocationAbbr(mounted.getLocation()));</b>
<b class="nc">&nbsp;            if (mounted.isSplit()) {</b>
<b class="nc">&nbsp;                wn.append(&#39;/&#39;);</b>
<b class="nc">&nbsp;                wn.append(en.getLocationAbbr(mounted.getSecondLocation()));</b>
&nbsp;            }
<b class="nc">&nbsp;            wn.append(&#39;]&#39;);</b>
&nbsp;            // determine shots left &amp; total shots left
<b class="nc">&nbsp;            if ((wtype.getAmmoType() != AmmoType.T_NA)</b>
<b class="nc">&nbsp;                    &amp;&amp; (!wtype.hasFlag(WeaponType.F_ONESHOT)</b>
<b class="nc">&nbsp;                            || wtype.hasFlag(WeaponType.F_BA_INDIVIDUAL))</b>
<b class="nc">&nbsp;                    &amp;&amp; (wtype.getAmmoType() != AmmoType.T_INFANTRY)) {</b>
<b class="nc">&nbsp;                int shotsLeft = 0;</b>
<b class="nc">&nbsp;                if ((mounted.getLinked() != null)</b>
<b class="nc">&nbsp;                    &amp;&amp; !mounted.getLinked().isDumping()) {</b>
<b class="nc">&nbsp;                    shotsLeft = mounted.getLinked().getUsableShotsLeft();</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                int totalShotsLeft = en.getTotalMunitionsOfType(mounted);</b>
&nbsp;
<b class="nc">&nbsp;                wn.append(&quot; (&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wn.append(shotsLeft);</b>
<b class="nc">&nbsp;                wn.append(&#39;/&#39;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wn.append(totalShotsLeft);</b>
<b class="nc">&nbsp;                wn.append(&#39;)&#39;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (wtype.hasFlag(WeaponType.F_DOUBLE_ONESHOT)</b>
<b class="nc">&nbsp;                    || (en.isSupportVehicle() &amp;&amp; (wtype.getAmmoType() == AmmoType.T_INFANTRY))) {</b>
<b class="nc">&nbsp;                int shotsLeft = 0;</b>
<b class="nc">&nbsp;                int totalShots = 0;</b>
<b class="nc">&nbsp;                long munition = ((AmmoType) mounted.getLinked().getType()).getMunitionType();</b>
<b class="nc">&nbsp;                for (Mounted current = mounted.getLinked(); current != null; current = current.getLinked()) {</b>
<b class="nc">&nbsp;                    if (((AmmoType) current.getType()).getMunitionType() == munition) {</b>
<b class="nc">&nbsp;                        shotsLeft += current.getUsableShotsLeft();</b>
<b class="nc">&nbsp;                        totalShots += current.getOriginalShots();</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                wn.append(&quot; (&quot;).append(shotsLeft) //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    .append(&quot;/&quot;).append(totalShots).append(&quot;)&quot;); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;            }
&nbsp;
&nbsp;            // MG rapidfire
<b class="nc">&nbsp;            if (mounted.isRapidfire()) {</b>
<b class="nc">&nbsp;                wn.append(Messages.getString(&quot;MechDisplay.rapidFire&quot;)); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;
&nbsp;            // Hotloaded Missile Launchers
<b class="nc">&nbsp;            if (mounted.isHotLoaded()) {</b>
<b class="nc">&nbsp;                wn.append(Messages.getString(&quot;MechDisplay.isHotLoaded&quot;)); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;
&nbsp;            // Fire Mode - lots of things have variable modes
<b class="nc">&nbsp;            if (wtype.hasModes()) {</b>
<b class="nc">&nbsp;                wn.append(&#39; &#39;);</b>
&nbsp;                
<b class="nc">&nbsp;                wn.append(mounted.curMode().getDisplayableName());</b>
<b class="nc">&nbsp;                if (!mounted.pendingMode().equals(&quot;None&quot;)) {</b>
<b class="nc">&nbsp;                    wn.append(&quot; (next turn, &quot;);</b>
<b class="nc">&nbsp;                    wn.append(mounted.pendingMode().getDisplayableName());</b>
<b class="nc">&nbsp;                    wn.append(&#39;)&#39;);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if ((game != null)</b>
<b class="nc">&nbsp;                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CALLED_SHOTS)) { //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wn.append(&#39; &#39;);</b>
<b class="nc">&nbsp;                wn.append(mounted.getCalledShot().getDisplayableName());</b>
&nbsp;            }
<b class="nc">&nbsp;            return wn.toString();</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Returns the number of Mounteds in the list.
&nbsp;         */
&nbsp;        @Override
&nbsp;        public int getSize() {
<b class="nc">&nbsp;            return weapons.size();</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Sort the Mounteds, generally using a WeaponComparator.
&nbsp;         *
&nbsp;         * @param comparator
&nbsp;         */
&nbsp;        public void sort(Comparator&lt;Mounted&gt; comparator) {
<b class="nc">&nbsp;            Collections.sort(weapons, comparator);</b>
<b class="nc">&nbsp;            fireContentsChanged(this, 0, weapons.size() - 1);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;    
&nbsp;    
&nbsp;    /**
&nbsp;     * 
&nbsp;     */
&nbsp;    private final UnitDisplay unitDisplay;
&nbsp;    
&nbsp;    /**
&nbsp;     *
&nbsp;     */
&nbsp;    private static final long serialVersionUID = -5728839963281503332L;
&nbsp;    private JComboBox&lt;String&gt; weapSortOrder;
&nbsp;    public JList&lt;String&gt; weaponList;
&nbsp;    /**
&nbsp;     * Keep track of the previous target, used for certain weapons (like VGLs)
&nbsp;     * that will force a target.  With this, we can restore the previous target
&nbsp;     * after the forced target.
&nbsp;     */
<b class="nc">&nbsp;    private Targetable prevTarget = null;</b>
&nbsp;    private JComboBox&lt;String&gt; m_chAmmo;
&nbsp;    public JComboBox&lt;String&gt; m_chBayWeapon;
&nbsp;
&nbsp;    private JLabel wSortOrder;
&nbsp;    private JLabel wAmmo;
&nbsp;    private JLabel wBayWeapon;
&nbsp;    private JLabel wNameL;
&nbsp;    private JLabel wHeatL;
&nbsp;    private JLabel wArcHeatL;
&nbsp;    private JLabel wDamL;
&nbsp;    private JLabel wMinL;
&nbsp;    private JLabel wShortL;
&nbsp;    private JLabel wMedL;
&nbsp;    private JLabel wLongL;
&nbsp;    private JLabel wExtL;
&nbsp;    private JLabel wAVL;
&nbsp;    private JLabel wNameR;
&nbsp;    private JLabel wHeatR;
&nbsp;    private JLabel wArcHeatR;
&nbsp;    private JLabel wDamR;
&nbsp;    private JLabel wMinR;
&nbsp;    private JLabel wShortR;
&nbsp;    private JLabel wMedR;
&nbsp;    private JLabel wLongR;
&nbsp;    private JLabel wExtR;
&nbsp;    private JLabel wShortAVR;
&nbsp;    private JLabel wMedAVR;
&nbsp;    private JLabel wLongAVR;
&nbsp;    private JLabel wExtAVR;
&nbsp;    private JLabel currentHeatBuildupL;
&nbsp;    private JLabel currentHeatBuildupR;
&nbsp;
&nbsp;    private JLabel wTargetL;
&nbsp;    private JLabel wRangeL;
&nbsp;    private JLabel wToHitL;
&nbsp;    public JLabel wTargetR;
&nbsp;    public JLabel wRangeR;
&nbsp;    public JLabel wToHitR;
&nbsp;
&nbsp;    private JLabel wDamageTrooperL;
&nbsp;    private JLabel wDamageTrooperR;
&nbsp;    private JLabel wInfantryRange0L;
&nbsp;    private JLabel wInfantryRange0R;
&nbsp;    private JLabel wInfantryRange1L;
&nbsp;    private JLabel wInfantryRange1R;
&nbsp;    private JLabel wInfantryRange2L;
&nbsp;    private JLabel wInfantryRange2R;
&nbsp;    private JLabel wInfantryRange3L;
&nbsp;    private JLabel wInfantryRange3R;
&nbsp;    private JLabel wInfantryRange4L;
&nbsp;    private JLabel wInfantryRange4R;
&nbsp;    private JLabel wInfantryRange5L;
&nbsp;    private JLabel wInfantryRange5R;
&nbsp;
&nbsp;    public JTextArea toHitText;
&nbsp;
&nbsp;    // I need to keep a pointer to the weapon list of the
&nbsp;    // currently selected mech.
&nbsp;    private ArrayList&lt;Mounted&gt; vAmmo;
&nbsp;    private Entity entity;
&nbsp;
<b class="nc">&nbsp;    private int minTopMargin = 8;</b>
<b class="nc">&nbsp;    private int minLeftMargin = 8;</b>
&nbsp;
<b class="nc">&nbsp;    WeaponPanel(UnitDisplay unitDisplay) {</b>
&nbsp;
<b class="nc">&nbsp;        this.unitDisplay = unitDisplay;</b>
<b class="nc">&nbsp;        setLayout(new GridBagLayout());</b>
&nbsp;
<b class="nc">&nbsp;        int gridy = 0;</b>
<b class="nc">&nbsp;        wSortOrder = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.WeaponSortOrder.label&quot;),</b>
&nbsp;                SwingConstants.LEFT);
<b class="nc">&nbsp;        wSortOrder.setOpaque(false);</b>
<b class="nc">&nbsp;        wSortOrder.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        add(wSortOrder, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(15, 9, 1, 1).gridy(gridy).gridx(0));</b>
<b class="nc">&nbsp;        weapSortOrder = new JComboBox&lt;String&gt;();</b>
<b class="nc">&nbsp;        for (Entity.WeaponSortOrder s : Entity.WeaponSortOrder.values()) {</b>
<b class="nc">&nbsp;            String entry = &quot;MechDisplay.WeaponSortOrder.&quot; + s.i18nEntry;</b>
<b class="nc">&nbsp;            weapSortOrder.addItem(Messages.getString(entry));</b>
&nbsp;        }
<b class="nc">&nbsp;        add(weapSortOrder,</b>
<b class="nc">&nbsp;                GBC.eol().insets(15, 9, 15, 1)</b>
<b class="nc">&nbsp;                   .fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                   .anchor(GridBagConstraints.CENTER).gridy(gridy)</b>
<b class="nc">&nbsp;                   .gridx(1));</b>
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;
&nbsp;        // weapon list
<b class="nc">&nbsp;        weaponList = new JList&lt;String&gt;(new DefaultListModel&lt;String&gt;());</b>
<b class="nc">&nbsp;        WeaponListMouseAdapter mouseAdapter = new WeaponListMouseAdapter();</b>
<b class="nc">&nbsp;        weaponList.addMouseListener(mouseAdapter);</b>
<b class="nc">&nbsp;        weaponList.addMouseMotionListener(mouseAdapter);</b>
<b class="nc">&nbsp;        JScrollPane tWeaponScroll = new JScrollPane(weaponList);</b>
<b class="nc">&nbsp;        tWeaponScroll.setMinimumSize(new Dimension(200, 100));</b>
<b class="nc">&nbsp;        tWeaponScroll.setPreferredSize(new Dimension(200, 100));</b>
<b class="nc">&nbsp;        add(tWeaponScroll,</b>
<b class="nc">&nbsp;            GBC.eol().insets(15, 9, 15, 9)</b>
<b class="nc">&nbsp;               .fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .anchor(GridBagConstraints.CENTER).gridy(gridy)</b>
<b class="nc">&nbsp;               .gridx(0));</b>
<b class="nc">&nbsp;        gridy++;</b>
<b class="nc">&nbsp;        weaponList.resetKeyboardActions();</b>
<b class="nc">&nbsp;        for (KeyListener key : weaponList.getKeyListeners()) {</b>
<b class="nc">&nbsp;            weaponList.removeKeyListener(key);</b>
&nbsp;        }
&nbsp;
&nbsp;        // adding Ammo choice + label
&nbsp;
<b class="nc">&nbsp;        wAmmo = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Ammo&quot;), SwingConstants.LEFT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wAmmo.setOpaque(false);</b>
<b class="nc">&nbsp;        wAmmo.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        m_chAmmo = new JComboBox&lt;String&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        wBayWeapon = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Weapon&quot;), SwingConstants.LEFT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wBayWeapon.setOpaque(false);</b>
<b class="nc">&nbsp;        wBayWeapon.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        m_chBayWeapon = new JComboBox&lt;String&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        add(wBayWeapon, GBC.std().insets(15, 1, 1, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(m_chBayWeapon, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                              .insets(1, 1, 15, 1).gridy(gridy).gridx(1));</b>
<b class="nc">&nbsp;        gridy++;</b>
<b class="nc">&nbsp;        add(wAmmo, GBC.std().insets(15, 9, 1, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(m_chAmmo,</b>
<b class="nc">&nbsp;            GBC.eol().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 15, 1).gridy(gridy).gridx(1));</b>
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;        // Adding Heat Buildup
&nbsp;
<b class="nc">&nbsp;        currentHeatBuildupL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.HeatBuildup&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        currentHeatBuildupL.setOpaque(false);</b>
<b class="nc">&nbsp;        currentHeatBuildupL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        currentHeatBuildupR = new JLabel(&quot;--&quot;, SwingConstants.LEFT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        currentHeatBuildupR.setOpaque(false);</b>
<b class="nc">&nbsp;        currentHeatBuildupR.setForeground(Color.WHITE);</b>
&nbsp;
<b class="nc">&nbsp;        add(currentHeatBuildupL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .anchor(GridBagConstraints.EAST).insets(9, 1, 1, 9)</b>
<b class="nc">&nbsp;               .gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(currentHeatBuildupR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 1, 9, 9).gridy(gridy).gridx(1));</b>
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;
&nbsp;        // Adding weapon display labels
<b class="nc">&nbsp;        wNameL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Name&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wNameL.setOpaque(false);</b>
<b class="nc">&nbsp;        wNameL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wHeatL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Heat&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wHeatL.setOpaque(false);</b>
<b class="nc">&nbsp;        wHeatL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wDamL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Damage&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wDamL.setOpaque(false);</b>
<b class="nc">&nbsp;        wDamL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wArcHeatL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.ArcHeat&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wArcHeatL.setOpaque(false);</b>
<b class="nc">&nbsp;        wArcHeatL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wNameR = new JLabel(&quot;&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wNameR.setOpaque(false);</b>
<b class="nc">&nbsp;        wNameR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wHeatR = new JLabel(&quot;--&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wHeatR.setOpaque(false);</b>
<b class="nc">&nbsp;        wHeatR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wDamR = new JLabel(&quot;--&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wDamR.setOpaque(false);</b>
<b class="nc">&nbsp;        wDamR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wArcHeatR = new JLabel(&quot;--&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wArcHeatR.setOpaque(false);</b>
<b class="nc">&nbsp;        wArcHeatR.setForeground(Color.WHITE);</b>
&nbsp;
<b class="nc">&nbsp;        wDamageTrooperL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.DamageTrooper&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wDamageTrooperL.setOpaque(false);</b>
<b class="nc">&nbsp;        wDamageTrooperL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wDamageTrooperR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wDamageTrooperR.setOpaque(false);</b>
<b class="nc">&nbsp;        wDamageTrooperR.setForeground(Color.WHITE);</b>
&nbsp;
<b class="nc">&nbsp;        add(wNameL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wHeatL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</b>
&nbsp;
<b class="nc">&nbsp;        add(wDamL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(2));</b>
&nbsp;
<b class="nc">&nbsp;        add(wArcHeatL, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                          .insets(1, 9, 1, 1).gridy(gridy).gridx(3));</b>
&nbsp;
<b class="nc">&nbsp;        add(wDamageTrooperL, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                                .insets(1, 9, 1, 1).gridy(gridy).gridx(3));</b>
<b class="nc">&nbsp;        gridy++;</b>
<b class="nc">&nbsp;        add(wNameR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wHeatR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</b>
&nbsp;
<b class="nc">&nbsp;        add(wDamR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(2));</b>
&nbsp;
<b class="nc">&nbsp;        add(wArcHeatR, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                          .insets(1, 9, 1, 1).gridy(gridy).gridx(3));</b>
&nbsp;
<b class="nc">&nbsp;        add(wDamageTrooperR, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                                .insets(1, 9, 1, 1).gridy(gridy).gridx(3));</b>
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;        // Adding range labels
<b class="nc">&nbsp;        wMinL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Min&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wMinL.setOpaque(false);</b>
<b class="nc">&nbsp;        wMinL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wShortL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Short&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wShortL.setOpaque(false);</b>
<b class="nc">&nbsp;        wShortL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wMedL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Med&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wMedL.setOpaque(false);</b>
<b class="nc">&nbsp;        wMedL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wLongL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Long&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wLongL.setOpaque(false);</b>
<b class="nc">&nbsp;        wLongL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wExtL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Ext&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wExtL.setOpaque(false);</b>
<b class="nc">&nbsp;        wExtL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wMinR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wMinR.setOpaque(false);</b>
<b class="nc">&nbsp;        wMinR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wShortR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wShortR.setOpaque(false);</b>
<b class="nc">&nbsp;        wShortR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wMedR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wMedR.setOpaque(false);</b>
<b class="nc">&nbsp;        wMedR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wLongR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wLongR.setOpaque(false);</b>
<b class="nc">&nbsp;        wLongR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wExtR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wExtR.setOpaque(false);</b>
<b class="nc">&nbsp;        wExtR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wAVL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.AV&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wAVL.setOpaque(false);</b>
<b class="nc">&nbsp;        wAVL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wShortAVR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wShortAVR.setOpaque(false);</b>
<b class="nc">&nbsp;        wShortAVR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wMedAVR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wMedAVR.setOpaque(false);</b>
<b class="nc">&nbsp;        wMedAVR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wLongAVR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wLongAVR.setOpaque(false);</b>
<b class="nc">&nbsp;        wLongAVR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wExtAVR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wExtAVR.setOpaque(false);</b>
<b class="nc">&nbsp;        wExtAVR.setForeground(Color.WHITE);</b>
&nbsp;
<b class="nc">&nbsp;        wInfantryRange0L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange0L.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange0L.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange0R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange0R.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange0R.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange1L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange1L.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange1L.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange1R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange1R.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange1R.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange2L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange2L.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange2L.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange2R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange2R.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange2R.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange3L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange3L.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange3L.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange3R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange3R.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange3R.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange4L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange4L.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange4L.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange4R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange4R.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange4R.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange5L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange5L.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange5L.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wInfantryRange5R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wInfantryRange5R.setOpaque(false);</b>
<b class="nc">&nbsp;        wInfantryRange5R.setForeground(Color.WHITE);</b>
&nbsp;
<b class="nc">&nbsp;        add(wMinL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wShortL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</b>
&nbsp;
<b class="nc">&nbsp;        add(wMedL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</b>
&nbsp;
<b class="nc">&nbsp;        add(wLongL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</b>
&nbsp;
<b class="nc">&nbsp;        add(wExtL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange0L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange1L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange2L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange3L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange4L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange5L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</b>
&nbsp;
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;        // ----------------
&nbsp;
<b class="nc">&nbsp;        add(wMinR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wShortR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</b>
&nbsp;
<b class="nc">&nbsp;        add(wMedR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</b>
&nbsp;
<b class="nc">&nbsp;        add(wLongR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</b>
&nbsp;
<b class="nc">&nbsp;        add(wExtR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange0R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange1R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange2R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange3R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange4R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</b>
&nbsp;
<b class="nc">&nbsp;        add(wInfantryRange5R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                            .insets(1, 9, 9, 1).gridy(gridy).gridx(5));</b>
&nbsp;
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;        // ----------------
<b class="nc">&nbsp;        add(wAVL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wShortAVR, GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;                          .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</b>
&nbsp;
<b class="nc">&nbsp;        add(wMedAVR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</b>
&nbsp;
<b class="nc">&nbsp;        add(wLongAVR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</b>
&nbsp;
<b class="nc">&nbsp;        add(wExtAVR,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</b>
&nbsp;
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;        // target panel
<b class="nc">&nbsp;        wTargetL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Target&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wTargetL.setOpaque(false);</b>
<b class="nc">&nbsp;        wTargetL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wRangeL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.Range&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wRangeL.setOpaque(false);</b>
<b class="nc">&nbsp;        wRangeL.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wToHitL = new JLabel(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.ToHit&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wToHitL.setOpaque(false);</b>
<b class="nc">&nbsp;        wToHitL.setForeground(Color.WHITE);</b>
&nbsp;
<b class="nc">&nbsp;        wTargetR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wTargetR.setOpaque(false);</b>
<b class="nc">&nbsp;        wTargetR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wRangeR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wRangeR.setOpaque(false);</b>
<b class="nc">&nbsp;        wRangeR.setForeground(Color.WHITE);</b>
<b class="nc">&nbsp;        wToHitR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wToHitR.setOpaque(false);</b>
<b class="nc">&nbsp;        wToHitR.setForeground(Color.WHITE);</b>
&nbsp;
<b class="nc">&nbsp;        add(wTargetL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wTargetR,</b>
<b class="nc">&nbsp;            GBC.eol().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</b>
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;
<b class="nc">&nbsp;        add(wRangeL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wRangeR,</b>
<b class="nc">&nbsp;            GBC.eol().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</b>
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;
<b class="nc">&nbsp;        add(wToHitL,</b>
<b class="nc">&nbsp;            GBC.std().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</b>
&nbsp;
<b class="nc">&nbsp;        add(wToHitR,</b>
<b class="nc">&nbsp;            GBC.eol().fill(GridBagConstraints.HORIZONTAL)</b>
<b class="nc">&nbsp;               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</b>
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;
&nbsp;        // to-hit text
<b class="nc">&nbsp;        toHitText = new JTextArea(&quot;&quot;, 2, 20); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        toHitText.setEditable(false);</b>
<b class="nc">&nbsp;        toHitText.setLineWrap(true);</b>
<b class="nc">&nbsp;        toHitText.setFont(new Font(&quot;SansSerif&quot;, Font.PLAIN, 10)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        add(toHitText,</b>
<b class="nc">&nbsp;            GBC.eol().fill(GridBagConstraints.BOTH)</b>
<b class="nc">&nbsp;               .insets(15, 9, 15, 9).gridy(gridy).gridx(0)</b>
<b class="nc">&nbsp;               .gridheight(2));</b>
<b class="nc">&nbsp;        gridy++;</b>
&nbsp;
<b class="nc">&nbsp;        addListeners();</b>
&nbsp;        
<b class="nc">&nbsp;        setBackGround();</b>
<b class="nc">&nbsp;        onResize();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onResize() {
<b class="nc">&nbsp;        int w = getSize().width;</b>
<b class="nc">&nbsp;        Rectangle r = getContentBounds();</b>
<b class="nc">&nbsp;        if (r == null) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        int dx = Math.round(((w - r.width) / 2));</b>
<b class="nc">&nbsp;        if (dx &lt; minLeftMargin) {</b>
<b class="nc">&nbsp;            dx = minLeftMargin;</b>
&nbsp;        }
<b class="nc">&nbsp;        int dy = minTopMargin;</b>
<b class="nc">&nbsp;        setContentMargins(dx, dy, dx, dy);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setBackGround() {
&nbsp;        UnitDisplaySkinSpecification udSpec = SkinXMLHandler
<b class="nc">&nbsp;                .getUnitDisplaySkin();</b>
&nbsp;
<b class="nc">&nbsp;        Image tile = getToolkit()</b>
<b class="nc">&nbsp;                .getImage(</b>
<b class="nc">&nbsp;                        new MegaMekFile(Configuration.widgetsDir(), udSpec</b>
<b class="nc">&nbsp;                                .getBackgroundTile()).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(tile, this);</b>
<b class="nc">&nbsp;        int b = BackGroundDrawer.TILING_BOTH;</b>
<b class="nc">&nbsp;        addBgDrawer(new BackGroundDrawer(tile, b));</b>
&nbsp;
<b class="nc">&nbsp;        b = BackGroundDrawer.TILING_HORIZONTAL | BackGroundDrawer.VALIGN_TOP;</b>
<b class="nc">&nbsp;        tile = getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.widgetsDir(), udSpec.getTopLine())</b>
<b class="nc">&nbsp;                        .toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(tile, this);</b>
<b class="nc">&nbsp;        addBgDrawer(new BackGroundDrawer(tile, b));</b>
&nbsp;
<b class="nc">&nbsp;        b = BackGroundDrawer.TILING_HORIZONTAL | BackGroundDrawer.VALIGN_BOTTOM;</b>
<b class="nc">&nbsp;        tile = getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.widgetsDir(), udSpec.getBottomLine())</b>
<b class="nc">&nbsp;                        .toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(tile, this);</b>
<b class="nc">&nbsp;        addBgDrawer(new BackGroundDrawer(tile, b));</b>
&nbsp;
<b class="nc">&nbsp;        b = BackGroundDrawer.TILING_VERTICAL | BackGroundDrawer.HALIGN_LEFT;</b>
<b class="nc">&nbsp;        tile = getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.widgetsDir(), udSpec.getLeftLine())</b>
<b class="nc">&nbsp;                        .toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(tile, this);</b>
<b class="nc">&nbsp;        addBgDrawer(new BackGroundDrawer(tile, b));</b>
&nbsp;
<b class="nc">&nbsp;        b = BackGroundDrawer.TILING_VERTICAL | BackGroundDrawer.HALIGN_RIGHT;</b>
<b class="nc">&nbsp;        tile = getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.widgetsDir(), udSpec.getRightLine())</b>
<b class="nc">&nbsp;                        .toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(tile, this);</b>
<b class="nc">&nbsp;        addBgDrawer(new BackGroundDrawer(tile, b));</b>
&nbsp;
<b class="nc">&nbsp;        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_TOP</b>
&nbsp;                | BackGroundDrawer.HALIGN_LEFT;
<b class="nc">&nbsp;        tile = getToolkit()</b>
<b class="nc">&nbsp;                .getImage(</b>
<b class="nc">&nbsp;                        new MegaMekFile(Configuration.widgetsDir(), udSpec</b>
<b class="nc">&nbsp;                                .getTopLeftCorner()).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(tile, this);</b>
<b class="nc">&nbsp;        addBgDrawer(new BackGroundDrawer(tile, b));</b>
&nbsp;
<b class="nc">&nbsp;        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_BOTTOM</b>
&nbsp;                | BackGroundDrawer.HALIGN_LEFT;
<b class="nc">&nbsp;        tile = getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.widgetsDir(), udSpec</b>
<b class="nc">&nbsp;                        .getBottomLeftCorner()).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(tile, this);</b>
<b class="nc">&nbsp;        addBgDrawer(new BackGroundDrawer(tile, b));</b>
&nbsp;
<b class="nc">&nbsp;        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_TOP</b>
&nbsp;                | BackGroundDrawer.HALIGN_RIGHT;
<b class="nc">&nbsp;        tile = getToolkit()</b>
<b class="nc">&nbsp;                .getImage(</b>
<b class="nc">&nbsp;                        new MegaMekFile(Configuration.widgetsDir(), udSpec</b>
<b class="nc">&nbsp;                                .getTopRightCorner()).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(tile, this);</b>
<b class="nc">&nbsp;        addBgDrawer(new BackGroundDrawer(tile, b));</b>
&nbsp;
<b class="nc">&nbsp;        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_BOTTOM</b>
&nbsp;                | BackGroundDrawer.HALIGN_RIGHT;
<b class="nc">&nbsp;        tile = getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.widgetsDir(), udSpec</b>
<b class="nc">&nbsp;                        .getBottomRightCorner()).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(tile, this);</b>
<b class="nc">&nbsp;        addBgDrawer(new BackGroundDrawer(tile, b));</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * updates fields for the specified mech
&nbsp;     * &lt;p/&gt;
&nbsp;     * fix the ammo when it&#39;s added
&nbsp;     */
&nbsp;    public void displayMech(Entity en) {
<b class="nc">&nbsp;        removeListeners();</b>
&nbsp;        
&nbsp;        // Grab a copy of the game.
<b class="nc">&nbsp;        IGame game = null;</b>
&nbsp;
<b class="nc">&nbsp;        if (unitDisplay.getClientGUI() != null) {</b>
<b class="nc">&nbsp;            game = unitDisplay.getClientGUI().getClient().getGame();</b>
&nbsp;        }
&nbsp;
&nbsp;        // update pointer to weapons
<b class="nc">&nbsp;        entity = en;</b>
&nbsp;
&nbsp;        // Check Game Options for max external heat
<b class="nc">&nbsp;        int max_ext_heat = game != null ? game.getOptions().intOption(OptionsConstants.ADVCOMBAT_MAX_EXTERNAL_HEAT) : 15;</b>
<b class="nc">&nbsp;        if (max_ext_heat &lt; 0) {</b>
<b class="nc">&nbsp;            max_ext_heat = 15; // Standard value specified in TW p.159</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int currentHeatBuildup = (en.heat // heat from last round                </b>
<b class="nc">&nbsp;                + en.getEngineCritHeat() // heat engine crits will add</b>
<b class="nc">&nbsp;                + Math.min(max_ext_heat, en.heatFromExternal) // heat from external sources</b>
&nbsp;                + en.heatBuildup) // heat we&#39;re building up this round
<b class="nc">&nbsp;                - Math.min(9, en.coolFromExternal); // cooling from external</b>
&nbsp;        // sources
<b class="nc">&nbsp;        if (en instanceof Mech) {</b>
<b class="nc">&nbsp;            if (en.infernos.isStillBurning()) { // hit with inferno ammo</b>
<b class="nc">&nbsp;                currentHeatBuildup += en.infernos.getHeat();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!((Mech) en).hasLaserHeatSinks()) {</b>
&nbsp;                // extreme temperatures.
<b class="nc">&nbsp;                if ((game != null) &amp;&amp; (game.getPlanetaryConditions().getTemperature() &gt; 0)) {</b>
<b class="nc">&nbsp;                    int buildup = game.getPlanetaryConditions()</b>
<b class="nc">&nbsp;                                      .getTemperatureDifference(50, -30);</b>
<b class="nc">&nbsp;                    if (((Mech) en).hasIntactHeatDissipatingArmor()) {</b>
<b class="nc">&nbsp;                        buildup /= 2;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    currentHeatBuildup += buildup;</b>
<b class="nc">&nbsp;                } else if (game != null) {</b>
<b class="nc">&nbsp;                    currentHeatBuildup -= game.getPlanetaryConditions()</b>
<b class="nc">&nbsp;                                              .getTemperatureDifference(50, -30);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        Coords position = entity.getPosition();</b>
<b class="nc">&nbsp;        if (!en.isOffBoard() &amp;&amp; (position != null)) {</b>
<b class="nc">&nbsp;            IHex hex = game.getBoard().getHex(position);</b>
<b class="nc">&nbsp;            if (hex.containsTerrain(Terrains.FIRE)</b>
<b class="nc">&nbsp;                &amp;&amp; (hex.getFireTurn() &gt; 0)) {</b>
&nbsp;                // standing in fire
<b class="nc">&nbsp;                if ((en instanceof Mech)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((Mech) en).hasIntactHeatDissipatingArmor()) {</b>
<b class="nc">&nbsp;                    currentHeatBuildup += 2;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    currentHeatBuildup += 5;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (hex.terrainLevel(Terrains.MAGMA) == 1) {</b>
<b class="nc">&nbsp;                if ((en instanceof Mech)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((Mech) en).hasIntactHeatDissipatingArmor()) {</b>
<b class="nc">&nbsp;                    currentHeatBuildup += 2;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    currentHeatBuildup += 5;</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (hex.terrainLevel(Terrains.MAGMA) == 2) {</b>
<b class="nc">&nbsp;                if ((en instanceof Mech)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((Mech) en).hasIntactHeatDissipatingArmor()) {</b>
<b class="nc">&nbsp;                    currentHeatBuildup += 5;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    currentHeatBuildup += 10;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if ((((en instanceof Mech) || (en instanceof Aero)) &amp;&amp; en.isStealthActive())</b>
<b class="nc">&nbsp;            || en.isNullSigActive() || en.isVoidSigActive()) {</b>
<b class="nc">&nbsp;            currentHeatBuildup += 10; // active stealth/null sig/void sig</b>
&nbsp;            // heat
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if ((en instanceof Mech) &amp;&amp; en.isChameleonShieldOn()) {</b>
<b class="nc">&nbsp;            currentHeatBuildup += 6;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (((en instanceof Mech) || (en instanceof Aero)) &amp;&amp; en.hasActiveNovaCEWS()) {</b>
<b class="nc">&nbsp;            currentHeatBuildup += 2;</b>
&nbsp;        }
&nbsp;
&nbsp;        // update weapon list
<b class="nc">&nbsp;        weaponList.setModel(new WeaponListModel(en));</b>
<b class="nc">&nbsp;        ((DefaultComboBoxModel&lt;String&gt;) m_chAmmo.getModel()).removeAllElements();</b>
&nbsp;
<b class="nc">&nbsp;        m_chAmmo.setEnabled(false);</b>
<b class="nc">&nbsp;        m_chBayWeapon.removeAllItems();</b>
<b class="nc">&nbsp;        m_chBayWeapon.setEnabled(false);</b>
&nbsp;
&nbsp;        // on large craft we may need to take account of firing arcs
<b class="nc">&nbsp;        boolean[] usedFrontArc = new boolean[entity.locations()];</b>
<b class="nc">&nbsp;        boolean[] usedRearArc = new boolean[entity.locations()];</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; entity.locations(); i++) {</b>
<b class="nc">&nbsp;            usedFrontArc[i] = false;</b>
<b class="nc">&nbsp;            usedRearArc[i] = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        boolean hasFiredWeapons = false;</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; entity.getWeaponList().size(); i++) {</b>
<b class="nc">&nbsp;            Mounted mounted = entity.getWeaponList().get(i);</b>
&nbsp;
&nbsp;            // Don&#39;t add bomb weapons for LAMs in mech mode except RL and TAG.
<b class="nc">&nbsp;            if ((entity instanceof LandAirMech)</b>
<b class="nc">&nbsp;                    &amp;&amp; (entity.getConversionMode() == LandAirMech.CONV_MODE_MECH)</b>
<b class="nc">&nbsp;                    &amp;&amp; mounted.getType().hasFlag(WeaponType.F_BOMB_WEAPON)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((WeaponType)mounted.getType()).getAmmoType() != AmmoType.T_RL_BOMB</b>
<b class="nc">&nbsp;                    &amp;&amp; !mounted.getType().hasFlag(WeaponType.F_TAG)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            ((WeaponListModel) weaponList.getModel()).addWeapon(mounted);</b>
<b class="nc">&nbsp;            if (mounted.isUsedThisRound()</b>
<b class="nc">&nbsp;                &amp;&amp; (game.getPhase() == mounted.usedInPhase())</b>
<b class="nc">&nbsp;                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_FIRING)) {</b>
<b class="nc">&nbsp;                hasFiredWeapons = true;</b>
&nbsp;                // add heat from weapons fire to heat tracker
<b class="nc">&nbsp;                if (entity.usesWeaponBays()) {</b>
&nbsp;                    // if using bay heat option then don&#39;t add total arc
<b class="nc">&nbsp;                    if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_HEAT_BY_BAY)) {</b>
<b class="nc">&nbsp;                        for (int wId : mounted.getBayWeapons()) {</b>
<b class="nc">&nbsp;                            currentHeatBuildup += entity.getEquipment(wId)</b>
<b class="nc">&nbsp;                                                        .getCurrentHeat();</b>
<b class="nc">&nbsp;                        }</b>
&nbsp;                    } else {
&nbsp;                        // check whether arc has fired
<b class="nc">&nbsp;                        int loc = mounted.getLocation();</b>
<b class="nc">&nbsp;                        boolean rearMount = mounted.isRearMounted();</b>
<b class="nc">&nbsp;                        if (!rearMount) {</b>
<b class="nc">&nbsp;                            if (!usedFrontArc[loc]) {</b>
<b class="nc">&nbsp;                                currentHeatBuildup += entity.getHeatInArc(</b>
&nbsp;                                        loc, rearMount);
<b class="nc">&nbsp;                                usedFrontArc[loc] = true;</b>
&nbsp;                            }
&nbsp;                        } else {
<b class="nc">&nbsp;                            if (!usedRearArc[loc]) {</b>
<b class="nc">&nbsp;                                currentHeatBuildup += entity.getHeatInArc(</b>
&nbsp;                                        loc, rearMount);
<b class="nc">&nbsp;                                usedRearArc[loc] = true;</b>
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    if (!mounted.isBombMounted()) {</b>
<b class="nc">&nbsp;                        currentHeatBuildup += mounted.getCurrentHeat();</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        weapSortOrder.setSelectedIndex(entity.getWeaponSortOrder().ordinal());</b>
<b class="nc">&nbsp;        setWeaponComparator(weapSortOrder.getSelectedIndex());</b>
&nbsp;
<b class="nc">&nbsp;        if (en.hasDamagedRHS() &amp;&amp; hasFiredWeapons) {</b>
<b class="nc">&nbsp;            currentHeatBuildup++;</b>
&nbsp;        }
&nbsp;
&nbsp;        // This code block copied from the MovementPanel class,
&nbsp;        // bad coding practice (duplicate code).
&nbsp;        int heatCap;
<b class="nc">&nbsp;        if (en instanceof Mech) {</b>
<b class="nc">&nbsp;            heatCap = ((Mech) en).getHeatCapacity(true, false);</b>
<b class="nc">&nbsp;        } else if (en instanceof Aero) {</b>
<b class="nc">&nbsp;            heatCap = en.getHeatCapacity(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            heatCap = en.getHeatCapacity();</b>
&nbsp;        }
<b class="nc">&nbsp;        int heatCapWater = en.getHeatCapacityWithWater();</b>
<b class="nc">&nbsp;        if (en.getCoolantFailureAmount() &gt; 0) {</b>
<b class="nc">&nbsp;            heatCap -= en.getCoolantFailureAmount();</b>
<b class="nc">&nbsp;            heatCapWater -= en.getCoolantFailureAmount();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (en.hasActivatedRadicalHS()) {</b>
<b class="nc">&nbsp;            if (en instanceof Mech) {</b>
<b class="nc">&nbsp;                heatCap += ((Mech) en).getActiveSinks();</b>
<b class="nc">&nbsp;                heatCapWater += ((Mech) en).getActiveSinks();</b>
<b class="nc">&nbsp;            } else if (en instanceof Aero) {</b>
<b class="nc">&nbsp;                heatCap += ((Aero) en).getHeatSinks();</b>
<b class="nc">&nbsp;                heatCapWater += ((Aero) en).getHeatSinks();</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        String heatCapacityStr = Integer.toString(heatCap);</b>
&nbsp;
<b class="nc">&nbsp;        if (heatCap &lt; heatCapWater) {</b>
<b class="nc">&nbsp;            heatCapacityStr = heatCap + &quot; [&quot; + heatCapWater + &#39;]&#39;; //$NON-NLS-1$</b>
&nbsp;        }
&nbsp;        // end duplicate block
&nbsp;
&nbsp;        // check for negative values due to extreme temp
<b class="nc">&nbsp;        if (currentHeatBuildup &lt; 0) {</b>
<b class="nc">&nbsp;            currentHeatBuildup = 0;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        String heatText = Integer.toString(currentHeatBuildup);</b>
<b class="nc">&nbsp;        if (currentHeatBuildup &gt; en.getHeatCapacityWithWater()) {</b>
<b class="nc">&nbsp;            heatText += &quot;*&quot;; // overheat indication //$NON-NLS-1$</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        currentHeatBuildupR.setText(heatText + &quot; (&quot; + heatCapacityStr + &#39;)&#39;); //$NON-NLS-1$</b>
&nbsp;
&nbsp;        // change what is visible based on type
<b class="nc">&nbsp;        if (entity.usesWeaponBays()) {</b>
<b class="nc">&nbsp;            wArcHeatL.setVisible(true);</b>
<b class="nc">&nbsp;            wArcHeatR.setVisible(true);</b>
<b class="nc">&nbsp;            m_chBayWeapon.setVisible(true);</b>
<b class="nc">&nbsp;            wBayWeapon.setVisible(true);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wArcHeatL.setVisible(false);</b>
<b class="nc">&nbsp;            wArcHeatR.setVisible(false);</b>
<b class="nc">&nbsp;            m_chBayWeapon.setVisible(false);</b>
<b class="nc">&nbsp;            wBayWeapon.setVisible(false);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        wDamageTrooperL.setVisible(false);</b>
<b class="nc">&nbsp;        wDamageTrooperR.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange0L.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange0R.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange1L.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange1R.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange2L.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange2R.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange3L.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange3R.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange4L.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange4R.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange5L.setVisible(false);</b>
<b class="nc">&nbsp;        wInfantryRange5R.setVisible(false);</b>
&nbsp;
<b class="nc">&nbsp;        if (entity.isAero() &amp;&amp; (entity.isAirborne() || entity.usesWeaponBays())) {</b>
<b class="nc">&nbsp;            wAVL.setVisible(true);</b>
<b class="nc">&nbsp;            wShortAVR.setVisible(true);</b>
<b class="nc">&nbsp;            wMedAVR.setVisible(true);</b>
<b class="nc">&nbsp;            wLongAVR.setVisible(true);</b>
<b class="nc">&nbsp;            wExtAVR.setVisible(true);</b>
<b class="nc">&nbsp;            wMinL.setVisible(false);</b>
<b class="nc">&nbsp;            wMinR.setVisible(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wAVL.setVisible(false);</b>
<b class="nc">&nbsp;            wShortAVR.setVisible(false);</b>
<b class="nc">&nbsp;            wMedAVR.setVisible(false);</b>
<b class="nc">&nbsp;            wLongAVR.setVisible(false);</b>
<b class="nc">&nbsp;            wExtAVR.setVisible(false);</b>
<b class="nc">&nbsp;            wMinL.setVisible(true);</b>
<b class="nc">&nbsp;            wMinR.setVisible(true);</b>
&nbsp;        }
&nbsp;
&nbsp;        // If MaxTech range rules are in play, display the extreme range.
<b class="nc">&nbsp;        if (((game != null) &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_RANGE))</b>
<b class="nc">&nbsp;                || (entity.isAero() &amp;&amp; (entity.isAirborne() || entity.usesWeaponBays()))) { // $NON-NLS-1$</b>
<b class="nc">&nbsp;            wExtL.setVisible(true);</b>
<b class="nc">&nbsp;            wExtR.setVisible(true);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wExtL.setVisible(false);</b>
<b class="nc">&nbsp;            wExtR.setVisible(false);</b>
&nbsp;        }
<b class="nc">&nbsp;        onResize();</b>
<b class="nc">&nbsp;        addListeners();</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getSelectedEntityId() {
<b class="nc">&nbsp;        return entity.getId();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Selects the weapon with the specified weapon ID.
&nbsp;     */
&nbsp;    public void selectWeapon(int wn) {
<b class="nc">&nbsp;        if (wn == -1) {</b>
<b class="nc">&nbsp;            weaponList.setSelectedIndex(-1);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        int index = ((WeaponListModel)weaponList.getModel()).getIndex(wn);</b>
<b class="nc">&nbsp;        if (index == -1) {</b>
<b class="nc">&nbsp;            weaponList.setSelectedIndex(-1);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        weaponList.setSelectedIndex(index);</b>
<b class="nc">&nbsp;        weaponList.ensureIndexIsVisible(index);</b>
<b class="nc">&nbsp;        displaySelected();</b>
<b class="nc">&nbsp;        weaponList.repaint();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns the Mounted for the selected weapon in the weapon list.
&nbsp;     * @return
&nbsp;     */
&nbsp;    public Mounted getSelectedWeapon() {
<b class="nc">&nbsp;        int selected = weaponList.getSelectedIndex();</b>
<b class="nc">&nbsp;        if (selected == -1) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        return ((WeaponListModel) weaponList.getModel())</b>
<b class="nc">&nbsp;                .getWeaponAt(selected);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns the equipment ID number for the weapon currently selected
&nbsp;     */
&nbsp;    public int getSelectedWeaponNum() {
<b class="nc">&nbsp;        int selected = weaponList.getSelectedIndex();</b>
<b class="nc">&nbsp;        if (selected == -1) {</b>
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
<b class="nc">&nbsp;        return entity.getEquipmentNum(((WeaponListModel) weaponList</b>
<b class="nc">&nbsp;                .getModel()).getWeaponAt(selected));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Selects the first valid weapon in the weapon list.
&nbsp;     * @return The weapon id of the weapon selected
&nbsp;     */
&nbsp;    public int selectFirstWeapon() {
&nbsp;        // Entity has no weapons, return -1;
<b class="nc">&nbsp;        if (entity.getWeaponList().size() == 0</b>
<b class="nc">&nbsp;                || (entity.usesWeaponBays() </b>
<b class="nc">&nbsp;                        &amp;&amp; entity.getWeaponBayList().size() == 0)) {</b>
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
<b class="nc">&nbsp;        WeaponListModel weapList = (WeaponListModel)weaponList.getModel();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; weaponList.getModel().getSize(); i++) {</b>
<b class="nc">&nbsp;            Mounted selectedWeap = weapList.getWeaponAt(i);</b>
<b class="nc">&nbsp;            if (entity.isWeaponValidForPhase(selectedWeap)) {</b>
<b class="nc">&nbsp;                weaponList.setSelectedIndex(i);</b>
<b class="nc">&nbsp;                weaponList.ensureIndexIsVisible(i);</b>
<b class="nc">&nbsp;                return entity.getEquipmentNum(selectedWeap);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        // Found no valid weapon
<b class="nc">&nbsp;        weaponList.setSelectedIndex(-1);</b>
<b class="nc">&nbsp;        return -1;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getNextWeaponListIdx() {
<b class="nc">&nbsp;        int selected = weaponList.getSelectedIndex();</b>
&nbsp;        // In case nothing was selected
<b class="nc">&nbsp;        if (selected == -1) {</b>
<b class="nc">&nbsp;            selected = weaponList.getModel().getSize() - 1;</b>
&nbsp;        }
&nbsp;        Mounted selectedWeap;
<b class="nc">&nbsp;        int initialSelection = selected;</b>
&nbsp;        
<b class="nc">&nbsp;        boolean hasLooped = false;</b>
&nbsp;        do {
<b class="nc">&nbsp;            selected++;</b>
<b class="nc">&nbsp;            if (selected &gt;= weaponList.getModel().getSize()) {</b>
<b class="nc">&nbsp;                selected = 0;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (selected == initialSelection) {</b>
<b class="nc">&nbsp;                hasLooped = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            selectedWeap = ((WeaponListModel) weaponList.getModel())</b>
<b class="nc">&nbsp;                    .getWeaponAt(selected);</b>
<b class="nc">&nbsp;        } while (!hasLooped &amp;&amp; !entity.isWeaponValidForPhase(selectedWeap));</b>
&nbsp;
<b class="nc">&nbsp;        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())</b>
&nbsp;                &amp;&amp; !hasLooped) {
<b class="nc">&nbsp;            return selected;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        } 
&nbsp;    }
&nbsp;    
&nbsp;    public int getPrevWeaponListIdx() {
<b class="nc">&nbsp;        int selected = weaponList.getSelectedIndex();</b>
&nbsp;        // In case nothing was selected
<b class="nc">&nbsp;        if (selected == -1) {</b>
<b class="nc">&nbsp;            selected = 0;</b>
&nbsp;        }
&nbsp;        Mounted selectedWeap;
<b class="nc">&nbsp;        int initialSelection = selected;</b>
<b class="nc">&nbsp;        boolean hasLooped = false;</b>
&nbsp;        do {
<b class="nc">&nbsp;            selected--;</b>
<b class="nc">&nbsp;            if (selected &lt; 0) {</b>
<b class="nc">&nbsp;                selected = weaponList.getModel().getSize() - 1;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (selected == initialSelection) {</b>
<b class="nc">&nbsp;                hasLooped = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            selectedWeap = ((WeaponListModel) weaponList.getModel())</b>
<b class="nc">&nbsp;                    .getWeaponAt(selected);</b>
<b class="nc">&nbsp;        } while (!hasLooped &amp;&amp; !entity.isWeaponValidForPhase(selectedWeap));</b>
&nbsp;
<b class="nc">&nbsp;        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())</b>
&nbsp;                &amp;&amp; !hasLooped) {
<b class="nc">&nbsp;            return selected;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    public int getNextWeaponNum() {
<b class="nc">&nbsp;        int selected = getNextWeaponListIdx();</b>
<b class="nc">&nbsp;        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())) {</b>
<b class="nc">&nbsp;            return entity.getEquipmentNum(((WeaponListModel) weaponList</b>
<b class="nc">&nbsp;                    .getModel()).getWeaponAt(selected));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Selects the next valid weapon in the weapon list.
&nbsp;     *
&nbsp;     * @return The weaponId for the selected weapon
&nbsp;     */
&nbsp;    public int selectNextWeapon() {
<b class="nc">&nbsp;        int selected = getNextWeaponListIdx();</b>
<b class="nc">&nbsp;        weaponList.setSelectedIndex(selected);</b>
<b class="nc">&nbsp;        weaponList.ensureIndexIsVisible(selected);</b>
<b class="nc">&nbsp;        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())) {</b>
<b class="nc">&nbsp;            return entity.getEquipmentNum(((WeaponListModel) weaponList</b>
<b class="nc">&nbsp;                    .getModel()).getWeaponAt(selected));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Selects the prevous valid weapon in the weapon list.
&nbsp;     *
&nbsp;     * @return The weaponId for the selected weapon
&nbsp;     */
&nbsp;    public int selectPrevWeapon() {
<b class="nc">&nbsp;        int selected = getPrevWeaponListIdx();</b>
<b class="nc">&nbsp;        weaponList.setSelectedIndex(selected);</b>
<b class="nc">&nbsp;        weaponList.ensureIndexIsVisible(selected);</b>
<b class="nc">&nbsp;        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())) {</b>
<b class="nc">&nbsp;            return entity.getEquipmentNum(((WeaponListModel) weaponList</b>
<b class="nc">&nbsp;                    .getModel()).getWeaponAt(selected));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * displays the selected item from the list in the weapon display panel.
&nbsp;     */
&nbsp;    private void displaySelected() {
<b class="nc">&nbsp;        removeListeners();</b>
&nbsp;        // short circuit if not selected
<b class="nc">&nbsp;        if (weaponList.getSelectedIndex() == -1) {</b>
<b class="nc">&nbsp;            ((DefaultComboBoxModel&lt;String&gt;) m_chAmmo.getModel())</b>
<b class="nc">&nbsp;                    .removeAllElements();</b>
<b class="nc">&nbsp;            m_chAmmo.setEnabled(false);</b>
<b class="nc">&nbsp;            m_chBayWeapon.removeAllItems();</b>
<b class="nc">&nbsp;            m_chBayWeapon.setEnabled(false);</b>
<b class="nc">&nbsp;            wNameR.setText(&quot;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            wHeatR.setText(&quot;--&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            wArcHeatR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            wDamR.setText(&quot;--&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            wShortR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            wMedR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            wLongR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            wExtR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;            wDamageTrooperL.setVisible(false);</b>
<b class="nc">&nbsp;            wDamageTrooperR.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange0L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange0R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange1L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange1R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange2L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange2R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange3L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange3R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange4L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange4R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange5L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange5R.setVisible(false);</b>
&nbsp;
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Mounted mounted = ((WeaponListModel) weaponList.getModel())</b>
<b class="nc">&nbsp;                .getWeaponAt(weaponList.getSelectedIndex());</b>
<b class="nc">&nbsp;        WeaponType wtype = (WeaponType) mounted.getType();</b>
&nbsp;        // The rules are a bit sparse on airborne (dropping) ground units, but it seems they should
&nbsp;        // still attack like ground units.
<b class="nc">&nbsp;        boolean aerospaceAttack = entity.isAero() &amp;&amp; (entity.isAirborne() || entity.usesWeaponBays());</b>
&nbsp;        // update weapon display
<b class="nc">&nbsp;        wNameR.setText(mounted.getDesc());</b>
<b class="nc">&nbsp;        wHeatR.setText(Integer.toString(mounted.getCurrentHeat()));</b>
&nbsp;
<b class="nc">&nbsp;        wArcHeatR.setText(Integer.toString(entity.getHeatInArc(</b>
<b class="nc">&nbsp;                mounted.getLocation(), mounted.isRearMounted())));</b>
&nbsp;
<b class="nc">&nbsp;        if (wtype instanceof InfantryWeapon &amp;&amp; !wtype.hasFlag(WeaponType.F_TAG)) {</b>
<b class="nc">&nbsp;            wDamageTrooperL.setVisible(true);</b>
<b class="nc">&nbsp;            wDamageTrooperR.setVisible(true);</b>
<b class="nc">&nbsp;            InfantryWeapon inftype = (InfantryWeapon) wtype;</b>
<b class="nc">&nbsp;            if ((entity instanceof Infantry)</b>
&nbsp;                &amp;&amp; !(entity instanceof BattleArmor)) {
<b class="nc">&nbsp;                wDamageTrooperR</b>
<b class="nc">&nbsp;                        .setText(Double.toString((double) Math</b>
<b class="nc">&nbsp;                                .round(((Infantry) entity)</b>
<b class="nc">&nbsp;                                               .getDamagePerTrooper() * 1000) / 1000));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wDamageTrooperR.setText(Double.toString(inftype</b>
<b class="nc">&nbsp;                                                                .getInfantryDamage()));</b>
&nbsp;            }
&nbsp;            // what a nightmare to set up all the range info for infantry
&nbsp;            // weapons
<b class="nc">&nbsp;            wMinL.setVisible(false);</b>
<b class="nc">&nbsp;            wShortL.setVisible(false);</b>
<b class="nc">&nbsp;            wMedL.setVisible(false);</b>
<b class="nc">&nbsp;            wLongL.setVisible(false);</b>
<b class="nc">&nbsp;            wExtL.setVisible(false);</b>
<b class="nc">&nbsp;            wMinR.setVisible(false);</b>
<b class="nc">&nbsp;            wShortR.setVisible(false);</b>
<b class="nc">&nbsp;            wMedR.setVisible(false);</b>
<b class="nc">&nbsp;            wLongR.setVisible(false);</b>
<b class="nc">&nbsp;            wExtR.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange0L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange0R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange1L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange1R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange2L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange2R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange3L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange3R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange4L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange4R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange5L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange5R.setVisible(false);</b>
<b class="nc">&nbsp;            int zeromods = 0;</b>
<b class="nc">&nbsp;            if (inftype.hasFlag(WeaponType.F_INF_POINT_BLANK)) {</b>
<b class="nc">&nbsp;                zeromods++;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (inftype.hasFlag(WeaponType.F_INF_ENCUMBER)</b>
<b class="nc">&nbsp;                || (inftype.getCrew() &gt; 1)) {</b>
<b class="nc">&nbsp;                zeromods++;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (inftype.hasFlag(WeaponType.F_INF_BURST)) {</b>
<b class="nc">&nbsp;                zeromods--;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            int range = inftype.getInfantryRange();</b>
<b class="nc">&nbsp;            if (entity.getLocationStatus(mounted.getLocation()) == ILocationExposureStatus.WET) {</b>
<b class="nc">&nbsp;            	range /= 2;</b>
&nbsp;            }
<b class="nc">&nbsp;            switch (range) {</b>
&nbsp;                case 0:
<b class="nc">&nbsp;                    wInfantryRange0L.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange0R.setText(&quot;+&quot; + zeromods);</b>
<b class="nc">&nbsp;                    wInfantryRange0L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange0R.setVisible(true);</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 1:
<b class="nc">&nbsp;                    wInfantryRange0L.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange0R</b>
<b class="nc">&nbsp;                            .setText(Integer.toString(zeromods - 2));</b>
<b class="nc">&nbsp;                    wInfantryRange0L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange0R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setText(&quot;1&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setText(&quot;+0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setText(&quot;2&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setText(&quot;+2&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setText(&quot;3&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setText(&quot;+4&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setVisible(true);</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 2:
<b class="nc">&nbsp;                    wInfantryRange0L.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange0R</b>
<b class="nc">&nbsp;                            .setText(Integer.toString(zeromods - 2));</b>
<b class="nc">&nbsp;                    wInfantryRange0L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange0R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setText(&quot;1-2&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setText(&quot;+0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setText(&quot;3-4&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setText(&quot;+2&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setText(&quot;5-6&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setText(&quot;+4&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setVisible(true);</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 3:
<b class="nc">&nbsp;                    wInfantryRange0L.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange0R</b>
<b class="nc">&nbsp;                            .setText(Integer.toString(zeromods - 2));</b>
<b class="nc">&nbsp;                    wInfantryRange0L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange0R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setText(&quot;1-3&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setText(&quot;+0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setText(&quot;4-6&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setText(&quot;+2&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setText(&quot;7-9&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setText(&quot;+4&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setVisible(true);</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 4:
<b class="nc">&nbsp;                    wInfantryRange0L.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange0R</b>
<b class="nc">&nbsp;                            .setText(Integer.toString(zeromods - 2));</b>
<b class="nc">&nbsp;                    wInfantryRange0L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange0R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setText(&quot;1-4&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setText(&quot;+0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setText(&quot;5-6&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setText(&quot;+1&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setText(&quot;7-8&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setText(&quot;+2&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange4L.setText(&quot;9-10&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange4R.setText(&quot;+3&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange4L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange4R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange5L.setText(&quot;11-12&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange5R.setText(&quot;+4&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange5L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange5R.setVisible(true);</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 5:
<b class="nc">&nbsp;                    wInfantryRange0L.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange0R</b>
<b class="nc">&nbsp;                            .setText(Integer.toString(zeromods - 1));</b>
<b class="nc">&nbsp;                    wInfantryRange0L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange0R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setText(&quot;1-5&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setText(&quot;+0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setText(&quot;6-7&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setText(&quot;+1&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setText(&quot;8-10&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setText(&quot;+2&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange4L.setText(&quot;11-12&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange4R.setText(&quot;+3&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange4L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange4R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange5L.setText(&quot;13-15&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange5R.setText(&quot;+4&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange5L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange5R.setVisible(true);</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 6:
<b class="nc">&nbsp;                    wInfantryRange0L.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange0R</b>
<b class="nc">&nbsp;                            .setText(Integer.toString(zeromods - 1));</b>
<b class="nc">&nbsp;                    wInfantryRange0L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange0R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setText(&quot;1-6&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setText(&quot;+0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setText(&quot;7-9&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setText(&quot;+1&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setText(&quot;10-12&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setText(&quot;+2&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange4L.setText(&quot;13-15&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange4R.setText(&quot;+4&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange4L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange4R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange5L.setText(&quot;16-18&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange5R.setText(&quot;+5&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange5L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange5R.setVisible(true);</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 7:
<b class="nc">&nbsp;                    wInfantryRange0L.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange0R</b>
<b class="nc">&nbsp;                            .setText(Integer.toString(zeromods - 1));</b>
<b class="nc">&nbsp;                    wInfantryRange0L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange0R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setText(&quot;1-7&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setText(&quot;+0&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange1L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange1R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setText(&quot;8-10&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setText(&quot;+1&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange2L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange2R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setText(&quot;11-14&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setText(&quot;+2&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange3L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange3R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange4L.setText(&quot;15-17&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange4R.setText(&quot;+4&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange4L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange4R.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange5L.setText(&quot;18-21&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange5R.setText(&quot;+6&quot;);</b>
<b class="nc">&nbsp;                    wInfantryRange5L.setVisible(true);</b>
<b class="nc">&nbsp;                    wInfantryRange5R.setVisible(true);</b>
&nbsp;                    break;
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            wDamageTrooperL.setVisible(false);</b>
<b class="nc">&nbsp;            wDamageTrooperR.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange0L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange0R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange1L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange1R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange2L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange2R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange3L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange3R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange4L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange4R.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange5L.setVisible(false);</b>
<b class="nc">&nbsp;            wInfantryRange5R.setVisible(false);</b>
<b class="nc">&nbsp;            wShortL.setVisible(true);</b>
<b class="nc">&nbsp;            wMedL.setVisible(true);</b>
<b class="nc">&nbsp;            wLongL.setVisible(true);</b>
&nbsp;
<b class="nc">&nbsp;            wMinR.setVisible(true);</b>
<b class="nc">&nbsp;            wShortR.setVisible(true);</b>
<b class="nc">&nbsp;            wMedR.setVisible(true);</b>
<b class="nc">&nbsp;            wLongR.setVisible(true);</b>
&nbsp;
<b class="nc">&nbsp;            if (!aerospaceAttack) {</b>
<b class="nc">&nbsp;                wMinL.setVisible(true);</b>
<b class="nc">&nbsp;                wMinR.setVisible(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (((entity.getGame() != null)</b>
<b class="nc">&nbsp;                    &amp;&amp; entity.getGame().getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_RANGE))</b>
&nbsp;                    || aerospaceAttack) {
<b class="nc">&nbsp;                wExtL.setVisible(true);</b>
<b class="nc">&nbsp;                wExtR.setVisible(true);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (wtype.getDamage() == WeaponType.DAMAGE_BY_CLUSTERTABLE) {</b>
<b class="nc">&nbsp;            if (wtype instanceof HAGWeapon) {</b>
<b class="nc">&nbsp;                wDamR.setText(Messages.getString(&quot;MechDisplay.Variable&quot;)); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wDamR.setText(Messages.getString(&quot;MechDisplay.Missile&quot;)); //$NON-NLS-1$</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (wtype.getDamage() == WeaponType.DAMAGE_VARIABLE) {</b>
<b class="nc">&nbsp;            wDamR.setText(Messages.getString(&quot;MechDisplay.Variable&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        } else if (wtype.getDamage() == WeaponType.DAMAGE_SPECIAL) {</b>
<b class="nc">&nbsp;            wDamR.setText(Messages.getString(&quot;MechDisplay.Special&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        } else if (wtype.getDamage() == WeaponType.DAMAGE_ARTILLERY) {</b>
<b class="nc">&nbsp;            StringBuffer damage = new StringBuffer();</b>
<b class="nc">&nbsp;            int artyDamage = wtype.getRackSize();</b>
<b class="nc">&nbsp;            damage.append(Integer.toString(artyDamage));</b>
<b class="nc">&nbsp;            artyDamage -= 10;</b>
<b class="nc">&nbsp;            while (artyDamage &gt; 0) {</b>
<b class="nc">&nbsp;                damage.append(&#39;/&#39;).append(Integer.toString(artyDamage));</b>
<b class="nc">&nbsp;                artyDamage -= 10;</b>
&nbsp;            }
<b class="nc">&nbsp;            wDamR.setText(damage.toString());</b>
<b class="nc">&nbsp;        } else if (wtype.hasFlag(WeaponType.F_ENERGY)</b>
<b class="nc">&nbsp;                   &amp;&amp; wtype.hasModes()</b>
<b class="nc">&nbsp;                   &amp;&amp; (unitDisplay.getClientGUI() != null) &amp;&amp; unitDisplay.getClientGUI().getClient().getGame().getOptions().booleanOption(</b>
&nbsp;                OptionsConstants.ADVCOMBAT_TACOPS_ENERGY_WEAPONS)) {
<b class="nc">&nbsp;            if (mounted.hasChargedCapacitor() != 0) {</b>
<b class="nc">&nbsp;                if (mounted.hasChargedCapacitor() == 1) {</b>
<b class="nc">&nbsp;                    wDamR.setText(Integer.toString(Compute.dialDownDamage(</b>
&nbsp;                            mounted, wtype) + 5));
&nbsp;                }
<b class="nc">&nbsp;                if (mounted.hasChargedCapacitor() == 2) {</b>
<b class="nc">&nbsp;                    wDamR.setText(Integer.toString(Compute.dialDownDamage(</b>
&nbsp;                            mounted, wtype) + 10));
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                wDamR.setText(Integer.toString(Compute.dialDownDamage(</b>
&nbsp;                        mounted, wtype)));
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            wDamR.setText(Integer.toString(wtype.getDamage()));</b>
&nbsp;        }
&nbsp;
&nbsp;        // update range
<b class="nc">&nbsp;        int shortR = wtype.getShortRange();</b>
<b class="nc">&nbsp;        int mediumR = wtype.getMediumRange();</b>
<b class="nc">&nbsp;        int longR = wtype.getLongRange();</b>
<b class="nc">&nbsp;        int extremeR = wtype.getExtremeRange();</b>
<b class="nc">&nbsp;        if (mounted.isInBearingsOnlyMode()) {</b>
<b class="nc">&nbsp;            extremeR = RangeType.RANGE_BEARINGS_ONLY_OUT;</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((entity.getLocationStatus(mounted.getLocation()) == ILocationExposureStatus.WET)</b>
&nbsp;            || (longR == 0)) {
<b class="nc">&nbsp;            shortR = wtype.getWShortRange();</b>
<b class="nc">&nbsp;            mediumR = wtype.getWMediumRange();</b>
<b class="nc">&nbsp;            longR = wtype.getWLongRange();</b>
<b class="nc">&nbsp;            extremeR = wtype.getWExtremeRange();</b>
<b class="nc">&nbsp;        } else if (wtype.hasFlag(WeaponType.F_PDBAY)) {</b>
&nbsp;        //Point Defense bays have a variable range, depending on the mode they&#39;re in
<b class="nc">&nbsp;            if (wtype.hasModes() &amp;&amp; mounted.curMode().equals(&quot;Point Defense&quot;)) {</b>
<b class="nc">&nbsp;                shortR = 1;</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                shortR = 6;</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1-6&quot;); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
&nbsp;        // We need to adjust the ranges for Centurion Weapon Systems: it&#39;s
&nbsp;        //  default range is 6/12/18 but that&#39;s only for units that are
&nbsp;        //  susceptible to CWS, for those that aren&#39;t the ranges are 1/2/3
<b class="nc">&nbsp;        if (wtype.hasFlag(WeaponType.F_CWS)) {</b>
<b class="nc">&nbsp;            Entity target = null;</b>
<b class="nc">&nbsp;            if ((unitDisplay.getClientGUI() != null)</b>
<b class="nc">&nbsp;                &amp;&amp; (unitDisplay.getClientGUI().getCurrentPanel() instanceof FiringDisplay)) {</b>
<b class="nc">&nbsp;                Targetable t =</b>
<b class="nc">&nbsp;                        ((FiringDisplay) unitDisplay.getClientGUI().getCurrentPanel()).getTarget();</b>
<b class="nc">&nbsp;                if (t instanceof Entity) {</b>
<b class="nc">&nbsp;                    target = (Entity) t;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if ((target == null) || !target.hasQuirk(&quot;susceptible_cws&quot;)) {</b>
<b class="nc">&nbsp;                shortR = 1;</b>
<b class="nc">&nbsp;                mediumR = 2;</b>
<b class="nc">&nbsp;                longR = 3;</b>
<b class="nc">&nbsp;                extremeR = 4;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (wtype.getMinimumRange() &gt; 0) {</b>
<b class="nc">&nbsp;            wMinR.setText(Integer.toString(wtype.getMinimumRange()));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        if (shortR &gt; 1) {</b>
<b class="nc">&nbsp;            wShortR.setText(&quot;1 - &quot; + shortR); //$NON-NLS-1$</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wShortR.setText(&quot;&quot; + shortR); //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((mediumR - shortR) &gt; 1) {</b>
<b class="nc">&nbsp;            wMedR.setText(shortR + 1 + &quot; - &quot; + mediumR); //$NON-NLS-1$</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wMedR.setText(&quot;&quot; + mediumR); //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((longR - mediumR) &gt; 1) {</b>
<b class="nc">&nbsp;            wLongR.setText(mediumR + 1 + &quot; - &quot; + longR); //$NON-NLS-1$</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wLongR.setText(&quot;&quot; + longR); //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((extremeR - longR) &gt; 1) {</b>
<b class="nc">&nbsp;            wExtR.setText(longR + 1 + &quot; - &quot; + extremeR); //$NON-NLS-1$</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wExtR.setText(&quot;&quot; + extremeR); //$NON-NLS-1$</b>
&nbsp;        }
&nbsp;
&nbsp;        // Update the range display to account for the weapon&#39;s loaded ammo.
<b class="nc">&nbsp;        if (mounted.getLinked() != null) {</b>
<b class="nc">&nbsp;            updateRangeDisplayForAmmo(mounted.getLinked());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (aerospaceAttack) {</b>
&nbsp;            // change damage report to a statement of standard or capital
<b class="nc">&nbsp;            if (wtype.isCapital()) {</b>
<b class="nc">&nbsp;                wDamR.setText(Messages.getString(&quot;MechDisplay.CapitalD&quot;)); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wDamR.setText(Messages.getString(&quot;MechDisplay.StandardD&quot;)); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;
&nbsp;            // if this is a weapons bay, then I need to compile it to get
&nbsp;            // accurate results
<b class="nc">&nbsp;            if (wtype instanceof BayWeapon) {</b>
<b class="nc">&nbsp;                compileWeaponBay(mounted, wtype.isCapital());</b>
&nbsp;            } else {
&nbsp;                // otherwise I need to replace range display with standard
&nbsp;                // ranges and attack values
<b class="nc">&nbsp;                updateAttackValues(mounted, mounted.getLinked());</b>
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;
&nbsp;        // update weapon bay selector
<b class="nc">&nbsp;        int chosen = m_chBayWeapon.getSelectedIndex();</b>
<b class="nc">&nbsp;        m_chBayWeapon.removeAllItems();</b>
<b class="nc">&nbsp;        if (!(wtype instanceof BayWeapon) || !entity.usesWeaponBays()) {</b>
<b class="nc">&nbsp;            m_chBayWeapon.setEnabled(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            m_chBayWeapon.setEnabled(true);</b>
<b class="nc">&nbsp;            for (int wId : mounted.getBayWeapons()) {</b>
<b class="nc">&nbsp;                Mounted curWeapon = entity.getEquipment(wId);</b>
<b class="nc">&nbsp;                if (null == curWeapon) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                m_chBayWeapon.addItem(formatBayWeapon(curWeapon));</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            if (chosen == -1 || chosen &gt;= m_chBayWeapon.getItemCount()) {</b>
<b class="nc">&nbsp;                m_chBayWeapon.setSelectedIndex(0);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                m_chBayWeapon.setSelectedIndex(chosen);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // update ammo selector
<b class="nc">&nbsp;        ((DefaultComboBoxModel&lt;String&gt;) m_chAmmo.getModel()).removeAllElements();</b>
<b class="nc">&nbsp;        Mounted oldmount = mounted;</b>
<b class="nc">&nbsp;        if (wtype instanceof BayWeapon) {</b>
<b class="nc">&nbsp;            int n = m_chBayWeapon.getSelectedIndex();</b>
<b class="nc">&nbsp;            if (n == -1) {</b>
<b class="nc">&nbsp;                n = 0;</b>
&nbsp;            }
<b class="nc">&nbsp;            mounted = entity.getEquipment(mounted.getBayWeapons()</b>
<b class="nc">&nbsp;                                                 .elementAt(n));</b>
<b class="nc">&nbsp;            wtype = (WeaponType) mounted.getType();</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (wtype.getAmmoType() == AmmoType.T_NA) {</b>
<b class="nc">&nbsp;            m_chAmmo.setEnabled(false);</b>
<b class="nc">&nbsp;        } else if (wtype.hasFlag(WeaponType.F_DOUBLE_ONESHOT)</b>
<b class="nc">&nbsp;                || (entity.isSupportVehicle() &amp;&amp; (wtype.getAmmoType() == AmmoType.T_INFANTRY))) {</b>
<b class="nc">&nbsp;            int count = 0;</b>
<b class="nc">&nbsp;            vAmmo = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (Mounted current = mounted.getLinked(); current != null; current = current.getLinked()) {</b>
<b class="nc">&nbsp;                if (current.getUsableShotsLeft() &gt; 0) {</b>
<b class="nc">&nbsp;                    vAmmo.add(current);</b>
<b class="nc">&nbsp;                    m_chAmmo.addItem(formatAmmo(current));</b>
<b class="nc">&nbsp;                    count++;</b>
&nbsp;                }
&nbsp;            }
&nbsp;            // If there is no remaining ammo, show the last one linked and disable
<b class="nc">&nbsp;            if (count == 0) {</b>
<b class="nc">&nbsp;                m_chAmmo.addItem(formatAmmo(mounted.getLinked()));</b>
&nbsp;            }
<b class="nc">&nbsp;            m_chAmmo.setSelectedIndex(0);</b>
<b class="nc">&nbsp;            m_chAmmo.setEnabled(count &gt; 0);</b>
&nbsp;
&nbsp;        // this is the situation where there&#39;s some kind of ammo but it&#39;s not changeable
<b class="nc">&nbsp;        } else if (wtype.hasFlag(WeaponType.F_ONESHOT)) {</b>
<b class="nc">&nbsp;            m_chAmmo.setEnabled(false);</b>
<b class="nc">&nbsp;            Mounted mountedAmmo = mounted.getLinked();</b>
<b class="nc">&nbsp;            if (mountedAmmo != null) {</b>
<b class="nc">&nbsp;                m_chAmmo.addItem(formatAmmo(mountedAmmo));</b>
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            m_chAmmo.setEnabled(true);</b>
<b class="nc">&nbsp;            vAmmo = new ArrayList&lt;Mounted&gt;();</b>
<b class="nc">&nbsp;            int nCur = -1;</b>
<b class="nc">&nbsp;            int i = 0;</b>
&nbsp;            //Ammo sharing between adjacent trailers
<b class="nc">&nbsp;            List&lt;Mounted&gt; fullAmmoList = new ArrayList&lt;Mounted&gt;(entity.getAmmo());</b>
<b class="nc">&nbsp;            if (entity.getTowedBy() != Entity.NONE) {</b>
<b class="nc">&nbsp;                Entity ahead = entity.getGame().getEntity(entity.getTowedBy());</b>
<b class="nc">&nbsp;                fullAmmoList.addAll(ahead.getAmmo());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (entity.getTowing() != Entity.NONE) {</b>
<b class="nc">&nbsp;                Entity behind = entity.getGame().getEntity(entity.getTowing());</b>
<b class="nc">&nbsp;                fullAmmoList.addAll(behind.getAmmo());</b>
&nbsp;            }
<b class="nc">&nbsp;            for (Mounted mountedAmmo : fullAmmoList) {</b>
<b class="nc">&nbsp;                AmmoType atype = (AmmoType) mountedAmmo.getType();</b>
&nbsp;                // for all aero units other than fighters,
&nbsp;                // ammo must be located in the same place to be usable
<b class="nc">&nbsp;                boolean same = true;</b>
<b class="nc">&nbsp;                if ((entity instanceof SmallCraft)</b>
&nbsp;                    || (entity instanceof Jumpship)) {
<b class="nc">&nbsp;                    same = (mounted.getLocation() == mountedAmmo</b>
<b class="nc">&nbsp;                            .getLocation());</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                boolean rightBay = true;</b>
<b class="nc">&nbsp;                if (entity.usesWeaponBays() &amp;&amp; !(entity instanceof FighterSquadron)) {</b>
<b class="nc">&nbsp;                    rightBay = oldmount.ammoInBay(entity.getEquipmentNum(mountedAmmo));</b>
&nbsp;                }
&nbsp;                
&nbsp;                // covers the situation where a weapon using non-caseless ammo should 
&nbsp;                // not be able to switch to caseless on the fly and vice versa
<b class="nc">&nbsp;                boolean canSwitchToAmmo = AmmoType.canSwitchToAmmo(mounted, atype);</b>
&nbsp;
<b class="nc">&nbsp;                if (mountedAmmo.isAmmoUsable() &amp;&amp; same &amp;&amp; rightBay &amp;&amp; canSwitchToAmmo</b>
<b class="nc">&nbsp;                    &amp;&amp; (atype.getAmmoType() == wtype.getAmmoType())</b>
<b class="nc">&nbsp;                    &amp;&amp; (atype.getRackSize() == wtype.getRackSize())) {</b>
&nbsp;
<b class="nc">&nbsp;                    vAmmo.add(mountedAmmo);</b>
<b class="nc">&nbsp;                    m_chAmmo.addItem(formatAmmo(mountedAmmo));</b>
<b class="nc">&nbsp;                    if ((mounted.getLinked() != null) &amp;&amp;</b>
<b class="nc">&nbsp;                        mounted.getLinked().equals(mountedAmmo)) {</b>
<b class="nc">&nbsp;                        nCur = i;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    i++;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (nCur != -1) {</b>
<b class="nc">&nbsp;                m_chAmmo.setSelectedIndex(nCur);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // send event to other parts of the UI which care
<b class="nc">&nbsp;        if (oldmount.isInWaypointLaunchMode()) {</b>
<b class="nc">&nbsp;            setFieldofFire(oldmount);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setFieldofFire(mounted);</b>
&nbsp;        }
<b class="nc">&nbsp;        unitDisplay.processMechDisplayEvent(new MechDisplayEvent(this, entity, mounted));</b>
<b class="nc">&nbsp;        onResize();</b>
<b class="nc">&nbsp;        addListeners();</b>
&nbsp;    }
&nbsp;    
&nbsp;    // this gathers all the range data 
&nbsp;    // it is a boiled down version of displaySelected,
&nbsp;    // updateAttackValues, updateRangeDisplayforAmmo
&nbsp;    private void setFieldofFire(Mounted mounted) {
&nbsp;        // No field of fire without ClientGUI
<b class="nc">&nbsp;        if (unitDisplay.getClientGUI() == null) </b>
&nbsp;            return;
&nbsp;        
<b class="nc">&nbsp;        ClientGUI gui = unitDisplay.getClientGUI();</b>
&nbsp;
<b class="nc">&nbsp;        WeaponType wtype = (WeaponType) mounted.getType();</b>
<b class="nc">&nbsp;        int[][] ranges = new int[2][5];</b>
<b class="nc">&nbsp;        ranges[0] = wtype.getRanges(mounted);</b>
&nbsp;
<b class="nc">&nbsp;        AmmoType atype = null;</b>
<b class="nc">&nbsp;        if (mounted.getLinked() != null) </b>
<b class="nc">&nbsp;            atype = (AmmoType) mounted.getLinked().getType();</b>
&nbsp;
&nbsp;        // gather underwater ranges
<b class="nc">&nbsp;        ranges[1] = wtype.getWRanges();</b>
<b class="nc">&nbsp;        if (atype != null) {</b>
<b class="nc">&nbsp;            if ((wtype.getAmmoType() == AmmoType.T_SRM)</b>
<b class="nc">&nbsp;                    || (wtype.getAmmoType() == AmmoType.T_SRM_IMP)</b>
<b class="nc">&nbsp;                    || (wtype.getAmmoType() == AmmoType.T_MRM)</b>
<b class="nc">&nbsp;                    || (wtype.getAmmoType() == AmmoType.T_LRM)</b>
<b class="nc">&nbsp;                    || (wtype.getAmmoType() == AmmoType.T_LRM_IMP)</b>
<b class="nc">&nbsp;                    || (wtype.getAmmoType() == AmmoType.T_MML)) {</b>
<b class="nc">&nbsp;                if (atype.getMunitionType() == AmmoType.M_TORPEDO) {</b>
<b class="nc">&nbsp;                    ranges[1] = wtype.getRanges(mounted);</b>
<b class="nc">&nbsp;                } else if (atype.getMunitionType() == AmmoType.M_MULTI_PURPOSE) {</b>
<b class="nc">&nbsp;                    ranges[1] = wtype.getRanges(mounted);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Infantry range types 4+ are simplified to 
&nbsp;        // the usual range types as displaying 5 range circles
&nbsp;        // would be visual overkill (and besides this makes
&nbsp;        // things easier)
<b class="nc">&nbsp;        if (wtype instanceof InfantryWeapon) {</b>
<b class="nc">&nbsp;            InfantryWeapon inftype = (InfantryWeapon) wtype;</b>
<b class="nc">&nbsp;            int iR = inftype.getInfantryRange();</b>
<b class="nc">&nbsp;            ranges[0] = </b>
&nbsp;                    new int[] { 0, iR, iR * 2, iR * 3, 0 };
<b class="nc">&nbsp;            ranges[1] =</b>
&nbsp;            		new int[] { 0, iR / 2, (iR / 2) * 2, (iR / 2) * 3, 0 }; 
&nbsp;        }
&nbsp;
&nbsp;        // Artillery gets fixed ranges, 100 as an arbitrary
&nbsp;        // large range for the targeting phase and
&nbsp;        // 6 to 17 in the other phases as it will be
&nbsp;        // direct fire then
<b class="nc">&nbsp;        if (wtype.hasFlag(WeaponType.F_ARTILLERY)) {</b>
<b class="nc">&nbsp;            if (gui.getCurrentPanel() instanceof TargetingPhaseDisplay) {</b>
<b class="nc">&nbsp;                ranges[0] = new int[] { 0, 0, 0, 100, 0 };  </b>
<b class="nc">&nbsp;                ranges[1] = new int[] { 0, 0, 0, 0, 0 };</b>
&nbsp;            } else {
<b class="nc">&nbsp;                ranges[0] = new int[] { 6, 0, 0, 17, 0 };  </b>
<b class="nc">&nbsp;                ranges[1] = new int[] { 0, 0, 0, 0, 0 };</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Override for the various ATM and MML ammos
<b class="nc">&nbsp;        if (atype != null) {</b>
<b class="nc">&nbsp;            if (atype.getAmmoType() == AmmoType.T_ATM) {</b>
<b class="nc">&nbsp;                if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) </b>
<b class="nc">&nbsp;                    ranges[0] = new int[] { 4, 9, 18, 27, 36 }; </b>
<b class="nc">&nbsp;                else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) </b>
<b class="nc">&nbsp;                    ranges[0] = new int[] { 0, 3, 6, 9, 12 };</b>
&nbsp;                else 
<b class="nc">&nbsp;                    ranges[0] = new int[] { 4, 5, 10, 15, 20 };</b>
&nbsp;            } 
<b class="nc">&nbsp;            else if (atype.getAmmoType() == AmmoType.T_MML) {</b>
<b class="nc">&nbsp;                if (atype.hasFlag(AmmoType.F_MML_LRM)) </b>
<b class="nc">&nbsp;                    ranges[0] = new int[] { 6, 7, 14, 21, 28 };</b>
&nbsp;                else 
<b class="nc">&nbsp;                    ranges[0] = new int[] { 0, 3, 6, 9, 12 };</b>
<b class="nc">&nbsp;            } else if (atype.getAmmoType() == AmmoType.T_IATM) {</b>
<b class="nc">&nbsp;                if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) </b>
<b class="nc">&nbsp;                    ranges[0] = new int[] { 4, 9, 18, 27, 36 };</b>
<b class="nc">&nbsp;                else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) </b>
<b class="nc">&nbsp;                    ranges[0] = new int[] { 0, 3, 6, 9, 12 };</b>
<b class="nc">&nbsp;                else if (atype.getMunitionType() == AmmoType.M_IATM_IMP) </b>
<b class="nc">&nbsp;                    ranges[0] = new int[] { 0, 3, 6, 9, 12 };</b>
&nbsp;                else  
<b class="nc">&nbsp;                    ranges[0] = new int[] { 4, 5, 10, 15, 20 };</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // No minimum range for hotload
<b class="nc">&nbsp;        if ((mounted.getLinked() != null) &amp;&amp; mounted.getLinked().isHotLoaded()) {</b>
<b class="nc">&nbsp;            ranges[0][0] = 0;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Aero
<b class="nc">&nbsp;        if (entity.isAirborne()) {</b>
&nbsp;
&nbsp;            // prepare fresh ranges, no underwater
<b class="nc">&nbsp;            ranges[0] = new int[] { 0, 0, 0, 0, 0 };  </b>
<b class="nc">&nbsp;            ranges[1] = new int[] { 0, 0, 0, 0, 0 };</b>
<b class="nc">&nbsp;            int maxr = WeaponType.RANGE_SHORT;</b>
&nbsp;            
&nbsp;            // In the WeaponPanel, when the weapon is out of ammo
&nbsp;            // or otherwise nonfunctional, SHORT range will be listed;
&nbsp;            // the field of fire is instead disabled
&nbsp;            // Here as well as in WeaponPanel, choosing a specific ammo
&nbsp;            // only works for the current player&#39;s units
<b class="nc">&nbsp;            if (!mounted.isBreached() &amp;&amp; !mounted.isMissing() </b>
<b class="nc">&nbsp;                    &amp;&amp; !mounted.isDestroyed() &amp;&amp; !mounted.isJammed() </b>
<b class="nc">&nbsp;                    &amp;&amp; ((mounted.getLinked() == null) </b>
<b class="nc">&nbsp;                            || (mounted.getLinked().getUsableShotsLeft() &gt; 0))) {</b>
<b class="nc">&nbsp;                maxr = wtype.getMaxRange(mounted);</b>
&nbsp;
<b class="nc">&nbsp;                if (atype != null) {</b>
<b class="nc">&nbsp;                    if (atype.getAmmoType() == AmmoType.T_ATM) {</b>
<b class="nc">&nbsp;                        if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) {</b>
<b class="nc">&nbsp;                            maxr = WeaponType.RANGE_EXT;</b>
<b class="nc">&nbsp;                        } else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) {</b>
<b class="nc">&nbsp;                            maxr = WeaponType.RANGE_SHORT;</b>
&nbsp;                        }
<b class="nc">&nbsp;                    } else if (atype.getAmmoType() == AmmoType.T_MML) {</b>
<b class="nc">&nbsp;                        if (!atype.hasFlag(AmmoType.F_MML_LRM)) {</b>
<b class="nc">&nbsp;                            maxr = WeaponType.RANGE_SHORT; </b>
&nbsp;                        }
&nbsp;                    } 
&nbsp;                }
&nbsp;
&nbsp;                // set the standard ranges, depending on capital or no
&nbsp;                //boolean isCap = wtype.isCapital();
<b class="nc">&nbsp;                int rangeMultiplier = wtype.isCapital() ? 2 : 1;</b>
<b class="nc">&nbsp;                final IGame game = unitDisplay.getClientGUI().getClient().getGame();</b>
<b class="nc">&nbsp;                if (game.getBoard().onGround()) {</b>
<b class="nc">&nbsp;                    rangeMultiplier *= 8;</b>
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                for(int rangeIndex = RangeType.RANGE_MINIMUM; rangeIndex &lt;= RangeType.RANGE_EXTREME; rangeIndex++) {</b>
<b class="nc">&nbsp;                    if(maxr &gt;= rangeIndex) {</b>
<b class="nc">&nbsp;                        ranges[0][rangeIndex] = WeaponType.AIRBORNE_WEAPON_RANGES[rangeIndex] * rangeMultiplier;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        
&nbsp;        // pass all this to the Displays
<b class="nc">&nbsp;        int arc = entity.getWeaponArc(entity.getEquipmentNum(mounted));</b>
<b class="nc">&nbsp;        int loc = mounted.getLocation();</b>
&nbsp;        
<b class="nc">&nbsp;        if (gui.getCurrentPanel() instanceof FiringDisplay) {</b>
&nbsp;            // twisting
<b class="nc">&nbsp;            int facing = entity.getFacing();</b>
<b class="nc">&nbsp;            if (entity.isSecondaryArcWeapon(entity.getEquipmentNum(mounted))) </b>
<b class="nc">&nbsp;                facing = entity.getSecondaryFacing();</b>
<b class="nc">&nbsp;            ((FiringDisplay) gui.getCurrentPanel()).FieldofFire(entity, ranges, arc, loc, facing);</b>
<b class="nc">&nbsp;        } else if (gui.getCurrentPanel() instanceof TargetingPhaseDisplay) {</b>
&nbsp;            // twisting
<b class="nc">&nbsp;            int facing = entity.getFacing();</b>
<b class="nc">&nbsp;            if (entity.isSecondaryArcWeapon(entity.getEquipmentNum(mounted))) </b>
<b class="nc">&nbsp;                facing = entity.getSecondaryFacing();</b>
<b class="nc">&nbsp;            ((TargetingPhaseDisplay) gui.getCurrentPanel()).FieldofFire(entity, ranges, arc, loc, facing);</b>
<b class="nc">&nbsp;        } else if (gui.getCurrentPanel() instanceof MovementDisplay) {</b>
&nbsp;            // no twisting here
<b class="nc">&nbsp;            ((MovementDisplay)gui.getCurrentPanel()).FieldofFire(entity, ranges, arc, loc);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String formatAmmo(Mounted m) {
<b class="nc">&nbsp;        StringBuffer sb = new StringBuffer(64);</b>
<b class="nc">&nbsp;        int ammoIndex = m.getDesc().indexOf(</b>
<b class="nc">&nbsp;                Messages.getString(&quot;MechDisplay.0&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        int loc = m.getLocation();</b>
<b class="nc">&nbsp;        if (!m.getEntity().equals(entity)) {</b>
<b class="nc">&nbsp;            sb.append(&quot;[TR] &quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        } else if (loc != Entity.LOC_NONE) {</b>
<b class="nc">&nbsp;            sb.append(&#39;[&#39;).append(entity.getLocationAbbr(loc)).append(&quot;] &quot;); //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        if (ammoIndex == -1) {</b>
<b class="nc">&nbsp;            sb.append(m.getDesc());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            sb.append(m.getDesc().substring(0, ammoIndex));</b>
<b class="nc">&nbsp;            sb.append(m.getDesc().substring(ammoIndex + 4));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (m.isHotLoaded()) {</b>
<b class="nc">&nbsp;            sb.append(Messages.getString(&quot;MechDisplay.isHotLoaded&quot;));</b>
&nbsp;        }
<b class="nc">&nbsp;        return sb.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    private String formatBayWeapon(Mounted m) {
<b class="nc">&nbsp;        StringBuffer sb = new StringBuffer(64);</b>
<b class="nc">&nbsp;        sb.append(m.getDesc());</b>
<b class="nc">&nbsp;        return sb.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Update the range display for the selected ammo.
&nbsp;     *
&nbsp;     * @param mAmmo - the &lt;code&gt;AmmoType&lt;/code&gt; of the weapon&#39;s loaded ammo.
&nbsp;     */
&nbsp;    private void updateRangeDisplayForAmmo(Mounted mAmmo) {
<b class="nc">&nbsp;        if (!(mAmmo.getType() instanceof AmmoType)) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        AmmoType atype = (AmmoType) mAmmo.getType();</b>
&nbsp;        // Only override the display for the various ATM and MML ammos
<b class="nc">&nbsp;        if (atype.getAmmoType() == AmmoType.T_ATM) {</b>
<b class="nc">&nbsp;            if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) {</b>
<b class="nc">&nbsp;                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 9&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;10 - 18&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;19 - 27&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;28 - 36&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) {</b>
<b class="nc">&nbsp;                wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 3&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;4 - 6&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;7 - 9&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;10 - 12&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 5&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;6 - 10&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;11 - 15&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;16 - 20&quot;); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        } // End weapon-is-ATM
<b class="nc">&nbsp;        else if (atype.getAmmoType() == AmmoType.T_MML) {</b>
<b class="nc">&nbsp;            if (atype.hasFlag(AmmoType.F_MML_LRM)) {</b>
<b class="nc">&nbsp;                wMinR.setText(&quot;6&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 7&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;8 - 14&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;15 - 21&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;21 - 28&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 3&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;4 - 6&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;7 - 9&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;10 - 12&quot;); //$NON-NLS-1$</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (atype.getAmmoType() == AmmoType.T_IATM) {</b>
<b class="nc">&nbsp;            if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) {</b>
<b class="nc">&nbsp;                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 9&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;10 - 18&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;19 - 27&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;28 - 36&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) {</b>
<b class="nc">&nbsp;                wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 3&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;4 - 6&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;7 - 9&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;10 - 12&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (atype.getMunitionType() == AmmoType.M_IATM_IIW) {</b>
<b class="nc">&nbsp;                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 5&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;6 - 10&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;11 - 15&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;16 - 20&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (atype.getMunitionType() == AmmoType.M_IATM_IMP) {</b>
<b class="nc">&nbsp;                wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 3&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;4 - 6&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;7 - 9&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;10 - 12&quot;); //$NON-NLS-1$</b>
&nbsp;            } else /* standard */ {
<b class="nc">&nbsp;                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wShortR.setText(&quot;1 - 5&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;6 - 10&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;11 - 15&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;16 - 20&quot;); //$NON-NLS-1$</b>
&nbsp;            }           
&nbsp;        }
&nbsp;
&nbsp;        // Min range 0 for hotload
<b class="nc">&nbsp;        if (mAmmo.isHotLoaded()) {</b>
<b class="nc">&nbsp;            wMinR.setText(&quot;---&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        onResize();</b>
&nbsp;    } // End private void updateRangeDisplayForAmmo( AmmoType )
&nbsp;
&nbsp;    private void updateAttackValues(Mounted weapon, Mounted ammo) {
<b class="nc">&nbsp;        WeaponType wtype = (WeaponType) weapon.getType();</b>
&nbsp;        // update Attack Values and change range
<b class="nc">&nbsp;        int avShort = wtype.getRoundShortAV();</b>
<b class="nc">&nbsp;        int avMed = wtype.getRoundMedAV();</b>
<b class="nc">&nbsp;        int avLong = wtype.getRoundLongAV();</b>
<b class="nc">&nbsp;        int avExt = wtype.getRoundExtAV();</b>
<b class="nc">&nbsp;        int maxr = wtype.getMaxRange(weapon);</b>
&nbsp;
&nbsp;        // change range and attack values based upon ammo
<b class="nc">&nbsp;        if (null != ammo) {</b>
<b class="nc">&nbsp;            AmmoType atype = (AmmoType) ammo.getType();</b>
<b class="nc">&nbsp;            double[] changes = changeAttackValues(atype, avShort, avMed,</b>
&nbsp;                                                  avLong, avExt, maxr);
<b class="nc">&nbsp;            avShort = (int) changes[0];</b>
<b class="nc">&nbsp;            avMed = (int) changes[1];</b>
<b class="nc">&nbsp;            avLong = (int) changes[2];</b>
<b class="nc">&nbsp;            avExt = (int) changes[3];</b>
<b class="nc">&nbsp;            maxr = (int) changes[4];</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (entity.getGame().getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY) &amp;&amp; wtype.isCapital()) {</b>
<b class="nc">&nbsp;            avShort *= 10;</b>
<b class="nc">&nbsp;            avMed *= 10;</b>
<b class="nc">&nbsp;            avLong *= 10;</b>
<b class="nc">&nbsp;            avExt *= 10;</b>
&nbsp;        }
&nbsp;
&nbsp;        // set default values in case if statement stops
<b class="nc">&nbsp;        wShortAVR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wMedAVR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wLongAVR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wExtAVR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wShortR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wMedR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wLongR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wExtR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
&nbsp;        // every weapon gets at least short range
<b class="nc">&nbsp;        wShortAVR.setText(Integer.toString(avShort));</b>
<b class="nc">&nbsp;        if (wtype.isCapital()) {</b>
<b class="nc">&nbsp;            wShortR.setText(&quot;1-12&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        } else if (wtype.hasFlag(WeaponType.F_PDBAY)) {</b>
&nbsp;                //Point Defense bays have a variable range too, depending on the mode they&#39;re in
<b class="nc">&nbsp;                if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(&quot;Point Defense&quot;)) {</b>
<b class="nc">&nbsp;                    wShortR.setText(&quot;1&quot;); //$NON-NLS-1$</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    wShortR.setText(&quot;1-6&quot;); //$NON-NLS-1$</b>
&nbsp;                }
&nbsp;        } else {
<b class="nc">&nbsp;            wShortR.setText(&quot;1-6&quot;); //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        if (maxr &gt; WeaponType.RANGE_SHORT) {</b>
<b class="nc">&nbsp;            wMedAVR.setText(Integer.toString(avMed));</b>
<b class="nc">&nbsp;            if (wtype.isCapital()) {</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;13-24&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wMedR.setText(&quot;7-12&quot;); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (maxr &gt; WeaponType.RANGE_MED) {</b>
<b class="nc">&nbsp;            wLongAVR.setText(Integer.toString(avLong));</b>
<b class="nc">&nbsp;            if (wtype.isCapital()) {</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;25-40&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wLongR.setText(&quot;13-20&quot;); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (maxr &gt; WeaponType.RANGE_LONG) {</b>
<b class="nc">&nbsp;            wExtAVR.setText(Integer.toString(avExt));</b>
<b class="nc">&nbsp;            if (wtype.isCapital()) {</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;41-50&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wExtR.setText(&quot;21-25&quot;); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        onResize();</b>
&nbsp;    }
&nbsp;
&nbsp;    private double[] changeAttackValues(AmmoType atype, double avShort,
&nbsp;                                        double avMed, double avLong, double avExt, int maxr) {
&nbsp;
<b class="nc">&nbsp;        if (AmmoType.T_ATM == atype.getAmmoType()) {</b>
<b class="nc">&nbsp;            if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) {</b>
<b class="nc">&nbsp;                maxr = WeaponType.RANGE_EXT;</b>
<b class="nc">&nbsp;                avShort = avShort / 2;</b>
<b class="nc">&nbsp;                avMed = avMed / 2;</b>
<b class="nc">&nbsp;                avLong = avMed;</b>
<b class="nc">&nbsp;                avExt = avMed;</b>
<b class="nc">&nbsp;            } else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) {</b>
<b class="nc">&nbsp;                maxr = WeaponType.RANGE_SHORT;</b>
<b class="nc">&nbsp;                avShort = avShort + (avShort / 2);</b>
<b class="nc">&nbsp;                avMed = 0;</b>
<b class="nc">&nbsp;                avLong = 0;</b>
<b class="nc">&nbsp;                avExt = 0;</b>
&nbsp;            }
&nbsp;        } // End weapon-is-ATM
<b class="nc">&nbsp;        else if (atype.getAmmoType() == AmmoType.T_MML) {</b>
&nbsp;            // first check for artemis
<b class="nc">&nbsp;            int bonus = 0;</b>
<b class="nc">&nbsp;            if (atype.getMunitionType() == AmmoType.M_ARTEMIS_CAPABLE) {</b>
<b class="nc">&nbsp;                int rack = atype.getRackSize();</b>
<b class="nc">&nbsp;                if (rack == 5) {</b>
<b class="nc">&nbsp;                    bonus += 1;</b>
<b class="nc">&nbsp;                } else if (rack &gt;= 7) {</b>
<b class="nc">&nbsp;                    bonus += 2;</b>
&nbsp;                }
<b class="nc">&nbsp;                avShort = avShort + bonus;</b>
<b class="nc">&nbsp;                avMed = avMed + bonus;</b>
<b class="nc">&nbsp;                avLong = avLong + bonus;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!atype.hasFlag(AmmoType.F_MML_LRM)) {</b>
<b class="nc">&nbsp;                maxr = WeaponType.RANGE_SHORT;</b>
<b class="nc">&nbsp;                avShort = avShort * 2;</b>
<b class="nc">&nbsp;                avMed = 0;</b>
<b class="nc">&nbsp;                avLong = 0;</b>
<b class="nc">&nbsp;                avExt = 0;</b>
&nbsp;            }
<b class="nc">&nbsp;        } // end weapon is MML</b>
<b class="nc">&nbsp;        else if ((atype.getAmmoType() == AmmoType.T_LRM) </b>
<b class="nc">&nbsp;                || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</b>
<b class="nc">&nbsp;                || (atype.getAmmoType() == AmmoType.T_SRM)</b>
<b class="nc">&nbsp;                || (atype.getAmmoType() == AmmoType.T_SRM_IMP)) {</b>
&nbsp;
<b class="nc">&nbsp;            if (atype.getMunitionType() == AmmoType.M_ARTEMIS_CAPABLE) {</b>
<b class="nc">&nbsp;                if ((atype.getAmmoType() == AmmoType.T_LRM) || (atype.getAmmoType() == AmmoType.T_LRM_IMP)) {</b>
<b class="nc">&nbsp;                    int bonus = (int) Math.ceil(atype.getRackSize() / 5.0);</b>
<b class="nc">&nbsp;                    avShort = avShort + bonus;</b>
<b class="nc">&nbsp;                    avMed = avMed + bonus;</b>
<b class="nc">&nbsp;                    avLong = avLong + bonus;</b>
&nbsp;                }
<b class="nc">&nbsp;                if ((atype.getAmmoType() == AmmoType.T_SRM) || (atype.getAmmoType() == AmmoType.T_SRM_IMP)) {</b>
<b class="nc">&nbsp;                    avShort = avShort + 2;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else if (atype.getAmmoType() == AmmoType.T_AC_LBX) {</b>
<b class="nc">&nbsp;            if (atype.getMunitionType() == AmmoType.M_CLUSTER) {</b>
<b class="nc">&nbsp;                int newAV = (int) Math.floor(0.6 * atype.getRackSize());</b>
<b class="nc">&nbsp;                avShort = newAV;</b>
<b class="nc">&nbsp;                if (avMed &gt; 0) {</b>
<b class="nc">&nbsp;                    avMed = newAV;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (avLong &gt; 0) {</b>
<b class="nc">&nbsp;                    avLong = newAV;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (avExt &gt; 0) {</b>
<b class="nc">&nbsp;                    avExt = newAV;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        } else if (atype.getAmmoType() == AmmoType.T_AR10) {</b>
<b class="nc">&nbsp;            if (atype.hasFlag(AmmoType.F_AR10_KILLER_WHALE)) {</b>
<b class="nc">&nbsp;                avShort = 4;</b>
<b class="nc">&nbsp;                avMed = 4;</b>
<b class="nc">&nbsp;                avLong = 4;</b>
<b class="nc">&nbsp;                avExt = 4;</b>
<b class="nc">&nbsp;            } else if (atype.hasFlag(AmmoType.F_AR10_WHITE_SHARK)) {</b>
<b class="nc">&nbsp;                avShort = 3;</b>
<b class="nc">&nbsp;                avMed = 3;</b>
<b class="nc">&nbsp;                avLong = 3;</b>
<b class="nc">&nbsp;                avExt = 3;</b>
<b class="nc">&nbsp;            } else if (atype.hasFlag(AmmoType.F_SANTA_ANNA)) {</b>
<b class="nc">&nbsp;                avShort = 100;</b>
<b class="nc">&nbsp;                avMed = 100;</b>
<b class="nc">&nbsp;                avLong = 100;</b>
<b class="nc">&nbsp;                avExt = 100;</b>
<b class="nc">&nbsp;            } else if (atype.hasFlag(AmmoType.F_PEACEMAKER)) {</b>
<b class="nc">&nbsp;                avShort = 1000;</b>
<b class="nc">&nbsp;                avMed = 1000;</b>
<b class="nc">&nbsp;                avLong = 1000;</b>
<b class="nc">&nbsp;                avExt = 1000;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                avShort = 2;</b>
<b class="nc">&nbsp;                avMed = 2;</b>
<b class="nc">&nbsp;                avLong = 2;</b>
<b class="nc">&nbsp;                avExt = 2;</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (atype.getAmmoType() == AmmoType.T_KILLER_WHALE) {</b>
<b class="nc">&nbsp;            if (atype.hasFlag(AmmoType.F_PEACEMAKER)) {</b>
<b class="nc">&nbsp;                avShort = 1000;</b>
<b class="nc">&nbsp;                avMed = 1000;</b>
<b class="nc">&nbsp;                avLong = 1000;</b>
<b class="nc">&nbsp;                avExt = 1000; </b>
&nbsp;            } else {
<b class="nc">&nbsp;                avShort = 4;</b>
<b class="nc">&nbsp;                avMed = 4;</b>
<b class="nc">&nbsp;                avLong = 4;</b>
<b class="nc">&nbsp;                avExt = 4;</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (atype.getAmmoType() == AmmoType.T_WHITE_SHARK) {</b>
<b class="nc">&nbsp;            if (atype.hasFlag(AmmoType.F_SANTA_ANNA)) {</b>
<b class="nc">&nbsp;                avShort = 100;</b>
<b class="nc">&nbsp;                avMed = 100;</b>
<b class="nc">&nbsp;                avLong = 100;</b>
<b class="nc">&nbsp;                avExt = 100; </b>
&nbsp;            } else {
<b class="nc">&nbsp;                avShort = 3;</b>
<b class="nc">&nbsp;                avMed = 3;</b>
<b class="nc">&nbsp;                avLong = 3;</b>
<b class="nc">&nbsp;                avExt = 3;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        double[] result = {avShort, avMed, avLong, avExt, maxr};</b>
<b class="nc">&nbsp;        return result;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private void compileWeaponBay(Mounted weapon, boolean isCapital) {
&nbsp;
<b class="nc">&nbsp;        Vector&lt;Integer&gt; bayWeapons = weapon.getBayWeapons();</b>
<b class="nc">&nbsp;        WeaponType wtype = (WeaponType) weapon.getType();</b>
&nbsp;
&nbsp;        // set default values in case if statement stops
<b class="nc">&nbsp;        wShortAVR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wMedAVR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wLongAVR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wExtAVR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wShortR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wMedR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wLongR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        wExtR.setText(&quot;---&quot;); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;        int heat = 0;</b>
<b class="nc">&nbsp;        double avShort = 0;</b>
<b class="nc">&nbsp;        double avMed = 0;</b>
<b class="nc">&nbsp;        double avLong = 0;</b>
<b class="nc">&nbsp;        double avExt = 0;</b>
<b class="nc">&nbsp;        int maxr = WeaponType.RANGE_SHORT;</b>
&nbsp;
<b class="nc">&nbsp;        for (int wId : bayWeapons) {</b>
<b class="nc">&nbsp;            Mounted m = entity.getEquipment(wId);</b>
<b class="nc">&nbsp;            if (!m.isBreached()</b>
<b class="nc">&nbsp;                &amp;&amp; !m.isMissing()</b>
<b class="nc">&nbsp;                &amp;&amp; !m.isDestroyed()</b>
<b class="nc">&nbsp;                &amp;&amp; !m.isJammed()</b>
<b class="nc">&nbsp;                &amp;&amp; ((m.getLinked() == null) || (m.getLinked()</b>
<b class="nc">&nbsp;                                                 .getUsableShotsLeft() &gt; 0))) {</b>
<b class="nc">&nbsp;                WeaponType bayWType = ((WeaponType) m.getType());</b>
<b class="nc">&nbsp;                heat = heat + m.getCurrentHeat();</b>
<b class="nc">&nbsp;                double mAVShort = bayWType.getShortAV();</b>
<b class="nc">&nbsp;                double mAVMed = bayWType.getMedAV();</b>
<b class="nc">&nbsp;                double mAVLong = bayWType.getLongAV();</b>
<b class="nc">&nbsp;                double mAVExt = bayWType.getExtAV();</b>
<b class="nc">&nbsp;                int mMaxR = bayWType.getMaxRange(m);</b>
&nbsp;
&nbsp;                // deal with any ammo adjustments
<b class="nc">&nbsp;                if (null != m.getLinked()) {</b>
<b class="nc">&nbsp;                    double[] changes = changeAttackValues((AmmoType) m</b>
<b class="nc">&nbsp;                                                                  .getLinked().getType(), mAVShort, mAVMed,</b>
&nbsp;                                                          mAVLong, mAVExt, mMaxR);
<b class="nc">&nbsp;                    mAVShort = changes[0];</b>
<b class="nc">&nbsp;                    mAVMed = changes[1];</b>
<b class="nc">&nbsp;                    mAVLong = changes[2];</b>
<b class="nc">&nbsp;                    mAVExt = changes[3];</b>
<b class="nc">&nbsp;                    mMaxR = (int) changes[4];</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                avShort = avShort + mAVShort;</b>
<b class="nc">&nbsp;                avMed = avMed + mAVMed;</b>
<b class="nc">&nbsp;                avLong = avLong + mAVLong;</b>
<b class="nc">&nbsp;                avExt = avExt + mAVExt;</b>
<b class="nc">&nbsp;                if (mMaxR &gt; maxr) {</b>
<b class="nc">&nbsp;                    maxr = mMaxR;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // check for bracketing
<b class="nc">&nbsp;        double mult = 1.0;</b>
<b class="nc">&nbsp;        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(&quot;Bracket 80%&quot;)) {</b>
<b class="nc">&nbsp;            mult = 0.8;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(&quot;Bracket 60%&quot;)) {</b>
<b class="nc">&nbsp;            mult = 0.6;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(&quot;Bracket 40%&quot;)) {</b>
<b class="nc">&nbsp;            mult = 0.4;</b>
&nbsp;        }
<b class="nc">&nbsp;        avShort = mult * avShort;</b>
<b class="nc">&nbsp;        avMed = mult * avMed;</b>
<b class="nc">&nbsp;        avLong = mult * avLong;</b>
<b class="nc">&nbsp;        avExt = mult * avExt;</b>
&nbsp;
<b class="nc">&nbsp;        if (entity.getGame().getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY) &amp;&amp; wtype.isCapital()) {</b>
<b class="nc">&nbsp;            avShort *= 10;</b>
<b class="nc">&nbsp;            avMed *= 10;</b>
<b class="nc">&nbsp;            avLong *= 10;</b>
<b class="nc">&nbsp;            avExt *= 10;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        wHeatR.setText(Integer.toString(heat));</b>
<b class="nc">&nbsp;        wShortAVR.setText(Integer.toString((int) Math.ceil(avShort)));</b>
<b class="nc">&nbsp;        if (isCapital) {</b>
<b class="nc">&nbsp;            wShortR.setText(&quot;1-12&quot;); //$NON-NLS-1$</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wShortR.setText(&quot;1-6&quot;); //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        if (maxr &gt; WeaponType.RANGE_SHORT) {</b>
<b class="nc">&nbsp;            wMedAVR.setText(Integer.toString((int) Math.ceil(avMed)));</b>
<b class="nc">&nbsp;            if (isCapital) {</b>
<b class="nc">&nbsp;                wMedR.setText(&quot;13-24&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wMedR.setText(&quot;7-12&quot;); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (maxr &gt; WeaponType.RANGE_MED) {</b>
<b class="nc">&nbsp;            wLongAVR.setText(Integer.toString((int) Math.ceil(avLong)));</b>
<b class="nc">&nbsp;            if (isCapital) {</b>
<b class="nc">&nbsp;                wLongR.setText(&quot;25-40&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wLongR.setText(&quot;13-20&quot;); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (maxr &gt; WeaponType.RANGE_LONG) {</b>
<b class="nc">&nbsp;            wExtAVR.setText(Integer.toString((int) Math.ceil(avExt)));</b>
<b class="nc">&nbsp;            if (isCapital) {</b>
<b class="nc">&nbsp;                wExtR.setText(&quot;41-50&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                wExtR.setText(&quot;21-25&quot;); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        onResize();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void valueChanged(ListSelectionEvent event) {
<b class="nc">&nbsp;        if (event.getValueIsAdjusting()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (event.getSource().equals(weaponList)) {</b>
<b class="nc">&nbsp;            displaySelected();</b>
&nbsp;            
&nbsp;            // Can&#39;t do anything if ClientGUI is null
<b class="nc">&nbsp;            if (unitDisplay.getClientGUI() == null) {</b>
&nbsp;                return;
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            JComponent currPanel = unitDisplay.getClientGUI().getCurrentPanel();</b>
&nbsp;            // When in the Firing Phase, update the targeting information.
<b class="nc">&nbsp;            if (currPanel instanceof FiringDisplay) {</b>
<b class="nc">&nbsp;                FiringDisplay firingDisplay = (FiringDisplay)currPanel;</b>
&nbsp;
<b class="nc">&nbsp;                Mounted mounted = null;</b>
<b class="nc">&nbsp;                WeaponListModel weaponModel = (WeaponListModel) weaponList</b>
<b class="nc">&nbsp;                        .getModel();</b>
<b class="nc">&nbsp;                if (weaponList.getSelectedIndex() != -1) {</b>
<b class="nc">&nbsp;                    mounted = weaponModel.getWeaponAt(weaponList</b>
<b class="nc">&nbsp;                            .getSelectedIndex());</b>
&nbsp;                }
<b class="nc">&nbsp;                Mounted prevMounted = null;</b>
<b class="nc">&nbsp;                if ((event.getLastIndex() != -1) </b>
<b class="nc">&nbsp;                        &amp;&amp; (event.getLastIndex() &lt; weaponModel.getSize())) {</b>
<b class="nc">&nbsp;                    prevMounted = weaponModel.getWeaponAt(event.getLastIndex());</b>
&nbsp;                }
&nbsp;                // Some weapons have a specific target, which gets handled
&nbsp;                // in the target method
<b class="nc">&nbsp;                if (mounted != null</b>
<b class="nc">&nbsp;                        &amp;&amp; mounted.getType().hasFlag(WeaponType.F_VGL)) {</b>
&nbsp;                    // Store previous target, if it&#39;s a weapon that doesn&#39;t 
&nbsp;                    // have a forced target
<b class="nc">&nbsp;                    if ((prevMounted != null)</b>
<b class="nc">&nbsp;                            &amp;&amp; !prevMounted.getType().hasFlag(WeaponType.F_VGL)) {</b>
<b class="nc">&nbsp;                        prevTarget = firingDisplay.getTarget();</b>
&nbsp;                    }                    
<b class="nc">&nbsp;                    firingDisplay.target(null);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    if (prevTarget != null) {</b>
<b class="nc">&nbsp;                        firingDisplay.target(prevTarget);</b>
<b class="nc">&nbsp;                        unitDisplay.getClientGUI().getBoardView()</b>
<b class="nc">&nbsp;                                .select(prevTarget.getPosition());</b>
<b class="nc">&nbsp;                        prevTarget = null;</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        firingDisplay.updateTarget();</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            } else if (currPanel instanceof TargetingPhaseDisplay) {</b>
<b class="nc">&nbsp;                ((TargetingPhaseDisplay) currPanel).updateTarget();</b>
&nbsp;            }
&nbsp;            
&nbsp;            // Tell the &lt;Phase&gt;Display to update the 
&nbsp;            // firing arc info when a weapon has been de-selected
<b class="nc">&nbsp;            if (weaponList.getSelectedIndex() == -1) {</b>
<b class="nc">&nbsp;                unitDisplay.getClientGUI().bv.clearFieldofF();</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        onResize();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void actionPerformed(ActionEvent ev) {
<b class="nc">&nbsp;        ClientGUI clientgui = unitDisplay.getClientGUI();</b>
<b class="nc">&nbsp;        if (ev.getSource().equals(m_chAmmo)</b>
<b class="nc">&nbsp;                &amp;&amp; (m_chAmmo.getSelectedIndex() != -1)</b>
&nbsp;                &amp;&amp; (clientgui != null)) {
&nbsp;            // only change our own units
<b class="nc">&nbsp;            if (!clientgui.getClient().getLocalPlayer()</b>
<b class="nc">&nbsp;                    .equals(entity.getOwner())) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            int n = weaponList.getSelectedIndex();</b>
<b class="nc">&nbsp;            if (weaponList.getSelectedIndex() == -1) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            Mounted mWeap = ((WeaponListModel) weaponList.getModel())</b>
<b class="nc">&nbsp;                    .getWeaponAt(n);</b>
<b class="nc">&nbsp;            Mounted oldWeap = mWeap;</b>
<b class="nc">&nbsp;            Mounted oldAmmo = mWeap.getLinked();</b>
<b class="nc">&nbsp;            Mounted mAmmo = vAmmo.get(m_chAmmo.getSelectedIndex());</b>
&nbsp;            // if this is a weapon bay, then this is not what we want
<b class="nc">&nbsp;            boolean isBay = false;</b>
<b class="nc">&nbsp;            if (mWeap.getType() instanceof BayWeapon) {</b>
<b class="nc">&nbsp;                isBay = true;</b>
<b class="nc">&nbsp;                n = m_chBayWeapon.getSelectedIndex();</b>
<b class="nc">&nbsp;                if (n == -1) {</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;                //
<b class="nc">&nbsp;                Mounted sWeap = entity.getEquipment(mWeap.getBayWeapons()</b>
<b class="nc">&nbsp;                        .elementAt(n));</b>
&nbsp;                // cycle through all weapons of the same type and load with
&nbsp;                // this ammo
<b class="nc">&nbsp;                for (int wid : mWeap.getBayWeapons()) {</b>
<b class="nc">&nbsp;                    Mounted bWeap = entity.getEquipment(wid);</b>
&nbsp;                    // FIXME: Consider new AmmoType::equals / BombType::equals
<b class="nc">&nbsp;                    if (bWeap.getType().equals(sWeap.getType())) {</b>
<b class="nc">&nbsp;                        entity.loadWeapon(bWeap, mAmmo);</b>
&nbsp;                        // Alert the server of the update.
<b class="nc">&nbsp;                        clientgui.getClient().sendAmmoChange(</b>
<b class="nc">&nbsp;                                entity.getId(),</b>
<b class="nc">&nbsp;                                entity.getEquipmentNum(bWeap),</b>
<b class="nc">&nbsp;                                entity.getEquipmentNum(mAmmo));</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                entity.loadWeapon(mWeap, mAmmo);</b>
&nbsp;                // Alert the server of the update.
<b class="nc">&nbsp;                clientgui.getClient().sendAmmoChange(entity.getId(),</b>
<b class="nc">&nbsp;                        entity.getEquipmentNum(mWeap),</b>
<b class="nc">&nbsp;                        entity.getEquipmentNum(mAmmo));</b>
&nbsp;            }
&nbsp;
&nbsp;            // Refresh for hot load change
<b class="nc">&nbsp;            if ((((oldAmmo == null) || !oldAmmo.isHotLoaded()) &amp;&amp; mAmmo</b>
<b class="nc">&nbsp;                    .isHotLoaded())</b>
<b class="nc">&nbsp;                    || ((oldAmmo != null) &amp;&amp; oldAmmo.isHotLoaded() &amp;&amp; !mAmmo</b>
<b class="nc">&nbsp;                            .isHotLoaded())) {</b>
<b class="nc">&nbsp;                displayMech(entity);</b>
<b class="nc">&nbsp;                weaponList.setSelectedIndex(n);</b>
<b class="nc">&nbsp;                weaponList.ensureIndexIsVisible(n);</b>
<b class="nc">&nbsp;                displaySelected();</b>
&nbsp;            }
&nbsp;
&nbsp;            // Update the range display to account for the weapon&#39;s loaded
&nbsp;            // ammo.
<b class="nc">&nbsp;            updateRangeDisplayForAmmo(mAmmo);</b>
<b class="nc">&nbsp;            if (entity.isAirborne() || entity.usesWeaponBays()) {</b>
<b class="nc">&nbsp;                WeaponType wtype = (WeaponType) mWeap.getType();</b>
<b class="nc">&nbsp;                if (isBay) {</b>
<b class="nc">&nbsp;                    compileWeaponBay(oldWeap, wtype.isCapital());</b>
&nbsp;                } else {
&nbsp;                    // otherwise I need to replace range display with
&nbsp;                    // standard ranges and attack values
<b class="nc">&nbsp;                    updateAttackValues(mWeap, mAmmo);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // When in the Firing Phase, update the targeting information.
<b class="nc">&nbsp;            if (clientgui.getCurrentPanel() instanceof FiringDisplay) {</b>
<b class="nc">&nbsp;                ((FiringDisplay) clientgui.getCurrentPanel()).updateTarget();</b>
<b class="nc">&nbsp;            } else if (clientgui.getCurrentPanel() instanceof TargetingPhaseDisplay) {</b>
<b class="nc">&nbsp;                ((TargetingPhaseDisplay) clientgui.getCurrentPanel()).updateTarget();</b>
&nbsp;            }
<b class="nc">&nbsp;            displaySelected();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(m_chBayWeapon)</b>
<b class="nc">&nbsp;                   &amp;&amp; (m_chBayWeapon.getItemCount() &gt; 0)) {</b>
<b class="nc">&nbsp;            int n = weaponList.getSelectedIndex();</b>
<b class="nc">&nbsp;            if (n == -1) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            displaySelected();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(weapSortOrder)) {</b>
<b class="nc">&nbsp;            setWeaponComparator(weapSortOrder.getSelectedIndex());</b>
&nbsp;        }
<b class="nc">&nbsp;        onResize();</b>
&nbsp;    }
&nbsp;
&nbsp;    void setWeaponComparator(int sortIdx) {
&nbsp;        Comparator&lt;Mounted&gt; weapComparator;
<b class="nc">&nbsp;        if (sortIdx == Entity.WeaponSortOrder.RANGE_LH.ordinal()) {</b>
<b class="nc">&nbsp;            entity.setWeaponSortOrder(Entity.WeaponSortOrder.RANGE_LH);</b>
<b class="nc">&nbsp;            weapComparator = new WeaponComparatorRange(true);</b>
<b class="nc">&nbsp;        } else if (sortIdx == Entity.WeaponSortOrder.RANGE_HL.ordinal()) {</b>
<b class="nc">&nbsp;            entity.setWeaponSortOrder(Entity.WeaponSortOrder.RANGE_HL);</b>
<b class="nc">&nbsp;            weapComparator = new WeaponComparatorRange(false);</b>
<b class="nc">&nbsp;        } else if (sortIdx == Entity.WeaponSortOrder.DAMAGE_LH.ordinal()) {</b>
<b class="nc">&nbsp;            entity.setWeaponSortOrder(Entity.WeaponSortOrder.DAMAGE_LH);</b>
<b class="nc">&nbsp;            weapComparator = new WeaponComparatorDamage(true);</b>
<b class="nc">&nbsp;        } else if (sortIdx == Entity.WeaponSortOrder.DAMAGE_HL.ordinal()) {</b>
<b class="nc">&nbsp;            entity.setWeaponSortOrder(Entity.WeaponSortOrder.DAMAGE_HL);</b>
<b class="nc">&nbsp;            weapComparator = new WeaponComparatorDamage(false);</b>
<b class="nc">&nbsp;        } else if (sortIdx == Entity.WeaponSortOrder.CUSTOM.ordinal()) {</b>
<b class="nc">&nbsp;            entity.setWeaponSortOrder(Entity.WeaponSortOrder.CUSTOM);</b>
<b class="nc">&nbsp;            weapComparator = new WeaponComparatorCustom(entity);</b>
<b class="nc">&nbsp;        } else if (sortIdx == Entity.WeaponSortOrder.ARC.ordinal()) {</b>
<b class="nc">&nbsp;            entity.setWeaponSortOrder(Entity.WeaponSortOrder.ARC);</b>
<b class="nc">&nbsp;            weapComparator = new WeaponComparatorArc(entity);</b>
&nbsp;        } else { // Default
<b class="nc">&nbsp;            entity.setWeaponSortOrder(Entity.WeaponSortOrder.DEFAULT);</b>
<b class="nc">&nbsp;            weapComparator = new WeaponComparatorNum(entity);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (unitDisplay.getClientGUI() != null) {</b>
<b class="nc">&nbsp;            unitDisplay.getClientGUI().getMenuBar()</b>
<b class="nc">&nbsp;                    .updateSaveWeaponOrderMenuItem();</b>
&nbsp;        }
<b class="nc">&nbsp;        ((WeaponListModel)weaponList.getModel()).sort(weapComparator);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void addListeners() {
<b class="nc">&nbsp;        weapSortOrder.addActionListener(this);</b>
<b class="nc">&nbsp;        m_chAmmo.addActionListener(this);</b>
<b class="nc">&nbsp;        m_chBayWeapon.addActionListener(this);</b>
&nbsp;        
<b class="nc">&nbsp;        weaponList.addListSelectionListener(this);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void removeListeners() {
<b class="nc">&nbsp;        weapSortOrder.removeActionListener(this);</b>
<b class="nc">&nbsp;        m_chAmmo.removeActionListener(this);</b>
<b class="nc">&nbsp;        m_chBayWeapon.removeActionListener(this);</b>
&nbsp;        
<b class="nc">&nbsp;        weaponList.removeListSelectionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Targetable getPrevTarget() {
<b class="nc">&nbsp;        return prevTarget;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setPrevTarget(Targetable prevTarget) {
<b class="nc">&nbsp;        this.prevTarget = prevTarget;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
