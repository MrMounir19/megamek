


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ForceDescriptor</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ratgenerator</a>
</div>

<h1>Coverage Summary for Class: ForceDescriptor (megamek.client.ratgenerator)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ForceDescriptor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/102)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/797)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ForceDescriptor$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/105)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/822)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp;* MegaMek -
&nbsp;* Copyright (C) 2016 The MegaMek Team
&nbsp;*
&nbsp;* This program is free software; you can redistribute it and/or modify it under
&nbsp;* the terms of the GNU General Public License as published by the Free Software
&nbsp;* Foundation; either version 2 of the License, or (at your option) any later
&nbsp;* version.
&nbsp;*
&nbsp;* This program is distributed in the hope that it will be useful, but WITHOUT
&nbsp;* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
&nbsp;* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
&nbsp;* details.
&nbsp;*/
&nbsp;
&nbsp;package megamek.client.ratgenerator;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Set;
&nbsp;import java.util.UUID;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.common.Compute;
&nbsp;import megamek.common.Entity;
&nbsp;import megamek.common.EntityMovementMode;
&nbsp;import megamek.common.EntityWeightClass;
&nbsp;import megamek.common.MechFileParser;
&nbsp;import megamek.common.MechSummary;
&nbsp;import megamek.common.MechSummaryCache;
&nbsp;import megamek.common.UnitType;
&nbsp;import megamek.common.loaders.EntityLoadingException;
&nbsp;import megamek.common.logging.LogLevel;
&nbsp;
&nbsp;/**
&nbsp; * Describes the characteristics of a force. May be changed during generation.
&nbsp; *
&nbsp; * @author Neoancient
&nbsp; *
&nbsp; */
&nbsp;public class ForceDescriptor {
&nbsp;
&nbsp;    public static final int REINFORCED = 1;
&nbsp;    public static final int UNDERSTRENGTH = -1;
&nbsp;
&nbsp;    public static final int EXP_GREEN = 0;
&nbsp;    public static final int EXP_REGULAR = 1;
&nbsp;    public static final int EXP_VETERAN = 2;
&nbsp;
<b class="nc">&nbsp;    public static final String[] ORDINALS = {</b>
&nbsp;            &quot;First&quot;, &quot;Second&quot;, &quot;Third&quot;, &quot;Fourth&quot;, &quot;Fifth&quot;,
&nbsp;            &quot;Sixth&quot;, &quot;Seventh&quot;, &quot;Eighth&quot;, &quot;Ninth&quot;, &quot;Tenth&quot;
&nbsp;    };
&nbsp;
<b class="nc">&nbsp;    public static final String[] PHONETIC = {</b>
&nbsp;            &quot;Alpha&quot;, &quot;Bravo&quot;, &quot;Charlie&quot;, &quot;Delta&quot;, &quot;Echo&quot;,
&nbsp;            &quot;Foxtrot&quot;, &quot;Golf&quot;, &quot;Hotel&quot;, &quot;India&quot;, &quot;Juliett&quot;,
&nbsp;            &quot;Kilo&quot;, &quot;Lima&quot;, &quot;Mike&quot;, &quot;November&quot;, &quot;Oscar&quot;,
&nbsp;            &quot;Papa&quot;, &quot;Quebec&quot;, &quot;Romeo&quot;, &quot;Sierra&quot;, &quot;Tango&quot;,
&nbsp;            &quot;Uniform&quot;, &quot;Victor&quot;, &quot;Whiskey&quot;, &quot;X-ray&quot;, &quot;Yankee&quot;,
&nbsp;            &quot;Zulu&quot;
&nbsp;    };
&nbsp;
<b class="nc">&nbsp;    public static final String[] GREEK = {</b>
&nbsp;            &quot;Alpha&quot;, &quot;Beta&quot;, &quot;Gamma&quot;, &quot;Delta&quot;, &quot;Epsilon&quot;,
&nbsp;            &quot;Zeta&quot;, &quot;Eta&quot;, &quot;Theta&quot;, &quot;Iota&quot;, &quot;Kappa&quot;,
&nbsp;            &quot;Lambda&quot;, &quot;Mu&quot;, &quot;Nu&quot;, &quot;Xi&quot;, &quot;Omicron&quot;, &quot;Pi&quot;,
&nbsp;            &quot;Rho&quot;, &quot;Sigma&quot;, &quot;Tau&quot;, &quot;Upsilon&quot;, &quot;Phi&quot;,
&nbsp;            &quot;Chi&quot;, &quot;Psi&quot;, &quot;Omega&quot;
&nbsp;    };
&nbsp;
<b class="nc">&nbsp;    public static final String[] LATIN = {</b>
&nbsp;            &quot;Prima&quot;, &quot;Secunda&quot;, &quot;Tertia&quot;, &quot;Quarta&quot;, &quot;Quinta&quot;,
&nbsp;            &quot;Sexta&quot;, &quot;Septima&quot;, &quot;Octava&quot;, &quot;Nona&quot;, &quot;Decima&quot;
&nbsp;    };
&nbsp;
<b class="nc">&nbsp;    public static final String[] ROMAN = {</b>
&nbsp;            &quot;I&quot;, &quot;II&quot;, &quot;III&quot;, &quot;IV&quot;, &quot;V&quot;, &quot;VI&quot;, &quot;VII&quot;, &quot;VIII&quot;, &quot;IX&quot;, &quot;X&quot;,
&nbsp;            &quot;XI&quot;, &quot;XII&quot;, &quot;XIII&quot;, &quot;XIV&quot;, &quot;XV&quot;, &quot;XVI&quot;, &quot;XVII&quot;, &quot;XVIII&quot;, &quot;XIX&quot;, &quot;XX&quot;
&nbsp;    };
&nbsp;
&nbsp;    private int index;
&nbsp;    private String name;
&nbsp;    private String faction;
&nbsp;    private Integer year;
&nbsp;    private Integer eschelon;
&nbsp;    private int sizeMod;
&nbsp;    private boolean augmented;
&nbsp;    private Integer weightClass;
&nbsp;    private Integer unitType;
&nbsp;    private HashSet&lt;EntityMovementMode&gt; movementModes;
&nbsp;    private HashSet&lt;MissionRole&gt; roles;
&nbsp;    private String rating;
&nbsp;    private Integer experience;
&nbsp;    private Integer rankSystem;
&nbsp;    private Integer coRank;
&nbsp;    private HashSet&lt;String&gt; models;
&nbsp;    private HashSet&lt;String&gt; chassis;
&nbsp;    private HashSet&lt;String&gt; variants;
&nbsp;    private CrewDescriptor co;
&nbsp;    private CrewDescriptor xo;
&nbsp;    private String camo;
&nbsp;
&nbsp;    private HashSet&lt;String&gt; flags;
&nbsp;
&nbsp;    private FormationType formationType;
&nbsp;    private String generationRule;
&nbsp;    private boolean topLevel;
&nbsp;    private boolean element;
&nbsp;    private int positionIndex;
&nbsp;    private int nameIndex;
&nbsp;    private String fluffName;
&nbsp;    private Entity entity;
&nbsp;    private List&lt;ValueNode&gt; nameNodes;
&nbsp;
&nbsp;    private boolean generateAttachments;
&nbsp;    private ForceDescriptor parent;
&nbsp;    private ArrayList&lt;ForceDescriptor&gt; subforces;
&nbsp;    private ArrayList&lt;ForceDescriptor&gt; attached;
<b class="nc">&nbsp;    private double dropshipPct = 0.0;</b>
<b class="nc">&nbsp;    private double jumpshipPct = 0.0;</b>
<b class="nc">&nbsp;    private double cargo = 0.0;</b>
&nbsp;
<b class="nc">&nbsp;    public ForceDescriptor() {</b>
<b class="nc">&nbsp;        faction = &quot;IS&quot;;</b>
<b class="nc">&nbsp;        year = 3067;</b>
<b class="nc">&nbsp;        movementModes = new HashSet&lt;EntityMovementMode&gt;();</b>
<b class="nc">&nbsp;        roles = new HashSet&lt;MissionRole&gt;();</b>
<b class="nc">&nbsp;        formationType = null;</b>
<b class="nc">&nbsp;        experience = EXP_REGULAR;</b>
<b class="nc">&nbsp;        models = new HashSet&lt;String&gt;();</b>
<b class="nc">&nbsp;        chassis = new HashSet&lt;String&gt;();</b>
<b class="nc">&nbsp;        variants = new HashSet&lt;String&gt;();</b>
<b class="nc">&nbsp;        parent = null;</b>
<b class="nc">&nbsp;        subforces = new ArrayList&lt;ForceDescriptor&gt;();</b>
<b class="nc">&nbsp;        attached = new ArrayList&lt;ForceDescriptor&gt;();</b>
<b class="nc">&nbsp;        flags = new HashSet&lt;String&gt;();</b>
<b class="nc">&nbsp;        topLevel = false;</b>
<b class="nc">&nbsp;        element = false;</b>
<b class="nc">&nbsp;        positionIndex = -1;</b>
<b class="nc">&nbsp;        nameIndex = -1;</b>
<b class="nc">&nbsp;        fluffName = null;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks whether the chassis matches the unit type for this node of the force tree.
&nbsp;     * If a list of acceptable chassis has been assigned, checks whether the chassis is in the list.
&nbsp;     * unit type.
&nbsp;     *
&nbsp;     * @param cRec A unit chassis record
&nbsp;     * @return     Whether the chassis is of the correct unit type and is on the list of acceptable
&nbsp;     *             chassis if it exists.
&nbsp;     *
&nbsp;     */
&nbsp;    public boolean matches(ChassisRecord cRec) {
<b class="nc">&nbsp;        if (cRec.getUnitType() != unitType) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (chassis.size() &gt; 0 &amp;&amp; !chassis.contains(cRec.getChassis())) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * If a list of acceptable chassis, models, or variants has been assigned, checks whether
&nbsp;     * the model is among them.
&nbsp;     *
&nbsp;     * @param mRec A unit model record
&nbsp;     * @return     Whether the model is on the list of acceptable chassis, variants, or models.
&nbsp;     *
&nbsp;     */
&nbsp;    public boolean matches(ModelRecord mRec) {
<b class="nc">&nbsp;        if (chassis.size() &gt; 0 &amp;&amp; !chassis.contains(mRec.getChassis())) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (variants.size() &gt; 0 &amp;&amp; !variants.contains(mRec.getModel())) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (models.size() &gt; 0 &amp;&amp; !models.contains(mRec.getKey())) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Goes through the force tree structure and generates units for all leaf nodes.
&nbsp;     */
&nbsp;    public void generateUnits(Ruleset.ProgressListener l, double progress) {
&nbsp;        //If the parent node has a chassis or model assigned, it carries through to the children.
<b class="nc">&nbsp;        if (null != parent) {</b>
<b class="nc">&nbsp;            chassis.addAll(parent.getChassis());</b>
<b class="nc">&nbsp;            models.addAll(parent.getModels());</b>
&nbsp;        }
&nbsp;        //First see if a formation has been assigned. If unable to fulfill the formation requirements, generate using default parameters.
<b class="nc">&nbsp;        if (subforces.isEmpty()) {</b>
<b class="nc">&nbsp;            ModelRecord mr = generate();</b>
<b class="nc">&nbsp;            if (null == mr &amp;&amp; !models.isEmpty()) {</b>
<b class="nc">&nbsp;                mr = RATGenerator.getInstance().getModelRecord(getModelName());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (null != mr) {</b>
<b class="nc">&nbsp;                setUnit(mr);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                MegaMek.getLogger().error(&quot;Could not generate unit&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            if (null != formationType) {</b>
&nbsp;                //Simple leaf node (Lance, Star, etc.
<b class="nc">&nbsp;                if (null != generationRule) {</b>
&nbsp;                    //In cases like Novas and air lances the formation rules only apply to some of the units
<b class="nc">&nbsp;                    if (!generateAndAssignFormation(subforces, generationRule.equals(&quot;chassis&quot;), 0)) {</b>
<b class="nc">&nbsp;                        generateLance(subforces);</b>
<b class="nc">&nbsp;                        formationType = null;</b>
&nbsp;                    }
&nbsp;                } else {
&nbsp;                    //If group generation is not set, then either this is a compound formation (e.g. squadron,
&nbsp;                    //aero/vehicle Point) or we are generating uniform subforces such as companies in SL line units
&nbsp;                    try {
<b class="nc">&nbsp;                        Map&lt;String,List&lt;ForceDescriptor&gt;&gt; byGenRule = subforces.stream()</b>
<b class="nc">&nbsp;                                .collect(Collectors.groupingBy(ForceDescriptor::getGenerationRule));</b>
<b class="nc">&nbsp;                        if (byGenRule.containsKey(&quot;group&quot;)) {</b>
<b class="nc">&nbsp;                            if (!generateAndAssignFormation(byGenRule.get(&quot;group&quot;).stream()</b>
<b class="nc">&nbsp;                                    .map(fd -&gt; fd.getSubforces()).flatMap(sf -&gt; sf.stream())</b>
<b class="nc">&nbsp;                                    .collect(Collectors.toList()), false, byGenRule.get(&quot;group&quot;).size())) {</b>
<b class="nc">&nbsp;                                formationType = null;</b>
&nbsp;                            }
<b class="nc">&nbsp;                        } else if (byGenRule.containsKey(&quot;model&quot;)) {</b>
<b class="nc">&nbsp;                            generateAndAssignFormation(byGenRule.get(&quot;model&quot;), false, 0);</b>
<b class="nc">&nbsp;                        } else if (byGenRule.containsKey(&quot;chassis&quot;)) {</b>
<b class="nc">&nbsp;                            generateAndAssignFormation(byGenRule.get(&quot;chassis&quot;), true, 0);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    } catch (NullPointerException ex) {</b>
<b class="nc">&nbsp;                        MegaMek.getLogger().error(&quot;Found null generation rule in force node with formation set.&quot;);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                if (null != generationRule) {</b>
<b class="nc">&nbsp;                    switch(generationRule) {</b>
&nbsp;                        case &quot;chassis&quot;:
<b class="nc">&nbsp;                            if (getChassis().isEmpty()) {</b>
<b class="nc">&nbsp;                                generate(generationRule);</b>
&nbsp;                            }
&nbsp;                            break;
&nbsp;                        case &quot;model&quot;:
<b class="nc">&nbsp;                            if (getModels().isEmpty()) {</b>
<b class="nc">&nbsp;                                generate(generationRule);</b>
&nbsp;                            }
&nbsp;                            break;
&nbsp;                        case &quot;group&quot;:
<b class="nc">&nbsp;                            generateLance(subforces);</b>
&nbsp;                            break;
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        int count = subforces.size() + attached.size();</b>
<b class="nc">&nbsp;        subforces.forEach(fd -&gt; fd.generateUnits(l, progress / count));</b>
<b class="nc">&nbsp;        attached.forEach(fd -&gt; fd.generateUnits(l, progress / count));</b>
<b class="nc">&nbsp;        if (count == 0 &amp;&amp; null != l) {</b>
<b class="nc">&nbsp;            l.updateProgress(progress, &quot;Populating force tree&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sorts out all subforce nodes eligible for the &lt;code&gt;FormationType&lt;/code&gt; and attempts to generate
&nbsp;     * a formation based on their parameters. If the formation is successfully generated, it is distributed
&nbsp;     * to the subforces in the order provided. For leaf node, the unit is set. For non-final nodes,
&nbsp;     * the unit is added to either the model or chassis list depending on the provided grouping rule.
&nbsp;     * Any subforces that are not eligible for the formation are then generated.
&nbsp;     *
&nbsp;     * @param subs             The subforces to generate unit for. These need not be direct children of
&nbsp;     *                         &lt;code&gt;this&lt;/code&gt;.
&nbsp;     * @param chassis          If true, any non-final subforce node will have the generated unit added to the
&nbsp;     *                         chassis list instead of the model list.
&nbsp;     * @param numGroups        The number of groups to pass on to formation generation; used to override
&nbsp;     *                         standard grouping constraints (e.g. matched pairs in fighter squadrons).
&nbsp;     * @return                 Whether the formation was successfully generated.
&nbsp;     */
&nbsp;    private boolean generateAndAssignFormation(List&lt;ForceDescriptor&gt; subs, boolean chassis, int numGroups) {
<b class="nc">&nbsp;        Map&lt;Boolean,List&lt;ForceDescriptor&gt;&gt; eligibleSubs = subs.stream()</b>
<b class="nc">&nbsp;                .collect(Collectors.groupingBy(fd -&gt; null != fd.getUnitType()</b>
<b class="nc">&nbsp;                &amp;&amp; (formationType.isAllowedUnitType(fd.getUnitType()))</b>
&nbsp;                || (augmented
<b class="nc">&nbsp;                        &amp;&amp; (fd.getUnitType() == UnitType.BATTLE_ARMOR)</b>
<b class="nc">&nbsp;                        || fd.getUnitType() == UnitType.INFANTRY)));</b>
<b class="nc">&nbsp;        if (eligibleSubs.containsKey(true)) {</b>
<b class="nc">&nbsp;            if (eligibleSubs.get(true).isEmpty()) {</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                List&lt;ModelRecord&gt; list = null;</b>
<b class="nc">&nbsp;                if (augmented) {</b>
<b class="nc">&nbsp;                    list = generateNovaFormation(eligibleSubs.get(true), ModelRecord.NETWORK_NONE, numGroups);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    list = generateFormation(eligibleSubs.get(true), ModelRecord.NETWORK_NONE, numGroups);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (list.isEmpty()) {</b>
<b class="nc">&nbsp;                    return false;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    for (int i = 0; i &lt; list.size(); i++) {</b>
&nbsp;                        //The formation requirements do not apply to the infantry part of a nova, and
&nbsp;                        //those units have already been generated by generateNovaFormation.
<b class="nc">&nbsp;                        if (augmented</b>
<b class="nc">&nbsp;                                &amp;&amp; (eligibleSubs.get(true).get(i).getUnitType() == UnitType.BATTLE_ARMOR</b>
<b class="nc">&nbsp;                                || eligibleSubs.get(true).get(i).getUnitType() == UnitType.INFANTRY)) {</b>
<b class="nc">&nbsp;                            continue;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (eligibleSubs.get(true).get(i).getSubforces().isEmpty()) {</b>
<b class="nc">&nbsp;                            eligibleSubs.get(true).get(i).setUnit(list.get(i));</b>
<b class="nc">&nbsp;                        } else if (chassis) {</b>
<b class="nc">&nbsp;                            eligibleSubs.get(true).get(i).getChassis().add(list.get(i).getChassis());</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            eligibleSubs.get(true).get(i).getModels().add(list.get(i).getKey());</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (eligibleSubs.containsKey(false)) {</b>
<b class="nc">&nbsp;                generateLance(eligibleSubs.get(false));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Translates &lt;code&gt;ForceDescriptor&lt;/code&gt; list into parameters to pass to the formation builder.
&nbsp;     *
&nbsp;     * @param subs         A list of &lt;ForceDescriptor&lt;/code&gt; nodes.
&nbsp;     * @param networkMask  The type of C3 network that should be used in generating the formation.
&nbsp;     * @param numGroups    Overrides the default value for formation grouping constraints (e.g. some
&nbsp;     *                     Capellan squadrons have two groups of three instead of the standard three groups
&nbsp;     *                     of two).
&nbsp;     * @return             The list of units that make up the formation, or an empty list if a formation
&nbsp;     *                     could not be generated with the given parameters.
&nbsp;     */
&nbsp;    private List&lt;ModelRecord&gt; generateFormation (List&lt;ForceDescriptor&gt; subs, int networkMask, int numGroups) {
<b class="nc">&nbsp;        Map&lt;UnitTable.Parameters, Integer&gt; paramCount = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for (ForceDescriptor sub : subs) {</b>
<b class="nc">&nbsp;            paramCount.merge(new UnitTable.Parameters(sub.getFactionRec(),</b>
<b class="nc">&nbsp;                    sub.getUnitType(), sub.getYear(), sub.ratGeneratorRating(), null, networkMask,</b>
<b class="nc">&nbsp;                    sub.getMovementModes(), sub.getRoles(), 0, sub.getFactionRec()), 1, Integer::sum);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;UnitTable.Parameters&gt; params = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        List&lt;Integer&gt; numUnits = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (Map.Entry&lt;UnitTable.Parameters, Integer&gt; e : paramCount.entrySet()) {</b>
<b class="nc">&nbsp;            params.add(e.getKey());</b>
<b class="nc">&nbsp;            numUnits.add(e.getValue());</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        // Check for amount of C3 equipment generated and if certain thresholds are met regenerate the unit
&nbsp;        // with a valid network.
<b class="nc">&nbsp;        List&lt;MechSummary&gt; unitList = formationType.generateFormation(params, numUnits, networkMask, false, 0, numGroups);</b>
<b class="nc">&nbsp;        if (networkMask == ModelRecord.NETWORK_NONE) {</b>
<b class="nc">&nbsp;            int c3m = 0;</b>
<b class="nc">&nbsp;            int c3s = 0;</b>
<b class="nc">&nbsp;            int c3i = 0;</b>
<b class="nc">&nbsp;            int nova = 0;</b>
<b class="nc">&nbsp;            for (MechSummary ms : unitList) {</b>
<b class="nc">&nbsp;                ModelRecord mRec = RATGenerator.getInstance().getModelRecord(ms.getName());</b>
<b class="nc">&nbsp;                int mask = mRec == null? ModelRecord.NETWORK_NONE : mRec.getNetworkMask();</b>
&nbsp;
<b class="nc">&nbsp;                if ((mask &amp; ModelRecord.NETWORK_C3_MASTER) != 0) {</b>
<b class="nc">&nbsp;                    c3m++;</b>
&nbsp;                }
<b class="nc">&nbsp;                if ((mask &amp; ModelRecord.NETWORK_C3_SLAVE) != 0) {</b>
<b class="nc">&nbsp;                    c3s++;</b>
&nbsp;                }
<b class="nc">&nbsp;                if ((mask &amp; ModelRecord.NETWORK_C3I) != 0) {</b>
<b class="nc">&nbsp;                    c3i++;</b>
&nbsp;                }
<b class="nc">&nbsp;                if ((mask &amp; ModelRecord.NETWORK_NOVA) != 0) {</b>
<b class="nc">&nbsp;                    nova++;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;            // Any lance with a C3 master should have three slave units (or the remainder of the unit, if smaller)
<b class="nc">&nbsp;            if (c3m &gt; 0) {</b>
<b class="nc">&nbsp;                if ((c3m &gt; 1) || (c3s &lt; Math.max(3, unitList.size() - 1))) {</b>
<b class="nc">&nbsp;                    networkMask = ModelRecord.NETWORK_C3_MASTER;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    flags.add(&quot;c3&quot;);</b>
&nbsp;                }
&nbsp;            } else {
&nbsp;                // If no master was generated, each slave unit gives a cumulative 1/3 chance of a network. Isolated
&nbsp;                // C3 slaves will be encountered, but not usually more than one or maybe two in a lance.
<b class="nc">&nbsp;                if (c3s &gt; Compute.randomInt(3)) {</b>
<b class="nc">&nbsp;                    networkMask = ModelRecord.NETWORK_C3_MASTER;</b>
<b class="nc">&nbsp;                } else if (c3i &gt; Compute.randomInt(5)) {</b>
&nbsp;                    // Each C3i gives a 1/5 chance of a full C3i network. A network is still useful if not full.
<b class="nc">&nbsp;                    networkMask = ModelRecord.NETWORK_C3I;</b>
<b class="nc">&nbsp;                } else if (nova &gt; 0) {</b>
&nbsp;                    // The Nova CEWS is specialized enough to add a complete network if any is present.
<b class="nc">&nbsp;                    networkMask = ModelRecord.NETWORK_NOVA;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (networkMask != ModelRecord.NETWORK_NONE) {</b>
<b class="nc">&nbsp;                List&lt;MechSummary&gt; netList = formationType.generateFormation(params, numUnits, networkMask, false, 0, numGroups);</b>
&nbsp;                // Attempt to create the type of network indicated. If no unit can be created that fits the
&nbsp;                // criteria, fall back on the unit that was originally generated.
<b class="nc">&nbsp;                if (!netList.isEmpty()) {</b>
<b class="nc">&nbsp;                    unitList = netList;</b>
<b class="nc">&nbsp;                    if (networkMask == ModelRecord.NETWORK_C3I) {</b>
<b class="nc">&nbsp;                        flags.add(&quot;c3i&quot;);</b>
<b class="nc">&nbsp;                    } else if (networkMask == ModelRecord.NETWORK_NOVA) {</b>
<b class="nc">&nbsp;                        flags.add(&quot;novacews&quot;);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        flags.add(&quot;c3&quot;);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return unitList.stream().map(ms -&gt; RATGenerator.getInstance().getModelRecord(ms.getName()))</b>
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * The Nova formation is a composite of base type and battle armor. The formationType only applies to the
&nbsp;     * base unit type (Mek, vehicle, fighter). The BA must be eligible for mechanized and have at least
&nbsp;     * one omni among the base units per BA squad/point, excepting any BA with magnetic clamps.
&nbsp;     *
&nbsp;     * Though the rules in Campaign Operations only cover BA novas, the Hell&#39;s Horses vehicle/conventional infantry
&nbsp;     * nova formations require an adapted version of the Nova formation rules to work.
&nbsp;     *
&nbsp;     * This method generates and assigns infantry elements and returns the list of base elements.
&nbsp;     *
&nbsp;     * @param subs         A list of &lt;ForceDescriptor&lt;/code&gt; nodes.
&nbsp;     * @param networkMask  The type of C3 network that should be used in generating the formation.
&nbsp;     * @param numGroups    Overrides the default value for formation grouping constraints (e.g. some
&nbsp;     *                     Capellan squadrons have two groups of three instead of the standard three groups
&nbsp;     *                     of two).
&nbsp;     * @return             The list of units that make up the base formation, or an empty list if a formation
&nbsp;     *                     could not be generated with the given parameters.
&nbsp;     */
&nbsp;    private List&lt;ModelRecord&gt; generateNovaFormation(List&lt;ForceDescriptor&gt; subs, int networkMask, int numGroups) {
&nbsp;        //Split base and infantry units
<b class="nc">&nbsp;        List&lt;ForceDescriptor&gt; baseSubs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        List&lt;ForceDescriptor&gt; baSubs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        List&lt;ForceDescriptor&gt; infSubs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (ForceDescriptor sub : subs) {</b>
<b class="nc">&nbsp;            if (sub.getUnitType() == UnitType.BATTLE_ARMOR) {</b>
<b class="nc">&nbsp;                baSubs.add(sub);</b>
<b class="nc">&nbsp;            } else if (sub.getUnitType() == UnitType.INFANTRY) {</b>
<b class="nc">&nbsp;                infSubs.add(sub);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                baseSubs.add(sub);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        //If there is any conventional infantry we&#39;ll generate it first, then assign the APC role
&nbsp;        //to as many vehicles (if any) in the base units as we have foot infantry. Any remaining vehicles
&nbsp;        //will get the infantry support role.
<b class="nc">&nbsp;        if (infSubs.size() &gt; 0) {</b>
<b class="nc">&nbsp;            generateLance(infSubs);</b>
<b class="nc">&nbsp;            int footCount = (int)infSubs.stream().filter(fd -&gt; fd.getMovementModes()</b>
<b class="nc">&nbsp;                    .contains(EntityMovementMode.INF_LEG)).count();</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; baseSubs.size(); i++) {</b>
<b class="nc">&nbsp;                if (baseSubs.get(i).getUnitType() == UnitType.TANK</b>
<b class="nc">&nbsp;                        || baseSubs.get(i).getUnitType() == UnitType.VTOL) {</b>
<b class="nc">&nbsp;                    if (footCount &gt; 0) {</b>
<b class="nc">&nbsp;                        baseSubs.get(i).getRoles().add(MissionRole.APC);</b>
<b class="nc">&nbsp;                        footCount--;</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        baseSubs.get(i).getRoles().add(MissionRole.INF_SUPPORT);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        //Generate the base units according to the formation type.
<b class="nc">&nbsp;        List&lt;ModelRecord&gt; baseUnitList = null;</b>
<b class="nc">&nbsp;        if (!baseSubs.isEmpty()) {</b>
<b class="nc">&nbsp;            baseUnitList = generateFormation(baseSubs, networkMask, numGroups);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (null == baseUnitList) {</b>
<b class="nc">&nbsp;            generateLance(baseSubs);</b>
<b class="nc">&nbsp;            baseUnitList = baseSubs.stream().map(ForceDescriptor::getModelName)</b>
<b class="nc">&nbsp;                    .map(m -&gt; RATGenerator.getInstance().getModelRecord(m))</b>
<b class="nc">&nbsp;                    .filter(Objects::nonNull).collect(Collectors.toList());</b>
&nbsp;        }
&nbsp;
&nbsp;        //Any BA in exceess of the number of omni base units will require mag clamps, up to the number of base units.
<b class="nc">&nbsp;        int magReq = Math.min((int)(baSubs.size() - baseUnitList.stream().filter(mr -&gt; mr.isOmni()).count()),</b>
<b class="nc">&nbsp;                baSubs.size());</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; baSubs.size(); i++) {</b>
<b class="nc">&nbsp;            if (i &lt; magReq) {</b>
<b class="nc">&nbsp;                baSubs.get(i).getRoles().add(MissionRole.MAG_CLAMP);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                baSubs.get(i).getRoles().add(MissionRole.MECHANIZED_BA);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        generateLance(baSubs);</b>
&nbsp;
<b class="nc">&nbsp;        return baseUnitList;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Generates a lance or other end-level unit (star, level ii) by individual units rather than
&nbsp;     * as an entire formation. Some unit cohesion is attempted for certain unit types, such as building
&nbsp;     * vehicle lances out of the same model or pairing fighter chassis. The equipment rating has an
&nbsp;     * effect on unit cohesion, such that lower rated units are more likely to have mismatched equipment.
&nbsp;     *
&nbsp;     * @param subs The subforces that describe the indiviual elements of the lance
&nbsp;     */
&nbsp;    public void generateLance(List&lt;ForceDescriptor&gt; subs) {
<b class="nc">&nbsp;        if (subs.size() == 0) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        ModelRecord unit = null;</b>
<b class="nc">&nbsp;        if (chassis.size() &gt; 0 || models.size() &gt; 0) {</b>
<b class="nc">&nbsp;            for (ForceDescriptor sub : subs) {</b>
<b class="nc">&nbsp;                unit = sub.generate();</b>
<b class="nc">&nbsp;                if (unit != null) {</b>
<b class="nc">&nbsp;                    sub.setUnit(unit);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        /* This method can be used to generate pieces of a combined arms
&nbsp;         * unit, so we need to get the unit type from one of the subforces
&nbsp;         * rather than the current. */
&nbsp;
<b class="nc">&nbsp;        Integer ut = subs.get(0).getUnitType();</b>
&nbsp;
<b class="nc">&nbsp;        boolean useWeights = useWeightClass(ut);</b>
<b class="nc">&nbsp;        ArrayList&lt;Integer&gt; weights = new ArrayList&lt;Integer&gt;();</b>
<b class="nc">&nbsp;        if (useWeights) {</b>
<b class="nc">&nbsp;            for (ForceDescriptor sub : subs) {</b>
<b class="nc">&nbsp;                weights.add(sub.getWeightClass());</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        } else {
<b class="nc">&nbsp;            weights.add(-1);</b>
<b class="nc">&nbsp;            weights.add(0);</b>
<b class="nc">&nbsp;            weights.add(1);</b>
<b class="nc">&nbsp;            weights.add(2);</b>
<b class="nc">&nbsp;            weights.add(3);</b>
<b class="nc">&nbsp;            weights.add(4);</b>
<b class="nc">&nbsp;            weights.add(5);</b>
<b class="nc">&nbsp;            weights.add(null);</b>
&nbsp;        }
<b class="nc">&nbsp;        int ratingLevel = getRatingLevel();</b>
<b class="nc">&nbsp;        int totalLevels = 5;</b>
&nbsp;        /*
&nbsp;         * 		Using the rating level relative to the total number of levels throws the results
&nbsp;         * 		off for ComStar, which should behave as A-B out of A-F rather than A-B out of A-B.
&nbsp;         *
&nbsp;         * 		int totalLevels = RATGenerator.getInstance().getFaction(faction.split(&quot;,&quot;)[0]).getRatingLevels().size();
&nbsp;         */
<b class="nc">&nbsp;        int target = 12 - ratingLevel;</b>
<b class="nc">&nbsp;        if (ratingLevel &lt; 0) {</b>
<b class="nc">&nbsp;            target = 10;</b>
&nbsp;        }
<b class="nc">&nbsp;        Integer era = RATGenerator.getInstance().eraForYear(getYear());</b>
<b class="nc">&nbsp;        AvailabilityRating av = null;</b>
<b class="nc">&nbsp;        ModelRecord baseModel = null;</b>
&nbsp;        /* Generate base model using weight class of entire formation */
<b class="nc">&nbsp;        if (ut != null) {</b>
<b class="nc">&nbsp;            if (!(ut == UnitType.MEK || (ut == UnitType.AERO &amp;&amp; subs.size() &gt; 3))) {</b>
<b class="nc">&nbsp;                baseModel = subs.get(0).generate();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (ut == UnitType.AERO || ut == UnitType.CONV_FIGHTER) {</b>
<b class="nc">&nbsp;                target -= 3;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (roles.contains(MissionRole.ARTILLERY)) {</b>
<b class="nc">&nbsp;                if (baseModel != null &amp;&amp;</b>
<b class="nc">&nbsp;                        baseModel.getRoles().contains(MissionRole.MISSILE_ARTILLERY)) {</b>
<b class="nc">&nbsp;                    roles.remove(MissionRole.ARTILLERY);</b>
<b class="nc">&nbsp;                    roles.add(MissionRole.MISSILE_ARTILLERY);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    target -= 4;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        for (ForceDescriptor sub : subs) {</b>
<b class="nc">&nbsp;            boolean foundUnit = false;</b>
<b class="nc">&nbsp;            if (baseModel == null || (ut != null &amp;&amp; !ut.equals(sub.getUnitType()))) {</b>
<b class="nc">&nbsp;                unit = sub.generate();</b>
<b class="nc">&nbsp;                if (unit != null) {</b>
<b class="nc">&nbsp;                    sub.setUnit(unit);</b>
<b class="nc">&nbsp;                    baseModel = unit;</b>
<b class="nc">&nbsp;                    if (useWeights) {</b>
<b class="nc">&nbsp;                        weights.remove(sub.getWeightClass());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    foundUnit = true;</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                for (String model : baseModel.getDeployedWith()) {</b>
<b class="nc">&nbsp;                    String chassisKey = model + &quot;[&quot; + ut + &quot;]&quot;;</b>
<b class="nc">&nbsp;                    ChassisRecord cRec = RATGenerator.getInstance().getChassisRecord(chassisKey);</b>
<b class="nc">&nbsp;                    if (cRec == null) {</b>
<b class="nc">&nbsp;                        cRec = RATGenerator.getInstance().getChassisRecord(chassisKey + &quot;Omni&quot;);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (cRec != null) {</b>
<b class="nc">&nbsp;                        av = RATGenerator.getInstance().</b>
<b class="nc">&nbsp;                                findChassisAvailabilityRecord(era, model, faction, getYear());</b>
<b class="nc">&nbsp;                        if (av == null) {</b>
<b class="nc">&nbsp;                            for (String alt : RATGenerator.getInstance().getFaction(faction).getParentFactions()) {</b>
<b class="nc">&nbsp;                                av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, model, alt, getYear());</b>
<b class="nc">&nbsp;                                if (av != null) {</b>
<b class="nc">&nbsp;                                    break;</b>
&nbsp;                                }
<b class="nc">&nbsp;                            }</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (Compute.d6(2) &gt;= target - ((av == null)?0:av.adjustForRating(ratingLevel, totalLevels))) {</b>
<b class="nc">&nbsp;                            sub.getChassis().clear();</b>
<b class="nc">&nbsp;                            sub.getChassis().add(model);</b>
<b class="nc">&nbsp;                            int oldWt = sub.getWeightClass();</b>
<b class="nc">&nbsp;                            sub.setWeightClass(-1);</b>
<b class="nc">&nbsp;                            unit = sub.generate();</b>
<b class="nc">&nbsp;                            if (unit != null &amp;&amp; weights.contains(unit.getWeightClass())) {</b>
<b class="nc">&nbsp;                                sub.setUnit(unit);</b>
<b class="nc">&nbsp;                                if (useWeights) {</b>
<b class="nc">&nbsp;                                    weights.remove(sub.getWeightClass());</b>
&nbsp;                                }
<b class="nc">&nbsp;                                foundUnit = true;</b>
<b class="nc">&nbsp;                                break;</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                sub.setWeightClass(oldWt);</b>
&nbsp;                            }
<b class="nc">&nbsp;                        }</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        ModelRecord mRec = RATGenerator.getInstance().getModelRecord(model);</b>
<b class="nc">&nbsp;                        if (mRec != null &amp;&amp; weights.contains(mRec.getWeightClass())</b>
<b class="nc">&nbsp;                                &amp;&amp; RATGenerator.getInstance().findModelAvailabilityRecord(era, model, faction) != null) {</b>
<b class="nc">&nbsp;                            av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, mRec.getChassisKey(), faction, getYear());</b>
<b class="nc">&nbsp;                            if (av == null) {</b>
<b class="nc">&nbsp;                                for (String alt : RATGenerator.getInstance().getFaction(faction).getParentFactions()) {</b>
<b class="nc">&nbsp;                                    av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, mRec.getChassisKey(), alt, getYear());</b>
<b class="nc">&nbsp;                                    if (av != null) {</b>
<b class="nc">&nbsp;                                        break;</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                }</b>
&nbsp;                            }
<b class="nc">&nbsp;                            if (Compute.d6(2) &gt;= target - ((av == null)?0:av.adjustForRating(ratingLevel, totalLevels))) {</b>
<b class="nc">&nbsp;                                sub.setUnit(mRec);</b>
<b class="nc">&nbsp;                                if (useWeights) {</b>
<b class="nc">&nbsp;                                    weights.remove((Object)mRec.getWeightClass());</b>
&nbsp;                                }
<b class="nc">&nbsp;                                foundUnit = true;</b>
<b class="nc">&nbsp;                                break;</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                if (!foundUnit &amp;&amp; weights.contains(baseModel.getWeightClass())) {</b>
<b class="nc">&nbsp;                    av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, baseModel.getChassisKey(), faction, getYear());</b>
<b class="nc">&nbsp;                    if (av == null) {</b>
<b class="nc">&nbsp;                        for (String alt : RATGenerator.getInstance().getFaction(faction).getParentFactions()) {</b>
<b class="nc">&nbsp;                            av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, baseModel.getChassisKey(), alt, getYear());</b>
<b class="nc">&nbsp;                            if (av != null) {</b>
<b class="nc">&nbsp;                                break;</b>
&nbsp;                            }
<b class="nc">&nbsp;                        }</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (Compute.d6(2) &gt;= target - ((av == null)?0:av.adjustForRating(ratingLevel, totalLevels))) {</b>
<b class="nc">&nbsp;                        sub.getChassis().add(baseModel.getChassis());</b>
<b class="nc">&nbsp;                        sub.setWeightClass(-1);</b>
<b class="nc">&nbsp;                        unit = sub.generate();</b>
<b class="nc">&nbsp;                        if (unit != null) {</b>
<b class="nc">&nbsp;                            sub.setUnit(unit);</b>
<b class="nc">&nbsp;                            if (useWeights) {</b>
<b class="nc">&nbsp;                                weights.remove(sub.getWeightClass());</b>
&nbsp;                            }
<b class="nc">&nbsp;                            foundUnit = true;</b>
&nbsp;                        }
<b class="nc">&nbsp;                    } else if (ut == UnitType.TANK &amp;&amp; Compute.d6(2) &gt;= target - 6) {</b>
<b class="nc">&nbsp;                        if (useWeights) {</b>
<b class="nc">&nbsp;                            switch (baseModel.getMechSummary().getUnitSubType()) {</b>
&nbsp;                                case &quot;Hover&quot;:
<b class="nc">&nbsp;                                    if (weights.contains(EntityWeightClass.WEIGHT_HEAVY)) {</b>
<b class="nc">&nbsp;                                        break;</b>
&nbsp;                                    }
&nbsp;                                    /* fall through */
&nbsp;                                case &quot;Wheeled&quot;:
<b class="nc">&nbsp;                                    if (weights.contains(EntityWeightClass.WEIGHT_ASSAULT)) {</b>
<b class="nc">&nbsp;                                        break;</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                    sub.getMovementModes().add(baseModel.getMovementMode());</b>
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                    } else if (ut == UnitType.INFANTRY) {</b>
<b class="nc">&nbsp;                        sub.getMovementModes().add(baseModel.getMovementMode());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (!foundUnit) {</b>
<b class="nc">&nbsp;                if (!weights.contains(sub.getWeightClass())) {</b>
<b class="nc">&nbsp;                    sub.setWeightClass(weights.get(0));</b>
&nbsp;                }
<b class="nc">&nbsp;                unit = sub.generate();</b>
<b class="nc">&nbsp;                if (unit == null) {</b>
<b class="nc">&nbsp;                    sub.getMovementModes().clear();</b>
<b class="nc">&nbsp;                    unit = sub.generate();</b>
&nbsp;                }
<b class="nc">&nbsp;                if (unit != null) {</b>
<b class="nc">&nbsp;                    sub.setUnit(unit);</b>
<b class="nc">&nbsp;                    if (useWeights) {</b>
<b class="nc">&nbsp;                        weights.remove(sub.getWeightClass());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (ut == null || ut == UnitType.MEK) {</b>
<b class="nc">&nbsp;                baseModel = null;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Assigns a specific model to this node of the force tree. If this is a leaf node it will be flagged
&nbsp;     * as an element. If it has child nodes, they will all be made up of the same model unless changed by
&nbsp;     * a rule at a lower level of organization.
&nbsp;     *
&nbsp;     * @param unit The unit to assign to this node.
&nbsp;     */
&nbsp;    public void setUnit(ModelRecord unit) {
<b class="nc">&nbsp;        chassis.clear();</b>
<b class="nc">&nbsp;        variants.clear();</b>
<b class="nc">&nbsp;        models.clear();</b>
<b class="nc">&nbsp;        models.add(unit.getKey());</b>
<b class="nc">&nbsp;        if (useWeightClass()) {</b>
<b class="nc">&nbsp;            weightClass = unit.getWeightClass();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (subforces.isEmpty()) {</b>
<b class="nc">&nbsp;            element = true;</b>
<b class="nc">&nbsp;            movementModes.clear();</b>
<b class="nc">&nbsp;            movementModes.add(unit.getMovementMode());</b>
<b class="nc">&nbsp;            if (null == unitType) {</b>
<b class="nc">&nbsp;                unitType = unit.getUnitType();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (((unitType == UnitType.MEK) || (unitType == UnitType.AERO)</b>
<b class="nc">&nbsp;                    || (unitType == UnitType.TANK))</b>
<b class="nc">&nbsp;                    &amp;&amp; unit.isOmni()) {</b>
<b class="nc">&nbsp;                flags.add(&quot;omni&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (unit.getRoles().contains(MissionRole.ARTILLERY)) {</b>
<b class="nc">&nbsp;                roles.add(MissionRole.ARTILLERY);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (unit.getRoles().contains(MissionRole.MISSILE_ARTILLERY)) {</b>
<b class="nc">&nbsp;                roles.add(MissionRole.MISSILE_ARTILLERY);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (unit.getRoles().contains(MissionRole.ANTI_MEK)) {</b>
<b class="nc">&nbsp;                roles.add(MissionRole.ANTI_MEK);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (unit.getRoles().contains(MissionRole.FIELD_GUN)) {</b>
<b class="nc">&nbsp;                roles.add(MissionRole.FIELD_GUN);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void generate(String level) {
<b class="nc">&nbsp;        ModelRecord mRec = generate();</b>
<b class="nc">&nbsp;        if (mRec != null) {</b>
<b class="nc">&nbsp;            if (level.equals(&quot;chassis&quot;)) {</b>
<b class="nc">&nbsp;                getChassis().add(mRec.getChassis());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                getModels().add(mRec.getKey());</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public ModelRecord generate() {
&nbsp;        /* If the criteria cannot be matched, first try the next closest weight class,
&nbsp;         * then ignore mission role, then the next weight class, then ignore motive types,
&nbsp;         * then remaining weight classes.
&nbsp;         */
<b class="nc">&nbsp;        final int[][] altWeights = {</b>
&nbsp;                {1, 2, 3, 4, 5}, //UL
&nbsp;                {2, 0, 3, 4, 5}, //L
&nbsp;                {3, 1, 4, 0, 5}, //M
&nbsp;                {2, 4, 1, 5, 0}, //H
&nbsp;                {3, 2, 5, 1, 0}, //A
&nbsp;                {4, 3, 2, 1, 0}  //SH
&nbsp;        };
&nbsp;        /* Work with a copy */
<b class="nc">&nbsp;        ForceDescriptor fd = createChild(index);</b>
<b class="nc">&nbsp;        fd.setEschelon(eschelon);</b>
<b class="nc">&nbsp;        fd.setCoRank(coRank);</b>
<b class="nc">&nbsp;        fd.getRoles().clear();</b>
<b class="nc">&nbsp;        fd.getRoles().addAll(roles.stream().filter(r -&gt; r.fitsUnitType(unitType)).collect(Collectors.toList()));</b>
&nbsp;
<b class="nc">&nbsp;        int wtIndex = (useWeightClass() &amp;&amp; weightClass != null &amp;&amp; weightClass != -1)?0:4;</b>
&nbsp;
<b class="nc">&nbsp;        while (wtIndex &lt; 5) {</b>
<b class="nc">&nbsp;            for (int roleStrictness = 3; roleStrictness &gt;= 0; roleStrictness--) {</b>
<b class="nc">&nbsp;                List&lt;Integer&gt; wcs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                if (useWeightClass() &amp;&amp; null != fd.getWeightClass() &amp;&amp; fd.getWeightClass() &gt;= 0) {</b>
<b class="nc">&nbsp;                    wcs.add(fd.getWeightClass());</b>
&nbsp;                }
<b class="nc">&nbsp;                String ratGenRating = ratGeneratorRating();</b>
<b class="nc">&nbsp;                UnitTable table = UnitTable.findTable(fd.getFactionRec(), fd.getUnitType(),</b>
<b class="nc">&nbsp;                        fd.getYear(), ratGenRating, wcs, ModelRecord.NETWORK_NONE,</b>
<b class="nc">&nbsp;                        fd.getMovementModes(), fd.getRoles(), roleStrictness);</b>
<b class="nc">&nbsp;                MechSummary ms = null;</b>
<b class="nc">&nbsp;                if (!fd.getModels().isEmpty()) {</b>
<b class="nc">&nbsp;                    ms = table.generateUnit(u -&gt; fd.getModels().contains(u.getName()));</b>
<b class="nc">&nbsp;                } else if (!fd.getChassis().isEmpty()) {</b>
<b class="nc">&nbsp;                    ms = table.generateUnit(u -&gt; fd.getChassis().contains(u.getChassis()));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    ms = table.generateUnit();</b>
&nbsp;                }
<b class="nc">&nbsp;                if (ms != null &amp;&amp; RATGenerator.getInstance().getModelRecord(ms.getName()) != null) {</b>
<b class="nc">&nbsp;                    return RATGenerator.getInstance().getModelRecord(ms.getName());</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if ((!useWeightClass() || wtIndex == 2) &amp;&amp; fd.getRoles().size() &gt; 0) {</b>
<b class="nc">&nbsp;                    fd.getRoles().clear();</b>
<b class="nc">&nbsp;                } else if ((!useWeightClass() || wtIndex == 1)</b>
<b class="nc">&nbsp;                        &amp;&amp; fd.getMovementModes().size() &gt; 0) {</b>
<b class="nc">&nbsp;                    fd.getMovementModes().clear();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    if (useWeightClass() &amp;&amp; null != weightClass &amp;&amp; weightClass != -1 &amp;&amp; weightClass &lt; altWeights.length &amp;&amp; wtIndex &lt; altWeights[weightClass].length) {</b>
<b class="nc">&nbsp;                        fd.setWeightClass(altWeights[weightClass][wtIndex]);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    wtIndex++;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        };
&nbsp;
<b class="nc">&nbsp;        MegaMek.getLogger().debug(&quot;Could not find unit for &quot; + UnitType.getTypeDisplayableName(unitType));</b>
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void loadEntities(Ruleset.ProgressListener l, double progress) {
<b class="nc">&nbsp;        if (element) {</b>
<b class="nc">&nbsp;            MechSummary ms = MechSummaryCache.getInstance().getMech(getModelName());</b>
<b class="nc">&nbsp;            if (ms != null) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    entity = new MechFileParser(ms.getSourceFile(), ms.getEntryName()).getEntity();</b>
<b class="nc">&nbsp;                    entity.setCrew(getCo().createCrew(entity.defaultCrewType()));</b>
<b class="nc">&nbsp;                    entity.setExternalIdAsString(UUID.randomUUID().toString());</b>
<b class="nc">&nbsp;                } catch (EntityLoadingException ex) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(&quot;Error loading &quot; + ms.getName() + &quot; from file &quot; + ms.getSourceFile().getPath(), ex);</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        int count = subforces.size() + attached.size();</b>
<b class="nc">&nbsp;        subforces.forEach(fd -&gt; fd.loadEntities(l, progress / count));</b>
<b class="nc">&nbsp;        attached.forEach(fd -&gt; fd.loadEntities(l, progress / count));</b>
<b class="nc">&nbsp;        if (count == 0 &amp;&amp; null != l) {</b>
<b class="nc">&nbsp;            l.updateProgress(progress, &quot;Loading entities&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void assignCommanders() {
<b class="nc">&nbsp;        subforces.forEach(ForceDescriptor::assignCommanders);</b>
&nbsp;
<b class="nc">&nbsp;        Ruleset rules = Ruleset.findRuleset(this);</b>
<b class="nc">&nbsp;        CommanderNode coNode = null;</b>
<b class="nc">&nbsp;        CommanderNode xoNode = null;</b>
&nbsp;
<b class="nc">&nbsp;        while (coNode == null &amp;&amp; rules != null) {</b>
<b class="nc">&nbsp;            coNode = rules.getCoNode(this);</b>
<b class="nc">&nbsp;            xoNode = rules.getXoNode(this);</b>
<b class="nc">&nbsp;            if (coNode == null) {</b>
<b class="nc">&nbsp;                if (rules.getParent() == null) {</b>
<b class="nc">&nbsp;                    setCo(new CrewDescriptor(this));</b>
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;                rules = Ruleset.findRuleset(rules.getParent());</b>
&nbsp;            }
&nbsp;        }
&nbsp;        //If none is found, assign crew without assigning rank or title.
<b class="nc">&nbsp;        if (coNode == null) {</b>
<b class="nc">&nbsp;            setCo(new CrewDescriptor(this));</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (subforces.size() &gt; 0) {</b>
<b class="nc">&nbsp;            int coPos = 0;</b>
<b class="nc">&nbsp;            if (coNode != null) {</b>
<b class="nc">&nbsp;                coPos = (coNode.getPosition() == null)?1:</b>
<b class="nc">&nbsp;                    Math.min(coNode.getPosition(), 1);</b>
&nbsp;            }
<b class="nc">&nbsp;            int xoPos = 0;</b>
<b class="nc">&nbsp;            if (xoNode != null &amp;&amp; (xoNode.getPosition() == null || xoNode.getPosition() &gt; 0)) {</b>
<b class="nc">&nbsp;                xoPos = (xoNode.getPosition() == null)?coPos + 1:</b>
<b class="nc">&nbsp;                    Math.max(coPos, xoNode.getPosition());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (coPos + xoPos &gt; 0) {</b>
<b class="nc">&nbsp;                ForceDescriptor [] forces = subforces.toArray(new ForceDescriptor[subforces.size()]);</b>
<b class="nc">&nbsp;                Arrays.sort(forces, forceSorter);</b>
<b class="nc">&nbsp;                if (coPos != 0) {</b>
<b class="nc">&nbsp;                    ForceDescriptor coFound = null;</b>
<b class="nc">&nbsp;                    if (coNode.getUnitType() != null) {</b>
<b class="nc">&nbsp;                        for (ForceDescriptor fd : forces) {</b>
<b class="nc">&nbsp;                            if (fd.getUnitType() != null &amp;&amp; fd.getUnitTypeName().equals(coNode.getUnitType())) {</b>
<b class="nc">&nbsp;                                coFound = fd;</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    if (coFound == null) {</b>
<b class="nc">&nbsp;                        coFound = forces[0];</b>
&nbsp;                    }
<b class="nc">&nbsp;                    setCo(coFound.getCo());</b>
<b class="nc">&nbsp;                    subforces.remove(coFound);</b>
<b class="nc">&nbsp;                    subforces.add(0, coFound);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (xoPos != 0) {</b>
&nbsp;                    /* If the XO is a field officer, the position is assigned to the first subforce that doesn&#39;t contain the CO
&nbsp;                     * (which is the first if the CO is not a field officer). If the CO and XO positions are the same, the
&nbsp;                     * XO is assigned to the same subforce as the CO, but the second subforce of that one.
&nbsp;                     */
<b class="nc">&nbsp;                    ForceDescriptor xoFound = null;</b>
<b class="nc">&nbsp;                    ArrayList&lt;ForceDescriptor&gt; subforces = this.subforces;</b>
<b class="nc">&nbsp;                    if (coPos == xoPos) {</b>
<b class="nc">&nbsp;                        subforces = this.subforces.get(0).getSubforces();</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (subforces.size() &gt; coPos) {</b>
<b class="nc">&nbsp;                        if (xoNode.getUnitType() != null) {</b>
<b class="nc">&nbsp;                            for (int i = coPos; i &lt; subforces.size(); i++) {</b>
<b class="nc">&nbsp;                                if (subforces.get(i).getUnitType() != null &amp;&amp;</b>
<b class="nc">&nbsp;                                        (xoNode.getUnitType().equals(subforces.get(i).getUnitTypeName())</b>
<b class="nc">&nbsp;                                                || (xoNode.getUnitType().equals(&quot;other&quot;)</b>
<b class="nc">&nbsp;                                                        &amp;&amp; !subforces.get(i).getUnitType().equals(co.getAssignment().getUnitType())))) {</b>
<b class="nc">&nbsp;                                    xoFound = subforces.get(i);</b>
<b class="nc">&nbsp;                                    break;</b>
&nbsp;                                }
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                        if (xoFound == null) {</b>
<b class="nc">&nbsp;                            xoFound = subforces.get(1);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    if (xoFound != null) {</b>
<b class="nc">&nbsp;                        setXo(xoFound.getCo());</b>
<b class="nc">&nbsp;                        getXo().setRank(xoNode.getRank());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (getCo() == null) {</b>
<b class="nc">&nbsp;            setCo(new CrewDescriptor(this));</b>
&nbsp;        }
<b class="nc">&nbsp;        getCo().setRank(coNode.getRank());</b>
<b class="nc">&nbsp;        getCo().setTitle(coNode.getTitle());</b>
&nbsp;
<b class="nc">&nbsp;        if (xoNode != null) {</b>
<b class="nc">&nbsp;            if (getXo() == null) {</b>
<b class="nc">&nbsp;                setXo(new CrewDescriptor(this));</b>
&nbsp;            }
<b class="nc">&nbsp;            getXo().setRank(xoNode.getRank());</b>
<b class="nc">&nbsp;            getXo().setTitle(xoNode.getTitle());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!element) {</b>
<b class="nc">&nbsp;            movementModes.clear();</b>
<b class="nc">&nbsp;            boolean isOmni = true;</b>
<b class="nc">&nbsp;            boolean isArtillery = true;</b>
<b class="nc">&nbsp;            boolean isMissileArtillery = true;</b>
<b class="nc">&nbsp;            boolean isFieldGun = true;</b>
<b class="nc">&nbsp;            for (ForceDescriptor fd : subforces) {</b>
<b class="nc">&nbsp;                movementModes.addAll(fd.getMovementModes());</b>
<b class="nc">&nbsp;                if ((fd.getUnitType() == null ||</b>
<b class="nc">&nbsp;                        !((UnitType.MEK == fd.getUnitType()) || (UnitType.AERO == fd.getUnitType())</b>
<b class="nc">&nbsp;                                || (UnitType.TANK == fd.getUnitType()))) ||</b>
<b class="nc">&nbsp;                        !fd.getFlags().contains(&quot;omni&quot;)) {</b>
<b class="nc">&nbsp;                    isOmni = false;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!fd.getRoles().contains(MissionRole.MISSILE_ARTILLERY)) {</b>
<b class="nc">&nbsp;                    isMissileArtillery = false;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!fd.getRoles().contains(MissionRole.ARTILLERY)</b>
<b class="nc">&nbsp;                        &amp;&amp; !fd.getRoles().contains(MissionRole.MISSILE_ARTILLERY)) {</b>
<b class="nc">&nbsp;                    isArtillery = false;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!fd.getRoles().contains(MissionRole.FIELD_GUN)) {</b>
<b class="nc">&nbsp;                    isFieldGun = false;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (isOmni) {</b>
<b class="nc">&nbsp;                flags.add(&quot;omni&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (isArtillery) {</b>
<b class="nc">&nbsp;                roles.add(MissionRole.ARTILLERY);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (isMissileArtillery) {</b>
<b class="nc">&nbsp;                roles.add(MissionRole.MISSILE_ARTILLERY);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (isFieldGun) {</b>
<b class="nc">&nbsp;                roles.add(MissionRole.FIELD_GUN);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            float wt = 0;</b>
<b class="nc">&nbsp;            int c = 0;</b>
<b class="nc">&nbsp;            for (ForceDescriptor sub : subforces) {</b>
<b class="nc">&nbsp;                if (sub.useWeightClass()) {</b>
<b class="nc">&nbsp;                    if (sub.getWeightClass() == null) {</b>
<b class="nc">&nbsp;                        MegaMek.getLogger().error(&quot;Weight class == null for &quot; </b>
<b class="nc">&nbsp;                                + sub.getUnitType() + &quot; with &quot; + sub.getSubforces().size() + &quot; subforces.&quot;);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        wt += sub.getWeightClass();</b>
<b class="nc">&nbsp;                        c++;</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (c &gt; 0) {</b>
<b class="nc">&nbsp;                weightClass = (int)(wt / c + 0.5);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        attached.forEach(ForceDescriptor::assignCommanders);</b>
&nbsp;
&nbsp;        //		setIcon();
&nbsp;    }
&nbsp;
&nbsp;    public void assignPositions() {
<b class="nc">&nbsp;        int index = 0;</b>
<b class="nc">&nbsp;        HashMap&lt;String,Integer&gt; uniqueCount = new HashMap&lt;String,Integer&gt;();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; subforces.size(); i++) {</b>
<b class="nc">&nbsp;            subforces.get(i).positionIndex = i + 1;</b>
<b class="nc">&nbsp;            if (subforces.get(i).name == null) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (subforces.get(i).name.contains(&quot;:distinct}&quot;)) {</b>
<b class="nc">&nbsp;                if (uniqueCount.containsKey(subforces.get(i).name)) {</b>
<b class="nc">&nbsp;                    uniqueCount.put(subforces.get(i).name, uniqueCount.get(subforces.get(i).name) + 1);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    uniqueCount.put(subforces.get(i).name, 1);</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (subforces.get(i).name.matches(&quot;.*\\{[^:]*\\}.*&quot;)) {</b>
<b class="nc">&nbsp;                subforces.get(i).nameIndex = index++;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        HashMap&lt;String,Integer&gt; indexCount = new HashMap&lt;String,Integer&gt;();</b>
<b class="nc">&nbsp;        for (ForceDescriptor sub : subforces) {</b>
<b class="nc">&nbsp;            if (uniqueCount.containsKey(sub.name)) {</b>
<b class="nc">&nbsp;                if (uniqueCount.get(sub.name) &gt; 1) {</b>
<b class="nc">&nbsp;                    if (indexCount.containsKey(sub.name)) {</b>
<b class="nc">&nbsp;                        indexCount.put(sub.name, indexCount.get(sub.name) + 1);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        indexCount.put(sub.name, 1);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    sub.nameIndex = indexCount.get(sub.name) - 1;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    sub.nameIndex = -1;</b>
&nbsp;                }
<b class="nc">&nbsp;                sub.name = sub.name.replace(&quot;:distinct&quot;, &quot;&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            sub.assignPositions();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        attached.forEach(ForceDescriptor::assignPositions);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private Comparator&lt;? super ForceDescriptor&gt; forceSorter = new Comparator&lt;ForceDescriptor&gt;() {</b>
&nbsp;        /* Rank by difference in experience + difference in unit/eschelon weights */
&nbsp;        private int rank(ForceDescriptor fd) {
<b class="nc">&nbsp;            int retVal = 0;</b>
<b class="nc">&nbsp;            if (fd.getWeightClass() != null) {</b>
<b class="nc">&nbsp;                retVal += fd.getWeightClass();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (fd.getUnitType() != null) {</b>
<b class="nc">&nbsp;                switch (fd.getUnitType()) {</b>
&nbsp;                    case UnitType.MEK:
<b class="nc">&nbsp;                        retVal += 2;</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case UnitType.INFANTRY:
<b class="nc">&nbsp;                        retVal -= 2;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (fd.getCo() != null) {</b>
<b class="nc">&nbsp;                retVal -= fd.getCo().getGunnery() + fd.getCo().getPiloting();</b>
<b class="nc">&nbsp;                ModelRecord mRec = RATGenerator.getInstance().getModelRecord(fd.getCo().getAssignment().getModelName());</b>
<b class="nc">&nbsp;                if (mRec != null) {</b>
<b class="nc">&nbsp;                    if (mRec.isSL()) {</b>
<b class="nc">&nbsp;                        retVal += 2;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (mRec.isClan()) {</b>
<b class="nc">&nbsp;                        retVal += 5;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return retVal;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int compare(ForceDescriptor arg0, ForceDescriptor arg1) {
<b class="nc">&nbsp;            if (arg0.getRoles().contains(MissionRole.COMMAND) &amp;&amp; !arg1.getRoles().contains(MissionRole.COMMAND)) {</b>
<b class="nc">&nbsp;                return -1;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!arg0.getRoles().contains(MissionRole.COMMAND) &amp;&amp; arg1.getRoles().contains(MissionRole.COMMAND)) {</b>
<b class="nc">&nbsp;                return 1;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (arg0.getRatingLevel() != arg1.getRatingLevel()) {</b>
<b class="nc">&nbsp;                return arg1.getRatingLevel() - arg0.getRatingLevel();</b>
&nbsp;            }
<b class="nc">&nbsp;            return rank(arg1) - rank(arg0);</b>
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    /**
&nbsp;     * Calculates transport needs of the unit and generates enough dropships and jumpships to carry
&nbsp;     * the indicated portion of the unit.
&nbsp;     */
&nbsp;    public ForceDescriptor assignTransport() {
<b class="nc">&nbsp;        if ((getDropshipPct() &lt;= 0) &amp;&amp; (getJumpshipPct() &lt;= 0) &amp;&amp; (getCargo() &lt;= 0)) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        TransportCalculator tp = new TransportCalculator(this);</b>
<b class="nc">&nbsp;        List&lt;MechSummary&gt; dropships = tp.calcDropships(getDropshipPct());</b>
<b class="nc">&nbsp;        ForceDescriptor transports = createChild(subforces.size() + attached.size());</b>
<b class="nc">&nbsp;        transports.setUnitType(null);</b>
<b class="nc">&nbsp;        transports.setName(&quot;Transport&quot;);</b>
&nbsp;        // TODO: put this in the faction files
<b class="nc">&nbsp;        transports.setEschelon(3);</b>
<b class="nc">&nbsp;        transports.setCoRank(35);</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;MechSummary&gt; shipList = tp.calcJumpships(getJumpshipPct(), dropships.size());</b>
<b class="nc">&nbsp;        shipList.addAll(dropships);</b>
<b class="nc">&nbsp;        for (MechSummary ms : shipList) {</b>
<b class="nc">&nbsp;            ForceDescriptor sub = transports.createChild(transports.getSubforces().size());</b>
<b class="nc">&nbsp;            sub.setUnit(RATGenerator.getInstance().getModelRecord(ms.getName()));</b>
<b class="nc">&nbsp;            sub.setEschelon(1);</b>
<b class="nc">&nbsp;            sub.setCoRank(34);</b>
<b class="nc">&nbsp;            transports.addSubforce(sub);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        transports.assignCommanders();</b>
<b class="nc">&nbsp;        transports.assignPositions();</b>
&nbsp;
<b class="nc">&nbsp;        return transports;</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;	public void assignBloodnames() {
&nbsp;		assignBloodnames(getFactionRec());
&nbsp;	}
&nbsp;
&nbsp;	public void assignBloodnames(FactionRecord fRec) {
&nbsp;		if (fRec != null &amp;&amp; fRec.isClan()) {
&nbsp;			for (ForceDescriptor fd : subforces) {
&nbsp;				fd.assignBloodnames();
&nbsp;			}
&nbsp;			for (ForceDescriptor fd : attached) {
&nbsp;				fd.assignBloodnames();
&nbsp;			}
&nbsp;
&nbsp;			if (co != null &amp;&amp; (element || !(co.getAssignment() != null &amp;&amp; co.getAssignment().isElement()))) {
&nbsp;				co.assignBloodname();
&nbsp;			}
&nbsp;			if (xo != null &amp;&amp; !(xo.getAssignment() != null &amp;&amp; xo.getAssignment().isElement())) {
&nbsp;				xo.assignBloodname();
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;     */
&nbsp;
&nbsp;    public static int decodeWeightClass(String code) {
<b class="nc">&nbsp;        switch (code) {</b>
<b class="nc">&nbsp;            case &quot;UL&quot;:return EntityWeightClass.WEIGHT_ULTRA_LIGHT;</b>
<b class="nc">&nbsp;            case &quot;L&quot;:return EntityWeightClass.WEIGHT_LIGHT;</b>
<b class="nc">&nbsp;            case &quot;M&quot;:return EntityWeightClass.WEIGHT_MEDIUM;</b>
<b class="nc">&nbsp;            case &quot;H&quot;:return EntityWeightClass.WEIGHT_HEAVY;</b>
<b class="nc">&nbsp;            case &quot;A&quot;:return EntityWeightClass.WEIGHT_ASSAULT;</b>
<b class="nc">&nbsp;            case &quot;SH&quot;:case &quot;C&quot;:return EntityWeightClass.WEIGHT_COLOSSAL;</b>
&nbsp;        }
<b class="nc">&nbsp;        return -1;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getWeightClassCode() {
<b class="nc">&nbsp;        final String[] codes = {&quot;UL&quot;, &quot;L&quot;, &quot;M&quot;, &quot;H&quot;, &quot;A&quot;, &quot;SH&quot;};</b>
<b class="nc">&nbsp;        if (weightClass == null || weightClass == -1) {</b>
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        return codes[weightClass];</b>
&nbsp;    }
&nbsp;    // AeroSpace Units
&nbsp;    public static final int WEIGHT_SMALL_CRAFT = 6; // Only a single weight class for Small Craft
&nbsp;    public static final int WEIGHT_SMALL_DROP = 7;
&nbsp;    public static final int WEIGHT_MEDIUM_DROP = 8;
&nbsp;    public static final int WEIGHT_LARGE_DROP = 9;
&nbsp;    public static final int WEIGHT_SMALL_WAR = 10;
&nbsp;    public static final int WEIGHT_LARGE_WAR = 11;
&nbsp;
&nbsp;    // Support Vehicles
&nbsp;    public static final int WEIGHT_SMALL_SUPPORT = 12;
&nbsp;    public static final int WEIGHT_MEDIUM_SUPPORT = 13;
&nbsp;    public static final int WEIGHT_LARGE_SUPPORT = 14;
&nbsp;
&nbsp;    public boolean useWeightClass() {
<b class="nc">&nbsp;        return useWeightClass(unitType);</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean useWeightClass(Integer ut) {
<b class="nc">&nbsp;        return ut != null &amp;&amp;</b>
<b class="nc">&nbsp;                !(roles.contains(MissionRole.ARTILLERY) || roles.contains(MissionRole.MISSILE_ARTILLERY)) &amp;&amp;</b>
<b class="nc">&nbsp;                (ut == UnitType.MEK ||</b>
<b class="nc">&nbsp;                ut == UnitType.AERO ||</b>
<b class="nc">&nbsp;                ut == UnitType.TANK ||</b>
<b class="nc">&nbsp;                ut == UnitType.BATTLE_ARMOR);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Weight class can differ from the target once units are generated. Weight class is recalculated
&nbsp;     * based on actual units present and eschelon name is set.
&nbsp;     *
&nbsp;     * @return The weight class of this force node
&nbsp;     */
&nbsp;    public double recalcWeightClass() {
&nbsp;        double wc;
<b class="nc">&nbsp;        if (subforces.size() &gt; 0) {</b>
<b class="nc">&nbsp;            wc = subforces.stream().mapToDouble(ForceDescriptor::recalcWeightClass)</b>
<b class="nc">&nbsp;                    .sum() / subforces.size();</b>
<b class="nc">&nbsp;        } else if (null != weightClass &amp;&amp; weightClass &gt;= 0) {</b>
<b class="nc">&nbsp;            wc = weightClass;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            wc = EntityWeightClass.WEIGHT_MEDIUM;</b>
&nbsp;        }
<b class="nc">&nbsp;        weightClass = (int)Math.round(wc);</b>
&nbsp;
&nbsp;        //Some names require knowing the weight class first.
<b class="nc">&nbsp;        if (null != nameNodes) {</b>
<b class="nc">&nbsp;            for (ValueNode n : nameNodes) {</b>
<b class="nc">&nbsp;                if (n.matches(this)) {</b>
<b class="nc">&nbsp;                    setName(n.getContent());</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        attached.forEach(ForceDescriptor::recalcWeightClass);</b>
&nbsp;
<b class="nc">&nbsp;        return wc;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ArrayList&lt;Object&gt; getAllChildren() {
<b class="nc">&nbsp;        ArrayList&lt;Object&gt; retVal = new ArrayList&lt;Object&gt;();</b>
<b class="nc">&nbsp;        retVal.addAll(subforces);</b>
<b class="nc">&nbsp;        retVal.addAll(attached);</b>
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getIndex() {
<b class="nc">&nbsp;        return index;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setIndex(int index) {
<b class="nc">&nbsp;        this.index = index;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getName() {
<b class="nc">&nbsp;        return name;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String parseName() {
<b class="nc">&nbsp;        String retVal = name;</b>
<b class="nc">&nbsp;        if (name == null) {</b>
<b class="nc">&nbsp;            String eschName = Ruleset.findRuleset(this).getEschelonName(this);</b>
<b class="nc">&nbsp;            if (eschName == null) {</b>
<b class="nc">&nbsp;                return &quot;&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            retVal = &quot;{ordinal} &quot; + eschName;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (getParent() != null &amp;&amp; getParent().getNameIndex() &gt;= 0) {</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{ordinal:parent}&quot;, ORDINALS[getParent().getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{greek:parent}&quot;, GREEK[getParent().getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{phonetic:parent}&quot;, PHONETIC[getParent().getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{latin:parent}&quot;, LATIN[getParent().getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{roman:parent}&quot;, ROMAN[getParent().getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{cardinal:parent}&quot;, Integer.toString(getParent().getNameIndex() + 1));</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{alpha:parent}&quot;, Character.toString((char)(getParent().getNameIndex() + &#39;A&#39;)));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (getParent() != null &amp;&amp; retVal.contains(&quot;{name:parent}&quot;)) {</b>
<b class="nc">&nbsp;            String parentName = getParent().getName().replaceAll(&quot;.*\\[&quot;, &quot;&quot;).replaceAll(&quot;\\].*&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{name:parent}&quot;, parentName);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (nameIndex &lt; 0) {</b>
<b class="nc">&nbsp;            retVal = retVal.replaceAll(&quot;\\{.*?\\}\\s?&quot;, &quot;&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{ordinal}&quot;, ORDINALS[getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{greek}&quot;, GREEK[getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{phonetic}&quot;, PHONETIC[getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{latin}&quot;, LATIN[getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{roman}&quot;, ROMAN[getNameIndex()]);</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{cardinal}&quot;, Integer.toString(getNameIndex() + 1));</b>
<b class="nc">&nbsp;            retVal = retVal.replace(&quot;{alpha}&quot;, Character.toString((char)(getNameIndex() + &#39;A&#39;)));</b>
<b class="nc">&nbsp;            if (retVal.contains(&quot;{formation}&quot;)) {</b>
<b class="nc">&nbsp;                if (null != formationType &amp;&amp; null != formationType.getCategory()) {</b>
<b class="nc">&nbsp;                    retVal = retVal.replace(&quot;{formation}&quot;, formationType.getCategory()</b>
<b class="nc">&nbsp;                            .replace(&quot;Striker/Cavalry&quot;, &quot;Striker&quot;).replaceAll(&quot; Squadron&quot;, &quot;&quot;));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    retVal = retVal.replace(&quot;{formation} &quot;, &quot;&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        retVal = retVal.replaceAll(&quot;\\{.*?\\}&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;        retVal = retVal.replaceAll(&quot;[\\[\\]]&quot;, &quot;&quot;).replaceAll(&quot;\\s+&quot;, &quot; &quot;);</b>
<b class="nc">&nbsp;        return retVal.trim();</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getDescription() {
<b class="nc">&nbsp;        StringBuilder retVal = new StringBuilder();</b>
<b class="nc">&nbsp;        if (unitType != null) {</b>
&nbsp;            //			if (useWeightClass() &amp;&amp; weightClass != null &amp;&amp; weightClass &gt;= 0) {
<b class="nc">&nbsp;            if (weightClass != null &amp;&amp; weightClass &gt;= 0) {</b>
<b class="nc">&nbsp;                retVal.append(EntityWeightClass.getClassName(weightClass)).append(&quot; &quot;);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (roles.contains(MissionRole.ARTILLERY) || roles.contains(MissionRole.MISSILE_ARTILLERY)) {</b>
<b class="nc">&nbsp;                retVal.append(getUnitTypeName().equals(&quot;Infantry&quot;)?&quot;Field&quot;:&quot;Mobile&quot;).append(&quot; &quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                retVal.append(UnitType.getTypeName(unitType)).append(&quot; &quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (roles.contains(MissionRole.RECON)) {</b>
<b class="nc">&nbsp;            retVal.append(&quot;Recon&quot;);</b>
<b class="nc">&nbsp;        } else if (roles.contains(MissionRole.FIRE_SUPPORT)) {</b>
<b class="nc">&nbsp;            retVal.append(&quot;Fire Support&quot;);</b>
<b class="nc">&nbsp;        } else if (roles.contains(MissionRole.ARTILLERY)) {</b>
<b class="nc">&nbsp;            retVal.append(&quot;Artillery&quot;);</b>
<b class="nc">&nbsp;        } else if (roles.contains(MissionRole.URBAN)) {</b>
<b class="nc">&nbsp;            retVal.append(&quot;Urban&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (flags.contains(&quot;c3&quot;)) {</b>
<b class="nc">&nbsp;            retVal.append(&quot; (C3)&quot;);</b>
<b class="nc">&nbsp;        } else if (flags.contains(&quot;c3i&quot;)) {</b>
<b class="nc">&nbsp;            retVal.append(&quot; (C3I)&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        Ruleset rules = Ruleset.findRuleset(this);</b>
<b class="nc">&nbsp;        String eschName = null;</b>
&nbsp;
<b class="nc">&nbsp;        while (eschName == null &amp;&amp; rules != null) {</b>
<b class="nc">&nbsp;            eschName = rules.getEschelonName(this);</b>
<b class="nc">&nbsp;            if (eschName == null) {</b>
<b class="nc">&nbsp;                if (rules.getParent() == null) {</b>
<b class="nc">&nbsp;                    rules = null;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    rules = Ruleset.findRuleset(rules.getParent());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (eschName != null) {</b>
<b class="nc">&nbsp;            retVal.append(&quot; &quot;).append(eschName);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (null != formationType) {</b>
<b class="nc">&nbsp;            retVal.append(&quot; (&quot;).append(formationType.getName()).append(&quot;)&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return retVal.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setName(String name) {
<b class="nc">&nbsp;        this.name = name;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getFaction() {
<b class="nc">&nbsp;        return faction;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setFaction(String faction) {
<b class="nc">&nbsp;        this.faction = faction;</b>
&nbsp;    }
&nbsp;
&nbsp;    public FactionRecord getFactionRec() {
<b class="nc">&nbsp;        return RATGenerator.getInstance().getFaction(faction.split(&quot;,&quot;)[0]);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer getYear() {
<b class="nc">&nbsp;        return year;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setYear(Integer year) {
<b class="nc">&nbsp;        this.year = year;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer getEschelon() {
<b class="nc">&nbsp;        return eschelon;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getEschelonCode() {
<b class="nc">&nbsp;        String retVal = eschelon.toString();</b>
<b class="nc">&nbsp;        if (augmented) {</b>
<b class="nc">&nbsp;            retVal += &quot;^&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setEschelon(Integer eschelon) {
<b class="nc">&nbsp;        this.eschelon = eschelon;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getSizeMod() {
<b class="nc">&nbsp;        return sizeMod;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setSizeMod(int sizeMod) {
<b class="nc">&nbsp;        this.sizeMod = sizeMod;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isAugmented() {
<b class="nc">&nbsp;        return augmented;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setAugmented(boolean augmented) {
<b class="nc">&nbsp;        this.augmented = augmented;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer getWeightClass() {
<b class="nc">&nbsp;        return weightClass;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setWeightClass(Integer weightClass) {
<b class="nc">&nbsp;        this.weightClass = weightClass;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer getUnitType() {
<b class="nc">&nbsp;        return unitType;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setUnitType(Integer unitType) {
<b class="nc">&nbsp;        this.unitType = unitType;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getUnitTypeName() {
<b class="nc">&nbsp;        if (null != unitType) {</b>
<b class="nc">&nbsp;            return UnitType.getTypeDisplayableName(unitType);</b>
&nbsp;        }
<b class="nc">&nbsp;        return &quot;&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public HashSet&lt;EntityMovementMode&gt; getMovementModes() {
<b class="nc">&nbsp;        return movementModes;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getRating() {
<b class="nc">&nbsp;        return rating;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setRating(String rating) {
<b class="nc">&nbsp;        this.rating = rating;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Translates between the rating codes used by the force generator and those used by the
&nbsp;     * RAT Generator. The force generator uses abbreviations to make the formation rules more
&nbsp;     * concise.
&nbsp;     *
&nbsp;     * @return The RATGenerator rating code corresponding to the same index as the force generator
&nbsp;     *         rating code.
&nbsp;     */
&nbsp;    public String ratGeneratorRating() {
<b class="nc">&nbsp;        FactionRecord fRec = getFactionRec();</b>
<b class="nc">&nbsp;        if ((null != fRec)</b>
<b class="nc">&nbsp;                &amp;&amp; !fRec.getRatingLevels().contains(rating)</b>
<b class="nc">&nbsp;                &amp;&amp; (getRatingLevel() &gt;= 0)</b>
<b class="nc">&nbsp;                &amp;&amp; !fRec.getRatingLevels().isEmpty()) {</b>
<b class="nc">&nbsp;            return fRec.getRatingLevels().get(Math.min(getRatingLevel(), fRec.getRatingLevels().size() - 1));</b>
&nbsp;        }
<b class="nc">&nbsp;        return rating;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getRatingLevel() {
<b class="nc">&nbsp;        if (rating != null) {</b>
<b class="nc">&nbsp;            Ruleset rs = Ruleset.findRuleset(this);</b>
<b class="nc">&nbsp;            if (rs != null) {</b>
<b class="nc">&nbsp;                return rs.getRatingIndex(rating);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return -1;</b>
&nbsp;    }
&nbsp;
&nbsp;    public FormationType getFormation() {
<b class="nc">&nbsp;        return formationType;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setFormationType(FormationType ft) {
<b class="nc">&nbsp;        formationType = ft;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getGenerationRule() {
<b class="nc">&nbsp;        return generationRule;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setGenerationRule(String rule) {
<b class="nc">&nbsp;        generationRule = rule;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Set&lt;MissionRole&gt; getRoles() {
<b class="nc">&nbsp;        return roles;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Set&lt;String&gt; getModels() {
<b class="nc">&nbsp;        return models;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getModelName() {
<b class="nc">&nbsp;        if (models.size() != 1) {</b>
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        return models.iterator().next();</b>
&nbsp;    }
&nbsp;
&nbsp;    public Set&lt;String&gt; getChassis() {
<b class="nc">&nbsp;        return chassis;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Set&lt;String&gt; getVariants() {
<b class="nc">&nbsp;        return variants;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer getExperience() {
<b class="nc">&nbsp;        return experience;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setExperience(Integer experience) {
<b class="nc">&nbsp;        this.experience = experience;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer getCoRank() {
<b class="nc">&nbsp;        return coRank;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setCoRank(Integer coRank) {
<b class="nc">&nbsp;        this.coRank = coRank;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer getRankSystem() {
<b class="nc">&nbsp;        return rankSystem;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setRankSystem(Integer rankSystem) {
<b class="nc">&nbsp;        this.rankSystem = rankSystem;</b>
&nbsp;    }
&nbsp;
&nbsp;    public CrewDescriptor getCo() {
<b class="nc">&nbsp;        return co;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setCo(CrewDescriptor co) {
<b class="nc">&nbsp;        this.co = co;</b>
&nbsp;    }
&nbsp;
&nbsp;    public CrewDescriptor getXo() {
<b class="nc">&nbsp;        return xo;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setXo(CrewDescriptor xo) {
<b class="nc">&nbsp;        this.xo = xo;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getCamo() {
<b class="nc">&nbsp;        return camo;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setCamo(String camo) {
<b class="nc">&nbsp;        this.camo = camo;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Because some eschelon names depend on knowing the actual weight class, we save a copy
&nbsp;     * of the possibilities for this node and defer selection until after the final weight class
&nbsp;     * determination.
&nbsp;     *
&nbsp;     * @param nameNodes
&nbsp;     */
&nbsp;    public void setNameNodes(List&lt;ValueNode&gt; nameNodes) {
<b class="nc">&nbsp;        this.nameNodes = nameNodes;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ForceDescriptor getParent() {
<b class="nc">&nbsp;        return parent;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setParent(ForceDescriptor parent) {
<b class="nc">&nbsp;        this.parent = parent;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean shouldGenerateAttachments() {
<b class="nc">&nbsp;        return generateAttachments;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setAttachments(boolean attachments) {
<b class="nc">&nbsp;        generateAttachments = attachments;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ArrayList&lt;ForceDescriptor&gt; getSubforces() {
<b class="nc">&nbsp;        return subforces;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setSubforces(ArrayList&lt;ForceDescriptor&gt; subforces) {
<b class="nc">&nbsp;        this.subforces = subforces;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void addSubforce(ForceDescriptor fd) {
<b class="nc">&nbsp;        subforces.add(fd);</b>
<b class="nc">&nbsp;        fd.setParent(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ArrayList&lt;ForceDescriptor&gt; getAttached() {
<b class="nc">&nbsp;        return attached;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setAttached(ArrayList&lt;ForceDescriptor&gt; attached) {
<b class="nc">&nbsp;        this.attached = attached;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void addAttached(ForceDescriptor fd) {
<b class="nc">&nbsp;        attached.add(fd);</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getDropshipPct() {
<b class="nc">&nbsp;        return dropshipPct;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setDropshipPct(double dropshipPct) {
<b class="nc">&nbsp;        this.dropshipPct = dropshipPct;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getJumpshipPct() {
<b class="nc">&nbsp;        return jumpshipPct;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setJumpshipPct(double jumpshipPct) {
<b class="nc">&nbsp;        this.jumpshipPct = jumpshipPct;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getCargo() {
<b class="nc">&nbsp;        return cargo;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setCargo(double cargo) {
<b class="nc">&nbsp;        this.cargo = cargo;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Set&lt;String&gt; getFlags() {
<b class="nc">&nbsp;        return flags;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isTopLevel() {
<b class="nc">&nbsp;        return topLevel;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setTopLevel(boolean topLevel) {
<b class="nc">&nbsp;        this.topLevel = topLevel;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isElement() {
<b class="nc">&nbsp;        return element;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setElement(boolean element) {
<b class="nc">&nbsp;        this.element = element;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getPositionIndex() {
<b class="nc">&nbsp;        return positionIndex;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getNameIndex() {
<b class="nc">&nbsp;        return nameIndex;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getFluffName() {
<b class="nc">&nbsp;        return fluffName;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setFluffName(String fluffName) {
<b class="nc">&nbsp;        this.fluffName = fluffName;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Entity getEntity() {
<b class="nc">&nbsp;        return entity;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void addAllEntities(List&lt;Entity&gt; list) {
<b class="nc">&nbsp;        if (isElement()) {</b>
<b class="nc">&nbsp;            if (entity != null) {</b>
<b class="nc">&nbsp;                list.add(entity);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        subforces.stream().forEach(sf -&gt; sf.addAllEntities(list));</b>
<b class="nc">&nbsp;        attached.stream().forEach(sf -&gt; sf.addAllEntities(list));</b>
&nbsp;    }
&nbsp;
&nbsp;    public ForceDescriptor createChild(int index) {
<b class="nc">&nbsp;        ForceDescriptor retVal = new ForceDescriptor();</b>
<b class="nc">&nbsp;        retVal.index = index;</b>
<b class="nc">&nbsp;        retVal.name = null;</b>
<b class="nc">&nbsp;        retVal.faction = faction;</b>
<b class="nc">&nbsp;        retVal.year = year;</b>
<b class="nc">&nbsp;        retVal.weightClass = weightClass;</b>
<b class="nc">&nbsp;        retVal.unitType = unitType;</b>
<b class="nc">&nbsp;        retVal.movementModes.addAll(movementModes);</b>
<b class="nc">&nbsp;        retVal.roles.addAll(roles);</b>
<b class="nc">&nbsp;        retVal.roles.remove(MissionRole.COMMAND);</b>
<b class="nc">&nbsp;        retVal.models.addAll(models);</b>
<b class="nc">&nbsp;        retVal.chassis.addAll(chassis);</b>
<b class="nc">&nbsp;        retVal.variants.addAll(variants);</b>
<b class="nc">&nbsp;        retVal.augmented = augmented;</b>
<b class="nc">&nbsp;        retVal.rating = rating;</b>
<b class="nc">&nbsp;        retVal.experience = experience;</b>
<b class="nc">&nbsp;        retVal.camo = camo;</b>
<b class="nc">&nbsp;        retVal.flags.addAll(flags);</b>
<b class="nc">&nbsp;        retVal.topLevel = false;</b>
<b class="nc">&nbsp;        retVal.rankSystem = rankSystem;</b>
<b class="nc">&nbsp;        retVal.generateAttachments = generateAttachments;</b>
&nbsp;
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Intended for debugging output. Shows description of current eschelon and all subforces
&nbsp;     *
&nbsp;     * @param indent   Prefix for the current eschelon
&nbsp;     * @param logLevel The level to pass to the logging utility
&nbsp;     */
&nbsp;    public void show(String indent, LogLevel logLevel) {
<b class="nc">&nbsp;        final String[] eschelonNames = {</b>
&nbsp;                &quot;Element&quot;, &quot;Squad&quot;, &quot;(2)&quot;, &quot;Lance&quot;, &quot;Company&quot;, &quot;Battalion&quot;,
&nbsp;                &quot;Regiment&quot;, &quot;Brigade&quot;, &quot;Division&quot;, &quot;Corps&quot;, &quot;Army&quot;
&nbsp;        };
<b class="nc">&nbsp;        final String[] airEschelonNames = {</b>
&nbsp;                &quot;Element&quot;, &quot;(1)&quot;, &quot;(2)&quot;, &quot;Flight&quot;, &quot;Squadron&quot;, &quot;Group&quot;, &quot;Wing&quot;, &quot;Regiment&quot;
&nbsp;        };
&nbsp;
<b class="nc">&nbsp;        MegaMek.getLogger().log(logLevel, indent + weightClass + &quot; &quot; + unitType + &quot; &quot;</b>
<b class="nc">&nbsp;                        + (((unitType == UnitType.AERO) || (unitType == UnitType.CONV_FIGHTER)) ? airEschelonNames[eschelon] : eschelonNames[eschelon]), null);</b>
<b class="nc">&nbsp;        for (ForceDescriptor sub : subforces) {</b>
<b class="nc">&nbsp;            sub.show(indent + &quot;  &quot;, logLevel);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        for (ForceDescriptor sub : attached) {</b>
<b class="nc">&nbsp;            sub.show(indent + &quot; +&quot;, logLevel);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
