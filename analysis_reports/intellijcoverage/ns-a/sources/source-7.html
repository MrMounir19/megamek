


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > FactionRecord</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ratgenerator</a>
</div>

<h1>Coverage Summary for Class: FactionRecord (megamek.client.ratgenerator)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">FactionRecord</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/392)
  </span>
</td>
</tr>
  <tr>
    <td class="name">FactionRecord$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FactionRecord$DateRange</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FactionRecord$TechCategory</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/414)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; *  MegaMek - Copyright (C) 2005 Ben Mazur (bmazur@sev.org)
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;package megamek.client.ratgenerator;
&nbsp;
&nbsp;import java.io.PrintWriter;
&nbsp;import java.text.ParseException;
&nbsp;import java.util.*;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import org.w3c.dom.Node;
&nbsp;import org.apache.commons.text.StringEscapeUtils;
&nbsp;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.common.UnitType;
&nbsp;
&nbsp;/**
&nbsp; * Stores data about factions used for building RATs, including
&nbsp; * parent factions, factions to salvage from, and percentages of
&nbsp; * Omni/SL/Clan tech. Keys are compatible with those used by MekHQ,
&nbsp; * with various subcommands indicated by a period and an additional
&nbsp; * key (e.g. DC.SL for Draconis Combine/Sword of Light).
&nbsp; *
&nbsp; * @author Neoancient
&nbsp; */
&nbsp;public class FactionRecord {
&nbsp;    /**
&nbsp;     * Proportions of omni/Clan/upgraded tech are given for each faction
&nbsp;     * by the field manual series.
&nbsp;     */
<b class="nc">&nbsp;    public enum TechCategory {</b>
<b class="nc">&nbsp;        OMNI, CLAN, IS_ADVANCED, // Used for Meks, and also used for ASFs or vees if no other value is present.</b>
<b class="nc">&nbsp;        OMNI_AERO, CLAN_AERO, IS_ADVANCED_AERO,</b>
<b class="nc">&nbsp;        CLAN_VEE, IS_ADVANCED_VEE;</b>
&nbsp;        /* omni vees do not see the widespread use of Meks and ASFs and do not get
&nbsp;         * a separate percentage value
&nbsp;         */
&nbsp;
&nbsp;        /**
&nbsp;         * If no value is provided for ASFs or Vees, use the base value.
&nbsp;         * @return The base category if the desired one has no value, or null if this is the base.
&nbsp;         */
&nbsp;        TechCategory fallthrough() {
<b class="nc">&nbsp;            switch (this) {</b>
&nbsp;            case OMNI_AERO:
<b class="nc">&nbsp;                return OMNI;</b>
&nbsp;            case CLAN_AERO:
&nbsp;            case CLAN_VEE:
<b class="nc">&nbsp;                return CLAN;</b>
&nbsp;            case IS_ADVANCED_AERO:
&nbsp;            case IS_ADVANCED_VEE:
<b class="nc">&nbsp;                return IS_ADVANCED;</b>
&nbsp;            default:
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String key;
&nbsp;    private boolean minor;
&nbsp;    private boolean clan;
&nbsp;    private boolean periphery;
&nbsp;    private String name;
&nbsp;    private TreeMap&lt;Integer, String&gt; altNames;
&nbsp;    private ArrayList&lt;DateRange&gt; yearsActive;
&nbsp;    private ArrayList&lt;String&gt; ratingLevels;
&nbsp;    private HashMap&lt;Integer, Integer&gt; pctSalvage;
&nbsp;    private HashMap&lt;TechCategory, HashMap&lt;Integer, ArrayList&lt;Integer&gt;&gt;&gt; pctTech;
&nbsp;    private HashMap&lt;Integer, HashMap&lt;String, Integer&gt;&gt; salvage;
&nbsp;    /*
&nbsp;     * FM:Updates gives percentage values for omni, Clan, and SL tech. Later manuals are
&nbsp;     * less precise, giving omni percentages for Clans and (in FM:3085) upgrade percentage
&nbsp;     * for IS and Periphery factions. In order to use the values that are available without
&nbsp;     * either forcing conformity to guesses for later eras or suddenly removing constraints,
&nbsp;     * we extrapolate some values but provide a margin of conformity that grows as we
&nbsp;     * get farther from known values. upgradeMargin applies the percentage of units that
&nbsp;     * are late-SW IS tech. techMargin applies to both Clan and advanced (SL and post-Clan) tech.
&nbsp;     */
&nbsp;    private HashMap&lt;Integer, Integer&gt; omniMargin;
&nbsp;    private HashMap&lt;Integer, Integer&gt; techMargin;
&nbsp;    private HashMap&lt;Integer, Integer&gt; upgradeMargin;
&nbsp;
&nbsp;    private HashMap&lt;Integer, HashMap&lt;Integer,ArrayList&lt;Integer&gt;&gt;&gt; weightDistribution;
&nbsp;    private ArrayList&lt;String&gt; parentFactions;
&nbsp;
&nbsp;    public FactionRecord() {
<b class="nc">&nbsp;        this(&quot;Periphery&quot;, &quot;Periphery&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    public FactionRecord(String key) {
<b class="nc">&nbsp;        this(key, key);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public FactionRecord(String key, String name) {</b>
<b class="nc">&nbsp;        this.key = key;</b>
<b class="nc">&nbsp;        this.name = name;</b>
<b class="nc">&nbsp;        minor = clan = periphery = false;</b>
<b class="nc">&nbsp;        ratingLevels = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        altNames = new TreeMap&lt;&gt;();</b>
<b class="nc">&nbsp;        yearsActive = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        pctSalvage = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        pctTech = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        omniMargin = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        upgradeMargin = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        techMargin = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        salvage = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        weightDistribution = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        parentFactions = new ArrayList&lt;&gt;();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int hashCode() {
<b class="nc">&nbsp;        return key.hashCode();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean equals(Object other) {
<b class="nc">&nbsp;        return other instanceof FactionRecord</b>
<b class="nc">&nbsp;                &amp;&amp; ((FactionRecord)other).getKey().equals(getKey());</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getKey() {
<b class="nc">&nbsp;        return key;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isMinor() {
<b class="nc">&nbsp;        return minor;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setMinor(boolean minor) {
<b class="nc">&nbsp;        this.minor = minor;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isClan() {
<b class="nc">&nbsp;        return clan;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setClan(boolean clan) {
<b class="nc">&nbsp;        this.clan = clan;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isPeriphery() {
<b class="nc">&nbsp;        return periphery;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setPeriphery(boolean periphery) {
<b class="nc">&nbsp;        this.periphery = periphery;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *
&nbsp;     * @return value of ratingLevels
&nbsp;     */
&nbsp;    public ArrayList&lt;String&gt; getRatingLevels() {
<b class="nc">&nbsp;        return ratingLevels;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks the faction parent hierarchy as necessary to find a set of ratings with at
&nbsp;     * least two values. If ratingLevels is empty, this faction inherits the parent&#39;s system.
&nbsp;     * If ratingLevels has one member, it indicates a set value for this faction within
&nbsp;     * the parent faction&#39;s system.
&nbsp;     *
&nbsp;     * @return The list of available equipment ratings for the faction.
&nbsp;     */
&nbsp;
&nbsp;    public ArrayList&lt;String&gt; getRatingLevelSystem() {
<b class="nc">&nbsp;        if (ratingLevels.size() &lt; 2) {</b>
<b class="nc">&nbsp;            for (String parent : parentFactions) {</b>
<b class="nc">&nbsp;                FactionRecord fr = RATGenerator.getInstance().getFaction(parent);</b>
<b class="nc">&nbsp;                if (fr != null) {</b>
<b class="nc">&nbsp;                    ArrayList&lt;String&gt; retVal = fr.getRatingLevelSystem();</b>
<b class="nc">&nbsp;                    if (retVal.size() &gt; 1 &amp;&amp;</b>
<b class="nc">&nbsp;                            (ratingLevels.isEmpty() || retVal.contains(ratingLevels.get(0)))) {</b>
<b class="nc">&nbsp;                        return retVal;</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        return ratingLevels;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getName() {
<b class="nc">&nbsp;        return name;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getName(int year) {
<b class="nc">&nbsp;        String retVal = name;</b>
<b class="nc">&nbsp;        for (Integer y : altNames.keySet()) {</b>
<b class="nc">&nbsp;            if (y &lt;= year) {</b>
<b class="nc">&nbsp;                retVal = altNames.get(y);</b>
&nbsp;            } else {
&nbsp;                break;
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setName(String name) {
<b class="nc">&nbsp;        this.name = name;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setName(int era, String name) {
<b class="nc">&nbsp;        altNames.put(era, name);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setNames(String names) {
<b class="nc">&nbsp;        String[] fields = names.split(&quot;,&quot;);</b>
<b class="nc">&nbsp;        name = fields[0];</b>
<b class="nc">&nbsp;        altNames.clear();</b>
<b class="nc">&nbsp;        for (int i = 1; i &lt; fields.length; i++) {</b>
<b class="nc">&nbsp;            String[] entry = fields[i].split(&quot;:&quot;);</b>
<b class="nc">&nbsp;            altNames.put(Integer.parseInt(entry[0]), entry[1]);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Check for whether the faction is active in a given year
&nbsp;     *
&nbsp;     * @param year The year to check
&nbsp;     * @return     Whether the faction is active
&nbsp;     * @see #isInEra(int)
&nbsp;     */
&nbsp;    public boolean isActiveInYear(int year) {
<b class="nc">&nbsp;        for (DateRange dr : yearsActive) {</b>
<b class="nc">&nbsp;            if (dr.isInRange(year)) {</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets one or more ranges of years the faction is active.
&nbsp;     * @param str The range of years the faction is active. The format is YYYY-YYYY. Either the start
&nbsp;     *            or end year (or both) can be omitted to make the range open at that end. Factions that
&nbsp;     *            vanish and reappear can provide multiple ranges separated by a comma.
&nbsp;     * @throws ParseException If the date range format is invalid
&nbsp;     */
&nbsp;    public void setYears(String str) throws ParseException {
<b class="nc">&nbsp;        yearsActive.clear();</b>
<b class="nc">&nbsp;        String[] ranges = str.split(&quot;,&quot;);</b>
<b class="nc">&nbsp;        int offset = 0;</b>
&nbsp;        try {
<b class="nc">&nbsp;            for (String range : ranges) {</b>
<b class="nc">&nbsp;                if (range.equals(&quot;-&quot;)) {</b>
<b class="nc">&nbsp;                    yearsActive.add(new DateRange(null, null));</b>
<b class="nc">&nbsp;                } else if (range.startsWith(&quot;-&quot;)) {</b>
<b class="nc">&nbsp;                    yearsActive.add(new DateRange(null, Integer.parseInt(range.substring(1))));</b>
<b class="nc">&nbsp;                } else if (range.endsWith(&quot;-&quot;)) {</b>
<b class="nc">&nbsp;                    yearsActive.add(new DateRange(Integer.parseInt(range.substring(0, range.length() - 1)), null));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    String[] termini = range.split(&quot;-&quot;);</b>
<b class="nc">&nbsp;                    if (termini.length == 2) {</b>
<b class="nc">&nbsp;                        yearsActive.add(new DateRange(Integer.parseInt(termini[0]),</b>
<b class="nc">&nbsp;                                Integer.parseInt(termini[1])));</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                offset += range.length();</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (Exception ex) {</b>
<b class="nc">&nbsp;            throw new ParseException(&quot;Could not parse year ranges for faction &quot; + key, offset);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer getPctSalvage(int era) {
<b class="nc">&nbsp;        return pctSalvage.get(era);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setPctSalvage(int era, Integer pct) {
<b class="nc">&nbsp;        pctSalvage.put(era, pct);</b>
&nbsp;    }
&nbsp;
&nbsp;    public HashMap&lt;String, Integer&gt; getSalvage(int era) {
<b class="nc">&nbsp;        if (salvage.containsKey(era) &amp;&amp; salvage.get(era).size() &gt; 0) {</b>
<b class="nc">&nbsp;            return salvage.get(era);</b>
&nbsp;        }
<b class="nc">&nbsp;        HashMap&lt;String,Integer&gt; retVal = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        if (parentFactions.size() &gt; 0) {</b>
<b class="nc">&nbsp;            for (String pKey : parentFactions) {</b>
<b class="nc">&nbsp;                FactionRecord fRec = RATGenerator.getInstance().getFaction(pKey);</b>
<b class="nc">&nbsp;                if (fRec != null) {</b>
<b class="nc">&nbsp;                    for (String fKey : fRec.getSalvage(era).keySet()) {</b>
<b class="nc">&nbsp;                        retVal.merge(fKey, fRec.getSalvage(era).get(fKey), Integer::sum);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    MegaMek.getLogger().debug(&quot;RATGenerator: could not locate salvage faction &quot; + pKey</b>
&nbsp;                            + &quot; for &quot; + key);
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        salvage.put(era, retVal);</b>
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setSalvage(int era, String faction, Integer wt) {
<b class="nc">&nbsp;        salvage.get(era).put(faction, wt);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void removeSalvage(int era, String faction) {
<b class="nc">&nbsp;        salvage.get(era).remove(faction);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer getPctTech(TechCategory category, int era, int rating) {
<b class="nc">&nbsp;        if (!pctTech.containsKey(category) || !pctTech.get(category).containsKey(era)</b>
<b class="nc">&nbsp;                || pctTech.get(category).get(era).isEmpty()</b>
<b class="nc">&nbsp;                || pctTech.get(category).get(era).size() &lt;= rating) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        return pctTech.get(category).get(era).get(rating);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Integer findPctTech(TechCategory category, int era, int rating) {
<b class="nc">&nbsp;        Integer retVal = getPctTech(category, era, rating);</b>
<b class="nc">&nbsp;        if (retVal != null) {</b>
<b class="nc">&nbsp;            return retVal;</b>
&nbsp;        }
<b class="nc">&nbsp;        retVal = getPctTech(category.fallthrough(), era, rating);</b>
<b class="nc">&nbsp;        if (retVal != null) {</b>
<b class="nc">&nbsp;            return retVal;</b>
&nbsp;        }
<b class="nc">&nbsp;        int total = 0;</b>
<b class="nc">&nbsp;        int count = 0;</b>
<b class="nc">&nbsp;        for (String parent : parentFactions) {</b>
<b class="nc">&nbsp;            FactionRecord pfr = RATGenerator.getInstance().getFaction(parent);</b>
<b class="nc">&nbsp;            if (pfr != null) {</b>
<b class="nc">&nbsp;                Integer pct = pfr.findPctTech(category, era, rating);</b>
<b class="nc">&nbsp;                if (pct != null) {</b>
<b class="nc">&nbsp;                    total += pct;</b>
<b class="nc">&nbsp;                    count++;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (count &gt; 0) {</b>
<b class="nc">&nbsp;            return (int)((total / count + 0.5));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void setRatings(String str) {
<b class="nc">&nbsp;        ratingLevels.clear();</b>
<b class="nc">&nbsp;        if (str.length() &gt; 0) {</b>
<b class="nc">&nbsp;            String[] fields = str.split(&quot;,&quot;);</b>
<b class="nc">&nbsp;            Collections.addAll(ratingLevels, fields);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the target percentage for a tech category.
&nbsp;     * 
&nbsp;     * @param category The category (omni, clan, SL/upgraded)
&nbsp;     * @param era      The year for which to set the tech percentage
&nbsp;     * @param str      A comma-separated list of percentages from the highest unit rating to the lowest.
&nbsp;     */
&nbsp;    public void setPctTech(TechCategory category, int era, String str) {
<b class="nc">&nbsp;        if (!pctTech.containsKey(category)) {</b>
<b class="nc">&nbsp;            pctTech.put(category, new HashMap&lt;&gt;());</b>
&nbsp;        }
<b class="nc">&nbsp;        ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        if (str != null &amp;&amp; str.length() &gt; 0) {</b>
<b class="nc">&nbsp;            for (String pct : str.split(&quot;,&quot;)) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    list.add(Integer.parseInt(pct));</b>
<b class="nc">&nbsp;                } catch (NumberFormatException ex) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(&quot;While loading faction data for &quot; + key);</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        pctTech.get(category).put(era, list);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the target percentage for a tech category for a particular rating.
&nbsp;     *
&nbsp;     * @param category The category (omni, clan, SL/upgraded)
&nbsp;     * @param era      The year for which to set the tech percentage
&nbsp;     * @param rating   The unit rating for which to set the tech percentage
&nbsp;     * @param pct      The percentage of the force that should match the given tech category
&nbsp;     */
&nbsp;    public void setPctTech(TechCategory category, int era, int rating, int pct) {
<b class="nc">&nbsp;        pctTech.putIfAbsent(category, new HashMap&lt;&gt;());</b>
<b class="nc">&nbsp;        pctTech.get(category).putIfAbsent(era, new ArrayList&lt;&gt;());</b>
<b class="nc">&nbsp;        while (pctTech.get(category).get(era).size() &lt;= rating) {</b>
<b class="nc">&nbsp;            pctTech.get(category).get(era).add(0);</b>
&nbsp;        }
<b class="nc">&nbsp;        pctTech.get(category).get(era).set(rating, pct);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    public int getOmniMargin(int era) {
<b class="nc">&nbsp;        if (omniMargin.containsKey(era)) {</b>
<b class="nc">&nbsp;            return omniMargin.get(era);</b>
&nbsp;        }
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getTechMargin(int era) {
<b class="nc">&nbsp;        if (techMargin.containsKey(era)) {</b>
<b class="nc">&nbsp;            return techMargin.get(era);</b>
&nbsp;        }
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getUpgradeMargin(int era) {
<b class="nc">&nbsp;        if (upgradeMargin.containsKey(era)) {</b>
<b class="nc">&nbsp;            return upgradeMargin.get(era);</b>
&nbsp;        }
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ArrayList&lt;Integer&gt; getWeightDistribution(int era, int unitType) {
<b class="nc">&nbsp;        if (weightDistribution.containsKey(era)</b>
<b class="nc">&nbsp;                &amp;&amp; weightDistribution.get(era).containsKey(unitType)) {</b>
<b class="nc">&nbsp;            return weightDistribution.get(era).get(unitType);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (parentFactions.size() &gt; 0) {</b>
<b class="nc">&nbsp;            ArrayList&lt;Integer&gt; retVal = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (String fKey : parentFactions) {</b>
<b class="nc">&nbsp;                FactionRecord fRec = RATGenerator.getInstance().getFaction(fKey);</b>
<b class="nc">&nbsp;                if (fRec != null) {</b>
<b class="nc">&nbsp;                    ArrayList&lt;Integer&gt; wd = fRec.getWeightDistribution(era, unitType);</b>
<b class="nc">&nbsp;                    if (wd != null) {</b>
<b class="nc">&nbsp;                        if (retVal.size() == 0) {</b>
<b class="nc">&nbsp;                            retVal.addAll(wd);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            for (int i = 0; i &lt; retVal.size(); i++) {</b>
<b class="nc">&nbsp;                                retVal.set(i, retVal.get(i) + wd.get(i));</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            return retVal;</b>
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setWeightDistribution(int era, int unitType, String dist) {
&nbsp;        // If the distribution parameter is null, clear the record if it exists.
<b class="nc">&nbsp;        if (dist == null) {</b>
<b class="nc">&nbsp;            if (weightDistribution.containsKey(era)) {</b>
<b class="nc">&nbsp;                weightDistribution.get(era).remove(unitType);</b>
&nbsp;            }
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (String s : dist.split(&quot;,&quot;)) {</b>
<b class="nc">&nbsp;            list.add(Integer.valueOf(s));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!weightDistribution.containsKey(era)) {</b>
<b class="nc">&nbsp;            weightDistribution.put(era, new HashMap&lt;&gt;());</b>
&nbsp;        }
<b class="nc">&nbsp;        weightDistribution.get(era).put(unitType, list);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ArrayList&lt;String&gt; getParentFactions() {
<b class="nc">&nbsp;        return parentFactions;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setParentFactions(String factions) {
<b class="nc">&nbsp;        parentFactions.clear();</b>
<b class="nc">&nbsp;        Collections.addAll(parentFactions, factions.split(&quot;,&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    public static FactionRecord createFromXml(Node node) {
<b class="nc">&nbsp;        FactionRecord retVal = new FactionRecord();</b>
<b class="nc">&nbsp;        retVal.key = node.getAttributes().getNamedItem(&quot;key&quot;).getTextContent();</b>
<b class="nc">&nbsp;        retVal.name = node.getAttributes().getNamedItem(&quot;name&quot;).getTextContent();</b>
<b class="nc">&nbsp;        if (node.getAttributes().getNamedItem(&quot;minor&quot;) != null) {</b>
<b class="nc">&nbsp;            retVal.minor = Boolean.parseBoolean(node.getAttributes().getNamedItem(&quot;minor&quot;).getTextContent());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            retVal.minor = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (node.getAttributes().getNamedItem(&quot;clan&quot;) != null) {</b>
<b class="nc">&nbsp;            retVal.clan = Boolean.parseBoolean(node.getAttributes().getNamedItem(&quot;clan&quot;).getTextContent());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            retVal.clan = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (node.getAttributes().getNamedItem(&quot;periphery&quot;) != null) {</b>
<b class="nc">&nbsp;            retVal.periphery = Boolean.parseBoolean(node.getAttributes().getNamedItem(&quot;periphery&quot;).getTextContent());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            retVal.periphery = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        for (int i = 0; i &lt; node.getChildNodes().getLength(); i++) {</b>
<b class="nc">&nbsp;            Node wn = node.getChildNodes().item(i);</b>
<b class="nc">&nbsp;            if (wn.getNodeName().equalsIgnoreCase(&quot;nameChange&quot;)) {</b>
<b class="nc">&nbsp;                retVal.altNames.put(Integer.parseInt(wn.getAttributes().getNamedItem(&quot;year&quot;).getTextContent()),</b>
<b class="nc">&nbsp;                        wn.getTextContent());</b>
<b class="nc">&nbsp;            } else if (wn.getNodeName().equalsIgnoreCase(&quot;years&quot;)) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    retVal.setYears(wn.getTextContent());</b>
<b class="nc">&nbsp;                } catch (ParseException ex) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(ex);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (wn.getNodeName().equalsIgnoreCase(&quot;ratingLevels&quot;)) {</b>
<b class="nc">&nbsp;                retVal.setRatings(wn.getTextContent());</b>
<b class="nc">&nbsp;            } else if (wn.getNodeName().equalsIgnoreCase(&quot;parentFaction&quot;)) {</b>
<b class="nc">&nbsp;                retVal.setParentFactions(wn.getTextContent());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void loadEra(Node node, int era) {
<b class="nc">&nbsp;        for (int i = 0; i &lt; node.getChildNodes().getLength(); i++) {</b>
<b class="nc">&nbsp;            Node wn = node.getChildNodes().item(i);</b>
<b class="nc">&nbsp;            switch(wn.getNodeName()) {</b>
&nbsp;            case &quot;pctOmni&quot;:
<b class="nc">&nbsp;                if (wn.getAttributes().getNamedItem(&quot;unitType&quot;) != null</b>
<b class="nc">&nbsp;                        &amp;&amp; wn.getAttributes().getNamedItem(&quot;unitType&quot;).getTextContent().equalsIgnoreCase(&quot;Aero&quot;)) {</b>
<b class="nc">&nbsp;                    setPctTech(TechCategory.OMNI_AERO, era, wn.getTextContent());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    setPctTech(TechCategory.OMNI, era, wn.getTextContent());</b>
&nbsp;                }
<b class="nc">&nbsp;                break;</b>
&nbsp;            case &quot;pctClan&quot;:
<b class="nc">&nbsp;                if (wn.getAttributes().getNamedItem(&quot;unitType&quot;) != null</b>
<b class="nc">&nbsp;                        &amp;&amp; wn.getAttributes().getNamedItem(&quot;unitType&quot;).getTextContent().equalsIgnoreCase(&quot;Aero&quot;)) {</b>
<b class="nc">&nbsp;                    setPctTech(TechCategory.CLAN_AERO, era, wn.getTextContent());</b>
<b class="nc">&nbsp;                } else if (wn.getAttributes().getNamedItem(&quot;unitType&quot;) != null</b>
<b class="nc">&nbsp;                            &amp;&amp; wn.getAttributes().getNamedItem(&quot;unitType&quot;).getTextContent().equalsIgnoreCase(&quot;Vehicle&quot;)) {</b>
<b class="nc">&nbsp;                    setPctTech(TechCategory.CLAN_VEE, era, wn.getTextContent());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    setPctTech(TechCategory.CLAN, era, wn.getTextContent());</b>
&nbsp;                }
<b class="nc">&nbsp;                break;</b>
&nbsp;            case &quot;pctSL&quot;:
<b class="nc">&nbsp;                if (wn.getAttributes().getNamedItem(&quot;unitType&quot;) != null</b>
<b class="nc">&nbsp;                        &amp;&amp; wn.getAttributes().getNamedItem(&quot;unitType&quot;).getTextContent().equalsIgnoreCase(&quot;Aero&quot;)) {</b>
<b class="nc">&nbsp;                    setPctTech(TechCategory.IS_ADVANCED_AERO, era, wn.getTextContent());</b>
<b class="nc">&nbsp;                } else if (wn.getAttributes().getNamedItem(&quot;unitType&quot;) != null</b>
<b class="nc">&nbsp;                            &amp;&amp; wn.getAttributes().getNamedItem(&quot;unitType&quot;).getTextContent().equalsIgnoreCase(&quot;Vehicle&quot;)) {</b>
<b class="nc">&nbsp;                    setPctTech(TechCategory.IS_ADVANCED_VEE, era, wn.getTextContent());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    setPctTech(TechCategory.IS_ADVANCED, era, wn.getTextContent());</b>
&nbsp;                }
<b class="nc">&nbsp;                break;</b>
&nbsp;            case &quot;omniMargin&quot;:
<b class="nc">&nbsp;                omniMargin.put(era, Integer.parseInt(wn.getTextContent()));</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case &quot;techMargin&quot;:
<b class="nc">&nbsp;                techMargin.put(era, Integer.parseInt(wn.getTextContent()));</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case &quot;upgradeMargin&quot;:
<b class="nc">&nbsp;                upgradeMargin.put(era, Integer.parseInt(wn.getTextContent()));</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case &quot;salvage&quot;:
<b class="nc">&nbsp;                pctSalvage.put(era,</b>
<b class="nc">&nbsp;                        Integer.parseInt(wn.getAttributes().getNamedItem(&quot;pct&quot;).getTextContent()));</b>
<b class="nc">&nbsp;                salvage.put(era, new HashMap&lt;&gt;());</b>
<b class="nc">&nbsp;                String [] fields = wn.getTextContent().trim().split(&quot;,&quot;);</b>
<b class="nc">&nbsp;                for (String field : fields) {</b>
<b class="nc">&nbsp;                    if (field.length() &gt; 0) {</b>
<b class="nc">&nbsp;                        String[] subfields = field.split(&quot;:&quot;);</b>
<b class="nc">&nbsp;                        if (subfields.length == 2) {</b>
<b class="nc">&nbsp;                            salvage.get(era).put(subfields[0], Integer.parseInt(subfields[1]));</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                break;</b>
&nbsp;            case &quot;weightDistribution&quot;:
&nbsp;                try {
<b class="nc">&nbsp;                    int unitType = ModelRecord.parseUnitType(wn.getAttributes().getNamedItem(&quot;unitType&quot;).getTextContent());</b>
<b class="nc">&nbsp;                    setWeightDistribution(era, unitType, wn.getTextContent());</b>
<b class="nc">&nbsp;                } catch (Exception ex) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(&quot;RATGenerator: error parsing weight distributions for &quot; + key</b>
&nbsp;                            + &quot;, &quot; + era);
<b class="nc">&nbsp;                }</b>
&nbsp;                break;
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void writeToXml(PrintWriter pw) {
<b class="nc">&nbsp;        pw.println(&quot;\t&lt;faction key=&#39;&quot; + key + &quot;&#39; name=&#39;&quot;</b>
<b class="nc">&nbsp;                + StringEscapeUtils.escapeXml10(name) + &quot;&#39; minor=&#39;&quot; + minor</b>
&nbsp;                + &quot;&#39; clan=&#39;&quot; + clan
&nbsp;                + &quot;&#39; periphery=&#39;&quot; + periphery + &quot;&#39;&gt;&quot;);
<b class="nc">&nbsp;        for (Integer year : altNames.keySet()) {</b>
<b class="nc">&nbsp;            pw.println(&quot;\t\t&lt;nameChange year=&#39;&quot; + year + &quot;&#39;&gt;&quot;</b>
<b class="nc">&nbsp;                    + altNames.get(year) + &quot;&lt;/nameChange&gt;&quot;);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        pw.print(&quot;\t\t&lt;years&gt;&quot;);</b>
<b class="nc">&nbsp;        pw.print(getYearsAsString());</b>
<b class="nc">&nbsp;        pw.println(&quot;&lt;/years&gt;&quot;);</b>
<b class="nc">&nbsp;        if (ratingLevels.size() &gt; 0) {</b>
<b class="nc">&nbsp;            pw.println(&quot;\t\t&lt;ratingLevels&gt;&quot; + StringEscapeUtils.escapeXml10(String.join(&quot;,&quot;, ratingLevels)) + &quot;&lt;/ratingLevels&gt;&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (parentFactions != null) {</b>
<b class="nc">&nbsp;            pw.println(&quot;\t\t&lt;parentFaction&gt;&quot; + StringEscapeUtils.escapeXml10(String.join(&quot;,&quot;, parentFactions)) + &quot;&lt;/parentFaction&gt;&quot;);</b>
&nbsp;        }       
<b class="nc">&nbsp;        pw.println(&quot;\t&lt;/faction&gt;&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    
&nbsp;    public void writeToXml(PrintWriter pw, int era) {
<b class="nc">&nbsp;        StringBuilder factionRecordBuilder = new StringBuilder();</b>
<b class="nc">&nbsp;        if (pctTech.containsKey(TechCategory.OMNI)</b>
<b class="nc">&nbsp;                &amp;&amp; pctTech.get(TechCategory.OMNI).containsKey(era)</b>
<b class="nc">&nbsp;                &amp;&amp; (pctTech.get(TechCategory.OMNI).get(era).size() &gt; 0)) {</b>
<b class="nc">&nbsp;            factionRecordBuilder.append(</b>
<b class="nc">&nbsp;                    String.format(&quot;\t\t&lt;pctOmni&gt;%s&lt;/pctOmni&gt;\n&quot;, </b>
<b class="nc">&nbsp;                            pctTech.get(TechCategory.OMNI).get(era).stream().map(Object::toString)</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;,&quot;))));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (pctTech.containsKey(TechCategory.CLAN)</b>
<b class="nc">&nbsp;                &amp;&amp; pctTech.get(TechCategory.CLAN).containsKey(era)</b>
<b class="nc">&nbsp;                &amp;&amp; (pctTech.get(TechCategory.CLAN).get(era).size() &gt; 0)) {</b>
<b class="nc">&nbsp;            factionRecordBuilder.append(</b>
<b class="nc">&nbsp;                    String.format(&quot;\t\t&lt;pctClan&gt;%s&lt;/pctClan&gt;\n&quot;, </b>
<b class="nc">&nbsp;                            pctTech.get(TechCategory.CLAN).get(era).stream().map(Object::toString)</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;,&quot;))));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (pctTech.containsKey(TechCategory.IS_ADVANCED)</b>
<b class="nc">&nbsp;                &amp;&amp; pctTech.get(TechCategory.IS_ADVANCED).containsKey(era)</b>
<b class="nc">&nbsp;                &amp;&amp; (pctTech.get(TechCategory.IS_ADVANCED).get(era).size() &gt; 0)) {</b>
<b class="nc">&nbsp;            factionRecordBuilder.append(</b>
<b class="nc">&nbsp;                    String.format(&quot;\t\t&lt;pctSL&gt;%s&lt;/pctSL&gt;\n&quot;, </b>
<b class="nc">&nbsp;                            pctTech.get(TechCategory.IS_ADVANCED).get(era).stream().map(Object::toString)</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;,&quot;))));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (pctTech.containsKey(TechCategory.OMNI_AERO)</b>
<b class="nc">&nbsp;                &amp;&amp; pctTech.get(TechCategory.OMNI_AERO).containsKey(era)</b>
<b class="nc">&nbsp;                &amp;&amp; (pctTech.get(TechCategory.OMNI_AERO).get(era).size() &gt; 0)) {</b>
<b class="nc">&nbsp;            factionRecordBuilder.append(</b>
<b class="nc">&nbsp;                    String.format(&quot;\t\t&lt;pctOmni unitType=&#39;Aero&#39;&gt;%s&lt;/pctOmni&gt;\n&quot;, </b>
<b class="nc">&nbsp;                            pctTech.get(TechCategory.OMNI_AERO).get(era).stream().map(Object::toString)</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;,&quot;))));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (pctTech.containsKey(TechCategory.CLAN_AERO)</b>
<b class="nc">&nbsp;                &amp;&amp; pctTech.get(TechCategory.CLAN_AERO).containsKey(era)</b>
<b class="nc">&nbsp;                &amp;&amp; (pctTech.get(TechCategory.CLAN_AERO).get(era).size() &gt; 0)) {</b>
<b class="nc">&nbsp;            factionRecordBuilder.append(</b>
<b class="nc">&nbsp;                    String.format(&quot;\t\t&lt;pctClan unitType=&#39;Aero&#39;&gt;%s&lt;/pctClan&gt;\n&quot;, </b>
<b class="nc">&nbsp;                            pctTech.get(TechCategory.CLAN_AERO).get(era).stream().map(Object::toString)</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;,&quot;))));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (pctTech.containsKey(TechCategory.IS_ADVANCED_AERO)</b>
<b class="nc">&nbsp;                &amp;&amp; pctTech.get(TechCategory.IS_ADVANCED_AERO).containsKey(era)</b>
<b class="nc">&nbsp;                &amp;&amp; (pctTech.get(TechCategory.IS_ADVANCED_AERO).get(era).size() &gt; 0)) {</b>
<b class="nc">&nbsp;            factionRecordBuilder.append(</b>
<b class="nc">&nbsp;                    String.format(&quot;\t\t&lt;pctSL unitType=&#39;Aero&#39;&gt;%s&lt;/pctSL&gt;\n&quot;, </b>
<b class="nc">&nbsp;                            pctTech.get(TechCategory.IS_ADVANCED_AERO).get(era).stream().map(Object::toString)</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;,&quot;))));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (pctTech.containsKey(TechCategory.CLAN_VEE)</b>
<b class="nc">&nbsp;                &amp;&amp; pctTech.get(TechCategory.CLAN_VEE).containsKey(era)</b>
<b class="nc">&nbsp;                &amp;&amp; (pctTech.get(TechCategory.CLAN_VEE).get(era).size() &gt; 0)) {</b>
<b class="nc">&nbsp;            factionRecordBuilder.append(</b>
<b class="nc">&nbsp;                    String.format(&quot;\t\t&lt;pctClan unitType=&#39;Vehicle&#39;&gt;%s&lt;/pctClan&gt;\n&quot;, </b>
<b class="nc">&nbsp;                            pctTech.get(TechCategory.CLAN_VEE).get(era).stream().map(Object::toString)</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;,&quot;))));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (pctTech.containsKey(TechCategory.IS_ADVANCED_VEE)</b>
<b class="nc">&nbsp;                &amp;&amp; pctTech.get(TechCategory.IS_ADVANCED_VEE).containsKey(era)</b>
<b class="nc">&nbsp;                &amp;&amp; (pctTech.get(TechCategory.IS_ADVANCED_VEE).get(era).size() &gt; 0)) {</b>
<b class="nc">&nbsp;            factionRecordBuilder.append(</b>
<b class="nc">&nbsp;                    String.format(&quot;\t\t&lt;pctSL unitType=&#39;Vehicle&#39;&gt;%s&lt;/pctSL&gt;\n&quot;, </b>
<b class="nc">&nbsp;                            pctTech.get(TechCategory.IS_ADVANCED_VEE).get(era).stream().map(Object::toString)</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;,&quot;))));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (era &gt; 3067) {</b>
<b class="nc">&nbsp;            if (!isClan() &amp;&amp; !key.equals(&quot;CGB.FRR&quot;) &amp;&amp; !key.equals(&quot;RA.OA&quot;)) {</b>
<b class="nc">&nbsp;                factionRecordBuilder.append(&quot;\t\t&lt;omniMargin&gt;&quot;);</b>
<b class="nc">&nbsp;                factionRecordBuilder.append((era - 3067) / 5);</b>
<b class="nc">&nbsp;                factionRecordBuilder.append(&quot;&lt;/omniMargin&gt;\n&quot;);</b>
<b class="nc">&nbsp;                factionRecordBuilder.append(&quot;\t\t&lt;techMargin&gt;&quot;);</b>
<b class="nc">&nbsp;                factionRecordBuilder.append((era - 3067) / 5);</b>
<b class="nc">&nbsp;                factionRecordBuilder.append(&quot;&lt;/techMargin&gt;\n&quot;);</b>
<b class="nc">&nbsp;                if (era &gt; 3085) {</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append(&quot;\t\t&lt;upgradeMargin&gt;&quot;);</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append((era - 3085) / 5);</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append(&quot;&lt;/upgradeMargin&gt;\n&quot;);</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                factionRecordBuilder.append(&quot;\t\t&lt;techMargin&gt;&quot;);</b>
<b class="nc">&nbsp;                factionRecordBuilder.append((era - 3067) / 5);</b>
<b class="nc">&nbsp;                factionRecordBuilder.append(&quot;&lt;/techMargin&gt;\n&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Integer pct = pctSalvage.get(era);</b>
<b class="nc">&nbsp;        if (pct != null) {</b>
<b class="nc">&nbsp;            StringJoiner sj = new StringJoiner(&quot;,&quot;);</b>
<b class="nc">&nbsp;            for (String faction : salvage.get(era).keySet()) {</b>
<b class="nc">&nbsp;                FactionRecord fr = RATGenerator.getInstance().getFaction(faction);</b>
<b class="nc">&nbsp;                if (fr == null || !fr.isInEra(era)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                sj.add(faction + &quot;:&quot; + salvage.get(era).get(faction));</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            factionRecordBuilder.append(&quot;\t\t&lt;salvage pct=&#39;&quot;).append(pct).append(&quot;&#39;&gt;&quot;)</b>
<b class="nc">&nbsp;                .append(sj.toString()).append(&quot;&lt;/salvage&gt;\n&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        final int[] unitWeightKeys = { UnitType.MEK, UnitType.TANK, UnitType.AERO };</b>
<b class="nc">&nbsp;        if (weightDistribution.containsKey(era)) {</b>
<b class="nc">&nbsp;            for (int unitType : unitWeightKeys) {</b>
<b class="nc">&nbsp;                if (weightDistribution.get(era).containsKey(unitType)</b>
<b class="nc">&nbsp;                        &amp;&amp; weightDistribution.get(era).get(unitType).size() &gt; 0) {</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append(&quot;\t\t&lt;weightDistribution era=&#39;&quot;);</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append(era);</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append(&quot;&#39; unitType=&#39;&quot;);</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append(UnitType.getTypeName(unitType));</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append(&quot;&#39;&gt;&quot;);</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append(getWeightDistributionAsString(era, unitType));</b>
<b class="nc">&nbsp;                    factionRecordBuilder.append(&quot;&lt;/weightDistribution&gt;\n&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if(factionRecordBuilder.length() &gt; 0) {</b>
<b class="nc">&nbsp;            pw.println(&quot;\t&lt;faction key=&#39;&quot; + key + &quot;&#39;&gt;&quot;);</b>
<b class="nc">&nbsp;            pw.println(factionRecordBuilder.toString().replaceFirst(&quot;\\n$&quot;, &quot;&quot;));</b>
<b class="nc">&nbsp;            pw.println(&quot;\t&lt;/faction&gt;&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            pw.println(&quot;\t&lt;faction key=&#39;&quot; + key + &quot;&#39;/&gt;&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks whether the faction is active at any point from the given year to the next reference 
&nbsp;     * @param era The era start year
&nbsp;     * @return    Whether the faction is active
&nbsp;     * @see #isActiveInYear(int)
&nbsp;     */
&nbsp;    public boolean isInEra(int era) {
<b class="nc">&nbsp;        if (isActiveInYear(era)) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        /* May still be in era if start date comes before the next era */
<b class="nc">&nbsp;        TreeSet&lt;Integer&gt; eraSet = RATGenerator.getInstance().getEraSet();</b>
<b class="nc">&nbsp;        Integer next = eraSet.ceiling(era + 1);</b>
<b class="nc">&nbsp;        if (next == null) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        for (DateRange dr : yearsActive) {</b>
<b class="nc">&nbsp;            if (dr.start != null &amp;&amp; dr.start &gt; era &amp;&amp; dr.start &lt; next) {</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * @return CSV of all names of the faction, with the original name given first followed by name
&nbsp;     *         changes in the format year:name
&nbsp;     */
&nbsp;    public Object getNamesAsString() {
<b class="nc">&nbsp;        StringBuilder retVal = new StringBuilder(name);</b>
<b class="nc">&nbsp;        for (Integer y : altNames.keySet()) {</b>
<b class="nc">&nbsp;            retVal.append(&quot;,&quot;).append(y).append(&quot;:&quot;).append(altNames.get(y));</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return retVal.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return CSV String of all date ranges in which the faction is active.
&nbsp;     */
&nbsp;    public String getYearsAsString() {
<b class="nc">&nbsp;        StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;        for (Iterator&lt;DateRange&gt; iter = yearsActive.iterator(); iter.hasNext();) {</b>
<b class="nc">&nbsp;            DateRange dr = iter.next();</b>
<b class="nc">&nbsp;            sb.append(dr.toString());</b>
<b class="nc">&nbsp;            if (iter.hasNext()) {</b>
<b class="nc">&nbsp;                sb.append(&quot;,&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return sb.toString();</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Formats the weight distribution for a given unit type in an era as a String.
&nbsp;     * 
&nbsp;     * @param era        The game year
&nbsp;     * @param unitType   The type of unit
&nbsp;     * @return           A formatted String
&nbsp;     */
&nbsp;    public String getWeightDistributionAsString(int era, int unitType) {
<b class="nc">&nbsp;        StringJoiner sj = new StringJoiner(&quot;,&quot;);</b>
<b class="nc">&nbsp;        if (weightDistribution.containsKey(era) &amp;&amp; weightDistribution.get(era).containsKey(unitType)) {</b>
<b class="nc">&nbsp;            for (Integer i : weightDistribution.get(era).get(unitType)) {</b>
<b class="nc">&nbsp;                sj.add(String.valueOf(i));</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        return sj.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    public String toString() {
<b class="nc">&nbsp;        return key;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static class DateRange {
&nbsp;        public Integer start;
&nbsp;        public Integer end;
&nbsp;
<b class="nc">&nbsp;        public DateRange(Integer start, Integer end) {</b>
<b class="nc">&nbsp;            this.start = start;</b>
<b class="nc">&nbsp;            this.end = end;</b>
&nbsp;        }
&nbsp;
&nbsp;        public boolean isInRange(int year) {
<b class="nc">&nbsp;            return (start == null || start &lt;= year)</b>
<b class="nc">&nbsp;                    &amp;&amp; (end == null || end &gt;= year);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public String toString() {
<b class="nc">&nbsp;            StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;            if (start != null) {</b>
<b class="nc">&nbsp;                sb.append(start);</b>
&nbsp;            }
<b class="nc">&nbsp;            sb.append(&quot;-&quot;);</b>
<b class="nc">&nbsp;            if (end != null) {</b>
<b class="nc">&nbsp;                sb.append(end);</b>
&nbsp;            }
<b class="nc">&nbsp;            return sb.toString();</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
