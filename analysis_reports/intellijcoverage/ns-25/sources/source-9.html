


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > TROView</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.common.templates</a>
</div>

<h1>Coverage Summary for Class: TROView (megamek.common.templates)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TROView</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/33)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/356)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TROView$EquipmentKey</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TROView$FormatTableRowMethod</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TROView$Justification</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/49)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/400)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp;* MegaMek -
&nbsp;* Copyright (C) 2018 The MegaMek Team
&nbsp;*
&nbsp;* This program is free software; you can redistribute it and/or modify it under
&nbsp;* the terms of the GNU General Public License as published by the Free Software
&nbsp;* Foundation; either version 2 of the License, or (at your option) any later
&nbsp;* version.
&nbsp;*
&nbsp;* This program is distributed in the hope that it will be useful, but WITHOUT
&nbsp;* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
&nbsp;* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
&nbsp;* details.
&nbsp;*/
&nbsp;
&nbsp;package megamek.common.templates;
&nbsp;
&nbsp;import java.io.ByteArrayOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.OutputStreamWriter;
&nbsp;import java.io.Writer;
&nbsp;import java.text.NumberFormat;
&nbsp;import java.util.*;
&nbsp;import java.util.function.BiFunction;
&nbsp;import java.util.function.Supplier;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import freemarker.template.Template;
&nbsp;import freemarker.template.TemplateException;
&nbsp;import freemarker.template.TemplateMethodModelEx;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.common.Aero;
&nbsp;import megamek.common.AmmoType;
&nbsp;import megamek.common.BattleArmor;
&nbsp;import megamek.common.Bay;
&nbsp;import megamek.common.Configuration;
&nbsp;import megamek.common.CriticalSlot;
&nbsp;import megamek.common.Entity;
&nbsp;import megamek.common.EntityFluff;
&nbsp;import megamek.common.EquipmentType;
&nbsp;import megamek.common.Infantry;
&nbsp;import megamek.common.Jumpship;
&nbsp;import megamek.common.Mech;
&nbsp;import megamek.common.Messages;
&nbsp;import megamek.common.Mounted;
&nbsp;import megamek.common.Protomech;
&nbsp;import megamek.common.SmallCraft;
&nbsp;import megamek.common.Tank;
&nbsp;import megamek.common.Transporter;
&nbsp;import megamek.common.TroopSpace;
&nbsp;import megamek.common.WeaponType;
&nbsp;import megamek.common.annotations.Nullable;
&nbsp;import megamek.common.options.IOption;
&nbsp;import megamek.common.options.IOptionGroup;
&nbsp;import megamek.common.options.Quirks;
&nbsp;import megamek.common.util.fileUtils.MegaMekFile;
&nbsp;import megamek.common.verifier.BayData;
&nbsp;import megamek.common.verifier.EntityVerifier;
&nbsp;
&nbsp;/**
&nbsp; * Fills in a template to produce a unit summary in TRO format.
&nbsp; *
&nbsp; * @author Neoancient
&nbsp; */
&nbsp;public class TROView {
&nbsp;
&nbsp;    private Template template;
<b class="nc">&nbsp;    private final Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private final EntityVerifier verifier = EntityVerifier</b>
<b class="nc">&nbsp;            .getInstance(new MegaMekFile(Configuration.unitsDir(), EntityVerifier.CONFIG_FILENAME).getFile());</b>
&nbsp;
<b class="nc">&nbsp;    private boolean includeFluff = true;</b>
&nbsp;
<b class="nc">&nbsp;    protected TROView() {</b>
&nbsp;    }
&nbsp;
&nbsp;    public static TROView createView(Entity entity, boolean html) {
&nbsp;        TROView view;
<b class="nc">&nbsp;        if (entity.hasETypeFlag(Entity.ETYPE_MECH)) {</b>
<b class="nc">&nbsp;            view = new MechTROView((Mech) entity);</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</b>
<b class="nc">&nbsp;            view = new ProtomechTROView((Protomech) entity);</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_SUPPORT_TANK)</b>
<b class="nc">&nbsp;                || (entity.hasETypeFlag(Entity.ETYPE_SUPPORT_VTOL))) {</b>
<b class="nc">&nbsp;            view = new SupportVeeTROView((Tank) entity);</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_TANK)) {</b>
<b class="nc">&nbsp;            view = new VehicleTROView((Tank) entity);</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</b>
<b class="nc">&nbsp;            view = new SmallCraftDropshipTROView((SmallCraft) entity);</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</b>
<b class="nc">&nbsp;            view = new CapitalShipTROView((Jumpship) entity);</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_AERO)) {</b>
<b class="nc">&nbsp;            view = new AeroTROView((Aero) entity);</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_BATTLEARMOR)) {</b>
<b class="nc">&nbsp;            view = new BattleArmorTROView((BattleArmor) entity);</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_INFANTRY)) {</b>
<b class="nc">&nbsp;            view = new InfantryTROView((Infantry) entity);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            view = new TROView();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (null != view.getTemplateFileName(html)) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                view.template = TemplateConfiguration.getInstance()</b>
<b class="nc">&nbsp;                        .getTemplate(&quot;tro/&quot; + view.getTemplateFileName(html));</b>
<b class="nc">&nbsp;            } catch (final IOException e) {</b>
<b class="nc">&nbsp;                MegaMek.getLogger().error(e);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            view.initModel(view.verifier);</b>
&nbsp;        }
<b class="nc">&nbsp;        return view;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected String getTemplateFileName(boolean html) {
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void setModelData(String key, Object data) {
<b class="nc">&nbsp;        model.put(key, data);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected Object getModelData(String key) {
<b class="nc">&nbsp;        return model.get(key);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void initModel(EntityVerifier verifier) {
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Uses the template and supplied {@link Entity} to generate a TRO document
&nbsp;     *
&nbsp;     * @return The generated document. Returns {@code null} if there was an error
&nbsp;     *         that prevented the document from being generated. Check logs for
&nbsp;     *         reason.
&nbsp;     */
&nbsp;    @Nullable
&nbsp;    public String processTemplate() {
<b class="nc">&nbsp;        if (null != template) {</b>
<b class="nc">&nbsp;            model.put(&quot;includeFluff&quot;, includeFluff);</b>
<b class="nc">&nbsp;            try (final ByteArrayOutputStream os = new ByteArrayOutputStream();</b>
<b class="nc">&nbsp;                 final Writer out = new OutputStreamWriter(os)) {</b>
<b class="nc">&nbsp;                template.process(model, out);</b>
<b class="nc">&nbsp;                return os.toString();</b>
<b class="nc">&nbsp;            } catch (TemplateException | IOException e) {</b>
<b class="nc">&nbsp;                MegaMek.getLogger().error(e);</b>
<b class="nc">&nbsp;                e.printStackTrace();</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void addBasicData(Entity entity) {
<b class="nc">&nbsp;        model.put(&quot;formatBasicDataRow&quot;, new FormatTableRowMethod(new int[] { 30, 20, 5 },</b>
&nbsp;                new Justification[] { Justification.LEFT, Justification.LEFT, Justification.RIGHT }));
<b class="nc">&nbsp;        model.put(&quot;fullName&quot;, entity.getShortNameRaw());</b>
<b class="nc">&nbsp;        model.put(&quot;chassis&quot;, entity.getChassis());</b>
<b class="nc">&nbsp;        model.put(&quot;techBase&quot;, formatTechBase(entity));</b>
<b class="nc">&nbsp;        model.put(&quot;tonnage&quot;, NumberFormat.getInstance().format(entity.getWeight()));</b>
<b class="nc">&nbsp;        model.put(&quot;battleValue&quot;, NumberFormat.getInstance().format(entity.calculateBattleValue()));</b>
<b class="nc">&nbsp;        model.put(&quot;cost&quot;, NumberFormat.getInstance().format(entity.getCost(false)));</b>
&nbsp;
<b class="nc">&nbsp;        final StringJoiner quirksList = new StringJoiner(&quot;, &quot;);</b>
<b class="nc">&nbsp;        final Quirks quirks = entity.getQuirks();</b>
<b class="nc">&nbsp;        for (final Enumeration&lt;IOptionGroup&gt; optionGroups = quirks.getGroups(); optionGroups.hasMoreElements();) {</b>
<b class="nc">&nbsp;            final IOptionGroup group = optionGroups.nextElement();</b>
<b class="nc">&nbsp;            if (quirks.count(group.getKey()) &gt; 0) {</b>
<b class="nc">&nbsp;                for (final Enumeration&lt;IOption&gt; options = group.getOptions(); options.hasMoreElements();) {</b>
<b class="nc">&nbsp;                    final IOption option = options.nextElement();</b>
<b class="nc">&nbsp;                    if ((option != null) &amp;&amp; option.booleanValue()) {</b>
<b class="nc">&nbsp;                        quirksList.add(option.getDisplayableNameWithValue());</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (quirksList.length() &gt; 0) {</b>
<b class="nc">&nbsp;            model.put(&quot;quirks&quot;, quirksList.toString());</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    protected void addEntityFluff(Entity entity) {
<b class="nc">&nbsp;        model.put(&quot;year&quot;, String.valueOf(entity.getYear()));</b>
<b class="nc">&nbsp;        model.put(&quot;techRating&quot;, entity.getFullRatingName());</b>
<b class="nc">&nbsp;        if (entity.getFluff().getOverview().length() &gt; 0) {</b>
<b class="nc">&nbsp;            model.put(&quot;fluffOverview&quot;, entity.getFluff().getOverview());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (entity.getFluff().getCapabilities().length() &gt; 0) {</b>
<b class="nc">&nbsp;            model.put(&quot;fluffCapabilities&quot;, entity.getFluff().getCapabilities());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (entity.getFluff().getDeployment().length() &gt; 0) {</b>
<b class="nc">&nbsp;            model.put(&quot;fluffDeployment&quot;, entity.getFluff().getDeployment());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (entity.getFluff().getHistory().length() &gt; 0) {</b>
<b class="nc">&nbsp;            model.put(&quot;fluffHistory&quot;, entity.getFluff().getHistory());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (entity.getFluff().getManufacturer().length() &gt; 0) {</b>
<b class="nc">&nbsp;            model.put(&quot;manufacturerDesc&quot;, entity.getFluff().getManufacturer());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (entity.getFluff().getPrimaryFactory().length() &gt; 0) {</b>
<b class="nc">&nbsp;            model.put(&quot;factoryDesc&quot;, entity.getFluff().getPrimaryFactory());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Builds the fluff name for a system component.
&nbsp;     *
&nbsp;     * @param system
&nbsp;     *            The system component
&nbsp;     * @param fluff
&nbsp;     *            The {@link Entity}&#39;s fluff object
&nbsp;     * @param altText
&nbsp;     *            Alternate text that will be used if neither fluff field is set.
&nbsp;     * @return The fluff display name, which consists of the manufacturer and the
&nbsp;     *         model separated by a space. If either is missing it is left out.
&nbsp;     */
&nbsp;    protected String formatSystemFluff(EntityFluff.System system, EntityFluff fluff, Supplier&lt;String&gt; altText) {
<b class="nc">&nbsp;        final StringJoiner sj = new StringJoiner(&quot; &quot;);</b>
<b class="nc">&nbsp;        if (fluff.getSystemManufacturer(system).length() &gt; 0) {</b>
<b class="nc">&nbsp;            sj.add(fluff.getSystemManufacturer(system));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (fluff.getSystemModel(system).length() &gt; 0) {</b>
<b class="nc">&nbsp;            sj.add(fluff.getSystemModel(system));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (sj.toString().length() &gt; 0) {</b>
<b class="nc">&nbsp;            return sj.toString();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return altText.get();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    protected void addMechVeeAeroFluff(Entity entity) {
<b class="nc">&nbsp;        addEntityFluff(entity);</b>
<b class="nc">&nbsp;        model.put(&quot;massDesc&quot;, NumberFormat.getInstance().format(entity.getWeight())</b>
<b class="nc">&nbsp;                + Messages.getString(entity.getWeight() == 1.0 ? &quot;TROView.ton&quot; : &quot;TROView.tons&quot;));</b>
<b class="nc">&nbsp;        model.put(&quot;engineDesc&quot;, formatSystemFluff(EntityFluff.System.ENGINE, entity.getFluff(),</b>
<b class="nc">&nbsp;                () -&gt; stripNotes(entity.getEngine().getEngineName())));</b>
<b class="nc">&nbsp;        model.put(&quot;cruisingSpeed&quot;, entity.getWalkMP() * 10.8);</b>
<b class="nc">&nbsp;        model.put(&quot;maxSpeed&quot;, entity.getRunMP() * 10.8);</b>
<b class="nc">&nbsp;        model.put(&quot;armorDesc&quot;,</b>
<b class="nc">&nbsp;                formatSystemFluff(EntityFluff.System.ARMOR, entity.getFluff(), () -&gt; formatArmorType(entity, false)));</b>
<b class="nc">&nbsp;        final Map&lt;String, Integer&gt; weaponCount = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        double podSpace = 0.0;</b>
<b class="nc">&nbsp;        for (final Mounted m : entity.getEquipment()) {</b>
<b class="nc">&nbsp;            if (m.isOmniPodMounted()) {</b>
<b class="nc">&nbsp;                podSpace += m.getTonnage();</b>
<b class="nc">&nbsp;            } else if (m.getType() instanceof WeaponType) {</b>
<b class="nc">&nbsp;                weaponCount.merge(m.getName(), 1, Integer::sum);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        final List&lt;String&gt; armaments = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (final Map.Entry&lt;String, Integer&gt; entry : weaponCount.entrySet()) {</b>
<b class="nc">&nbsp;            armaments.add(String.format(&quot;%d %s&quot;, entry.getValue(), entry.getKey()));</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (podSpace &gt; 0) {</b>
<b class="nc">&nbsp;            armaments.add(String.format(Messages.getString(&quot;TROView.podspace.format&quot;), podSpace));</b>
&nbsp;        }
<b class="nc">&nbsp;        model.put(&quot;armamentList&quot;, armaments);</b>
<b class="nc">&nbsp;        model.put(&quot;communicationDesc&quot;, formatSystemFluff(EntityFluff.System.COMMUNICATIONS, entity.getFluff(),</b>
<b class="nc">&nbsp;                () -&gt; Messages.getString(&quot;TROView.Unknown&quot;)));</b>
<b class="nc">&nbsp;        model.put(&quot;targetingDesc&quot;, formatSystemFluff(EntityFluff.System.TARGETING, entity.getFluff(),</b>
<b class="nc">&nbsp;                () -&gt; Messages.getString(&quot;TROView.Unknown&quot;)));</b>
&nbsp;    }
&nbsp;
&nbsp;    private String formatTechBase(Entity entity) {
<b class="nc">&nbsp;        final StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;        if (entity.isMixedTech()) {</b>
<b class="nc">&nbsp;            sb.append(Messages.getString(&quot;TROView.Mixed&quot;));</b>
<b class="nc">&nbsp;        } else if (entity.isClan()) {</b>
<b class="nc">&nbsp;            sb.append(Messages.getString(&quot;TROView.Clan&quot;));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            sb.append(Messages.getString(&quot;TROView.InnerSphere&quot;));</b>
&nbsp;        }
<b class="nc">&nbsp;        sb.append(&quot; (&quot;).append(entity.getStaticTechLevel().toString()).append(&quot;)&quot;);</b>
<b class="nc">&nbsp;        return sb.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    protected String formatArmorType(Entity entity, boolean trim) {
<b class="nc">&nbsp;        if (entity.hasETypeFlag(Entity.ETYPE_SUPPORT_TANK) || entity.hasETypeFlag(Entity.ETYPE_SUPPORT_VTOL)</b>
<b class="nc">&nbsp;                || entity.hasETypeFlag(Entity.ETYPE_FIXED_WING_SUPPORT)) {</b>
<b class="nc">&nbsp;            return &quot;BAR &quot; + entity.getBARRating(Tank.LOC_FRONT);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (entity.hasPatchworkArmor()) {</b>
<b class="nc">&nbsp;            return EquipmentType.getArmorTypeName(EquipmentType.T_ARMOR_PATCHWORK);</b>
&nbsp;        }
&nbsp;        // Some types do not have armor on the first location, and others have only a
&nbsp;        // single location
<b class="nc">&nbsp;        final int at = entity.getArmorType(Math.min(1, entity.locations() - 1));</b>
<b class="nc">&nbsp;        if (trim &amp;&amp; (at == EquipmentType.T_ARMOR_STANDARD)) {</b>
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        String name = EquipmentType.getArmorTypeName(at);</b>
<b class="nc">&nbsp;        if (trim) {</b>
<b class="nc">&nbsp;            name = name.replace(&quot;-Fibrous&quot;, &quot;&quot;).replace(&quot;-Aluminum&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;            if (at == EquipmentType.T_ARMOR_EDP) {</b>
<b class="nc">&nbsp;                name = &quot;EDP&quot;;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return name;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected String formatArmorType(int at, boolean trim) {
&nbsp;        // Some types do not have armor on the first location, and others have only a
&nbsp;        // single location
<b class="nc">&nbsp;        if (trim &amp;&amp; (at == EquipmentType.T_ARMOR_STANDARD)) {</b>
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        String name = EquipmentType.getArmorTypeName(at);</b>
<b class="nc">&nbsp;        if (trim) {</b>
<b class="nc">&nbsp;            name = name.replace(&quot;-Fibrous&quot;, &quot;&quot;).replace(&quot;-Aluminum&quot;, &quot;&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return name;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Convenience method to format armor and structure values, consolidating
&nbsp;     * right/left values into a single entry. In most cases the right and left armor
&nbsp;     * values are the same, in which case only a single value is used. If the values
&nbsp;     * do not match they are both (or all, in the case of tripod mech legs) given
&nbsp;     * separated by slashes.
&nbsp;     *
&nbsp;     * @param entity
&nbsp;     *            The entity to collect structure or armor values for
&nbsp;     * @param provider
&nbsp;     *            The function that retrieves the armor or structure value for the
&nbsp;     *            entity and location
&nbsp;     * @param locSets
&nbsp;     *            A two-dimensional array that groups locations that should appear
&nbsp;     *            on the same line. Any location that is not legal for the unit
&nbsp;     *            (e.g. center leg on non-tripods) is ignored. If the first location
&nbsp;     *            in a group is illegal, the entire group is skipped.
&nbsp;     * @return A {@link Map} with the armor/structure value mapped to the
&nbsp;     *         abbreviation of each of the location keys.
&nbsp;     */
&nbsp;    protected Map&lt;String, String&gt; addArmorStructureEntries(Entity entity, BiFunction&lt;Entity, Integer, Integer&gt; provider,
&nbsp;            int[][] locSets) {
<b class="nc">&nbsp;        final Map&lt;String, String&gt; retVal = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for (final int[] locs : locSets) {</b>
<b class="nc">&nbsp;            if ((locs.length == 0) || (locs[0] &gt;= entity.locations())) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            String val = null;</b>
<b class="nc">&nbsp;            if (locs.length &gt; 1) {</b>
<b class="nc">&nbsp;                for (int i = 1; i &lt; locs.length; i++) {</b>
<b class="nc">&nbsp;                    if ((locs[i] &lt; entity.locations())</b>
<b class="nc">&nbsp;                            &amp;&amp; ((!provider.apply(entity, locs[i]).equals(provider.apply(entity, locs[0])))</b>
<b class="nc">&nbsp;                                    || !entity.hasETypeFlag(Entity.ETYPE_MECH))) {</b>
<b class="nc">&nbsp;                        val = Arrays.stream(locs).filter(l -&gt; l &lt; entity.locations())</b>
<b class="nc">&nbsp;                                .mapToObj(l -&gt; String.valueOf(provider.apply(entity, l)))</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;/&quot;));</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (null == val) {</b>
<b class="nc">&nbsp;                val = String.valueOf(provider.apply(entity, locs[0]));</b>
&nbsp;            }
<b class="nc">&nbsp;            for (final int loc : locs) {</b>
<b class="nc">&nbsp;                if (loc &lt; entity.locations()) {</b>
<b class="nc">&nbsp;                    retVal.put(entity.getLocationAbbr(loc), val);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected Map&lt;String, String&gt; addPatchworkATs(Entity entity, int[][] locSets) {
<b class="nc">&nbsp;        final Map&lt;String, String&gt; retVal = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for (final int[] locs : locSets) {</b>
<b class="nc">&nbsp;            if ((locs.length == 0) || (locs[0] &gt;= entity.locations())) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            String val = null;</b>
<b class="nc">&nbsp;            if (locs.length &gt; 1) {</b>
<b class="nc">&nbsp;                for (int i = 1; i &lt; locs.length; i++) {</b>
<b class="nc">&nbsp;                    if ((locs[i] &lt; entity.locations())</b>
<b class="nc">&nbsp;                            &amp;&amp; (entity.getArmorType(locs[i]) != entity.getArmorType(locs[0]))) {</b>
<b class="nc">&nbsp;                        val = Arrays.stream(locs).mapToObj(l -&gt; formatArmorType(entity.getArmorType(l), true))</b>
<b class="nc">&nbsp;                                .collect(Collectors.joining(&quot;/&quot;));</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (null == val) {</b>
<b class="nc">&nbsp;                val = formatArmorType(entity.getArmorType(locs[0]), true);</b>
&nbsp;            }
<b class="nc">&nbsp;            for (final int loc : locs) {</b>
<b class="nc">&nbsp;                if (loc &lt; entity.locations()) {</b>
<b class="nc">&nbsp;                    retVal.put(entity.getLocationAbbr(loc), val);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected int addEquipment(Entity entity) {
<b class="nc">&nbsp;        return addEquipment(entity, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Test for whether the mount should be included in the equipment inventory section.
&nbsp;     *
&nbsp;     * @param mount        The equipment mount
&nbsp;     * @param includeAmmo  Whether to include ammo in the list
&nbsp;     * @return             Whether to list the equipment in the inventory section
&nbsp;     */
&nbsp;    protected boolean skipMount(Mounted mount, boolean includeAmmo) {
<b class="nc">&nbsp;        return mount.getLocation() &lt; 0</b>
<b class="nc">&nbsp;                || mount.isWeaponGroup()</b>
<b class="nc">&nbsp;                || (!includeAmmo &amp;&amp; (mount.getType() instanceof AmmoType));</b>
&nbsp;    }
&nbsp;
&nbsp;    protected int addEquipment(Entity entity, boolean includeAmmo) {
<b class="nc">&nbsp;        final int structure = entity.getStructureType();</b>
<b class="nc">&nbsp;        final Map&lt;String, Map&lt;EquipmentKey, Integer&gt;&gt; equipment = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        int nameWidth = 20;</b>
<b class="nc">&nbsp;        for (final Mounted m : entity.getEquipment()) {</b>
<b class="nc">&nbsp;            if (skipMount(m, includeAmmo)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            // Skip armor and structure
<b class="nc">&nbsp;            if (!m.getType().isHittable() &amp;&amp; (m.getLocation() &gt;= 0)) {</b>
<b class="nc">&nbsp;                if ((structure != EquipmentType.T_STRUCTURE_UNKNOWN)</b>
<b class="nc">&nbsp;                        &amp;&amp; (EquipmentType.getStructureType(m.getType()) == structure)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                if ((m.getLocation() &gt;= 0)</b>
<b class="nc">&nbsp;                        &amp;&amp; (entity.getArmorType(m.getLocation()) == EquipmentType.getArmorType(m.getType()))) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (m.isOmniPodMounted() || !entity.isOmni()) {</b>
<b class="nc">&nbsp;                final String loc = formatLocationTableEntry(entity, m);</b>
<b class="nc">&nbsp;                equipment.putIfAbsent(loc, new HashMap&lt;&gt;());</b>
<b class="nc">&nbsp;                equipment.get(loc).merge(new EquipmentKey(m.getType(), m.getSize(), m.isArmored()),</b>
<b class="nc">&nbsp;                        1, Integer::sum);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        final List&lt;Map&lt;String, Object&gt;&gt; eqList = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (final String loc : equipment.keySet()) {</b>
<b class="nc">&nbsp;            for (final Map.Entry&lt;EquipmentKey, Integer&gt; entry : equipment.get(loc).entrySet()) {</b>
<b class="nc">&nbsp;                final EquipmentType eq = entry.getKey().getType();</b>
<b class="nc">&nbsp;                final int count = equipment.get(loc).get(entry.getKey());</b>
<b class="nc">&nbsp;                String name = stripNotes(entry.getKey().name());</b>
<b class="nc">&nbsp;                if (entry.getKey().isArmored()) {</b>
<b class="nc">&nbsp;                    name += &quot; (Armored)&quot;;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (eq instanceof AmmoType) {</b>
<b class="nc">&nbsp;                    name = String.format(&quot;%s (%d)&quot;, name, ((AmmoType) eq).getShots() * count);</b>
<b class="nc">&nbsp;                } else if (count &gt; 1) {</b>
<b class="nc">&nbsp;                    name = String.format(&quot;%d %s&quot;, count, name);</b>
&nbsp;                }
<b class="nc">&nbsp;                final Map&lt;String, Object&gt; fields = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                fields.put(&quot;name&quot;, name);</b>
<b class="nc">&nbsp;                if (name.length() &gt;= nameWidth) {</b>
<b class="nc">&nbsp;                    nameWidth = name.length() + 1;</b>
&nbsp;                }
<b class="nc">&nbsp;                fields.put(&quot;tonnage&quot;, eq.getTonnage(entity, entry.getKey().getSize()) * count);</b>
<b class="nc">&nbsp;                if (eq instanceof WeaponType) {</b>
<b class="nc">&nbsp;                    fields.put(&quot;heat&quot;, eq.getHeat());</b>
<b class="nc">&nbsp;                    fields.put(&quot;srv&quot;, (int) ((WeaponType) eq).getShortAV());</b>
<b class="nc">&nbsp;                    fields.put(&quot;mrv&quot;, (int) ((WeaponType) eq).getMedAV());</b>
<b class="nc">&nbsp;                    fields.put(&quot;lrv&quot;, (int) ((WeaponType) eq).getLongAV());</b>
<b class="nc">&nbsp;                    fields.put(&quot;erv&quot;, (int) ((WeaponType) eq).getExtAV());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    fields.put(&quot;heat&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                    fields.put(&quot;srv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                    fields.put(&quot;mrv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                    fields.put(&quot;lrv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                    fields.put(&quot;erv&quot;, &quot;-&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (eq.isSpreadable()) {</b>
<b class="nc">&nbsp;                    final Map&lt;Integer, Integer&gt; byLoc = getSpreadableLocations(entity, eq);</b>
<b class="nc">&nbsp;                    final StringJoiner locs = new StringJoiner(&quot;/&quot;);</b>
<b class="nc">&nbsp;                    final StringJoiner crits = new StringJoiner(&quot;/&quot;);</b>
<b class="nc">&nbsp;                    byLoc.forEach((l, c) -&gt; {</b>
<b class="nc">&nbsp;                        locs.add(entity.getLocationAbbr(l));</b>
<b class="nc">&nbsp;                        crits.add(String.valueOf(c));</b>
&nbsp;                    });
<b class="nc">&nbsp;                    fields.put(&quot;location&quot;, locs.toString());</b>
<b class="nc">&nbsp;                    fields.put(&quot;slots&quot;, crits.toString());</b>
<b class="nc">&nbsp;                } else {</b>
<b class="nc">&nbsp;                    fields.put(&quot;location&quot;, loc);</b>
<b class="nc">&nbsp;                    fields.put(&quot;slots&quot;, eq.getCriticals(entity, entry.getValue()) * count);</b>
&nbsp;                }
<b class="nc">&nbsp;                eqList.add(fields);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        model.put(&quot;equipment&quot;, eqList);</b>
<b class="nc">&nbsp;        return nameWidth;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Map&lt;Integer, Integer&gt; getSpreadableLocations(final Entity entity, final EquipmentType eq) {
<b class="nc">&nbsp;        final Map&lt;Integer, Integer&gt; retVal = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; entity.locations(); loc++) {</b>
<b class="nc">&nbsp;            for (int slot = 0; slot &lt; entity.getNumberOfCriticals(loc); slot++) {</b>
<b class="nc">&nbsp;                final CriticalSlot crit = entity.getCritical(loc, slot);</b>
<b class="nc">&nbsp;                if ((crit != null) &amp;&amp; (crit.getMount() != null) &amp;&amp; (crit.getMount().getType() == eq)) {</b>
<b class="nc">&nbsp;                    retVal.merge(loc, 1, Integer::sum);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void addFixedOmni(final Entity entity) {
<b class="nc">&nbsp;        double fixedTonnage = 0.0;</b>
<b class="nc">&nbsp;        final List&lt;Map&lt;String, Object&gt;&gt; fixedList = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; entity.locations(); loc++) {</b>
<b class="nc">&nbsp;            if (entity.isAero() &amp;&amp; (loc == Aero.LOC_WINGS)) {</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            }
<b class="nc">&nbsp;            int remaining = 0;</b>
<b class="nc">&nbsp;            final Map&lt;String, Integer&gt; fixedCount = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            final Map&lt;String, Double&gt; fixedWeight = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            for (int slot = 0; slot &lt; entity.getNumberOfCriticals(loc); slot++) {</b>
<b class="nc">&nbsp;                final CriticalSlot crit = entity.getCritical(loc, slot);</b>
<b class="nc">&nbsp;                if (null == crit) {</b>
<b class="nc">&nbsp;                    remaining++;</b>
<b class="nc">&nbsp;                } else if ((crit.getType() == CriticalSlot.TYPE_SYSTEM)</b>
<b class="nc">&nbsp;                        &amp;&amp; showFixedSystem(entity, crit.getIndex(), loc)) {</b>
<b class="nc">&nbsp;                    fixedCount.merge(getSystemName(entity, crit.getIndex()), 1, Integer::sum);</b>
<b class="nc">&nbsp;                } else if (crit.getMount() != null) {</b>
<b class="nc">&nbsp;                    if (crit.getMount().isOmniPodMounted()) {</b>
<b class="nc">&nbsp;                        remaining++;</b>
<b class="nc">&nbsp;                    } else if (!crit.getMount().isWeaponGroup()) {</b>
<b class="nc">&nbsp;                        final String key = stripNotes(crit.getMount().getName());</b>
<b class="nc">&nbsp;                        fixedCount.merge(key, 1, Integer::sum);</b>
<b class="nc">&nbsp;                        fixedWeight.merge(key, crit.getMount().getTonnage(), Double::sum);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;            Map&lt;String, Object&gt; row;
<b class="nc">&nbsp;            if (fixedCount.isEmpty()) {</b>
<b class="nc">&nbsp;                row = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                row.put(&quot;location&quot;, entity.getLocationName(loc));</b>
<b class="nc">&nbsp;                row.put(&quot;equipment&quot;, &quot;None&quot;);</b>
<b class="nc">&nbsp;                row.put(&quot;remaining&quot;, remaining);</b>
<b class="nc">&nbsp;                row.put(&quot;tonnage&quot;, 0.0);</b>
<b class="nc">&nbsp;                row.put(&quot;heat&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                row.put(&quot;srv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                row.put(&quot;mrv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                row.put(&quot;lrv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                row.put(&quot;erv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                fixedList.add(row);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                boolean firstLine = true;</b>
<b class="nc">&nbsp;                for (final Map.Entry&lt;String, Integer&gt; entry : fixedCount.entrySet()) {</b>
<b class="nc">&nbsp;                    row = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                    if (firstLine) {</b>
<b class="nc">&nbsp;                        row.put(&quot;location&quot;, entity.getLocationName(loc));</b>
<b class="nc">&nbsp;                        row.put(&quot;remaining&quot;, remaining);</b>
<b class="nc">&nbsp;                        firstLine = false;</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        row.put(&quot;location&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;                        row.put(&quot;remaining&quot;, &quot;&quot;);</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    if (entry.getValue() &gt; 1) {</b>
<b class="nc">&nbsp;                        row.put(&quot;equipment&quot;, entry.getValue() + &quot; &quot; + entry.getKey());</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        row.put(&quot;equipment&quot;, entry.getKey());</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    if (fixedWeight.containsKey(entry.getKey())) {</b>
&nbsp;                        // Not valid for mech systems
<b class="nc">&nbsp;                        row.put(&quot;tonnage&quot;, fixedWeight.get(entry.getKey()));</b>
<b class="nc">&nbsp;                        fixedTonnage += fixedWeight.get(entry.getKey());</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        row.put(&quot;tonnage&quot;, &quot;&quot;);</b>
&nbsp;                    }
&nbsp;
&nbsp;                    // FIXME : I am not properly implemented, this is a temporary fix for testing
&nbsp;                    // FIXME : and needs to be fixed.
<b class="nc">&nbsp;                    row.put(&quot;heat&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                    row.put(&quot;srv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                    row.put(&quot;mrv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                    row.put(&quot;lrv&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;                    row.put(&quot;erv&quot;, &quot;-&quot;);</b>
&nbsp;
<b class="nc">&nbsp;                    fixedList.add(row);</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        model.put(&quot;fixedEquipment&quot;, fixedList);</b>
<b class="nc">&nbsp;        model.put(&quot;fixedTonnage&quot;, fixedTonnage);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void addTransportBays(Entity entity) {
<b class="nc">&nbsp;        final List&lt;Map&lt;String, Object&gt;&gt; bays = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (final Bay bay : entity.getTransportBays()) {</b>
<b class="nc">&nbsp;            if (bay.isQuarters()) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            final BayData bayData = BayData.getBayType(bay);</b>
<b class="nc">&nbsp;            if (null != bayData) {</b>
<b class="nc">&nbsp;                final Map&lt;String, Object&gt; bayRow = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                bayRow.put(&quot;name&quot;, bayData.getDisplayName());</b>
<b class="nc">&nbsp;                if (bayData.isCargoBay()) {</b>
<b class="nc">&nbsp;                    bayRow.put(&quot;size&quot;, bay.getCapacity() + Messages.getString(&quot;TROView.tons&quot;));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    bayRow.put(&quot;size&quot;, (int) bay.getCapacity());</b>
&nbsp;                }
<b class="nc">&nbsp;                bayRow.put(&quot;doors&quot;, bay.getDoors());</b>
<b class="nc">&nbsp;                bays.add(bayRow);</b>
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                MegaMek.getLogger().warning(&quot;Could not determine bay type for &quot; + bay.toString());</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        setModelData(&quot;bays&quot;, bays);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Used to determine whether system crits should be shown when detailing fixed
&nbsp;     * equipment in an omni unit. By default this is false, but mechs override it to
&nbsp;     * show some systems.
&nbsp;     *
&nbsp;     * @param entity
&nbsp;     *            The unit the TRO is for
&nbsp;     * @param index
&nbsp;     *            The system index of the critical slot
&nbsp;     * @param loc
&nbsp;     *            The slot location
&nbsp;     * @return Whether to show this as a fixed system in an omni configuration
&nbsp;     */
&nbsp;    protected boolean showFixedSystem(Entity entity, int index, int loc) {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Used to show the name of fixed system critical slots in an omni unit. This is
&nbsp;     * only used for Mechs, and returns a default value of &quot;Unknown System&quot; for
&nbsp;     * other units.
&nbsp;     *
&nbsp;     * @param entity
&nbsp;     *            The unit the TRO is for
&nbsp;     * @param index
&nbsp;     *            The system index of the critical slot
&nbsp;     * @return The name of the system to display in the fixed equipment table
&nbsp;     */
&nbsp;    protected String getSystemName(Entity entity, int index) {
<b class="nc">&nbsp;        return &quot;Unknown System&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Formats displayable location name for use in equipment table. The format of
&nbsp;     * the name can vary by unit type due to available space based on number of
&nbsp;     * columns, and in some cases the official TROs have different location names
&nbsp;     * than the ones used by MM.
&nbsp;     *
&nbsp;     * @param entity
&nbsp;     *            The entity the TRO is created for
&nbsp;     * @param mounted
&nbsp;     *            The mounted equipment
&nbsp;     * @return The location name to use in the table.
&nbsp;     */
&nbsp;    protected String formatLocationTableEntry(Entity entity, Mounted mounted) {
&nbsp;        // Default: location abbreviation
<b class="nc">&nbsp;        return entity.getLocationAbbr(mounted.getLocation());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Formats {@link Transporter} to display as a row in an equipment table. Any
&nbsp;     * other than bays and troop space are skipped to avoid showing BA handles and
&nbsp;     * such.
&nbsp;     *
&nbsp;     * @param transporter
&nbsp;     *            The transporter to show.
&nbsp;     * @param loc
&nbsp;     *            The location name to display on the table.
&nbsp;     * @return A map of values used by the equipment tables (omni fixed and
&nbsp;     *         pod/non-omni). Returns {@code null} for a type of {@link Transporter}
&nbsp;     *         that should not be shown.
&nbsp;     */
&nbsp;    protected @Nullable Map&lt;String, Object&gt; formatTransporter(Transporter transporter, String loc) {
<b class="nc">&nbsp;        final Map&lt;String, Object&gt; retVal = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        if (transporter instanceof TroopSpace) {</b>
<b class="nc">&nbsp;            retVal.put(&quot;name&quot;, Messages.getString(&quot;TROView.TroopSpace&quot;));</b>
<b class="nc">&nbsp;            retVal.put(&quot;tonnage&quot;, transporter.getUnused());</b>
<b class="nc">&nbsp;        } else if (transporter instanceof Bay) {</b>
<b class="nc">&nbsp;            final BayData bayType = BayData.getBayType((Bay) transporter);</b>
<b class="nc">&nbsp;            retVal.put(&quot;name&quot;, bayType.getDisplayName());</b>
<b class="nc">&nbsp;            retVal.put(&quot;tonnage&quot;, bayType.getWeight() * transporter.getUnused());</b>
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        retVal.put(&quot;equipment&quot;, retVal.get(&quot;name&quot;));</b>
<b class="nc">&nbsp;        retVal.put(&quot;location&quot;, loc);</b>
<b class="nc">&nbsp;        retVal.put(&quot;slots&quot;, 1);</b>
<b class="nc">&nbsp;        retVal.put(&quot;heat&quot;, &quot;-&quot;);</b>
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    protected enum Justification {</b>
<b class="nc">&nbsp;        LEFT((str, w) -&gt; String.format(&quot;%-&quot; + w + &quot;s&quot;, str)), CENTER((str, w) -&gt; {</b>
<b class="nc">&nbsp;            if (w &gt; str.length()) {</b>
<b class="nc">&nbsp;                final int rightPadding = Math.max(0, (w - str.length()) / 2);</b>
<b class="nc">&nbsp;                if (rightPadding &gt; 0) {</b>
<b class="nc">&nbsp;                    str = String.format(&quot;%-&quot; + (w - rightPadding) + &quot;s&quot;, str);</b>
&nbsp;                }
<b class="nc">&nbsp;                return String.format(&quot;%&quot; + w + &quot;s&quot;, str);</b>
&nbsp;            }
<b class="nc">&nbsp;            return str;</b>
<b class="nc">&nbsp;        }), RIGHT((str, w) -&gt; String.format(&quot;%&quot; + w + &quot;s&quot;, str));</b>
&nbsp;
&nbsp;        final private BiFunction&lt;String, Integer, String&gt; pad;
&nbsp;
<b class="nc">&nbsp;        Justification(BiFunction&lt;String, Integer, String&gt; pad) {</b>
<b class="nc">&nbsp;            this.pad = pad;</b>
&nbsp;        }
&nbsp;
&nbsp;        public String padString(String str, int fieldWidth) {
<b class="nc">&nbsp;            if (fieldWidth &gt; 0) {</b>
<b class="nc">&nbsp;                return pad.apply(str, fieldWidth);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return str;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Removes parenthetical and bracketed notes from a String, with the exception
&nbsp;     * of parenthetical notes that begin with a digit. These are assumed to be
&nbsp;     * a marker of equipment size and left intact.
&nbsp;     *
&nbsp;     * @param str The String to process
&nbsp;     * @return     The same String with notes removed
&nbsp;     */
&nbsp;    protected String stripNotes(String str) {
<b class="nc">&nbsp;        return str.replaceAll(&quot;\\s+\\[.*?]&quot;, &quot;&quot;)</b>
<b class="nc">&nbsp;                .replaceAll(&quot;\\s+\\([^\\d].*?\\)&quot;, &quot;&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected static class FormatTableRowMethod implements TemplateMethodModelEx {
&nbsp;        final private int[] colWidths;
&nbsp;        final private Justification[] justification;
&nbsp;
<b class="nc">&nbsp;        public FormatTableRowMethod(int[] widths, Justification[] justify) {</b>
<b class="nc">&nbsp;            colWidths = new int[widths.length];</b>
<b class="nc">&nbsp;            justification = new Justification[widths.length];</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; widths.length; i++) {</b>
<b class="nc">&nbsp;                colWidths[i] = widths[i];</b>
<b class="nc">&nbsp;                if (i &lt; justify.length) {</b>
<b class="nc">&nbsp;                    justification[i] = justify[i];</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    justification[i] = Justification.LEFT;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            System.arraycopy(widths, 0, colWidths, 0, widths.length);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Object exec(List arguments) {
<b class="nc">&nbsp;            final StringBuilder sb = new StringBuilder();</b>
<b class="nc">&nbsp;            int col = 0;</b>
<b class="nc">&nbsp;            for (final Object o : arguments) {</b>
<b class="nc">&nbsp;                if (col &lt; colWidths.length) {</b>
<b class="nc">&nbsp;                    sb.append(justification[col].padString(o.toString(), colWidths[col]));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    sb.append(o);</b>
&nbsp;                }
<b class="nc">&nbsp;                col++;</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            return sb.toString();</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets whether to include the fluff section when processing the template
&nbsp;     *
&nbsp;     * @param includeFluff
&nbsp;     *            Whether to include the fluff section
&nbsp;     */
&nbsp;    public void setIncludeFluff(boolean includeFluff) {
<b class="nc">&nbsp;        this.includeFluff = includeFluff;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *
&nbsp;     * @return Whether the fluff section will be included when processing the
&nbsp;     *         template
&nbsp;     */
&nbsp;    public boolean getIncludeFluff() {
<b class="nc">&nbsp;        return includeFluff;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Tuple composed of EquipmentType and size, used for map keys
&nbsp;     */
&nbsp;    static final class EquipmentKey {
&nbsp;        private final EquipmentType etype;
&nbsp;        private final double size;
&nbsp;        private final boolean armored;
&nbsp;
&nbsp;        EquipmentKey(EquipmentType etype, double size) {
<b class="nc">&nbsp;            this(etype, size, false);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        EquipmentKey(EquipmentType etype, double size, boolean armored) {</b>
<b class="nc">&nbsp;            this.etype = etype;</b>
<b class="nc">&nbsp;            this.size = size;</b>
<b class="nc">&nbsp;            this.armored = armored;</b>
&nbsp;        }
&nbsp;
&nbsp;        String name() {
<b class="nc">&nbsp;            return etype.getName(size);</b>
&nbsp;        }
&nbsp;
&nbsp;        EquipmentType getType() {
<b class="nc">&nbsp;            return etype;</b>
&nbsp;        }
&nbsp;
&nbsp;        double getSize() {
<b class="nc">&nbsp;            return size;</b>
&nbsp;        }
&nbsp;
&nbsp;        boolean isArmored() {
<b class="nc">&nbsp;            return armored;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public boolean equals(Object o) {
<b class="nc">&nbsp;            return (o instanceof EquipmentKey)</b>
<b class="nc">&nbsp;                    &amp;&amp; (etype.equals(((EquipmentKey) o).etype))</b>
&nbsp;                    &amp;&amp; (size == ((EquipmentKey) o).size)
&nbsp;                    &amp;&amp; (armored == ((EquipmentKey) o).armored);
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int hashCode() {
<b class="nc">&nbsp;            return Objects.hash(etype, size, armored);</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
