


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ForceGeneratorOptionsView</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ui.swing</a>
</div>

<h1>Coverage Summary for Class: ForceGeneratorOptionsView (megamek.client.ui.swing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ForceGeneratorOptionsView</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/671)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ForceGeneratorOptionsView$CBRenderer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ForceGeneratorOptionsView$ForceTreeModel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ForceGeneratorOptionsView$GenerateTask</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ForceGeneratorOptionsView$UnitRenderer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/50)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/759)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * 
&nbsp; */
&nbsp;package megamek.client.ui.swing;
&nbsp;
&nbsp;import java.awt.Component;
&nbsp;import java.awt.GridBagConstraints;
&nbsp;import java.awt.GridBagLayout;
&nbsp;import java.awt.GridLayout;
&nbsp;import java.awt.Insets;
&nbsp;import java.awt.event.ActionEvent;
&nbsp;import java.awt.event.ActionListener;
&nbsp;import java.awt.event.FocusEvent;
&nbsp;import java.awt.event.FocusListener;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.concurrent.ExecutionException;
&nbsp;import java.util.function.Consumer;
&nbsp;import java.util.function.Function;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import javax.swing.BorderFactory;
&nbsp;import javax.swing.DefaultListCellRenderer;
&nbsp;import javax.swing.JButton;
&nbsp;import javax.swing.JCheckBox;
&nbsp;import javax.swing.JComboBox;
&nbsp;import javax.swing.JLabel;
&nbsp;import javax.swing.JList;
&nbsp;import javax.swing.JPanel;
&nbsp;import javax.swing.JTextField;
&nbsp;import javax.swing.JTree;
&nbsp;import javax.swing.ProgressMonitor;
&nbsp;import javax.swing.SwingWorker;
&nbsp;import javax.swing.UIManager;
&nbsp;import javax.swing.event.TreeModelListener;
&nbsp;import javax.swing.tree.DefaultTreeCellRenderer;
&nbsp;import javax.swing.tree.TreeModel;
&nbsp;import javax.swing.tree.TreePath;
&nbsp;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.client.ratgenerator.AbstractUnitRecord;
&nbsp;import megamek.client.ratgenerator.CrewDescriptor;
&nbsp;import megamek.client.ratgenerator.FactionRecord;
&nbsp;import megamek.client.ratgenerator.ForceDescriptor;
&nbsp;import megamek.client.ratgenerator.ForceNode;
&nbsp;import megamek.client.ratgenerator.MissionRole;
&nbsp;import megamek.client.ratgenerator.RATGenerator;
&nbsp;import megamek.client.ratgenerator.Ruleset;
&nbsp;import megamek.client.ratgenerator.TOCNode;
&nbsp;import megamek.client.ratgenerator.ValueNode;
&nbsp;import megamek.client.ui.Messages;
&nbsp;import megamek.common.Entity;
&nbsp;import megamek.common.EntityWeightClass;
&nbsp;import megamek.common.Game;
&nbsp;import megamek.common.Player;
&nbsp;import megamek.common.UnitType;
&nbsp;import megamek.common.options.OptionsConstants;
&nbsp;
&nbsp;/**
&nbsp; * Controls to set options for force generator.
&nbsp; * 
&nbsp; * @author Neoancient
&nbsp; *
&nbsp; */
&nbsp;
&nbsp;
<b class="nc">&nbsp;public class ForceGeneratorOptionsView extends JPanel implements FocusListener, ActionListener {</b>
&nbsp;
&nbsp;    private static final long serialVersionUID = 5269823128861856001L;
&nbsp;
&nbsp;    private int currentYear;
<b class="nc">&nbsp;    private Consumer&lt;ForceDescriptor&gt; onGenerate = null;</b>
&nbsp;
<b class="nc">&nbsp;    private ForceDescriptor forceDesc = new ForceDescriptor();</b>
&nbsp;
&nbsp;    private JTextField txtYear;
&nbsp;    private JComboBox&lt;FactionRecord&gt; cbFaction;
&nbsp;    private JComboBox&lt;FactionRecord&gt; cbSubfaction;
&nbsp;    private JComboBox&lt;Integer&gt; cbUnitType;	
&nbsp;    private JComboBox&lt;String&gt; cbFormation;
&nbsp;    private JComboBox&lt;String&gt; cbRating;
&nbsp;    private JComboBox&lt;String&gt; cbFlags;
&nbsp;
&nbsp;    private JComboBox&lt;String&gt; cbExperience;
&nbsp;    private JComboBox&lt;Integer&gt; cbWeightClass;
&nbsp;    private JCheckBox chkAttachments;
&nbsp;
<b class="nc">&nbsp;    private DefaultListCellRenderer factionRenderer = new CBRenderer&lt;FactionRecord&gt;</b>
<b class="nc">&nbsp;    (Messages.getString(&quot;ForceGeneratorDialog.general&quot;),</b>
<b class="nc">&nbsp;            fRec -&gt; fRec.getName(currentYear));</b>
&nbsp;
<b class="nc">&nbsp;    private HashMap&lt;String,String&gt; ratingDisplayNames = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private HashMap&lt;String,String&gt; formationDisplayNames = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private HashMap&lt;String,String&gt; flagDisplayNames = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    private JPanel panGroundRole;
&nbsp;    private JPanel panInfRole;
&nbsp;    private JPanel panAirRole;
&nbsp;
&nbsp;    private JCheckBox chkRoleRecon;
&nbsp;    private JCheckBox chkRoleFireSupport;
&nbsp;    private JCheckBox chkRoleUrban;
&nbsp;    private JCheckBox chkRoleInfantrySupport;
&nbsp;    private JCheckBox chkRoleCavalry;
&nbsp;    private JCheckBox chkRoleRaider;
&nbsp;    private JCheckBox chkRoleIncindiary;
&nbsp;    private JCheckBox chkRoleAntiAircraft;
&nbsp;    private JCheckBox chkRoleAntiInfantry;	
&nbsp;    private JCheckBox chkRoleArtillery;
&nbsp;    private JCheckBox chkRoleMissileArtillery;
&nbsp;    private JCheckBox chkRoleTransport;
&nbsp;    private JCheckBox chkRoleEngineer;
&nbsp;
&nbsp;    private JCheckBox chkRoleFieldGun;
&nbsp;    private JCheckBox chkRoleFieldArtillery;
&nbsp;    private JCheckBox chkRoleFieldMissileArtillery;
&nbsp;
&nbsp;    private JCheckBox chkRoleAirRecon;
&nbsp;    private JCheckBox chkRoleGroundSupport;
&nbsp;    private JCheckBox chkRoleInterceptor;
&nbsp;    private JCheckBox chkRoleEscort;
&nbsp;    private JCheckBox chkRoleBomber;
&nbsp;    private JCheckBox chkRoleAssault;
&nbsp;    private JCheckBox chkRoleAirTransport;
&nbsp;
&nbsp;    private JTextField txtDropshipPct;
&nbsp;    private JTextField txtJumpshipPct;
&nbsp;    private JTextField txtCargo;
&nbsp;
&nbsp;    private JButton btnGenerate;
&nbsp;    private JButton btnExportMUL;
&nbsp;    private JButton btnClear;
&nbsp;
&nbsp;    private ClientGUI clientGui;
&nbsp;
<b class="nc">&nbsp;    public ForceGeneratorOptionsView(ClientGUI gui, Consumer&lt;ForceDescriptor&gt; onGenerate) {</b>
<b class="nc">&nbsp;        clientGui = gui;</b>
<b class="nc">&nbsp;        this.onGenerate = onGenerate;</b>
<b class="nc">&nbsp;        if (!Ruleset.isInitialized()) {</b>
<b class="nc">&nbsp;            Ruleset.loadData();</b>
&nbsp;        }
<b class="nc">&nbsp;        initUi();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void initUi() {
<b class="nc">&nbsp;        currentYear = clientGui.getClient().getGame().getOptions().intOption(OptionsConstants.ALLOWED_YEAR);</b>
<b class="nc">&nbsp;        forceDesc.setYear(currentYear);</b>
<b class="nc">&nbsp;        RATGenerator rg = RATGenerator.getInstance();</b>
<b class="nc">&nbsp;        rg.loadYear(currentYear);</b>
&nbsp;
<b class="nc">&nbsp;        setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints gbc = new GridBagConstraints();</b>
<b class="nc">&nbsp;        gbc.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gbc.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        gbc.insets = new Insets(5, 5, 5, 5);</b>
&nbsp;
<b class="nc">&nbsp;        int y = 0;</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.year&quot;)), gbc); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        txtYear = new JTextField();</b>
<b class="nc">&nbsp;        txtYear.setEditable(true);</b>
<b class="nc">&nbsp;        txtYear.setText(Integer.toString(currentYear));</b>
<b class="nc">&nbsp;        txtYear.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.year.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        add(txtYear, gbc);</b>
<b class="nc">&nbsp;        txtYear.addFocusListener(this);</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.faction&quot;)), gbc); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbFaction = new JComboBox&lt;&gt;();</b>
<b class="nc">&nbsp;        cbFaction.setRenderer(factionRenderer);</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(cbFaction, gbc);</b>
<b class="nc">&nbsp;        cbFaction.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.faction.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbFaction.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.subfaction&quot;)), gbc); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbSubfaction = new JComboBox&lt;&gt;();</b>
<b class="nc">&nbsp;        cbSubfaction.setRenderer(factionRenderer);</b>
<b class="nc">&nbsp;        gbc.gridx = 3;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        add(cbSubfaction, gbc);</b>
<b class="nc">&nbsp;        cbSubfaction.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.subfaction.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbSubfaction.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.unitType&quot;)), gbc);</b>
<b class="nc">&nbsp;        cbUnitType = new JComboBox&lt;Integer&gt;();</b>
<b class="nc">&nbsp;        cbUnitType.setRenderer(new CBRenderer&lt;Integer&gt;(Messages.getString(&quot;ForceGeneratorDialog.combined&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                ut -&gt; UnitType.getTypeName(ut)));</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(cbUnitType, gbc);</b>
<b class="nc">&nbsp;        cbUnitType.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.unitType.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbUnitType.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.formation&quot;)), gbc); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbFormation = new JComboBox&lt;&gt;();</b>
<b class="nc">&nbsp;        cbFormation.setRenderer(new CBRenderer&lt;String&gt;(Messages.getString(&quot;ForceGeneratorDialog.random&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                f -&gt; formationDisplayNames.get(f)));</b>
<b class="nc">&nbsp;        gbc.gridx = 3;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        add(cbFormation, gbc);</b>
<b class="nc">&nbsp;        cbFormation.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.formation.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbFormation.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.rating&quot;)), gbc); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbRating = new JComboBox&lt;&gt;();</b>
<b class="nc">&nbsp;        cbRating.setRenderer(new CBRenderer&lt;String&gt;(Messages.getString(&quot;ForceGeneratorDialog.random&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                r -&gt; ratingDisplayNames.get(r)));</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(cbRating, gbc);</b>
<b class="nc">&nbsp;        cbRating.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.rating.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbRating.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.weight&quot;)), gbc); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbWeightClass = new JComboBox&lt;Integer&gt;();</b>
<b class="nc">&nbsp;        cbWeightClass.setRenderer(new CBRenderer&lt;Integer&gt;(Messages.getString(&quot;ForceGeneratorDialog.random&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                wc -&gt; EntityWeightClass.getClassName(wc)));</b>
<b class="nc">&nbsp;        cbWeightClass.addItem(null);</b>
<b class="nc">&nbsp;        cbWeightClass.addItem(EntityWeightClass.WEIGHT_LIGHT);</b>
<b class="nc">&nbsp;        cbWeightClass.addItem(EntityWeightClass.WEIGHT_MEDIUM);</b>
<b class="nc">&nbsp;        cbWeightClass.addItem(EntityWeightClass.WEIGHT_HEAVY);</b>
<b class="nc">&nbsp;        cbWeightClass.addItem(EntityWeightClass.WEIGHT_ASSAULT);</b>
<b class="nc">&nbsp;        gbc.gridx = 3;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        add(cbWeightClass, gbc);</b>
<b class="nc">&nbsp;        cbWeightClass.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.weight.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbWeightClass.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.other&quot;)), gbc); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbFlags = new JComboBox&lt;&gt;();</b>
<b class="nc">&nbsp;        cbFlags.setRenderer(new CBRenderer&lt;String&gt;(&quot;---&quot;,</b>
<b class="nc">&nbsp;                f -&gt; flagDisplayNames.get(f)));</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(cbFlags, gbc);</b>
<b class="nc">&nbsp;        cbFlags.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.other.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbFlags.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.experience&quot;)), gbc); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbExperience = new JComboBox&lt;String&gt;();</b>
<b class="nc">&nbsp;        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.random&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.green&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.regular&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.veteran&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.elite&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        gbc.gridx = 3;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        add(cbExperience, gbc);</b>
<b class="nc">&nbsp;        cbExperience.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.experience.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cbExperience.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        gbc.gridwidth = 2;</b>
<b class="nc">&nbsp;        chkAttachments = new JCheckBox(Messages.getString(&quot;ForceGeneratorDialog.includeSupportForces&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        chkAttachments.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.includeSupportForces.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        chkAttachments.setSelected(true);</b>
<b class="nc">&nbsp;        add(chkAttachments, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridwidth = 4;</b>
<b class="nc">&nbsp;        panGroundRole = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        add(panGroundRole, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        panInfRole = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        add(panInfRole, gbc);</b>
<b class="nc">&nbsp;        panInfRole.setVisible(false);</b>
&nbsp;
<b class="nc">&nbsp;        panAirRole = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        add(panAirRole, gbc);</b>
<b class="nc">&nbsp;        panAirRole.setVisible(false);</b>
&nbsp;
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
&nbsp;
<b class="nc">&nbsp;        JPanel panTransport = new JPanel(new GridLayout(3, 2));</b>
<b class="nc">&nbsp;        txtDropshipPct = new JTextField(&quot;0&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        txtDropshipPct.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.dropshipPercentage.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        txtJumpshipPct = new JTextField(&quot;0&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        txtJumpshipPct.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.jumpshipPercentage.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        txtCargo = new JTextField(&quot;0&quot;);</b>
<b class="nc">&nbsp;        panTransport.add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.dropshipPercentage&quot;))); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        panTransport.add(txtDropshipPct, gbc);</b>
<b class="nc">&nbsp;        panTransport.add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.jumpshipPercentage&quot;))); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        panTransport.add(txtJumpshipPct, gbc);</b>
&nbsp;        // Cargo needs more work to select cargo dropships.
&nbsp;        //        panTransport.add(new JLabel(&quot;Cargo Tonnage:&quot;));
&nbsp;        //        panTransport.add(txtCargo, gbc);
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y++;</b>
<b class="nc">&nbsp;        gbc.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;        panTransport.setBorder(BorderFactory.createTitledBorder(Messages.getString(&quot;ForceGeneratorDialog.transport&quot;))); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        add(panTransport, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        btnGenerate = new JButton(Messages.getString(&quot;ForceGeneratorDialog.generate&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        btnGenerate.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.generate.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        gbc.gridwidth = 1;</b>
<b class="nc">&nbsp;        gbc.weighty = 1.0;</b>
<b class="nc">&nbsp;        add(btnGenerate, gbc);</b>
<b class="nc">&nbsp;        btnGenerate.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        btnExportMUL = new JButton(Messages.getString(&quot;ForceGeneratorDialog.exportMUL&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        btnExportMUL.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.exportMUL.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        add(btnExportMUL, gbc);</b>
<b class="nc">&nbsp;        btnExportMUL.addActionListener(this);</b>
<b class="nc">&nbsp;        btnExportMUL.setEnabled(false);</b>
&nbsp;
<b class="nc">&nbsp;        btnClear = new JButton(Messages.getString(&quot;ForceGeneratorDialog.clear&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        btnClear.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.clear.tooltip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = y;</b>
<b class="nc">&nbsp;        gbc.weighty = 1.0;</b>
<b class="nc">&nbsp;        add(btnClear, gbc);</b>
<b class="nc">&nbsp;        btnClear.addActionListener(this);</b>
<b class="nc">&nbsp;        btnClear.setEnabled(false);</b>
&nbsp;
<b class="nc">&nbsp;        gbc = new GridBagConstraints();</b>
<b class="nc">&nbsp;        gbc.anchor = GridBagConstraints.NORTHWEST;</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleRecon = createMissionRoleCheck(MissionRole.RECON);</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleRecon, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleFireSupport = createMissionRoleCheck(MissionRole.FIRE_SUPPORT);</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleFireSupport, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleUrban = createMissionRoleCheck(MissionRole.URBAN);</b>
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleUrban, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleCavalry = createMissionRoleCheck(MissionRole.CAVALRY);</b>
<b class="nc">&nbsp;        gbc.gridx = 3;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleCavalry, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleRaider = createMissionRoleCheck(MissionRole.RAIDER);</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = 1;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleRaider, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleIncindiary = createMissionRoleCheck(MissionRole.INCENDIARY);</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = 1;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleIncindiary, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleAntiAircraft = createMissionRoleCheck(MissionRole.ANTI_AIRCRAFT);</b>
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = 1;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleAntiAircraft, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleAntiInfantry = createMissionRoleCheck(MissionRole.ANTI_INFANTRY);</b>
<b class="nc">&nbsp;        gbc.gridx = 3;</b>
<b class="nc">&nbsp;        gbc.gridy = 1;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleAntiInfantry, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleArtillery = createMissionRoleCheck(MissionRole.ARTILLERY);</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = 2;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleArtillery, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleMissileArtillery = createMissionRoleCheck(MissionRole.MISSILE_ARTILLERY);</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = 2;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleMissileArtillery, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleInfantrySupport = createMissionRoleCheck(MissionRole.INF_SUPPORT);</b>
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = 2;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleInfantrySupport, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleTransport = createMissionRoleCheck(MissionRole.CARGO);</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = 3;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleTransport, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleEngineer = createMissionRoleCheck(MissionRole.ENGINEER);</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = 3;</b>
<b class="nc">&nbsp;        panGroundRole.add(chkRoleEngineer, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        gbc = new GridBagConstraints();</b>
<b class="nc">&nbsp;        gbc.anchor = GridBagConstraints.NORTHWEST;</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleFieldGun = createMissionRoleCheck(MissionRole.FIELD_GUN);</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panInfRole.add(chkRoleFieldGun, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleFieldArtillery = createMissionRoleCheck(MissionRole.ARTILLERY);</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panInfRole.add(chkRoleFieldArtillery, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleFieldMissileArtillery = createMissionRoleCheck(MissionRole.MISSILE_ARTILLERY);</b>
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panInfRole.add(chkRoleFieldMissileArtillery, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        gbc = new GridBagConstraints();</b>
<b class="nc">&nbsp;        gbc.anchor = GridBagConstraints.NORTHWEST;</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleAirRecon = createMissionRoleCheck(MissionRole.RECON);</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panAirRole.add(chkRoleAirRecon, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleGroundSupport = createMissionRoleCheck(MissionRole.GROUND_SUPPORT);</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panAirRole.add(chkRoleGroundSupport, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleInterceptor = createMissionRoleCheck(MissionRole.INTERCEPTOR);</b>
<b class="nc">&nbsp;        gbc.gridx = 2;</b>
<b class="nc">&nbsp;        gbc.gridy = 0;</b>
<b class="nc">&nbsp;        panAirRole.add(chkRoleInterceptor, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleEscort = createMissionRoleCheck(MissionRole.ESCORT);</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = 1;</b>
<b class="nc">&nbsp;        panAirRole.add(chkRoleEscort, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleBomber = createMissionRoleCheck(MissionRole.BOMBER);</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = 1;</b>
<b class="nc">&nbsp;        panAirRole.add(chkRoleBomber, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleAssault = createMissionRoleCheck(MissionRole.ASSAULT);</b>
<b class="nc">&nbsp;        gbc.gridx = 0;</b>
<b class="nc">&nbsp;        gbc.gridy = 2;</b>
<b class="nc">&nbsp;        panAirRole.add(chkRoleAssault, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        chkRoleAirTransport = createMissionRoleCheck(MissionRole.CARGO);</b>
<b class="nc">&nbsp;        gbc.gridx = 1;</b>
<b class="nc">&nbsp;        gbc.gridy = 2;</b>
<b class="nc">&nbsp;        panAirRole.add(chkRoleAirTransport, gbc);</b>
&nbsp;
<b class="nc">&nbsp;        refreshFactions();</b>
&nbsp;    }
&nbsp;
&nbsp;    private JCheckBox createMissionRoleCheck(MissionRole role) {
<b class="nc">&nbsp;        String key = &quot;MissionRole.&quot; + role.toString().toLowerCase();</b>
<b class="nc">&nbsp;        JCheckBox chk = new JCheckBox(Messages.getString(key));</b>
<b class="nc">&nbsp;        chk.setToolTipText(Messages.getString(key + &quot;.tooltip&quot;));</b>
<b class="nc">&nbsp;        return chk;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void generateForce() {
<b class="nc">&nbsp;        ForceDescriptor fd = new ForceDescriptor();</b>
<b class="nc">&nbsp;        fd.setTopLevel(true);</b>
<b class="nc">&nbsp;        fd.setYear(forceDesc.getYear());</b>
<b class="nc">&nbsp;        fd.setFaction(forceDesc.getFaction());</b>
<b class="nc">&nbsp;        fd.setUnitType(forceDesc.getUnitType());</b>
<b class="nc">&nbsp;        fd.setEschelon(forceDesc.getEschelon());</b>
<b class="nc">&nbsp;        fd.setAugmented(forceDesc.isAugmented());</b>
<b class="nc">&nbsp;        fd.setSizeMod(forceDesc.getSizeMod());</b>
<b class="nc">&nbsp;        fd.getFlags().addAll(forceDesc.getFlags());</b>
<b class="nc">&nbsp;        fd.setRating(forceDesc.getRating());</b>
<b class="nc">&nbsp;        if (forceDesc.getExperience() != null) {</b>
<b class="nc">&nbsp;            fd.setExperience(forceDesc.getExperience());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            fd.setExperience(CrewDescriptor.randomExperienceLevel());</b>
&nbsp;        }
<b class="nc">&nbsp;        fd.setWeightClass(forceDesc.getWeightClass());</b>
<b class="nc">&nbsp;        fd.setAttachments(chkAttachments.isSelected());</b>
<b class="nc">&nbsp;        if (forceDesc.getUnitType() != null) {</b>
<b class="nc">&nbsp;            switch (forceDesc.getUnitType()) {</b>
&nbsp;            case UnitType.MEK:case UnitType.TANK:
<b class="nc">&nbsp;                if (chkRoleRecon.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.RECON);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleFireSupport.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.FIRE_SUPPORT);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleUrban.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.URBAN);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleInfantrySupport.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.INF_SUPPORT);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleCavalry.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.CAVALRY);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleRaider.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.RAIDER);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleIncindiary.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.INCENDIARY);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleAntiAircraft.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.ANTI_AIRCRAFT);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleAntiInfantry.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.ANTI_INFANTRY);</b>
&nbsp;                }			
<b class="nc">&nbsp;                if (chkRoleArtillery.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.ARTILLERY);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleMissileArtillery.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.MISSILE_ARTILLERY);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleTransport.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.CARGO);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleEngineer.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.ENGINEER);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case UnitType.INFANTRY:
&nbsp;            case UnitType.BATTLE_ARMOR:
<b class="nc">&nbsp;                if (chkRoleFieldGun.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.FIELD_GUN);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleFieldArtillery.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.ARTILLERY);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleFieldMissileArtillery.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.MISSILE_ARTILLERY);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case UnitType.AERO:
<b class="nc">&nbsp;                if (chkRoleAirRecon.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.RECON);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleGroundSupport.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.GROUND_SUPPORT);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleInterceptor.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.INTERCEPTOR);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleAssault.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.ASSAULT);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (chkRoleAirTransport.isSelected()) {</b>
<b class="nc">&nbsp;                    fd.getRoles().add(MissionRole.CARGO);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            fd.setDropshipPct(Double.parseDouble(txtDropshipPct.getText()) * 0.01);</b>
<b class="nc">&nbsp;        } catch (NumberFormatException ex) {</b>
<b class="nc">&nbsp;            fd.setDropshipPct(0.0);</b>
<b class="nc">&nbsp;            txtDropshipPct.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        try {
<b class="nc">&nbsp;            fd.setJumpshipPct(Double.parseDouble(txtJumpshipPct.getText()) * 0.01);</b>
<b class="nc">&nbsp;        } catch (NumberFormatException ex) {</b>
<b class="nc">&nbsp;            fd.setJumpshipPct(0.0);</b>
<b class="nc">&nbsp;            txtJumpshipPct.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        try {
<b class="nc">&nbsp;            fd.setCargo(Double.parseDouble(txtCargo.getText()));</b>
<b class="nc">&nbsp;        } catch (NumberFormatException ex) {</b>
<b class="nc">&nbsp;            fd.setCargo(0.0);</b>
<b class="nc">&nbsp;            txtCargo.setText(&quot;0&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        ProgressMonitor monitor = new ProgressMonitor(this, Messages.getString(&quot;ForceGeneratorDialog.generateFormation&quot;), &quot;&quot;, 0, 100);</b>
<b class="nc">&nbsp;        monitor.setProgress(0);</b>
<b class="nc">&nbsp;        GenerateTask task = new GenerateTask(fd);</b>
<b class="nc">&nbsp;        task.addPropertyChangeListener(e -&gt; {</b>
<b class="nc">&nbsp;            monitor.setProgress(task.getProgress());</b>
<b class="nc">&nbsp;            monitor.setNote(task.getMessage());</b>
<b class="nc">&nbsp;            if (monitor.isCanceled()) {</b>
<b class="nc">&nbsp;                task.cancel(true);</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        task.execute();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void clearForce() {
<b class="nc">&nbsp;        if (null != onGenerate) {</b>
<b class="nc">&nbsp;            onGenerate.accept(null);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void refreshFactions() {
<b class="nc">&nbsp;        FactionRecord oldFaction = (FactionRecord)cbFaction.getSelectedItem();</b>
<b class="nc">&nbsp;        cbFaction.removeActionListener(this);</b>
<b class="nc">&nbsp;        cbFaction.removeAllItems();</b>
<b class="nc">&nbsp;        List&lt;FactionRecord&gt; sorted = RATGenerator.getInstance().getFactionList()</b>
<b class="nc">&nbsp;                .stream().filter(fr -&gt; !fr.getKey().contains(&quot;.&quot;) &amp;&amp; fr.isActiveInYear(currentYear))</b>
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
<b class="nc">&nbsp;        sorted.sort((fr1, fr2) -&gt; fr1.getName(currentYear).compareTo(fr2.getName(currentYear)));</b>
<b class="nc">&nbsp;        sorted.forEach(fr -&gt; cbFaction.addItem(fr));</b>
<b class="nc">&nbsp;        cbFaction.setSelectedItem(oldFaction);</b>
<b class="nc">&nbsp;        if (cbFaction.getSelectedItem() == null ||</b>
<b class="nc">&nbsp;                !cbFaction.getSelectedItem().toString().equals(oldFaction.toString())) {</b>
<b class="nc">&nbsp;            cbFaction.setSelectedItem(RATGenerator.getInstance().getFaction(&quot;IS&quot;));</b>
&nbsp;        }
<b class="nc">&nbsp;        forceDesc.setFaction(cbFaction.getSelectedItem().toString());</b>
<b class="nc">&nbsp;        refreshSubfactions();</b>
<b class="nc">&nbsp;        cbFaction.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshSubfactions() {
<b class="nc">&nbsp;        FactionRecord oldFaction = (FactionRecord)cbSubfaction.getSelectedItem();</b>
<b class="nc">&nbsp;        cbSubfaction.removeActionListener(this);</b>
<b class="nc">&nbsp;        cbSubfaction.removeAllItems();</b>
<b class="nc">&nbsp;        String currentFaction = ((FactionRecord)cbFaction.getSelectedItem()).getKey();</b>
<b class="nc">&nbsp;        if (currentFaction != null) {</b>
<b class="nc">&nbsp;            List&lt;FactionRecord&gt; sorted = RATGenerator.getInstance().getFactionList().stream()</b>
<b class="nc">&nbsp;                    .filter(fr -&gt; fr.getKey().startsWith(currentFaction + &quot;.&quot;)</b>
<b class="nc">&nbsp;                            &amp;&amp; fr.isActiveInYear(currentYear))</b>
<b class="nc">&nbsp;                    .collect(Collectors.toList());</b>
<b class="nc">&nbsp;            sorted.sort((fr1, fr2) -&gt; fr1.getName(currentYear).compareTo(fr2.getName(currentYear)));</b>
<b class="nc">&nbsp;            cbSubfaction.addItem(null);</b>
<b class="nc">&nbsp;            sorted.forEach(fr -&gt; cbSubfaction.addItem(fr));</b>
&nbsp;        }
<b class="nc">&nbsp;        cbSubfaction.setSelectedItem(oldFaction);</b>
<b class="nc">&nbsp;        if (cbSubfaction.getSelectedItem() == null) {</b>
<b class="nc">&nbsp;            forceDesc.setFaction(cbFaction.getSelectedItem().toString());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            forceDesc.setFaction(cbSubfaction.getSelectedItem().toString());</b>
&nbsp;        }
<b class="nc">&nbsp;        refreshUnitTypes();</b>
<b class="nc">&nbsp;        cbSubfaction.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshUnitTypes() {
<b class="nc">&nbsp;        cbUnitType.removeActionListener(this);</b>
<b class="nc">&nbsp;        TOCNode tocNode = findTOCNode();</b>
<b class="nc">&nbsp;        Integer currentType = forceDesc.getUnitType();</b>
<b class="nc">&nbsp;        boolean hasCurrent = false;</b>
<b class="nc">&nbsp;        cbUnitType.removeAllItems();</b>
<b class="nc">&nbsp;        if (tocNode != null) {</b>
<b class="nc">&nbsp;            ValueNode n = tocNode.findUnitTypes(forceDesc);</b>
<b class="nc">&nbsp;            if (n != null) {</b>
<b class="nc">&nbsp;                for (String unitType : n.getContent().split(&quot;,&quot;)) {</b>
<b class="nc">&nbsp;                    if (unitType.equals(&quot;null&quot;)) {</b>
<b class="nc">&nbsp;                        cbUnitType.addItem(null);</b>
<b class="nc">&nbsp;                        if (currentType == null) {</b>
<b class="nc">&nbsp;                            hasCurrent = true;</b>
&nbsp;                        }
&nbsp;                    } else {
<b class="nc">&nbsp;                        cbUnitType.addItem(AbstractUnitRecord.parseUnitType(unitType));</b>
<b class="nc">&nbsp;                        if (currentType != null &amp;&amp; UnitType.getTypeDisplayableName(currentType).equals(unitType)) {</b>
<b class="nc">&nbsp;                            hasCurrent = true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                MegaMek.getLogger().warning(&quot;No unit type node found.&quot;);</b>
<b class="nc">&nbsp;                cbUnitType.addItem(null);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            cbUnitType.addItem(null);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (hasCurrent) {</b>
<b class="nc">&nbsp;            cbUnitType.setSelectedItem(currentType);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Ruleset rs = Ruleset.findRuleset(forceDesc.getFaction());</b>
<b class="nc">&nbsp;            Integer unitType = rs.getDefaultUnitType(forceDesc);</b>
<b class="nc">&nbsp;            if (unitType == null &amp;&amp; cbUnitType.getItemCount() &gt; 0) {</b>
<b class="nc">&nbsp;                unitType = (Integer)cbUnitType.getItemAt(0);</b>
&nbsp;            }
<b class="nc">&nbsp;            cbUnitType.setSelectedItem(unitType);</b>
<b class="nc">&nbsp;            forceDesc.setUnitType(unitType);</b>
&nbsp;        }
<b class="nc">&nbsp;        refreshFormations();</b>
<b class="nc">&nbsp;        cbUnitType.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshFormations() {
<b class="nc">&nbsp;        cbFormation.removeActionListener(this);</b>
<b class="nc">&nbsp;        if (cbUnitType.getSelectedItem() != null) {</b>
<b class="nc">&nbsp;            Integer unitType = (Integer)cbUnitType.getSelectedItem();</b>
<b class="nc">&nbsp;            if (unitType != null) {</b>
<b class="nc">&nbsp;                panGroundRole.setVisible(unitType == UnitType.MEK || unitType == UnitType.TANK);</b>
<b class="nc">&nbsp;                panInfRole.setVisible(unitType == UnitType.INFANTRY</b>
<b class="nc">&nbsp;                        || unitType == UnitType.BATTLE_ARMOR);</b>
<b class="nc">&nbsp;                panAirRole.setVisible(unitType == UnitType.AERO</b>
<b class="nc">&nbsp;                        || unitType == UnitType.CONV_FIGHTER);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        TOCNode tocNode = findTOCNode();</b>
<b class="nc">&nbsp;        String currentFormation = (String)cbFormation.getSelectedItem();</b>
<b class="nc">&nbsp;        boolean hasCurrent = false;</b>
<b class="nc">&nbsp;        Ruleset ruleset = Ruleset.findRuleset(forceDesc);</b>
<b class="nc">&nbsp;        cbFormation.removeAllItems();</b>
&nbsp;
<b class="nc">&nbsp;        if (tocNode != null) {</b>
<b class="nc">&nbsp;            ValueNode n = tocNode.findEschelons(forceDesc);</b>
<b class="nc">&nbsp;            if (n != null) {</b>
<b class="nc">&nbsp;                formationDisplayNames.clear();</b>
<b class="nc">&nbsp;                for (String formation : n.getContent().split(&quot;,&quot;)) {</b>
<b class="nc">&nbsp;                    Ruleset rs = ruleset;</b>
<b class="nc">&nbsp;                    ForceNode fn = null;</b>
&nbsp;                    do {
<b class="nc">&nbsp;                        fn = rs.findForceNode(forceDesc,</b>
<b class="nc">&nbsp;                                Integer.parseInt(formation.replaceAll(&quot;[^0-9]&quot;, &quot;&quot;)),</b>
<b class="nc">&nbsp;                                formation.endsWith(&quot;^&quot;));</b>
<b class="nc">&nbsp;                        if (fn == null) {</b>
<b class="nc">&nbsp;                            if (rs.getParent() != null) {</b>
<b class="nc">&nbsp;                                rs = Ruleset.findRuleset(rs.getParent());</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                rs = null;</b>
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                    } while (fn == null &amp;&amp; rs != null);</b>
<b class="nc">&nbsp;                    String formName = (fn != null)?fn.getEschelonName() : formation;</b>
<b class="nc">&nbsp;                    if (formation.endsWith(&quot;+&quot;)) {</b>
<b class="nc">&nbsp;                        formName = Messages.getString(&quot;ForceGeneratorDialog.reinforced&quot;) + formName;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (formation.endsWith(&quot;-&quot;)) {</b>
<b class="nc">&nbsp;                        formName = Messages.getString(&quot;ForceGeneratorDialog.understrength&quot;) + formName;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    formationDisplayNames.put(formation, formName);</b>
<b class="nc">&nbsp;                    cbFormation.addItem(formation);</b>
<b class="nc">&nbsp;                    if (currentFormation != null &amp;&amp; currentFormation.equals(formation)) {</b>
<b class="nc">&nbsp;                        hasCurrent = true;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().warning(&quot;No eschelon node found.&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (hasCurrent) {</b>
<b class="nc">&nbsp;            cbFormation.setSelectedItem(currentFormation);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Ruleset rs = Ruleset.findRuleset(forceDesc.getFaction());</b>
<b class="nc">&nbsp;            String esch = rs.getDefaultEschelon(forceDesc);</b>
<b class="nc">&nbsp;            if ((esch == null || !formationDisplayNames.containsKey(esch)</b>
<b class="nc">&nbsp;                    &amp;&amp; cbFormation.getItemCount() &gt; 0)) {</b>
<b class="nc">&nbsp;                esch = (String)cbFormation.getItemAt(0);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (esch != null) {</b>
<b class="nc">&nbsp;                cbFormation.setSelectedItem(esch);</b>
<b class="nc">&nbsp;                setFormation(esch);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        refreshRatings();</b>
<b class="nc">&nbsp;        cbFormation.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshRatings() {
<b class="nc">&nbsp;        cbRating.removeActionListener(this);</b>
<b class="nc">&nbsp;        TOCNode tocNode = findTOCNode();</b>
<b class="nc">&nbsp;        String currentRating = forceDesc.getRating();</b>
<b class="nc">&nbsp;        boolean hasCurrent = false;</b>
<b class="nc">&nbsp;        cbRating.removeAllItems();</b>
<b class="nc">&nbsp;        ratingDisplayNames.clear();</b>
<b class="nc">&nbsp;        if (tocNode != null) {</b>
<b class="nc">&nbsp;            ValueNode n = tocNode.findRatings(forceDesc);</b>
<b class="nc">&nbsp;            if (n != null &amp;&amp; n.getContent() != null) {</b>
<b class="nc">&nbsp;                cbRating.addItem(null);</b>
<b class="nc">&nbsp;                for (String rating : n.getContent().split(&quot;,&quot;)) {</b>
<b class="nc">&nbsp;                    if (rating.contains(&quot;:&quot;)) {</b>
<b class="nc">&nbsp;                        String[] fields = rating.split(&quot;:&quot;);</b>
<b class="nc">&nbsp;                        cbRating.addItem(fields[0]);</b>
<b class="nc">&nbsp;                        ratingDisplayNames.put(fields[0], fields[1]);</b>
<b class="nc">&nbsp;                    } else {</b>
<b class="nc">&nbsp;                        cbRating.addItem(rating);</b>
<b class="nc">&nbsp;                        ratingDisplayNames.put(rating, rating);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                MegaMek.getLogger().warning(&quot;No rating found.&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (hasCurrent) {</b>
<b class="nc">&nbsp;            cbRating.setSelectedItem(currentRating);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Ruleset rs = Ruleset.findRuleset(forceDesc.getFaction());</b>
<b class="nc">&nbsp;            String rating = rs.getDefaultRating(forceDesc);</b>
<b class="nc">&nbsp;            if (rating == null &amp;&amp; cbRating.getItemCount() &gt; 0) {</b>
<b class="nc">&nbsp;                rating = cbRating.getItemAt(0);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (rating != null) {</b>
<b class="nc">&nbsp;                cbRating.setSelectedItem(rating);</b>
<b class="nc">&nbsp;                forceDesc.setRating(rating);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        refreshFlags();</b>
<b class="nc">&nbsp;        cbRating.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshFlags() {
<b class="nc">&nbsp;        cbFlags.removeActionListener(this);</b>
<b class="nc">&nbsp;        TOCNode tocNode = findTOCNode();</b>
<b class="nc">&nbsp;        String currentFlag = (String)cbFlags.getSelectedItem();</b>
<b class="nc">&nbsp;        boolean hasCurrent = false;</b>
<b class="nc">&nbsp;        cbFlags.removeAllItems();</b>
<b class="nc">&nbsp;        cbFlags.addItem(null);</b>
<b class="nc">&nbsp;        if (tocNode != null) {</b>
<b class="nc">&nbsp;            ValueNode n = tocNode.findFlags(forceDesc);</b>
<b class="nc">&nbsp;            if (n != null &amp;&amp; n.getContent() != null) {</b>
<b class="nc">&nbsp;                for (String flag : n.getContent().split(&quot;,&quot;)) {</b>
<b class="nc">&nbsp;                    if (flag.contains(&quot;:&quot;)) {</b>
<b class="nc">&nbsp;                        String[] fields = flag.split(&quot;:&quot;);</b>
<b class="nc">&nbsp;                        flagDisplayNames.put(fields[0], fields[1]);</b>
<b class="nc">&nbsp;                        cbFlags.addItem(fields[0]);</b>
<b class="nc">&nbsp;                    } else {</b>
<b class="nc">&nbsp;                        flagDisplayNames.put(flag, flag);</b>
<b class="nc">&nbsp;                        cbFlags.addItem(flag);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (hasCurrent) {</b>
<b class="nc">&nbsp;            cbFlags.setSelectedItem(currentFlag);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            cbFlags.setSelectedIndex(0);</b>
&nbsp;        }
<b class="nc">&nbsp;        forceDesc.getFlags().clear();</b>
<b class="nc">&nbsp;        if (cbFlags.getSelectedItem() != null) {</b>
<b class="nc">&nbsp;            forceDesc.getFlags().add((String)cbFlags.getSelectedItem());</b>
&nbsp;        }
<b class="nc">&nbsp;        cbFlags.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    private TOCNode findTOCNode() {
<b class="nc">&nbsp;        Ruleset rs = Ruleset.findRuleset(forceDesc);</b>
<b class="nc">&nbsp;        if (null == rs) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        TOCNode toc = null;</b>
&nbsp;        do {
<b class="nc">&nbsp;            toc = rs.getTOCNode();</b>
<b class="nc">&nbsp;            if (toc == null) {</b>
<b class="nc">&nbsp;                if (rs.getParent() == null) {</b>
<b class="nc">&nbsp;                    rs = null;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    rs = Ruleset.findRuleset(rs.getParent());</b>
&nbsp;                }				
&nbsp;            }
<b class="nc">&nbsp;        } while (rs != null &amp;&amp; toc == null);</b>
<b class="nc">&nbsp;        return toc;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent ev) {
<b class="nc">&nbsp;        if (ev.getSource() == cbFaction) {</b>
<b class="nc">&nbsp;            if (cbFaction.getSelectedItem() != null) {</b>
<b class="nc">&nbsp;                forceDesc.setFaction(((FactionRecord)cbFaction.getSelectedItem()).getKey());</b>
&nbsp;            }
<b class="nc">&nbsp;            refreshSubfactions();</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == cbSubfaction) {</b>
<b class="nc">&nbsp;            if (cbSubfaction.getSelectedItem() != null) {</b>
<b class="nc">&nbsp;                forceDesc.setFaction(((FactionRecord)cbSubfaction.getSelectedItem()).getKey());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                forceDesc.setFaction(((FactionRecord)cbFaction.getSelectedItem()).getKey());</b>
&nbsp;            }
<b class="nc">&nbsp;            refreshUnitTypes();</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == cbUnitType) {</b>
<b class="nc">&nbsp;            forceDesc.setUnitType((Integer)cbUnitType.getSelectedItem());</b>
<b class="nc">&nbsp;            refreshFormations();</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == cbFormation) {</b>
<b class="nc">&nbsp;            String esch = (String)cbFormation.getSelectedItem();</b>
<b class="nc">&nbsp;            if (esch != null) {</b>
<b class="nc">&nbsp;                setFormation(esch);</b>
&nbsp;            }
<b class="nc">&nbsp;            refreshRatings();</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == cbRating) {</b>
<b class="nc">&nbsp;            forceDesc.setRating((String)cbRating.getSelectedItem());</b>
<b class="nc">&nbsp;            refreshFlags();</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == cbExperience) {</b>
<b class="nc">&nbsp;            if (cbExperience.getSelectedIndex() == 0) {</b>
<b class="nc">&nbsp;                forceDesc.setExperience(null);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                forceDesc.setExperience(cbExperience.getSelectedIndex() - 1);</b>
&nbsp;            }
<b class="nc">&nbsp;            refreshFlags();</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == cbFlags) {</b>
<b class="nc">&nbsp;            forceDesc.getFlags().clear();</b>
<b class="nc">&nbsp;            if (cbFlags.getSelectedItem() != null) {</b>
<b class="nc">&nbsp;                forceDesc.getFlags().add((String)cbFlags.getSelectedItem());</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (ev.getSource() == cbWeightClass) {</b>
<b class="nc">&nbsp;            if (cbWeightClass.getSelectedIndex() &lt; 1) {</b>
<b class="nc">&nbsp;                forceDesc.setWeightClass(null);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                forceDesc.setWeightClass(cbWeightClass.getSelectedIndex());</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (ev.getSource() == btnGenerate) {</b>
<b class="nc">&nbsp;            generateForce();</b>
<b class="nc">&nbsp;            btnExportMUL.setEnabled(true);</b>
<b class="nc">&nbsp;            btnClear.setEnabled(true);</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == btnExportMUL) {</b>
<b class="nc">&nbsp;            exportMUL(forceDesc);</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == btnClear) {</b>
<b class="nc">&nbsp;            clearForce();</b>
<b class="nc">&nbsp;            btnExportMUL.setEnabled(false);</b>
<b class="nc">&nbsp;            btnClear.setEnabled(false);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    void exportMUL(ForceDescriptor fd) {
<b class="nc">&nbsp;        ArrayList&lt;Entity&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        fd.addAllEntities(list);</b>
&nbsp;        //Create a fake game so we can write the entities to a file without adding them to the real game.
<b class="nc">&nbsp;        Game game = new Game();</b>
&nbsp;        //Add a player to prevent complaining in the log file
<b class="nc">&nbsp;        Player p = new Player(1, &quot;Observer&quot;);</b>
<b class="nc">&nbsp;        game.addPlayer(1, p);</b>
<b class="nc">&nbsp;        game.setOptions(clientGui.getClient().getGame().getOptions());</b>
<b class="nc">&nbsp;        list.stream().forEach(en -&gt; {</b>
<b class="nc">&nbsp;            en.setOwner(p);</b>
&nbsp;            // If we don&#39;t set the id, the first unit will be left at -1, which in most cases is interpreted
&nbsp;            // as no entity
<b class="nc">&nbsp;            en.setId(game.getNextEntityId());</b>
<b class="nc">&nbsp;            game.addEntity(en);</b>
&nbsp;        });
<b class="nc">&nbsp;        configureNetworks(fd);</b>
<b class="nc">&nbsp;        clientGui.saveListFile(list, clientGui.getClient().getLocalPlayer().getName());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Searches recursively for nodes that are flagged with C3 networks and configures them.
&nbsp;     * 
&nbsp;     * @param fd
&nbsp;     */
&nbsp;    private void configureNetworks(ForceDescriptor fd) {
<b class="nc">&nbsp;        if (fd.getFlags().contains(&quot;c3&quot;)) {</b>
<b class="nc">&nbsp;            Entity master = fd.getSubforces().stream().map(ForceDescriptor::getEntity)</b>
<b class="nc">&nbsp;                    .filter(en -&gt; (null != en)</b>
<b class="nc">&nbsp;                            &amp;&amp; (en.hasC3M() || en.hasC3MM()))</b>
<b class="nc">&nbsp;                    .findFirst().orElse(null);</b>
<b class="nc">&nbsp;            if (null != master) {</b>
<b class="nc">&nbsp;                int c3s = 0;</b>
<b class="nc">&nbsp;                for (ForceDescriptor sf : fd.getSubforces()) {</b>
<b class="nc">&nbsp;                    if ((null != sf.getEntity())</b>
<b class="nc">&nbsp;                            &amp;&amp; (sf.getEntity().getId() != master.getId())</b>
<b class="nc">&nbsp;                            &amp;&amp; sf.getEntity().hasC3S()) {</b>
<b class="nc">&nbsp;                        sf.getEntity().setC3Master(master, false);</b>
<b class="nc">&nbsp;                        c3s++;</b>
<b class="nc">&nbsp;                        if (c3s == 3) {</b>
<b class="nc">&nbsp;                            break;</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
&nbsp;            // Even if we haven&#39;t reworked this into a full C3i network, we can still connect
&nbsp;            // any C3i units that happen to be present.
<b class="nc">&nbsp;            Entity first = null;</b>
<b class="nc">&nbsp;            int nodes = 0;</b>
<b class="nc">&nbsp;            for (ForceDescriptor sf : fd.getSubforces()) {</b>
<b class="nc">&nbsp;                if ((null != sf.getEntity())</b>
<b class="nc">&nbsp;                        &amp;&amp; sf.getEntity().hasC3i()) {</b>
<b class="nc">&nbsp;                    sf.getEntity().setC3UUID();</b>
<b class="nc">&nbsp;                    if (null == first) {</b>
<b class="nc">&nbsp;                        sf.getEntity().setC3NetIdSelf();</b>
<b class="nc">&nbsp;                        first = sf.getEntity();</b>
<b class="nc">&nbsp;                        nodes++;</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        sf.getEntity().setC3NetId(first);</b>
<b class="nc">&nbsp;                        nodes++;</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (nodes &gt;= Entity.MAX_C3i_NODES) {</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        fd.getSubforces().forEach(sf -&gt; configureNetworks(sf));</b>
<b class="nc">&nbsp;        fd.getAttached().forEach(sf -&gt; configureNetworks(sf));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setFormation(String esch) {
<b class="nc">&nbsp;        forceDesc.setEschelon(Integer.parseInt(esch.replaceAll(&quot;[^0-9]&quot;, &quot;&quot;)));</b>
<b class="nc">&nbsp;        forceDesc.setAugmented(esch.contains(&quot;^&quot;));</b>
<b class="nc">&nbsp;        if (esch.endsWith(&quot;+&quot;)) {</b>
<b class="nc">&nbsp;            forceDesc.setSizeMod(1);</b>
<b class="nc">&nbsp;        } else if (esch.endsWith(&quot;-&quot;)) {</b>
<b class="nc">&nbsp;            forceDesc.setSizeMod(-1);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            forceDesc.setSizeMod(0);</b>
&nbsp;        }
&nbsp;    }		
&nbsp;
&nbsp;    public void setCurrentYear(int year) {
<b class="nc">&nbsp;        currentYear = year;</b>
<b class="nc">&nbsp;        yearUpdated();	    </b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Worker function that updates various things that need to be updated when the year is changed.
&nbsp;     */
&nbsp;    private void yearUpdated() {
<b class="nc">&nbsp;        txtYear.setText(String.valueOf(currentYear));</b>
<b class="nc">&nbsp;        RATGenerator.getInstance().loadYear(currentYear);</b>
<b class="nc">&nbsp;        forceDesc.setYear(currentYear);</b>
<b class="nc">&nbsp;        refreshFactions();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void focusGained(FocusEvent arg0) {
&nbsp;        //Do nothing
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void focusLost(FocusEvent arg0) {
&nbsp;        try {
<b class="nc">&nbsp;            currentYear = Integer.parseInt(txtYear.getText());</b>
<b class="nc">&nbsp;            if (currentYear &lt; RATGenerator.getInstance().getEraSet().first()) {</b>
<b class="nc">&nbsp;                currentYear = RATGenerator.getInstance().getEraSet().first();</b>
<b class="nc">&nbsp;            } else if (currentYear &gt; RATGenerator.getInstance().getEraSet().last()) {</b>
<b class="nc">&nbsp;                currentYear = RATGenerator.getInstance().getEraSet().last();</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (NumberFormatException ex) {</b>
&nbsp;            //ignore and restore to previous value
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        yearUpdated();</b>
&nbsp;    }
&nbsp;
&nbsp;    static class CBRenderer&lt;T&gt; extends DefaultListCellRenderer {
&nbsp;
&nbsp;        private static final long serialVersionUID = 4895258839502183158L;
&nbsp;
<b class="nc">&nbsp;        private String nullVal = Messages.getString(&quot;ForceGeneratorDialog.default&quot;);</b>
&nbsp;        private Function&lt;T,String&gt; toString;
&nbsp;
&nbsp;        public CBRenderer(String nullVal) {
<b class="nc">&nbsp;            this(nullVal, null);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        public CBRenderer(String nullVal, Function&lt;T,String&gt; strConverter) {</b>
<b class="nc">&nbsp;            this.nullVal = nullVal;</b>
<b class="nc">&nbsp;            if (strConverter == null) {</b>
<b class="nc">&nbsp;                toString = obj -&gt; obj.toString();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                toString = strConverter;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @SuppressWarnings(&quot;unchecked&quot;)
&nbsp;        @Override
&nbsp;        public Component getListCellRendererComponent(JList&lt;? extends Object&gt; list, Object entry,
&nbsp;                int position, boolean arg3, boolean arg4) {
<b class="nc">&nbsp;            if (entry == null) {</b>
<b class="nc">&nbsp;                setText(nullVal);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                setText(toString.apply((T)entry));</b>
&nbsp;            }
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    static class ForceTreeModel implements TreeModel {
&nbsp;
&nbsp;        private ForceDescriptor root;
&nbsp;        private ArrayList&lt;TreeModelListener&gt; listeners;
&nbsp;
<b class="nc">&nbsp;        public ForceTreeModel(ForceDescriptor root) {</b>
<b class="nc">&nbsp;            this.root = root;</b>
<b class="nc">&nbsp;            listeners = new ArrayList&lt;TreeModelListener&gt;();		</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void addTreeModelListener(TreeModelListener listener) {
<b class="nc">&nbsp;            if (null != listener &amp;&amp; !listeners.contains(listener)) {</b>
<b class="nc">&nbsp;                listeners.add(listener);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Object getChild(Object parent, int index) {
<b class="nc">&nbsp;            if (parent instanceof ForceDescriptor) {</b>
<b class="nc">&nbsp;                return ((ForceDescriptor)parent).getAllChildren().get(index);</b>
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int getChildCount(Object parent) {
<b class="nc">&nbsp;            if (parent instanceof ForceDescriptor) {</b>
<b class="nc">&nbsp;                return ((ForceDescriptor)parent).getAllChildren().size();</b>
&nbsp;            }
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int getIndexOfChild(Object parent, Object child) {
<b class="nc">&nbsp;            if (parent instanceof ForceDescriptor) {</b>
<b class="nc">&nbsp;                return ((ForceDescriptor)parent).getAllChildren().indexOf(child);</b>
&nbsp;            }
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Object getRoot() {
<b class="nc">&nbsp;            return root;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public boolean isLeaf(Object node) {
<b class="nc">&nbsp;            return ((ForceDescriptor)node).getEschelon() == 0</b>
<b class="nc">&nbsp;                    || (node instanceof ForceDescriptor &amp;&amp; getChildCount(node) == 0);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void removeTreeModelListener(TreeModelListener listener) {
<b class="nc">&nbsp;            if (null != listener) {</b>
<b class="nc">&nbsp;                listeners.remove(listener);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void valueForPathChanged(TreePath arg0, Object arg1) {
&nbsp;            // TODO Auto-generated method stub
&nbsp;
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    static class UnitRenderer extends DefaultTreeCellRenderer {
&nbsp;        private static final long serialVersionUID = -5915350078441133119L;
&nbsp;
<b class="nc">&nbsp;        public UnitRenderer() {</b>
&nbsp;
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Component getTreeCellRendererComponent(JTree tree, Object value,
&nbsp;                boolean sel, boolean expanded, boolean leaf, int row, boolean hasFocus) {
&nbsp;
<b class="nc">&nbsp;            super.getTreeCellRendererComponent(</b>
&nbsp;                    tree, value, sel,
&nbsp;                    expanded, leaf, row,
&nbsp;                    hasFocus);
<b class="nc">&nbsp;            setBackground(UIManager.getColor(&quot;Tree.textBackground&quot;));</b>
<b class="nc">&nbsp;            setForeground(UIManager.getColor(&quot;Tree.textForeground&quot;));</b>
<b class="nc">&nbsp;            if(sel) {</b>
<b class="nc">&nbsp;                setBackground(UIManager.getColor(&quot;Tree.selectionBackground&quot;));</b>
<b class="nc">&nbsp;                setForeground(UIManager.getColor(&quot;Tree.selectionForeground&quot;));</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            ForceDescriptor fd = (ForceDescriptor)value;</b>
<b class="nc">&nbsp;            if (fd.isElement()) {</b>
<b class="nc">&nbsp;                StringBuilder name = new StringBuilder();</b>
<b class="nc">&nbsp;                String uname = &quot;&quot;;</b>
<b class="nc">&nbsp;                if (fd.getCo() == null) {</b>
<b class="nc">&nbsp;                    name.append(&quot;&lt;font color=&#39;red&#39;&gt;&quot;)</b>
<b class="nc">&nbsp;                    .append(Messages.getString(&quot;ForceGeneratorDialog.noCrew&quot;))</b>
<b class="nc">&nbsp;                    .append(&quot;&lt;/font&gt;&quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    name.append(fd.getCo().getName());</b>
<b class="nc">&nbsp;                    name.append(&quot; (&quot;).append(fd.getCo().getGunnery()).append(&quot;/&quot;).append(fd.getCo().getPiloting()).append(&quot;)&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                uname = &quot;&lt;i&gt;&quot; + fd.getModelName() + &quot;&lt;/i&gt;&quot;;</b>
<b class="nc">&nbsp;                if (fd.getFluffName() != null) {</b>
<b class="nc">&nbsp;                    uname += &quot;&lt;br /&gt;&lt;i&gt;&quot; + fd.getFluffName() + &quot;&lt;/i&gt;&quot;;</b>
&nbsp;                }
<b class="nc">&nbsp;                setText(&quot;&lt;html&gt;&quot; + name.toString() + &quot;, &quot; + uname + &quot;&lt;/html&gt;&quot;);</b>
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                StringBuilder desc = new StringBuilder(&quot;&lt;html&gt;&quot;);</b>
<b class="nc">&nbsp;                desc.append(fd.parseName()).append(&quot;&lt;br /&gt;&quot;).append(fd.getDescription());</b>
<b class="nc">&nbsp;                if (fd.getCo() != null) {</b>
<b class="nc">&nbsp;                    desc.append(&quot;&lt;br /&gt;&quot;).append(fd.getCo().getTitle() == null?&quot;CO&quot;:fd.getCo().getTitle());</b>
<b class="nc">&nbsp;                    desc.append(fd.getCo().getName());</b>
&nbsp;                }
<b class="nc">&nbsp;                if (fd.getXo() != null) {</b>
<b class="nc">&nbsp;                    desc.append(&quot;&lt;br /&gt;&quot;).append(fd.getXo().getTitle() == null?&quot;XO&quot;:fd.getXo().getTitle());</b>
<b class="nc">&nbsp;                    desc.append(fd.getXo().getName());</b>
&nbsp;                }
<b class="nc">&nbsp;                setText(desc.append(&quot;&lt;/html&gt;&quot;).toString());</b>
&nbsp;            }
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private class GenerateTask extends SwingWorker&lt;ForceDescriptor,Double&gt; implements Ruleset.ProgressListener {
&nbsp;
&nbsp;        private ForceDescriptor fd;
&nbsp;
<b class="nc">&nbsp;        private final Object progressLock = new Object();</b>
<b class="nc">&nbsp;        private double progress = 0;</b>
<b class="nc">&nbsp;        private String message = &quot;&quot;;</b>
&nbsp;
<b class="nc">&nbsp;        GenerateTask(ForceDescriptor fd) {</b>
<b class="nc">&nbsp;            this.fd = fd;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected ForceDescriptor doInBackground() throws Exception {
<b class="nc">&nbsp;            btnGenerate.setEnabled(false);</b>
<b class="nc">&nbsp;            Ruleset.findRuleset(fd).processRoot(fd, this);</b>
<b class="nc">&nbsp;            return fd;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected void done() {
&nbsp;            try {
<b class="nc">&nbsp;                forceDesc = get();</b>
<b class="nc">&nbsp;                if (onGenerate != null) {</b>
<b class="nc">&nbsp;                    onGenerate.accept(forceDesc);</b>
&nbsp;                }
<b class="nc">&nbsp;            } catch (InterruptedException ex) {</b>
&nbsp;                //Ignore
<b class="nc">&nbsp;            } catch (ExecutionException e) {</b>
<b class="nc">&nbsp;                e.getCause().printStackTrace();</b>
&nbsp;            } finally {
<b class="nc">&nbsp;                btnGenerate.setEnabled(true);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void updateProgress(double progress, String message) {
&nbsp;            int progressPercent;
<b class="nc">&nbsp;            synchronized (progressLock) {</b>
<b class="nc">&nbsp;                this.progress += progress;</b>
<b class="nc">&nbsp;                this.message = message;</b>
&nbsp;
<b class="nc">&nbsp;                progressPercent = Math.min((int)Math.round(this.progress * 100.0), 100);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            setProgress(progressPercent);</b>
&nbsp;        }
&nbsp;
&nbsp;        public String getMessage() {
<b class="nc">&nbsp;            synchronized (progressLock) {</b>
<b class="nc">&nbsp;                return message;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
