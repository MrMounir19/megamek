


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > BoardEditor</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ui.swing</a>
</div>

<h1>Coverage Summary for Class: BoardEditor (megamek.client.ui.swing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">BoardEditor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/61)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1074)
  </span>
</td>
</tr>
  <tr>
    <td class="name">BoardEditor$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/41)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$ComboboxToolTipRenderer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$EditorTextField</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$EditorTextField$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$EditorTextField$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$HexCanvas</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/34)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$TerrainHelper</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BoardEditor$TerrainTypeHelper</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/102)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1238)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek - Copyright (C) 2000-2003 Ben Mazur (bmazur@sev.org)
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;package megamek.client.ui.swing;
&nbsp;
&nbsp;import java.awt.BorderLayout;
&nbsp;import java.awt.Color;
&nbsp;import java.awt.Component;
&nbsp;import java.awt.Cursor;
&nbsp;import java.awt.Desktop;
&nbsp;import java.awt.Dimension;
&nbsp;import java.awt.FlowLayout;
&nbsp;import java.awt.Font;
&nbsp;import java.awt.Graphics;
&nbsp;import java.awt.Graphics2D;
&nbsp;import java.awt.GridBagConstraints;
&nbsp;import java.awt.GridBagLayout;
&nbsp;import java.awt.GridLayout;
&nbsp;import java.awt.Image;
&nbsp;import java.awt.Insets;
&nbsp;import java.awt.Point;
&nbsp;import java.awt.RenderingHints;
&nbsp;import java.awt.SystemColor;
&nbsp;import java.awt.event.*;
&nbsp;import java.io.File;
&nbsp;import java.io.FileInputStream;
&nbsp;import java.io.FileOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.OutputStream;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Collections;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.LinkedList;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;import java.util.Stack;
&nbsp;
&nbsp;import javax.imageio.ImageIO;
&nbsp;import javax.swing.Box;
&nbsp;import javax.swing.ButtonGroup;
&nbsp;import javax.swing.DefaultListCellRenderer;
&nbsp;import javax.swing.DefaultListModel;
&nbsp;import javax.swing.ImageIcon;
&nbsp;import javax.swing.JButton;
&nbsp;import javax.swing.JCheckBox;
&nbsp;import javax.swing.JComboBox;
&nbsp;import javax.swing.JComponent;
&nbsp;import javax.swing.JDialog;
&nbsp;import javax.swing.JFileChooser;
&nbsp;import javax.swing.JFrame;
&nbsp;import javax.swing.JLabel;
&nbsp;import javax.swing.JList;
&nbsp;import javax.swing.JOptionPane;
&nbsp;import javax.swing.JPanel;
&nbsp;import javax.swing.JScrollPane;
&nbsp;import javax.swing.ScrollPaneConstants;
&nbsp;import javax.swing.JTextArea;
&nbsp;import javax.swing.JTextField;
&nbsp;import javax.swing.JToggleButton;
&nbsp;import javax.swing.SwingConstants;
&nbsp;import javax.swing.WindowConstants;
&nbsp;import javax.swing.border.LineBorder;
&nbsp;import javax.swing.border.TitledBorder;
&nbsp;import javax.swing.event.DocumentEvent;
&nbsp;import javax.swing.event.DocumentListener;
&nbsp;import javax.swing.event.ListSelectionEvent;
&nbsp;import javax.swing.event.ListSelectionListener;
&nbsp;import javax.swing.filechooser.FileFilter;
&nbsp;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.client.event.BoardViewEvent;
&nbsp;import megamek.client.event.BoardViewListenerAdapter;
&nbsp;import megamek.client.ui.Messages;
&nbsp;import megamek.client.ui.swing.boardview.BoardView1;
&nbsp;import megamek.client.ui.swing.tileset.TilesetManager;
&nbsp;import megamek.client.ui.swing.util.MegaMekController;
&nbsp;import megamek.common.*;
&nbsp;import megamek.common.util.BoardUtilities;
&nbsp;import megamek.common.util.ImageUtil;
&nbsp;import megamek.common.util.fileUtils.MegaMekFile;
&nbsp;
&nbsp;// TODO: center map
&nbsp;// TODO: background on the whole screen
&nbsp;// TODO: restrict terrains to those with images?
&nbsp;// TODO: Allow drawing of invalid terrain as an override?
&nbsp;// TODO: Allow adding/changing board background images
&nbsp;// TODO: sluggish hex drawing?
&nbsp;// TODO: the board validation after a board load seems to be influenced by the former board...
&nbsp;// TODO: copy/paste hexes
&nbsp;
<b class="nc">&nbsp;public class BoardEditor extends JComponent</b>
&nbsp;        implements ItemListener, ListSelectionListener, ActionListener, DocumentListener, IMapSettingsObserver {
&nbsp;    
&nbsp;    /**
&nbsp;     * Class to make terrains in JComboBoxes easier.  This enables keeping the terrain type int separate from the name
&nbsp;     * that gets displayed and also provides a way to get tooltips.
&nbsp;     * 
&nbsp;     * @author arlith
&nbsp;     */
&nbsp;    private static class TerrainHelper implements Comparable&lt;TerrainHelper&gt; {
&nbsp;        private int terrainType;
&nbsp;
<b class="nc">&nbsp;        TerrainHelper (int terrain) {</b>
<b class="nc">&nbsp;            terrainType = terrain;</b>
&nbsp;        }
&nbsp;
&nbsp;        public int getTerrainType() {
<b class="nc">&nbsp;            return terrainType;</b>
&nbsp;        }
&nbsp;
&nbsp;        public String toString() {
<b class="nc">&nbsp;            return Terrains.getEditorName(terrainType);</b>
&nbsp;        }
&nbsp;
&nbsp;        public String getTerrainTooltip() {
<b class="nc">&nbsp;            return Terrains.getEditorTooltip(terrainType);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int compareTo(TerrainHelper o) {
<b class="nc">&nbsp;            return toString().compareTo(o.toString());</b>
&nbsp;        }
&nbsp;        
&nbsp;        @Override
&nbsp;        public boolean equals(Object other) {
<b class="nc">&nbsp;            if (other instanceof Integer) {</b>
<b class="nc">&nbsp;                return getTerrainType() == (Integer) other;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!(other instanceof TerrainHelper)) {</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
<b class="nc">&nbsp;            return getTerrainType() == ((TerrainHelper)other).getTerrainType();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Class to make it easier to display a &lt;code&gt;Terrain&lt;/code&gt; in a JList or JComboBox.
&nbsp;     *
&nbsp;     * @author arlith
&nbsp;     */
&nbsp;    private static class TerrainTypeHelper implements Comparable&lt;TerrainTypeHelper&gt; {
&nbsp;
&nbsp;        ITerrain terrain;
&nbsp;
<b class="nc">&nbsp;        TerrainTypeHelper(ITerrain terrain) {</b>
<b class="nc">&nbsp;            this.terrain = terrain;</b>
&nbsp;        }
&nbsp;
&nbsp;        public ITerrain getTerrain() {
<b class="nc">&nbsp;            return terrain;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public String toString() {
<b class="nc">&nbsp;            String baseString = Terrains.getDisplayName(terrain.getType(), terrain.getLevel());</b>
<b class="nc">&nbsp;            if (baseString == null) {</b>
<b class="nc">&nbsp;                baseString = Terrains.getEditorName(terrain.getType());</b>
<b class="nc">&nbsp;                baseString += &quot; &quot; + terrain.getLevel();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (terrain.hasExitsSpecified()) {</b>
<b class="nc">&nbsp;                baseString += &quot; (Exits: &quot; + terrain.getExits() + &quot;)&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            return baseString; </b>
&nbsp;        }
&nbsp;
&nbsp;        public String getTooltip() {
<b class="nc">&nbsp;            return terrain.toString();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int compareTo(TerrainTypeHelper o) {
<b class="nc">&nbsp;            return toString().compareTo(o.toString());</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     *  ListCellRenderer for rendering tooltips for each item in a list or combobox.  Code from SourceForge:
&nbsp;     *  https://stackoverflow.com/questions/480261/java-swing-mouseover-text-on-jcombobox-items 
&nbsp;     */
<b class="nc">&nbsp;    private static class ComboboxToolTipRenderer extends DefaultListCellRenderer {</b>
&nbsp;        /**
&nbsp;         * 
&nbsp;         */
&nbsp;        private static final long serialVersionUID = 7428395938750335593L;
&nbsp;
&nbsp;        TerrainHelper[] terrains;
&nbsp;        
&nbsp;        List&lt;TerrainTypeHelper&gt; terrainTypes;
&nbsp;
&nbsp;        @Override
&nbsp;        public Component getListCellRendererComponent(JList&lt;?&gt; list, Object value, int index, boolean isSelected,
&nbsp;                boolean cellHasFocus) {
&nbsp;
<b class="nc">&nbsp;            JComponent comp = (JComponent) super.getListCellRendererComponent(list, value, index, isSelected,</b>
&nbsp;                    cellHasFocus);
&nbsp;
<b class="nc">&nbsp;            if (-1 &lt; index &amp;&amp; null != value &amp;&amp; null != terrains) {</b>
<b class="nc">&nbsp;                list.setToolTipText(terrains[index].getTerrainTooltip());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (-1 &lt; index &amp;&amp; null != value &amp;&amp; null != terrainTypes) {</b>
<b class="nc">&nbsp;                list.setToolTipText(terrainTypes.get(index).getTooltip());</b>
&nbsp;            }
<b class="nc">&nbsp;            return comp;</b>
&nbsp;        }
&nbsp;
&nbsp;        public void setTerrains(TerrainHelper[] terrains) {
<b class="nc">&nbsp;            this.terrains = terrains;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public void setTerrainTypes(List&lt;TerrainTypeHelper&gt; terrainTypes) {
<b class="nc">&nbsp;            this.terrainTypes = terrainTypes;</b>
&nbsp;        }
&nbsp;    }
&nbsp; 
&nbsp;    private static final long serialVersionUID = 4689863639249616192L;
&nbsp;    
<b class="nc">&nbsp;    GUIPreferences guip = GUIPreferences.getInstance();</b>
&nbsp;
&nbsp;    //region action commands
&nbsp;    private static final String FILE_BOARD_EDITOR_EXPAND = &quot;fileBoardExpand&quot;;
&nbsp;    private static final String FILE_BOARD_EDITOR_VALIDATE = &quot;fileBoardValidate&quot;;
&nbsp;    private static final String FILE_SOURCEFILE = &quot;fileSource&quot;;
&nbsp;    //endregion action commands
&nbsp;
&nbsp;    // Components
<b class="nc">&nbsp;    JFrame frame = new JFrame();</b>
&nbsp;    JScrollPane scrollPane;
<b class="nc">&nbsp;    private Game game = new Game();</b>
<b class="nc">&nbsp;    IBoard board = game.getBoard();</b>
&nbsp;    BoardView1 bv;
<b class="nc">&nbsp;    public static final int [] allDirections = {0,1,2,3,4,5};</b>
<b class="nc">&nbsp;    boolean isDragging = false;</b>
&nbsp;    private Component bvc;
<b class="nc">&nbsp;    private CommonMenuBar menuBar = new CommonMenuBar();</b>
&nbsp;    private CommonAboutDialog about;
&nbsp;    private CommonHelpDialog help;
&nbsp;    private CommonSettingsDialog setdlg;
<b class="nc">&nbsp;    private ITerrainFactory TF = Terrains.getTerrainFactory();</b>
&nbsp;    private JDialog minimapW;
&nbsp;    private MiniMap minimap;
&nbsp;    MegaMekController controller;
&nbsp;    
&nbsp;    // The current files
&nbsp;    private File curfileImage;
&nbsp;    private File curBoardFile;
&nbsp;
&nbsp;    // The active hex &quot;brush&quot;
&nbsp;    private HexCanvas canHex;
<b class="nc">&nbsp;    IHex curHex = new Hex();</b>
&nbsp;    
&nbsp;    // Easy terrain access buttons
&nbsp;    private JButton buttonLW, buttonLJ;
&nbsp;    private JButton buttonOW, buttonOJ;
&nbsp;    private JButton buttonWa, buttonSw, buttonRo;
&nbsp;    private JButton buttonRd, buttonCl, buttonBu;
&nbsp;    private JButton buttonMd, buttonPv, buttonSn;
&nbsp;    private JButton buttonIc, buttonTu, buttonMg;
&nbsp;    private JButton buttonBr, buttonFT;
&nbsp;    private JToggleButton buttonBrush1, buttonBrush2, buttonBrush3;
&nbsp;    private JToggleButton buttonUpDn, buttonOOC;
&nbsp;    // The brush size: 1 = 1 hex, 2 = radius 1, 3 = radius 2  
<b class="nc">&nbsp;    int brushSize = 1;</b>
<b class="nc">&nbsp;    int hexLeveltoDraw = -1000;</b>
<b class="nc">&nbsp;    private Font fontElev = new Font(&quot;SansSerif&quot;, Font.BOLD, 20); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private Font fontComboTerr = new Font(&quot;SansSerif&quot;, Font.BOLD, 12); //$NON-NLS-1$</b>
&nbsp;    private EditorTextField texElev;
&nbsp;    private JButton butElevUp;
&nbsp;    private JButton butElevDown;
&nbsp;    private JList&lt;TerrainTypeHelper&gt; lisTerrain;
&nbsp;    private ComboboxToolTipRenderer lisTerrainRenderer;
&nbsp;    private JButton butDelTerrain;
&nbsp;    private JComboBox&lt;TerrainHelper&gt; choTerrainType;
&nbsp;    private EditorTextField texTerrainLevel;
&nbsp;    private JCheckBox cheTerrExitSpecified;
&nbsp;    private EditorTextField texTerrExits;
&nbsp;    private JButton butTerrExits;
&nbsp;    private JCheckBox cheRoadsAutoExit;
&nbsp;    private JButton butExitUp, butExitDown;
&nbsp;    private JComboBox&lt;String&gt; choTheme;
&nbsp;    private JButton butTerrDown, butTerrUp;
&nbsp;    private JButton butAddTerrain;
&nbsp;    private JButton butBoardNew;
&nbsp;    private JButton butBoardOpen;
&nbsp;    private JButton butBoardSave;
&nbsp;    private JButton butBoardSaveAs;
&nbsp;    private JButton butBoardSaveAsImage;
&nbsp;    private JButton butMiniMap;
&nbsp;    private JButton butBoardValidate;
&nbsp;    private JButton butSourceFile;
<b class="nc">&nbsp;    private MapSettings mapSettings = MapSettings.getInstance();</b>
&nbsp;    private JButton butExpandMap;
&nbsp;    private Coords lastClicked;
&nbsp;    
&nbsp;    // Undo / Redo
&nbsp;    JButton buttonUndo, buttonRedo;
<b class="nc">&nbsp;    private Stack&lt;HashSet&lt;IHex&gt;&gt; undoStack = new Stack&lt;&gt;();</b>
<b class="nc">&nbsp;    private Stack&lt;HashSet&lt;IHex&gt;&gt; redoStack = new Stack&lt;&gt;();</b>
&nbsp;    private HashSet&lt;IHex&gt; currentUndoSet;
&nbsp;    private HashSet&lt;Coords&gt; currentUndoCoords;
&nbsp;    
&nbsp;    // Tracker for board changes; unfortunately this is not equal to 
&nbsp;    // undoStack == empty because saving the board doesn&#39;t empty the 
&nbsp;    // undo stack but makes the board unchanged.
&nbsp;    /** Tracks if the board has changes over the last saved version. */
<b class="nc">&nbsp;    private boolean hasChanges = false;</b>
&nbsp;    /** Tracks if the board can return to the last saved version. */
<b class="nc">&nbsp;    private boolean canReturnToSaved = true;</b>
&nbsp;    /** The undo stack size at the last save. Used to track saved status of the board. */
<b class="nc">&nbsp;    private int savedUndoStackSize = 0;</b>
&nbsp;    
&nbsp;    // Misc
<b class="nc">&nbsp;    private File loadPath = Configuration.boardsDir();</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * Special purpose indicator, keeps terrain list 
&nbsp;     * from de-selecting when clicking it
&nbsp;     */
<b class="nc">&nbsp;    private boolean terrListBlocker = false;</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * Special purpose indicator, prevents an update
&nbsp;     * loop when the terrain level or exits field is changed
&nbsp;     */
<b class="nc">&nbsp;    private boolean noTextFieldUpdate = false;</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * A MouseAdapter that closes a JLabel when clicked 
&nbsp;     */
<b class="nc">&nbsp;    private MouseAdapter clickToHide = new MouseAdapter() {</b>
&nbsp;        @Override
&nbsp;        public void mouseReleased(MouseEvent e) {
<b class="nc">&nbsp;            if (e.getSource() instanceof JLabel)</b>
<b class="nc">&nbsp;                ((JLabel) e.getSource()).setVisible(false);</b>
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    /**
&nbsp;     * Flag that indicates whether hotkeys should be ignored or not.  This is
&nbsp;     * used for disabling hot keys when various dialogs are displayed.
&nbsp;     */
<b class="nc">&nbsp;    private boolean ignoreHotKeys = false;</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Creates and lays out a new Board Editor frame.
&nbsp;     */
<b class="nc">&nbsp;    public BoardEditor(MegaMekController c) {</b>
<b class="nc">&nbsp;        controller = c;</b>
&nbsp;        try {
<b class="nc">&nbsp;            bv = new BoardView1(game, controller, null);</b>
<b class="nc">&nbsp;            bvc = bv.getComponent(true);</b>
<b class="nc">&nbsp;            bv.setDisplayInvalidHexInfo(true);</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            JOptionPane</b>
<b class="nc">&nbsp;                    .showMessageDialog(</b>
&nbsp;                            frame,
<b class="nc">&nbsp;                            Messages.getString(&quot;BoardEditor.CouldntInitialize&quot;) + e,</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;BoardEditor.FatalError&quot;), JOptionPane.ERROR_MESSAGE); //$NON-NLS-1$</b>
&nbsp;            //$NON-NLS-2$
<b class="nc">&nbsp;            frame.dispose();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // Add a mouse listener for mouse button release 
&nbsp;        // to handle Undo
<b class="nc">&nbsp;        bv.addMouseListener(new MouseAdapter() {</b>
&nbsp;            @Override
&nbsp;            public void mouseReleased(MouseEvent e) {
<b class="nc">&nbsp;                if (e.getButton() == MouseEvent.BUTTON1) {</b>
&nbsp;                    // Act only if the user actually drew something
<b class="nc">&nbsp;                    if ((currentUndoSet != null) &amp;&amp;</b>
<b class="nc">&nbsp;                            !currentUndoSet.isEmpty()) {</b>
&nbsp;                        // Since this draw action is finished, push the
&nbsp;                        // drawn hexes onto the Undo Stack and get ready
&nbsp;                        // for a new draw action
<b class="nc">&nbsp;                        undoStack.push(currentUndoSet);</b>
<b class="nc">&nbsp;                        currentUndoSet = null;</b>
<b class="nc">&nbsp;                        buttonUndo.setEnabled(true);</b>
&nbsp;                        // Drawing something disables any redo actions
<b class="nc">&nbsp;                        redoStack.clear();</b>
<b class="nc">&nbsp;                        buttonRedo.setEnabled(false);</b>
&nbsp;                        // When Undo (without Redo) has been used after saving
&nbsp;                        // and the user draws on the board, then it can
&nbsp;                        // no longer know if it&#39;s been returned to the saved state
&nbsp;                        // and it will always be treated as changed.
<b class="nc">&nbsp;                        if (savedUndoStackSize &gt; undoStack.size()) {</b>
<b class="nc">&nbsp;                            canReturnToSaved = false;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        hasChanges = !canReturnToSaved | (undoStack.size() != savedUndoStackSize);</b>
&nbsp;                    }
&nbsp;                    // Mark the title when the board has changes
<b class="nc">&nbsp;                    setFrameTitle();</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        bv.addBoardViewListener(new BoardViewListenerAdapter() {</b>
&nbsp;            @Override
&nbsp;            public void hexMoused(BoardViewEvent b) {
<b class="nc">&nbsp;                Coords c = b.getCoords();</b>
&nbsp;                // return if there are no or no valid coords or if we click the same hex again
&nbsp;                // unless Raise/Lower Terrain is active which should let us click the same hex 
<b class="nc">&nbsp;                if ((c == null) || (c.equals(lastClicked) &amp;&amp; !buttonUpDn.isSelected())</b>
<b class="nc">&nbsp;                        || !board.contains(c)) {</b>
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;                lastClicked = c;</b>
<b class="nc">&nbsp;                bv.cursor(c);</b>
<b class="nc">&nbsp;                boolean isALT = (b.getModifiers() &amp; ActionEvent.ALT_MASK) != 0;</b>
<b class="nc">&nbsp;                boolean isSHIFT = (b.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0;</b>
<b class="nc">&nbsp;                boolean isCTRL = (b.getModifiers() &amp; ActionEvent.CTRL_MASK) != 0;</b>
<b class="nc">&nbsp;                boolean isLMB = (b.getModifiers() &amp; InputEvent.BUTTON1_MASK) != 0;</b>
&nbsp;
&nbsp;                // Raise/Lower Terrain is selected
<b class="nc">&nbsp;                if (buttonUpDn.isSelected()) {</b>
&nbsp;                    
&nbsp;                    // Mouse Button released
<b class="nc">&nbsp;                    if (b.getType() == BoardViewEvent.BOARD_HEX_CLICKED) {</b>
<b class="nc">&nbsp;                        hexLeveltoDraw = -1000;</b>
<b class="nc">&nbsp;                        isDragging = false;</b>
&nbsp;                    }
&nbsp;
&nbsp;                    // Mouse Button clicked or dragged
<b class="nc">&nbsp;                    if ((b.getType() == BoardViewEvent.BOARD_HEX_DRAGGED) &amp;&amp; isLMB) {</b>
<b class="nc">&nbsp;                        if (!isDragging) {</b>
<b class="nc">&nbsp;                            hexLeveltoDraw = board.getHex(c).getLevel();</b>
<b class="nc">&nbsp;                            if (isALT) hexLeveltoDraw--;</b>
<b class="nc">&nbsp;                            else if (isSHIFT) hexLeveltoDraw++;</b>
<b class="nc">&nbsp;                            isDragging = true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    // CORRECTION, click outside the board then drag inside???
<b class="nc">&nbsp;                    if (hexLeveltoDraw != -1000) {</b>
<b class="nc">&nbsp;                        LinkedList&lt;Coords&gt; allBrushHexes = getBrushCoords(c) ;</b>
<b class="nc">&nbsp;                        for (Coords h: allBrushHexes) {</b>
<b class="nc">&nbsp;                            if (!buttonOOC.isSelected() || board.getHex(h).isClearHex())</b>
&nbsp;                            {
<b class="nc">&nbsp;                                saveToUndo(h);</b>
<b class="nc">&nbsp;                                relevelHex(h);</b>
&nbsp;                            }   
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                    // ------- End Raise/Lower Terrain
&nbsp;                } else {
&nbsp;                    // Normal texture paint
<b class="nc">&nbsp;                    if (isALT) { // ALT-Click</b>
<b class="nc">&nbsp;                        setCurrentHex(board.getHex(b.getCoords()));</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        LinkedList&lt;Coords&gt; allBrushHexes = getBrushCoords(c);</b>
<b class="nc">&nbsp;                        for (Coords h: allBrushHexes) {</b>
&nbsp;                            // test if texture overwriting is active
<b class="nc">&nbsp;                            if ((!buttonOOC.isSelected() || board.getHex(h).isClearHex()) &amp;&amp; curHex.isValid(null))</b>
&nbsp;                            {
<b class="nc">&nbsp;                                saveToUndo(h);</b>
<b class="nc">&nbsp;                                if (isCTRL) { // CTRL-Click</b>
<b class="nc">&nbsp;                                    paintHex(h);</b>
<b class="nc">&nbsp;                                } else if (isSHIFT) { // SHIFT-Click</b>
<b class="nc">&nbsp;                                    addToHex(h);</b>
<b class="nc">&nbsp;                                } else if (isLMB) { // Normal click</b>
<b class="nc">&nbsp;                                    retextureHex(h);</b>
&nbsp;                                }
&nbsp;                            }
<b class="nc">&nbsp;                        }</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;        
<b class="nc">&nbsp;        bv.setUseLOSTool(false);</b>
<b class="nc">&nbsp;        setupEditorPanel();</b>
<b class="nc">&nbsp;        setupFrame();</b>
<b class="nc">&nbsp;        frame.setVisible(true);</b>
<b class="nc">&nbsp;        if (GUIPreferences.getInstance().getNagForMapEdReadme()) {</b>
<b class="nc">&nbsp;            String title = Messages.getString(&quot;BoardEditor.readme.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String body = Messages.getString(&quot;BoardEditor.readme.message&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            ConfirmDialog confirm = new ConfirmDialog(frame, title, body, true);</b>
<b class="nc">&nbsp;            confirm.setVisible(true);</b>
<b class="nc">&nbsp;            if (!confirm.getShowAgain()) {</b>
<b class="nc">&nbsp;                GUIPreferences.getInstance().setNagForMapEdReadme(false);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (confirm.getAnswer()) {</b>
<b class="nc">&nbsp;                showHelp();</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets up the frame that will display the editor.
&nbsp;     */
&nbsp;    private void setupFrame() {
<b class="nc">&nbsp;        scrollPane = new JScrollPane(this, ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,</b>
&nbsp;                ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
<b class="nc">&nbsp;        scrollPane.getVerticalScrollBar().setUnitIncrement(12);</b>
&nbsp;
<b class="nc">&nbsp;        setFrameTitle();</b>
<b class="nc">&nbsp;        frame.getContentPane().setLayout(new BorderLayout());</b>
&nbsp;
<b class="nc">&nbsp;        frame.getContentPane().add(bvc, BorderLayout.CENTER);</b>
<b class="nc">&nbsp;        frame.getContentPane().add(scrollPane, BorderLayout.EAST);</b>
<b class="nc">&nbsp;        menuBar.addActionListener(this);</b>
<b class="nc">&nbsp;        frame.setJMenuBar(menuBar);</b>
<b class="nc">&nbsp;        frame.setBackground(SystemColor.menu);</b>
<b class="nc">&nbsp;        frame.setForeground(SystemColor.menuText);</b>
<b class="nc">&nbsp;        if (GUIPreferences.getInstance().getWindowSizeHeight() != 0) {</b>
<b class="nc">&nbsp;            frame.setLocation(GUIPreferences.getInstance().getWindowPosX(),</b>
<b class="nc">&nbsp;                              GUIPreferences.getInstance().getWindowPosY());</b>
<b class="nc">&nbsp;            frame.setSize(GUIPreferences.getInstance().getWindowSizeWidth(),</b>
<b class="nc">&nbsp;                          GUIPreferences.getInstance().getWindowSizeHeight());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            frame.setSize(800, 600);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        frame.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</b>
<b class="nc">&nbsp;        frame.addWindowListener(new WindowAdapter() {</b>
&nbsp;            @Override
&nbsp;            public void windowClosing(WindowEvent e) {
&nbsp;                // When the board has changes, ask the user 
<b class="nc">&nbsp;                if (hasChanges) {</b>
<b class="nc">&nbsp;                    ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                    int savePrompt = JOptionPane.showConfirmDialog(null,</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;BoardEditor.exitprompt&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;BoardEditor.exittitle&quot;), //$NON-NLS-1$</b>
&nbsp;                            JOptionPane.YES_NO_CANCEL_OPTION,
&nbsp;                            JOptionPane.WARNING_MESSAGE);
<b class="nc">&nbsp;                    ignoreHotKeys = false;</b>
&nbsp;
&nbsp;                    // When the user cancels or did not actually save the board, don&#39;t close 
<b class="nc">&nbsp;                    if (((savePrompt == JOptionPane.YES_OPTION) &amp;&amp; !boardSave(false)) || </b>
&nbsp;                            (savePrompt == JOptionPane.CANCEL_OPTION)) {
&nbsp;                        return;
&nbsp;                    } 
&nbsp;                }
&nbsp;
&nbsp;                // otherwise: exit the Map Editor
<b class="nc">&nbsp;                minimapW.setVisible(false);</b>
<b class="nc">&nbsp;                if (controller != null) {</b>
<b class="nc">&nbsp;                    controller.removeAllActions();</b>
<b class="nc">&nbsp;                    controller.boardEditor = null;</b>
&nbsp;                }
<b class="nc">&nbsp;                frame.dispose();</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets up JButtons
&nbsp;     */
&nbsp;    private JButton prepareButton(String iconName, String buttonName, ArrayList&lt;JButton&gt; bList) {
<b class="nc">&nbsp;        JButton button = new JButton(buttonName);</b>
<b class="nc">&nbsp;        button.addActionListener(this);</b>
&nbsp;        // Get the normal icon
<b class="nc">&nbsp;        File file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        Image imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</b>
<b class="nc">&nbsp;        if (imageButton != null) {</b>
<b class="nc">&nbsp;            button.setIcon(new ImageIcon(imageButton));</b>
&nbsp;            // When there is an icon, then the text can be removed
<b class="nc">&nbsp;            button.setText(&quot;&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Get the hover icon
<b class="nc">&nbsp;        file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;_H.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</b>
<b class="nc">&nbsp;        if (imageButton != null) {</b>
<b class="nc">&nbsp;            button.setRolloverIcon(new ImageIcon(imageButton));</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Get the disabled icon, if any
<b class="nc">&nbsp;        file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;_G.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</b>
<b class="nc">&nbsp;        if (imageButton != null) {</b>
<b class="nc">&nbsp;            button.setDisabledIcon(new ImageIcon(imageButton));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        String tt = Messages.getString(&quot;BoardEditor.&quot;+iconName+&quot;TT&quot;);</b>
<b class="nc">&nbsp;        if (tt.length() != 0) {</b>
<b class="nc">&nbsp;            button.setToolTipText(tt); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;        }
<b class="nc">&nbsp;        button.setMargin(new Insets(0,0,0,0));</b>
<b class="nc">&nbsp;        if (bList != null) bList.add(button);</b>
<b class="nc">&nbsp;        return button;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Sets up JToggleButtons
&nbsp;     */
&nbsp;    private JToggleButton addTerrainTButton(String iconName, String buttonName, ArrayList&lt;JToggleButton&gt; bList) {
<b class="nc">&nbsp;        JToggleButton button = new JToggleButton(buttonName);</b>
<b class="nc">&nbsp;        button.addActionListener(this);</b>
&nbsp;        
&nbsp;        // Get the normal icon
<b class="nc">&nbsp;        File file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        Image imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</b>
<b class="nc">&nbsp;        if (imageButton != null) {</b>
<b class="nc">&nbsp;            button.setIcon(new ImageIcon(imageButton));</b>
&nbsp;            // When there is an icon, then the text can be removed
<b class="nc">&nbsp;            button.setText(&quot;&quot;);</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Get the hover icon
<b class="nc">&nbsp;        file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;_H.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</b>
<b class="nc">&nbsp;        if (imageButton != null)</b>
<b class="nc">&nbsp;            button.setRolloverIcon(new ImageIcon(imageButton));</b>
&nbsp;        
&nbsp;        // Get the selected icon
<b class="nc">&nbsp;        file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;_S.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</b>
<b class="nc">&nbsp;        if (imageButton != null)</b>
<b class="nc">&nbsp;            button.setSelectedIcon(new ImageIcon(imageButton));</b>
&nbsp;        
<b class="nc">&nbsp;        button.setToolTipText(Messages.getString(&quot;BoardEditor.&quot;+iconName+&quot;TT&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        if (bList != null) bList.add(button);</b>
<b class="nc">&nbsp;        return button;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets up the editor panel, which goes on the right of the map and has
&nbsp;     * controls for editing the current square.
&nbsp;     */
&nbsp;    private void setupEditorPanel() {
&nbsp;        // Help Texts
<b class="nc">&nbsp;        JLabel genHelpText1 = new JLabel(Messages.getString(&quot;BoardEditor.helpText&quot;),SwingConstants.LEFT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        JLabel terrainButtonHelp = new JLabel(Messages.getString(&quot;BoardEditor.helpText2&quot;),SwingConstants.LEFT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        genHelpText1.addMouseListener(clickToHide);</b>
<b class="nc">&nbsp;        terrainButtonHelp.addMouseListener(clickToHide);</b>
&nbsp;
&nbsp;        // Buttons to ease setting common terrain types
<b class="nc">&nbsp;        ArrayList&lt;JButton&gt; terrainButtons = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        buttonLW = prepareButton(&quot;ButtonLW&quot;, &quot;Woods&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonLJ = prepareButton(&quot;ButtonLJ&quot;, &quot;Jungle&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonOW = prepareButton(&quot;ButtonLLW&quot;, &quot;Low Woods&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonOJ = prepareButton(&quot;ButtonLLJ&quot;, &quot;Low Jungle&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonWa = prepareButton(&quot;ButtonWa&quot;, &quot;Water&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonSw = prepareButton(&quot;ButtonSw&quot;, &quot;Swamp&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonRo = prepareButton(&quot;ButtonRo&quot;, &quot;Rough&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonMd = prepareButton(&quot;ButtonMd&quot;, &quot;Mud&quot;, terrainButtons); </b>
<b class="nc">&nbsp;        buttonPv = prepareButton(&quot;ButtonPv&quot;, &quot;Pavement&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonSn = prepareButton(&quot;ButtonSn&quot;, &quot;Snow&quot;, terrainButtons); </b>
<b class="nc">&nbsp;        buttonBu = prepareButton(&quot;ButtonBu&quot;, &quot;Buildings&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonRd = prepareButton(&quot;ButtonRd&quot;, &quot;Roads&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonBr = prepareButton(&quot;ButtonBr&quot;, &quot;Bridges&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonFT = prepareButton(&quot;ButtonFT&quot;, &quot;Fuel Tanks&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonIc = prepareButton(&quot;ButtonIc&quot;, &quot;Ice&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonTu = prepareButton(&quot;ButtonTu&quot;, &quot;Tundra&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonMg = prepareButton(&quot;ButtonMg&quot;, &quot;Magma&quot;, terrainButtons);</b>
<b class="nc">&nbsp;        buttonCl = prepareButton(&quot;ButtonCl&quot;, &quot;Clear&quot;, terrainButtons);</b>
&nbsp;
<b class="nc">&nbsp;        ArrayList&lt;JToggleButton&gt; brushButtons = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        buttonBrush1 = addTerrainTButton(&quot;ButtonHex1&quot;, &quot;Brush1&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        buttonBrush2 = addTerrainTButton(&quot;ButtonHex7&quot;, &quot;Brush2&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        buttonBrush3 = addTerrainTButton(&quot;ButtonHex19&quot;, &quot;Brush3&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        ButtonGroup brushGroup = new ButtonGroup();</b>
<b class="nc">&nbsp;        brushGroup.add(buttonBrush1);</b>
<b class="nc">&nbsp;        brushGroup.add(buttonBrush2);</b>
<b class="nc">&nbsp;        brushGroup.add(buttonBrush3);</b>
<b class="nc">&nbsp;        buttonOOC = addTerrainTButton(&quot;ButtonOOC&quot;, &quot;OOC&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        buttonUpDn = addTerrainTButton(&quot;ButtonUpDn&quot;, &quot;UpDown&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;
<b class="nc">&nbsp;        ArrayList&lt;JButton&gt; undoButtons = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        buttonUndo = prepareButton(&quot;ButtonUndo&quot;, &quot;Undo&quot;, undoButtons); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        buttonRedo = prepareButton(&quot;ButtonRedo&quot;, &quot;Redo&quot;, undoButtons); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        buttonUndo.setEnabled(false);</b>
<b class="nc">&nbsp;        buttonRedo.setEnabled(false);</b>
&nbsp;
<b class="nc">&nbsp;        MouseWheelListener wheelListener = e -&gt; {</b>
<b class="nc">&nbsp;            int terrain = Integer.MIN_VALUE;</b>
<b class="nc">&nbsp;            if (e.getSource() == buttonRo) terrain = Terrains.ROUGH;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonSw) terrain = Terrains.SWAMP;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonWa) terrain = Terrains.WATER;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonLW) terrain = Terrains.WOODS;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonLJ) terrain = Terrains.JUNGLE;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonOW) terrain = Terrains.WOODS;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonOJ) terrain = Terrains.JUNGLE;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonMd) terrain = Terrains.MUD;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonPv) terrain = Terrains.PAVEMENT;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonIc) terrain = Terrains.ICE;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonSn) terrain = Terrains.SNOW;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonTu) terrain = Terrains.TUNDRA;</b>
<b class="nc">&nbsp;            else if (e.getSource() == buttonMg) terrain = Terrains.MAGMA;</b>
&nbsp;            else {
&nbsp;                return;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            IHex saveHex = curHex.duplicate();</b>
&nbsp;            // change the terrain level by wheel direction if present,
&nbsp;            // or set to 1 if not present
<b class="nc">&nbsp;            int newLevel = 1;</b>
<b class="nc">&nbsp;            if (curHex.containsTerrain(terrain)) {</b>
<b class="nc">&nbsp;                newLevel = curHex.terrainLevel(terrain) + (e.getWheelRotation() &lt; 0 ? 1 : -1);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                if (!e.isShiftDown()) {</b>
<b class="nc">&nbsp;                    curHex.removeAllTerrains();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            addSetTerrainEasy(terrain, newLevel);</b>
&nbsp;            // Add or adapt elevation helper terrain for foliage
&nbsp;            // When the elevation was 1, it stays 1 (L1 Foliage, TO p.36)
&nbsp;            // Otherwise, it is set to 3 for Ultra W/J and 2 otherwise (TW foliage)
<b class="nc">&nbsp;            if (terrain == Terrains.WOODS || terrain == Terrains.JUNGLE) {</b>
<b class="nc">&nbsp;                int elev = curHex.terrainLevel(Terrains.FOLIAGE_ELEV);</b>
<b class="nc">&nbsp;                if (elev != 1 &amp;&amp; newLevel == 3) {</b>
<b class="nc">&nbsp;                    elev = 3;</b>
<b class="nc">&nbsp;                } else if (elev != 1) {</b>
<b class="nc">&nbsp;                    elev = 2;</b>
&nbsp;                }
<b class="nc">&nbsp;                curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FOLIAGE_ELEV, elev));</b>
&nbsp;            }
&nbsp;            // Reset the terrain to the former state
&nbsp;            // if the new would be invalid.
<b class="nc">&nbsp;            if (!curHex.isValid(null)) {</b>
<b class="nc">&nbsp;                curHex = saveHex;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;        };
&nbsp;
<b class="nc">&nbsp;        buttonSw.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonWa.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonRo.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonLJ.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonLW.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonOJ.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonOW.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonMd.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonPv.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonSn.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonIc.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonTu.addMouseWheelListener(wheelListener);</b>
<b class="nc">&nbsp;        buttonMg.addMouseWheelListener(wheelListener);</b>
&nbsp;
&nbsp;        // Mouse wheel behaviour for the BUILDINGS button
&nbsp;        // Always ADDS the building. 
<b class="nc">&nbsp;        buttonBu.addMouseWheelListener(e -&gt; {</b>
&nbsp;            // Restore mandatory building parts if some are missing
<b class="nc">&nbsp;            setBasicBuilding(false);</b>
<b class="nc">&nbsp;            int wheelDir = (e.getWheelRotation() &lt; 0) ? 1 : -1;</b>
&nbsp;
<b class="nc">&nbsp;            if (e.isShiftDown()) {</b>
<b class="nc">&nbsp;                int oldLevel = curHex.getTerrain(Terrains.BLDG_CF).getLevel();</b>
<b class="nc">&nbsp;                int newLevel = Math.max(10, oldLevel + wheelDir*5);</b>
<b class="nc">&nbsp;                curHex.addTerrain(TF.createTerrain(Terrains.BLDG_CF, newLevel));</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            else if (e.isControlDown()) {</b>
<b class="nc">&nbsp;                int oldLevel = curHex.getTerrain(Terrains.BUILDING).getLevel();</b>
<b class="nc">&nbsp;                int newLevel = Math.max(1, Math.min(4, oldLevel + wheelDir)); // keep between 1 and 4</b>
&nbsp;
<b class="nc">&nbsp;                if (newLevel != oldLevel) {</b>
<b class="nc">&nbsp;                    ITerrain curTerr = curHex.getTerrain(Terrains.BUILDING);</b>
<b class="nc">&nbsp;                    curHex.addTerrain(TF.createTerrain(Terrains.BUILDING, </b>
<b class="nc">&nbsp;                            newLevel, curTerr.hasExitsSpecified(), curTerr.getExits()));</b>
&nbsp;
&nbsp;                    // Set the CF to the appropriate standard value *IF* it is the appropriate value now,
&nbsp;                    // i.e. if the user has not manually set it to something else
<b class="nc">&nbsp;                    int curCF = curHex.getTerrain(Terrains.BLDG_CF).getLevel();</b>
<b class="nc">&nbsp;                    if (curCF == Building.getDefaultCF(oldLevel)) </b>
<b class="nc">&nbsp;                        curHex.addTerrain(TF.createTerrain(Terrains.BLDG_CF, Building.getDefaultCF(newLevel)));</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;            else {
<b class="nc">&nbsp;                int oldLevel = curHex.getTerrain(Terrains.BLDG_ELEV).getLevel();</b>
<b class="nc">&nbsp;                int newLevel = Math.max(1, oldLevel + wheelDir);</b>
<b class="nc">&nbsp;                curHex.addTerrain(TF.createTerrain(Terrains.BLDG_ELEV, newLevel));</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;        });
&nbsp;
&nbsp;        // Mouse wheel behaviour for the BRIDGE button
<b class="nc">&nbsp;        buttonBr.addMouseWheelListener(e -&gt; {</b>
<b class="nc">&nbsp;            setBasicBridge();</b>
<b class="nc">&nbsp;            int wheelDir = (e.getWheelRotation() &lt; 0) ? 1 : -1;</b>
&nbsp;            int terrainType;
&nbsp;            int newLevel;
&nbsp;
<b class="nc">&nbsp;            if (e.isShiftDown()) {</b>
<b class="nc">&nbsp;                terrainType = Terrains.BRIDGE_CF;</b>
<b class="nc">&nbsp;                int oldLevel = curHex.getTerrain(terrainType).getLevel();</b>
<b class="nc">&nbsp;                newLevel = Math.max(10, oldLevel + wheelDir*10);</b>
<b class="nc">&nbsp;                curHex.addTerrain(TF.createTerrain(terrainType, newLevel));</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            else if (e.isControlDown()) {</b>
<b class="nc">&nbsp;                ITerrain terrain = curHex.getTerrain(Terrains.BRIDGE);</b>
<b class="nc">&nbsp;                boolean hasExits = terrain.hasExitsSpecified();</b>
<b class="nc">&nbsp;                int exits = terrain.getExits();</b>
<b class="nc">&nbsp;                newLevel = Math.max(1, terrain.getLevel() + wheelDir);</b>
<b class="nc">&nbsp;                curHex.addTerrain(TF.createTerrain(Terrains.BRIDGE, newLevel, hasExits, exits));</b>
<b class="nc">&nbsp;            }</b>
&nbsp;            else {
<b class="nc">&nbsp;                terrainType = Terrains.BRIDGE_ELEV;</b>
<b class="nc">&nbsp;                int oldLevel = curHex.getTerrain(terrainType).getLevel();</b>
<b class="nc">&nbsp;                newLevel = Math.max(0, oldLevel + wheelDir);</b>
<b class="nc">&nbsp;                curHex.addTerrain(TF.createTerrain(terrainType, newLevel));</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;        });
&nbsp;
&nbsp;        // Mouse wheel behaviour for the FUELTANKS button
<b class="nc">&nbsp;        buttonFT.addMouseWheelListener(e -&gt; {</b>
<b class="nc">&nbsp;            setBasicFuelTank();</b>
<b class="nc">&nbsp;            int wheelDir = (e.getWheelRotation() &lt; 0) ? 1 : -1;</b>
&nbsp;            int terrainType;
&nbsp;            int newLevel;
&nbsp;
<b class="nc">&nbsp;            if (e.isShiftDown()) {</b>
<b class="nc">&nbsp;                terrainType = Terrains.FUEL_TANK_CF;</b>
<b class="nc">&nbsp;                int oldLevel = curHex.getTerrain(terrainType).getLevel();</b>
<b class="nc">&nbsp;                newLevel = Math.max(10, oldLevel + wheelDir*10);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            else if (e.isControlDown()) {</b>
<b class="nc">&nbsp;                terrainType = Terrains.FUEL_TANK_MAGN;</b>
<b class="nc">&nbsp;                int oldLevel = curHex.getTerrain(terrainType).getLevel();</b>
<b class="nc">&nbsp;                newLevel = Math.max(10, oldLevel + wheelDir*10);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;            else {
<b class="nc">&nbsp;                terrainType = Terrains.FUEL_TANK_ELEV;</b>
<b class="nc">&nbsp;                int oldLevel = curHex.getTerrain(terrainType).getLevel();</b>
<b class="nc">&nbsp;                newLevel = Math.max(1, oldLevel + wheelDir);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(terrainType, newLevel));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        JPanel terrainButtonPanel = new JPanel(new GridLayout(0, 4, 2, 2));</b>
<b class="nc">&nbsp;        addManyButtons(terrainButtonPanel, terrainButtons);</b>
&nbsp;
<b class="nc">&nbsp;        JPanel brushButtonPanel = new JPanel(new GridLayout(0, 3, 2, 2));</b>
<b class="nc">&nbsp;        addManyTButtons(brushButtonPanel, brushButtons);</b>
<b class="nc">&nbsp;        buttonBrush1.setSelected(true);</b>
&nbsp;
<b class="nc">&nbsp;        JPanel undoButtonPanel = new JPanel(new GridLayout(1, 2, 2, 2));</b>
<b class="nc">&nbsp;        addManyButtons(undoButtonPanel, buttonUndo, buttonRedo);</b>
&nbsp;
&nbsp;        // Hex Elevation Control
<b class="nc">&nbsp;        texElev = new EditorTextField(&quot;0&quot;, 3); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        texElev.addActionListener(this);</b>
<b class="nc">&nbsp;        texElev.getDocument().addDocumentListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        butElevUp = prepareButton(&quot;ButtonHexUP&quot;, &quot;Raise Hex Elevation&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        butElevUp.setName(&quot;butElevUp&quot;);</b>
<b class="nc">&nbsp;        butElevUp.setToolTipText(Messages.getString(&quot;BoardEditor.butElevUp.toolTipText&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        butElevDown = prepareButton(&quot;ButtonHexDN&quot;, &quot;Lower Hex Elevation&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        butElevDown.setName(&quot;butElevDown&quot;);</b>
<b class="nc">&nbsp;        butElevDown.setToolTipText(Messages.getString(&quot;BoardEditor.butElevDown.toolTipText&quot;));</b>
&nbsp;
&nbsp;        // Terrain List
<b class="nc">&nbsp;        lisTerrainRenderer = new ComboboxToolTipRenderer();</b>
<b class="nc">&nbsp;        lisTerrain = new JList&lt;&gt;(new DefaultListModel&lt;&gt;());</b>
<b class="nc">&nbsp;        lisTerrain.addListSelectionListener(this);</b>
<b class="nc">&nbsp;        lisTerrain.setCellRenderer(lisTerrainRenderer);</b>
<b class="nc">&nbsp;        lisTerrain.setVisibleRowCount(6);</b>
<b class="nc">&nbsp;        lisTerrain.setFixedCellWidth(180);</b>
<b class="nc">&nbsp;        refreshTerrainList();</b>
&nbsp;
&nbsp;        // Terrain List, Preview, Delete
<b class="nc">&nbsp;        JPanel panlisHex = new JPanel(new FlowLayout(FlowLayout.LEFT,4,4));</b>
<b class="nc">&nbsp;        butDelTerrain = prepareButton(&quot;buttonRemT&quot;, &quot;Delete Terrain&quot;, null);</b>
<b class="nc">&nbsp;        butDelTerrain.setEnabled(false);</b>
<b class="nc">&nbsp;        canHex = new HexCanvas();</b>
<b class="nc">&nbsp;        panlisHex.add(butDelTerrain);</b>
<b class="nc">&nbsp;        panlisHex.add(new JScrollPane(lisTerrain));</b>
<b class="nc">&nbsp;        panlisHex.add(canHex);</b>
&nbsp;
&nbsp;        // Build the terrain list for the chooser ComboBox,
&nbsp;        // excluding terrains that are handled internally
<b class="nc">&nbsp;        ArrayList&lt;TerrainHelper&gt; tList = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int i = 1; i &lt; Terrains.SIZE; i++) {</b>
<b class="nc">&nbsp;            if (!Terrains.AUTOMATIC.contains(i)) {</b>
<b class="nc">&nbsp;                tList.add(new TerrainHelper(i));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        TerrainHelper[] terrains = new TerrainHelper[tList.size()]; </b>
<b class="nc">&nbsp;        tList.toArray(terrains);</b>
<b class="nc">&nbsp;        Arrays.sort(terrains);</b>
<b class="nc">&nbsp;        texTerrainLevel = new EditorTextField(&quot;0&quot;, 2, 0); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        texTerrainLevel.addActionListener(this);</b>
<b class="nc">&nbsp;        texTerrainLevel.getDocument().addDocumentListener(this);</b>
<b class="nc">&nbsp;        choTerrainType = new JComboBox&lt;&gt;(terrains);</b>
<b class="nc">&nbsp;        ComboboxToolTipRenderer renderer = new ComboboxToolTipRenderer();</b>
<b class="nc">&nbsp;        renderer.setTerrains(terrains);</b>
<b class="nc">&nbsp;        choTerrainType.setRenderer(renderer);</b>
&nbsp;        // Selecting a terrain type in the Dropdown should deselect
&nbsp;        // all in the terrain overview list except when selected from there
<b class="nc">&nbsp;        choTerrainType.addActionListener(e -&gt; { if (!terrListBlocker) lisTerrain.clearSelection(); });</b>
<b class="nc">&nbsp;        choTerrainType.setFont(fontComboTerr);</b>
<b class="nc">&nbsp;        butAddTerrain = new JButton(Messages.getString(&quot;BoardEditor.butAddTerrain&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butTerrUp = prepareButton(&quot;ButtonTLUP&quot;, &quot;Increase Terrain Level&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        butTerrDown = prepareButton(&quot;ButtonTLDN&quot;, &quot;Decrease Terrain Level&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;
&nbsp;        // Minimap Toggle
<b class="nc">&nbsp;        butMiniMap = new JButton(Messages.getString(&quot;BoardEditor.butMiniMap&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butMiniMap.setActionCommand(ClientGUI.VIEW_MINI_MAP);</b>
&nbsp;
&nbsp;        // Exits
<b class="nc">&nbsp;        cheTerrExitSpecified = new JCheckBox(Messages.getString(&quot;BoardEditor.cheTerrExitSpecified&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cheTerrExitSpecified.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;            noTextFieldUpdate = true;</b>
<b class="nc">&nbsp;            updateWhenSelected();</b>
<b class="nc">&nbsp;            noTextFieldUpdate = false;</b>
&nbsp;        });
<b class="nc">&nbsp;        butTerrExits = prepareButton(&quot;ButtonExitA&quot;, Messages.getString(&quot;BoardEditor.butTerrExits&quot;), null); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        texTerrExits = new EditorTextField(&quot;0&quot;, 2, 0); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        texTerrExits.addActionListener(this);</b>
<b class="nc">&nbsp;        texTerrExits.getDocument().addDocumentListener(this);</b>
<b class="nc">&nbsp;        butExitUp = prepareButton(&quot;ButtonEXUP&quot;, &quot;Increase Exit / Gfx&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        butExitDown = prepareButton(&quot;ButtonEXDN&quot;, &quot;Decrease Exit / Gfx&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;
&nbsp;        // Arrows and text fields for type and exits
<b class="nc">&nbsp;        JPanel panUP = new JPanel(new GridLayout(1,0,4,4));</b>
<b class="nc">&nbsp;        panUP.add(butTerrUp);</b>
<b class="nc">&nbsp;        panUP.add(butExitUp);</b>
<b class="nc">&nbsp;        panUP.add(butTerrExits);</b>
<b class="nc">&nbsp;        JPanel panTex = new JPanel(new GridLayout(1,0,4,4));</b>
<b class="nc">&nbsp;        panTex.add(texTerrainLevel);</b>
<b class="nc">&nbsp;        panTex.add(texTerrExits);</b>
<b class="nc">&nbsp;        panTex.add(cheTerrExitSpecified);</b>
<b class="nc">&nbsp;        JPanel panDN = new JPanel(new GridLayout(1,0,4,4));</b>
<b class="nc">&nbsp;        panDN.add(butTerrDown);</b>
<b class="nc">&nbsp;        panDN.add(butExitDown);</b>
<b class="nc">&nbsp;        panDN.add(Box.createHorizontalStrut(5));</b>
&nbsp;
&nbsp;        // Auto Exits to Pavement
<b class="nc">&nbsp;        cheRoadsAutoExit = new JCheckBox(Messages.getString(&quot;BoardEditor.cheRoadsAutoExit&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cheRoadsAutoExit.addItemListener(this);</b>
<b class="nc">&nbsp;        cheRoadsAutoExit.setSelected(true);</b>
&nbsp;
&nbsp;        // Theme
<b class="nc">&nbsp;        JPanel panTheme = new JPanel(new FlowLayout(FlowLayout.LEFT, 4, 4));</b>
<b class="nc">&nbsp;        JLabel labTheme = new JLabel(Messages.getString(&quot;BoardEditor.labTheme&quot;), SwingConstants.LEFT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choTheme = new JComboBox&lt;&gt;();</b>
<b class="nc">&nbsp;        TilesetManager tileMan = bv.getTilesetManager();</b>
<b class="nc">&nbsp;        Set&lt;String&gt; themes = tileMan.getThemes();</b>
<b class="nc">&nbsp;        for (String s: themes) choTheme.addItem(s);</b>
<b class="nc">&nbsp;        choTheme.addActionListener(this);</b>
<b class="nc">&nbsp;        panTheme.add(labTheme);</b>
<b class="nc">&nbsp;        panTheme.add(choTheme);</b>
&nbsp;
&nbsp;        // The hex settings panel (elevation, theme)
<b class="nc">&nbsp;        JPanel panelHexSettings = new JPanel();</b>
<b class="nc">&nbsp;        panelHexSettings.setBorder(new TitledBorder(new LineBorder(Color.BLUE, 1), &quot;Hex Settings&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        panelHexSettings.add(butElevUp);</b>
<b class="nc">&nbsp;        panelHexSettings.add(texElev);</b>
<b class="nc">&nbsp;        panelHexSettings.add(butElevDown);</b>
<b class="nc">&nbsp;        panelHexSettings.add(panTheme);</b>
&nbsp;
&nbsp;        // The terrain settings panel (type, level, exits)
<b class="nc">&nbsp;        JPanel panelTerrSettings = new JPanel(new GridLayout(0, 2, 4, 4));</b>
<b class="nc">&nbsp;        panelTerrSettings.setBorder(new TitledBorder(new LineBorder(Color.BLUE, 1), &quot;Terrain Settings&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        panelTerrSettings.add(Box.createVerticalStrut(5));</b>
<b class="nc">&nbsp;        panelTerrSettings.add(panUP);</b>
&nbsp;
<b class="nc">&nbsp;        panelTerrSettings.add(choTerrainType);</b>
<b class="nc">&nbsp;        panelTerrSettings.add(panTex);</b>
&nbsp;
<b class="nc">&nbsp;        panelTerrSettings.add(butAddTerrain);</b>
<b class="nc">&nbsp;        panelTerrSettings.add(panDN);</b>
&nbsp;
&nbsp;        // The board settings panel (Auto exit roads to pavement)
<b class="nc">&nbsp;        JPanel panelBoardSettings = new JPanel();</b>
<b class="nc">&nbsp;        panelBoardSettings.setBorder(new TitledBorder(new LineBorder(Color.BLUE, 1), &quot;Board Settings&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        panelBoardSettings.add(cheRoadsAutoExit);</b>
&nbsp;
&nbsp;        // Board Buttons (Save, Load...)
<b class="nc">&nbsp;        butBoardNew = new JButton(Messages.getString(&quot;BoardEditor.butBoardNew&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butBoardNew.setActionCommand(ClientGUI.FILE_BOARD_NEW);</b>
&nbsp;
<b class="nc">&nbsp;        butExpandMap = new JButton(Messages.getString(&quot;BoardEditor.butExpandMap&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butExpandMap.setActionCommand(FILE_BOARD_EDITOR_EXPAND);</b>
&nbsp;
<b class="nc">&nbsp;        butBoardOpen = new JButton(Messages.getString(&quot;BoardEditor.butBoardOpen&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butBoardOpen.setActionCommand(ClientGUI.FILE_BOARD_OPEN);</b>
&nbsp;
<b class="nc">&nbsp;        butBoardSave = new JButton(Messages.getString(&quot;BoardEditor.butBoardSave&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butBoardSave.setActionCommand(ClientGUI.FILE_BOARD_SAVE);</b>
&nbsp;
<b class="nc">&nbsp;        butBoardSaveAs = new JButton(Messages.getString(&quot;BoardEditor.butBoardSaveAs&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butBoardSaveAs.setActionCommand(ClientGUI.FILE_BOARD_SAVE_AS);</b>
&nbsp;
<b class="nc">&nbsp;        butBoardSaveAsImage = new JButton(Messages.getString(&quot;BoardEditor.butBoardSaveAsImage&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butBoardSaveAsImage.setActionCommand(ClientGUI.FILE_BOARD_SAVE_AS_IMAGE);</b>
&nbsp;
<b class="nc">&nbsp;        butBoardValidate = new JButton(Messages.getString(&quot;BoardEditor.butBoardValidate&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butBoardValidate.setActionCommand(FILE_BOARD_EDITOR_VALIDATE);</b>
&nbsp;        
<b class="nc">&nbsp;        butSourceFile = new JButton(Messages.getString(&quot;BoardEditor.butSourceFile&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butSourceFile.setActionCommand(FILE_SOURCEFILE);</b>
&nbsp;
<b class="nc">&nbsp;        addManyActionListeners(butBoardValidate, butBoardSaveAsImage, butBoardSaveAs, butBoardSave);</b>
<b class="nc">&nbsp;        addManyActionListeners(butBoardOpen, butExpandMap, butBoardNew, butMiniMap);</b>
<b class="nc">&nbsp;        addManyActionListeners(butDelTerrain, butAddTerrain, butSourceFile);</b>
&nbsp;        
&nbsp;
<b class="nc">&nbsp;        JPanel panButtons = new JPanel(new GridLayout(4, 2, 2, 2));</b>
<b class="nc">&nbsp;        addManyButtons(panButtons, butBoardNew, butBoardSave, butBoardOpen,</b>
&nbsp;                butExpandMap, butBoardSaveAs, butBoardSaveAsImage);
<b class="nc">&nbsp;        panButtons.add(butBoardValidate);</b>
<b class="nc">&nbsp;        panButtons.add(butMiniMap);</b>
<b class="nc">&nbsp;        if (Desktop.isDesktopSupported()) {</b>
<b class="nc">&nbsp;            panButtons.add(butSourceFile);</b>
&nbsp;        }
&nbsp;
&nbsp;        // ------------------
&nbsp;        // Arrange everything
&nbsp;        //
<b class="nc">&nbsp;        setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints cfullLine = new GridBagConstraints();</b>
<b class="nc">&nbsp;        GridBagConstraints cYFiller = new GridBagConstraints();</b>
&nbsp;
<b class="nc">&nbsp;        cfullLine.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        cfullLine.gridwidth = GridBagConstraints.REMAINDER;</b>
<b class="nc">&nbsp;        cfullLine.gridx = 0;</b>
<b class="nc">&nbsp;        cfullLine.insets = new Insets(4, 4, 1, 1);</b>
&nbsp;
<b class="nc">&nbsp;        cYFiller.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        cYFiller.gridwidth = GridBagConstraints.REMAINDER;</b>
<b class="nc">&nbsp;        cYFiller.gridx = 0;</b>
<b class="nc">&nbsp;        cYFiller.weighty = 1;</b>
<b class="nc">&nbsp;        cYFiller.insets = new Insets(4, 4, 1, 1);</b>
&nbsp;
&nbsp;        // Easy Access Terrain Buttons
<b class="nc">&nbsp;        add(genHelpText1, cfullLine);</b>
<b class="nc">&nbsp;        add(terrainButtonHelp, cfullLine);</b>
<b class="nc">&nbsp;        add(terrainButtonPanel, cfullLine);</b>
<b class="nc">&nbsp;        add(brushButtonPanel, cfullLine);</b>
<b class="nc">&nbsp;        add(new JLabel(&quot;&quot;), cYFiller); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        add(undoButtonPanel, cfullLine);</b>
<b class="nc">&nbsp;        add(new JLabel(&quot;&quot;), cYFiller); //$NON-NLS-1$</b>
&nbsp;
&nbsp;        // Terrain and Hex Control
<b class="nc">&nbsp;        add(panelBoardSettings, cfullLine);</b>
<b class="nc">&nbsp;        add(panelHexSettings, cfullLine);</b>
<b class="nc">&nbsp;        add(panelTerrSettings, cfullLine);</b>
&nbsp;
&nbsp;        // Terrain List and Preview Hex
<b class="nc">&nbsp;        add(panlisHex, cfullLine);</b>
&nbsp;
&nbsp;        // Board buttons
<b class="nc">&nbsp;        add(panButtons, cfullLine);</b>
&nbsp;
<b class="nc">&nbsp;        minimapW = new JDialog(frame, Messages</b>
<b class="nc">&nbsp;                .getString(&quot;BoardEditor.minimapW&quot;), false); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        minimapW.setLocation(GUIPreferences.getInstance().getMinimapPosX(),</b>
<b class="nc">&nbsp;                             GUIPreferences.getInstance().getMinimapPosY());</b>
&nbsp;        try {
<b class="nc">&nbsp;            minimap = new MiniMap(minimapW, game, bv);</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            JOptionPane</b>
<b class="nc">&nbsp;                    .showMessageDialog(</b>
&nbsp;                            frame,
&nbsp;                            Messages
<b class="nc">&nbsp;                                    .getString(&quot;BoardEditor.CouldNotInitialiseMinimap&quot;) + e,</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;BoardEditor.FatalError&quot;), JOptionPane.ERROR_MESSAGE); //$NON-NLS-1$</b>
&nbsp;            //$NON-NLS-2$
<b class="nc">&nbsp;            frame.dispose();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        minimapW.add(minimap);</b>
<b class="nc">&nbsp;        minimapW.setVisible(true);</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Returns coords that the active brush will paint on;
&nbsp;     * returns only coords that are valid, i.e. on the board
&nbsp;     */
&nbsp;    private LinkedList&lt;Coords&gt; getBrushCoords(Coords center) {
<b class="nc">&nbsp;        LinkedList&lt;Coords&gt; coords = new LinkedList&lt;&gt;();</b>
&nbsp;        // The center hex itself is always part of the brush
<b class="nc">&nbsp;        coords.add(center);</b>
&nbsp;        // Add surrounding hexes for the big brush
<b class="nc">&nbsp;        if (brushSize &gt; 1) {</b>
<b class="nc">&nbsp;            for (int dir: allDirections) </b>
<b class="nc">&nbsp;                coords.add(center.translated(dir));</b>
&nbsp;        } 
&nbsp;        // Add the surrounding hexes, radius 2 for the very big brush
<b class="nc">&nbsp;        if (brushSize &gt; 2) {</b>
<b class="nc">&nbsp;            for (int dir: allDirections) {</b>
<b class="nc">&nbsp;                Coords candC = center.translated(dir, 2);</b>
<b class="nc">&nbsp;                coords.add(candC);</b>
<b class="nc">&nbsp;                coords.add(candC.translated((dir+2)%6));</b>
&nbsp;            }
&nbsp;        } 
&nbsp;        // Remove coords that are not on the board
<b class="nc">&nbsp;        LinkedList&lt;Coords&gt; finalCoords = new LinkedList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (Coords c: coords) if (board.contains(c)) finalCoords.add(c);</b>
<b class="nc">&nbsp;        return finalCoords;</b>
&nbsp;    }
&nbsp;
&nbsp;    // Helper to shorten the code
&nbsp;    private void addManyActionListeners(JButton... buttons) {
<b class="nc">&nbsp;        for (JButton button: buttons) button.addActionListener(this);</b>
&nbsp;    }
&nbsp;    
&nbsp;    // Helper to shorten the code
&nbsp;    private void addManyButtons(JPanel panel, JButton... buttons) {
<b class="nc">&nbsp;        for (JButton button: buttons) panel.add(button);</b>
&nbsp;    }
&nbsp;    
&nbsp;    // Helper to shorten the code
&nbsp;    private void addManyButtons(JPanel panel, ArrayList&lt;JButton&gt; buttonList) {
<b class="nc">&nbsp;        for (JButton button: buttonList) panel.add(button);</b>
&nbsp;    }
&nbsp;    
&nbsp;    // Helper to shorten the code
&nbsp;    private void addManyTButtons(JPanel panel, ArrayList&lt;JToggleButton&gt; buttonList) {
<b class="nc">&nbsp;        for (JToggleButton button: buttonList) panel.add(button);</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Save the hex at c into the current undo Set
&nbsp;     */
&nbsp;    private void saveToUndo(Coords c) {
&nbsp;        // Create a new set of hexes to save for undoing
&nbsp;        // This will be filled as long as the mouse is dragged
<b class="nc">&nbsp;        if (currentUndoSet == null) {</b>
<b class="nc">&nbsp;            currentUndoSet = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;            currentUndoCoords = new HashSet&lt;&gt;();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!currentUndoCoords.contains(c)) {</b>
<b class="nc">&nbsp;            IHex hex = board.getHex(c).duplicate();</b>
&nbsp;            // Newly drawn board hexes do not know their Coords
<b class="nc">&nbsp;            hex.setCoords(c);</b>
<b class="nc">&nbsp;            currentUndoSet.add(hex);</b>
<b class="nc">&nbsp;            currentUndoCoords.add(c);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private void resetUndo() {
<b class="nc">&nbsp;        currentUndoSet = null;</b>
<b class="nc">&nbsp;        currentUndoCoords = null;</b>
<b class="nc">&nbsp;        undoStack.clear();</b>
<b class="nc">&nbsp;        redoStack.clear();</b>
<b class="nc">&nbsp;        buttonUndo.setEnabled(false);</b>
<b class="nc">&nbsp;        buttonRedo.setEnabled(false);</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Changes the hex level at Coords c. Expects c 
&nbsp;     * to be on the board.
&nbsp;     */
&nbsp;    private void relevelHex(Coords c) {
<b class="nc">&nbsp;        IHex newHex = board.getHex(c).duplicate(); </b>
<b class="nc">&nbsp;        newHex.setLevel(hexLeveltoDraw);</b>
<b class="nc">&nbsp;        board.resetStoredElevation();</b>
<b class="nc">&nbsp;        board.setHex(c, newHex);</b>
&nbsp;        
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Apply the current Hex to the Board at the specified location.
&nbsp;     */
&nbsp;    void paintHex(Coords c) {
<b class="nc">&nbsp;        board.resetStoredElevation();</b>
<b class="nc">&nbsp;        board.setHex(c, curHex.duplicate());</b>
&nbsp;    } 
&nbsp;    
&nbsp;    /**
&nbsp;     * Apply the current Hex to the Board at the specified location.
&nbsp;     */
&nbsp;    public void retextureHex(Coords c) {
<b class="nc">&nbsp;        if (board.contains(c)) {</b>
<b class="nc">&nbsp;            IHex newHex = curHex.duplicate();</b>
<b class="nc">&nbsp;            newHex.setLevel(board.getHex(c).getLevel());</b>
<b class="nc">&nbsp;            board.resetStoredElevation();</b>
<b class="nc">&nbsp;            board.setHex(c, newHex);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Apply the current Hex to the Board at the specified location.
&nbsp;     */
&nbsp;    public void addToHex(Coords c) {
<b class="nc">&nbsp;        if (board.contains(c)) {</b>
<b class="nc">&nbsp;            IHex newHex = curHex.duplicate();</b>
<b class="nc">&nbsp;            IHex oldHex = board.getHex(c);</b>
<b class="nc">&nbsp;            newHex.setLevel(oldHex.getLevel());</b>
<b class="nc">&nbsp;            int[] terrainTypes = oldHex.getTerrainTypes();</b>
<b class="nc">&nbsp;            for (int terrainID : terrainTypes) {</b>
<b class="nc">&nbsp;                if (!newHex.containsTerrain(terrainID) &amp;&amp; oldHex.containsTerrain(terrainID)) {</b>
<b class="nc">&nbsp;                    newHex.addTerrain(oldHex.getTerrain(terrainID));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            board.resetStoredElevation();</b>
<b class="nc">&nbsp;            board.setHex(c, newHex);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the working hex to &lt;code&gt;hex&lt;/code&gt;;
&nbsp;     * used for mouse ALT-click (eyedropper function).
&nbsp;     *
&nbsp;     * @param hex hex to set.
&nbsp;     */
&nbsp;    void setCurrentHex(IHex hex) {
<b class="nc">&nbsp;        curHex = hex.duplicate();</b>
<b class="nc">&nbsp;        texElev.setText(Integer.toString(curHex.getLevel()));</b>
<b class="nc">&nbsp;        refreshTerrainList();</b>
<b class="nc">&nbsp;        if (lisTerrain.getModel().getSize() &gt; 0) {</b>
<b class="nc">&nbsp;            lisTerrain.setSelectedIndex(0);</b>
<b class="nc">&nbsp;            refreshTerrainFromList();</b>
&nbsp;        }
<b class="nc">&nbsp;        choTheme.setSelectedItem(curHex.getTheme());</b>
<b class="nc">&nbsp;        repaint();</b>
<b class="nc">&nbsp;        repaintWorkingHex();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void repaintWorkingHex() {
<b class="nc">&nbsp;        if (curHex != null) {</b>
<b class="nc">&nbsp;            TilesetManager tm = bv.getTilesetManager();</b>
<b class="nc">&nbsp;            tm.clearHex(curHex);</b>
&nbsp;        }
<b class="nc">&nbsp;        canHex.repaint();</b>
<b class="nc">&nbsp;        lastClicked = null;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Refreshes the terrain list to match the current hex
&nbsp;     */
&nbsp;    private void refreshTerrainList() {
&nbsp;        
<b class="nc">&nbsp;        ((DefaultListModel&lt;TerrainTypeHelper&gt;)lisTerrain.getModel()).removeAllElements();</b>
<b class="nc">&nbsp;        lisTerrainRenderer.setTerrainTypes(null);</b>
<b class="nc">&nbsp;        int[] terrainTypes = curHex.getTerrainTypes();</b>
<b class="nc">&nbsp;        List&lt;TerrainTypeHelper&gt; types = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int terrainType : terrainTypes) {</b>
<b class="nc">&nbsp;            ITerrain terrain = curHex.getTerrain(terrainType);</b>
<b class="nc">&nbsp;            if (terrain != null &amp;&amp; !Terrains.AUTOMATIC.contains(terrainType)) {</b>
<b class="nc">&nbsp;                TerrainTypeHelper tth = new TerrainTypeHelper(terrain);</b>
<b class="nc">&nbsp;                types.add(tth);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        Collections.sort(types);</b>
<b class="nc">&nbsp;        for (TerrainTypeHelper tth : types) {</b>
<b class="nc">&nbsp;            ((DefaultListModel&lt;TerrainTypeHelper&gt;) lisTerrain.getModel()).addElement(tth);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        lisTerrainRenderer.setTerrainTypes(types);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a new instance of the terrain that is currently entered in the
&nbsp;     * terrain input fields
&nbsp;     */
&nbsp;    private ITerrain enteredTerrain() {
<b class="nc">&nbsp;        int type = ((TerrainHelper)choTerrainType.getSelectedItem()).getTerrainType();</b>
<b class="nc">&nbsp;        int level = texTerrainLevel.getNumber();  </b>
&nbsp;        // For the terrain subtypes that only add to a main terrain type exits make no
&nbsp;        // sense at all. Therefore simply do not add them
<b class="nc">&nbsp;        if ((type == Terrains.BLDG_ARMOR) || (type == Terrains.BLDG_CF) </b>
&nbsp;                || (type == Terrains.BLDG_ELEV) || (type == Terrains.BLDG_CLASS)  
&nbsp;                || (type == Terrains.BLDG_BASE_COLLAPSED) || (type == Terrains.BLDG_BASEMENT_TYPE)
&nbsp;                || (type == Terrains.BRIDGE_CF) || (type == Terrains.BRIDGE_ELEV)
&nbsp;                || (type == Terrains.FUEL_TANK_CF) || (type == Terrains.FUEL_TANK_ELEV)
&nbsp;                || (type == Terrains.FUEL_TANK_MAGN)) 
&nbsp;        {
<b class="nc">&nbsp;            return Terrains.getTerrainFactory().createTerrain(type, level, false, 0);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            boolean exitsSpecified = cheTerrExitSpecified.isSelected();</b>
<b class="nc">&nbsp;            int exits = texTerrExits.getNumber();</b>
<b class="nc">&nbsp;            return Terrains.getTerrainFactory().createTerrain(type, level, exitsSpecified, exits);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Add or set the terrain to the list based on the fields.
&nbsp;     */
&nbsp;    private void addSetTerrain() {
<b class="nc">&nbsp;        ITerrain toAdd = enteredTerrain();</b>
<b class="nc">&nbsp;        if (((toAdd.getType() == Terrains.BLDG_ELEV) </b>
<b class="nc">&nbsp;                || (toAdd.getType() == Terrains.BRIDGE_ELEV))</b>
<b class="nc">&nbsp;                &amp;&amp; toAdd.getLevel() &lt; 0) {</b>
<b class="nc">&nbsp;            texTerrainLevel.setNumber(0);</b>
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(frame,</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;BoardEditor.BridgeBuildingElevError&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;BoardEditor.invalidTerrainTitle&quot;), //$NON-NLS-1$ </b>
&nbsp;                    JOptionPane.ERROR_MESSAGE);
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        curHex.addTerrain(toAdd);</b>
<b class="nc">&nbsp;        int formerSelection = lisTerrain.getSelectedIndex();</b>
<b class="nc">&nbsp;        noTextFieldUpdate = true;</b>
<b class="nc">&nbsp;        refreshTerrainList();</b>
<b class="nc">&nbsp;        lisTerrain.setSelectedIndex(formerSelection);</b>
<b class="nc">&nbsp;        lisTerrain.ensureIndexIsVisible(formerSelection);</b>
<b class="nc">&nbsp;        repaintWorkingHex();</b>
<b class="nc">&nbsp;        noTextFieldUpdate = false;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Add to the terrain from one of the easy access buttons
&nbsp;     */
&nbsp;    private void addSetTerrainEasy(int type, int level) {
<b class="nc">&nbsp;        boolean exitsSpecified = cheTerrExitSpecified.isSelected();</b>
<b class="nc">&nbsp;        int exits = texTerrExits.getNumber();</b>
<b class="nc">&nbsp;        ITerrain toAdd = Terrains.getTerrainFactory().createTerrain(type, level, exitsSpecified, exits);</b>
<b class="nc">&nbsp;        curHex.addTerrain(toAdd);</b>
<b class="nc">&nbsp;        TerrainTypeHelper toSelect = new TerrainTypeHelper(toAdd);</b>
<b class="nc">&nbsp;        refreshTerrainList();</b>
<b class="nc">&nbsp;        lisTerrain.setSelectedValue(toSelect, true);</b>
<b class="nc">&nbsp;        repaintWorkingHex();</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Sets valid basic Fuel Tank values as far as they are missing
&nbsp;     */
&nbsp;    private void setBasicFuelTank() {
&nbsp;        // There is only fuel_tank:1, so this can be set
<b class="nc">&nbsp;        curHex.addTerrain(TF.createTerrain(Terrains.FUEL_TANK, 1, true, 0));</b>
&nbsp;
<b class="nc">&nbsp;        if (!curHex.containsTerrain(Terrains.FUEL_TANK_CF)) </b>
<b class="nc">&nbsp;         curHex.addTerrain(TF.createTerrain(Terrains.FUEL_TANK_CF, 40, false, 0));</b>
&nbsp;        
<b class="nc">&nbsp;        if (!curHex.containsTerrain(Terrains.FUEL_TANK_ELEV)) </b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.FUEL_TANK_ELEV, 1, false, 0));</b>
&nbsp;        
<b class="nc">&nbsp;        if (!curHex.containsTerrain(Terrains.FUEL_TANK_MAGN)) </b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.FUEL_TANK_MAGN, 100, false, 0));</b>
&nbsp;        
<b class="nc">&nbsp;        refreshTerrainList();</b>
<b class="nc">&nbsp;        repaintWorkingHex();</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Sets valid basic bridge values as far as they are missing
&nbsp;     */
&nbsp;    private void setBasicBridge() {
<b class="nc">&nbsp;        if (!curHex.containsTerrain(Terrains.BRIDGE_CF)) </b>
<b class="nc">&nbsp;         curHex.addTerrain(TF.createTerrain(Terrains.BRIDGE_CF, 40, false, 0));</b>
&nbsp;        
<b class="nc">&nbsp;        if (!curHex.containsTerrain(Terrains.BRIDGE_ELEV)) </b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.BRIDGE_ELEV, 1, false, 0));</b>
&nbsp;        
<b class="nc">&nbsp;        if (!curHex.containsTerrain(Terrains.BRIDGE)) </b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.BRIDGE, 1, false, 0));</b>
&nbsp;        
<b class="nc">&nbsp;        refreshTerrainList();</b>
<b class="nc">&nbsp;        repaintWorkingHex();</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Sets valid basic Building values as far as they are missing
&nbsp;     */
&nbsp;    private void setBasicBuilding(boolean ALT_Held) {
<b class="nc">&nbsp;        if (!curHex.containsTerrain(Terrains.BLDG_CF)) </b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.BLDG_CF, 15, false, 0));</b>
&nbsp;
<b class="nc">&nbsp;        if (!curHex.containsTerrain(Terrains.BLDG_ELEV)) </b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.BLDG_ELEV, 1, false, 0));</b>
&nbsp;
<b class="nc">&nbsp;        if (!curHex.containsTerrain(Terrains.BUILDING))</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.BUILDING, 1, ALT_Held, 0));</b>
&nbsp;
&nbsp;        // When clicked with ALT and a Building is present, only toggle the exits
<b class="nc">&nbsp;        if (curHex.containsTerrain(Terrains.BUILDING) &amp;&amp; ALT_Held) {</b>
<b class="nc">&nbsp;            ITerrain curTerr = curHex.getTerrain(Terrains.BUILDING);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.BUILDING, </b>
<b class="nc">&nbsp;                    curTerr.getLevel(), !curTerr.hasExitsSpecified(), curTerr.getExits()));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        refreshTerrainList();</b>
<b class="nc">&nbsp;        repaintWorkingHex();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Set all the appropriate terrain fields to match the currently selected
&nbsp;     * terrain in the list.
&nbsp;     */
&nbsp;    private void refreshTerrainFromList() {
<b class="nc">&nbsp;        if (lisTerrain.isSelectionEmpty()) {</b>
<b class="nc">&nbsp;            butDelTerrain.setEnabled(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            butDelTerrain.setEnabled(true);</b>
<b class="nc">&nbsp;            ITerrain terrain = Terrains.getTerrainFactory().createTerrain(</b>
<b class="nc">&nbsp;                    lisTerrain.getSelectedValue().getTerrain());</b>
<b class="nc">&nbsp;            terrain = curHex.getTerrain(terrain.getType());</b>
<b class="nc">&nbsp;            TerrainHelper terrainHelper = new TerrainHelper(terrain.getType());</b>
<b class="nc">&nbsp;            terrListBlocker = true;</b>
<b class="nc">&nbsp;            choTerrainType.setSelectedItem(terrainHelper);</b>
<b class="nc">&nbsp;            texTerrainLevel.setText(Integer.toString(terrain.getLevel()));</b>
<b class="nc">&nbsp;            cheTerrExitSpecified.setSelected(terrain.hasExitsSpecified());</b>
<b class="nc">&nbsp;            texTerrExits.setNumber(terrain.getExits());</b>
<b class="nc">&nbsp;            terrListBlocker = false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Updates the selected terrain in the terrain list if
&nbsp;     * a terrain is actually selected
&nbsp;     */
&nbsp;    private void updateWhenSelected() {
<b class="nc">&nbsp;        if (!lisTerrain.isSelectionEmpty())</b>
<b class="nc">&nbsp;            addSetTerrain();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void boardNew(boolean showDialog) {
<b class="nc">&nbsp;        boolean userCancel = false;</b>
<b class="nc">&nbsp;        if (showDialog) {</b>
<b class="nc">&nbsp;            RandomMapDialog rmd = new RandomMapDialog(frame, this, null, mapSettings);</b>
<b class="nc">&nbsp;            userCancel = rmd.activateDialog(bv.getTilesetManager().getThemes());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!userCancel) {</b>
<b class="nc">&nbsp;            board = BoardUtilities.generateRandom(mapSettings);</b>
&nbsp;            // &quot;Initialize&quot; all hexes to add internally handled terrains
<b class="nc">&nbsp;            correctExits();</b>
<b class="nc">&nbsp;            game.setBoard(board);</b>
<b class="nc">&nbsp;            curBoardFile = null;</b>
<b class="nc">&nbsp;            choTheme.setSelectedItem(mapSettings.getTheme());</b>
<b class="nc">&nbsp;            setupUiFreshBoard();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void boardResize() {
<b class="nc">&nbsp;        ResizeMapDialog emd = new ResizeMapDialog(frame, this, null, mapSettings);</b>
<b class="nc">&nbsp;        boolean userCancel = emd.activateDialog(bv.getTilesetManager().getThemes());</b>
<b class="nc">&nbsp;        if (!userCancel) {</b>
<b class="nc">&nbsp;            board = BoardUtilities.generateRandom(mapSettings);</b>
&nbsp;
&nbsp;            // Implant the old board
<b class="nc">&nbsp;            int west = emd.getExpandWest();</b>
<b class="nc">&nbsp;            int north = emd.getExpandNorth();</b>
<b class="nc">&nbsp;            int east = emd.getExpandEast();</b>
<b class="nc">&nbsp;            int south = emd.getExpandSouth();</b>
<b class="nc">&nbsp;            board = implantOldBoard(game, west, north, east, south);</b>
&nbsp;
<b class="nc">&nbsp;            game.setBoard(board);</b>
<b class="nc">&nbsp;            curBoardFile = null;</b>
<b class="nc">&nbsp;            setupUiFreshBoard();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // When we resize a board, implant the old board&#39;s hexes where they should be in the new board
&nbsp;    public IBoard implantOldBoard(IGame game, int west, int north, int east, int south) {
<b class="nc">&nbsp;        IBoard oldBoard = game.getBoard();</b>
<b class="nc">&nbsp;        for (int x = 0; x &lt; oldBoard.getWidth(); x++) {</b>
<b class="nc">&nbsp;            for (int y = 0; y &lt; oldBoard.getHeight(); y++) {</b>
<b class="nc">&nbsp;                int newX = x+west;</b>
<b class="nc">&nbsp;                int odd = x &amp; 1 &amp; west;</b>
<b class="nc">&nbsp;                int newY = y+north + odd;</b>
<b class="nc">&nbsp;                if (oldBoard.contains(x, y) &amp;&amp; board.contains(newX, newY)) {</b>
<b class="nc">&nbsp;                    IHex oldHex = oldBoard.getHex(x, y);</b>
<b class="nc">&nbsp;                    IHex hex = board.getHex(newX, newY);</b>
<b class="nc">&nbsp;                    hex.removeAllTerrains();</b>
<b class="nc">&nbsp;                        hex.setLevel(oldHex.getLevel());</b>
<b class="nc">&nbsp;                    int[] terrainTypes = oldHex.getTerrainTypes();</b>
<b class="nc">&nbsp;                    for (int terrainID : terrainTypes) {</b>
<b class="nc">&nbsp;                        if (!hex.containsTerrain(terrainID) &amp;&amp;</b>
<b class="nc">&nbsp;                                oldHex.containsTerrain(terrainID)) {</b>
<b class="nc">&nbsp;                            hex.addTerrain(oldHex.getTerrain(terrainID));</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    hex.setTheme(oldHex.getTheme());</b>
<b class="nc">&nbsp;                    board.setHex(newX, newY, hex);</b>
<b class="nc">&nbsp;                    board.resetStoredElevation();</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return board;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void updateMapSettings(MapSettings newSettings) {
<b class="nc">&nbsp;        mapSettings = newSettings;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void boardLoad() {
<b class="nc">&nbsp;        JFileChooser fc = new JFileChooser(loadPath);</b>
<b class="nc">&nbsp;        setDialogSize(fc);</b>
<b class="nc">&nbsp;        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.loadBoard&quot;));</b>
<b class="nc">&nbsp;        fc.setFileFilter(new BoardFileFilter());</b>
<b class="nc">&nbsp;        int returnVal = fc.showOpenDialog(frame);</b>
<b class="nc">&nbsp;        saveDialogSize(fc);</b>
<b class="nc">&nbsp;        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</b>
&nbsp;            // I want a file, y&#39;know!
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        curBoardFile = fc.getSelectedFile();</b>
<b class="nc">&nbsp;        loadPath = curBoardFile.getParentFile();</b>
&nbsp;        // load!
<b class="nc">&nbsp;        try (InputStream is = new FileInputStream(fc.getSelectedFile())) {            </b>
&nbsp;            // tell the board to load!
<b class="nc">&nbsp;            board.load(is, null, true);</b>
&nbsp;            // Board generation in a game always calls BoardUtilities.combine
&nbsp;            // This serves no purpose here, but is necessary to create 
&nbsp;            // flipBGVert/flipBGHoriz lists for the board, which is necessary 
&nbsp;            // for the background image to work in the BoardEditor
<b class="nc">&nbsp;            board = BoardUtilities.combine(board.getWidth(), board.getHeight(), 1, 1, </b>
<b class="nc">&nbsp;                    new IBoard[]{board}, Collections.singletonList(false), MapSettings.MEDIUM_GROUND);</b>
<b class="nc">&nbsp;            game.setBoard(board);</b>
<b class="nc">&nbsp;            cheRoadsAutoExit.setSelected(board.getRoadsAutoExit());</b>
<b class="nc">&nbsp;            mapSettings.setBoardSize(board.getWidth(), board.getHeight());</b>
&nbsp;            
&nbsp;            // Now, *after* initialization of the board which will correct some errors,
&nbsp;            // do a board validation
<b class="nc">&nbsp;            validateBoard(false);</b>
&nbsp;            
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            setupUiFreshBoard();</b>
<b class="nc">&nbsp;        } catch (IOException ex) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(ex);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Will do board.initializeHex() for all hexes, correcting 
&nbsp;     * building and road connection issues for those hexes that do not have
&nbsp;     * the exits check set.
&nbsp;     */
&nbsp;    private void correctExits() {
<b class="nc">&nbsp;        for (int x = 0; x &lt; board.getWidth(); x++) {</b>
<b class="nc">&nbsp;            for (int y = 0; y &lt; board.getHeight(); y++) {</b>
<b class="nc">&nbsp;                board.initializeHex(x, y);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Saves the board in PNG image format.
&nbsp;     */
&nbsp;    private void boardSaveImage(boolean ignoreUnits) {
<b class="nc">&nbsp;        if (curfileImage == null) {</b>
<b class="nc">&nbsp;            boardSaveAsImage(ignoreUnits);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        JDialog waitD = new JDialog(frame, Messages.getString(&quot;BoardEditor.waitDialog.title&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        waitD.add(new JLabel(Messages.getString(&quot;BoardEditor.waitDialog.message&quot;))); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        waitD.setSize(250, 130);</b>
&nbsp;        // move to middle of screen
<b class="nc">&nbsp;        waitD.setLocation(</b>
<b class="nc">&nbsp;                (frame.getSize().width / 2) - (waitD.getSize().width / 2),</b>
<b class="nc">&nbsp;                (frame.getSize().height / 2) - (waitD.getSize().height / 2));</b>
<b class="nc">&nbsp;        waitD.setVisible(true);</b>
<b class="nc">&nbsp;        frame.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</b>
<b class="nc">&nbsp;        waitD.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</b>
&nbsp;        // save!
&nbsp;        try {
<b class="nc">&nbsp;            ImageIO.write(bv.getEntireBoardImage(ignoreUnits), &quot;png&quot;, curfileImage);</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        waitD.setVisible(false);</b>
<b class="nc">&nbsp;        frame.setCursor(Cursor.getDefaultCursor());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Saves the board to a .board file. 
&nbsp;     * When saveAs is true, acts as a Save As... by opening a file chooser dialog.
&nbsp;     * When saveAs is false, it will directly save to the current board file name,
&nbsp;     * if it is known and otherwise act as Save As... 
&nbsp;     */
&nbsp;    private boolean boardSave(boolean saveAs) {
&nbsp;        // Correct connection issues and do a validation.
<b class="nc">&nbsp;        correctExits();</b>
<b class="nc">&nbsp;        validateBoard(false); </b>
&nbsp;        
&nbsp;        // Choose a board file to save to if this was
&nbsp;        // called as &quot;Save As...&quot; or there is no current filename
<b class="nc">&nbsp;        if (curBoardFile == null || saveAs) {</b>
<b class="nc">&nbsp;            if (!chooseSaveBoardFile()) {</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // write the board
<b class="nc">&nbsp;        try (OutputStream os = new FileOutputStream(curBoardFile)) {</b>
<b class="nc">&nbsp;            board.save(os);</b>
&nbsp;            
&nbsp;            // Adapt to successful save
<b class="nc">&nbsp;            butSourceFile.setEnabled(true);</b>
<b class="nc">&nbsp;            savedUndoStackSize = undoStack.size();</b>
<b class="nc">&nbsp;            hasChanges = false;</b>
<b class="nc">&nbsp;            setFrameTitle();</b>
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } catch (IOException ex) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(ex);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /** 
&nbsp;     * Shows a dialog for choosing a .board file to save to. 
&nbsp;     * Sets curBoardFile and returns true when a valid file was chosen.
&nbsp;     * Returns false otherwise.
&nbsp;     */
&nbsp;    private boolean chooseSaveBoardFile() {
<b class="nc">&nbsp;        JFileChooser fc = new JFileChooser(loadPath);</b>
<b class="nc">&nbsp;        setDialogSize(fc);</b>
<b class="nc">&nbsp;        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</b>
<b class="nc">&nbsp;        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveBoardAs&quot;));</b>
<b class="nc">&nbsp;        fc.setFileFilter(new BoardFileFilter());</b>
<b class="nc">&nbsp;        int returnVal = fc.showSaveDialog(frame);</b>
<b class="nc">&nbsp;        saveDialogSize(fc);</b>
<b class="nc">&nbsp;        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</b>
<b class="nc">&nbsp;            return false; </b>
&nbsp;        }
<b class="nc">&nbsp;        File choice = fc.getSelectedFile();</b>
&nbsp;        // make sure the file ends in board
<b class="nc">&nbsp;        if (!choice.getName().toLowerCase().endsWith(&quot;.board&quot;)) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                choice = new File(choice.getCanonicalPath() + &quot;.board&quot;);</b>
<b class="nc">&nbsp;            } catch (IOException ie) {</b>
<b class="nc">&nbsp;                return false;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        curBoardFile = choice;</b>
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Opens a file dialog box to select a file to save as; saves the board to
&nbsp;     * the file as an image. Useful for printing boards.
&nbsp;     */
&nbsp;    private void boardSaveAsImage(boolean ignoreUnits) {
<b class="nc">&nbsp;        JFileChooser fc = new JFileChooser(&quot;.&quot;);</b>
<b class="nc">&nbsp;        setDialogSize(fc);</b>
<b class="nc">&nbsp;        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</b>
<b class="nc">&nbsp;        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveAsImage&quot;));</b>
<b class="nc">&nbsp;        fc.setFileFilter(new FileFilter() {</b>
&nbsp;            @Override
&nbsp;            public boolean accept(File dir) {
<b class="nc">&nbsp;                return (dir.getName().endsWith(&quot;.png&quot;) || dir.isDirectory()); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public String getDescription() {
<b class="nc">&nbsp;                return &quot;.png&quot;;</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        int returnVal = fc.showSaveDialog(frame);</b>
<b class="nc">&nbsp;        saveDialogSize(fc);</b>
<b class="nc">&nbsp;        if ((returnVal != JFileChooser.APPROVE_OPTION)</b>
<b class="nc">&nbsp;            || (fc.getSelectedFile() == null)) {</b>
&nbsp;            // I want a file, y&#39;know!
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        curfileImage = fc.getSelectedFile();</b>
&nbsp;
&nbsp;        // make sure the file ends in png
<b class="nc">&nbsp;        if (!curfileImage.getName().toLowerCase().endsWith(&quot;.png&quot;)) { //$NON-NLS-1$</b>
&nbsp;            try {
<b class="nc">&nbsp;                curfileImage = new File(curfileImage.getCanonicalPath() + &quot;.png&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } catch (IOException ie) {</b>
&nbsp;                // failure!
&nbsp;                return;
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        boardSaveImage(ignoreUnits);</b>
&nbsp;    }
&nbsp;
&nbsp;    //
&nbsp;    // ItemListener
&nbsp;    //
&nbsp;    public void itemStateChanged(ItemEvent ie) {
<b class="nc">&nbsp;        if (ie.getSource().equals(cheRoadsAutoExit)) {</b>
&nbsp;            // Set the new value for the option, and refresh the board.
<b class="nc">&nbsp;            board.setRoadsAutoExit(cheRoadsAutoExit.isSelected());</b>
<b class="nc">&nbsp;            bv.updateBoard();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    //
&nbsp;    // TextListener
&nbsp;    //
&nbsp;    public void changedUpdate(DocumentEvent te) {
<b class="nc">&nbsp;        if (te.getDocument().equals(texElev.getDocument())) {</b>
&nbsp;            int value;
&nbsp;            try {
<b class="nc">&nbsp;                value = Integer.parseInt(texElev.getText());</b>
<b class="nc">&nbsp;            } catch (NumberFormatException ex) {</b>
&nbsp;                return;
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (value != curHex.getLevel()) {</b>
<b class="nc">&nbsp;                curHex.setLevel(value);</b>
<b class="nc">&nbsp;                repaintWorkingHex();</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (te.getDocument().equals(texTerrainLevel.getDocument())) {</b>
&nbsp;            // prevent updating the terrain from looping back to
&nbsp;            // update the text fields that have just been edited
<b class="nc">&nbsp;            if (!terrListBlocker) {</b>
<b class="nc">&nbsp;                noTextFieldUpdate = true;</b>
<b class="nc">&nbsp;                updateWhenSelected();</b>
<b class="nc">&nbsp;                noTextFieldUpdate = false;</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (te.getDocument().equals(texTerrExits.getDocument())) {</b>
&nbsp;            // prevent updating the terrain from looping back to
&nbsp;            // update the text fields that have just been edited
<b class="nc">&nbsp;            if (!terrListBlocker) {</b>
<b class="nc">&nbsp;                noTextFieldUpdate = true;</b>
<b class="nc">&nbsp;                cheTerrExitSpecified.setSelected(true);</b>
<b class="nc">&nbsp;                updateWhenSelected();</b>
<b class="nc">&nbsp;                noTextFieldUpdate = false;</b>
&nbsp;            }
&nbsp;        }  
&nbsp;    }
&nbsp;    
&nbsp;    public void insertUpdate(DocumentEvent event) {
<b class="nc">&nbsp;        changedUpdate(event);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void removeUpdate(DocumentEvent event) {
<b class="nc">&nbsp;        changedUpdate(event);</b>
&nbsp;    }
&nbsp;
&nbsp;    /** Called when the user selects the &quot;Help-&gt;About&quot; menu item. */
&nbsp;    private void showAbout() {
&nbsp;        // Do we need to create the &quot;about&quot; dialog?
<b class="nc">&nbsp;        if (about == null) {</b>
<b class="nc">&nbsp;            about = new CommonAboutDialog(frame);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Show the about dialog.
<b class="nc">&nbsp;        about.setVisible(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    /** Called when the user selects the &quot;Help-&gt;Contents&quot; menu item. */
&nbsp;    private void showHelp() {
&nbsp;        // Do we need to create the &quot;help&quot; dialog?
<b class="nc">&nbsp;        if (help == null) {</b>
<b class="nc">&nbsp;            File helpFile = new File(&quot;docs\\Boards Stuff&quot;, &quot;Map Editor-readme.txt&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            help = new CommonHelpDialog(frame, helpFile);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Show the help dialog.
<b class="nc">&nbsp;        help.setVisible(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    /** Called when the user selects the &quot;View-&gt;Client Settings&quot; menu item. */
&nbsp;    private void showSettings() {
&nbsp;        // Do we need to create the &quot;settings&quot; dialog?
<b class="nc">&nbsp;        if (setdlg == null) {</b>
<b class="nc">&nbsp;            setdlg = new CommonSettingsDialog(frame);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Show the settings dialog.
<b class="nc">&nbsp;        setdlg.setVisible(true);</b>
&nbsp;    }
&nbsp;    
&nbsp;    /** 
&nbsp;     * Adjusts some UI and internal settings for a freshly 
&nbsp;     * loaded or freshly generated board.
&nbsp;     */
&nbsp;    private void setupUiFreshBoard() {
&nbsp;        // Reset the Undo stack and the board has no changes
<b class="nc">&nbsp;        savedUndoStackSize = 0;</b>
<b class="nc">&nbsp;        canReturnToSaved = true;</b>
<b class="nc">&nbsp;        resetUndo();</b>
<b class="nc">&nbsp;        hasChanges = false;</b>
&nbsp;        // When a board was loaded, we have a file, otherwise not
<b class="nc">&nbsp;        butSourceFile.setEnabled(curBoardFile != null);</b>
&nbsp;        // Adjust the UI
<b class="nc">&nbsp;        menuBar.setBoard(true);</b>
<b class="nc">&nbsp;        bvc.doLayout();</b>
<b class="nc">&nbsp;        setFrameTitle();</b>
&nbsp;    }
&nbsp;    
&nbsp;    /** 
&nbsp;     * Performs board validation. When showPositiveResult is true,
&nbsp;     * the result of the validation will be shown in a dialog. 
&nbsp;     * Otherwise, only a negative result (the board has errors) will 
&nbsp;     * be shown.
&nbsp;     */
&nbsp;    private void validateBoard(boolean showPositiveResult) {
<b class="nc">&nbsp;        StringBuffer errBuff = new StringBuffer();</b>
<b class="nc">&nbsp;        board.isValid(errBuff);</b>
<b class="nc">&nbsp;        if ((errBuff.length() &gt; 0) || showPositiveResult) {</b>
<b class="nc">&nbsp;            showBoardValidationReport(errBuff);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Shows a board validation report dialog, reporting either
&nbsp;     * the contents of errBuff or that the board has no errors.
&nbsp;     */
&nbsp;    private void showBoardValidationReport(StringBuffer errBuff) {
<b class="nc">&nbsp;        ignoreHotKeys = true;</b>
<b class="nc">&nbsp;        if ((errBuff != null) &amp;&amp; errBuff.length() &gt; 0) {</b>
<b class="nc">&nbsp;            String title = Messages.getString(&quot;BoardEditor.invalidBoard.title&quot;);</b>
<b class="nc">&nbsp;            String msg = Messages.getString(&quot;BoardEditor.invalidBoard.report&quot;);</b>
<b class="nc">&nbsp;            msg += errBuff;</b>
<b class="nc">&nbsp;            JTextArea textArea = new JTextArea(msg);</b>
<b class="nc">&nbsp;            JScrollPane scrollPane = new JScrollPane(textArea);</b>
<b class="nc">&nbsp;            textArea.setLineWrap(true);</b>
<b class="nc">&nbsp;            textArea.setWrapStyleWord(true);</b>
<b class="nc">&nbsp;            scrollPane.setPreferredSize(new Dimension(getWidth(), getHeight() / 2));</b>
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(frame, scrollPane, title, JOptionPane.ERROR_MESSAGE);</b>
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            String title =  Messages.getString(&quot;BoardEditor.validBoard.title&quot;);</b>
<b class="nc">&nbsp;            String msg = Messages.getString(&quot;BoardEditor.validBoard.report&quot;);</b>
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(frame, msg, title, JOptionPane.INFORMATION_MESSAGE);</b>
&nbsp;        }
<b class="nc">&nbsp;        ignoreHotKeys = false;</b>
&nbsp;    }
&nbsp;
&nbsp;    //
&nbsp;    // ActionListener
&nbsp;    //
&nbsp;    public void actionPerformed(ActionEvent ae) {
<b class="nc">&nbsp;        if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_NEW)) {</b>
<b class="nc">&nbsp;            ignoreHotKeys = true;</b>
<b class="nc">&nbsp;            boardNew(true);</b>
<b class="nc">&nbsp;            ignoreHotKeys = false;</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(FILE_BOARD_EDITOR_EXPAND)) {</b>
<b class="nc">&nbsp;            ignoreHotKeys = true;</b>
<b class="nc">&nbsp;            boardResize();</b>
<b class="nc">&nbsp;            ignoreHotKeys = false;</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_OPEN)) {</b>
<b class="nc">&nbsp;            ignoreHotKeys = true;</b>
<b class="nc">&nbsp;            boardLoad();</b>
<b class="nc">&nbsp;            ignoreHotKeys = false;</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_SAVE)) {</b>
<b class="nc">&nbsp;            ignoreHotKeys = true;</b>
<b class="nc">&nbsp;            boardSave(false);</b>
<b class="nc">&nbsp;            ignoreHotKeys = false;</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_SAVE_AS)) {</b>
<b class="nc">&nbsp;            ignoreHotKeys = true;</b>
<b class="nc">&nbsp;            boardSave(true);</b>
<b class="nc">&nbsp;            ignoreHotKeys = false;</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_SAVE_AS_IMAGE)) {</b>
<b class="nc">&nbsp;            ignoreHotKeys = true;</b>
<b class="nc">&nbsp;            boardSaveAsImage(false);</b>
<b class="nc">&nbsp;            ignoreHotKeys = false;</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(FILE_SOURCEFILE)) {</b>
<b class="nc">&nbsp;            if (curBoardFile != null) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    Desktop.getDesktop().open(curBoardFile);</b>
<b class="nc">&nbsp;                } catch (IOException e) {</b>
<b class="nc">&nbsp;                    ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                    JOptionPane.showMessageDialog(</b>
&nbsp;                            frame,
<b class="nc">&nbsp;                            Messages.getString(&quot;BoardEditor.OpenFileError&quot;, curBoardFile.toString())</b>
<b class="nc">&nbsp;                             + e.getMessage());</b>
<b class="nc">&nbsp;                    e.printStackTrace();</b>
<b class="nc">&nbsp;                    ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(FILE_BOARD_EDITOR_VALIDATE)) {</b>
<b class="nc">&nbsp;            correctExits();</b>
<b class="nc">&nbsp;            validateBoard(true);</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(butDelTerrain)</b>
<b class="nc">&nbsp;                   &amp;&amp; (!lisTerrain.isSelectionEmpty())) {</b>
<b class="nc">&nbsp;            ITerrain toRemove = Terrains.getTerrainFactory().createTerrain(</b>
<b class="nc">&nbsp;                    lisTerrain.getSelectedValue().getTerrain());</b>
<b class="nc">&nbsp;            curHex.removeTerrain(toRemove.getType());</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(butAddTerrain)) {</b>
<b class="nc">&nbsp;            addSetTerrain();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(butElevUp) &amp;&amp; (curHex.getLevel() &lt; 9)) {</b>
<b class="nc">&nbsp;            curHex.setLevel(curHex.getLevel() + 1);</b>
<b class="nc">&nbsp;            texElev.incValue();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(butElevDown) &amp;&amp; (curHex.getLevel() &gt; -5)) {</b>
<b class="nc">&nbsp;            curHex.setLevel(curHex.getLevel() - 1);</b>
<b class="nc">&nbsp;            texElev.decValue();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(butTerrUp)) {</b>
<b class="nc">&nbsp;            texTerrainLevel.incValue();</b>
<b class="nc">&nbsp;            updateWhenSelected();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(butTerrDown)) {</b>
<b class="nc">&nbsp;            texTerrainLevel.decValue();</b>
<b class="nc">&nbsp;            updateWhenSelected();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(texTerrainLevel)) {</b>
<b class="nc">&nbsp;            updateWhenSelected();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(texTerrExits)) {</b>
<b class="nc">&nbsp;            int exitsVal = texTerrExits.getNumber();</b>
<b class="nc">&nbsp;            if (exitsVal == 0) {</b>
<b class="nc">&nbsp;                cheTerrExitSpecified.setSelected(false);</b>
<b class="nc">&nbsp;            } else if (exitsVal &gt; 63) {</b>
<b class="nc">&nbsp;                texTerrExits.setNumber(63);</b>
&nbsp;            }
<b class="nc">&nbsp;            updateWhenSelected();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(butTerrExits)) {</b>
<b class="nc">&nbsp;            ExitsDialog ed = new ExitsDialog(frame);</b>
<b class="nc">&nbsp;            int exitsVal = texTerrExits.getNumber();</b>
<b class="nc">&nbsp;            ed.setExits(exitsVal);</b>
<b class="nc">&nbsp;            ed.setVisible(true);</b>
<b class="nc">&nbsp;            exitsVal = ed.getExits();</b>
<b class="nc">&nbsp;            texTerrExits.setNumber(exitsVal);</b>
<b class="nc">&nbsp;            cheTerrExitSpecified.setSelected(exitsVal != 0);</b>
<b class="nc">&nbsp;            updateWhenSelected();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(butExitUp)) {</b>
<b class="nc">&nbsp;            cheTerrExitSpecified.setSelected(true);</b>
<b class="nc">&nbsp;            if (texTerrExits.getNumber() &lt; 63) {</b>
<b class="nc">&nbsp;                texTerrExits.incValue();</b>
&nbsp;            }
<b class="nc">&nbsp;            updateWhenSelected();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(butExitDown)) {</b>
<b class="nc">&nbsp;            texTerrExits.decValue();</b>
<b class="nc">&nbsp;            cheTerrExitSpecified.setSelected(texTerrExits.getNumber() != 0);</b>
<b class="nc">&nbsp;            updateWhenSelected();</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_MINI_MAP)) {</b>
<b class="nc">&nbsp;            minimapW.setVisible(!minimapW.isVisible());</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.HELP_ABOUT)) {</b>
&nbsp;
<b class="nc">&nbsp;            showAbout();</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.HELP_CONTENTS)) {</b>
<b class="nc">&nbsp;            showHelp();</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_CLIENT_SETTINGS)) {</b>
<b class="nc">&nbsp;            showSettings();</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_ZOOM_IN)) {</b>
<b class="nc">&nbsp;            bv.zoomIn();</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_ZOOM_OUT)) {</b>
<b class="nc">&nbsp;            bv.zoomOut();</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_TOGGLE_ISOMETRIC)) {</b>
<b class="nc">&nbsp;            bv.toggleIsometric();</b>
<b class="nc">&nbsp;        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_CHANGE_THEME)) {</b>
<b class="nc">&nbsp;            bv.changeTheme();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(choTheme) ) { </b>
<b class="nc">&nbsp;            curHex.setTheme((String)choTheme.getSelectedItem());</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonLW)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }  
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.WOODS, 1));</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.FOLIAGE_ELEV, 2));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonOW)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }  
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.WOODS, 1));</b>
<b class="nc">&nbsp;            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FOLIAGE_ELEV, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonMg)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.MAGMA, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonLJ)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.JUNGLE, 1));</b>
<b class="nc">&nbsp;            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FOLIAGE_ELEV, 2));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonOJ)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.JUNGLE, 1));</b>
<b class="nc">&nbsp;            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FOLIAGE_ELEV, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonWa)) {</b>
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.CTRL_MASK) != 0) {</b>
<b class="nc">&nbsp;                if (curHex.containsTerrain(Terrains.RAPIDS, 1))</b>
<b class="nc">&nbsp;                    addSetTerrainEasy(Terrains.RAPIDS, 2);</b>
&nbsp;                else
<b class="nc">&nbsp;                    addSetTerrainEasy(Terrains.RAPIDS, 1);</b>
<b class="nc">&nbsp;                if (!curHex.containsTerrain(Terrains.WATER) ||</b>
<b class="nc">&nbsp;                        curHex.getTerrain(Terrains.WATER).getLevel() == 0)</b>
<b class="nc">&nbsp;                    addSetTerrainEasy(Terrains.WATER, 1);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                    curHex.removeAllTerrains();</b>
&nbsp;                }
<b class="nc">&nbsp;                addSetTerrainEasy(Terrains.WATER, 1);</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonSw)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.SWAMP, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonRo)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.ROUGH, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonPv)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.PAVEMENT, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonMd)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.MUD, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonTu)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.TUNDRA, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonIc)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.ICE, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonSn)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.SNOW, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonCl)) {</b>
<b class="nc">&nbsp;            curHex.removeAllTerrains();</b>
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonBrush1)) {</b>
<b class="nc">&nbsp;            brushSize = 1;</b>
<b class="nc">&nbsp;            lastClicked = null;</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonBrush2)) {</b>
<b class="nc">&nbsp;            brushSize = 2;</b>
<b class="nc">&nbsp;            lastClicked = null;</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonBrush3)) {</b>
<b class="nc">&nbsp;            brushSize = 3;</b>
<b class="nc">&nbsp;            lastClicked = null;</b>
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonBu)) { </b>
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0 &amp;&amp; (ae.getModifiers() &amp; ActionEvent.ALT_MASK) == 0) </b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.ALT_MASK) != 0) {</b>
<b class="nc">&nbsp;                setBasicBuilding(true);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                setBasicBuilding(false);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonBr)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            setBasicBridge();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonFT)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            setBasicFuelTank();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonRd)) {</b>
<b class="nc">&nbsp;            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</b>
<b class="nc">&nbsp;                curHex.removeAllTerrains();</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonUpDn.setSelected(false);</b>
<b class="nc">&nbsp;            curHex.addTerrain(TF.createTerrain(Terrains.ROAD, 1));</b>
<b class="nc">&nbsp;            refreshTerrainList();</b>
<b class="nc">&nbsp;            repaintWorkingHex();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonUpDn)) {</b>
&nbsp;            // Not so useful to only do on clear terrain
<b class="nc">&nbsp;            buttonOOC.setSelected(false);</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonUndo)) {</b>
&nbsp;            // The button should not be active when the stack is empty, but
&nbsp;            // let&#39;s check nevertheless
<b class="nc">&nbsp;            if (undoStack.isEmpty()) { </b>
<b class="nc">&nbsp;                buttonUndo.setEnabled(false);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                HashSet&lt;IHex&gt; recentHexes = undoStack.pop();</b>
<b class="nc">&nbsp;                HashSet&lt;IHex&gt; redoHexes = new HashSet&lt;&gt;(); </b>
<b class="nc">&nbsp;                for (IHex hex: recentHexes) {</b>
&nbsp;                    // Retrieve the board hex for Redo
<b class="nc">&nbsp;                    IHex rHex = board.getHex(hex.getCoords()).duplicate();</b>
<b class="nc">&nbsp;                    rHex.setCoords(hex.getCoords());</b>
<b class="nc">&nbsp;                    redoHexes.add(rHex);</b>
&nbsp;                    // and undo the board hex
<b class="nc">&nbsp;                    board.setHex(hex.getCoords(), hex);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                redoStack.push(redoHexes);</b>
<b class="nc">&nbsp;                if (undoStack.isEmpty()) {</b>
<b class="nc">&nbsp;                    buttonUndo.setEnabled(false);</b>
&nbsp;                }
<b class="nc">&nbsp;                hasChanges = !canReturnToSaved | (undoStack.size() != savedUndoStackSize);</b>
<b class="nc">&nbsp;                buttonRedo.setEnabled(true);</b>
<b class="nc">&nbsp;                currentUndoSet = null; // should be anyway</b>
&nbsp;            }
<b class="nc">&nbsp;            setFrameTitle();</b>
&nbsp;            
<b class="nc">&nbsp;        } else if (ae.getSource().equals(buttonRedo)) {</b>
&nbsp;            // The button should not be active when the stack is empty, but
&nbsp;            // let&#39;s check nevertheless
<b class="nc">&nbsp;            if (redoStack.isEmpty()) { </b>
<b class="nc">&nbsp;                buttonRedo.setEnabled(false); </b>
&nbsp;            } else {
<b class="nc">&nbsp;                HashSet&lt;IHex&gt; recentHexes = redoStack.pop();</b>
<b class="nc">&nbsp;                HashSet&lt;IHex&gt; undoHexes = new HashSet&lt;&gt;(); </b>
<b class="nc">&nbsp;                for (IHex hex: recentHexes) {</b>
<b class="nc">&nbsp;                    IHex rHex = board.getHex(hex.getCoords()).duplicate();</b>
<b class="nc">&nbsp;                    rHex.setCoords(hex.getCoords());</b>
<b class="nc">&nbsp;                    undoHexes.add(rHex);</b>
<b class="nc">&nbsp;                    board.setHex(hex.getCoords(), hex);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                undoStack.push(undoHexes);</b>
<b class="nc">&nbsp;                if (redoStack.isEmpty()) buttonRedo.setEnabled(false);</b>
<b class="nc">&nbsp;                buttonUndo.setEnabled(true);</b>
<b class="nc">&nbsp;                hasChanges = !canReturnToSaved | (undoStack.size() != savedUndoStackSize);</b>
<b class="nc">&nbsp;                currentUndoSet = null; // should be anyway</b>
&nbsp;            }
<b class="nc">&nbsp;            setFrameTitle();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void valueChanged(ListSelectionEvent event) {
<b class="nc">&nbsp;        if (event.getValueIsAdjusting()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (event.getSource().equals(lisTerrain)) {</b>
<b class="nc">&nbsp;            if (!noTextFieldUpdate)</b>
<b class="nc">&nbsp;                refreshTerrainFromList();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Displays the currently selected hex picture, in component form
&nbsp;     */
&nbsp;    private class HexCanvas extends JPanel {
&nbsp;        /**
&nbsp;         *
&nbsp;         */
&nbsp;        private static final long serialVersionUID = 3201928357525361191L;
&nbsp;
<b class="nc">&nbsp;        HexCanvas() {</b>
<b class="nc">&nbsp;            setPreferredSize(new Dimension(90, 90));</b>
&nbsp;        }
&nbsp;        
&nbsp;        /** Returns list or an empty list when list is null. */
&nbsp;        private List&lt;Image&gt; safeList(List&lt;Image&gt; list) {
<b class="nc">&nbsp;            return list == null ? Collections.emptyList() : list;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void paintComponent(Graphics g) {
<b class="nc">&nbsp;            super.paintComponent(g);</b>
<b class="nc">&nbsp;            if (curHex != null) {</b>
&nbsp;                // draw the terrain images
<b class="nc">&nbsp;                TilesetManager tm = bv.getTilesetManager();</b>
<b class="nc">&nbsp;                g.drawImage(tm.baseFor(curHex), 0, 0, BoardView1.HEX_W, BoardView1.HEX_H, this);</b>
<b class="nc">&nbsp;                for (final Image newVar : safeList(tm.supersFor(curHex))) {</b>
<b class="nc">&nbsp;                    g.drawImage(newVar, 0, 0, this);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                for (final Image newVar : safeList(tm.orthoFor(curHex))) {</b>
<b class="nc">&nbsp;                    g.drawImage(newVar, 0, 0, this);</b>
<b class="nc">&nbsp;                }</b>
&nbsp;                // add level and INVALID if necessary
<b class="nc">&nbsp;                if (guip.getAntiAliasing()) {</b>
<b class="nc">&nbsp;                    ((Graphics2D) g).setRenderingHint(</b>
&nbsp;                            RenderingHints.KEY_ANTIALIASING,
&nbsp;                            RenderingHints.VALUE_ANTIALIAS_ON);
&nbsp;                }
<b class="nc">&nbsp;                g.setColor(getForeground());</b>
<b class="nc">&nbsp;                g.setFont(new Font(&quot;SansSerif&quot;, Font.PLAIN, 9)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                g.drawString(Messages.getString(&quot;BoardEditor.LEVEL&quot;) + curHex.getLevel(), 24, 70); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                StringBuffer errBuf = new StringBuffer();</b>
<b class="nc">&nbsp;                if (!curHex.isValid(errBuf)) {</b>
<b class="nc">&nbsp;                    g.setFont(new Font(&quot;SansSerif&quot;, Font.BOLD, 14)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Point hexCenter = new Point(BoardView1.HEX_W / 2, BoardView1.HEX_H / 2);</b>
<b class="nc">&nbsp;                    bv.drawCenteredText((Graphics2D) g, </b>
<b class="nc">&nbsp;                            Messages.getString(&quot;BoardEditor.INVALID&quot;), //$NON-NLS-1$</b>
&nbsp;                            hexCenter, 
<b class="nc">&nbsp;                            guip.getWarningColor(),</b>
&nbsp;                            false);
<b class="nc">&nbsp;                    String tooltip = Messages.getString(&quot;BoardEditor.invalidHex&quot;) + errBuf; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    tooltip = tooltip.replace(&quot;\n&quot;, &quot;&lt;br&gt;&quot;); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                    setToolTipText(tooltip);</b>
<b class="nc">&nbsp;                } else {</b>
<b class="nc">&nbsp;                    setToolTipText(null);</b>
&nbsp;                }
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                g.clearRect(0, 0, 72, 72);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Make the hex stubborn when resizing the frame
&nbsp;        @Override
&nbsp;        public Dimension getPreferredSize() {
<b class="nc">&nbsp;            return new Dimension(90, 90);</b>
&nbsp;        }
&nbsp;        
&nbsp;        @Override
&nbsp;        public Dimension getMinimumSize() {
<b class="nc">&nbsp;            return new Dimension(90, 90);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return the frame this is displayed in
&nbsp;     */
&nbsp;    public JFrame getFrame() {
<b class="nc">&nbsp;        return frame;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns true if a dialog is visible on top of the &lt;code&gt;ClientGUI&lt;/code&gt;.
&nbsp;     * For example, the &lt;code&gt;MegaMekController&lt;/code&gt; should ignore hotkeys
&nbsp;     * if there is a dialog, like the &lt;code&gt;CommonSettingsDialog&lt;/code&gt;, open.
&nbsp;     *
&nbsp;     * @return
&nbsp;     */
&nbsp;    public boolean shouldIgnoreHotKeys() {
<b class="nc">&nbsp;        return ignoreHotKeys || (about != null &amp;&amp; about.isVisible())</b>
<b class="nc">&nbsp;                || (help != null &amp;&amp; help.isVisible())</b>
<b class="nc">&nbsp;                || (setdlg != null &amp;&amp; setdlg.isVisible()) || texElev.hasFocus()</b>
<b class="nc">&nbsp;                || texTerrainLevel.hasFocus() || texTerrExits.hasFocus();</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void setDialogSize(JFileChooser dialog) {
<b class="nc">&nbsp;        int width = guip.getBoardEditLoadWidth();</b>
<b class="nc">&nbsp;        int height = guip.getBoardEditLoadHeight();</b>
<b class="nc">&nbsp;        dialog.setPreferredSize(new Dimension(width, height));   </b>
&nbsp;    }
&nbsp;    
&nbsp;    private void saveDialogSize(JComponent dialog) {
<b class="nc">&nbsp;        guip.setBoardEditLoadHeight(dialog.getHeight());</b>
<b class="nc">&nbsp;        guip.setBoardEditLoadWidth(dialog.getWidth());</b>
&nbsp;    }
&nbsp;    
&nbsp;    /** 
&nbsp;     *  Sets the Board Editor frame title, adding the current file name if any
&nbsp;     *  and a &quot;*&quot; if the board has unsaved changes.
&nbsp;     */
&nbsp;    private void setFrameTitle() {
<b class="nc">&nbsp;        String title = Messages.getString(&quot;BoardEditor.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        if (curBoardFile != null) {</b>
<b class="nc">&nbsp;            title = Messages.getString(&quot;BoardEditor.title0&quot;, curBoardFile);  //$NON-NLS-1$ </b>
&nbsp;        }
<b class="nc">&nbsp;        frame.setTitle(title + (hasChanges ? &quot;*&quot; : &quot;&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;    }
&nbsp;    
&nbsp;    
&nbsp;    /**
&nbsp;     * Specialized field for the BoardEditor that supports 
&nbsp;     * MouseWheel changes.
&nbsp;     * 
&nbsp;     * @author Simon
&nbsp;     */
&nbsp;    private class EditorTextField extends JTextField {
&nbsp;
&nbsp;        /**
&nbsp;         * 
&nbsp;         */
&nbsp;        private static final long serialVersionUID = 4706926692515844105L;
&nbsp;
<b class="nc">&nbsp;        private int minValue = Integer.MIN_VALUE;</b>
&nbsp;        
&nbsp;        /**
&nbsp;         * Creates an EditorTextField based on JTextField. This is a 
&nbsp;         * specialized field for the BoardEditor that supports 
&nbsp;         * MouseWheel changes.
&nbsp;         * 
&nbsp;         * @param text the initial text
&nbsp;         * @param columns as in JTextField
&nbsp;         * 
&nbsp;         * @see javax.swing.JTextField#JTextField(String, int)
&nbsp;         */
<b class="nc">&nbsp;        public EditorTextField(String text, int columns) {</b>
<b class="nc">&nbsp;            super(text, columns);</b>
&nbsp;            // Automatically select all text when clicking the text field
<b class="nc">&nbsp;            addMouseListener(new MouseAdapter() {</b>
&nbsp;                @Override public void mouseReleased(MouseEvent e) {
<b class="nc">&nbsp;                    selectAll();</b>
&nbsp;                }
&nbsp;            });
&nbsp;
<b class="nc">&nbsp;            addMouseWheelListener(new MouseWheelListener() {</b>
&nbsp;                @Override
&nbsp;                public void mouseWheelMoved(MouseWheelEvent e) {
<b class="nc">&nbsp;                    if (e.getWheelRotation() &lt; 0)</b>
<b class="nc">&nbsp;                        incValue();</b>
&nbsp;                    else 
<b class="nc">&nbsp;                        decValue();</b>
&nbsp;                }
&nbsp;            });
<b class="nc">&nbsp;            setMargin(new Insets(1,1,1,1));</b>
<b class="nc">&nbsp;            setHorizontalAlignment(JTextField.CENTER);</b>
<b class="nc">&nbsp;            setFont(fontElev);</b>
<b class="nc">&nbsp;            setCursor(Cursor.getDefaultCursor());</b>
&nbsp;        }
&nbsp;        
&nbsp;        /**
&nbsp;         * Creates an EditorTextField based on JTextField. This is a 
&nbsp;         * specialized field for the BoardEditor that supports 
&nbsp;         * MouseWheel changes.
&nbsp;         * 
&nbsp;         * @param text the initial text
&nbsp;         * @param columns as in JTextField
&nbsp;         * @param minimum a minimum value that the EditorTextField
&nbsp;         * will generally adhere to when its own methods are used
&nbsp;         * to change its value.
&nbsp;         * 
&nbsp;         * @see javax.swing.JTextField#JTextField(String, int)
&nbsp;         * 
&nbsp;         * @author Simon/Juliez
&nbsp;         */
&nbsp;        public EditorTextField(String text, int columns, int minimum) {
<b class="nc">&nbsp;            this(text, columns);</b>
<b class="nc">&nbsp;            minValue = minimum;</b>
&nbsp;        }
&nbsp;        
&nbsp;        /**
&nbsp;         * Increases the EditorTextField&#39;s number by one, if a number
&nbsp;         * is present.
&nbsp;         */
&nbsp;        public void incValue() {
<b class="nc">&nbsp;            int newValue = getNumber() + 1;</b>
<b class="nc">&nbsp;            setNumber(newValue);</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Lowers the EditorTextField&#39;s number by one, if a number
&nbsp;         * is present and if that number is higher than the minimum
&nbsp;         * value.
&nbsp;         */
&nbsp;        public void decValue() {
<b class="nc">&nbsp;            setNumber(getNumber() - 1);</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Sets the text to &lt;code&gt;newValue&lt;/code&gt;. If &lt;code&gt;newValue&lt;/code&gt; is lower
&nbsp;         * than the EditorTextField&#39;s minimum value, the minimum value will
&nbsp;         * be set instead.
&nbsp;         * 
&nbsp;         * @param newValue the value to be set
&nbsp;         */
&nbsp;        public void setNumber(int newValue) {
<b class="nc">&nbsp;            int value = Math.max(newValue, minValue);</b>
<b class="nc">&nbsp;            setText(Integer.toString(value));</b>
&nbsp;        }
&nbsp;        
&nbsp;        /**
&nbsp;         * Returns the text in the EditorTextField&#39;s as an int. 
&nbsp;         * Returns 0 when no parsable number (only letters) are present. 
&nbsp;         */
&nbsp;        public int getNumber() {
&nbsp;            try {
<b class="nc">&nbsp;                return Integer.parseInt(getText());</b>
<b class="nc">&nbsp;            } catch (NumberFormatException ex) {</b>
<b class="nc">&nbsp;                return 0;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
