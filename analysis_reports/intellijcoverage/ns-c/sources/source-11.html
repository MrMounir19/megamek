


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ChatLounge</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ui.swing</a>
</div>

<h1>Coverage Summary for Class: ChatLounge (megamek.client.ui.swing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ChatLounge</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/82)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1720)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ChatLounge$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/33)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$MekInfo</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$MekTableKeyAdapter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$MekTableModel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/41)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$MekTableModel$Renderer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/69)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$MekTableMouseAdapter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/677)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$PlayerTableModel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/59)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatLounge$PlayerTableMouseAdapter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/135)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2738)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek -
&nbsp; * Copyright (C) 2000,2001,2002,2003,2004,2005,2006 Ben Mazur (bmazur@sev.org)
&nbsp; * Copyright © 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
&nbsp; *
&nbsp; * This program is free software; you can redistribute it and/or modify it
&nbsp; * under the terms of the GNU General Public License as published by the Free
&nbsp; * Software Foundation; either version 2 of the License, or (at your option)
&nbsp; * any later version.
&nbsp; *
&nbsp; * This program is distributed in the hope that it will be useful, but
&nbsp; * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; * for more details.
&nbsp; */
&nbsp;package megamek.client.ui.swing;
&nbsp;
&nbsp;import java.awt.BorderLayout;
&nbsp;import java.awt.Color;
&nbsp;import java.awt.Component;
&nbsp;import java.awt.Dimension;
&nbsp;import java.awt.Font;
&nbsp;import java.awt.GridBagConstraints;
&nbsp;import java.awt.GridBagLayout;
&nbsp;import java.awt.GridLayout;
&nbsp;import java.awt.Image;
&nbsp;import java.awt.Insets;
&nbsp;import java.awt.event.ActionEvent;
&nbsp;import java.awt.event.ActionListener;
&nbsp;import java.awt.event.ItemEvent;
&nbsp;import java.awt.event.ItemListener;
&nbsp;import java.awt.event.KeyAdapter;
&nbsp;import java.awt.event.KeyEvent;
&nbsp;import java.awt.event.MouseEvent;
&nbsp;import java.awt.event.MouseListener;
&nbsp;import java.awt.event.WindowAdapter;
&nbsp;import java.awt.event.WindowEvent;
&nbsp;import java.io.IOException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.Enumeration;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.List;
&nbsp;import java.util.Map.Entry;
&nbsp;import java.util.Set;
&nbsp;import java.util.StringTokenizer;
&nbsp;import java.util.TreeSet;
&nbsp;import java.util.Vector;
&nbsp;
&nbsp;import javax.swing.*;
&nbsp;import javax.swing.event.ListSelectionEvent;
&nbsp;import javax.swing.event.ListSelectionListener;
&nbsp;import javax.swing.event.MouseInputAdapter;
&nbsp;import javax.swing.table.AbstractTableModel;
&nbsp;import javax.swing.table.TableCellRenderer;
&nbsp;import javax.swing.table.TableColumn;
&nbsp;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.client.Client;
&nbsp;import megamek.client.generator.RandomGenderGenerator;
&nbsp;import megamek.client.generator.RandomNameGenerator;
&nbsp;import megamek.client.bot.BotClient;
&nbsp;import megamek.client.bot.princess.Princess;
&nbsp;import megamek.client.bot.ui.swing.BotGUI;
&nbsp;import megamek.client.generator.RandomCallsignGenerator;
&nbsp;import megamek.client.ui.Messages;
&nbsp;import megamek.client.ui.swing.boardview.BoardView1;
&nbsp;import megamek.client.ui.swing.dialog.imageChooser.CamoChooserDialog;
&nbsp;import megamek.client.ui.swing.util.MenuScroller;
&nbsp;import megamek.client.ui.swing.widget.SkinSpecification;
&nbsp;import megamek.common.*;
&nbsp;import megamek.common.enums.Gender;
&nbsp;import megamek.common.event.GameCFREvent;
&nbsp;import megamek.common.event.GameEntityNewEvent;
&nbsp;import megamek.common.event.GameEntityRemoveEvent;
&nbsp;import megamek.common.event.GamePhaseChangeEvent;
&nbsp;import megamek.common.event.GamePlayerChangeEvent;
&nbsp;import megamek.common.event.GameSettingsChangeEvent;
&nbsp;import megamek.common.icons.AbstractIcon;
&nbsp;import megamek.common.icons.Portrait;
&nbsp;import megamek.common.options.GameOptions;
&nbsp;import megamek.common.options.IOption;
&nbsp;import megamek.common.options.IOptionGroup;
&nbsp;import megamek.common.options.OptionsConstants;
&nbsp;import megamek.common.options.PilotOptions;
&nbsp;import megamek.common.options.Quirks;
&nbsp;import megamek.common.util.BoardUtilities;
&nbsp;import megamek.common.util.fileUtils.MegaMekFile;
&nbsp;
<b class="nc">&nbsp;public class ChatLounge extends AbstractPhaseDisplay implements ActionListener, ItemListener,</b>
&nbsp;        ListSelectionListener, MouseListener, IMapSettingsObserver {
&nbsp;    private static final long serialVersionUID = 1454736776730903786L;
&nbsp;
&nbsp;    private JButton butOptions;
&nbsp;    private JLabel lblMapSummary;
&nbsp;    private JLabel lblGameYear;
&nbsp;    private JLabel lblTechLevel;
&nbsp;
&nbsp;    private JTabbedPane panTabs;
&nbsp;    private JPanel panMain;
&nbsp;    private JPanel panMap;
&nbsp;
&nbsp;    /* Unit Configuration Panel */
&nbsp;    private JPanel panUnitInfo;
&nbsp;    JButton butLoad;
&nbsp;    JButton butArmy;
&nbsp;    JButton butSkills;
&nbsp;    JButton butNames;
&nbsp;    private JButton butLoadList;
&nbsp;    private JButton butSaveList;
&nbsp;    private JButton butDeleteAll;
&nbsp;
&nbsp;    /* Unit Table */
&nbsp;    JTable tableEntities;
&nbsp;    private JScrollPane scrEntities;
&nbsp;    private JToggleButton butCompact;
&nbsp;
&nbsp;    private MekTableModel mekModel;
&nbsp;
&nbsp;    /* Player Configuration Panel */
&nbsp;    private JPanel panPlayerInfo;
&nbsp;    private JComboBox&lt;String&gt; choTeam;
&nbsp;    private JButton butCamo;
&nbsp;    private JButton butAddBot;
&nbsp;    private JButton butRemoveBot;
&nbsp;    private JButton butChangeStart;
&nbsp;    private JTable tablePlayers;
&nbsp;    private JScrollPane scrPlayers;
&nbsp;    private PlayerTableModel playerModel;
&nbsp;
&nbsp;    /* Map Settings Panel */
&nbsp;    private MapSettings mapSettings;
&nbsp;    private JButton butConditions;
&nbsp;    private JPanel panGroundMap;
&nbsp;    private JPanel panSpaceMap;
&nbsp;    private JComboBox&lt;String&gt; comboMapType;
&nbsp;    @SuppressWarnings(&quot;rawtypes&quot;)
&nbsp;    private JComboBox&lt;Comparable&gt; comboMapSizes;
&nbsp;    private JButton butMapSize;
&nbsp;    private JButton butRandomMap;
&nbsp;    private JButton buttonBoardPreview;
&nbsp;    private JScrollPane scrMapButtons;
&nbsp;    private JPanel panMapButtons;
&nbsp;    private JLabel labBoardsSelected;
&nbsp;    private JList&lt;String&gt; lisBoardsSelected;
&nbsp;    private JScrollPane scrBoardsSelected;
&nbsp;    private JButton butChange;
&nbsp;    private JLabel labBoardsAvailable;
&nbsp;    private JList&lt;String&gt; lisBoardsAvailable;
&nbsp;    private JScrollPane scrBoardsAvailable;
&nbsp;    private JCheckBox chkRotateBoard;
&nbsp;    private JCheckBox chkIncludeGround;
&nbsp;    private JCheckBox chkIncludeSpace;
&nbsp;    private JButton butSpaceSize;
<b class="nc">&nbsp;    private Set&lt;BoardDimensions&gt; mapSizes = new TreeSet&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;    boolean resetAvailBoardSelection = false;</b>
<b class="nc">&nbsp;    boolean resetSelectedBoards = true;</b>
&nbsp;
&nbsp;    JPanel mapPreviewPanel;
<b class="nc">&nbsp;    MiniMap miniMap = null;</b>
&nbsp;    ClientDialog boardPreviewW;
<b class="nc">&nbsp;    private Game boardPreviewGame = new Game();</b>
&nbsp;
<b class="nc">&nbsp;    private String cmdSelectedTab = null;</b>
&nbsp;
<b class="nc">&nbsp;    private MechSummaryCache.Listener mechSummaryCacheListener = new MechSummaryCache.Listener() {</b>
&nbsp;        @Override
&nbsp;        public void doneLoading() {
<b class="nc">&nbsp;            butLoad.setEnabled(true);</b>
<b class="nc">&nbsp;            butArmy.setEnabled(true);</b>
<b class="nc">&nbsp;            butLoadList.setEnabled(true);</b>
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    //region Action Commands
&nbsp;    private static final String NAME_COMMAND = &quot;NAME&quot;;
&nbsp;    private static final String CALLSIGN_COMMAND = &quot;CALLSIGN&quot;;
&nbsp;    //endregion Action Commands
&nbsp;
&nbsp;    /**
&nbsp;     * Creates a new chat lounge for the clientgui.getClient().
&nbsp;     */
&nbsp;    public ChatLounge(ClientGUI clientgui) {
<b class="nc">&nbsp;        super(clientgui, SkinSpecification.UIComponents.ChatLounge.getComp(),</b>
<b class="nc">&nbsp;                SkinSpecification.UIComponents.ChatLoungeDoneButton.getComp());</b>
&nbsp;
&nbsp;        // Create a tabbed panel to hold our components.
<b class="nc">&nbsp;        panTabs = new JTabbedPane();</b>
<b class="nc">&nbsp;        Font tabPanelFont = new Font(&quot;Dialog&quot;, Font.BOLD, //$NON-NLS-1$</b>
<b class="nc">&nbsp;                GUIPreferences.getInstance().getInt(&quot;AdvancedChatLoungeTabFontSize&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        panTabs.setFont(tabPanelFont);</b>
&nbsp;
<b class="nc">&nbsp;        clientgui.getClient().getGame().addGameListener(this);</b>
<b class="nc">&nbsp;        clientgui.getBoardView().addBoardViewListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        butOptions = new JButton(Messages.getString(&quot;ChatLounge.butOptions&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butOptions.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        lblMapSummary = new JLabel(&quot;&quot;);</b>
<b class="nc">&nbsp;        lblGameYear = new JLabel(&quot;&quot;);</b>
<b class="nc">&nbsp;        lblGameYear.setToolTipText(Messages.getString(&quot;ChatLounge.GameYearLabelToolTip&quot;)); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;        lblTechLevel = new JLabel(&quot;&quot;);</b>
<b class="nc">&nbsp;        lblTechLevel.setToolTipText(Messages.getString(&quot;ChatLounge.TechLevelLabelToolTip&quot;)); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;        butCompact = new JToggleButton(Messages.getString(&quot;ChatLounge.butCompact&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butCompact.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        butDone.setText(Messages.getString(&quot;ChatLounge.butDone&quot;));</b>
<b class="nc">&nbsp;        Font font = null;</b>
&nbsp;        try {
<b class="nc">&nbsp;            font = new Font(&quot;sanserif&quot;, Font.BOLD, 12);</b>
<b class="nc">&nbsp;        } catch (Exception exp) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(exp);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (font == null) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(&quot;Couldn&#39;t find the new font for the &#39;Done&#39; button.&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            butDone.setFont(font);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setupPlayerInfo();</b>
&nbsp;
<b class="nc">&nbsp;        refreshGameSettings();</b>
&nbsp;
<b class="nc">&nbsp;        setupEntities();</b>
<b class="nc">&nbsp;        setupUnitConfiguration();</b>
&nbsp;
<b class="nc">&nbsp;        refreshEntities();</b>
&nbsp;
<b class="nc">&nbsp;        setupMainPanel();</b>
&nbsp;
&nbsp;        // layout main thing
<b class="nc">&nbsp;        setLayout(new BorderLayout());</b>
&nbsp;
<b class="nc">&nbsp;        refreshMapSummaryLabel();</b>
<b class="nc">&nbsp;        refreshGameYearLabel();</b>
<b class="nc">&nbsp;        refreshTechLevelLabel();</b>
&nbsp;
<b class="nc">&nbsp;        if (GUIPreferences.getInstance().getChatLoungeTabs()) {</b>
<b class="nc">&nbsp;            add(panTabs, BorderLayout.CENTER);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            add(panMain, BorderLayout.CENTER);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets up the entities table
&nbsp;     */
&nbsp;    private void setupEntities() {
<b class="nc">&nbsp;        mekModel = new MekTableModel();</b>
<b class="nc">&nbsp;        tableEntities = new JTable();</b>
<b class="nc">&nbsp;        tableEntities.setModel(mekModel);</b>
<b class="nc">&nbsp;        tableEntities.setRowHeight(80);</b>
<b class="nc">&nbsp;        tableEntities.setIntercellSpacing(new Dimension(0, 0));</b>
<b class="nc">&nbsp;        tableEntities.setSelectionMode(ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);</b>
<b class="nc">&nbsp;        TableColumn column = null;</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; MekTableModel.N_COL; i++) {</b>
<b class="nc">&nbsp;            tableEntities.getColumnModel().getColumn(i).setCellRenderer(mekModel.getRenderer());</b>
<b class="nc">&nbsp;            column = tableEntities.getColumnModel().getColumn(i);</b>
<b class="nc">&nbsp;            if ((i == MekTableModel.COL_UNIT) || (i == MekTableModel.COL_PILOT)) {</b>
<b class="nc">&nbsp;                column.setPreferredWidth(170);</b>
<b class="nc">&nbsp;            } else if (i == MekTableModel.COL_PLAYER) {</b>
<b class="nc">&nbsp;                column.setPreferredWidth(50);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                column.setPreferredWidth(10);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        tableEntities.addMouseListener(new MekTableMouseAdapter());</b>
<b class="nc">&nbsp;        tableEntities.addKeyListener(new MekTableKeyAdapter());</b>
<b class="nc">&nbsp;        tableEntities.getSelectionModel().addListSelectionListener(this);</b>
<b class="nc">&nbsp;        scrEntities = new JScrollPane(tableEntities);</b>
<b class="nc">&nbsp;        scrEntities.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets up the unit configuration panel
&nbsp;     */
&nbsp;    private void setupUnitConfiguration() {
<b class="nc">&nbsp;        butLoadList = new JButton(Messages.getString(&quot;ChatLounge.butLoadList&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butLoadList.setActionCommand(&quot;load_list&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butLoadList.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        butSaveList = new JButton(Messages.getString(&quot;ChatLounge.butSaveList&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butSaveList.setActionCommand(&quot;save_list&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butSaveList.addActionListener(this);</b>
<b class="nc">&nbsp;        butSaveList.setEnabled(false);</b>
&nbsp;
<b class="nc">&nbsp;        butLoad = new JButton(Messages.getString(&quot;ChatLounge.butLoad&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butArmy = new JButton(Messages.getString(&quot;ChatLounge.butArmy&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butSkills = new JButton(Messages.getString(&quot;ChatLounge.butSkills&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butNames = new JButton(Messages.getString(&quot;ChatLounge.butNames&quot;)); //$NON-NLS-1$</b>
&nbsp;
&nbsp;        // Initialize the RandomNameGenerator and RandomCallsignGenerator
<b class="nc">&nbsp;        RandomNameGenerator.getInstance();</b>
<b class="nc">&nbsp;        RandomCallsignGenerator.getInstance();</b>
&nbsp;
<b class="nc">&nbsp;        MechSummaryCache mechSummaryCache = MechSummaryCache.getInstance();</b>
<b class="nc">&nbsp;        mechSummaryCache.addListener(mechSummaryCacheListener);</b>
<b class="nc">&nbsp;        boolean mscLoaded = mechSummaryCache.isInitialized();</b>
<b class="nc">&nbsp;        butLoad.setEnabled(mscLoaded);</b>
<b class="nc">&nbsp;        butArmy.setEnabled(mscLoaded);</b>
<b class="nc">&nbsp;        butLoadList.setEnabled(mscLoaded);</b>
<b class="nc">&nbsp;        butSkills.setEnabled(true);</b>
<b class="nc">&nbsp;        butNames.setEnabled(true);</b>
&nbsp;
<b class="nc">&nbsp;        Font font = new Font(&quot;Sans Serif&quot;, Font.BOLD, 18); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butLoad.setFont(font);</b>
<b class="nc">&nbsp;        butLoad.setActionCommand(&quot;load_mech&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butLoad.addActionListener(this);</b>
<b class="nc">&nbsp;        butArmy.addActionListener(this);</b>
<b class="nc">&nbsp;        butSkills.addActionListener(this);</b>
<b class="nc">&nbsp;        butNames.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        butDeleteAll = new JButton(Messages.getString(&quot;ChatLounge.butDeleteAll&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butDeleteAll.setActionCommand(&quot;delete_all&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butDeleteAll.addActionListener(this);</b>
<b class="nc">&nbsp;        butDeleteAll.setEnabled(false);</b>
&nbsp;
<b class="nc">&nbsp;        panUnitInfo = new JPanel();</b>
<b class="nc">&nbsp;        panUnitInfo.setBorder(BorderFactory.createTitledBorder(&quot;Unit Setup&quot;));</b>
&nbsp;
&nbsp;        // layout
<b class="nc">&nbsp;        GridBagLayout gridbag = new GridBagLayout();</b>
<b class="nc">&nbsp;        GridBagConstraints c = new GridBagConstraints();</b>
<b class="nc">&nbsp;        panUnitInfo.setLayout(gridbag);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridwidth = 2;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butLoad, c);</b>
<b class="nc">&nbsp;        panUnitInfo.add(butLoad);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butArmy, c);</b>
<b class="nc">&nbsp;        panUnitInfo.add(butArmy);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butSkills, c);</b>
<b class="nc">&nbsp;        panUnitInfo.add(butSkills);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 3;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butNames, c);</b>
<b class="nc">&nbsp;        panUnitInfo.add(butNames);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butLoadList, c);</b>
<b class="nc">&nbsp;        panUnitInfo.add(butLoadList);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butSaveList, c);</b>
<b class="nc">&nbsp;        panUnitInfo.add(butSaveList);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.gridy = 3;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butDeleteAll, c);</b>
<b class="nc">&nbsp;        panUnitInfo.add(butDeleteAll);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets up the player info (team, camo) panel
&nbsp;     */
&nbsp;    private void setupPlayerInfo() {
&nbsp;
<b class="nc">&nbsp;        playerModel = new PlayerTableModel();</b>
<b class="nc">&nbsp;        tablePlayers = new JTable(playerModel) {</b>
&nbsp;            private static final long serialVersionUID = 6252953920509362407L;
&nbsp;
&nbsp;            @Override
&nbsp;            public String getToolTipText(MouseEvent e) {
<b class="nc">&nbsp;                java.awt.Point p = e.getPoint();</b>
<b class="nc">&nbsp;                int rowIndex = rowAtPoint(p);</b>
<b class="nc">&nbsp;                int colIndex = columnAtPoint(p);</b>
<b class="nc">&nbsp;                int realColIndex = convertColumnIndexToModel(colIndex);</b>
<b class="nc">&nbsp;                IPlayer player = playerModel.getPlayerAt(rowIndex);</b>
<b class="nc">&nbsp;                if (player == null) {</b>
<b class="nc">&nbsp;                    return null;</b>
&nbsp;                }
<b class="nc">&nbsp;                int mines = player.getNbrMFConventional() + player.getNbrMFActive() + player.getNbrMFInferno()</b>
<b class="nc">&nbsp;                        + player.getNbrMFVibra();</b>
<b class="nc">&nbsp;                if (realColIndex == PlayerTableModel.COL_PLAYER) {</b>
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.tipPlayer&quot;,</b>
<b class="nc">&nbsp;                            new Object[] { getValueAt(rowIndex, colIndex), player.getConstantInitBonus(), mines });</b>
<b class="nc">&nbsp;                } else if (realColIndex == PlayerTableModel.COL_TON) {</b>
<b class="nc">&nbsp;                    return ((Double) getValueAt(rowIndex, colIndex)).toString();</b>
<b class="nc">&nbsp;                } else if (realColIndex == PlayerTableModel.COL_COST) {</b>
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.tipCost&quot;,</b>
<b class="nc">&nbsp;                            new Object[] { (Integer) getValueAt(rowIndex, colIndex) });</b>
<b class="nc">&nbsp;                } else if (realColIndex == PlayerTableModel.COL_START) {</b>
<b class="nc">&nbsp;                    return (String) getValueAt(rowIndex, colIndex);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return Integer.toString((Integer) getValueAt(rowIndex, colIndex));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        };
<b class="nc">&nbsp;        tablePlayers.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</b>
<b class="nc">&nbsp;        tablePlayers.getSelectionModel().addListSelectionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        tablePlayers.setModel(playerModel);</b>
<b class="nc">&nbsp;        TableColumn column = null;</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; PlayerTableModel.N_COL; i++) {</b>
<b class="nc">&nbsp;            column = tablePlayers.getColumnModel().getColumn(i);</b>
<b class="nc">&nbsp;            if (i == PlayerTableModel.COL_PLAYER) {</b>
<b class="nc">&nbsp;                column.setPreferredWidth(90);</b>
<b class="nc">&nbsp;            } else if (i == PlayerTableModel.COL_TEAM) {</b>
<b class="nc">&nbsp;                column.setPreferredWidth(5);</b>
<b class="nc">&nbsp;            } else if ((i == PlayerTableModel.COL_COST)) {</b>
<b class="nc">&nbsp;                column.setPreferredWidth(55);</b>
<b class="nc">&nbsp;            } else if (i == PlayerTableModel.COL_START) {</b>
<b class="nc">&nbsp;                column.setPreferredWidth(50);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                column.setPreferredWidth(35);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        tablePlayers.addMouseListener(new PlayerTableMouseAdapter());</b>
&nbsp;
<b class="nc">&nbsp;        scrPlayers = new JScrollPane(tablePlayers);</b>
<b class="nc">&nbsp;        scrPlayers.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);</b>
&nbsp;
<b class="nc">&nbsp;        panPlayerInfo = new JPanel();</b>
<b class="nc">&nbsp;        panPlayerInfo.setBorder(BorderFactory.createTitledBorder(&quot;Player Setup&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        butAddBot = new JButton(Messages.getString(&quot;ChatLounge.butAddBot&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butAddBot.setActionCommand(&quot;add_bot&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butAddBot.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        butRemoveBot = new JButton(Messages.getString(&quot;ChatLounge.butRemoveBot&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butRemoveBot.setEnabled(false);</b>
<b class="nc">&nbsp;        butRemoveBot.setActionCommand(&quot;remove_bot&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butRemoveBot.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        choTeam = new JComboBox&lt;String&gt;();</b>
<b class="nc">&nbsp;        setupTeams();</b>
<b class="nc">&nbsp;        choTeam.addItemListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        butCamo = new JButton();</b>
<b class="nc">&nbsp;        butCamo.setPreferredSize(new Dimension(84, 72));</b>
<b class="nc">&nbsp;        butCamo.setActionCommand(&quot;camo&quot;);</b>
<b class="nc">&nbsp;        butCamo.addActionListener(e -&gt; {</b>
&nbsp;            // Show the CamoChooserDialog for the selected player
<b class="nc">&nbsp;            IPlayer player = getPlayerSelected().getLocalPlayer();</b>
<b class="nc">&nbsp;            CamoChooserDialog ccd = new CamoChooserDialog(clientgui.getFrame(), player.getCamouflage());</b>
&nbsp;
&nbsp;            // If the dialog was canceled or nothing selected, do nothing
<b class="nc">&nbsp;            if ((ccd.showDialog() == JOptionPane.CANCEL_OPTION) || (ccd.getSelectedItem() == null)) {</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            // Update the player from the camo selection
<b class="nc">&nbsp;            AbstractIcon selectedItem = ccd.getSelectedItem();</b>
<b class="nc">&nbsp;            player.setCamoCategory(selectedItem.getCategory());</b>
<b class="nc">&nbsp;            player.setCamoFileName(selectedItem.getFilename());</b>
<b class="nc">&nbsp;            butCamo.setIcon(player.getCamouflage().getImageIcon());</b>
<b class="nc">&nbsp;            getPlayerSelected().sendPlayerInfo();</b>
&nbsp;        });
<b class="nc">&nbsp;        refreshCamos();</b>
&nbsp;
<b class="nc">&nbsp;        butChangeStart = new JButton(Messages.getString(&quot;ChatLounge.butChangeStart&quot;));</b>
<b class="nc">&nbsp;        butChangeStart.addActionListener(this);</b>
&nbsp;
&nbsp;        // layout
<b class="nc">&nbsp;        GridBagLayout gridbag = new GridBagLayout();</b>
<b class="nc">&nbsp;        GridBagConstraints c = new GridBagConstraints();</b>
<b class="nc">&nbsp;        panPlayerInfo.setLayout(gridbag);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(choTeam, c);</b>
<b class="nc">&nbsp;        panPlayerInfo.add(choTeam);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butChangeStart, c);</b>
<b class="nc">&nbsp;        panPlayerInfo.add(butChangeStart);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butAddBot, c);</b>
<b class="nc">&nbsp;        panPlayerInfo.add(butAddBot);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 3;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butRemoveBot, c);</b>
<b class="nc">&nbsp;        panPlayerInfo.add(butRemoveBot);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 4;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 1.0;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butCamo, c);</b>
<b class="nc">&nbsp;        panPlayerInfo.add(butCamo);</b>
&nbsp;
<b class="nc">&nbsp;        refreshPlayerInfo();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setupMainPanel() {
<b class="nc">&nbsp;        setupMap();</b>
&nbsp;
<b class="nc">&nbsp;        panMain = new JPanel();</b>
&nbsp;
&nbsp;        // layout
<b class="nc">&nbsp;        GridBagLayout gridbag = new GridBagLayout();</b>
<b class="nc">&nbsp;        GridBagConstraints c = new GridBagConstraints();</b>
<b class="nc">&nbsp;        panMain.setLayout(gridbag);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.VERTICAL;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butOptions, c);</b>
<b class="nc">&nbsp;        panMain.add(butOptions);</b>
&nbsp;
<b class="nc">&nbsp;        JPanel panel1 = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.weightx = 1;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;        panel1.add(lblMapSummary, c);</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.weightx = 0;</b>
<b class="nc">&nbsp;        c.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;        c.insets = new Insets(0, 0, 0, 20);</b>
<b class="nc">&nbsp;        panel1.add(lblGameYear, c);</b>
<b class="nc">&nbsp;        c.gridx = 2;</b>
<b class="nc">&nbsp;        panel1.add(lblTechLevel, c);</b>
<b class="nc">&nbsp;        c.insets = new Insets(0, 0, 0, 0);</b>
<b class="nc">&nbsp;        c.fill = GridBagConstraints.VERTICAL;</b>
<b class="nc">&nbsp;        c.gridx = 3;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.weightx = 0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHEAST;</b>
<b class="nc">&nbsp;        panel1.add(butCompact, c);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHEAST;</b>
<b class="nc">&nbsp;        panMain.add(panel1, c);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 1.0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 3;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(scrEntities, c);</b>
<b class="nc">&nbsp;        panMain.add(scrEntities);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(panUnitInfo, c);</b>
<b class="nc">&nbsp;        panMain.add(panUnitInfo);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(panPlayerInfo, c);</b>
<b class="nc">&nbsp;        panMain.add(panPlayerInfo);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 3;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 1.0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(scrPlayers, c);</b>
<b class="nc">&nbsp;        panMain.add(scrPlayers);</b>
&nbsp;
<b class="nc">&nbsp;        panTabs.add(&quot;Select Units&quot;, panMain); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        panTabs.add(&quot;Select Map&quot;, panMap); //$NON-NLS-1$</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setupMap() {
&nbsp;
<b class="nc">&nbsp;        panMap = new JPanel();</b>
&nbsp;
<b class="nc">&nbsp;        mapSettings = MapSettings.getInstance(clientgui.getClient().getMapSettings());</b>
&nbsp;
<b class="nc">&nbsp;        butConditions = new JButton(Messages.getString(&quot;ChatLounge.butConditions&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butConditions.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        butRandomMap = new JButton(Messages.getString(&quot;BoardSelectionDialog.GeneratedMapSettings&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butRandomMap.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        chkIncludeGround = new JCheckBox(Messages.getString(&quot;ChatLounge.IncludeGround&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        chkIncludeGround.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        chkIncludeSpace = new JCheckBox(Messages.getString(&quot;ChatLounge.IncludeSpace&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        chkIncludeSpace.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        setupGroundMap();</b>
<b class="nc">&nbsp;        setupSpaceMap();</b>
<b class="nc">&nbsp;        refreshSpaceGround();</b>
&nbsp;
<b class="nc">&nbsp;        GridBagLayout gridbag = new GridBagLayout();</b>
<b class="nc">&nbsp;        GridBagConstraints c = new GridBagConstraints();</b>
<b class="nc">&nbsp;        panMap.setLayout(gridbag);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.EAST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butConditions, c);</b>
<b class="nc">&nbsp;        panMap.add(butConditions);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.WEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butRandomMap, c);</b>
<b class="nc">&nbsp;        panMap.add(butRandomMap);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.insets = new Insets(4, 4, 4, 4);</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.75;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.gridwidth = 2;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(panGroundMap, c);</b>
<b class="nc">&nbsp;        panMap.add(panGroundMap);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.25;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        c.gridwidth = 2;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(panSpaceMap, c);</b>
<b class="nc">&nbsp;        panMap.add(panSpaceMap);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets up the ground map selection panel
&nbsp;     */
&nbsp;    @SuppressWarnings(&quot;rawtypes&quot;)
&nbsp;    private void setupGroundMap() {
&nbsp;
<b class="nc">&nbsp;        panGroundMap = new JPanel();</b>
<b class="nc">&nbsp;        panGroundMap.setBorder(BorderFactory.createTitledBorder(&quot;Planetary Map&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        panMapButtons = new JPanel();</b>
&nbsp;
<b class="nc">&nbsp;        comboMapType = new JComboBox&lt;String&gt;();</b>
<b class="nc">&nbsp;        setupMapChoice();</b>
&nbsp;
<b class="nc">&nbsp;        butMapSize = new JButton(Messages.getString(&quot;ChatLounge.MapSize&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butMapSize.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        comboMapSizes = new JComboBox&lt;Comparable&gt;();</b>
<b class="nc">&nbsp;        setupMapSizes();</b>
&nbsp;
<b class="nc">&nbsp;        buttonBoardPreview = new JButton(Messages.getString(&quot;BoardSelectionDialog.ViewGameBoard&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        buttonBoardPreview.addActionListener(this);</b>
<b class="nc">&nbsp;        buttonBoardPreview.setToolTipText(Messages.getString(&quot;BoardSelectionDialog.ViewGameBoardTooltip&quot;));//$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;        butChange = new JButton(&quot;&lt;&lt;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butChange.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        labBoardsSelected = new JLabel(Messages.getString(&quot;BoardSelectionDialog.MapsSelected&quot;), SwingConstants.CENTER); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        labBoardsAvailable = new JLabel(Messages.getString(&quot;BoardSelectionDialog.mapsAvailable&quot;), //$NON-NLS-1$</b>
&nbsp;                SwingConstants.CENTER);
&nbsp;
<b class="nc">&nbsp;        lisBoardsSelected = new JList&lt;String&gt;(new DefaultListModel&lt;String&gt;());</b>
<b class="nc">&nbsp;        lisBoardsSelected.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</b>
<b class="nc">&nbsp;        lisBoardsAvailable = new JList&lt;String&gt;(new DefaultListModel&lt;String&gt;());</b>
<b class="nc">&nbsp;        refreshBoardsSelected();</b>
<b class="nc">&nbsp;        refreshBoardsAvailable();</b>
<b class="nc">&nbsp;        lisBoardsAvailable.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</b>
<b class="nc">&nbsp;        lisBoardsAvailable.addMouseListener(this);</b>
<b class="nc">&nbsp;        lisBoardsAvailable.addListSelectionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        chkRotateBoard = new JCheckBox(Messages.getString(&quot;BoardSelectionDialog.RotateBoard&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        chkRotateBoard.addActionListener(this);</b>
&nbsp;
&nbsp;        // layout
<b class="nc">&nbsp;        GridBagLayout gridbag = new GridBagLayout();</b>
<b class="nc">&nbsp;        GridBagConstraints c = new GridBagConstraints();</b>
<b class="nc">&nbsp;        panGroundMap.setLayout(gridbag);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(chkIncludeGround, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(chkIncludeGround);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(comboMapType, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(comboMapType);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(comboMapSizes, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(comboMapSizes);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 3;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butMapSize, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(butMapSize);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 4;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(buttonBoardPreview, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(buttonBoardPreview);</b>
&nbsp;
<b class="nc">&nbsp;        scrMapButtons = new JScrollPane(panMapButtons);</b>
<b class="nc">&nbsp;        refreshMapButtons();</b>
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 1.0;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 5;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(scrMapButtons, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(scrMapButtons);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(labBoardsSelected, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(labBoardsSelected);</b>
&nbsp;
<b class="nc">&nbsp;        scrBoardsSelected = new JScrollPane(lisBoardsSelected);</b>
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 1.0;</b>
<b class="nc">&nbsp;        c.gridx = 1;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 4;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(scrBoardsSelected, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(scrBoardsSelected);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 2;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.CENTER;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butChange, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(butChange);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 3;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(labBoardsAvailable, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(labBoardsAvailable);</b>
&nbsp;
<b class="nc">&nbsp;        scrBoardsAvailable = new JScrollPane(lisBoardsAvailable);</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 1.0;</b>
<b class="nc">&nbsp;        c.gridx = 3;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 4;</b>
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(scrBoardsAvailable, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(scrBoardsAvailable);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 4;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.CENTER;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(chkRotateBoard, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(chkRotateBoard);</b>
&nbsp;
<b class="nc">&nbsp;        mapPreviewPanel = new JPanel();</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 1.0;</b>
<b class="nc">&nbsp;        c.gridx = 4;</b>
<b class="nc">&nbsp;        c.gridy = 2;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 4;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(mapPreviewPanel, c);</b>
<b class="nc">&nbsp;        panGroundMap.add(mapPreviewPanel);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            miniMap = new MiniMap(mapPreviewPanel, null);</b>
&nbsp;            // Set a default size for the minimap object to ensure it will have
&nbsp;            // space on the screen to be drawn.
<b class="nc">&nbsp;            miniMap.setSize(160, 200);</b>
<b class="nc">&nbsp;            miniMap.setZoom(2);</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(this, Messages.getString(&quot;BoardEditor.CouldNotInitialiseMinimap&quot;) + e,</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;BoardEditor.FatalError&quot;), JOptionPane.ERROR_MESSAGE); // $NON-NLS-1$</b>
&nbsp;            // //$NON-NLS-2$
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        mapPreviewPanel.add(miniMap);</b>
&nbsp;
&nbsp;        // setup the board preview window.
<b class="nc">&nbsp;        boardPreviewW = new ClientDialog(clientgui.frame, </b>
<b class="nc">&nbsp;                Messages.getString(&quot;BoardSelectionDialog.ViewGameBoard&quot;), //$NON-NLS-1$</b>
&nbsp;                false);
<b class="nc">&nbsp;        boardPreviewW.setLocationRelativeTo(clientgui.frame);</b>
<b class="nc">&nbsp;        boardPreviewW.setVisible(false);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            BoardView1 bv = new BoardView1(boardPreviewGame, null, null);</b>
<b class="nc">&nbsp;            bv.setDisplayInvalidHexInfo(false);</b>
<b class="nc">&nbsp;            bv.setUseLOSTool(false);</b>
<b class="nc">&nbsp;            boardPreviewW.add(bv.getComponent(true));</b>
<b class="nc">&nbsp;            boardPreviewW.setSize(clientgui.frame.getWidth()/2, clientgui.frame.getHeight()/2);</b>
<b class="nc">&nbsp;            bv.zoomOut();</b>
<b class="nc">&nbsp;            bv.zoomOut();</b>
<b class="nc">&nbsp;            bv.zoomOut();</b>
<b class="nc">&nbsp;            bv.zoomOut();</b>
<b class="nc">&nbsp;            boardPreviewW.center();</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(this,</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;BoardEditor.CouldntInitialize&quot;) + e,</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;BoardEditor.FatalError&quot;), JOptionPane.ERROR_MESSAGE); //$NON-NLS-1$</b>
&nbsp;            //$NON-NLS-2$
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private void setupSpaceMap() {
&nbsp;
<b class="nc">&nbsp;        panSpaceMap = new JPanel();</b>
<b class="nc">&nbsp;        panSpaceMap.setBorder(BorderFactory.createTitledBorder(&quot;Space Map&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        butSpaceSize = new JButton(Messages.getString(&quot;ChatLounge.MapSize&quot;));</b>
<b class="nc">&nbsp;        butSpaceSize.addActionListener(this);</b>
&nbsp;
&nbsp;        // layout
<b class="nc">&nbsp;        GridBagLayout gridbag = new GridBagLayout();</b>
<b class="nc">&nbsp;        GridBagConstraints c = new GridBagConstraints();</b>
<b class="nc">&nbsp;        panSpaceMap.setLayout(gridbag);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(chkIncludeSpace, c);</b>
<b class="nc">&nbsp;        panSpaceMap.add(chkIncludeSpace);</b>
&nbsp;
<b class="nc">&nbsp;        c.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;        c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 1.0;</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.gridwidth = 1;</b>
<b class="nc">&nbsp;        c.gridheight = 1;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridbag.setConstraints(butSpaceSize, c);</b>
<b class="nc">&nbsp;        panSpaceMap.add(butSpaceSize);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Set up the map chooser panel
&nbsp;     */
&nbsp;    private void setupMapChoice() {
<b class="nc">&nbsp;        comboMapType.addItem(MapSettings.getMediumName(MapSettings.MEDIUM_GROUND));</b>
<b class="nc">&nbsp;        comboMapType.addItem(MapSettings.getMediumName(MapSettings.MEDIUM_ATMOSPHERE));</b>
<b class="nc">&nbsp;        comboMapType.addActionListener(this);</b>
<b class="nc">&nbsp;        refreshMapChoice();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setupMapSizes() {
<b class="nc">&nbsp;        int oldSelection = comboMapSizes.getSelectedIndex();</b>
<b class="nc">&nbsp;        mapSizes = clientgui.getClient().getAvailableMapSizes();</b>
<b class="nc">&nbsp;        comboMapSizes.removeActionListener(this);</b>
<b class="nc">&nbsp;        comboMapSizes.removeAllItems();</b>
<b class="nc">&nbsp;        for (BoardDimensions size : mapSizes) {</b>
<b class="nc">&nbsp;            comboMapSizes.addItem(size);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        comboMapSizes.addItem(Messages.getString(&quot;ChatLounge.CustomMapSize&quot;));</b>
<b class="nc">&nbsp;        comboMapSizes.setSelectedIndex(oldSelection != -1 ? oldSelection : 0);</b>
<b class="nc">&nbsp;        comboMapSizes.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshMapChoice() {
<b class="nc">&nbsp;        comboMapType.removeActionListener(this);</b>
<b class="nc">&nbsp;        if (mapSettings.getMedium() &lt; MapSettings.MEDIUM_SPACE) {</b>
<b class="nc">&nbsp;            comboMapType.setSelectedIndex(mapSettings.getMedium());</b>
&nbsp;        }
<b class="nc">&nbsp;        comboMapType.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshSpaceGround() {
<b class="nc">&nbsp;        chkIncludeGround.removeActionListener(this);</b>
<b class="nc">&nbsp;        chkIncludeSpace.removeActionListener(this);</b>
<b class="nc">&nbsp;        boolean inSpace = mapSettings.getMedium() == MapSettings.MEDIUM_SPACE;</b>
<b class="nc">&nbsp;        chkIncludeSpace.setSelected(inSpace);</b>
<b class="nc">&nbsp;        chkIncludeGround.setSelected(!inSpace);</b>
<b class="nc">&nbsp;        comboMapType.setEnabled(!inSpace);</b>
<b class="nc">&nbsp;        butMapSize.setEnabled(!inSpace);</b>
<b class="nc">&nbsp;        comboMapSizes.setEnabled(!inSpace);</b>
<b class="nc">&nbsp;        buttonBoardPreview.setEnabled(!inSpace);</b>
<b class="nc">&nbsp;        lisBoardsSelected.setEnabled(!inSpace);</b>
<b class="nc">&nbsp;        butChange.setEnabled(!inSpace);</b>
<b class="nc">&nbsp;        lisBoardsAvailable.setEnabled(!inSpace);</b>
<b class="nc">&nbsp;        chkRotateBoard.setEnabled(!inSpace);</b>
<b class="nc">&nbsp;        butSpaceSize.setEnabled(inSpace);</b>
<b class="nc">&nbsp;        chkIncludeGround.addActionListener(this);</b>
<b class="nc">&nbsp;        chkIncludeSpace.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshBoardsAvailable() {
<b class="nc">&nbsp;        int selectedRow = lisBoardsAvailable.getSelectedIndex();</b>
<b class="nc">&nbsp;        ((DefaultListModel&lt;String&gt;) lisBoardsAvailable.getModel()).removeAllElements();</b>
<b class="nc">&nbsp;        for (String s : mapSettings.getBoardsAvailableVector()) {</b>
<b class="nc">&nbsp;            ((DefaultListModel&lt;String&gt;) lisBoardsAvailable.getModel()).addElement(s);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (resetAvailBoardSelection) {</b>
<b class="nc">&nbsp;            lisBoardsAvailable.setSelectedIndex(0);</b>
<b class="nc">&nbsp;            resetAvailBoardSelection = false;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            lisBoardsAvailable.setSelectedIndex(selectedRow);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void refreshBoardsSelected() {
<b class="nc">&nbsp;        int selectedRow = lisBoardsSelected.getSelectedIndex();</b>
<b class="nc">&nbsp;        ((DefaultListModel&lt;String&gt;) lisBoardsSelected.getModel()).removeAllElements();</b>
<b class="nc">&nbsp;        int index = 0;</b>
<b class="nc">&nbsp;        for (Iterator&lt;String&gt; i = mapSettings.getBoardsSelected(); i.hasNext();) {</b>
<b class="nc">&nbsp;            ((DefaultListModel&lt;String&gt;) lisBoardsSelected.getModel()).addElement(index++ + &quot;: &quot; + i.next()); //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        lisBoardsSelected.setSelectedIndex(selectedRow);</b>
<b class="nc">&nbsp;        if (resetSelectedBoards) {</b>
<b class="nc">&nbsp;            lisBoardsSelected.setSelectedIndex(0);</b>
<b class="nc">&nbsp;            resetSelectedBoards = false;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            lisBoardsSelected.setSelectedIndex(selectedRow);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Fills the Map Buttons scroll pane with the appropriate amount of buttons
&nbsp;     * in the appropriate layout
&nbsp;     */
&nbsp;    private void refreshMapButtons() {
<b class="nc">&nbsp;        panMapButtons.removeAll();</b>
&nbsp;
<b class="nc">&nbsp;        panMapButtons.setLayout(new GridLayout(mapSettings.getMapHeight(), mapSettings.getMapWidth()));</b>
&nbsp;
<b class="nc">&nbsp;        for (int i = 0; i &lt; mapSettings.getMapHeight(); i++) {</b>
<b class="nc">&nbsp;            for (int j = 0; j &lt; mapSettings.getMapWidth(); j++) {</b>
<b class="nc">&nbsp;                JButton button = new JButton(Integer.toString((i * mapSettings.getMapWidth()) + j));</b>
<b class="nc">&nbsp;                button.addActionListener(this);</b>
<b class="nc">&nbsp;                panMapButtons.add(button);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        scrMapButtons.validate();</b>
&nbsp;
<b class="nc">&nbsp;        labBoardsAvailable.setText(mapSettings.getBoardWidth() + &quot;x&quot; + mapSettings.getBoardHeight() + &quot; &quot;</b>
<b class="nc">&nbsp;                + Messages.getString(&quot;BoardSelectionDialog.mapsAvailable&quot;));</b>
<b class="nc">&nbsp;        comboMapSizes.removeActionListener(this);</b>
<b class="nc">&nbsp;        int items = comboMapSizes.getItemCount();</b>
&nbsp;
<b class="nc">&nbsp;        boolean mapSizeSelected = false;</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; (items - 1); i++) {</b>
<b class="nc">&nbsp;            BoardDimensions size = (BoardDimensions) comboMapSizes.getItemAt(i);</b>
&nbsp;
<b class="nc">&nbsp;            if ((size.width() == mapSettings.getBoardWidth()) &amp;&amp; (size.height() == mapSettings.getBoardHeight())) {</b>
<b class="nc">&nbsp;                comboMapSizes.setSelectedIndex(i);</b>
<b class="nc">&nbsp;                mapSizeSelected = true;</b>
&nbsp;            }
&nbsp;        }
&nbsp;        // If we didn&#39;t select a size, select the last item: &#39;Custom Size&#39;
<b class="nc">&nbsp;        if (!mapSizeSelected) {</b>
<b class="nc">&nbsp;            comboMapSizes.setSelectedIndex(items - 1);</b>
&nbsp;        }
<b class="nc">&nbsp;        comboMapSizes.addActionListener(this);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    public void previewMapsheet() {
<b class="nc">&nbsp;        String boardName = lisBoardsAvailable.getSelectedValue();</b>
<b class="nc">&nbsp;        if (lisBoardsAvailable.getSelectedIndex() &gt; 2) {</b>
<b class="nc">&nbsp;            IBoard board = new Board(16, 17);</b>
<b class="nc">&nbsp;            board.load(new MegaMekFile(Configuration.boardsDir(), boardName + &quot;.board&quot;).getFile());</b>
<b class="nc">&nbsp;            if (chkRotateBoard.isSelected()) {</b>
<b class="nc">&nbsp;                BoardUtilities.flip(board, true, true);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (board.isValid())</b>
<b class="nc">&nbsp;                miniMap.setBoard(board);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void previewGameBoard() {
<b class="nc">&nbsp;        MapSettings temp = mapSettings;</b>
<b class="nc">&nbsp;        temp.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</b>
<b class="nc">&nbsp;        temp.replaceBoardWithRandom(MapSettings.BOARD_SURPRISE);</b>
<b class="nc">&nbsp;        IBoard[] sheetBoards = new IBoard[temp.getMapWidth() * temp.getMapHeight()];</b>
<b class="nc">&nbsp;        List&lt;Boolean&gt; rotateBoard = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; (temp.getMapWidth() * temp.getMapHeight()); i++) {</b>
<b class="nc">&nbsp;            sheetBoards[i] = new Board();</b>
<b class="nc">&nbsp;            String name = temp.getBoardsSelectedVector().get(i);</b>
<b class="nc">&nbsp;            boolean isRotated = false;</b>
<b class="nc">&nbsp;            if (name.startsWith(Board.BOARD_REQUEST_ROTATION)) {</b>
&nbsp;                // only rotate boards with an even width
<b class="nc">&nbsp;                if ((temp.getBoardWidth() % 2) == 0) {</b>
<b class="nc">&nbsp;                    isRotated = true;</b>
&nbsp;                }
<b class="nc">&nbsp;                name = name.substring(Board.BOARD_REQUEST_ROTATION.length());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (name.startsWith(MapSettings.BOARD_GENERATED) || (temp.getMedium() == MapSettings.MEDIUM_SPACE)) {</b>
<b class="nc">&nbsp;                sheetBoards[i] = BoardUtilities.generateRandom(temp);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                sheetBoards[i].load(new MegaMekFile(Configuration.boardsDir(), name</b>
<b class="nc">&nbsp;                        + &quot;.board&quot;).getFile());</b>
<b class="nc">&nbsp;                BoardUtilities.flip(sheetBoards[i], isRotated, isRotated);</b>
&nbsp;            }
<b class="nc">&nbsp;            rotateBoard.add(isRotated);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        IBoard newBoard = BoardUtilities.combine(temp.getBoardWidth(), temp.getBoardHeight(), temp.getMapWidth(),</b>
<b class="nc">&nbsp;                temp.getMapHeight(), sheetBoards, rotateBoard, temp.getMedium());</b>
&nbsp;        
<b class="nc">&nbsp;        boardPreviewGame.setBoard(newBoard);</b>
<b class="nc">&nbsp;        boardPreviewW.setVisible(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Refreshes the game settings with new info from the client
&nbsp;     */
&nbsp;    private void refreshGameSettings() {
<b class="nc">&nbsp;        refreshTeams();</b>
<b class="nc">&nbsp;        refreshDoneButton();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Refreshes the entities from the client
&nbsp;     */
&nbsp;    public void refreshEntities() {
<b class="nc">&nbsp;        mekModel.clearData();</b>
<b class="nc">&nbsp;        boolean localUnits = false;</b>
&nbsp;
&nbsp;        /*
&nbsp;         * We will attempt to sort by the following criteria: My units first,
&nbsp;         * then my teamates units, then other teams units. We will also sort by
&nbsp;         * player name within the forementioned categories. Finally, a players
&nbsp;         * units will be sorted by the order they were &quot;added&quot; to the list.
&nbsp;         */
<b class="nc">&nbsp;        ArrayList&lt;Entity&gt; allEntities = new ArrayList&lt;Entity&gt;();</b>
<b class="nc">&nbsp;        for (Entity ent : clientgui.getClient().getEntitiesVector()) {</b>
<b class="nc">&nbsp;            allEntities.add(ent);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        Collections.sort(allEntities, new Comparator&lt;Entity&gt;() {</b>
&nbsp;            @Override
&nbsp;            public int compare(final Entity a, final Entity b) {
&nbsp;                // entity.getOwner() does not work properly because teams are
&nbsp;                // not updated for
&nbsp;                // entities when the user switches teams
<b class="nc">&nbsp;                final IPlayer p_a = clientgui.getClient().getGame().getPlayer(a.getOwnerId());// a.getOwner();</b>
<b class="nc">&nbsp;                final IPlayer p_b = clientgui.getClient().getGame().getPlayer(b.getOwnerId());// b.getOwner();</b>
<b class="nc">&nbsp;                final IPlayer localPlayer = clientgui.getClient().getLocalPlayer();</b>
<b class="nc">&nbsp;                final int t_a = p_a.getTeam();</b>
<b class="nc">&nbsp;                final int t_b = p_b.getTeam();</b>
<b class="nc">&nbsp;                final int tr_a = a.getTransportId();</b>
<b class="nc">&nbsp;                final int tr_b = b.getTransportId();</b>
<b class="nc">&nbsp;                if (p_a.equals(localPlayer) &amp;&amp; !p_b.equals(localPlayer)) {</b>
<b class="nc">&nbsp;                    return -1;</b>
<b class="nc">&nbsp;                } else if (!p_a.equals(localPlayer) &amp;&amp; p_b.equals(localPlayer)) {</b>
<b class="nc">&nbsp;                    return 1;</b>
<b class="nc">&nbsp;                } else if ((t_a == localPlayer.getTeam()) &amp;&amp; (t_b != localPlayer.getTeam())) {</b>
<b class="nc">&nbsp;                    return -1;</b>
<b class="nc">&nbsp;                } else if ((t_b == localPlayer.getTeam()) &amp;&amp; (t_a != localPlayer.getTeam())) {</b>
<b class="nc">&nbsp;                    return 1;</b>
<b class="nc">&nbsp;                } else if (t_a != t_b) {</b>
<b class="nc">&nbsp;                    return t_a - t_b;</b>
<b class="nc">&nbsp;                } else if (!p_a.equals(p_b)) {</b>
<b class="nc">&nbsp;                    return p_a.getName().compareTo(p_b.getName());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    int a_id = a.getId();</b>
<b class="nc">&nbsp;                    int b_id = b.getId();</b>
&nbsp;                    // loaded units should be put immediately below their parent
&nbsp;                    // unit
&nbsp;                    // if a unit&#39;s transport ID is not none, then it should
&nbsp;                    // replace their actual id
<b class="nc">&nbsp;                    if (tr_a == tr_b) {</b>
&nbsp;                        // either they are both not being transported, or they
&nbsp;                        // are being transported
&nbsp;                        // by the same unit
<b class="nc">&nbsp;                        return a_id - b_id;</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    if (tr_b != Entity.NONE) {</b>
<b class="nc">&nbsp;                        if (tr_b == a_id) {</b>
&nbsp;                            // b is loaded on a
<b class="nc">&nbsp;                            return -1;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        b_id = tr_b;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (tr_a != Entity.NONE) {</b>
<b class="nc">&nbsp;                        if (tr_a == b_id) {</b>
&nbsp;                            // a is loaded on b
<b class="nc">&nbsp;                            return 1;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        a_id = tr_a;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return a_id - b_id;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        for (Entity entity : allEntities) {</b>
&nbsp;            // Remember if the local player has units.
<b class="nc">&nbsp;            if (!localUnits &amp;&amp; entity.getOwner().equals(clientgui.getClient().getLocalPlayer())) {</b>
<b class="nc">&nbsp;                localUnits = true;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_PILOT_ADVANTAGES)) { // $NON-NLS-1$</b>
<b class="nc">&nbsp;                entity.getCrew().clearOptions(PilotOptions.LVL3_ADVANTAGES);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.EDGE)) { // $NON-NLS-1$</b>
<b class="nc">&nbsp;                entity.getCrew().clearOptions(PilotOptions.EDGE_ADVANTAGES);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_MANEI_DOMINI)) { // $NON-NLS-1$</b>
<b class="nc">&nbsp;                entity.getCrew().clearOptions(PilotOptions.MD_ADVANTAGES);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                    .booleanOption(OptionsConstants.ADVANCED_STRATOPS_PARTIALREPAIRS)) { // $NON-NLS-1$</b>
<b class="nc">&nbsp;                entity.clearPartialRepairs();</b>
&nbsp;            }
&nbsp;            // Handle the &quot;Blind Drop&quot; option.
<b class="nc">&nbsp;            if (!entity.getOwner().equals(clientgui.getClient().getLocalPlayer())</b>
<b class="nc">&nbsp;                    &amp;&amp; clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP) // $NON-NLS-1$</b>
<b class="nc">&nbsp;                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                    .booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP)) { // $NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;                mekModel.addUnit(entity);</b>
<b class="nc">&nbsp;            } else if (entity.getOwner().equals(clientgui.getClient().getLocalPlayer())</b>
<b class="nc">&nbsp;                    || (!clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP) // $NON-NLS-1$</b>
<b class="nc">&nbsp;                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                    .booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP))) { // $NON-NLS-1$</b>
<b class="nc">&nbsp;                mekModel.addUnit(entity);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // Enable the &quot;Save Unit List...&quot; and &quot;Delete All&quot;
&nbsp;        // buttons if the local player has units.
<b class="nc">&nbsp;        butSaveList.setEnabled(localUnits);</b>
<b class="nc">&nbsp;        butDeleteAll.setEnabled(localUnits);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setUnitList(localUnits);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String formatPilotCompact(Crew pilot, boolean blindDrop, boolean rpgSkills) {
&nbsp;
<b class="nc">&nbsp;        String value = &quot;&quot;;</b>
<b class="nc">&nbsp;        if (blindDrop) {</b>
<b class="nc">&nbsp;            value += Messages.getString(&quot;ChatLounge.Unknown&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            value += pilot.getDesc();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        value += &quot; (&quot; + pilot.getSkillsAsString(rpgSkills) + &quot;)&quot;;</b>
<b class="nc">&nbsp;        if (pilot.countOptions() &gt; 0) {</b>
<b class="nc">&nbsp;            value += &quot; (&quot; + pilot.countOptions() + Messages.getString(&quot;ChatLounge.abilities&quot;) + &quot;)&quot;;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return value;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    public static String formatPilotHTML(Crew pilot, boolean blindDrop, boolean rpgSkill) {
&nbsp;
<b class="nc">&nbsp;        int crewAdvCount = pilot.countOptions(PilotOptions.LVL3_ADVANTAGES);</b>
<b class="nc">&nbsp;        int implants = pilot.countOptions(PilotOptions.MD_ADVANTAGES);</b>
&nbsp;
<b class="nc">&nbsp;        String value = &quot;&quot;;</b>
<b class="nc">&nbsp;        if (!blindDrop &amp;&amp; pilot.getSlotCount() &gt; 1) {</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; pilot.getSlotCount(); i++) {</b>
<b class="nc">&nbsp;                if (pilot.isMissing(i)) {</b>
<b class="nc">&nbsp;                    value += &quot;&lt;b&gt;No &quot; + pilot.getCrewType().getRoleName(i) + &quot;&lt;/b&gt;&quot;;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    value += &quot;&lt;b&gt;&quot; + pilot.getDesc(i) + &quot;&lt;/b&gt; (&quot; + pilot.getCrewType().getRoleName(i) + &quot;): &quot;;</b>
<b class="nc">&nbsp;                    value += pilot.getSkillsAsString(i, rpgSkill);</b>
&nbsp;                }
<b class="nc">&nbsp;                value += &quot;&lt;br/&gt;&quot;;</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            if (blindDrop) {</b>
<b class="nc">&nbsp;                value += &quot;&lt;b&gt;&quot; + Messages.getString(&quot;ChatLounge.Unknown&quot;) + &quot;&lt;/b&gt;&lt;br/&gt;&quot;;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                value += &quot;&lt;b&gt;&quot; + pilot.getDesc() + &quot;&lt;/b&gt;&lt;br/&gt;&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            value += &quot;&quot; + pilot.getSkillsAsString(rpgSkill);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (crewAdvCount &gt; 0) {</b>
<b class="nc">&nbsp;            value += &quot;, &quot; + crewAdvCount + Messages.getString(&quot;ChatLounge.advs&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        value += &quot;&lt;br&gt;&quot;;</b>
<b class="nc">&nbsp;        if (implants &gt; 0) {</b>
<b class="nc">&nbsp;            value += &quot;&lt;i&gt;&quot; + Messages.getString(&quot;ChatLounge.md&quot;) + &quot;&lt;/i&gt;, &quot; + implants</b>
<b class="nc">&nbsp;                    + Messages.getString(&quot;ChatLounge.implants&quot;) + &quot;&lt;br&gt;&quot;;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return value;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    public static String formatPilotTooltip(Crew pilot, boolean command, boolean init, boolean tough, boolean rpgSkills) {
&nbsp;
<b class="nc">&nbsp;        String value = &quot;&lt;html&gt;&quot;;</b>
<b class="nc">&nbsp;        value += &quot;&lt;b&gt;&quot; + pilot.getDesc() + &quot;&lt;/b&gt;&lt;br&gt;&quot;;</b>
<b class="nc">&nbsp;        if (pilot.getNickname().length() &gt; 0) {</b>
<b class="nc">&nbsp;            value += &quot;&lt;i&gt;&quot; + pilot.getNickname() + &quot;&lt;/i&gt;&lt;br&gt;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (pilot.getHits() &gt; 0) {</b>
<b class="nc">&nbsp;            value += &quot;&lt;font color=&#39;red&#39;&gt;&quot; + Messages.getString(&quot;ChatLounge.Hits&quot;) + pilot.getHits() + &quot;&lt;/font&gt;&lt;br&gt;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        value += &quot;&quot; + pilot.getSkillsAsString(rpgSkills) + &quot;&lt;br&gt;&quot;;</b>
<b class="nc">&nbsp;        if (tough) {</b>
<b class="nc">&nbsp;            value += Messages.getString(&quot;ChatLounge.Tough&quot;) + pilot.getToughness(0) + &quot;&lt;br&gt;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (command) {</b>
<b class="nc">&nbsp;            value += Messages.getString(&quot;ChatLounge.Command&quot;) + pilot.getCommandBonus() + &quot;&lt;br&gt;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (init) {</b>
<b class="nc">&nbsp;            value += Messages.getString(&quot;ChatLounge.Initiative&quot;) + pilot.getInitBonus() + &quot;&lt;br&gt;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        value += &quot;&lt;br&gt;&quot;;</b>
<b class="nc">&nbsp;        for (Enumeration&lt;IOptionGroup&gt; advGroups = pilot.getOptions().getGroups(); advGroups.hasMoreElements();) {</b>
<b class="nc">&nbsp;            IOptionGroup advGroup = advGroups.nextElement();</b>
<b class="nc">&nbsp;            if (pilot.countOptions(advGroup.getKey()) &gt; 0) {</b>
<b class="nc">&nbsp;                value += &quot;&lt;b&gt;&quot; + advGroup.getDisplayableName() + &quot;&lt;/b&gt;&lt;br&gt;&quot;;</b>
<b class="nc">&nbsp;                for (Enumeration&lt;IOption&gt; advs = advGroup.getOptions(); advs.hasMoreElements();) {</b>
<b class="nc">&nbsp;                    IOption adv = advs.nextElement();</b>
<b class="nc">&nbsp;                    if (adv.booleanValue()) {</b>
<b class="nc">&nbsp;                        value += &quot;  &quot; + adv.getDisplayableNameWithValue() + &quot;&lt;br&gt;&quot;;</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        value += &quot;&lt;/html&gt;&quot;;</b>
<b class="nc">&nbsp;        return value;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private static StringBuffer tooltipString;
&nbsp;    private static final boolean BR = true;
&nbsp;    private static final boolean NOBR = false;
&nbsp;
&nbsp;    /**
&nbsp;     * Adds a resource string to the entity tooltip
&nbsp;     *
&nbsp;     * @param ttSName
&nbsp;     *            The resource string name. &quot;BoardView1.Tooltip.&quot; will be added
&nbsp;     *            in front, so &quot;Pilot&quot; will retrieve BoardView1.Tooltip.Pilot
&nbsp;     * @param startBR
&nbsp;     *            = true will start the string with a &amp;lt;BR&amp;gt;; The constants
&nbsp;     *            BR and NOBR can be used here.
&nbsp;     * @param ttO
&nbsp;     *            a list of Objects to insert into the {x} places in the
&nbsp;     *            resource.
&nbsp;     */
&nbsp;    private static void addToTT(String ttSName, boolean startBR, Object... ttO) {
<b class="nc">&nbsp;        if (startBR == BR)</b>
<b class="nc">&nbsp;            tooltipString.append(&quot;&lt;BR&gt;&quot;);</b>
<b class="nc">&nbsp;        if (ttO != null) {</b>
<b class="nc">&nbsp;            tooltipString.append(Messages.getString(&quot;BoardView1.Tooltip.&quot; + ttSName, ttO));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            tooltipString.append(Messages.getString(&quot;BoardView1.Tooltip.&quot; + ttSName));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Adds a resource string to the entity tooltip
&nbsp;     *
&nbsp;     * @param ttSName
&nbsp;     *            The resource string name. &quot;BoardView1.Tooltip.&quot; will be added
&nbsp;     *            in front, so &quot;Pilot&quot; will retrieve BoardView1.Tooltip.Pilot
&nbsp;     * @param startBR
&nbsp;     *            = true will start the string with a &amp;lt;BR&amp;gt;; The constants
&nbsp;     *            BR and NOBR can be used here.
&nbsp;     */
&nbsp;    private static void addToTT(String ttSName, boolean startBR) {
<b class="nc">&nbsp;        addToTT(ttSName, startBR, (Object[]) null);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String formatUnitTooltip(Entity entity) {
&nbsp;
<b class="nc">&nbsp;        GunEmplacement thisGunEmp = null;</b>
<b class="nc">&nbsp;        if (entity instanceof GunEmplacement)</b>
<b class="nc">&nbsp;            thisGunEmp = (GunEmplacement) entity;</b>
&nbsp;
<b class="nc">&nbsp;        tooltipString = new StringBuffer();</b>
<b class="nc">&nbsp;        tooltipString.append(&quot;&lt;HTML&gt;&quot;);</b>
&nbsp;
&nbsp;        // Unit Chassis and Player
<b class="nc">&nbsp;        addToTT(&quot;Unit&quot;, NOBR, entity.getOwner().getColour().getHexString(),</b>
<b class="nc">&nbsp;                entity.getChassis(), entity.getOwner().getName());</b>
&nbsp;
&nbsp;        // Pilot Info
&nbsp;        // Nickname &gt; Name &gt; &quot;Pilot&quot;
<b class="nc">&nbsp;        for (int i = 0; i &lt; entity.getCrew().getSlotCount(); i++) {</b>
<b class="nc">&nbsp;            if (entity.getCrew().isMissing(i)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            String pnameStr = entity.getCrew().getCrewType().getRoleName(i);</b>
&nbsp;
<b class="nc">&nbsp;            if ((entity.getCrew().getName(i) != null) &amp;&amp; !entity.getCrew().getName(i).equals(&quot;&quot;))</b>
<b class="nc">&nbsp;                pnameStr = entity.getCrew().getName(i);</b>
&nbsp;
<b class="nc">&nbsp;            if ((entity.getCrew().getNickname(i) != null) &amp;&amp; !entity.getCrew().getNickname(i).equals(&quot;&quot;))</b>
<b class="nc">&nbsp;                pnameStr = &quot;&#39;&quot; + entity.getCrew().getNickname(i) + &quot;&#39;&quot;;</b>
&nbsp;
<b class="nc">&nbsp;            if (entity.getCrew().getSlotCount() &gt; 1) {</b>
<b class="nc">&nbsp;                pnameStr += &quot; (&quot; + entity.getCrew().getCrewType().getRoleName(i) + &quot;)&quot;;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            addToTT(&quot;Pilot&quot;, BR, pnameStr, entity.getCrew().getGunnery(i), entity.getCrew().getPiloting(i));</b>
&nbsp;
&nbsp;            // Pilot Status
<b class="nc">&nbsp;            if (!entity.getCrew().getStatusDesc(i).equals(&quot;&quot;))</b>
<b class="nc">&nbsp;                addToTT(&quot;PilotStatus&quot;, NOBR, entity.getCrew().getStatusDesc(i));</b>
&nbsp;        }
&nbsp;
&nbsp;        // Pilot Advantages
<b class="nc">&nbsp;        int numAdv = entity.getCrew().countOptions(PilotOptions.LVL3_ADVANTAGES);</b>
<b class="nc">&nbsp;        if (numAdv == 1)</b>
<b class="nc">&nbsp;            addToTT(&quot;Adv1&quot;, NOBR, numAdv);</b>
<b class="nc">&nbsp;        else if (numAdv &gt; 1)</b>
<b class="nc">&nbsp;            addToTT(&quot;Advs&quot;, NOBR, numAdv);</b>
&nbsp;
&nbsp;        // Pilot Manei Domini
<b class="nc">&nbsp;        if ((entity.getCrew().countOptions(PilotOptions.MD_ADVANTAGES) &gt; 0))</b>
<b class="nc">&nbsp;            addToTT(&quot;MD&quot;, NOBR);</b>
&nbsp;
&nbsp;        // Unit movement ability
<b class="nc">&nbsp;        if (thisGunEmp == null) {</b>
<b class="nc">&nbsp;            addToTT(&quot;Movement&quot;, BR, entity.getWalkMP(), entity.getRunMPasString());</b>
<b class="nc">&nbsp;            if (entity.getJumpMP() &gt; 0)</b>
<b class="nc">&nbsp;                tooltipString.append(&quot;/&quot; + entity.getJumpMP());</b>
&nbsp;        }
&nbsp;
&nbsp;        // Armor and Internals
<b class="nc">&nbsp;        addToTT(&quot;ArmorInternals&quot;, BR,</b>
<b class="nc">&nbsp;                entity.getTotalArmor()</b>
<b class="nc">&nbsp;                        + ((entity.getTotalArmor() != entity.getTotalOArmor()) ? &quot;/&quot; + entity.getTotalOArmor() : &quot;&quot;),</b>
<b class="nc">&nbsp;                entity.getTotalInternal() + ((entity.getTotalInternal() != entity.getTotalOInternal())</b>
<b class="nc">&nbsp;                        ? &quot;/&quot; + entity.getTotalOInternal() : &quot;&quot;));</b>
&nbsp;
&nbsp;        // Weapon List
<b class="nc">&nbsp;        if (GUIPreferences.getInstance().getBoolean(GUIPreferences.SHOW_WPS_IN_TT)) {</b>
&nbsp;
<b class="nc">&nbsp;            ArrayList&lt;Mounted&gt; weapons = entity.getWeaponList();</b>
<b class="nc">&nbsp;            HashMap&lt;String, Integer&gt; wpNames = new HashMap&lt;String, Integer&gt;();</b>
&nbsp;
&nbsp;            // Gather names, counts, Clan/IS
&nbsp;            // When clan then the number will be stored as negative
<b class="nc">&nbsp;            for (Mounted curWp : weapons) {</b>
<b class="nc">&nbsp;                String weapDesc = curWp.getDesc();</b>
&nbsp;                // Append ranges
<b class="nc">&nbsp;                WeaponType wtype = (WeaponType) curWp.getType();</b>
&nbsp;                int ranges[];
<b class="nc">&nbsp;                if (entity.isAero()) {</b>
<b class="nc">&nbsp;                    ranges = wtype.getATRanges();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    ranges = wtype.getRanges(curWp);</b>
&nbsp;                }
<b class="nc">&nbsp;                String rangeString = &quot;(&quot;;</b>
<b class="nc">&nbsp;                if ((ranges[RangeType.RANGE_MINIMUM] != WeaponType.WEAPON_NA)</b>
&nbsp;                        &amp;&amp; (ranges[RangeType.RANGE_MINIMUM] != 0)) {
<b class="nc">&nbsp;                    rangeString += ranges[RangeType.RANGE_MINIMUM] + &quot;/&quot;;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    rangeString += &quot;-/&quot;;</b>
&nbsp;                }
<b class="nc">&nbsp;                int maxRange = RangeType.RANGE_LONG;</b>
&nbsp;
<b class="nc">&nbsp;                if ((entity.getGame() != null)</b>
<b class="nc">&nbsp;                        &amp;&amp; entity.getGame().getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_RANGE)) {</b>
<b class="nc">&nbsp;                    maxRange = RangeType.RANGE_EXTREME;</b>
&nbsp;                }
<b class="nc">&nbsp;                for (int i = RangeType.RANGE_SHORT; i &lt;= maxRange; i++) {</b>
<b class="nc">&nbsp;                    rangeString += ranges[i];</b>
<b class="nc">&nbsp;                    if (i != maxRange) {</b>
<b class="nc">&nbsp;                        rangeString += &quot;/&quot;;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                weapDesc += rangeString + &quot;)&quot;;</b>
<b class="nc">&nbsp;                if (wpNames.containsKey(weapDesc)) {</b>
<b class="nc">&nbsp;                    int number = wpNames.get(weapDesc);</b>
<b class="nc">&nbsp;                    if (number &gt; 0)</b>
<b class="nc">&nbsp;                        wpNames.put(weapDesc, number + 1);</b>
&nbsp;                    else
<b class="nc">&nbsp;                        wpNames.put(weapDesc, number - 1);</b>
<b class="nc">&nbsp;                } else {</b>
<b class="nc">&nbsp;                    WeaponType wpT = ((WeaponType) curWp.getType());</b>
&nbsp;
<b class="nc">&nbsp;                    if (entity.isClan() &amp;&amp; TechConstants.isClan(wpT.getTechLevel(entity.getYear())))</b>
<b class="nc">&nbsp;                        wpNames.put(weapDesc, -1);</b>
&nbsp;                    else
<b class="nc">&nbsp;                        wpNames.put(weapDesc, 1);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            // Print to Tooltip
<b class="nc">&nbsp;            tooltipString.append(&quot;&lt;FONT SIZE=\&quot;-2\&quot;&gt;&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            for (Entry&lt;String, Integer&gt; entry : wpNames.entrySet()) {</b>
&nbsp;                // Check if weapon is destroyed, text gray and strikethrough if
&nbsp;                // so, remove the &quot;x &quot;/&quot;*&quot;
&nbsp;                // Also remove &quot;+&quot;, means currently selected for firing
<b class="nc">&nbsp;                boolean wpDest = false;</b>
<b class="nc">&nbsp;                String nameStr = entry.getKey();</b>
<b class="nc">&nbsp;                if (entry.getKey().startsWith(&quot;x &quot;)) {</b>
<b class="nc">&nbsp;                    nameStr = entry.getKey().substring(2, entry.getKey().length());</b>
<b class="nc">&nbsp;                    wpDest = true;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (entry.getKey().startsWith(&quot;*&quot;)) {</b>
<b class="nc">&nbsp;                    nameStr = entry.getKey().substring(1, entry.getKey().length());</b>
<b class="nc">&nbsp;                    wpDest = true;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (entry.getKey().startsWith(&quot;+&quot;)) {</b>
<b class="nc">&nbsp;                    nameStr = entry.getKey().substring(1, entry.getKey().length());</b>
<b class="nc">&nbsp;                    nameStr = nameStr.concat(&quot; &lt;I&gt;(Firing)&lt;/I&gt;&quot;);</b>
&nbsp;                }
&nbsp;
&nbsp;                // normal coloring
<b class="nc">&nbsp;                tooltipString.append(&quot;&lt;FONT COLOR=#8080FF&gt;&quot;);</b>
&nbsp;                // but: color gray and strikethrough when weapon destroyed
<b class="nc">&nbsp;                if (wpDest)</b>
<b class="nc">&nbsp;                    tooltipString.append(&quot;&lt;FONT COLOR=#a0a0a0&gt;&lt;S&gt;&quot;);</b>
&nbsp;
<b class="nc">&nbsp;                String clanStr = &quot;&quot;;</b>
<b class="nc">&nbsp;                if (entry.getValue() &lt; 0)</b>
<b class="nc">&nbsp;                    clanStr = Messages.getString(&quot;BoardView1.Tooltip.Clan&quot;);</b>
&nbsp;
&nbsp;                // when more than 5 weapons are present, they will be grouped
&nbsp;                // and listed with a multiplier
<b class="nc">&nbsp;                if (weapons.size() &gt; 5) {</b>
<b class="nc">&nbsp;                    addToTT(&quot;WeaponN&quot;, BR, Math.abs(entry.getValue()), clanStr, nameStr);</b>
&nbsp;
&nbsp;                } else { // few weapons: list each weapon separately
<b class="nc">&nbsp;                    for (int i = 0; i &lt; Math.abs(entry.getValue()); i++) {</b>
<b class="nc">&nbsp;                        addToTT(&quot;Weapon&quot;, BR, Math.abs(entry.getValue()), clanStr, nameStr);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                // Weapon destroyed? End strikethrough
<b class="nc">&nbsp;                if (wpDest)</b>
<b class="nc">&nbsp;                    tooltipString.append(&quot;&lt;/S&gt;&quot;);</b>
<b class="nc">&nbsp;                tooltipString.append(&quot;&lt;/FONT&gt;&quot;);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            tooltipString.append(&quot;&lt;/FONT&gt;&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Add StratOps quirks, if activated
<b class="nc">&nbsp;        if ((entity.getGame() != null)</b>
<b class="nc">&nbsp;                &amp;&amp; entity.getGame().getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</b>
<b class="nc">&nbsp;            for (Enumeration&lt;IOptionGroup&gt; advGroups = entity.getQuirks().getGroups(); advGroups.hasMoreElements();) {</b>
<b class="nc">&nbsp;                IOptionGroup advGroup = advGroups.nextElement();</b>
<b class="nc">&nbsp;                if (entity.countQuirks(advGroup.getKey()) &gt; 0) {</b>
<b class="nc">&nbsp;                    tooltipString.append(&quot;&lt;BR&gt;&lt;i&gt;&quot; + advGroup.getDisplayableName() + &quot;:&lt;/i&gt;&quot;);</b>
<b class="nc">&nbsp;                    for (Enumeration&lt;IOption&gt; advs = advGroup.getOptions(); advs.hasMoreElements();) {</b>
<b class="nc">&nbsp;                        IOption adv = advs.nextElement();</b>
<b class="nc">&nbsp;                        if (adv.booleanValue()) {</b>
<b class="nc">&nbsp;                            tooltipString.append(&quot;&lt;BR&gt;&amp;nbsp;&quot; + adv.getDisplayableNameWithValue());</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            for (Mounted weapon : entity.getWeaponList()) {</b>
<b class="nc">&nbsp;                for (Enumeration&lt;IOptionGroup&gt; advGroups = weapon.getQuirks().getGroups(); advGroups</b>
<b class="nc">&nbsp;                        .hasMoreElements();) {</b>
<b class="nc">&nbsp;                    IOptionGroup advGroup = advGroups.nextElement();</b>
<b class="nc">&nbsp;                    if (weapon.countQuirks() &gt; 0) {</b>
<b class="nc">&nbsp;                        tooltipString.append(&quot;&lt;BR&gt;&lt;i&gt;&quot; + weapon.getDesc() + &quot;:&lt;/i&gt;&quot;);</b>
<b class="nc">&nbsp;                        for (Enumeration&lt;IOption&gt; advs = advGroup.getOptions(); advs.hasMoreElements();) {</b>
<b class="nc">&nbsp;                            IOption adv = advs.nextElement();</b>
<b class="nc">&nbsp;                            if (adv.booleanValue()) {</b>
<b class="nc">&nbsp;                                tooltipString.append(&quot;&lt;BR&gt;&amp;nbsp;&quot; + adv.getDisplayableNameWithValue());</b>
&nbsp;                            }
<b class="nc">&nbsp;                        }</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
&nbsp;        // Add partial repairs, if activated
<b class="nc">&nbsp;        for (Enumeration&lt;IOptionGroup&gt; advGroups = entity.getPartialRepairs().getGroups(); advGroups</b>
<b class="nc">&nbsp;                .hasMoreElements();) {</b>
<b class="nc">&nbsp;            IOptionGroup advGroup = advGroups.nextElement();</b>
<b class="nc">&nbsp;            if (entity.countPartialRepairs() &gt; 0) {</b>
<b class="nc">&nbsp;                tooltipString.append(&quot;&lt;BR&gt;&lt;i&gt;&quot; + advGroup.getDisplayableName() + &quot;:&lt;/i&gt;&lt;br&gt;&quot;);</b>
<b class="nc">&nbsp;                for (Enumeration&lt;IOption&gt; advs = advGroup.getOptions(); advs.hasMoreElements();) {</b>
<b class="nc">&nbsp;                    IOption adv = advs.nextElement();</b>
<b class="nc">&nbsp;                    if (adv.booleanValue()) {</b>
<b class="nc">&nbsp;                        tooltipString.append(&quot;&amp;nbsp;&quot; + adv.getDisplayableNameWithValue() + &quot;&lt;br&gt;&quot;);</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        tooltipString.append(&quot;&lt;/html&gt;&quot;);</b>
<b class="nc">&nbsp;        return tooltipString.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String formatUnitCompact(Entity entity, boolean blindDrop) {
&nbsp;
<b class="nc">&nbsp;        String value = &quot;&quot;;</b>
&nbsp;        // Reset the tree strings.
<b class="nc">&nbsp;        String strTreeSet = &quot;&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;        String strTreeView = &quot;&quot;; //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;        if (blindDrop) {</b>
<b class="nc">&nbsp;            if (entity instanceof Infantry) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.0&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (entity instanceof Protomech) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.1&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (entity instanceof GunEmplacement) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.2&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                value += entity.getWeightClassName();</b>
<b class="nc">&nbsp;                if (entity instanceof Tank) {</b>
<b class="nc">&nbsp;                    value += Messages.getString(&quot;ChatLounge.6&quot;); //$NON-NLS-1$</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return value;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Set the tree strings based on C3 settings for the unit.
<b class="nc">&nbsp;        if (entity.hasC3i() || entity.hasNavalC3()) {</b>
<b class="nc">&nbsp;            if (entity.calculateFreeC3Nodes() == 5) {</b>
<b class="nc">&nbsp;                strTreeSet = &quot;**&quot;; //$NON-NLS-1$</b>
&nbsp;            }
<b class="nc">&nbsp;            strTreeView = &quot; (&quot; + entity.getC3NetId() + &quot;)&quot;; //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        } else if (entity.hasC3()) {</b>
<b class="nc">&nbsp;            if (entity.getC3Master() == null) {</b>
<b class="nc">&nbsp;                if (entity.hasC3S()) {</b>
<b class="nc">&nbsp;                    strTreeSet = &quot;***&quot;; //$NON-NLS-1$</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    strTreeSet = &quot;*&quot;; //$NON-NLS-1$</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (!entity.C3MasterIs(entity)) {</b>
<b class="nc">&nbsp;                strTreeSet = &quot;&gt;&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                if ((entity.getC3Master().getC3Master() != null)</b>
<b class="nc">&nbsp;                        &amp;&amp; !entity.getC3Master().C3MasterIs(entity.getC3Master())) {</b>
<b class="nc">&nbsp;                    strTreeSet = &quot;&gt;&gt;&quot;; //$NON-NLS-1$</b>
&nbsp;                }
<b class="nc">&nbsp;                strTreeView = &quot; -&gt; &quot; + entity.getC3Master().getDisplayName(); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        value += strTreeSet + entity.getShortName() + strTreeView;</b>
&nbsp;
<b class="nc">&nbsp;        if (entity.getTransportId() != Entity.NONE) {</b>
<b class="nc">&nbsp;            Entity loader = entity.getGame().getEntity(entity.getTransportId());</b>
<b class="nc">&nbsp;            value += &quot;, aboard &quot; + loader.getShortName() + &quot;&quot;;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (entity.isHidden()) {</b>
<b class="nc">&nbsp;            value += &quot; (&quot; + Messages.getString(&quot;ChatLounge.hidden&quot;) + &quot;)&quot;; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (entity.isOffBoard()) {</b>
<b class="nc">&nbsp;            value += &quot; (&quot; + Messages.getString(&quot;ChatLounge.deploysOffBoard&quot;) + &quot;)&quot;; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$</b>
<b class="nc">&nbsp;        } else if (entity.getDeployRound() &gt; 0) {</b>
<b class="nc">&nbsp;            value += &quot; (&quot; + Messages.getString(&quot;ChatLounge.deploysAfterRound&quot;) //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                    + entity.getDeployRound();</b>
<b class="nc">&nbsp;            if (entity.getStartingPos(false) != Board.START_NONE) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.deploysAfterZone&quot;) //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        + IStartingPositions.START_LOCATION_NAMES[entity.getStartingPos(false)];</b>
&nbsp;            }
&nbsp;            // $NON-NLS-2$
<b class="nc">&nbsp;            value += &quot;)&quot;; //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        return value;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String formatUnitHTML(Entity entity, boolean blindDrop) {
&nbsp;
<b class="nc">&nbsp;        String value = &quot;&quot;;</b>
&nbsp;
<b class="nc">&nbsp;        if (blindDrop) {</b>
<b class="nc">&nbsp;            if (entity instanceof Infantry) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.0&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (entity instanceof Protomech) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.1&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (entity instanceof GunEmplacement) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.2&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                value += entity.getWeightClassName();</b>
<b class="nc">&nbsp;                if (entity instanceof Tank) {</b>
<b class="nc">&nbsp;                    value += Messages.getString(&quot;ChatLounge.6&quot;); //$NON-NLS-1$</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            value += &quot;&lt;br&gt;&quot;;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            String c3network = &quot;&quot;;</b>
<b class="nc">&nbsp;            if (entity.hasC3i()) {</b>
<b class="nc">&nbsp;                if (entity.calculateFreeC3Nodes() &gt;= 5) {</b>
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.C3iNone&quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.C3iNetwork&quot;) + entity.getC3NetId();</b>
<b class="nc">&nbsp;                    if (entity.calculateFreeC3Nodes() &gt; 0) {</b>
<b class="nc">&nbsp;                        c3network += Messages.getString(&quot;ChatLounge.C3iNodes&quot;,</b>
<b class="nc">&nbsp;                                new Object[] { entity.calculateFreeC3Nodes() });</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            } else if (entity.hasNavalC3()) {</b>
<b class="nc">&nbsp;                if (entity.calculateFreeC3Nodes() &gt;= 5) {</b>
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.NC3None&quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.NC3Network&quot;) + entity.getC3NetId();</b>
<b class="nc">&nbsp;                    if (entity.calculateFreeC3Nodes() &gt; 0) {</b>
<b class="nc">&nbsp;                        c3network += Messages.getString(&quot;ChatLounge.NC3Nodes&quot;,</b>
<b class="nc">&nbsp;                                new Object[] { entity.calculateFreeC3Nodes() });</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            } else if (entity.hasC3()) {</b>
<b class="nc">&nbsp;                if (entity.C3MasterIs(entity)) {</b>
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.C3Master&quot;);</b>
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.C3MNodes&quot;,</b>
<b class="nc">&nbsp;                            new Object[] { entity.calculateFreeC3MNodes() });</b>
<b class="nc">&nbsp;                    if (entity.hasC3MM()) {</b>
<b class="nc">&nbsp;                        c3network += Messages.getString(&quot;ChatLounge.C3SNodes&quot;,</b>
<b class="nc">&nbsp;                                new Object[] { entity.calculateFreeC3Nodes() });</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else if (!entity.hasC3S()) {</b>
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.C3Master&quot;);</b>
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.C3SNodes&quot;,</b>
<b class="nc">&nbsp;                            new Object[] { entity.calculateFreeC3Nodes() });</b>
&nbsp;                    // an independent master might also be a slave to a company
&nbsp;                    // master
<b class="nc">&nbsp;                    if (entity.getC3Master() != null) {</b>
<b class="nc">&nbsp;                        c3network += &quot;&lt;br&gt;&quot; + Messages.getString(&quot;ChatLounge.C3Slave&quot;)</b>
<b class="nc">&nbsp;                                + entity.getC3Master().getDisplayName();</b>
&nbsp;                        // $NON-NLS-1$
&nbsp;                    }
<b class="nc">&nbsp;                } else if (entity.getC3Master() != null) {</b>
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.C3Slave&quot;) + entity.getC3Master().getDisplayName();</b>
&nbsp;                    // $NON-NLS-1$
&nbsp;                } else {
<b class="nc">&nbsp;                    c3network += Messages.getString(&quot;ChatLounge.C3None&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            int posQuirkCount = entity.countQuirks(Quirks.POS_QUIRKS);</b>
<b class="nc">&nbsp;            int negQuirkCount = entity.countQuirks(Quirks.NEG_QUIRKS);</b>
<b class="nc">&nbsp;            int partRepCount = entity.countPartialRepairs();</b>
&nbsp;
<b class="nc">&nbsp;            value += &quot;&lt;b&gt;&quot; + entity.getShortName() + &quot;&lt;/b&gt;&lt;br&gt;&quot;;</b>
<b class="nc">&nbsp;            value += &quot;&quot; + Math.round(entity.getWeight()) + Messages.getString(&quot;ChatLounge.Tons&quot;) + &quot;&lt;br&gt;&quot;;</b>
<b class="nc">&nbsp;            if (entity.getTransportId() != Entity.NONE) {</b>
<b class="nc">&nbsp;                Entity loader = entity.getGame().getEntity(entity.getTransportId());</b>
<b class="nc">&nbsp;                value += &quot;&lt;i&gt;Carried by &quot; + loader.getShortName() + &quot;&lt;/i&gt;&lt;br&gt;&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (c3network.length() &gt; 0) {</b>
<b class="nc">&nbsp;                value += c3network + &quot;&lt;br&gt;&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            if ((posQuirkCount &gt; 0) | (negQuirkCount &gt; 0)) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.Quirks&quot;) + &quot;+&quot; + posQuirkCount + &quot;/&quot; + &quot;-&quot; + negQuirkCount</b>
&nbsp;                        + &quot;&lt;br&gt;&quot;;
&nbsp;            }
<b class="nc">&nbsp;            if ((partRepCount &gt; 0)) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.PartialRepairs&quot;) + &quot; + &quot; + partRepCount + &quot;&lt;br&gt;&quot;;</b>
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (entity.isHidden()) {</b>
<b class="nc">&nbsp;            value += Messages.getString(&quot;ChatLounge.hidden&quot;) + &quot;&lt;br&gt;&quot;; // ; //$NON-NLS-1$</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (entity.isOffBoard()) {</b>
<b class="nc">&nbsp;            value += Messages.getString(&quot;ChatLounge.deploysOffBoard&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        } else if (entity.getDeployRound() &gt; 0) {</b>
<b class="nc">&nbsp;            value += Messages.getString(&quot;ChatLounge.deploysAfterRound&quot;) + entity.getDeployRound(); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            if (entity.getStartingPos(false) != Board.START_NONE) {</b>
<b class="nc">&nbsp;                value += Messages.getString(&quot;ChatLounge.deploysAfterZone&quot;) //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        + IStartingPositions.START_LOCATION_NAMES[entity.getStartingPos(false)];</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (!entity.isDesignValid()) {</b>
<b class="nc">&nbsp;            value += Messages.getString(&quot;ChatLounge.invalidDesign&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return value;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This function is now deprecated and has been replaced by formatUnitHTML,
&nbsp;     * formatPilotHTML, formatUnitTooltip, and formatPilotTooltip. It is however
&nbsp;     * used by other programs so it remains.
&nbsp;     */
&nbsp;    public static String formatUnit(Entity entity, boolean blindDrop, boolean rpgSkills) {
&nbsp;        String value;
&nbsp;
&nbsp;        // Reset the tree strings.
<b class="nc">&nbsp;        String strTreeSet = &quot;&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;        String strTreeView = &quot;&quot;; //$NON-NLS-1$</b>
&nbsp;
&nbsp;        // Set the tree strings based on C3 settings for the unit.
<b class="nc">&nbsp;        if (entity.hasC3i() || entity.hasNavalC3()) {</b>
<b class="nc">&nbsp;            if (entity.calculateFreeC3Nodes() == 5) {</b>
<b class="nc">&nbsp;                strTreeSet = &quot;**&quot;; //$NON-NLS-1$</b>
&nbsp;            }
<b class="nc">&nbsp;            strTreeView = &quot; (&quot; + entity.getC3NetId() + &quot;)&quot;; //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;        } else if (entity.hasC3()) {</b>
<b class="nc">&nbsp;            if (entity.getC3Master() == null) {</b>
<b class="nc">&nbsp;                if (entity.hasC3S()) {</b>
<b class="nc">&nbsp;                    strTreeSet = &quot;***&quot;; //$NON-NLS-1$</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    strTreeSet = &quot;*&quot;; //$NON-NLS-1$</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (!entity.C3MasterIs(entity)) {</b>
<b class="nc">&nbsp;                strTreeSet = &quot;&gt;&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                if ((entity.getC3Master().getC3Master() != null)</b>
<b class="nc">&nbsp;                        &amp;&amp; !entity.getC3Master().C3MasterIs(entity.getC3Master())) {</b>
<b class="nc">&nbsp;                    strTreeSet = &quot;&gt;&gt;&quot;; //$NON-NLS-1$</b>
&nbsp;                }
<b class="nc">&nbsp;                strTreeView = &quot; -&gt; &quot; + entity.getC3Master().getDisplayName(); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int crewAdvCount = entity.getCrew().countOptions(PilotOptions.LVL3_ADVANTAGES);</b>
<b class="nc">&nbsp;        boolean isManeiDomini = entity.getCrew().countOptions(PilotOptions.MD_ADVANTAGES) &gt; 0;</b>
<b class="nc">&nbsp;        int posQuirkCount = entity.countQuirks(Quirks.POS_QUIRKS);</b>
<b class="nc">&nbsp;        int negQuirkCount = entity.countQuirks(Quirks.NEG_QUIRKS);</b>
&nbsp;
<b class="nc">&nbsp;        String gunnery = entity.getCrew().getSkillsAsString(false, rpgSkills);</b>
&nbsp;
<b class="nc">&nbsp;        if (blindDrop) {</b>
&nbsp;            String unitClass;
<b class="nc">&nbsp;            if (entity instanceof Infantry) {</b>
<b class="nc">&nbsp;                unitClass = Messages.getString(&quot;ChatLounge.0&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (entity instanceof Protomech) {</b>
<b class="nc">&nbsp;                unitClass = Messages.getString(&quot;ChatLounge.1&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            } else if (entity instanceof GunEmplacement) {</b>
<b class="nc">&nbsp;                unitClass = Messages.getString(&quot;ChatLounge.2&quot;); //$NON-NLS-1$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                unitClass = entity.getWeightClassName();</b>
<b class="nc">&nbsp;                if (entity instanceof Tank) {</b>
<b class="nc">&nbsp;                    unitClass += Messages.getString(&quot;ChatLounge.6&quot;); //$NON-NLS-1$</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            Integer piloting = entity.getCrew().getPiloting();</b>
<b class="nc">&nbsp;            String advantages = (crewAdvCount &gt; 0 ? &quot; &lt;&quot; + crewAdvCount //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    + Messages.getString(&quot;ChatLounge.advs&quot;) : &quot;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String maneiDomini = (isManeiDomini ? Messages.getString(&quot;ChatLounge.md&quot;) : &quot;&quot;); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;            String posQuirks = (posQuirkCount &gt; 0 ? &quot; &lt;&quot; + posQuirkCount //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    + Messages.getString(&quot;ChatLounge.pquirk&quot;) : &quot;&quot;); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;            String negQuirks = (negQuirkCount &gt; 0 ? &quot; &lt;&quot; + negQuirkCount //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    + Messages.getString(&quot;ChatLounge.nquirk&quot;) : &quot;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String hidden = ((entity.isHidden()) ? Messages.getString(&quot;ChatLounge.hidden&quot;) : &quot;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String offBoard = ((entity.isOffBoard()) ? Messages.getString(&quot;ChatLounge.deploysOffBoard&quot;) : &quot;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String deployRound = ((entity.getDeployRound() &gt; 0) ? Messages.getString(&quot;ChatLounge.deploysAfterRound&quot;) //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    + entity.getDeployRound() : &quot;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            value = Messages.getString(&quot;ChatLounge.EntityListEntry1&quot;, //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    new Object[] { entity.getOwner().getName(), gunnery, piloting, advantages, maneiDomini, unitClass,</b>
&nbsp;                            posQuirks, negQuirks, offBoard, deployRound, hidden });
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            Integer piloting = entity.getCrew().getPiloting();</b>
<b class="nc">&nbsp;            String advantages = (crewAdvCount &gt; 0 ? &quot; &lt;&quot; + crewAdvCount //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    + Messages.getString(&quot;ChatLounge.advs&quot;) : &quot;&quot;); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;            String maneiDomini = (isManeiDomini ? Messages.getString(&quot;ChatLounge.md&quot;) : &quot;&quot;); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;            String posQuirks = (posQuirkCount &gt; 0 ? &quot; &lt;&quot; + posQuirkCount //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    + Messages.getString(&quot;ChatLounge.pquirk&quot;) : &quot;&quot;); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;            String negQuirks = (negQuirkCount &gt; 0 ? &quot; &lt;&quot; + negQuirkCount //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    + Messages.getString(&quot;ChatLounge.nquirk&quot;) : &quot;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            Integer battleValue = entity.calculateBattleValue();</b>
<b class="nc">&nbsp;            String hidden = ((entity.isHidden()) ? Messages.getString(&quot;ChatLounge.hidden&quot;) : &quot;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String offBoard = ((entity.isOffBoard()) ? Messages.getString(&quot;ChatLounge.deploysOffBoard&quot;) : &quot;&quot;); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;            String deployRound = ((entity.getDeployRound() &gt; 0) ? Messages.getString(&quot;ChatLounge.deploysAfterRound&quot;) //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    + entity.getDeployRound() : &quot;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String valid = (entity.isDesignValid() ? &quot;&quot; : Messages //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    .getString(&quot;ChatLounge.invalidDesign&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            value = strTreeSet</b>
<b class="nc">&nbsp;                    + Messages.getString(&quot;ChatLounge.EntityListEntry2&quot;, //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    new Object[] { entity.getDisplayName(), gunnery, piloting, advantages, maneiDomini,</b>
&nbsp;                            posQuirks, negQuirks, battleValue, strTreeView, offBoard, deployRound, hidden,
&nbsp;                            valid });
&nbsp;        }
<b class="nc">&nbsp;        return value;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Refreshes the player info
&nbsp;     */
&nbsp;    private void refreshPlayerInfo() {
<b class="nc">&nbsp;        playerModel.clearData();</b>
<b class="nc">&nbsp;        for (Enumeration&lt;IPlayer&gt; i = clientgui.getClient().getPlayers(); i.hasMoreElements();) {</b>
<b class="nc">&nbsp;            final IPlayer player = i.nextElement();</b>
<b class="nc">&nbsp;            if (player == null) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            playerModel.addPlayer(player);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshCamos() {
<b class="nc">&nbsp;        butCamo.setIcon(getPlayerSelected().getLocalPlayer().getCamouflage().getImageIcon());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Setup the team choice box
&nbsp;     */
&nbsp;    private void setupTeams() {
<b class="nc">&nbsp;        choTeam.removeAllItems();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; IPlayer.MAX_TEAMS; i++) {</b>
<b class="nc">&nbsp;            choTeam.addItem(IPlayer.teamNames[i]);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (clientgui.getClient().getLocalPlayer() != null) {</b>
<b class="nc">&nbsp;            choTeam.setSelectedIndex(clientgui.getClient().getLocalPlayer().getTeam());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            choTeam.setSelectedIndex(0);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Highlight the team the player is playing on.
&nbsp;     */
&nbsp;    private void refreshTeams() {
<b class="nc">&nbsp;        choTeam.setSelectedIndex(clientgui.getClient().getLocalPlayer().getTeam());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Refreshes the done button. The label will say the opposite of the
&nbsp;     * player&#39;s &quot;done&quot; status, indicating that clicking it will reverse the
&nbsp;     * condition.
&nbsp;     */
&nbsp;    private void refreshDoneButton(boolean done) {
<b class="nc">&nbsp;        butDone.setText(done ? Messages.getString(&quot;ChatLounge.notDone&quot;) : Messages.getString(&quot;ChatLounge.imDone&quot;));</b>
&nbsp;        // $NON-NLS-1$ //$NON-NLS-2$
&nbsp;    }
&nbsp;
&nbsp;    private void refreshDoneButton() {
<b class="nc">&nbsp;        refreshDoneButton(clientgui.getClient().getLocalPlayer().isDone());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Change local player team.
&nbsp;     */
&nbsp;    private void changeTeam(int team) {
<b class="nc">&nbsp;        Client c = getPlayerSelected();</b>
<b class="nc">&nbsp;        if ((c != null) &amp;&amp; (c.getLocalPlayer().getTeam() != team)) {</b>
<b class="nc">&nbsp;            c.getLocalPlayer().setTeam(team);</b>
<b class="nc">&nbsp;            c.sendPlayerInfo();</b>
&nbsp;
&nbsp;            // WIP on getting entities to be able to be loaded by teammates
<b class="nc">&nbsp;            for (Entity unit : c.getGame().getPlayerEntities(c.getLocalPlayer(), false)) {</b>
&nbsp;                // If unit has empty bays it needs to be updated in order for
&nbsp;                // other entities to be able to load into it.
<b class="nc">&nbsp;                if ((unit.getTransports().size() &gt; 0) &amp;&amp; (unit.getLoadedUnits().isEmpty())</b>
<b class="nc">&nbsp;                        &amp;&amp; (unit.getTransportId() == Entity.NONE)) {</b>
<b class="nc">&nbsp;                    c.sendUpdateEntity(unit);</b>
&nbsp;                }
&nbsp;
&nbsp;                // Unload this unit if its being transported.
<b class="nc">&nbsp;                if (unit.getTransportId() != Entity.NONE) {</b>
<b class="nc">&nbsp;                    unloader(unit);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            // Loop through everyone elses entities and if they no longer have a
&nbsp;            // legal loading, remove them.
&nbsp;            // I am aware this is an odd way to do it, however I couldn&#39;t get it
&nbsp;            // to work by looping through the
&nbsp;            // unit.getLoadedUnits() - it always returned with an empty list
&nbsp;            // even when there was loaded units.
<b class="nc">&nbsp;            for (Entity unit : c.getGame().getEntitiesVector()) {</b>
<b class="nc">&nbsp;                if (unit.getOwner().equals(c.getLocalPlayer())) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if ((unit.getTransportId() != Entity.NONE) &amp;&amp; (c.getGame().getEntity(unit.getTransportId()).getOwner()</b>
<b class="nc">&nbsp;                        .getTeam() != unit.getOwner().getTeam())) {</b>
<b class="nc">&nbsp;                    unloader(unit);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Pop up the customize mech dialog
&nbsp;     */
&nbsp;
&nbsp;    private void customizeMech() {
<b class="nc">&nbsp;        if (tableEntities.getSelectedRow() == -1) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        customizeMech(mekModel.getEntityAt(tableEntities.getSelectedRow()));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Load one unit into another in the chat lounge
&nbsp;     *
&nbsp;     * @param loadee
&nbsp;     *            - an Entity that should be loaded
&nbsp;     * @param loaderId
&nbsp;     *            - the id of the entity that will load
&nbsp;     */
&nbsp;    private void loader(Entity loadee, int loaderId, int bayNumber) {
<b class="nc">&nbsp;        Client c = clientgui.getBots().get(loadee.getOwner().getName());</b>
<b class="nc">&nbsp;        if (c == null) {</b>
<b class="nc">&nbsp;            c = clientgui.getClient();</b>
&nbsp;        }
<b class="nc">&nbsp;        Entity loader = clientgui.getClient().getGame().getEntity(loaderId);</b>
<b class="nc">&nbsp;        if (loader == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // We need to make sure our current bomb choices fit onto the new
&nbsp;        // fighter
<b class="nc">&nbsp;        if (loader instanceof FighterSquadron) {</b>
<b class="nc">&nbsp;            FighterSquadron fSquad = (FighterSquadron) loader;</b>
&nbsp;            // We can&#39;t use Aero.getBombPoints() because the bombs haven&#39;t been
&nbsp;            // loaded yet, only selected, so we have to count the choices
<b class="nc">&nbsp;            int[] bombChoice = fSquad.getBombChoices();</b>
<b class="nc">&nbsp;            int numLoadedBombs = 0;</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; bombChoice.length; i++) {</b>
<b class="nc">&nbsp;                numLoadedBombs += bombChoice[i];</b>
&nbsp;            }
&nbsp;            // We can&#39;t load all of the squadrons bombs
<b class="nc">&nbsp;            if (numLoadedBombs &gt; ((IBomber)loadee).getMaxBombPoints()) {</b>
<b class="nc">&nbsp;                JOptionPane.showMessageDialog(clientgui.frame, Messages.getString(&quot;FighterSquadron.bomberror&quot;),</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;FighterSquadron.error&quot;), JOptionPane.ERROR_MESSAGE);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        c.sendLoadEntity(loadee.getId(), loaderId, bayNumber);</b>
&nbsp;        // TODO: it would probably be a good idea to reset deployment
&nbsp;        // info to equal that of the loader, and disable it in customMechDialog
&nbsp;        // I tried doing this but I cant quite figure out the client/server
&nbsp;        // interaction in CustomMechDialog.java
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Unload a unit in the chat lounge
&nbsp;     *
&nbsp;     * @param unloadee
&nbsp;     *            - the Entity to be unloaded
&nbsp;     */
&nbsp;    private void unloader(Entity unloadee) {
<b class="nc">&nbsp;        Client c = clientgui.getBots().get(unloadee.getOwner().getName());</b>
<b class="nc">&nbsp;        if (c == null) {</b>
<b class="nc">&nbsp;            c = clientgui.getClient();</b>
&nbsp;        }
<b class="nc">&nbsp;        Entity unloader = clientgui.getClient().getGame().getEntity(unloadee.getTransportId());</b>
<b class="nc">&nbsp;        if (null == unloader) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        unloader.unload(unloadee);</b>
<b class="nc">&nbsp;        unloadee.setTransportId(Entity.NONE);</b>
<b class="nc">&nbsp;        c.sendUpdateEntity(unloadee);</b>
<b class="nc">&nbsp;        c.sendUpdateEntity(unloader);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * swap pilots from one entity to another
&nbsp;     *
&nbsp;     * @param swapee
&nbsp;     *            - an Entity that should be swapped from
&nbsp;     * @param swapperId
&nbsp;     *            - the id of the entity that should be swapped to
&nbsp;     */
&nbsp;    private void swapPilots(Entity swapee, int swapperId) {
<b class="nc">&nbsp;        Client c = clientgui.getBots().get(swapee.getOwner().getName());</b>
<b class="nc">&nbsp;        if (c == null) {</b>
<b class="nc">&nbsp;            c = clientgui.getClient();</b>
&nbsp;        }
<b class="nc">&nbsp;        Entity swapper = clientgui.getClient().getGame().getEntity(swapperId);</b>
<b class="nc">&nbsp;        if (swapper == null) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        Crew temp = swapper.getCrew();</b>
<b class="nc">&nbsp;        swapper.setCrew(swapee.getCrew());</b>
<b class="nc">&nbsp;        swapee.setCrew(temp);</b>
<b class="nc">&nbsp;        c.sendUpdateEntity(swapee);</b>
<b class="nc">&nbsp;        c.sendUpdateEntity(swapper);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Change the entities controller from one player to another
&nbsp;     *
&nbsp;     * @param e
&nbsp;     *            - an Entity that should that will have its owner changed
&nbsp;     * @param player_id
&nbsp;     *            - the id of the player that should now own the entity
&nbsp;     */
&nbsp;    private void changeEntityOwner(Entity e, int player_id) {
<b class="nc">&nbsp;        Client c = clientgui.getBots().get(e.getOwner().getName());</b>
<b class="nc">&nbsp;        if (c == null) {</b>
<b class="nc">&nbsp;            c = clientgui.getClient();</b>
&nbsp;        }
<b class="nc">&nbsp;        IPlayer new_owner = c.getGame().getPlayer(player_id);</b>
&nbsp;        // We if the unit is switching teams, we need to unload it
<b class="nc">&nbsp;        if (e.getOwner().getTeam() != new_owner.getTeam()) {</b>
<b class="nc">&nbsp;            List&lt;Entity&gt; loadedUnits = e.getLoadedUnits();</b>
<b class="nc">&nbsp;            for (Entity loadee : loadedUnits) {</b>
<b class="nc">&nbsp;                unloader(loadee);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        e.setOwner(new_owner);</b>
<b class="nc">&nbsp;        c.sendUpdateEntity(e);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Delete an entity from the lobby
&nbsp;     *
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void delete(Entity entity) {
<b class="nc">&nbsp;        Client c = clientgui.getBots().get(entity.getOwner().getName());</b>
<b class="nc">&nbsp;        if (c == null) {</b>
<b class="nc">&nbsp;            c = clientgui.getClient();</b>
&nbsp;        }
&nbsp;        // first unload any units from this unit
<b class="nc">&nbsp;        if (entity.getLoadedUnits().size() &gt; 0) {</b>
<b class="nc">&nbsp;            for (Entity loaded : entity.getLoadedUnits()) {</b>
<b class="nc">&nbsp;                entity.unload(loaded);</b>
<b class="nc">&nbsp;                loaded.setTransportId(Entity.NONE);</b>
<b class="nc">&nbsp;                c.sendUpdateEntity(loaded);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            c.sendUpdateEntity(entity);</b>
&nbsp;        }
&nbsp;        // unload this unit from any other units it might be loaded onto
<b class="nc">&nbsp;        if (entity.getTransportId() != Entity.NONE) {</b>
<b class="nc">&nbsp;            Entity loader = clientgui.getClient().getGame().getEntity(entity.getTransportId());</b>
<b class="nc">&nbsp;            if (null != loader) {</b>
<b class="nc">&nbsp;                loader.unload(entity);</b>
<b class="nc">&nbsp;                entity.setTransportId(Entity.NONE);</b>
<b class="nc">&nbsp;                c.sendUpdateEntity(loader);</b>
<b class="nc">&nbsp;                c.sendUpdateEntity(entity);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        c.sendDeleteEntity(entity.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *
&nbsp;     * @param entities
&nbsp;     */
&nbsp;    public void customizeMechs(List&lt;Entity&gt; entities) {
&nbsp;        // Only call this for when selecting a valid list of entities
<b class="nc">&nbsp;        if (entities.size() &lt; 1) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        Set&lt;String&gt; owners = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        String ownerName = &quot;&quot;;</b>
<b class="nc">&nbsp;        int ownerId = -1;</b>
<b class="nc">&nbsp;        for (Entity e : entities) {</b>
<b class="nc">&nbsp;            ownerName = e.getOwner().getName();</b>
<b class="nc">&nbsp;            ownerId = e.getOwner().getId();</b>
<b class="nc">&nbsp;            owners.add(ownerName);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // Error State
<b class="nc">&nbsp;        if (owners.size() &gt; 1) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        boolean editable = clientgui.getBots().get(ownerName) != null;</b>
&nbsp;        Client client;
<b class="nc">&nbsp;        if (editable) {</b>
<b class="nc">&nbsp;            client = clientgui.getBots().get(ownerName);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            editable |= ownerId == clientgui.getClient().getLocalPlayer().getId();</b>
<b class="nc">&nbsp;            client = clientgui.getClient();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        CustomMechDialog cmd = new CustomMechDialog(clientgui, client, entities, editable);</b>
<b class="nc">&nbsp;        cmd.setSize(new Dimension(GUIPreferences.getInstance().getCustomUnitWidth(),</b>
<b class="nc">&nbsp;                GUIPreferences.getInstance().getCustomUnitHeight()));</b>
<b class="nc">&nbsp;        cmd.setTitle(Messages.getString(&quot;ChatLounge.CustomizeUnits&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        cmd.setVisible(true);</b>
<b class="nc">&nbsp;        GUIPreferences.getInstance().setCustomUnitHeight(cmd.getSize().height);</b>
<b class="nc">&nbsp;        GUIPreferences.getInstance().setCustomUnitWidth(cmd.getSize().width);</b>
<b class="nc">&nbsp;        if (editable &amp;&amp; cmd.isOkay()) {</b>
&nbsp;            // send changes
<b class="nc">&nbsp;            for (Entity entity : entities) {</b>
&nbsp;                // If a LAM with mechanized BA was changed to non-mech mode, unload the BA.
<b class="nc">&nbsp;                if ((entity instanceof LandAirMech)</b>
<b class="nc">&nbsp;                        &amp;&amp; entity.getConversionMode() != LandAirMech.CONV_MODE_MECH) {</b>
<b class="nc">&nbsp;                    for (Entity loadee : entity.getLoadedUnits()) {</b>
<b class="nc">&nbsp;                        entity.unload(loadee);</b>
<b class="nc">&nbsp;                        loadee.setTransportId(Entity.NONE);</b>
<b class="nc">&nbsp;                        client.sendUpdateEntity(loadee);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                client.sendUpdateEntity(entity);</b>
&nbsp;
&nbsp;                // Changing state to a transporting unit can update state of
&nbsp;                // transported units, so update those as well
<b class="nc">&nbsp;                for (Transporter transport : entity.getTransports()) {</b>
<b class="nc">&nbsp;                    for (Entity loaded : transport.getLoadedUnits()) {</b>
<b class="nc">&nbsp;                        client.sendUpdateEntity(loaded);</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                }</b>
&nbsp;
&nbsp;                // Customizations to a Squadron can effect the fighters
<b class="nc">&nbsp;                if (entity instanceof FighterSquadron) {</b>
<b class="nc">&nbsp;                    entity.getSubEntities().ifPresent(ents -&gt; ents.forEach(client::sendUpdateEntity));</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        if (cmd.isOkay() &amp;&amp; (cmd.getStatus() != CustomMechDialog.DONE)) {</b>
<b class="nc">&nbsp;            Entity nextEnt = cmd.getNextEntity(cmd.getStatus() == CustomMechDialog.NEXT);</b>
<b class="nc">&nbsp;            customizeMech(nextEnt);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void setCMDSelectedTab(String tab) {
<b class="nc">&nbsp;        cmdSelectedTab = tab;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    public void customizeMech(Entity entity) {
<b class="nc">&nbsp;        boolean editable = clientgui.getBots().get(entity.getOwner().getName()) != null;</b>
&nbsp;        Client c;
<b class="nc">&nbsp;        if (editable) {</b>
<b class="nc">&nbsp;            c = clientgui.getBots().get(entity.getOwner().getName());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            editable |= entity.getOwnerId() == clientgui.getClient().getLocalPlayer().getId();</b>
<b class="nc">&nbsp;            c = clientgui.getClient();</b>
&nbsp;        }
&nbsp;        // When we customize a single entity&#39;s C3 network setting,
&nbsp;        // **ALL** members of the network may get changed.
<b class="nc">&nbsp;        Entity c3master = entity.getC3Master();</b>
<b class="nc">&nbsp;        ArrayList&lt;Entity&gt; c3members = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        Iterator&lt;Entity&gt; playerUnits = c.getGame().getPlayerEntities(c.getLocalPlayer(), false).iterator();</b>
<b class="nc">&nbsp;        while (playerUnits.hasNext()) {</b>
<b class="nc">&nbsp;            Entity unit = playerUnits.next();</b>
<b class="nc">&nbsp;            if (!entity.equals(unit) &amp;&amp; entity.onSameC3NetworkAs(unit)) {</b>
<b class="nc">&nbsp;                c3members.add(unit);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        boolean doneCustomizing = false;</b>
<b class="nc">&nbsp;        while (!doneCustomizing) {</b>
&nbsp;            // display dialog
<b class="nc">&nbsp;            List&lt;Entity&gt; entities = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            entities.add(entity);</b>
<b class="nc">&nbsp;            CustomMechDialog cmd = new CustomMechDialog(clientgui, c, entities, editable);</b>
<b class="nc">&nbsp;            cmd.setSize(new Dimension(GUIPreferences.getInstance().getCustomUnitWidth(),</b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance().getCustomUnitHeight()));</b>
<b class="nc">&nbsp;            cmd.refreshOptions();</b>
<b class="nc">&nbsp;            cmd.refreshQuirks();</b>
<b class="nc">&nbsp;            cmd.refreshPartReps();</b>
<b class="nc">&nbsp;            cmd.setTitle(entity.getShortName());</b>
<b class="nc">&nbsp;            if (cmdSelectedTab != null) {</b>
<b class="nc">&nbsp;                cmd.setSelectedTab(cmdSelectedTab);</b>
&nbsp;            }
<b class="nc">&nbsp;            cmd.setVisible(true);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setCustomUnitHeight(cmd.getSize().height);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setCustomUnitWidth(cmd.getSize().width);</b>
<b class="nc">&nbsp;            cmdSelectedTab = cmd.getSelectedTab();</b>
<b class="nc">&nbsp;            if (editable &amp;&amp; cmd.isOkay()) {</b>
&nbsp;                // If a LAM with mechanized BA was changed to non-mech mode, unload the BA.
<b class="nc">&nbsp;                if ((entity instanceof LandAirMech)</b>
<b class="nc">&nbsp;                        &amp;&amp; entity.getConversionMode() != LandAirMech.CONV_MODE_MECH) {</b>
<b class="nc">&nbsp;                    for (Entity loadee : entity.getLoadedUnits()) {</b>
<b class="nc">&nbsp;                        entity.unload(loadee);</b>
<b class="nc">&nbsp;                        loadee.setTransportId(Entity.NONE);</b>
<b class="nc">&nbsp;                        c.sendUpdateEntity(loadee);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;
&nbsp;                // send changes
<b class="nc">&nbsp;                c.sendUpdateEntity(entity);</b>
&nbsp;
&nbsp;                // Changing state to a transporting unit can update state of
&nbsp;                // transported units, so update those as well
<b class="nc">&nbsp;                for (Transporter transport : entity.getTransports()) {</b>
<b class="nc">&nbsp;                    for (Entity loaded : transport.getLoadedUnits()) {</b>
<b class="nc">&nbsp;                        c.sendUpdateEntity(loaded);</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                }</b>
&nbsp;
&nbsp;                // Customizations to a Squadron can effect the fighters
<b class="nc">&nbsp;                if (entity instanceof FighterSquadron) {</b>
<b class="nc">&nbsp;                    entity.getSubEntities().ifPresent(ents -&gt; ents.forEach(c::sendUpdateEntity));</b>
&nbsp;                }
&nbsp;
&nbsp;                // Do we need to update the members of our C3 network?
<b class="nc">&nbsp;                if (((c3master != null) &amp;&amp; !c3master.equals(entity.getC3Master()))</b>
<b class="nc">&nbsp;                        || ((c3master == null) &amp;&amp; (entity.getC3Master() != null))) {</b>
<b class="nc">&nbsp;                    for (Entity unit : c3members) {</b>
<b class="nc">&nbsp;                        c.sendUpdateEntity(unit);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (cmd.isOkay() &amp;&amp; (cmd.getStatus() != CustomMechDialog.DONE)) {</b>
<b class="nc">&nbsp;                entity = cmd.getNextEntity(cmd.getStatus() == CustomMechDialog.NEXT);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                doneCustomizing = true;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /** 
&nbsp;     * Displays a CamoChooserDialog to choose an individual camo for
&nbsp;     * the given vector of entities. The camo will only be applied
&nbsp;     * to units configurable by the local player, i.e. his own units
&nbsp;     * or those of his bots.
&nbsp;     */
&nbsp;    public void mechCamo(Vector&lt;Entity&gt; entities) {
<b class="nc">&nbsp;        if (entities.size() &lt; 1) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Display the CamoChooserDialog and await the result
&nbsp;        // The dialog is preset to the first selected unit&#39;s settings
<b class="nc">&nbsp;        CamoChooserDialog ccd = new CamoChooserDialog(clientgui.getFrame(),</b>
<b class="nc">&nbsp;                entities.get(0).getOwner().getCamouflage(), entities.get(0).getCamouflage());</b>
&nbsp;
&nbsp;        // If the dialog was canceled or nothing was selected, do nothing
<b class="nc">&nbsp;        if ((ccd.showDialog() == JOptionPane.CANCEL_OPTION) || (ccd.getSelectedItem() == null)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Choosing the player camo resets the units to have no 
&nbsp;        // individual camo.
<b class="nc">&nbsp;        AbstractIcon selectedItem = ccd.getSelectedItem();</b>
<b class="nc">&nbsp;        IPlayer owner = entities.get(0).getOwner();</b>
<b class="nc">&nbsp;        AbstractIcon ownerCamo = owner.getCamouflage();</b>
<b class="nc">&nbsp;        boolean noIndividualCamo = selectedItem.equals(ownerCamo);</b>
&nbsp;        
&nbsp;        // Update all allowed entities with the camo
<b class="nc">&nbsp;        for (Entity ent : entities) {</b>
<b class="nc">&nbsp;            if (isEditable(ent)) {</b>
<b class="nc">&nbsp;                if (noIndividualCamo) {</b>
<b class="nc">&nbsp;                    ent.setCamoCategory(null);</b>
<b class="nc">&nbsp;                    ent.setCamoFileName(null);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    ent.setCamoCategory(selectedItem.getCategory());</b>
<b class="nc">&nbsp;                    ent.setCamoFileName(selectedItem.getFilename());</b>
&nbsp;                }
<b class="nc">&nbsp;                getLocalClient(ent).sendUpdateEntity(ent);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;    
&nbsp;    /** 
&nbsp;     * Returns true when the given entity may be configured
&nbsp;     * by the local player, i.e. if it is his own unit or one
&nbsp;     * of his bot&#39;s units.
&nbsp;     */
&nbsp;    private boolean isEditable(Entity entity) {
<b class="nc">&nbsp;        return clientgui.getBots().containsKey(entity.getOwner().getName())</b>
<b class="nc">&nbsp;                || (entity.getOwnerId() == clientgui.getClient().getLocalPlayer().getId());</b>
&nbsp;    }
&nbsp;    
&nbsp;    /** 
&nbsp;     * Returns the Client associated with a given entity that may be configured
&nbsp;     * by the local player (his own unit or one of his bot&#39;s units).
&nbsp;     */
&nbsp;    private Client getLocalClient(Entity entity) {
<b class="nc">&nbsp;        if (clientgui.getBots().containsKey(entity.getOwner().getName())) {</b>
<b class="nc">&nbsp;            return clientgui.getBots().get(entity.getOwner().getName());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return clientgui.getClient();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void mechEdit(Entity entity) {
<b class="nc">&nbsp;        boolean editable = clientgui.getBots().get(entity.getOwner().getName()) != null;</b>
&nbsp;        Client c;
<b class="nc">&nbsp;        if (editable) {</b>
<b class="nc">&nbsp;            c = clientgui.getBots().get(entity.getOwner().getName());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            editable |= entity.getOwnerId() == clientgui.getClient().getLocalPlayer().getId();</b>
<b class="nc">&nbsp;            c = clientgui.getClient();</b>
&nbsp;        }
&nbsp;
&nbsp;        // display dialog
<b class="nc">&nbsp;        UnitEditorDialog med = new UnitEditorDialog(clientgui.getFrame(), entity);</b>
&nbsp;        // med.setPlayer(c.getLocalPlayer());
<b class="nc">&nbsp;        med.setVisible(true);</b>
<b class="nc">&nbsp;        c.sendUpdateEntity(entity);</b>
&nbsp;        /*
&nbsp;         * if (editable &amp;&amp; med.isSelect()) { // send changes
&nbsp;         * c.sendUpdateEntity(entity); }
&nbsp;         */
&nbsp;    }
&nbsp;
&nbsp;    public void customizePlayer() {
<b class="nc">&nbsp;        Client c = getPlayerSelected();</b>
<b class="nc">&nbsp;        if (null != c) {</b>
<b class="nc">&nbsp;            PlayerSettingsDialog psd = new PlayerSettingsDialog(clientgui, c);</b>
<b class="nc">&nbsp;            psd.setVisible(true);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Pop up the view mech dialog
&nbsp;     */
&nbsp;    private void mechReadout(Entity entity) {
<b class="nc">&nbsp;        final JDialog dialog = new JDialog(clientgui.frame, Messages.getString(&quot;ChatLounge.quickView&quot;), false); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        dialog.addKeyListener(new KeyAdapter() {</b>
&nbsp;            @Override
&nbsp;            public void keyPressed(KeyEvent e) {
<b class="nc">&nbsp;                int code = e.getKeyCode();</b>
<b class="nc">&nbsp;                if (code == KeyEvent.VK_SPACE) {</b>
<b class="nc">&nbsp;                    e.consume();</b>
<b class="nc">&nbsp;                    dialog.setVisible(false);</b>
<b class="nc">&nbsp;                } else if (code == KeyEvent.VK_ENTER) {</b>
<b class="nc">&nbsp;                    e.consume();</b>
<b class="nc">&nbsp;                    dialog.setVisible(false);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;        // FIXME: this isn&#39;t working right, but is necessary for the key
&nbsp;        // listener to work right
&nbsp;        // dialog.setFocusable(true);
<b class="nc">&nbsp;        dialog.addWindowListener(new WindowAdapter() {</b>
&nbsp;            @Override
&nbsp;            public void windowClosing(WindowEvent e) {
<b class="nc">&nbsp;                dialog.setVisible(false);</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        MechViewPanel mvp = new MechViewPanel();</b>
<b class="nc">&nbsp;        mvp.setMech(entity);</b>
<b class="nc">&nbsp;        JButton btn = new JButton(Messages.getString(&quot;Okay&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        btn.addActionListener(e -&gt; dialog.setVisible(false));</b>
&nbsp;
<b class="nc">&nbsp;        dialog.getContentPane().setLayout(new GridBagLayout());</b>
&nbsp;        GridBagConstraints c;
&nbsp;
<b class="nc">&nbsp;        c = new GridBagConstraints();</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 0;</b>
<b class="nc">&nbsp;        c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        c.weightx = 1.0;</b>
<b class="nc">&nbsp;        c.weighty = 1.0;</b>
<b class="nc">&nbsp;        dialog.getContentPane().add(mvp, c);</b>
&nbsp;
<b class="nc">&nbsp;        c = new GridBagConstraints();</b>
<b class="nc">&nbsp;        c.gridx = 0;</b>
<b class="nc">&nbsp;        c.gridy = 1;</b>
<b class="nc">&nbsp;        c.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;        c.anchor = GridBagConstraints.CENTER;</b>
<b class="nc">&nbsp;        c.weightx = 0.0;</b>
<b class="nc">&nbsp;        c.weighty = 0.0;</b>
<b class="nc">&nbsp;        dialog.getContentPane().add(btn, c);</b>
<b class="nc">&nbsp;        dialog.setSize(mvp.getBestWidth(), mvp.getBestHeight() + 75);</b>
<b class="nc">&nbsp;        dialog.validate();</b>
<b class="nc">&nbsp;        dialog.setVisible(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param entity the entity to display the BV Calculation for
&nbsp;     */
&nbsp;    private void mechBVDisplay(Entity entity) {
<b class="nc">&nbsp;        final JDialog dialog = new JDialog(clientgui.frame, &quot;BV Calculation Display&quot;, false);</b>
<b class="nc">&nbsp;        dialog.getContentPane().setLayout(new GridBagLayout());</b>
&nbsp;
<b class="nc">&nbsp;        final int width = 500;</b>
<b class="nc">&nbsp;        final int height = 400;</b>
<b class="nc">&nbsp;        Dimension size = new Dimension(width, height);</b>
&nbsp;
<b class="nc">&nbsp;        JEditorPane tEditorPane = new JEditorPane();</b>
<b class="nc">&nbsp;        tEditorPane.setContentType(&quot;text/html&quot;);</b>
<b class="nc">&nbsp;        tEditorPane.setEditable(false);</b>
<b class="nc">&nbsp;        tEditorPane.setBorder(null);</b>
<b class="nc">&nbsp;        entity.calculateBattleValue();</b>
<b class="nc">&nbsp;        tEditorPane.setText(entity.getBVText());</b>
<b class="nc">&nbsp;        tEditorPane.setCaretPosition(0);</b>
&nbsp;
<b class="nc">&nbsp;        JScrollPane tScroll = new JScrollPane(tEditorPane,</b>
&nbsp;                JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED,
&nbsp;                JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<b class="nc">&nbsp;        tScroll.setBorder(null);</b>
<b class="nc">&nbsp;        tScroll.setPreferredSize(size);</b>
<b class="nc">&nbsp;        tScroll.setMinimumSize(size);</b>
&nbsp;
<b class="nc">&nbsp;        GridBagConstraints gridBagConstraints = new GridBagConstraints();</b>
<b class="nc">&nbsp;        gridBagConstraints.gridx = 0;</b>
<b class="nc">&nbsp;        gridBagConstraints.gridy = 0;</b>
<b class="nc">&nbsp;        gridBagConstraints.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        gridBagConstraints.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        gridBagConstraints.weightx = 0.0;</b>
<b class="nc">&nbsp;        gridBagConstraints.weighty = 1.0;</b>
<b class="nc">&nbsp;        dialog.getContentPane().add(tScroll, gridBagConstraints);</b>
&nbsp;
<b class="nc">&nbsp;        JButton button = new JButton(Messages.getString(&quot;Okay&quot;));</b>
<b class="nc">&nbsp;        button.addActionListener(e -&gt; dialog.setVisible(false));</b>
<b class="nc">&nbsp;        gridBagConstraints.gridy = 1;</b>
<b class="nc">&nbsp;        gridBagConstraints.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;        gridBagConstraints.anchor = GridBagConstraints.CENTER;</b>
<b class="nc">&nbsp;        gridBagConstraints.weighty = 0.0;</b>
<b class="nc">&nbsp;        dialog.getContentPane().add(button, gridBagConstraints);</b>
&nbsp;
<b class="nc">&nbsp;        dialog.setSize(new Dimension(width + 25, height + 75));</b>
<b class="nc">&nbsp;        dialog.validate();</b>
<b class="nc">&nbsp;        dialog.setVisible(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Pop up the dialog to load a mech
&nbsp;     */
&nbsp;    private void loadMech() {
<b class="nc">&nbsp;        clientgui.getMechSelectorDialog().updateOptionValues();</b>
<b class="nc">&nbsp;        clientgui.getMechSelectorDialog().setVisible(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void loadFS(Vector&lt;Integer&gt; fighterIds) {
<b class="nc">&nbsp;        String name = JOptionPane.showInputDialog(clientgui.frame, &quot;Choose a squadron designation&quot;);</b>
<b class="nc">&nbsp;        if ((name == null) || (name.trim().length() == 0)) {</b>
<b class="nc">&nbsp;            name = &quot;Flying Circus&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        FighterSquadron fs = new FighterSquadron(name);</b>
<b class="nc">&nbsp;        fs.setOwner(clientgui.getClient().getGame().getEntity(fighterIds.firstElement()).getOwner());</b>
<b class="nc">&nbsp;        clientgui.getClient().sendAddSquadron(fs, fighterIds);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void loadArmy() {
<b class="nc">&nbsp;        clientgui.getRandomArmyDialog().setVisible(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void loadRandomSkills() {
<b class="nc">&nbsp;        clientgui.getRandomSkillDialog().showDialog(clientgui.getClient().getGame().getEntitiesVector());</b>
&nbsp;    }
&nbsp;
&nbsp;    public void loadRandomNames() {
<b class="nc">&nbsp;        clientgui.getRandomNameDialog().showDialog(clientgui.getClient().getGame().getEntitiesVector());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Changes all selected boards to be the specified board
&nbsp;     */
&nbsp;    private void changeMap(String board) {
<b class="nc">&nbsp;        int[] selected = lisBoardsSelected.getSelectedIndices();</b>
<b class="nc">&nbsp;        for (final int newVar : selected) {</b>
<b class="nc">&nbsp;            String name = board;</b>
<b class="nc">&nbsp;            if (!MapSettings.BOARD_RANDOM.equals(name) &amp;&amp; !MapSettings.BOARD_SURPRISE.equals(name)</b>
<b class="nc">&nbsp;                    &amp;&amp; chkRotateBoard.isSelected()) {</b>
<b class="nc">&nbsp;                name = Board.BOARD_REQUEST_ROTATION + name;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Validate the map
<b class="nc">&nbsp;            IBoard b = new Board(16, 17);</b>
<b class="nc">&nbsp;            if (!MapSettings.BOARD_GENERATED.equals(board) &amp;&amp; !MapSettings.BOARD_RANDOM.equals(board)</b>
<b class="nc">&nbsp;                    &amp;&amp; !MapSettings.BOARD_SURPRISE.equals(board)) {</b>
<b class="nc">&nbsp;                b.load(new MegaMekFile(Configuration.boardsDir(), board + &quot;.board&quot;).getFile());</b>
<b class="nc">&nbsp;                if (!b.isValid()) {</b>
<b class="nc">&nbsp;                    JOptionPane.showMessageDialog(this, &quot;The Selected board is invalid, please select another.&quot;);</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            ((DefaultListModel&lt;String&gt;) lisBoardsSelected.getModel()).setElementAt(newVar + &quot;: &quot; + name, newVar); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            mapSettings.getBoardsSelectedVector().set(newVar, name);</b>
&nbsp;        }
<b class="nc">&nbsp;        lisBoardsSelected.setSelectedIndices(selected);</b>
<b class="nc">&nbsp;        clientgui.getClient().sendMapSettings(mapSettings);</b>
<b class="nc">&nbsp;        if (boardPreviewW.isVisible()) {</b>
<b class="nc">&nbsp;            previewGameBoard();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    //
&nbsp;    // GameListener
&nbsp;    //
&nbsp;    @Override
&nbsp;    public void gamePlayerChange(GamePlayerChangeEvent e) {
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        refreshDoneButton();</b>
<b class="nc">&nbsp;        clientgui.getClient().getGame().setupTeams();</b>
<b class="nc">&nbsp;        refreshPlayerInfo();</b>
<b class="nc">&nbsp;        refreshEntities();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void gamePhaseChange(GamePhaseChangeEvent e) {
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getPhase() == IGame.Phase.PHASE_LOUNGE) {</b>
<b class="nc">&nbsp;            refreshDoneButton();</b>
<b class="nc">&nbsp;            refreshGameSettings();</b>
<b class="nc">&nbsp;            refreshPlayerInfo();</b>
<b class="nc">&nbsp;            refreshTeams();</b>
<b class="nc">&nbsp;            refreshCamos();</b>
<b class="nc">&nbsp;            refreshEntities();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void gameEntityNew(GameEntityNewEvent e) {
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        refreshEntities();</b>
<b class="nc">&nbsp;        refreshPlayerInfo();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void gameEntityRemove(GameEntityRemoveEvent e) {
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        refreshEntities();</b>
<b class="nc">&nbsp;        refreshPlayerInfo();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void gameSettingsChange(GameSettingsChangeEvent e) {
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        refreshGameSettings();</b>
<b class="nc">&nbsp;        refreshEntities();</b>
<b class="nc">&nbsp;        refreshPlayerInfo();</b>
<b class="nc">&nbsp;        setupMapSizes();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void gameClientFeedbackRequest(GameCFREvent evt) {
&nbsp;        // Do nothing
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /*
&nbsp;     * NOTE: On linux, this gets called even when programatically updating the
&nbsp;     * list box selected item. Do not let this go into an infinite loop. Do not
&nbsp;     * update the selected item (even indirectly, by sending player info) if it
&nbsp;     * is already selected.
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void itemStateChanged(ItemEvent ev) {
&nbsp;
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ev.getSource().equals(choTeam)) {</b>
<b class="nc">&nbsp;            changeTeam(choTeam.getSelectedIndex());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    //
&nbsp;    // ActionListener
&nbsp;    //
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent ev) {
&nbsp;
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ev.getSource().equals(butLoad)) {</b>
<b class="nc">&nbsp;            loadMech();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butArmy)) {</b>
<b class="nc">&nbsp;            loadArmy();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butSkills)) {</b>
<b class="nc">&nbsp;            loadRandomSkills();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butNames)) {</b>
<b class="nc">&nbsp;            loadRandomNames();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(tableEntities)) {</b>
<b class="nc">&nbsp;            customizeMech();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(tablePlayers)) {</b>
<b class="nc">&nbsp;            customizePlayer();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butDeleteAll)) {</b>
&nbsp;            // Build a Vector of this player&#39;s entities.
<b class="nc">&nbsp;            Client c = getPlayerSelected();</b>
<b class="nc">&nbsp;            if (c == null) {</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;ChatLounge.SelectBotOrPlayer&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            clientgui.deleteAllUnits(c);</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butOptions)) {</b>
&nbsp;            // Make sure the game options dialog is editable.
<b class="nc">&nbsp;            if (!clientgui.getGameOptionsDialog().isEditable()) {</b>
<b class="nc">&nbsp;                clientgui.getGameOptionsDialog().setEditable(true);</b>
&nbsp;            }
&nbsp;            // Display the game options dialog.
<b class="nc">&nbsp;            clientgui.getGameOptionsDialog().update(clientgui.getClient().getGame().getOptions());</b>
<b class="nc">&nbsp;            clientgui.getGameOptionsDialog().setVisible(true);</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butCompact)) {</b>
<b class="nc">&nbsp;            if (butCompact.isSelected()) {</b>
<b class="nc">&nbsp;                tableEntities.setRowHeight(15);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                tableEntities.setRowHeight(80);</b>
&nbsp;            }
<b class="nc">&nbsp;            refreshEntities();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butChangeStart)) {</b>
<b class="nc">&nbsp;            clientgui.getStartingPositionDialog().update();</b>
<b class="nc">&nbsp;            Client c = getPlayerSelected();</b>
<b class="nc">&nbsp;            if (c == null) {</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;ChatLounge.SelectBotOrPlayer&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            clientgui.getStartingPositionDialog().setClient(c);</b>
<b class="nc">&nbsp;            clientgui.getStartingPositionDialog().setVisible(true);</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butLoadList)) {</b>
&nbsp;            // Allow the player to replace their current
&nbsp;            // list of entities with a list from a file.
<b class="nc">&nbsp;            Client c = getPlayerSelected();</b>
<b class="nc">&nbsp;            if (c == null) {</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;ChatLounge.SelectBotOrPlayer&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            clientgui.loadListFile(c.getLocalPlayer());</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butSaveList)) {</b>
&nbsp;            // Allow the player to save their current
&nbsp;            // list of entities to a file.
<b class="nc">&nbsp;            Client c = getPlayerSelected();</b>
<b class="nc">&nbsp;            if (c == null) {</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;ChatLounge.SelectBotOrPlayer&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            clientgui.saveListFile(c.getGame().getPlayerEntities(c.getLocalPlayer(), false),</b>
<b class="nc">&nbsp;                    c.getLocalPlayer().getName());</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butAddBot)) {</b>
<b class="nc">&nbsp;            BotConfigDialog bcd = new BotConfigDialog(clientgui.frame);</b>
<b class="nc">&nbsp;            bcd.setVisible(true);</b>
<b class="nc">&nbsp;            if (bcd.dialogAborted) {</b>
&nbsp;                return; // user didn&#39;t click &#39;ok&#39;, add no bot
&nbsp;            }
<b class="nc">&nbsp;            if (clientgui.getBots().containsKey(bcd.getBotName())) {</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.AlertExistsBot.title&quot;),</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;ChatLounge.AlertExistsBot.message&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;            } else {
<b class="nc">&nbsp;                BotClient c = bcd.getSelectedBot(clientgui.getClient().getHost(), clientgui.getClient().getPort());</b>
<b class="nc">&nbsp;                c.setClientGUI(clientgui);</b>
<b class="nc">&nbsp;                c.getGame().addGameListener(new BotGUI(c));</b>
&nbsp;                try {
<b class="nc">&nbsp;                    c.connect();</b>
<b class="nc">&nbsp;                } catch (Exception e) {</b>
<b class="nc">&nbsp;                    clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.AlertBot.title&quot;),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;ChatLounge.AlertBot.message&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                clientgui.getBots().put(bcd.getBotName(), c);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butRemoveBot)) {</b>
<b class="nc">&nbsp;            Client c = getPlayerSelected();</b>
<b class="nc">&nbsp;            if ((c == null) || c.equals(clientgui.getClient())) {</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;ChatLounge.SelectBo&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            c.die();</b>
<b class="nc">&nbsp;            clientgui.getBots().remove(c.getName());</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == butConditions) {</b>
<b class="nc">&nbsp;            clientgui.getPlanetaryConditionsDialog().update(clientgui.getClient().getGame().getPlanetaryConditions());</b>
<b class="nc">&nbsp;            clientgui.getPlanetaryConditionsDialog().setVisible(true);</b>
<b class="nc">&nbsp;        } else if (ev.getSource() == butRandomMap) {</b>
<b class="nc">&nbsp;            RandomMapDialog rmd = new RandomMapDialog(clientgui.frame, this, clientgui.getClient(), mapSettings);</b>
<b class="nc">&nbsp;            rmd.activateDialog(clientgui.getBoardView().getTilesetManager().getThemes());</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butChange)) {</b>
<b class="nc">&nbsp;            if (lisBoardsAvailable.getSelectedIndex() != -1) {</b>
<b class="nc">&nbsp;                changeMap(lisBoardsAvailable.getSelectedValue());</b>
<b class="nc">&nbsp;                lisBoardsSelected.setSelectedIndex(lisBoardsSelected.getSelectedIndex() + 1);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (ev.getSource().equals(buttonBoardPreview)) {</b>
<b class="nc">&nbsp;            previewGameBoard();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(butMapSize) || ev.getSource().equals(butSpaceSize)) {</b>
<b class="nc">&nbsp;            MapDimensionsDialog mdd = new MapDimensionsDialog(clientgui, mapSettings);</b>
<b class="nc">&nbsp;            mdd.setVisible(true);</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(comboMapSizes)) {</b>
<b class="nc">&nbsp;            if ((comboMapSizes.getSelectedItem() != null)</b>
<b class="nc">&nbsp;                    &amp;&amp; !comboMapSizes.getSelectedItem().equals(Messages.getString(&quot;ChatLounge.CustomMapSize&quot;))) {</b>
<b class="nc">&nbsp;                BoardDimensions size = (BoardDimensions) comboMapSizes.getSelectedItem();</b>
<b class="nc">&nbsp;                mapSettings.setBoardSize(size.width(), size.height());</b>
<b class="nc">&nbsp;                resetAvailBoardSelection = true;</b>
<b class="nc">&nbsp;                resetSelectedBoards = true;</b>
<b class="nc">&nbsp;                clientgui.getClient().sendMapSettings(mapSettings);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(chkRotateBoard) &amp;&amp; (lisBoardsAvailable.getSelectedIndex() != -1)) {</b>
<b class="nc">&nbsp;            previewMapsheet();</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(comboMapType)) {</b>
<b class="nc">&nbsp;            mapSettings.setMedium(comboMapType.getSelectedIndex());</b>
<b class="nc">&nbsp;            clientgui.getClient().sendMapSettings(mapSettings);</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(chkIncludeGround)) {</b>
<b class="nc">&nbsp;            if (chkIncludeGround.isSelected()) {</b>
<b class="nc">&nbsp;                mapSettings.setMedium(comboMapType.getSelectedIndex());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                mapSettings.setMedium(MapSettings.MEDIUM_SPACE);</b>
&nbsp;                // set default size for space maps
<b class="nc">&nbsp;                mapSettings.setBoardSize(50, 50);</b>
<b class="nc">&nbsp;                mapSettings.setMapSize(1, 1);</b>
&nbsp;            }
<b class="nc">&nbsp;            clientgui.getClient().sendMapDimensions(mapSettings);</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(chkIncludeSpace)) {</b>
<b class="nc">&nbsp;            if (chkIncludeSpace.isSelected()) {</b>
<b class="nc">&nbsp;                mapSettings.setMedium(MapSettings.MEDIUM_SPACE);</b>
&nbsp;                // set default size for space maps
<b class="nc">&nbsp;                mapSettings.setBoardSize(50, 50);</b>
<b class="nc">&nbsp;                mapSettings.setMapSize(1, 1);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                mapSettings.setMedium(comboMapType.getSelectedIndex());</b>
&nbsp;            }
<b class="nc">&nbsp;            clientgui.getClient().sendMapDimensions(mapSettings);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void mouseClicked(MouseEvent arg0) {
<b class="nc">&nbsp;        if ((arg0.getClickCount() == 1) &amp;&amp; arg0.getSource().equals(lisBoardsAvailable)) {</b>
<b class="nc">&nbsp;            previewMapsheet();</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((arg0.getClickCount() == 2) &amp;&amp; arg0.getSource().equals(lisBoardsAvailable)) {</b>
<b class="nc">&nbsp;            if (lisBoardsAvailable.getSelectedIndex() != -1) {</b>
<b class="nc">&nbsp;                changeMap(lisBoardsAvailable.getSelectedValue());</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void mouseEntered(MouseEvent arg0) {
&nbsp;        // ignore
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void mouseExited(MouseEvent arg0) {
&nbsp;        // ignore
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void mousePressed(MouseEvent arg0) {
&nbsp;        // ignore
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void mouseReleased(MouseEvent arg0) {
&nbsp;        // ignore
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Updates to show the map settings that have, presumably, just been sent by
&nbsp;     * the server.
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void updateMapSettings(MapSettings newSettings) {
<b class="nc">&nbsp;        mapSettings = MapSettings.getInstance(newSettings);</b>
<b class="nc">&nbsp;        refreshMapButtons();</b>
<b class="nc">&nbsp;        refreshMapChoice();</b>
<b class="nc">&nbsp;        refreshSpaceGround();</b>
<b class="nc">&nbsp;        refreshBoardsSelected();</b>
<b class="nc">&nbsp;        refreshBoardsAvailable();</b>
<b class="nc">&nbsp;        refreshMapSummaryLabel();</b>
<b class="nc">&nbsp;        refreshGameYearLabel();</b>
<b class="nc">&nbsp;        refreshTechLevelLabel();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void refreshMapSummaryLabel() {
<b class="nc">&nbsp;        String txt = Messages.getString(&quot;ChatLounge.MapSummary&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        txt = txt + &quot; &quot; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                + (mapSettings.getBoardWidth() * mapSettings.getMapWidth()) + &quot; x &quot; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                + (mapSettings.getBoardHeight() * mapSettings.getMapHeight());</b>
<b class="nc">&nbsp;        if (chkIncludeGround.isSelected()) {</b>
<b class="nc">&nbsp;            txt = txt + &quot; &quot; + comboMapType.getSelectedItem();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            txt = txt + &quot; &quot; + &quot;Space Map&quot;; //$NON-NLS-1$</b>
&nbsp;        }
<b class="nc">&nbsp;        lblMapSummary.setText(txt);</b>
&nbsp;
<b class="nc">&nbsp;        StringBuilder selectedMaps = new StringBuilder();</b>
<b class="nc">&nbsp;        selectedMaps.append(&quot;&lt;html&gt;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        selectedMaps.append(Messages.getString(&quot;ChatLounge.MapSummarySelectedMaps&quot;));</b>
<b class="nc">&nbsp;        selectedMaps.append(&quot;&lt;br&gt;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        ListModel&lt;String&gt; model = lisBoardsSelected.getModel();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; model.getSize(); i++) {</b>
<b class="nc">&nbsp;            String map = model.getElementAt(i);</b>
<b class="nc">&nbsp;            selectedMaps.append(map);</b>
<b class="nc">&nbsp;            if ((i + 1) &lt; model.getSize()) {</b>
<b class="nc">&nbsp;                selectedMaps.append(&quot;&lt;br&gt;&quot;); //$NON-NLS-1$</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        lblMapSummary.setToolTipText(selectedMaps.toString());</b>
&nbsp;    }
&nbsp;
&nbsp;    public void refreshGameYearLabel() {
<b class="nc">&nbsp;        String txt = Messages.getString(&quot;ChatLounge.GameYear&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        txt = txt + &quot; &quot; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                + clientgui.getClient().getGame().getOptions().intOption(OptionsConstants.ALLOWED_YEAR); // $NON-NLS-1$</b>
<b class="nc">&nbsp;        lblGameYear.setText(txt);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void refreshTechLevelLabel() {
&nbsp;        String tlString;
<b class="nc">&nbsp;        IOption tlOpt = clientgui.getClient().getGame().getOptions().getOption(&quot;techlevel&quot;);</b>
<b class="nc">&nbsp;        if (tlOpt != null) {</b>
<b class="nc">&nbsp;            tlString = tlOpt.stringValue();</b>
&nbsp;
&nbsp;        } else {
<b class="nc">&nbsp;            tlString = TechConstants.getLevelDisplayableName(TechConstants.T_TECH_UNKNOWN);</b>
&nbsp;        }
<b class="nc">&nbsp;        String txt = Messages.getString(&quot;ChatLounge.TechLevel&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        txt = txt + &quot; &quot; + tlString; //$NON-NLS-1$</b>
<b class="nc">&nbsp;        lblTechLevel.setText(txt);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void ready() {
<b class="nc">&nbsp;        final Client client = clientgui.getClient();</b>
<b class="nc">&nbsp;        final IGame game = client.getGame();</b>
<b class="nc">&nbsp;        final GameOptions gOpts = game.getOptions();</b>
&nbsp;        // enforce exclusive deployment zones in double blind
<b class="nc">&nbsp;        if (gOpts.booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND) // $NON-NLS-1$</b>
<b class="nc">&nbsp;                &amp;&amp; gOpts.booleanOption(OptionsConstants.BASE_EXCLUSIVE_DB_DEPLOYMENT)) { // $NON-NLS-1$</b>
<b class="nc">&nbsp;            int i = client.getLocalPlayer().getStartingPos();</b>
<b class="nc">&nbsp;            if (i == 0) {</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ExclusiveDeploy.title&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;ChatLounge.ExclusiveDeploy.msg&quot;)); //$NON-NLS-1$</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            for (Enumeration&lt;IPlayer&gt; e = client.getGame().getPlayers(); e.hasMoreElements();) {</b>
<b class="nc">&nbsp;                IPlayer player = e.nextElement();</b>
<b class="nc">&nbsp;                if (player.getStartingPos() == 0) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // CTR and EDG don&#39;t overlap
<b class="nc">&nbsp;                if (((player.getStartingPos() == 9) &amp;&amp; (i == 10)) || ((player.getStartingPos() == 10) &amp;&amp; (i == 9))) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // check for overlapping starting directions
<b class="nc">&nbsp;                if (((player.getStartingPos() == i) || ((player.getStartingPos() + 1) == i)</b>
<b class="nc">&nbsp;                        || ((player.getStartingPos() - 1) == i))</b>
<b class="nc">&nbsp;                        &amp;&amp; (player.getId() != client.getLocalPlayer().getId())) {</b>
<b class="nc">&nbsp;                    clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.OverlapDeploy.title&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;ChatLounge.OverlapDeploy.msg&quot;)); //$NON-NLS-1$</b>
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
&nbsp;        // Make sure player has a commander if Commander killed victory is on
<b class="nc">&nbsp;        if (gOpts.booleanOption(OptionsConstants.VICTORY_COMMANDER_KILLED)) {</b>
<b class="nc">&nbsp;            List&lt;String&gt; players = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            if ((game.getLiveCommandersOwnedBy(client.getLocalPlayer()) &lt; 1)</b>
<b class="nc">&nbsp;                    &amp;&amp; (game.getEntitiesOwnedBy(client.getLocalPlayer()) &gt; 0)) {</b>
<b class="nc">&nbsp;                players.add(client.getLocalPlayer().getName());</b>
&nbsp;            }
<b class="nc">&nbsp;            for (Client bc : clientgui.getBots().values()) {</b>
<b class="nc">&nbsp;                if ((game.getLiveCommandersOwnedBy(bc.getLocalPlayer()) &lt; 1)</b>
<b class="nc">&nbsp;                        &amp;&amp; (game.getEntitiesOwnedBy(bc.getLocalPlayer()) &gt; 0)) {</b>
<b class="nc">&nbsp;                    players.add(bc.getLocalPlayer().getName());</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (players.size() &gt; 0) {</b>
<b class="nc">&nbsp;                String title = Messages.getString(&quot;ChatLounge.noCmdr.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                String msg = Messages.getString(&quot;ChatLounge.noCmdr.msg&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                for (String player : players) {</b>
<b class="nc">&nbsp;                    msg += player + &quot;\n&quot;;</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(title, msg);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        boolean done = !client.getLocalPlayer().isDone();</b>
<b class="nc">&nbsp;        client.sendDone(done);</b>
<b class="nc">&nbsp;        refreshDoneButton(done);</b>
<b class="nc">&nbsp;        for (Client client2 : clientgui.getBots().values()) {</b>
<b class="nc">&nbsp;            client2.sendDone(done);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    Client getPlayerSelected() {
<b class="nc">&nbsp;        if ((tablePlayers == null) || (tablePlayers.getSelectedRow() == -1)) {</b>
<b class="nc">&nbsp;            return clientgui.getClient();</b>
&nbsp;        }
<b class="nc">&nbsp;        String name = (String) tablePlayers.getValueAt(tablePlayers.getSelectedRow(), 0);</b>
<b class="nc">&nbsp;        BotClient c = (BotClient) clientgui.getBots().get(name);</b>
<b class="nc">&nbsp;        if ((c == null) &amp;&amp; clientgui.getClient().getName().equals(name)) {</b>
<b class="nc">&nbsp;            return clientgui.getClient();</b>
&nbsp;        }
<b class="nc">&nbsp;        return c;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Stop just ignoring events and actually stop listening to them.
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void removeAllListeners() {
<b class="nc">&nbsp;        clientgui.getClient().getGame().removeGameListener(this);</b>
<b class="nc">&nbsp;        clientgui.getBoardView().removeBoardViewListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * This is required because the ChatLounge adds the listener to the
&nbsp;     * MechSummaryCache that must be removed explicitly.
&nbsp;     */
&nbsp;    public void die() {
<b class="nc">&nbsp;        MechSummaryCache.getInstance().removeListener(mechSummaryCacheListener);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns true if the given list of entities can be configured as a group.
&nbsp;     * This requires that they all have the same owner, and that none of the
&nbsp;     * units are being transported.
&nbsp;     *
&nbsp;     * @param entities
&nbsp;     * @return
&nbsp;     */
&nbsp;    private boolean canConfigureAll(List&lt;Entity&gt; entities) {
<b class="nc">&nbsp;        if (entities.size() == 1) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Set&lt;Integer&gt; owners = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        boolean containsTransportedUnit = false;</b>
<b class="nc">&nbsp;        for (Entity e : entities) {</b>
<b class="nc">&nbsp;            containsTransportedUnit |= e.getTransportId() != Entity.NONE;</b>
<b class="nc">&nbsp;            owners.add(e.getOwner().getId());</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return (owners.size() == 1) &amp;&amp; !containsTransportedUnit;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void valueChanged(ListSelectionEvent event) {
<b class="nc">&nbsp;        if (event.getValueIsAdjusting()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (event.getSource().equals(butRemoveBot)) {</b>
<b class="nc">&nbsp;            butRemoveBot.setEnabled(false);</b>
<b class="nc">&nbsp;            Client c = getPlayerSelected();</b>
<b class="nc">&nbsp;            if (c == null) {</b>
&nbsp;
<b class="nc">&nbsp;                tablePlayers.removeRowSelectionInterval(tablePlayers.getSelectedRow(), tablePlayers.getSelectedRow());</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            if (c instanceof BotClient) {</b>
<b class="nc">&nbsp;                butRemoveBot.setEnabled(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            choTeam.setSelectedIndex(c.getLocalPlayer().getTeam());</b>
<b class="nc">&nbsp;        } else if (event.getSource().equals(tablePlayers.getSelectionModel())) {</b>
<b class="nc">&nbsp;            butRemoveBot.setEnabled(false);</b>
<b class="nc">&nbsp;            Client c = getPlayerSelected();</b>
<b class="nc">&nbsp;            if (c == null) {</b>
<b class="nc">&nbsp;                tablePlayers.removeRowSelectionInterval(tablePlayers.getSelectedRow(), tablePlayers.getSelectedRow());</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            if (c instanceof BotClient) {</b>
<b class="nc">&nbsp;                butRemoveBot.setEnabled(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            boolean tf = (!c.getGame().getPlayerEntities(c.getLocalPlayer(), false).isEmpty());</b>
<b class="nc">&nbsp;            butDeleteAll.setEnabled(tf);</b>
<b class="nc">&nbsp;            butSaveList.setEnabled(tf);</b>
<b class="nc">&nbsp;            refreshCamos();</b>
<b class="nc">&nbsp;            choTeam.setSelectedIndex(c.getLocalPlayer().getTeam());</b>
<b class="nc">&nbsp;        } else if (event.getSource().equals(lisBoardsAvailable)) {</b>
<b class="nc">&nbsp;            previewMapsheet();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * A table model for displaying players
&nbsp;     */
&nbsp;    public class PlayerTableModel extends AbstractTableModel {
&nbsp;
&nbsp;        private static final long serialVersionUID = -1372393680232901923L;
&nbsp;
&nbsp;        private static final int COL_PLAYER = 0;
&nbsp;        private static final int COL_START = 1;
&nbsp;        private static final int COL_TEAM = 2;
&nbsp;        private static final int COL_BV = 3;
&nbsp;        private static final int COL_TON = 4;
&nbsp;        private static final int COL_COST = 5;
&nbsp;        private static final int N_COL = 6;
&nbsp;
&nbsp;        private ArrayList&lt;IPlayer&gt; players;
&nbsp;        private ArrayList&lt;Integer&gt; bvs;
&nbsp;        private ArrayList&lt;Integer&gt; costs;
&nbsp;        private ArrayList&lt;Double&gt; tons;
&nbsp;
<b class="nc">&nbsp;        public PlayerTableModel() {</b>
<b class="nc">&nbsp;            players = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            bvs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            costs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            tons = new ArrayList&lt;&gt;();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int getRowCount() {
<b class="nc">&nbsp;            return players.size();</b>
&nbsp;        }
&nbsp;
&nbsp;        public void clearData() {
<b class="nc">&nbsp;            players = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            bvs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            costs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            tons = new ArrayList&lt;&gt;();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int getColumnCount() {
<b class="nc">&nbsp;            return N_COL;</b>
&nbsp;        }
&nbsp;
&nbsp;        public void addPlayer(IPlayer player) {
<b class="nc">&nbsp;            players.add(player);</b>
<b class="nc">&nbsp;            int bv = 0;</b>
<b class="nc">&nbsp;            int cost = 0;</b>
<b class="nc">&nbsp;            double ton = 0;</b>
<b class="nc">&nbsp;            for (Entity entity : clientgui.getClient().getEntitiesVector()) {</b>
<b class="nc">&nbsp;                if (entity.getOwner().equals(player)) {</b>
<b class="nc">&nbsp;                    bv += entity.calculateBattleValue();</b>
<b class="nc">&nbsp;                    cost += entity.getCost(false);</b>
<b class="nc">&nbsp;                    ton += entity.getWeight();</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            bvs.add(bv);</b>
<b class="nc">&nbsp;            costs.add(cost);</b>
<b class="nc">&nbsp;            tons.add(ton);</b>
<b class="nc">&nbsp;            fireTableDataChanged();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public String getColumnName(int column) {
<b class="nc">&nbsp;            switch (column) {</b>
&nbsp;                case COL_PLAYER:
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.colPlayer&quot;);</b>
&nbsp;                case COL_START:
<b class="nc">&nbsp;                    return &quot;Start&quot;;</b>
&nbsp;                case COL_TEAM:
<b class="nc">&nbsp;                    return &quot;Team&quot;;</b>
&nbsp;                case COL_TON:
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.colTon&quot;);</b>
&nbsp;                case COL_BV:
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.colBV&quot;);</b>
&nbsp;                case COL_COST:
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.colCost&quot;);</b>
&nbsp;                default:
<b class="nc">&nbsp;                    return &quot;??&quot;;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Class&lt;?&gt; getColumnClass(int c) {
<b class="nc">&nbsp;            return getValueAt(0, c).getClass();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public boolean isCellEditable(int row, int col) {
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Object getValueAt(int row, int col) {
<b class="nc">&nbsp;            IPlayer player = getPlayerAt(row);</b>
<b class="nc">&nbsp;            boolean blindDrop = !player.equals(clientgui.getClient().getLocalPlayer()) &amp;&amp; clientgui.getClient()</b>
<b class="nc">&nbsp;                    .getGame().getOptions().booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP);</b>
<b class="nc">&nbsp;            if (col == COL_BV) {</b>
<b class="nc">&nbsp;                int bv = bvs.get(row);</b>
<b class="nc">&nbsp;                if (blindDrop) {</b>
<b class="nc">&nbsp;                    bv = bv &gt; 0 ? 9999 : 0;</b>
&nbsp;                }
<b class="nc">&nbsp;                return bv;</b>
<b class="nc">&nbsp;            } else if (col == COL_PLAYER) {</b>
<b class="nc">&nbsp;                return player.getName();</b>
<b class="nc">&nbsp;            } else if (col == COL_START) {</b>
<b class="nc">&nbsp;                return IStartingPositions.START_LOCATION_NAMES[player.getStartingPos()];</b>
<b class="nc">&nbsp;            } else if (col == COL_TON) {</b>
<b class="nc">&nbsp;                double ton = tons.get(row);</b>
<b class="nc">&nbsp;                if (blindDrop) {</b>
<b class="nc">&nbsp;                    ton = ton &gt; 0 ? 9999 : 0;</b>
&nbsp;                }
<b class="nc">&nbsp;                return ton;</b>
<b class="nc">&nbsp;            } else if (col == COL_COST) {</b>
<b class="nc">&nbsp;                int cost = costs.get(row);</b>
<b class="nc">&nbsp;                if (blindDrop) {</b>
<b class="nc">&nbsp;                    cost = cost &gt; 0 ? 9999 : 0;</b>
&nbsp;                }
<b class="nc">&nbsp;                return cost;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return player.getTeam();</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        public IPlayer getPlayerAt(int row) {
<b class="nc">&nbsp;            return players.get(row);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public class PlayerTableMouseAdapter extends MouseInputAdapter implements ActionListener {</b>
&nbsp;
&nbsp;        @Override
&nbsp;        public void mouseClicked(MouseEvent e) {
<b class="nc">&nbsp;            if (e.getClickCount() == 2) {</b>
<b class="nc">&nbsp;                int row = tablePlayers.rowAtPoint(e.getPoint());</b>
<b class="nc">&nbsp;                IPlayer player = playerModel.getPlayerAt(row);</b>
<b class="nc">&nbsp;                if (player != null) {</b>
<b class="nc">&nbsp;                    boolean isOwner = player.equals(clientgui.getClient().getLocalPlayer());</b>
<b class="nc">&nbsp;                    boolean isBot = clientgui.getBots().get(player.getName()) != null;</b>
<b class="nc">&nbsp;                    if ((isOwner || isBot)) {</b>
<b class="nc">&nbsp;                        customizePlayer();</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void mousePressed(MouseEvent e) {
<b class="nc">&nbsp;            maybeShowPopup(e);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void mouseReleased(MouseEvent e) {
<b class="nc">&nbsp;            maybeShowPopup(e);</b>
&nbsp;        }
&nbsp;
&nbsp;        private void maybeShowPopup(MouseEvent e) {
<b class="nc">&nbsp;            JPopupMenu popup = new JPopupMenu();</b>
<b class="nc">&nbsp;            int row = tablePlayers.rowAtPoint(e.getPoint());</b>
<b class="nc">&nbsp;            IPlayer player = playerModel.getPlayerAt(row);</b>
<b class="nc">&nbsp;            boolean isOwner = player.equals(clientgui.getClient().getLocalPlayer());</b>
<b class="nc">&nbsp;            boolean isBot = clientgui.getBots().get(player.getName()) != null;</b>
<b class="nc">&nbsp;            if (e.isPopupTrigger()) {</b>
<b class="nc">&nbsp;                JMenuItem menuItem = null;</b>
<b class="nc">&nbsp;                menuItem = new JMenuItem(&quot;Configure ...&quot;);</b>
<b class="nc">&nbsp;                menuItem.setActionCommand(&quot;CONFIGURE|&quot; + row);</b>
<b class="nc">&nbsp;                menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                menuItem.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                popup.add(menuItem);</b>
&nbsp;                
<b class="nc">&nbsp;                if (isBot) {</b>
<b class="nc">&nbsp;                    JMenuItem botConfig = new JMenuItem(&quot;Bot Settings ...&quot;);</b>
<b class="nc">&nbsp;                    botConfig.setActionCommand(&quot;BOTCONFIG|&quot; + row);</b>
<b class="nc">&nbsp;                    botConfig.addActionListener(this);</b>
<b class="nc">&nbsp;                    popup.add(botConfig);</b>
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                popup.show(e.getComponent(), e.getX(), e.getY());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void actionPerformed(ActionEvent action) {
<b class="nc">&nbsp;            StringTokenizer st = new StringTokenizer(action.getActionCommand(), &quot;|&quot;);</b>
<b class="nc">&nbsp;            String command = st.nextToken();</b>
<b class="nc">&nbsp;            if (command.equalsIgnoreCase(&quot;CONFIGURE&quot;)) {</b>
<b class="nc">&nbsp;                customizePlayer();</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;BOTCONFIG&quot;)) {</b>
<b class="nc">&nbsp;                int row = Integer.parseInt(st.nextToken());</b>
<b class="nc">&nbsp;                IPlayer player = playerModel.getPlayerAt(row);</b>
<b class="nc">&nbsp;                BotClient bot = (BotClient) clientgui.getBots().get(player.getName());</b>
<b class="nc">&nbsp;                BotConfigDialog bcd = new BotConfigDialog(clientgui.frame, bot);</b>
<b class="nc">&nbsp;                bcd.setVisible(true);</b>
&nbsp;
<b class="nc">&nbsp;                if (bcd.dialogAborted) {</b>
&nbsp;                    return; // user didn&#39;t click &#39;ok&#39;, add no bot
<b class="nc">&nbsp;                } else if (bot instanceof Princess) {</b>
<b class="nc">&nbsp;                    ((Princess) bot).setBehaviorSettings(bcd.getBehaviorSettings());</b>
&nbsp;                    
&nbsp;                    // bookkeeping:
<b class="nc">&nbsp;                    clientgui.getBots().remove(player.getName());</b>
<b class="nc">&nbsp;                    bot.setName(bcd.getBotName());</b>
<b class="nc">&nbsp;                    clientgui.getBots().put(bot.getName(), bot);</b>
<b class="nc">&nbsp;                    player.setName(bcd.getBotName());</b>
<b class="nc">&nbsp;                    clientgui.chatlounge.refreshPlayerInfo();</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * A table model for displaying units
&nbsp;     */
&nbsp;    public class MekTableModel extends AbstractTableModel {
&nbsp;
&nbsp;        private static final long serialVersionUID = 4819661751806908535L;
&nbsp;
&nbsp;        private static final int COL_UNIT = 0;
&nbsp;        private static final int COL_PILOT = 1;
&nbsp;        private static final int COL_PLAYER = 2;
&nbsp;        private static final int COL_BV = 3;
&nbsp;        private static final int N_COL = 4;
&nbsp;
&nbsp;        private ArrayList&lt;Entity&gt; data;
&nbsp;
<b class="nc">&nbsp;        public MekTableModel() {</b>
<b class="nc">&nbsp;            data = new ArrayList&lt;Entity&gt;();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int getRowCount() {
<b class="nc">&nbsp;            return data.size();</b>
&nbsp;        }
&nbsp;
&nbsp;        public void clearData() {
<b class="nc">&nbsp;            data = new ArrayList&lt;Entity&gt;();</b>
<b class="nc">&nbsp;            fireTableDataChanged();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public int getColumnCount() {
<b class="nc">&nbsp;            return N_COL;</b>
&nbsp;        }
&nbsp;
&nbsp;        public void addUnit(Entity en) {
<b class="nc">&nbsp;            data.add(en);</b>
<b class="nc">&nbsp;            fireTableDataChanged();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public String getColumnName(int column) {
<b class="nc">&nbsp;            switch (column) {</b>
&nbsp;                case (COL_PILOT):
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.colPilot&quot;);</b>
&nbsp;                case (COL_UNIT):
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.colUnit&quot;);</b>
&nbsp;                case (COL_PLAYER):
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.colPlayer&quot;);</b>
&nbsp;                case (COL_BV):
<b class="nc">&nbsp;                    return Messages.getString(&quot;ChatLounge.colBV&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            return &quot;??&quot;;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Class&lt;?&gt; getColumnClass(int c) {
<b class="nc">&nbsp;            return getValueAt(0, c).getClass();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public boolean isCellEditable(int row, int col) {
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public Object getValueAt(int row, int col) {
<b class="nc">&nbsp;            boolean compact = butCompact.isSelected();</b>
<b class="nc">&nbsp;            Entity entity = getEntityAt(row);</b>
<b class="nc">&nbsp;            boolean blindDrop = !entity.getOwner().equals(clientgui.getClient().getLocalPlayer())</b>
<b class="nc">&nbsp;                    &amp;&amp; clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP);</b>
<b class="nc">&nbsp;            String value = &quot;&quot;;</b>
<b class="nc">&nbsp;            if (col == COL_BV) {</b>
<b class="nc">&nbsp;                value += entity.calculateBattleValue();</b>
<b class="nc">&nbsp;            } else if (col == COL_PLAYER) {</b>
<b class="nc">&nbsp;                if (compact) {</b>
<b class="nc">&nbsp;                    value += entity.getOwner().getName();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    value += entity.getOwner().getName() + &quot;&lt;br&gt;Team &quot;</b>
<b class="nc">&nbsp;                            + clientgui.getClient().getGame().getPlayer(entity.getOwnerId()).getTeam();</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (col == COL_PILOT) {</b>
<b class="nc">&nbsp;                final boolean rpgSkills = clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_RPG_GUNNERY);</b>
<b class="nc">&nbsp;                if (compact) {</b>
<b class="nc">&nbsp;                    return formatPilotCompact(entity.getCrew(), blindDrop, rpgSkills);</b>
&nbsp;                }
<b class="nc">&nbsp;                return formatPilotHTML(entity.getCrew(), blindDrop, rpgSkills);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                if (compact) {</b>
<b class="nc">&nbsp;                    return formatUnitCompact(entity, blindDrop);</b>
&nbsp;                }
<b class="nc">&nbsp;                return formatUnitHTML(entity, blindDrop);</b>
&nbsp;            }
<b class="nc">&nbsp;            return value;</b>
&nbsp;        }
&nbsp;
&nbsp;        public Entity getEntityAt(int row) {
<b class="nc">&nbsp;            if (row &lt; 0) {</b>
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
<b class="nc">&nbsp;            return data.get(row);</b>
&nbsp;        }
&nbsp;
&nbsp;        public MekTableModel.Renderer getRenderer() {
<b class="nc">&nbsp;            return new MekTableModel.Renderer();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        public class Renderer extends MekInfo implements TableCellRenderer {</b>
&nbsp;            private static final String FILENAME_UNKNOWN_UNIT = &quot;unknown_unit.gif&quot;;
&nbsp;            private static final long serialVersionUID = -9154596036677641620L;
&nbsp;
&nbsp;            @Override
&nbsp;            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected,
&nbsp;                                                           boolean hasFocus, int row, int column) {
<b class="nc">&nbsp;                Component c = this;</b>
<b class="nc">&nbsp;                setText(getValueAt(row, column).toString(), isSelected);</b>
<b class="nc">&nbsp;                Entity entity = getEntityAt(row);</b>
<b class="nc">&nbsp;                if (null == entity) {</b>
<b class="nc">&nbsp;                    return null;</b>
&nbsp;                }
<b class="nc">&nbsp;                boolean isOwner = entity.getOwner().equals(clientgui.getClient().getLocalPlayer());</b>
<b class="nc">&nbsp;                boolean blindDrop = clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                        .booleanOption(OptionsConstants.BASE_BLIND_DROP);</b>
<b class="nc">&nbsp;                boolean compact = butCompact.isSelected();</b>
<b class="nc">&nbsp;                if (!isOwner &amp;&amp; blindDrop) {</b>
<b class="nc">&nbsp;                    if (column == COL_UNIT) {</b>
<b class="nc">&nbsp;                        if (compact) {</b>
<b class="nc">&nbsp;                            clearImage();</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            Image image = getToolkit().getImage(</b>
<b class="nc">&nbsp;                                    new MegaMekFile(Configuration.miscImagesDir(),</b>
<b class="nc">&nbsp;                                            FILENAME_UNKNOWN_UNIT).toString());</b>
<b class="nc">&nbsp;                            image = image.getScaledInstance(-1, 72,</b>
&nbsp;                                    Image.SCALE_DEFAULT);
<b class="nc">&nbsp;                            setImage(image);</b>
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                    } else if (column == COL_PILOT) {</b>
<b class="nc">&nbsp;                        if (compact) {</b>
<b class="nc">&nbsp;                            clearImage();</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            Image image = getToolkit().getImage(</b>
<b class="nc">&nbsp;                                    new MegaMekFile(Configuration.portraitImagesDir(),</b>
&nbsp;                                            Portrait.DEFAULT_PORTRAIT_FILENAME)
<b class="nc">&nbsp;                                            .toString());</b>
<b class="nc">&nbsp;                            image = image.getScaledInstance(-1, 50,</b>
&nbsp;                                    Image.SCALE_DEFAULT);
<b class="nc">&nbsp;                            setImage(image);</b>
<b class="nc">&nbsp;                        }</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    if (column == COL_UNIT) {</b>
<b class="nc">&nbsp;                        if (compact) {</b>
<b class="nc">&nbsp;                            clearImage();</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            clientgui.loadPreviewImage(getLabel(), entity);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        setToolTipText(formatUnitTooltip(entity));</b>
<b class="nc">&nbsp;                        setLoad(entity.getTransportId() != Entity.NONE);</b>
<b class="nc">&nbsp;                    } else if (column == COL_PILOT) {</b>
<b class="nc">&nbsp;                        if (compact) {</b>
<b class="nc">&nbsp;                            clearImage();</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            setImage(entity.getCrew().getPortrait(0).getImage(50));</b>
&nbsp;                        }
<b class="nc">&nbsp;                        setToolTipText(formatPilotTooltip(entity.getCrew(),</b>
<b class="nc">&nbsp;                                clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                                        .booleanOption(OptionsConstants.RPG_COMMAND_INIT),</b>
<b class="nc">&nbsp;                                clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                                        .booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE),</b>
<b class="nc">&nbsp;                                clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                                        .booleanOption(OptionsConstants.RPG_TOUGHNESS),</b>
<b class="nc">&nbsp;                                clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                                        .booleanOption(OptionsConstants.RPG_RPG_GUNNERY)));</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (isSelected) {</b>
<b class="nc">&nbsp;                    c.setForeground(table.getSelectionForeground());</b>
<b class="nc">&nbsp;                    c.setBackground(table.getSelectionBackground());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    Color background = table.getBackground();</b>
<b class="nc">&nbsp;                    if (row % 2 != 0) {</b>
<b class="nc">&nbsp;                        Color alternateColor = UIManager.getColor(&quot;Table.alternateRowColor&quot;);</b>
<b class="nc">&nbsp;                        if (alternateColor == null) {</b>
&nbsp;                            // If we don&#39;t have an alternate row color, use &#39;controlHighlight&#39;
&nbsp;                            // as it is pretty reasonable across the various themes.
<b class="nc">&nbsp;                            alternateColor = UIManager.getColor(&quot;controlHighlight&quot;);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (alternateColor != null) {</b>
<b class="nc">&nbsp;                            background = alternateColor;</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    c.setForeground(table.getForeground());</b>
<b class="nc">&nbsp;                    c.setBackground(background);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (hasFocus) {</b>
<b class="nc">&nbsp;                    if (!isSelected ) {</b>
<b class="nc">&nbsp;                        Color col = UIManager.getColor(&quot;Table.focusCellForeground&quot;);</b>
<b class="nc">&nbsp;                        if (col != null) {</b>
<b class="nc">&nbsp;                            c.setForeground(col);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        col = UIManager.getColor(&quot;Table.focusCellBackground&quot;);</b>
<b class="nc">&nbsp;                        if (col != null) {</b>
<b class="nc">&nbsp;                            c.setBackground(col);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                return c;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public class MekTableKeyAdapter extends KeyAdapter {</b>
&nbsp;
&nbsp;        @Override
&nbsp;        public void keyPressed(KeyEvent e) {
<b class="nc">&nbsp;            if (tableEntities.getSelectedRowCount() == 0) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            int[] rows = tableEntities.getSelectedRows();</b>
<b class="nc">&nbsp;            Vector&lt;Entity&gt; entities = new Vector&lt;&gt;();</b>
<b class="nc">&nbsp;            for (int row : rows) {</b>
<b class="nc">&nbsp;                entities.add(mekModel.getEntityAt(row));</b>
&nbsp;            }
<b class="nc">&nbsp;            int code = e.getKeyCode();</b>
<b class="nc">&nbsp;            if ((code == KeyEvent.VK_DELETE) || (code == KeyEvent.VK_BACK_SPACE)) {</b>
<b class="nc">&nbsp;                e.consume();</b>
<b class="nc">&nbsp;                for (Entity entity : entities) {</b>
<b class="nc">&nbsp;                    delete(entity);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (code == KeyEvent.VK_SPACE) {</b>
<b class="nc">&nbsp;                e.consume();</b>
<b class="nc">&nbsp;                mechReadout(entities.get(0));</b>
<b class="nc">&nbsp;            } else if (code == KeyEvent.VK_ENTER) {</b>
<b class="nc">&nbsp;                e.consume();</b>
<b class="nc">&nbsp;                if (entities.size() == 1) {</b>
<b class="nc">&nbsp;                    customizeMech(entities.get(0));</b>
<b class="nc">&nbsp;                } else if (canConfigureAll(entities)) {</b>
<b class="nc">&nbsp;                    customizeMechs(entities);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public class MekTableMouseAdapter extends MouseInputAdapter implements ActionListener {</b>
&nbsp;        @Override
&nbsp;        public void actionPerformed(ActionEvent action) {
<b class="nc">&nbsp;            StringTokenizer st = new StringTokenizer(action.getActionCommand(), &quot;|&quot;);</b>
<b class="nc">&nbsp;            String command = st.nextToken();</b>
<b class="nc">&nbsp;            int[] rows = tableEntities.getSelectedRows();</b>
<b class="nc">&nbsp;            int row = tableEntities.getSelectedRow();</b>
<b class="nc">&nbsp;            Entity entity = mekModel.getEntityAt(row);</b>
<b class="nc">&nbsp;            Vector&lt;Entity&gt; entities = new Vector&lt;&gt;();</b>
<b class="nc">&nbsp;            for (int value : rows) {</b>
<b class="nc">&nbsp;                entities.add(mekModel.getEntityAt(value));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (null == entity) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            if (command.equalsIgnoreCase(&quot;VIEW&quot;)) {</b>
<b class="nc">&nbsp;                mechReadout(entity);</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;BV&quot;)) {</b>
<b class="nc">&nbsp;                mechBVDisplay(entity);</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;DAMAGE&quot;)) {</b>
<b class="nc">&nbsp;                mechEdit(entity);</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;INDI_CAMO&quot;)) {</b>
<b class="nc">&nbsp;                mechCamo(entities);</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;CONFIGURE&quot;)) {</b>
<b class="nc">&nbsp;                customizeMech(entity);</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;CONFIGURE_ALL&quot;)) {</b>
<b class="nc">&nbsp;                customizeMechs(entities);</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;DELETE&quot;)) {</b>
<b class="nc">&nbsp;                Client c = clientgui.getBots().get(entity.getOwner().getName());</b>
<b class="nc">&nbsp;                if (c == null) {</b>
<b class="nc">&nbsp;                    c = clientgui.getClient();</b>
&nbsp;                }
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
&nbsp;                    // first unload any units from this unit
<b class="nc">&nbsp;                    if (e.getLoadedUnits().size() &gt; 0) {</b>
<b class="nc">&nbsp;                        for (Entity loaded : e.getLoadedUnits()) {</b>
<b class="nc">&nbsp;                            e.unload(loaded);</b>
<b class="nc">&nbsp;                            loaded.setTransportId(Entity.NONE);</b>
<b class="nc">&nbsp;                            c.sendUpdateEntity(loaded);</b>
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                        c.sendUpdateEntity(e);</b>
&nbsp;                    }
&nbsp;                    // unload this unit from any other units it might be loaded
&nbsp;                    // onto
<b class="nc">&nbsp;                    if (entity.getTransportId() != Entity.NONE) {</b>
<b class="nc">&nbsp;                        Entity loader = clientgui.getClient().getGame().getEntity(entity.getTransportId());</b>
<b class="nc">&nbsp;                        if (null != loader) {</b>
<b class="nc">&nbsp;                            loader.unload(entity);</b>
<b class="nc">&nbsp;                            entity.setTransportId(Entity.NONE);</b>
<b class="nc">&nbsp;                            c.sendUpdateEntity(loader);</b>
<b class="nc">&nbsp;                            c.sendUpdateEntity(entity);</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    c.sendDeleteEntity(e.getId());</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;SKILLS&quot;)) {</b>
<b class="nc">&nbsp;                Client c = clientgui.getBots().get(entity.getOwner().getName());</b>
<b class="nc">&nbsp;                if (c == null) {</b>
<b class="nc">&nbsp;                    c = clientgui.getClient();</b>
&nbsp;                }
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    for (int i = 0; i &lt; e.getCrew().getSlotCount(); i++) {</b>
<b class="nc">&nbsp;                        int[] skills = c.getRandomSkillsGenerator().getRandomSkills(e, true);</b>
<b class="nc">&nbsp;                        e.getCrew().setGunnery(skills[0], i);</b>
<b class="nc">&nbsp;                        e.getCrew().setPiloting(skills[1], i);</b>
<b class="nc">&nbsp;                        if (e.getCrew() instanceof LAMPilot) {</b>
<b class="nc">&nbsp;                            skills = c.getRandomSkillsGenerator().getRandomSkills(e, true);</b>
<b class="nc">&nbsp;                            ((LAMPilot) e.getCrew()).setGunneryAero(skills[0]);</b>
<b class="nc">&nbsp;                            ((LAMPilot) e.getCrew()).setPilotingAero(skills[1]);</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    e.getCrew().sortRandomSkills();</b>
<b class="nc">&nbsp;                    c.sendUpdateEntity(e);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(NAME_COMMAND)) {</b>
<b class="nc">&nbsp;                Client c = clientgui.getBots().get(entity.getOwner().getName());</b>
<b class="nc">&nbsp;                if (c == null) {</b>
<b class="nc">&nbsp;                    c = clientgui.getClient();</b>
&nbsp;                }
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    for (int i = 0; i &lt; e.getCrew().getSlotCount(); i++) {</b>
<b class="nc">&nbsp;                        Gender gender = RandomGenderGenerator.generate();</b>
<b class="nc">&nbsp;                        e.getCrew().setGender(gender, i);</b>
<b class="nc">&nbsp;                        e.getCrew().setName(RandomNameGenerator.getInstance().generate(gender, e.getOwner().getName()), i);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    c.sendUpdateEntity(e);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equals(CALLSIGN_COMMAND)) {</b>
<b class="nc">&nbsp;                Client c = clientgui.getBots().get(entity.getOwner().getName());</b>
<b class="nc">&nbsp;                if (c == null) {</b>
<b class="nc">&nbsp;                    c = clientgui.getClient();</b>
&nbsp;                }
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    for (int i = 0; i &lt; e.getCrew().getSlotCount(); i++) {</b>
<b class="nc">&nbsp;                        e.getCrew().setNickname(RandomCallsignGenerator.getInstance().generate(), i);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    c.sendUpdateEntity(e);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;LOAD&quot;)) {</b>
<b class="nc">&nbsp;                StringTokenizer stLoad = new StringTokenizer(st.nextToken(), &quot;:&quot;);</b>
<b class="nc">&nbsp;                int id = Integer.parseInt(stLoad.nextToken());</b>
<b class="nc">&nbsp;                int bayNumber = Integer.parseInt(stLoad.nextToken());</b>
<b class="nc">&nbsp;                Entity loadingEntity = clientgui.getClient().getEntity(id);</b>
<b class="nc">&nbsp;                boolean loadRear = false;</b>
<b class="nc">&nbsp;                if (stLoad.hasMoreTokens()) {</b>
<b class="nc">&nbsp;                    loadRear = Boolean.parseBoolean(stLoad.nextToken());</b>
&nbsp;                }
&nbsp;
&nbsp;                double capacity;
&nbsp;                boolean hasEnoughCargoCapacity;
<b class="nc">&nbsp;                String errorMessage = &quot;&quot;;</b>
<b class="nc">&nbsp;                if (bayNumber != -1) {</b>
<b class="nc">&nbsp;                    Bay bay = loadingEntity.getBayById(bayNumber);</b>
<b class="nc">&nbsp;                    if (null != bay) {</b>
<b class="nc">&nbsp;                        double loadSize = entities.stream().mapToDouble(bay::spaceForUnit).sum();</b>
<b class="nc">&nbsp;                        capacity = bay.getUnused();</b>
<b class="nc">&nbsp;                        hasEnoughCargoCapacity = loadSize &lt;= capacity;</b>
<b class="nc">&nbsp;                        errorMessage = Messages.getString(&quot;LoadingBay.baytoomany&quot;) + // $NON-NLS-2$</b>
<b class="nc">&nbsp;                                &quot; &quot; + (int) bay.getUnusedSlots()</b>
<b class="nc">&nbsp;                                + bay.getDefaultSlotDescription() + &quot;.&quot;;</b>
&nbsp;                        // We&#39;re also using bay number to distinguish between front and rear locations
&nbsp;                        // for protomech mag clamp systems
<b class="nc">&nbsp;                    } else if (loadingEntity.hasETypeFlag(Entity.ETYPE_MECH)</b>
<b class="nc">&nbsp;                            &amp;&amp; entities.get(0).hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</b>
<b class="nc">&nbsp;                        capacity = 1;</b>
<b class="nc">&nbsp;                        hasEnoughCargoCapacity = entities.size() == 1;</b>
<b class="nc">&nbsp;                        errorMessage = Messages.getString(&quot;LoadingBay.protostoomany&quot;);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        hasEnoughCargoCapacity = false;</b>
<b class="nc">&nbsp;                        errorMessage = Messages.getString(&quot;LoadingBay.bayNumberNotFound&quot;, bayNumber);</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else {</b>
&nbsp;                    HashMap&lt;Long, Double&gt; capacities, counts;
<b class="nc">&nbsp;                    capacities = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                    counts = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                    HashMap&lt;Transporter, Double&gt; potentialLoad = new HashMap&lt;&gt;();</b>
&nbsp;                    // Get the counts and capacities for all present types
<b class="nc">&nbsp;                    for (Entity e : entities) {</b>
<b class="nc">&nbsp;                        long entityType = e.getEntityType();</b>
<b class="nc">&nbsp;                        long loaderType = loadingEntity.getEntityType();</b>
&nbsp;                        double unitSize;
<b class="nc">&nbsp;                        if ((entityType &amp; Entity.ETYPE_MECH) != 0) {</b>
<b class="nc">&nbsp;                            entityType = Entity.ETYPE_MECH;</b>
<b class="nc">&nbsp;                            unitSize = 1;</b>
<b class="nc">&nbsp;                        } else if ((entityType &amp; Entity.ETYPE_INFANTRY) != 0) {</b>
<b class="nc">&nbsp;                            entityType = Entity.ETYPE_INFANTRY;</b>
<b class="nc">&nbsp;                            boolean useCount = true;</b>
<b class="nc">&nbsp;                            if ((loaderType &amp; Entity.ETYPE_TANK) != 0) {</b>
&nbsp;                                // This is a super hack... When getting
&nbsp;                                // capacities, troopspace gives unused space in
&nbsp;                                // terms of tons, and BattleArmorHandles gives
&nbsp;                                // it in terms of unit count. If I call
&nbsp;                                // getUnused, it sums these together, and is
&nbsp;                                // meaningless, so we&#39;ll go through all
&nbsp;                                // transporters....
<b class="nc">&nbsp;                                boolean hasTroopSpace = false;</b>
<b class="nc">&nbsp;                                for (Transporter t : loadingEntity.getTransports()) {</b>
<b class="nc">&nbsp;                                    if (t instanceof TankTrailerHitch) {</b>
<b class="nc">&nbsp;                                        continue;</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                    double loadWeight = e.getWeight();</b>
<b class="nc">&nbsp;                                    if (potentialLoad.containsKey(t)) {</b>
<b class="nc">&nbsp;                                        loadWeight += potentialLoad.get(t);</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                    if (!(t instanceof BattleArmorHandlesTank) &amp;&amp; t.canLoad(e)</b>
<b class="nc">&nbsp;                                            &amp;&amp; (loadWeight &lt;= t.getUnused())) {</b>
<b class="nc">&nbsp;                                        hasTroopSpace = true;</b>
<b class="nc">&nbsp;                                        potentialLoad.put(t, loadWeight);</b>
<b class="nc">&nbsp;                                        break;</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                }</b>
<b class="nc">&nbsp;                                if (hasTroopSpace) {</b>
<b class="nc">&nbsp;                                    useCount = false;</b>
&nbsp;                                }
&nbsp;                            }
&nbsp;                            // TroopSpace uses tonnage
&nbsp;                            // bays and BA handlebars use a count
<b class="nc">&nbsp;                            if (useCount) {</b>
<b class="nc">&nbsp;                                unitSize = 1;</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                unitSize = e.getWeight();</b>
&nbsp;                            }
<b class="nc">&nbsp;                        } else if ((entityType &amp; Entity.ETYPE_PROTOMECH) != 0) {</b>
<b class="nc">&nbsp;                            entityType = Entity.ETYPE_PROTOMECH;</b>
<b class="nc">&nbsp;                            unitSize = 1;</b>
&nbsp;                            // Loading using mag clamps; user can specify front or rear.
&nbsp;                            // Make use of bayNumber field
<b class="nc">&nbsp;                            if ((loaderType &amp; Entity.ETYPE_MECH) != 0) {</b>
<b class="nc">&nbsp;                                bayNumber = loadRear? 1 : 0;</b>
&nbsp;                            }
<b class="nc">&nbsp;                        } else if ((entityType &amp; Entity.ETYPE_DROPSHIP) != 0) {</b>
<b class="nc">&nbsp;                            entityType = Entity.ETYPE_DROPSHIP;</b>
<b class="nc">&nbsp;                            unitSize = 1;</b>
<b class="nc">&nbsp;                        } else if ((entityType &amp; Entity.ETYPE_JUMPSHIP) != 0) {</b>
<b class="nc">&nbsp;                            entityType = Entity.ETYPE_JUMPSHIP;</b>
<b class="nc">&nbsp;                            unitSize = 1;</b>
<b class="nc">&nbsp;                        } else if ((entityType &amp; Entity.ETYPE_AERO) != 0) {</b>
<b class="nc">&nbsp;                            entityType = Entity.ETYPE_AERO;</b>
<b class="nc">&nbsp;                            unitSize = 1;</b>
<b class="nc">&nbsp;                        } else if ((entityType &amp; Entity.ETYPE_TANK) != 0) {</b>
<b class="nc">&nbsp;                            entityType = Entity.ETYPE_TANK;</b>
<b class="nc">&nbsp;                            unitSize = 1;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            unitSize = 1;</b>
&nbsp;                        }
&nbsp;
<b class="nc">&nbsp;                        Double count = counts.get(entityType);</b>
<b class="nc">&nbsp;                        if (count == null) {</b>
<b class="nc">&nbsp;                            count = 0.0;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        count = count + unitSize;</b>
<b class="nc">&nbsp;                        counts.put(entityType, count);</b>
&nbsp;
<b class="nc">&nbsp;                        Double cap = capacities.get(entityType);</b>
<b class="nc">&nbsp;                        if (cap == null) {</b>
<b class="nc">&nbsp;                            cap = loadingEntity.getUnused(e);</b>
<b class="nc">&nbsp;                            capacities.put(entityType, cap);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    hasEnoughCargoCapacity = true;</b>
<b class="nc">&nbsp;                    capacity = 0;</b>
<b class="nc">&nbsp;                    for (Long typeId : counts.keySet()) {</b>
<b class="nc">&nbsp;                        double currCount = counts.get(typeId);</b>
<b class="nc">&nbsp;                        double currCapacity = capacities.get(typeId);</b>
<b class="nc">&nbsp;                        if (currCount &gt; currCapacity) {</b>
<b class="nc">&nbsp;                            hasEnoughCargoCapacity = false;</b>
<b class="nc">&nbsp;                            capacity = currCapacity;</b>
&nbsp;                            String messageName;
<b class="nc">&nbsp;                            if (typeId == Entity.ETYPE_INFANTRY) {</b>
<b class="nc">&nbsp;                                messageName = &quot;LoadingBay.nonbaytoomanyInf&quot;;</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                messageName = &quot;LoadingBay.nonbaytoomany&quot;;</b>
&nbsp;                            }
<b class="nc">&nbsp;                            errorMessage = Messages.getString(messageName, currCount,</b>
<b class="nc">&nbsp;                                    Entity.getEntityTypeName(typeId), currCapacity);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
<b class="nc">&nbsp;                if (hasEnoughCargoCapacity) {</b>
<b class="nc">&nbsp;                    for (Entity e : entities) {</b>
<b class="nc">&nbsp;                        loader(e, id, bayNumber);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    JOptionPane.showMessageDialog(clientgui.frame, errorMessage, Messages.getString(&quot;LoadingBay.error&quot;), // $NON-NLS-2$</b>
&nbsp;                            JOptionPane.ERROR_MESSAGE);
&nbsp;                }
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;UNLOAD&quot;)) {</b>
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    unloader(e);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;UNLOADALL&quot;)) {</b>
<b class="nc">&nbsp;                for (Entity loadee : entity.getLoadedUnits()) {</b>
<b class="nc">&nbsp;                    unloader(loadee);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;UNLOADALLFROMBAY&quot;)) {</b>
<b class="nc">&nbsp;                int id = Integer.parseInt(st.nextToken());</b>
<b class="nc">&nbsp;                Bay bay = entity.getBayById(id);</b>
<b class="nc">&nbsp;                for (Entity loadee : bay.getLoadedUnits()) {</b>
<b class="nc">&nbsp;                    unloader(loadee);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;SQUADRON&quot;)) {</b>
<b class="nc">&nbsp;                Vector&lt;Integer&gt; fighters = new Vector&lt;Integer&gt;();</b>
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    fighters.add(e.getId());</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                if ((!clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                        .booleanOption(OptionsConstants.ADVAERORULES_ALLOW_LARGE_SQUADRONS)</b>
<b class="nc">&nbsp;                        &amp;&amp; (fighters.size() &gt; FighterSquadron.MAX_SIZE))</b>
<b class="nc">&nbsp;                        || (clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                        .booleanOption(OptionsConstants.ADVAERORULES_ALLOW_LARGE_SQUADRONS)</b>
<b class="nc">&nbsp;                        &amp;&amp; (fighters.size() &gt; FighterSquadron.ALTERNATE_MAX_SIZE))) {</b>
<b class="nc">&nbsp;                    JOptionPane.showMessageDialog(clientgui.frame, Messages.getString(&quot;FighterSquadron.toomany&quot;),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;FighterSquadron.error&quot;), JOptionPane.ERROR_MESSAGE); // $NON-NLS-1$</b>
&nbsp;                    // //$NON-NLS-2$
&nbsp;                } else {
<b class="nc">&nbsp;                    loadFS(fighters);</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;SWAP&quot;)) {</b>
<b class="nc">&nbsp;                int id = Integer.parseInt(st.nextToken());</b>
<b class="nc">&nbsp;                swapPilots(entity, id);</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;CHANGE_OWNER&quot;)) {</b>
&nbsp;                // Code to swap entities to a player.
<b class="nc">&nbsp;                int id = Integer.parseInt(st.nextToken());</b>
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    changeEntityOwner(e, id);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;SAVE_QUIRKS_ALL&quot;)) {</b>
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    QuirksHandler.addCustomQuirk(e, false);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;SAVE_QUIRKS_MODEL&quot;)) {</b>
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    QuirksHandler.addCustomQuirk(e, true);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;RAPIDFIREMG_OFF&quot;) || command.equalsIgnoreCase(&quot;RAPIDFIREMG_ON&quot;)) {</b>
<b class="nc">&nbsp;                boolean rapidFire = command.equalsIgnoreCase(&quot;RAPIDFIREMG_ON&quot;);</b>
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    boolean dirty = false;</b>
<b class="nc">&nbsp;                    for (Mounted m : e.getWeaponList()) {</b>
<b class="nc">&nbsp;                        WeaponType wtype = (WeaponType) m.getType();</b>
<b class="nc">&nbsp;                        if (!wtype.hasFlag(WeaponType.F_MG)) {</b>
<b class="nc">&nbsp;                            continue;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        m.setRapidfire(rapidFire);</b>
<b class="nc">&nbsp;                        dirty = true;</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    if (dirty) {</b>
<b class="nc">&nbsp;                        clientgui.getClient().sendUpdateEntity(e);</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;HOTLOAD_OFF&quot;) || command.equalsIgnoreCase(&quot;HOTLOAD_ON&quot;)) {</b>
<b class="nc">&nbsp;                boolean hotLoad = command.equalsIgnoreCase(&quot;HOTLOAD_ON&quot;);</b>
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    boolean dirty = false;</b>
<b class="nc">&nbsp;                    for (Mounted m : e.getWeaponList()) {</b>
<b class="nc">&nbsp;                        WeaponType wtype = (WeaponType) m.getType();</b>
<b class="nc">&nbsp;                        if (!wtype.hasFlag(WeaponType.F_MISSILE)</b>
<b class="nc">&nbsp;                                || (wtype.getAmmoType() != AmmoType.T_LRM)) {</b>
<b class="nc">&nbsp;                            continue;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        m.setHotLoad(hotLoad);</b>
<b class="nc">&nbsp;                        dirty = true;</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    for (Mounted m : e.getAmmo()) {</b>
<b class="nc">&nbsp;                        AmmoType atype = (AmmoType) m.getType();</b>
<b class="nc">&nbsp;                        if (atype.getAmmoType() != AmmoType.T_LRM) {</b>
<b class="nc">&nbsp;                            continue;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        m.setHotLoad(hotLoad);</b>
&nbsp;                        // Set the mode too, so vehicles can switch back
<b class="nc">&nbsp;                        int numModes = m.getType().getModesCount();</b>
<b class="nc">&nbsp;                        for (int i = 0; i &lt; numModes; i++) {</b>
<b class="nc">&nbsp;                            if (m.getType().getMode(i).getName().equals(&quot;HotLoad&quot;)) {</b>
<b class="nc">&nbsp;                                m.setMode(i);</b>
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                        dirty = true;</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    if (dirty) {</b>
<b class="nc">&nbsp;                        clientgui.getClient().sendUpdateEntity(e);</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            } else if (command.equalsIgnoreCase(&quot;SEARCHLIGHT_OFF&quot;) || command.equalsIgnoreCase(&quot;SEARCHLIGHT_ON&quot;)) {</b>
<b class="nc">&nbsp;                boolean searchLight = command.equalsIgnoreCase(&quot;SEARCHLIGHT_ON&quot;);</b>
<b class="nc">&nbsp;                for (Entity e : entities) {</b>
<b class="nc">&nbsp;                    boolean dirty = false;</b>
<b class="nc">&nbsp;                    if (!e.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT)) {</b>
<b class="nc">&nbsp;                        e.setExternalSpotlight(searchLight);</b>
<b class="nc">&nbsp;                        e.setSpotlightState(searchLight);</b>
<b class="nc">&nbsp;                        dirty = true;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (dirty) {</b>
<b class="nc">&nbsp;                        clientgui.getClient().sendUpdateEntity(e);</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void mouseClicked(MouseEvent e) {
<b class="nc">&nbsp;            if (e.getClickCount() == 2) {</b>
<b class="nc">&nbsp;                int row = tableEntities.rowAtPoint(e.getPoint());</b>
<b class="nc">&nbsp;                Entity entity = mekModel.getEntityAt(row);</b>
<b class="nc">&nbsp;                if (entity != null) {</b>
<b class="nc">&nbsp;                    boolean isOwner = entity.getOwner().equals(clientgui.getClient().getLocalPlayer());</b>
<b class="nc">&nbsp;                    boolean isBot = clientgui.getBots().get(entity.getOwner().getName()) != null;</b>
<b class="nc">&nbsp;                    if ((isOwner || isBot)) {</b>
<b class="nc">&nbsp;                        customizeMech(entity);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void mousePressed(MouseEvent e) {
<b class="nc">&nbsp;            maybeShowPopup(e);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void mouseReleased(MouseEvent e) {
<b class="nc">&nbsp;            maybeShowPopup(e);</b>
&nbsp;        }
&nbsp;
&nbsp;        private void maybeShowPopup(MouseEvent e) {
<b class="nc">&nbsp;            JPopupMenu popup = new JPopupMenu();</b>
<b class="nc">&nbsp;            if (tableEntities.getSelectedRowCount() == 0) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            int[] rows = tableEntities.getSelectedRows();</b>
<b class="nc">&nbsp;            int row = tableEntities.getSelectedRow();</b>
<b class="nc">&nbsp;            boolean oneSelected = tableEntities.getSelectedRowCount() == 1;</b>
<b class="nc">&nbsp;            Entity entity = mekModel.getEntityAt(row);</b>
<b class="nc">&nbsp;            Vector&lt;Entity&gt; entities = new Vector&lt;&gt;();</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; rows.length; i++) {</b>
<b class="nc">&nbsp;                entities.add(mekModel.getEntityAt(rows[i]));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (null == entity) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            boolean isOwner = entity.getOwner().equals(clientgui.getClient().getLocalPlayer());</b>
<b class="nc">&nbsp;            boolean isBot = clientgui.getBots().get(entity.getOwner().getName()) != null;</b>
<b class="nc">&nbsp;            boolean blindDrop = clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                    .booleanOption(OptionsConstants.BASE_BLIND_DROP);</b>
<b class="nc">&nbsp;            boolean isQuirksEnabled = clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                    .booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS);</b>
<b class="nc">&nbsp;            boolean isRapidFireMG = clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                    .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_BURST);</b>
<b class="nc">&nbsp;            boolean isHotLoad = clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                    .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_HOTLOAD);</b>
<b class="nc">&nbsp;            boolean isSearchlight = clientgui.getClient().getGame().getPlanetaryConditions()</b>
<b class="nc">&nbsp;                    .getLight() &gt; PlanetaryConditions.L_DUSK;</b>
<b class="nc">&nbsp;            boolean allLoaded = true;</b>
<b class="nc">&nbsp;            boolean allUnloaded = true;</b>
<b class="nc">&nbsp;            boolean allCapFighter = true;</b>
<b class="nc">&nbsp;            boolean allDropships = true;</b>
<b class="nc">&nbsp;            boolean allInfantry = true;</b>
<b class="nc">&nbsp;            boolean allBattleArmor = true;</b>
<b class="nc">&nbsp;            boolean allProtomechs = true;</b>
<b class="nc">&nbsp;            boolean allSameEntityType = true;</b>
<b class="nc">&nbsp;            boolean hasMGs = false;</b>
<b class="nc">&nbsp;            boolean hasSearchlight = false;</b>
<b class="nc">&nbsp;            boolean hasLRMS = false;</b>
<b class="nc">&nbsp;            boolean hasHotLoad = false;</b>
<b class="nc">&nbsp;            boolean hasRapidFireMG = false;</b>
<b class="nc">&nbsp;            boolean sameSide = true;</b>
<b class="nc">&nbsp;            Entity prevEntity = null;</b>
<b class="nc">&nbsp;            int prevOwnerId = -1;</b>
<b class="nc">&nbsp;            for (Entity en : entities) {</b>
<b class="nc">&nbsp;                if (en.getTransportId() == Entity.NONE) {</b>
<b class="nc">&nbsp;                    allLoaded = false;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    allUnloaded = false;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!en.isCapitalFighter(true) || (en instanceof FighterSquadron)) {</b>
<b class="nc">&nbsp;                    allCapFighter = false;</b>
&nbsp;                }
<b class="nc">&nbsp;                if ((prevOwnerId != -1) &amp;&amp; (en.getOwnerId() != prevOwnerId)) {</b>
<b class="nc">&nbsp;                    sameSide = false;</b>
&nbsp;                }
<b class="nc">&nbsp;                prevOwnerId = en.getOwnerId();</b>
<b class="nc">&nbsp;                allDropships &amp;= en.hasETypeFlag(Entity.ETYPE_DROPSHIP);</b>
<b class="nc">&nbsp;                allInfantry &amp;= en.hasETypeFlag(Entity.ETYPE_INFANTRY);</b>
<b class="nc">&nbsp;                allBattleArmor &amp;= en.hasETypeFlag(Entity.ETYPE_BATTLEARMOR);</b>
<b class="nc">&nbsp;                allProtomechs &amp;= en.hasETypeFlag(Entity.ETYPE_PROTOMECH);</b>
<b class="nc">&nbsp;                if ((prevEntity != null) &amp;&amp; !en.getClass().equals(prevEntity.getClass()) &amp;&amp; !allInfantry) {</b>
<b class="nc">&nbsp;                    allSameEntityType = false;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (isRapidFireMG || isHotLoad) {</b>
<b class="nc">&nbsp;                    for (Mounted m : en.getWeaponList()) {</b>
<b class="nc">&nbsp;                        EquipmentType etype = m.getType();</b>
<b class="nc">&nbsp;                        if (etype.hasFlag(WeaponType.F_MG)) {</b>
<b class="nc">&nbsp;                            hasMGs = true;</b>
<b class="nc">&nbsp;                            hasRapidFireMG |= m.isRapidfire();</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (etype.hasFlag(WeaponType.F_MISSILE)) {</b>
<b class="nc">&nbsp;                            hasLRMS |= ((WeaponType) etype).getAmmoType() == AmmoType.T_LRM;</b>
<b class="nc">&nbsp;                            hasHotLoad |= m.isHotLoaded();</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (etype.hasFlag(WeaponType.F_MISSILE)) {</b>
<b class="nc">&nbsp;                            hasLRMS |= ((WeaponType) etype).getAmmoType() == AmmoType.T_LRM_IMP;</b>
<b class="nc">&nbsp;                            hasHotLoad |= m.isHotLoaded();</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
<b class="nc">&nbsp;                boolean hasSearchlightQuirk = isQuirksEnabled &amp;&amp; en.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT);</b>
<b class="nc">&nbsp;                if (!hasSearchlightQuirk) {</b>
<b class="nc">&nbsp;                    hasSearchlight |= en.hasExternaSpotlight();</b>
&nbsp;                }
<b class="nc">&nbsp;                prevEntity = en;</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (e.isPopupTrigger()) {</b>
&nbsp;                // This menu uses the following Mnemonics:
&nbsp;                // B, C, D, E, I, O, R, V
&nbsp;                JMenuItem menuItem;
<b class="nc">&nbsp;                if (oneSelected) {</b>
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;View...&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;VIEW&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    menuItem.setEnabled(isOwner || !blindDrop);</b>
<b class="nc">&nbsp;                    menuItem.setMnemonic(KeyEvent.VK_V);</b>
<b class="nc">&nbsp;                    popup.add(menuItem);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (oneSelected) {</b>
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;Configure...&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;CONFIGURE&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    menuItem.setEnabled(isOwner || isBot);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;Configure all&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;CONFIGURE_ALL&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    menuItem.setEnabled(canConfigureAll(entities));</b>
&nbsp;                }
<b class="nc">&nbsp;                menuItem.setMnemonic(KeyEvent.VK_C);</b>
<b class="nc">&nbsp;                popup.add(menuItem);</b>
&nbsp;
<b class="nc">&nbsp;                if (oneSelected) {</b>
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;Edit Damage...&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;DAMAGE&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    menuItem.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                    menuItem.setMnemonic(KeyEvent.VK_E);</b>
<b class="nc">&nbsp;                    popup.add(menuItem);</b>
&nbsp;                }
&nbsp;
&nbsp;
<b class="nc">&nbsp;                menuItem = new JMenuItem(&quot;Set individual camo&quot;);</b>
<b class="nc">&nbsp;                menuItem.setActionCommand(&quot;INDI_CAMO&quot;);</b>
<b class="nc">&nbsp;                menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                menuItem.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                menuItem.setMnemonic(KeyEvent.VK_I);</b>
<b class="nc">&nbsp;                popup.add(menuItem);</b>
&nbsp;
<b class="nc">&nbsp;                if (oneSelected) {</b>
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;View BV Calculation...&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;BV&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    menuItem.setMnemonic(KeyEvent.VK_B);</b>
<b class="nc">&nbsp;                    popup.add(menuItem);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                menuItem = new JMenuItem(&quot;Delete...&quot;);</b>
<b class="nc">&nbsp;                menuItem.setActionCommand(&quot;DELETE&quot;);</b>
<b class="nc">&nbsp;                menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                menuItem.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                menuItem.setMnemonic(KeyEvent.VK_D);</b>
<b class="nc">&nbsp;                popup.add(menuItem);</b>
&nbsp;
&nbsp;                //region Randomize Submenu
&nbsp;                // This menu uses the following Mnemonic Keys:
&nbsp;                // C, N, S
<b class="nc">&nbsp;                JMenu menu = new JMenu(&quot;Randomize&quot;);</b>
<b class="nc">&nbsp;                menu.setMnemonic(KeyEvent.VK_R);</b>
&nbsp;
<b class="nc">&nbsp;                menuItem = new JMenuItem(&quot;Name&quot;);</b>
<b class="nc">&nbsp;                menuItem.setActionCommand(NAME_COMMAND);</b>
<b class="nc">&nbsp;                menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                menuItem.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                menuItem.setMnemonic(KeyEvent.VK_N);</b>
<b class="nc">&nbsp;                menu.add(menuItem);</b>
&nbsp;
<b class="nc">&nbsp;                menuItem = new JMenuItem(&quot;Callsign&quot;);</b>
<b class="nc">&nbsp;                menuItem.setActionCommand(CALLSIGN_COMMAND);</b>
<b class="nc">&nbsp;                menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                menuItem.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                menuItem.setMnemonic(KeyEvent.VK_C);</b>
<b class="nc">&nbsp;                menu.add(menuItem);</b>
&nbsp;
<b class="nc">&nbsp;                menuItem = new JMenuItem(&quot;Skills&quot;);</b>
<b class="nc">&nbsp;                menuItem.setActionCommand(&quot;SKILLS&quot;);</b>
<b class="nc">&nbsp;                menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                menuItem.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                menuItem.setMnemonic(KeyEvent.VK_S);</b>
<b class="nc">&nbsp;                menu.add(menuItem);</b>
<b class="nc">&nbsp;                popup.add(menu);</b>
&nbsp;                //endregion Randomize Submenu
&nbsp;
&nbsp;                // Change Owner Menu Item
<b class="nc">&nbsp;                menu = new JMenu(Messages.getString(&quot;ChatLounge.ChangeOwner&quot;));</b>
<b class="nc">&nbsp;                menu.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                menu.setMnemonic(KeyEvent.VK_O);</b>
<b class="nc">&nbsp;                Enumeration&lt;IPlayer&gt; players = clientgui.getClient().getPlayers();</b>
<b class="nc">&nbsp;                while (players.hasMoreElements() &amp;&amp; (isOwner || isBot)) {</b>
<b class="nc">&nbsp;                    IPlayer p = players.nextElement();</b>
&nbsp;                    //
<b class="nc">&nbsp;                    if (!entity.getOwner().equals(p)) {</b>
<b class="nc">&nbsp;                        menuItem = new JMenuItem(p.getName());</b>
<b class="nc">&nbsp;                        menuItem.setActionCommand(&quot;CHANGE_OWNER|&quot; + p.getId());</b>
<b class="nc">&nbsp;                        menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                        menuItem.setEnabled((isOwner || isBot));</b>
<b class="nc">&nbsp;                        menu.add(menuItem);</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                popup.add(menu);</b>
&nbsp;
<b class="nc">&nbsp;                if (allUnloaded) {</b>
<b class="nc">&nbsp;                    menu = new JMenu(&quot;Load...&quot;);</b>
<b class="nc">&nbsp;                    JMenu menuDocking = new JMenu(&quot;Dock With...&quot;);</b>
<b class="nc">&nbsp;                    JMenu menuSquadrons = new JMenu(&quot;Join...&quot;);</b>
<b class="nc">&nbsp;                    JMenu menuMounting = new JMenu(&quot;Mount...&quot;);</b>
<b class="nc">&nbsp;                    JMenu menuClamp = new JMenu(&quot;Mag Clamp...&quot;);</b>
<b class="nc">&nbsp;                    JMenu menuLoadAll = new JMenu(&quot;Load All Into&quot;);</b>
<b class="nc">&nbsp;                    boolean canLoad = false;</b>
<b class="nc">&nbsp;                    boolean allHaveMagClamp = true;</b>
<b class="nc">&nbsp;                    for (Entity b : entities) {</b>
<b class="nc">&nbsp;                        if (b.hasETypeFlag(Entity.ETYPE_BATTLEARMOR)</b>
<b class="nc">&nbsp;                                || b.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</b>
<b class="nc">&nbsp;                            allHaveMagClamp &amp;= b.hasWorkingMisc(MiscType.F_MAGNETIC_CLAMP);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    for (Entity loader : clientgui.getClient().getGame().getEntitiesVector()) {</b>
&nbsp;                        // TODO don&#39;t allow capital fighters to load one another
&nbsp;                        // at the moment
<b class="nc">&nbsp;                        if (loader.isCapitalFighter() &amp;&amp; !(loader instanceof FighterSquadron)) {</b>
<b class="nc">&nbsp;                            continue;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        boolean loadable = true;</b>
<b class="nc">&nbsp;                        for (Entity en : entities) {</b>
<b class="nc">&nbsp;                            if (!loader.canLoad(en, false)</b>
<b class="nc">&nbsp;                                    || (loader.getId() == en.getId())</b>
&nbsp;                                    //TODO: support edge case where a support vee with an internal vehicle bay can load trailer internally
<b class="nc">&nbsp;                                    || (loader.canTow(en.getId()))) {</b>
<b class="nc">&nbsp;                                loadable = false;</b>
<b class="nc">&nbsp;                                break;</b>
&nbsp;                            }
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                        if (loadable) {</b>
<b class="nc">&nbsp;                            canLoad = true;</b>
<b class="nc">&nbsp;                            menuItem = new JMenuItem(loader.getShortName());</b>
<b class="nc">&nbsp;                            menuItem.setActionCommand(&quot;LOAD|&quot; + loader.getId() + &quot;:-1&quot;);</b>
<b class="nc">&nbsp;                            menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                            menuItem.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                            menuLoadAll.add(menuItem);</b>
<b class="nc">&nbsp;                            JMenu subMenu = new JMenu(loader.getShortName());</b>
<b class="nc">&nbsp;                            if ((loader instanceof FighterSquadron) &amp;&amp; allCapFighter) {</b>
<b class="nc">&nbsp;                                menuItem = new JMenuItem(&quot;Join &quot; + loader.getShortName());</b>
<b class="nc">&nbsp;                                menuItem.setActionCommand(&quot;LOAD|&quot; + loader.getId() + &quot;:-1&quot;);</b>
<b class="nc">&nbsp;                                menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                                menuItem.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                                menuSquadrons.add(menuItem);</b>
<b class="nc">&nbsp;                            } else if ((loader instanceof Jumpship) &amp;&amp; allDropships) {</b>
<b class="nc">&nbsp;                                int freeCollars = 0;</b>
<b class="nc">&nbsp;                                for (Transporter t : loader.getTransports()) {</b>
<b class="nc">&nbsp;                                    if (t instanceof DockingCollar) {</b>
<b class="nc">&nbsp;                                        freeCollars += t.getUnused();</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                }</b>
<b class="nc">&nbsp;                                menuItem = new JMenuItem(</b>
<b class="nc">&nbsp;                                        loader.getShortName() + &quot; (Free Collars: &quot; + freeCollars + &quot;)&quot;);</b>
<b class="nc">&nbsp;                                menuItem.setActionCommand(&quot;LOAD|&quot; + loader.getId() + &quot;:-1&quot;);</b>
<b class="nc">&nbsp;                                menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                                menuItem.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                                menuDocking.add(menuItem);</b>
<b class="nc">&nbsp;                            } else if (allBattleArmor &amp;&amp; allHaveMagClamp &amp;&amp; !loader.isOmni()</b>
&nbsp;                                    // Only load magclamps if applicable
<b class="nc">&nbsp;                                    &amp;&amp; loader.hasUnloadedClampMount()</b>
&nbsp;                                    // Only choose MagClamps as last option
<b class="nc">&nbsp;                                    &amp;&amp; (loader.getUnused(entities.get(0)) &lt; 2)) {</b>
<b class="nc">&nbsp;                                for (Transporter t : loader.getTransports()) {</b>
<b class="nc">&nbsp;                                    if ((t instanceof ClampMountMech) || (t instanceof ClampMountTank)) {</b>
<b class="nc">&nbsp;                                        menuItem = new JMenuItem(&quot;Onto &quot; + loader.getShortName());</b>
<b class="nc">&nbsp;                                        menuItem.setActionCommand(&quot;LOAD|&quot; + loader.getId() + &quot;:-1&quot;);</b>
<b class="nc">&nbsp;                                        menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                                        menuItem.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                                        menuClamp.add(menuItem);</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                }</b>
<b class="nc">&nbsp;                            } else if (allProtomechs &amp;&amp; allHaveMagClamp</b>
<b class="nc">&nbsp;                                    &amp;&amp; loader.hasETypeFlag(Entity.ETYPE_MECH)) {</b>
<b class="nc">&nbsp;                                Transporter front = null;</b>
<b class="nc">&nbsp;                                Transporter rear = null;</b>
<b class="nc">&nbsp;                                for (Transporter t : loader.getTransports()) {</b>
<b class="nc">&nbsp;                                    if (t instanceof ProtomechClampMount) {</b>
<b class="nc">&nbsp;                                        if (((ProtomechClampMount) t).isRear()) {</b>
<b class="nc">&nbsp;                                            rear = t;</b>
&nbsp;                                        } else {
<b class="nc">&nbsp;                                            front = t;</b>
&nbsp;                                        }
&nbsp;                                    }
<b class="nc">&nbsp;                                }</b>
<b class="nc">&nbsp;                                Entity en = entities.firstElement();</b>
<b class="nc">&nbsp;                                if ((front != null) &amp;&amp; front.canLoad(en)</b>
<b class="nc">&nbsp;                                        &amp;&amp; ((en.getWeightClass() &lt; EntityWeightClass.WEIGHT_SUPER_HEAVY)</b>
<b class="nc">&nbsp;                                        || (rear == null) || rear.getLoadedUnits().isEmpty())) {</b>
<b class="nc">&nbsp;                                    menuItem = new JMenuItem(&quot;Onto Front&quot;);</b>
<b class="nc">&nbsp;                                    menuItem.setActionCommand(&quot;LOAD|&quot; + loader.getId() + &quot;:0&quot;);</b>
<b class="nc">&nbsp;                                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                                    menuItem.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                                    subMenu.add(menuItem);</b>
&nbsp;                                }
<b class="nc">&nbsp;                                boolean frontUltra = (front != null)</b>
<b class="nc">&nbsp;                                        &amp;&amp; front.getLoadedUnits().stream()</b>
<b class="nc">&nbsp;                                        .anyMatch(l -&gt; l.getWeightClass() == EntityWeightClass.WEIGHT_SUPER_HEAVY);</b>
<b class="nc">&nbsp;                                if ((rear != null) &amp;&amp; rear.canLoad(en) &amp;&amp; !frontUltra) {</b>
<b class="nc">&nbsp;                                    menuItem = new JMenuItem(&quot;Onto Rear&quot;);</b>
<b class="nc">&nbsp;                                    menuItem.setActionCommand(&quot;LOAD|&quot; + loader.getId() + &quot;:1&quot;);</b>
<b class="nc">&nbsp;                                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                                    menuItem.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                                    subMenu.add(menuItem);</b>
&nbsp;                                }
<b class="nc">&nbsp;                                if (subMenu.getItemCount() &gt; 0) {</b>
<b class="nc">&nbsp;                                    menuClamp.add(subMenu);</b>
&nbsp;                                }
<b class="nc">&nbsp;                            } else if (allInfantry) {</b>
<b class="nc">&nbsp;                                menuItem = new JMenuItem(loader.getShortName());</b>
<b class="nc">&nbsp;                                menuItem.setActionCommand(&quot;LOAD|&quot; + loader.getId() + &quot;:-1&quot;);</b>
<b class="nc">&nbsp;                                menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                                menuItem.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                                menuMounting.add(menuItem);</b>
&nbsp;                            }
<b class="nc">&nbsp;                            Entity en = entities.firstElement();</b>
<b class="nc">&nbsp;                            if (allSameEntityType &amp;&amp; !allDropships) {</b>
<b class="nc">&nbsp;                                for (Transporter t : loader.getTransports()) {</b>
<b class="nc">&nbsp;                                    if (t.canLoad(en)) {</b>
<b class="nc">&nbsp;                                        if (t instanceof Bay) {</b>
<b class="nc">&nbsp;                                            Bay bay = (Bay) t;</b>
<b class="nc">&nbsp;                                            menuItem = new JMenuItem(&quot;Into Bay #&quot; + bay.getBayNumber() + &quot; (Free &quot;</b>
&nbsp;                                                    + &quot;Slots: &quot;
<b class="nc">&nbsp;                                                    + (int) loader.getBayById(bay.getBayNumber()).getUnusedSlots()</b>
<b class="nc">&nbsp;                                                    + loader.getBayById(bay.getBayNumber()).getDefaultSlotDescription()</b>
&nbsp;                                                    + &quot;)&quot;);
<b class="nc">&nbsp;                                            menuItem.setActionCommand(</b>
<b class="nc">&nbsp;                                                    &quot;LOAD|&quot; + loader.getId() + &quot;:&quot; + bay.getBayNumber());</b>
&nbsp;                                            /*
&nbsp;                                             * } else { menuItem = new
&nbsp;                                             * JMenuItem(
&nbsp;                                             * t.getClass().getName()+
&nbsp;                                             * &quot;Transporter&quot; );
&nbsp;                                             * menuItem.setActionCommand(&quot;LOAD|&quot;
&nbsp;                                             * + loader.getId() + &quot;:-1&quot;); }
&nbsp;                                             */
<b class="nc">&nbsp;                                            menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                                            menuItem.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                                            subMenu.add(menuItem);</b>
&nbsp;                                        }
&nbsp;                                    }
<b class="nc">&nbsp;                                }</b>
<b class="nc">&nbsp;                                if (subMenu.getMenuComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;                                    menu.add(subMenu);</b>
&nbsp;                                }
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    if (canLoad) {</b>
<b class="nc">&nbsp;                        if (menu.getMenuComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;                            menu.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                            MenuScroller.createScrollBarsOnMenus(menu);</b>
<b class="nc">&nbsp;                            popup.add(menu);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (menuDocking.getMenuComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;                            menuDocking.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                            MenuScroller.createScrollBarsOnMenus(menuDocking);</b>
<b class="nc">&nbsp;                            popup.add(menuDocking);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (menuSquadrons.getMenuComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;                            menuSquadrons.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                            MenuScroller.createScrollBarsOnMenus(menuSquadrons);</b>
<b class="nc">&nbsp;                            popup.add(menuSquadrons);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (menuMounting.getMenuComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;                            menuMounting.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                            MenuScroller.createScrollBarsOnMenus(menuMounting);</b>
<b class="nc">&nbsp;                            popup.add(menuMounting);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (menuClamp.getMenuComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;                            menuClamp.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                            MenuScroller.createScrollBarsOnMenus(menuClamp);</b>
<b class="nc">&nbsp;                            popup.add(menuClamp);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        boolean hasMounting = menuMounting.getMenuComponentCount() &gt; 0;</b>
<b class="nc">&nbsp;                        boolean hasSquadrons = menuSquadrons.getMenuComponentCount() &gt; 0;</b>
<b class="nc">&nbsp;                        boolean hasDocking = menuDocking.getMenuComponentCount() &gt; 0;</b>
<b class="nc">&nbsp;                        boolean hasLoad = menu.getMenuComponentCount() &gt; 0;</b>
<b class="nc">&nbsp;                        boolean hasClamp = menuClamp.getMenuComponentCount() &gt; 0;</b>
<b class="nc">&nbsp;                        if ((menuLoadAll.getMenuComponentCount() &gt; 0)</b>
&nbsp;                                &amp;&amp; !(hasMounting || hasSquadrons || hasDocking || hasLoad || hasClamp)) {
<b class="nc">&nbsp;                            menuLoadAll.setEnabled((isOwner || isBot) &amp;&amp; allUnloaded);</b>
<b class="nc">&nbsp;                            MenuScroller.createScrollBarsOnMenus(menuLoadAll);</b>
<b class="nc">&nbsp;                            popup.add(menuLoadAll);</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                } else if (allLoaded) {</b>
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;Unload&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;UNLOAD&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    menuItem.setEnabled((isOwner || isBot) &amp;&amp; allLoaded);</b>
<b class="nc">&nbsp;                    popup.add(menuItem);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (oneSelected &amp;&amp; (entity.getLoadedUnits().size() &gt; 0)) {</b>
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;Unload All Carried Units&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;UNLOADALL&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    menuItem.setEnabled((isOwner || isBot));</b>
<b class="nc">&nbsp;                    popup.add(menuItem);</b>
<b class="nc">&nbsp;                    JMenu subMenu = new JMenu(&quot;Unload All From...&quot;);</b>
<b class="nc">&nbsp;                    for (Bay bay : entity.getTransportBays()) {</b>
<b class="nc">&nbsp;                        if (bay.getLoadedUnits().size() &gt; 0) {</b>
<b class="nc">&nbsp;                            menuItem = new JMenuItem(</b>
<b class="nc">&nbsp;                                    &quot;Bay # &quot; + bay.getBayNumber() + &quot; (&quot; + bay.getLoadedUnits().size() + &quot; units)&quot;);</b>
<b class="nc">&nbsp;                            menuItem.setActionCommand(&quot;UNLOADALLFROMBAY|&quot; + bay.getBayNumber());</b>
<b class="nc">&nbsp;                            menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                            menuItem.setEnabled((isOwner || isBot));</b>
<b class="nc">&nbsp;                            subMenu.add(menuItem);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    if (subMenu.getItemCount() &gt; 0) {</b>
<b class="nc">&nbsp;                        subMenu.setEnabled((isOwner || isBot));</b>
<b class="nc">&nbsp;                        popup.add(subMenu);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (allCapFighter &amp;&amp; allUnloaded &amp;&amp; sameSide) {</b>
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;Start Fighter Squadron&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;SQUADRON&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    menuItem.setEnabled((isOwner || isBot) &amp;&amp; allCapFighter);</b>
<b class="nc">&nbsp;                    popup.add(menuItem);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (oneSelected) {</b>
<b class="nc">&nbsp;                    menu = new JMenu(&quot;Swap pilots with&quot;);</b>
<b class="nc">&nbsp;                    boolean canSwap = false;</b>
<b class="nc">&nbsp;                    for (Entity swapper : clientgui.getClient().getGame().getEntitiesVector()) {</b>
<b class="nc">&nbsp;                        if (swapper.isCapitalFighter()) {</b>
<b class="nc">&nbsp;                            continue;</b>
&nbsp;                        }
&nbsp;                        // only swap your own pilots and with the same unit and crew type
<b class="nc">&nbsp;                        if ((swapper.getOwnerId() == entity.getOwnerId()) &amp;&amp; (swapper.getId() != entity.getId())</b>
<b class="nc">&nbsp;                                &amp;&amp; (swapper.getUnitType() == entity.getUnitType())</b>
<b class="nc">&nbsp;                                &amp;&amp; swapper.getCrew().getCrewType() == entity.getCrew().getCrewType()) {</b>
<b class="nc">&nbsp;                            canSwap = true;</b>
<b class="nc">&nbsp;                            menuItem = new JMenuItem(swapper.getShortName());</b>
<b class="nc">&nbsp;                            menuItem.setActionCommand(&quot;SWAP|&quot; + swapper.getId());</b>
<b class="nc">&nbsp;                            menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                            menuItem.setEnabled((isOwner || isBot));</b>
<b class="nc">&nbsp;                            menu.add(menuItem);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    if (canSwap) {</b>
<b class="nc">&nbsp;                        menu.setEnabled((isOwner || isBot) &amp;&amp; canSwap);</b>
<b class="nc">&nbsp;                        popup.add(menu);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
&nbsp;                // Set Rapid Fire MGs
<b class="nc">&nbsp;                if (isRapidFireMG || isHotLoad || isSearchlight) {</b>
<b class="nc">&nbsp;                    menu = new JMenu(Messages.getString(&quot;ChatLounge.Equipment&quot;));</b>
<b class="nc">&nbsp;                    if (isRapidFireMG &amp;&amp; hasMGs) {</b>
<b class="nc">&nbsp;                        if (hasRapidFireMG) {</b>
<b class="nc">&nbsp;                            menuItem = new JMenuItem(Messages.getString(&quot;ChatLounge.RapidFireToggleOff&quot;));</b>
<b class="nc">&nbsp;                            menuItem.setActionCommand(&quot;RAPIDFIREMG_OFF&quot;);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            menuItem = new JMenuItem(Messages.getString(&quot;ChatLounge.RapidFireToggleOn&quot;));</b>
<b class="nc">&nbsp;                            menuItem.setActionCommand(&quot;RAPIDFIREMG_ON&quot;);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                        menuItem.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                        menu.add(menuItem);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (isHotLoad &amp;&amp; hasLRMS) {</b>
<b class="nc">&nbsp;                        if (hasHotLoad) {</b>
<b class="nc">&nbsp;                            menuItem = new JMenuItem(Messages.getString(&quot;ChatLounge.HotLoadToggleOff&quot;));</b>
<b class="nc">&nbsp;                            menuItem.setActionCommand(&quot;HOTLOAD_OFF&quot;);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            menuItem = new JMenuItem(Messages.getString(&quot;ChatLounge.HotLoadToggleOn&quot;));</b>
<b class="nc">&nbsp;                            menuItem.setActionCommand(&quot;HOTLOAD_ON&quot;);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                        menuItem.setEnabled(isOwner || isBot);</b>
<b class="nc">&nbsp;                        menu.add(menuItem);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (isSearchlight) {</b>
<b class="nc">&nbsp;                        if (hasSearchlight) {</b>
<b class="nc">&nbsp;                            menuItem = new JMenuItem(Messages.getString(&quot;ChatLounge.SearchlightToggleOff&quot;));</b>
<b class="nc">&nbsp;                            menuItem.setActionCommand(&quot;SEARCHLIGHT_OFF&quot;);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            menuItem = new JMenuItem(Messages.getString(&quot;ChatLounge.SearchlightToggleOn&quot;));</b>
<b class="nc">&nbsp;                            menuItem.setActionCommand(&quot;SEARCHLIGHT_ON&quot;);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                        boolean loneEntityWithQuirk = oneSelected &amp;&amp; isQuirksEnabled</b>
<b class="nc">&nbsp;                                &amp;&amp; entity.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT);</b>
<b class="nc">&nbsp;                        menuItem.setEnabled((isOwner || isBot) &amp;&amp; !loneEntityWithQuirk);</b>
<b class="nc">&nbsp;                        menu.add(menuItem);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (menu.getMenuComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;                        popup.add(menu);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (isQuirksEnabled) {</b>
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;Save Quirks for Chassis&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;SAVE_QUIRKS_ALL&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    popup.add(menuItem);</b>
<b class="nc">&nbsp;                    menuItem = new JMenuItem(&quot;Save Quirks for Chassis/Model&quot;);</b>
<b class="nc">&nbsp;                    menuItem.setActionCommand(&quot;SAVE_QUIRKS_MODEL&quot;);</b>
<b class="nc">&nbsp;                    menuItem.addActionListener(this);</b>
<b class="nc">&nbsp;                    popup.add(menuItem);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                popup.show(e.getComponent(), e.getX(), e.getY());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    public static class MekInfo extends JPanel {
&nbsp;        private static final long serialVersionUID = -7337823041775639463L;
&nbsp;
&nbsp;        private JLabel lblImage;
&nbsp;        private JLabel lblLoad;
&nbsp;
<b class="nc">&nbsp;        public MekInfo() {</b>
&nbsp;
<b class="nc">&nbsp;            lblImage = new JLabel();</b>
<b class="nc">&nbsp;            lblLoad = new JLabel();</b>
&nbsp;
<b class="nc">&nbsp;            GridBagLayout gridbag = new GridBagLayout();</b>
<b class="nc">&nbsp;            GridBagConstraints c = new GridBagConstraints();</b>
<b class="nc">&nbsp;            setLayout(gridbag);</b>
&nbsp;
<b class="nc">&nbsp;            c.fill = GridBagConstraints.NONE;</b>
<b class="nc">&nbsp;            c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;            c.gridx = 0;</b>
<b class="nc">&nbsp;            c.gridy = 0;</b>
<b class="nc">&nbsp;            c.weightx = 0.0;</b>
<b class="nc">&nbsp;            c.weighty = 0.0;</b>
<b class="nc">&nbsp;            c.gridwidth = 1;</b>
<b class="nc">&nbsp;            c.gridheight = 1;</b>
<b class="nc">&nbsp;            c.anchor = GridBagConstraints.CENTER;</b>
<b class="nc">&nbsp;            gridbag.setConstraints(lblLoad, c);</b>
<b class="nc">&nbsp;            add(lblLoad);</b>
&nbsp;
<b class="nc">&nbsp;            c.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;            c.insets = new Insets(1, 1, 1, 1);</b>
<b class="nc">&nbsp;            c.gridx = 1;</b>
<b class="nc">&nbsp;            c.gridy = 0;</b>
<b class="nc">&nbsp;            c.weightx = 1.0;</b>
<b class="nc">&nbsp;            c.weighty = 1.0;</b>
<b class="nc">&nbsp;            c.gridwidth = 1;</b>
<b class="nc">&nbsp;            c.gridheight = 1;</b>
<b class="nc">&nbsp;            c.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;            gridbag.setConstraints(lblImage, c);</b>
<b class="nc">&nbsp;            add(lblImage);</b>
&nbsp;
<b class="nc">&nbsp;            lblImage.setBorder(BorderFactory.createEmptyBorder());</b>
&nbsp;        }
&nbsp;
&nbsp;        public void setText(String s, boolean isSelected) {
<b class="nc">&nbsp;            lblImage.setText(String.format(&quot;&lt;html&gt;%s&lt;/html&gt;&quot;, s));</b>
&nbsp;        }
&nbsp;
&nbsp;        public void clearImage() {
<b class="nc">&nbsp;            lblImage.setIcon(null);</b>
&nbsp;        }
&nbsp;
&nbsp;        public void setImage(Image img) {
<b class="nc">&nbsp;            lblImage.setIcon(new ImageIcon(img));</b>
&nbsp;        }
&nbsp;
&nbsp;        public JLabel getLabel() {
<b class="nc">&nbsp;            return lblImage;</b>
&nbsp;        }
&nbsp;
&nbsp;        public void setLoad(boolean load) {
&nbsp;            // if this is a loaded unit then do something with lblLoad to make
&nbsp;            // it show up
&nbsp;            // otherwise clear lblLoad
<b class="nc">&nbsp;            if (load) {</b>
<b class="nc">&nbsp;                lblLoad.setText(&quot; +&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                lblLoad.setText(&quot;&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
