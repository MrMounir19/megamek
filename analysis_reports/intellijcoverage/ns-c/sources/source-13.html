


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ChatterBox2</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ui.swing</a>
</div>

<h1>Coverage Summary for Class: ChatterBox2 (megamek.client.ui.swing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ChatterBox2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/39)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/409)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ChatterBox2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatterBox2$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/46)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/423)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek - Copyright (C) 2000-2002 Ben Mazur (bmazur@sev.org)
&nbsp; * Copyright © 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;
&nbsp;package megamek.client.ui.swing;
&nbsp;
&nbsp;import java.awt.Color;
&nbsp;import java.awt.Dimension;
&nbsp;import java.awt.Font;
&nbsp;import java.awt.FontMetrics;
&nbsp;import java.awt.Graphics;
&nbsp;import java.awt.Image;
&nbsp;import java.awt.Point;
&nbsp;import java.awt.Rectangle;
&nbsp;import java.awt.Toolkit;
&nbsp;import java.awt.datatransfer.DataFlavor;
&nbsp;import java.awt.datatransfer.Transferable;
&nbsp;import java.awt.datatransfer.UnsupportedFlavorException;
&nbsp;import java.awt.event.KeyEvent;
&nbsp;import java.awt.event.KeyListener;
&nbsp;import java.io.IOException;
&nbsp;import java.util.Enumeration;
&nbsp;import java.util.Vector;
&nbsp;
&nbsp;import megamek.client.Client;
&nbsp;import megamek.client.ui.IBoardView;
&nbsp;import megamek.client.ui.IDisplayable;
&nbsp;import megamek.client.ui.swing.boardview.BoardView1;
&nbsp;import megamek.client.ui.swing.util.CommandAction;
&nbsp;import megamek.client.ui.swing.util.KeyCommandBind;
&nbsp;import megamek.client.ui.swing.util.MegaMekController;
&nbsp;import megamek.client.ui.swing.widget.PMUtil;
&nbsp;import megamek.common.Configuration;
&nbsp;import megamek.common.event.GameEntityChangeEvent;
&nbsp;import megamek.common.event.GameEntityNewEvent;
&nbsp;import megamek.common.event.GameListenerAdapter;
&nbsp;import megamek.common.event.GamePlayerChatEvent;
&nbsp;import megamek.common.preference.PreferenceManager;
&nbsp;import megamek.common.util.fileUtils.MegaMekFile;
&nbsp;import megamek.common.util.StringUtil;
&nbsp;
&nbsp;/**
&nbsp; *  A graphical chatterbox within the boardview.
&nbsp; * @author beerockxs2
&nbsp; *
&nbsp; */
<b class="nc">&nbsp;public class ChatterBox2 implements KeyListener, IDisplayable {</b>
&nbsp;
&nbsp;    private static final String FILENAME_BUTTON_UP = &quot;upbutton.gif&quot;; //$NON-NLS-1$
&nbsp;    private static final String FILENAME_BUTTON_DOWN = &quot;downbutton.gif&quot;; //$NON-NLS-1$
&nbsp;    private static final String FILENAME_BUTTON_MINIMISE = &quot;minbutton.gif&quot;; //$NON-NLS-1$
&nbsp;    private static final String FILENAME_BUTTON_MAXIMISE = &quot;maxbutton.gif&quot;; //$NON-NLS-1$
&nbsp;    private static final String FILENAME_BUTTON_RESIZE = &quot;resizebutton.gif&quot;; //$NON-NLS-1$
<b class="nc">&nbsp;    private static final Font FONT_CHAT = new Font(&quot;SansSerif&quot;, Font.BOLD, GUIPreferences.getInstance().getInt(&quot;AdvancedChatbox2Fontsize&quot;));  //$NON-NLS-2$</b>
<b class="nc">&nbsp;    private static final Color COLOR_TEXT_BACK = Color.black;</b>
<b class="nc">&nbsp;    private static final Color COLOR_TEXT_FRONT = Color.white;</b>
&nbsp;    private static final Color COLOR_BACKGROUND;
&nbsp;    private ChatterBox cb;
&nbsp;
&nbsp;    static {
&nbsp;        Color temp;
&nbsp;        try {
<b class="nc">&nbsp;            temp = GUIPreferences.getInstance().getColor(&quot;AdvancedChatbox2BackColor&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            temp = new Color(temp.getRed(), temp.getGreen(), temp.getBlue(), GUIPreferences.getInstance().getInt(&quot;AdvancedChatbox2Transparancy&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        } catch (Throwable err) {</b>
<b class="nc">&nbsp;            temp = Color.gray;</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        COLOR_BACKGROUND = temp;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static final int SLIDING_SPEED = 5;
&nbsp;    private static final int MIN_SLIDE_OFFSET = 0;
&nbsp;
&nbsp;    private static final int DIST_BOTTOM = 0;
&nbsp;    private static final int DIST_SIDE = 5;
&nbsp;
&nbsp;    private static final long MAX_IDLE_TIME = 10000;
&nbsp;
<b class="nc">&nbsp;    private int height = 150;</b>
<b class="nc">&nbsp;    private int width = 400;</b>
<b class="nc">&nbsp;    private int max_nbr_rows = 7;</b>
&nbsp;
<b class="nc">&nbsp;    private boolean isHit = false;</b>
<b class="nc">&nbsp;    private boolean resizing = false;</b>
<b class="nc">&nbsp;    private boolean scrolling = false;</b>
<b class="nc">&nbsp;    private boolean increasedChatScroll = false;</b>
<b class="nc">&nbsp;    private boolean decreasedChatScroll = false;</b>
<b class="nc">&nbsp;    private boolean overTheTop = false;</b>
<b class="nc">&nbsp;    private boolean underTheBottom = false;</b>
<b class="nc">&nbsp;    private boolean slidingDown = false;</b>
<b class="nc">&nbsp;    private boolean slidingUp = false;</b>
<b class="nc">&nbsp;    private boolean lockOpen = false;</b>
<b class="nc">&nbsp;    private int chatScroll = 0;</b>
&nbsp;    private int scrollBarHeight;
&nbsp;    private int scrollBarOffset;
<b class="nc">&nbsp;    private int slideOffset = 0;</b>
<b class="nc">&nbsp;    private long idleTime = 0;</b>
&nbsp;    private float scrollBarStep;
&nbsp;    private float scrollBarDragPos;
<b class="nc">&nbsp;    private String message = &quot;&quot;;</b>
<b class="nc">&nbsp;    private String visibleMessage = &quot;&quot;;</b>
&nbsp;
&nbsp;    private Point lastScrollPoint;
&nbsp;
<b class="nc">&nbsp;    private Vector&lt;String&gt; messages = new Vector&lt;String&gt;();</b>
&nbsp;
&nbsp;    private Client client;
&nbsp;    private BoardView1 bv;
&nbsp;
&nbsp;    private Image upbutton;
&nbsp;    private Image downbutton;
&nbsp;    private Image maxbutton;
&nbsp;    private Image minbutton;
&nbsp;    private Image resizebutton;
&nbsp;
&nbsp;    private FontMetrics fm;
&nbsp;
&nbsp;    public ChatterBox2(ClientGUI client, IBoardView boardview,
<b class="nc">&nbsp;            MegaMekController controller) {</b>
<b class="nc">&nbsp;        this.client = client.getClient();</b>
<b class="nc">&nbsp;        client.getClient().getGame().addGameListener(new GameListenerAdapter() {</b>
&nbsp;            @Override
&nbsp;            public void gamePlayerChat(GamePlayerChatEvent e) {
<b class="nc">&nbsp;                addChatMessage(e.getMessage());</b>
&nbsp;            }
&nbsp;            @Override
&nbsp;            public void gameEntityNew(GameEntityNewEvent e) {
<b class="nc">&nbsp;                if (PreferenceManager.getClientPreferences()</b>
<b class="nc">&nbsp;                        .getPrintEntityChange()) {</b>
<b class="nc">&nbsp;                    addChatMessage(&quot;MegaMek: &quot; + e.getNumberOfEntities() + </b>
&nbsp;                            &quot; Entities added.&quot;);
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void gameEntityChange(GameEntityChangeEvent e) {
<b class="nc">&nbsp;                if (PreferenceManager.getClientPreferences()</b>
<b class="nc">&nbsp;                        .getPrintEntityChange()) {</b>
<b class="nc">&nbsp;                    addChatMessage(&quot;Megamek: &quot; + e.toString());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        bv = (BoardView1)boardview;</b>
<b class="nc">&nbsp;        fm = bv.getFontMetrics(FONT_CHAT);</b>
&nbsp;
<b class="nc">&nbsp;        Toolkit toolkit = bv.getToolkit();</b>
<b class="nc">&nbsp;        upbutton = toolkit.getImage(new MegaMekFile(Configuration.widgetsDir(), </b>
<b class="nc">&nbsp;                FILENAME_BUTTON_UP).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(upbutton, client);</b>
<b class="nc">&nbsp;        downbutton = toolkit.getImage(new MegaMekFile(Configuration.widgetsDir(), </b>
<b class="nc">&nbsp;                FILENAME_BUTTON_DOWN).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(downbutton, client);</b>
<b class="nc">&nbsp;        minbutton = toolkit.getImage(new MegaMekFile(Configuration.widgetsDir(), </b>
<b class="nc">&nbsp;                FILENAME_BUTTON_MINIMISE).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(minbutton, client);</b>
<b class="nc">&nbsp;        maxbutton = toolkit.getImage(new MegaMekFile(Configuration.widgetsDir(), </b>
<b class="nc">&nbsp;                FILENAME_BUTTON_MAXIMISE).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(maxbutton, client);</b>
<b class="nc">&nbsp;        resizebutton = toolkit.getImage(new MegaMekFile(Configuration.widgetsDir(), </b>
<b class="nc">&nbsp;                FILENAME_BUTTON_RESIZE).toString());</b>
<b class="nc">&nbsp;        PMUtil.setImage(resizebutton, client);</b>
&nbsp;
<b class="nc">&nbsp;        registerKeyboardCommands(controller);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void registerKeyboardCommands(MegaMekController controller) {
<b class="nc">&nbsp;        if (controller == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Register the action for CLEAR
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.CANCEL.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (!bv.getChatterBoxActive()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        clearMessage();</b>
<b class="nc">&nbsp;                        slideDown();</b>
&nbsp;                    }
&nbsp;                });
&nbsp;    }
&nbsp;
&nbsp;    public boolean isReleased() {
<b class="nc">&nbsp;        if (scrolling) {</b>
<b class="nc">&nbsp;            stopScrolling();</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (resizing) {</b>
<b class="nc">&nbsp;            stopScrolling();</b>
<b class="nc">&nbsp;            resizing = false;</b>
<b class="nc">&nbsp;            lockOpen = false;</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (isHit){</b>
<b class="nc">&nbsp;            isHit = false;</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }            
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isSliding() {
<b class="nc">&nbsp;        return slidingDown || slidingUp;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void slideUp() {
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        slidingUp = true;</b>
<b class="nc">&nbsp;        slidingDown = false;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void slideDown() {
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        slidingUp = false;</b>
<b class="nc">&nbsp;        slidingDown = true;</b>
<b class="nc">&nbsp;        bv.setChatterBoxActive(false);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void stopSliding() {
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        slidingUp = false;</b>
<b class="nc">&nbsp;        slidingDown = false;</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isDown() {
<b class="nc">&nbsp;        return !isSliding() &amp;&amp; (slideOffset == getMaxSlideOffset());</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isUp() {
<b class="nc">&nbsp;        return !isSliding() &amp;&amp; (slideOffset == MIN_SLIDE_OFFSET);</b>
&nbsp;    }
&nbsp;
&nbsp;    public synchronized void setIdleTime(long timeIdle, boolean add) {
<b class="nc">&nbsp;        if (!lockOpen) {</b>
<b class="nc">&nbsp;            if (add) {</b>
<b class="nc">&nbsp;                idleTime += timeIdle;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                idleTime = timeIdle;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if ((idleTime &gt; MAX_IDLE_TIME) &amp;&amp; !isSliding() &amp;&amp; </b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance().getBoolean(</b>
&nbsp;                            &quot;AdvancedChatbox2AutoSlidedown&quot;)) {
<b class="nc">&nbsp;                slideDown();</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void pageUp() {
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        if (!(chatScroll &gt;= (messages.size() - max_nbr_rows - (max_nbr_rows - 1)))) {</b>
<b class="nc">&nbsp;            chatScroll += max_nbr_rows - 1;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            chatScroll = messages.size() - max_nbr_rows;</b>
&nbsp;        }
<b class="nc">&nbsp;        computeScrollBarOffset();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void pageDown() {
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        if (chatScroll &gt; (max_nbr_rows - 1)) {</b>
<b class="nc">&nbsp;            chatScroll -= max_nbr_rows - 1;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            chatScroll = 0;</b>
&nbsp;        }
<b class="nc">&nbsp;        computeScrollBarOffset();</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean slide() {
<b class="nc">&nbsp;        if (slidingDown) {</b>
<b class="nc">&nbsp;            if (slideOffset &lt; getMaxSlideOffset()) {</b>
<b class="nc">&nbsp;                slideOffset += SLIDING_SPEED;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                stopSliding();</b>
&nbsp;            }
<b class="nc">&nbsp;            slideOffset = Math.min(slideOffset, getMaxSlideOffset());</b>
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } else if (slidingUp) {</b>
<b class="nc">&nbsp;            if (slideOffset &gt; MIN_SLIDE_OFFSET) {</b>
<b class="nc">&nbsp;                slideOffset -= SLIDING_SPEED;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                stopSliding();</b>
&nbsp;            }
<b class="nc">&nbsp;            slideOffset = Math.max(slideOffset, MIN_SLIDE_OFFSET);</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void stopScrolling() {
<b class="nc">&nbsp;        scrollBarDragPos = 0;</b>
<b class="nc">&nbsp;        lastScrollPoint = null;</b>
<b class="nc">&nbsp;        scrolling = false;</b>
<b class="nc">&nbsp;        computeScrollBarOffset();</b>
<b class="nc">&nbsp;        bv.refreshDisplayables();</b>
<b class="nc">&nbsp;        increasedChatScroll = false;</b>
<b class="nc">&nbsp;        decreasedChatScroll = false;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isDragged(Point p, Dimension size) {
<b class="nc">&nbsp;        if (scrolling) {</b>
<b class="nc">&nbsp;            scroll(p, size);</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (resizing) {</b>
<b class="nc">&nbsp;            resize(p, size);</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        int xMin = DIST_SIDE;</b>
<b class="nc">&nbsp;        int xMax = xMin + width;</b>
<b class="nc">&nbsp;        int yMin = ((size.height) - height - DIST_BOTTOM) + slideOffset;</b>
<b class="nc">&nbsp;        int yMax = yMin + height;</b>
&nbsp;
<b class="nc">&nbsp;        boolean mouseOver = (p.x &gt; xMin) &amp;&amp; (p.x &lt; xMax) &amp;&amp; (p.y &gt; yMin)</b>
&nbsp;                &amp;&amp; (p.y &lt; yMax);
<b class="nc">&nbsp;        return mouseOver;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isBeingDragged() {
<b class="nc">&nbsp;        return scrolling || resizing ;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isMouseOver(Point p, Dimension size) {
<b class="nc">&nbsp;        int xMin = DIST_SIDE;</b>
<b class="nc">&nbsp;        int xMax = xMin + width;</b>
<b class="nc">&nbsp;        int yMin = ((size.height) - height - DIST_BOTTOM) + slideOffset;</b>
<b class="nc">&nbsp;        int yMax = yMin + height;</b>
&nbsp;
<b class="nc">&nbsp;        boolean mouseOver = (p.x &gt; xMin) &amp;&amp; (p.x &lt; xMax) &amp;&amp; (p.y &gt; yMin)</b>
&nbsp;                &amp;&amp; (p.y &lt; yMax);
&nbsp;
&nbsp;
&nbsp;        // Don&#39;t open on mouse over, it is annoying.
&nbsp;        /*if (mouseOver &amp;&amp; isDown()) {
&nbsp;            slideUp();
&nbsp;        }*/
&nbsp;
<b class="nc">&nbsp;        if (mouseOver &amp;&amp; isUp()) {</b>
<b class="nc">&nbsp;            lockOpen = true;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!mouseOver &amp;&amp; isUp()) {</b>
<b class="nc">&nbsp;            lockOpen = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return mouseOver;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isHit(Point p, Dimension size) {
<b class="nc">&nbsp;        if (isSliding()) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (message != null) {</b>
<b class="nc">&nbsp;            bv.refreshDisplayables();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int x = p.x;</b>
<b class="nc">&nbsp;        int y = p.y;</b>
<b class="nc">&nbsp;        int yOffset = ((size.height) - height - DIST_BOTTOM) + slideOffset;</b>
&nbsp;
<b class="nc">&nbsp;        if ((x &lt; DIST_SIDE) || (x &gt; (DIST_SIDE + width)) || (y &lt; yOffset)</b>
&nbsp;                || (y &gt; (yOffset + height))) {
<b class="nc">&nbsp;            bv.setChatterBoxActive(false);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        isHit = true;</b>
&nbsp;        // Hide button
<b class="nc">&nbsp;        if ((x &gt; 9) &amp;&amp; (x &lt; 25) &amp;&amp; (y &gt; (yOffset + 2)) &amp;&amp; (y &lt; (yOffset + 18)) </b>
<b class="nc">&nbsp;                &amp;&amp; !isDown()) {</b>
<b class="nc">&nbsp;            slideDown();</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        bv.setChatterBoxActive(true);</b>
<b class="nc">&nbsp;        if (isDown()){</b>
<b class="nc">&nbsp;            slideUp();</b>
&nbsp;        }
&nbsp;
&nbsp;        // Scroll up
<b class="nc">&nbsp;        if ((x &gt; (width - 17)) &amp;&amp; (x &lt; (width - 1)) &amp;&amp; (y &gt; (yOffset + 2 + 14))</b>
&nbsp;                &amp;&amp; (y &lt; (yOffset + 32))) {
<b class="nc">&nbsp;            scrollUp();</b>
<b class="nc">&nbsp;            bv.refreshDisplayables();</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        // resize
<b class="nc">&nbsp;        if ((x &gt; (width - 17)) &amp;&amp; (x &lt; (width - 1)) &amp;&amp; (y &gt; (yOffset + 2))</b>
&nbsp;                &amp;&amp; (y &lt; (yOffset + 18))) {
<b class="nc">&nbsp;            if (isUp()) {</b>
<b class="nc">&nbsp;                resizing = true;</b>
<b class="nc">&nbsp;                lockOpen = true;</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;        }
&nbsp;        // Above scrollbar
<b class="nc">&nbsp;        if ((x &gt; (width - 17)) &amp;&amp; (x &lt; (width - 1)) &amp;&amp; (y &gt; (yOffset + 31))</b>
&nbsp;                &amp;&amp; (y &lt; ((yOffset + 18 + scrollBarOffset) - 1))) {
<b class="nc">&nbsp;            pageUp();</b>
<b class="nc">&nbsp;            bv.refreshDisplayables();</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        // Scroll bar
<b class="nc">&nbsp;        if ((x &gt; (width - 15)) &amp;&amp; (x &lt; (width - 5))</b>
&nbsp;                &amp;&amp; (y &gt; ((yOffset + 18 + scrollBarOffset) - 1))
&nbsp;                &amp;&amp; (y &lt; (yOffset + 18 + scrollBarOffset + scrollBarHeight))) {
<b class="nc">&nbsp;            lastScrollPoint = p;</b>
<b class="nc">&nbsp;            scrolling = true;</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        // Below scrollbar
<b class="nc">&nbsp;        if ((x &gt; (width - 17)) &amp;&amp; (x &lt; (width - 2))</b>
&nbsp;                &amp;&amp; (y &gt; (yOffset + 18 + scrollBarOffset + scrollBarHeight))
<b class="nc">&nbsp;                &amp;&amp; (y &lt; (yOffset + 18 + getScrollbarOuterHeight()))) {</b>
<b class="nc">&nbsp;            pageDown();</b>
<b class="nc">&nbsp;            bv.refreshDisplayables();</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        // Scroll down
<b class="nc">&nbsp;        if ((x &gt; (width - 17)) &amp;&amp; (x &lt; (width - 1)) &amp;&amp; (y &gt; ((size.height) - 25))</b>
&nbsp;                &amp;&amp; (y &lt; ((size.height) - 11))) {
<b class="nc">&nbsp;            scrollDown();</b>
<b class="nc">&nbsp;            bv.refreshDisplayables();</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        // Message box
<b class="nc">&nbsp;        if ((x &gt; 10) &amp;&amp; (x &lt; (width - 40)) &amp;&amp; (y &gt; ((size.height) - 25))</b>
&nbsp;                &amp;&amp; (y &lt; ((size.height) - 11))) {
<b class="nc">&nbsp;            bv.refreshDisplayables();</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Draws the chatter box.
&nbsp;     */
&nbsp;    public void draw(Graphics graph, Rectangle clipBounds) {
<b class="nc">&nbsp;        graph.setColor(COLOR_BACKGROUND);</b>
<b class="nc">&nbsp;        graph.setFont(FONT_CHAT);</b>
&nbsp;
&nbsp;        // Draw box.
<b class="nc">&nbsp;        int yOffset = ((clipBounds.height) - height - DIST_BOTTOM) + slideOffset + clipBounds.y;</b>
&nbsp;        //graph.fillRoundRect(DIST_SIDE + clipBounds.x, yOffset, width, height, 20, 20);
<b class="nc">&nbsp;        graph.fillRect(DIST_SIDE + clipBounds.x, yOffset, width, height);</b>
<b class="nc">&nbsp;        graph.setColor(COLOR_TEXT_BACK);</b>
&nbsp;
&nbsp;        // Min/max button
<b class="nc">&nbsp;        if (slideOffset == getMaxSlideOffset()) {</b>
<b class="nc">&nbsp;            graph.drawImage(maxbutton, 10 + clipBounds.x, yOffset + 3, bv);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            graph.drawImage(minbutton, 10 + clipBounds.x , yOffset + 3, bv);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Title
<b class="nc">&nbsp;        printLine(graph, &quot;Incoming messages...&quot;, 29 + clipBounds.x, yOffset + 15);</b>
&nbsp;
&nbsp;        // resize button
<b class="nc">&nbsp;        graph.drawImage(resizebutton, (width - 16) + clipBounds.x, yOffset + 3, bv);</b>
&nbsp;
&nbsp;        // Scroll up button
<b class="nc">&nbsp;        graph.drawImage(upbutton, (width - 16) + clipBounds.x, yOffset + 16, bv);</b>
&nbsp;
&nbsp;        // Scroll bar outer
<b class="nc">&nbsp;        graph.drawRect((width - 16) + clipBounds.x, yOffset + 30, 13, getScrollbarOuterHeight());</b>
&nbsp;
&nbsp;        // Scroll bar inner
<b class="nc">&nbsp;        graph.drawRect((width - 14) + clipBounds.x, yOffset + 31 + scrollBarOffset, 9, scrollBarHeight);</b>
&nbsp;
&nbsp;        // Scroll down button
<b class="nc">&nbsp;        graph.drawImage(downbutton, (width - 16) + clipBounds.x, (yOffset + height) - 20, bv);</b>
&nbsp;
&nbsp;        // Message box
<b class="nc">&nbsp;        graph.drawRect(10 + clipBounds.x, (yOffset + height) - 21, width - 50, 17);</b>
<b class="nc">&nbsp;        if (message != null &amp;&amp; bv.getChatterBoxActive()) {</b>
<b class="nc">&nbsp;            printLine(graph, visibleMessage + &quot;_&quot;, 13 + clipBounds.x, (yOffset + height) - 7);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Text rows
<b class="nc">&nbsp;        int rows = messages.size();</b>
<b class="nc">&nbsp;        if (rows &lt;= max_nbr_rows) {</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; messages.size(); i++) {</b>
<b class="nc">&nbsp;                printLine(graph, messages.elementAt(i), 10 + clipBounds.x, yOffset</b>
&nbsp;                        + 15 + ((i + 1) * 15));
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            int row = 1;</b>
<b class="nc">&nbsp;            for (int i = rows - max_nbr_rows - chatScroll; i &lt; (messages</b>
<b class="nc">&nbsp;                    .size()</b>
<b class="nc">&nbsp;                    - chatScroll); i++) {</b>
<b class="nc">&nbsp;                if (i &gt; -1) {</b>
<b class="nc">&nbsp;                    printLine(graph, messages.elementAt(i), 10 + clipBounds.x, yOffset</b>
&nbsp;                            + 15 + (row * 15));
<b class="nc">&nbsp;                    row++;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void printLine(Graphics graph, String text, int x, int y) {
<b class="nc">&nbsp;        graph.drawString(text, x, y + 1);</b>
<b class="nc">&nbsp;        graph.drawString(text, x, y - 1);</b>
<b class="nc">&nbsp;        graph.drawString(text, x + 1, y);</b>
<b class="nc">&nbsp;        graph.drawString(text, x - 1, y);</b>
<b class="nc">&nbsp;        graph.setColor(COLOR_TEXT_FRONT);</b>
<b class="nc">&nbsp;        graph.drawString(text, x, y);</b>
<b class="nc">&nbsp;        graph.setColor(COLOR_TEXT_BACK);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Adds a line to the chat, and performs line breaking if
&nbsp;     *  necessary
&nbsp;     * @param line
&nbsp;     */
&nbsp;    public void addChatMessage(String line) {
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        if (!isUp()) {</b>
<b class="nc">&nbsp;            slideUp();</b>
&nbsp;        }
<b class="nc">&nbsp;        int stringWidth = fm.stringWidth(line);</b>
<b class="nc">&nbsp;        int lineWidth = width - 5 - 20;</b>
&nbsp;
<b class="nc">&nbsp;        chatScroll = 0;</b>
&nbsp;
<b class="nc">&nbsp;        if (stringWidth &lt;= lineWidth) {</b>
<b class="nc">&nbsp;            messages.addElement(line);</b>
<b class="nc">&nbsp;            computeScrollBarHeight();</b>
<b class="nc">&nbsp;            bv.refreshDisplayables();</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Enumeration&lt;String&gt; words = StringUtil.splitString(line, &quot; &quot;).elements();</b>
&nbsp;
<b class="nc">&nbsp;        String nextLine = &quot;&quot;;</b>
<b class="nc">&nbsp;        while (words.hasMoreElements()) {</b>
<b class="nc">&nbsp;            String nextWord = words.nextElement();</b>
<b class="nc">&nbsp;            if (fm.stringWidth(nextLine + &quot; &quot; + nextWord) &lt; lineWidth) {</b>
<b class="nc">&nbsp;                nextLine = (nextLine.equals(&quot;&quot;)) ? nextWord : nextLine + &quot; &quot;</b>
<b class="nc">&nbsp;                        + nextWord;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                messages.addElement(nextLine);</b>
<b class="nc">&nbsp;                nextLine = nextWord;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        messages.addElement(nextLine);</b>
<b class="nc">&nbsp;        computeScrollBarHeight();</b>
<b class="nc">&nbsp;        bv.refreshDisplayables();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Scrolls up one line.
&nbsp;     */
&nbsp;    public void scrollUp() {
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        if (!(chatScroll &gt;= (messages.size() - max_nbr_rows))) {</b>
<b class="nc">&nbsp;            chatScroll++;</b>
<b class="nc">&nbsp;            computeScrollBarOffset();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Scrolls down one line.
&nbsp;     */
&nbsp;    public void scrollDown() {
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        if (chatScroll &gt; 0) {</b>
<b class="nc">&nbsp;            chatScroll--;</b>
<b class="nc">&nbsp;            computeScrollBarOffset();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * resizing
&nbsp;     * @param p
&nbsp;     * @param size
&nbsp;     */
&nbsp;    private void resize(Point p, Dimension size) {
<b class="nc">&nbsp;        width = p.x;</b>
<b class="nc">&nbsp;        height = Math.max(size.height - p.y, 10);</b>
<b class="nc">&nbsp;        max_nbr_rows = (height / fm.getHeight()) - 2;</b>
<b class="nc">&nbsp;        computeScrollBarHeight();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Scrolling...
&nbsp;     * @param p
&nbsp;     * @param size
&nbsp;     */
&nbsp;    private void scroll(Point p, Dimension size) {
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        int yOffset = (size.height) - height - DIST_BOTTOM;</b>
&nbsp;        int dY;
<b class="nc">&nbsp;        if (p.y &lt; (yOffset + 3 + 14 + 14)) {</b>
<b class="nc">&nbsp;            if (overTheTop) {</b>
&nbsp;                return;
&nbsp;            } else {
<b class="nc">&nbsp;                p = new Point(0, yOffset + 3 + 14 + 14);</b>
<b class="nc">&nbsp;                overTheTop = true;</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (p.y &gt; ((yOffset + 150) - 20)) {</b>
<b class="nc">&nbsp;            if (underTheBottom) {</b>
&nbsp;                return;
&nbsp;            } else {
<b class="nc">&nbsp;                p = new Point(0, (yOffset + 150) - 20);</b>
<b class="nc">&nbsp;                underTheBottom = true;</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            underTheBottom = false;</b>
<b class="nc">&nbsp;            overTheTop = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        dY = (int) (p.y - lastScrollPoint.getY());</b>
<b class="nc">&nbsp;        lastScrollPoint = p;</b>
&nbsp;
<b class="nc">&nbsp;        scrollBarDragPos += dY;</b>
<b class="nc">&nbsp;        scrollBarOffset += dY;</b>
&nbsp;
<b class="nc">&nbsp;        if (scrollBarOffset &lt; 0) {</b>
<b class="nc">&nbsp;            scrollBarOffset = 0;</b>
<b class="nc">&nbsp;        } else if (scrollBarOffset &gt; (getMaxScrollbarHeight() - scrollBarHeight)) {</b>
<b class="nc">&nbsp;            scrollBarOffset = getMaxScrollbarHeight() - scrollBarHeight;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        while (Math.abs(scrollBarDragPos) &gt;= scrollBarStep) {</b>
<b class="nc">&nbsp;            if (Math.abs(scrollBarDragPos) &gt;= ((scrollBarStep) / 2.0f)) {</b>
<b class="nc">&nbsp;                if (scrollBarDragPos &lt; 0) {</b>
<b class="nc">&nbsp;                    if (!increasedChatScroll</b>
<b class="nc">&nbsp;                            &amp;&amp; !(chatScroll &gt;= (messages.size() - 6))) {</b>
<b class="nc">&nbsp;                        chatScroll++;</b>
<b class="nc">&nbsp;                        decreasedChatScroll = false;</b>
<b class="nc">&nbsp;                        increasedChatScroll = true;</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    if (!decreasedChatScroll &amp;&amp; (chatScroll &gt; 0)) {</b>
<b class="nc">&nbsp;                        chatScroll--;</b>
<b class="nc">&nbsp;                        decreasedChatScroll = true;</b>
<b class="nc">&nbsp;                        increasedChatScroll = false;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (Math.abs(scrollBarDragPos) &gt;= scrollBarStep) {</b>
<b class="nc">&nbsp;                if (scrollBarDragPos &lt; 0) {</b>
<b class="nc">&nbsp;                    scrollBarDragPos += scrollBarStep;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    scrollBarDragPos -= scrollBarStep;</b>
&nbsp;                }
<b class="nc">&nbsp;                decreasedChatScroll = false;</b>
<b class="nc">&nbsp;                increasedChatScroll = false;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (Math.abs(scrollBarDragPos) &gt;= ((scrollBarStep) / 2.0f)) {</b>
<b class="nc">&nbsp;            if (scrollBarDragPos &lt; 0) {</b>
<b class="nc">&nbsp;                if (!increasedChatScroll</b>
<b class="nc">&nbsp;                        &amp;&amp; !(chatScroll &gt;= (messages.size() - 6))) {</b>
<b class="nc">&nbsp;                    chatScroll++;</b>
<b class="nc">&nbsp;                    decreasedChatScroll = false;</b>
<b class="nc">&nbsp;                    increasedChatScroll = true;</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                if (!decreasedChatScroll &amp;&amp; (chatScroll &gt; 0)) {</b>
<b class="nc">&nbsp;                    chatScroll--;</b>
<b class="nc">&nbsp;                    decreasedChatScroll = true;</b>
<b class="nc">&nbsp;                    increasedChatScroll = false;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void computeScrollBarOffset() {
<b class="nc">&nbsp;        if (messages.size() &lt;= max_nbr_rows) {</b>
<b class="nc">&nbsp;            scrollBarOffset = 0;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            scrollBarOffset = (int) (((getMaxScrollbarHeight() - scrollBarHeight)) * (1.0f - (chatScroll / ((float) (messages</b>
<b class="nc">&nbsp;                    .size() - max_nbr_rows)))));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void computeScrollBarHeight() {
<b class="nc">&nbsp;        if (messages.size() &lt;= max_nbr_rows) {</b>
<b class="nc">&nbsp;            scrollBarHeight = getMaxScrollbarHeight();</b>
<b class="nc">&nbsp;            scrollBarStep = 1;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            scrollBarHeight = Math</b>
<b class="nc">&nbsp;                    .max(3, (int) (((float) max_nbr_rows / messages</b>
<b class="nc">&nbsp;                            .size()) * getMaxScrollbarHeight()));</b>
<b class="nc">&nbsp;            scrollBarStep = ((getMaxScrollbarHeight() - scrollBarHeight) / (float) (messages</b>
<b class="nc">&nbsp;                    .size() - max_nbr_rows));</b>
&nbsp;        }
<b class="nc">&nbsp;        computeScrollBarOffset();</b>
&nbsp;    }
&nbsp;
&nbsp;    //
&nbsp;    // KeyListener
&nbsp;    //
&nbsp;    public void keyPressed(KeyEvent ke) {
&nbsp;
<b class="nc">&nbsp;        if (!bv.getChatterBoxActive()){</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (ke.isControlDown() &amp;&amp; (ke.getKeyCode() == KeyEvent.VK_V)) {</b>
<b class="nc">&nbsp;            Transferable content = Toolkit.getDefaultToolkit().</b>
<b class="nc">&nbsp;                    getSystemClipboard().getContents(null);</b>
<b class="nc">&nbsp;            boolean hasTransferableText = (content != null) &amp;&amp; </b>
<b class="nc">&nbsp;                    content.isDataFlavorSupported(DataFlavor.stringFlavor);</b>
<b class="nc">&nbsp;            if (hasTransferableText) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    addChatMessage((String)content.getTransferData(</b>
&nbsp;                            DataFlavor.stringFlavor));
&nbsp;                  }
<b class="nc">&nbsp;                  catch (UnsupportedFlavorException ex){</b>
&nbsp;                    //highly unlikely since we are using a standard DataFlavor
<b class="nc">&nbsp;                    System.out.println(ex);</b>
<b class="nc">&nbsp;                    ex.printStackTrace();</b>
&nbsp;                  }
<b class="nc">&nbsp;                  catch (IOException ex) {</b>
<b class="nc">&nbsp;                      System.out.println(ex);</b>
<b class="nc">&nbsp;                      ex.printStackTrace();</b>
<b class="nc">&nbsp;                  }</b>
&nbsp;            }            
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (ke.isAltDown() || ke.isControlDown()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ke.consume();</b>
<b class="nc">&nbsp;        switch (ke.getKeyCode()) {</b>
&nbsp;            case KeyEvent.VK_UP:
<b class="nc">&nbsp;                cb.historyBookmark++;</b>
<b class="nc">&nbsp;                cb.fetchHistory();</b>
<b class="nc">&nbsp;                bv.repaint();</b>
&nbsp;                return;
&nbsp;            case KeyEvent.VK_DOWN:
<b class="nc">&nbsp;                cb.historyBookmark--;</b>
<b class="nc">&nbsp;                cb.fetchHistory();</b>
<b class="nc">&nbsp;                bv.repaint();</b>
&nbsp;                return;
&nbsp;            case KeyEvent.VK_ALT:
&nbsp;            case KeyEvent.VK_SHIFT:
&nbsp;            case KeyEvent.VK_TAB:
&nbsp;            case KeyEvent.VK_CAPS_LOCK:
&nbsp;            case KeyEvent.VK_CONTROL:
&nbsp;            case KeyEvent.VK_RIGHT:
&nbsp;            case KeyEvent.VK_LEFT:
&nbsp;            case KeyEvent.VK_PAGE_UP:
&nbsp;            case KeyEvent.VK_PAGE_DOWN:
&nbsp;            case KeyEvent.VK_END:
&nbsp;            case KeyEvent.VK_HOME:
&nbsp;            case KeyEvent.VK_NUM_LOCK:
&nbsp;            case KeyEvent.VK_SCROLL_LOCK:
&nbsp;            case KeyEvent.VK_F1:
&nbsp;            case KeyEvent.VK_F2:
&nbsp;            case KeyEvent.VK_F3:
&nbsp;            case KeyEvent.VK_F4:
&nbsp;            case KeyEvent.VK_F5:
&nbsp;            case KeyEvent.VK_F6:
&nbsp;            case KeyEvent.VK_F7:
&nbsp;            case KeyEvent.VK_F8:
&nbsp;            case KeyEvent.VK_F9:
&nbsp;            case KeyEvent.VK_F10:
&nbsp;            case KeyEvent.VK_F11:
&nbsp;            case KeyEvent.VK_F12:
&nbsp;            case KeyEvent.VK_PRINTSCREEN:
&nbsp;            case KeyEvent.VK_INSERT:
&nbsp;            case KeyEvent.VK_DELETE:
&nbsp;                return;
&nbsp;        }      
&nbsp;        
<b class="nc">&nbsp;        if ((isDown() || isSliding()) &amp;&amp; (ke.getKeyCode() != KeyEvent.VK_ENTER)</b>
<b class="nc">&nbsp;                &amp;&amp; (ke.getKeyCode() != KeyEvent.VK_BACK_SPACE)</b>
<b class="nc">&nbsp;                &amp;&amp; (ke.getKeyCode() != KeyEvent.VK_ESCAPE)) {</b>
<b class="nc">&nbsp;            if (!slidingUp) {</b>
<b class="nc">&nbsp;                slideUp();</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setIdleTime(0, false);</b>
<b class="nc">&nbsp;        switch (ke.getKeyCode()) {</b>
&nbsp;            case KeyEvent.VK_ENTER:
<b class="nc">&nbsp;                if ((message != null) &amp;&amp; (message.length() &gt; 0)) {</b>
<b class="nc">&nbsp;                    cb.history.addFirst(message);</b>
<b class="nc">&nbsp;                    cb.historyBookmark = -1;</b>
&nbsp;
<b class="nc">&nbsp;                    if (cb.history.size() &gt; ChatterBox.MAX_HISTORY) {</b>
<b class="nc">&nbsp;                        cb.history.removeLast();</b>
&nbsp;                    }
<b class="nc">&nbsp;                    client.sendChat(message);</b>
<b class="nc">&nbsp;                    clearMessage();</b>
<b class="nc">&nbsp;                    cb.setMessage(&quot;&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                bv.setChatterBoxActive(false);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case KeyEvent.VK_ESCAPE:
<b class="nc">&nbsp;                clearMessage();</b>
<b class="nc">&nbsp;                bv.setChatterBoxActive(false);</b>
<b class="nc">&nbsp;                slideDown();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case KeyEvent.VK_BACK_SPACE:
<b class="nc">&nbsp;                if ((message == null) || message.equals(&quot;&quot;)) {</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                message = message.substring(0, message.length() - 1);</b>
<b class="nc">&nbsp;                int i = 0;</b>
<b class="nc">&nbsp;                if (fm.stringWidth(message) &gt; (width - 60)) {</b>
<b class="nc">&nbsp;                    boolean noFit = true;</b>
<b class="nc">&nbsp;                    while (noFit) {</b>
<b class="nc">&nbsp;                        i++;</b>
<b class="nc">&nbsp;                        String s = message.substring(i);</b>
<b class="nc">&nbsp;                        noFit = fm.stringWidth(s) &gt; (width - 60);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
<b class="nc">&nbsp;                visibleMessage = message.substring(i);</b>
<b class="nc">&nbsp;                cb.setMessage(message);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            default:
<b class="nc">&nbsp;                if (message == null) {</b>
<b class="nc">&nbsp;                    message = &quot;&quot; + ke.getKeyChar();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    message += ke.getKeyChar();</b>
&nbsp;                }
<b class="nc">&nbsp;                cb.setMessage(message);</b>
<b class="nc">&nbsp;                i = 0;</b>
<b class="nc">&nbsp;                if (fm.stringWidth(message) &gt; (width - 60)) {</b>
<b class="nc">&nbsp;                    boolean noFit = true;</b>
<b class="nc">&nbsp;                    while (noFit) {</b>
<b class="nc">&nbsp;                        i++;</b>
<b class="nc">&nbsp;                        String s = message.substring(i);</b>
<b class="nc">&nbsp;                        noFit = fm.stringWidth(s) &gt; (width - 60);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
<b class="nc">&nbsp;                visibleMessage = message.substring(i);</b>
&nbsp;        }
<b class="nc">&nbsp;        bv.refreshDisplayables();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void keyReleased(KeyEvent ke) {
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public void keyTyped(KeyEvent ke) {
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public String getMessage() {
<b class="nc">&nbsp;        return message;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setMessage(String message) {
<b class="nc">&nbsp;        this.message = message;</b>
<b class="nc">&nbsp;        int i = 0;</b>
<b class="nc">&nbsp;        if (fm.stringWidth(message) &gt; 240) {</b>
<b class="nc">&nbsp;            boolean noFit = true;</b>
<b class="nc">&nbsp;            while (noFit) {</b>
<b class="nc">&nbsp;                i++;</b>
<b class="nc">&nbsp;                String s = message.substring(i);</b>
<b class="nc">&nbsp;                noFit = fm.stringWidth(s) &gt; 240;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        visibleMessage = message.substring(i);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setChatterBox(ChatterBox cb) {
<b class="nc">&nbsp;        this.cb = cb;</b>
&nbsp;    }
&nbsp;
&nbsp;    private int getScrollbarOuterHeight() {
<b class="nc">&nbsp;        return height - 49;</b>
&nbsp;    }
&nbsp;
&nbsp;    private int getMaxScrollbarHeight() {
<b class="nc">&nbsp;        return height - 54;</b>
&nbsp;    }
&nbsp;
&nbsp;    private int getMaxSlideOffset() {
<b class="nc">&nbsp;        return height - 20;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public void clearMessage(){
<b class="nc">&nbsp;        message = &quot;&quot;;</b>
<b class="nc">&nbsp;        visibleMessage =&quot;&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
