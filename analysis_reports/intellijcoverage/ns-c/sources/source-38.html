


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > MovementDisplay</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ui.swing</a>
</div>

<h1>Coverage Summary for Class: MovementDisplay (megamek.client.ui.swing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MovementDisplay</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/142)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2998)
  </span>
</td>
</tr>
  <tr>
    <td class="name">MovementDisplay$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$10</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$1HitchChoice</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$7</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$8</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$9</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MovementDisplay$MoveCommand</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/104)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/184)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3248)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek - Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur
&nbsp; * (bmazur@sev.org)
&nbsp; *
&nbsp; * This program is free software; you can redistribute it and/or modify it under
&nbsp; * the terms of the GNU General Public License as published by the Free Software
&nbsp; * Foundation; either version 2 of the License, or (at your option) any later
&nbsp; * version.
&nbsp; *
&nbsp; * This program is distributed in the hope that it will be useful, but WITHOUT
&nbsp; * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
&nbsp; * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
&nbsp; * details.
&nbsp; */
&nbsp;package megamek.client.ui.swing;
&nbsp;
&nbsp;import java.awt.Color;
&nbsp;import java.awt.event.ActionEvent;
&nbsp;import java.awt.event.InputEvent;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Collections;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;import java.util.TreeMap;
&nbsp;import java.util.Vector;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import javax.swing.JOptionPane;
&nbsp;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.client.event.BoardViewEvent;
&nbsp;import megamek.client.ui.Messages;
&nbsp;import megamek.client.ui.SharedUtility;
&nbsp;import megamek.client.ui.swing.util.CommandAction;
&nbsp;import megamek.client.ui.swing.util.KeyCommandBind;
&nbsp;import megamek.client.ui.swing.util.MegaMekController;
&nbsp;import megamek.client.ui.swing.widget.MegamekButton;
&nbsp;import megamek.client.ui.swing.widget.SkinSpecification;
&nbsp;import megamek.common.*;
&nbsp;import megamek.common.IGame.Phase;
&nbsp;import megamek.common.MovePath.MoveStepType;
&nbsp;import megamek.common.actions.AirmechRamAttackAction;
&nbsp;import megamek.common.actions.ChargeAttackAction;
&nbsp;import megamek.common.actions.DfaAttackAction;
&nbsp;import megamek.common.actions.RamAttackAction;
&nbsp;import megamek.common.event.GamePhaseChangeEvent;
&nbsp;import megamek.common.event.GameTurnChangeEvent;
&nbsp;import megamek.common.options.GameOptions;
&nbsp;import megamek.common.options.IOptions;
&nbsp;import megamek.common.options.OptionsConstants;
&nbsp;import megamek.common.pathfinder.AbstractPathFinder;
&nbsp;import megamek.common.pathfinder.LongestPathFinder;
&nbsp;import megamek.common.pathfinder.ShortestPathFinder;
&nbsp;import megamek.common.preference.PreferenceManager;
&nbsp;import megamek.client.ui.swing.util.TurnTimer;
&nbsp;
<b class="nc">&nbsp;public class MovementDisplay extends StatusBarPhaseDisplay {</b>
&nbsp;    private static final long serialVersionUID = -7246715124042905688L;
&nbsp;    
&nbsp;    // Defines for the different flags
&nbsp;    public static final int CMD_NONE = 0;
&nbsp;    public static final int CMD_MECH = 1;
&nbsp;    public static final int CMD_TANK = 1 &lt;&lt; 1;
&nbsp;    public static final int CMD_VTOL = 1 &lt;&lt; 2;
&nbsp;    public static final int CMD_INF = 1 &lt;&lt; 3;
&nbsp;    public static final int CMD_AERO = 1 &lt;&lt; 4;
&nbsp;    public static final int CMD_AERO_VECTORED = 1 &lt;&lt; 5;
&nbsp;    public static final int CMD_CONVERTER = 1 &lt;&lt; 6;
&nbsp;    public static final int CMD_AIRMECH = 1 &lt;&lt; 7;
&nbsp;    // Command used only in menus and has no associated button
&nbsp;    public static final int CMD_NO_BUTTON = 1 &lt;&lt; 8;
&nbsp;    // Convenience defines for common combinations
&nbsp;    public static final int CMD_AERO_BOTH = CMD_AERO | CMD_AERO_VECTORED;
&nbsp;    public static final int CMD_GROUND = CMD_MECH | CMD_TANK | CMD_VTOL
&nbsp;                                         | CMD_INF;
&nbsp;    public static final int CMD_NON_VECTORED = CMD_MECH | CMD_TANK | CMD_VTOL
&nbsp;                                               | CMD_INF | CMD_AERO;
&nbsp;    public static final int CMD_ALL = CMD_MECH | CMD_TANK | CMD_VTOL | CMD_INF
&nbsp;                                      | CMD_AERO | CMD_AERO_VECTORED;
&nbsp;    public static final int CMD_NON_INF = CMD_MECH | CMD_TANK | CMD_VTOL
&nbsp;                                          | CMD_AERO | CMD_AERO_VECTORED;
&nbsp;    private TurnTimer tt;
&nbsp;
&nbsp;    /**
&nbsp;     * This enumeration lists all of the possible ActionCommands that can be
&nbsp;     * carried out during the movement phase. Each command has a string for the
&nbsp;     * command plus a flag that determines what unit type it is appropriate for.
&nbsp;     *
&nbsp;     * @author arlith
&nbsp;     */
<b class="nc">&nbsp;    public enum MoveCommand implements PhaseCommand {</b>
<b class="nc">&nbsp;        MOVE_NEXT(&quot;moveNext&quot;, CMD_NONE), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_TURN(&quot;moveTurn&quot;, CMD_GROUND | CMD_AERO), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_WALK(&quot;moveWalk&quot;, CMD_GROUND), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_JUMP(&quot;moveJump&quot;, CMD_MECH | CMD_TANK | CMD_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_BACK_UP(&quot;moveBackUp&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_GET_UP(&quot;moveGetUp&quot;, CMD_MECH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_FORWARD_INI(&quot;moveForwardIni&quot;, CMD_ALL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_CHARGE(&quot;moveCharge&quot;, CMD_MECH | CMD_TANK), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_DFA(&quot;moveDFA&quot;, CMD_MECH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_GO_PRONE(&quot;moveGoProne&quot;, CMD_MECH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_FLEE(&quot;moveFlee&quot;, CMD_ALL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_EJECT(&quot;moveEject&quot;, CMD_ALL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_LOAD(&quot;moveLoad&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_UNLOAD(&quot;moveUnload&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_MOUNT(&quot;moveMount&quot;, CMD_GROUND), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_TOW(&quot;moveTow&quot;, CMD_TANK), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_DISCONNECT(&quot;moveDisconnect&quot;, CMD_TANK), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_UNJAM(&quot;moveUnjam&quot;, CMD_NON_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_CLEAR(&quot;moveClear&quot;, CMD_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_CANCEL(&quot;moveCancel&quot;, CMD_NONE), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_RAISE_ELEVATION(&quot;moveRaiseElevation&quot;, CMD_NON_VECTORED), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_LOWER_ELEVATION(&quot;moveLowerElevation&quot;, CMD_NON_VECTORED), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_SEARCHLIGHT(&quot;moveSearchlight&quot;, CMD_GROUND), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_LAY_MINE(&quot;moveLayMine&quot;, CMD_TANK | CMD_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_HULL_DOWN(&quot;moveHullDown&quot;, CMD_MECH | CMD_TANK), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_CLIMB_MODE(&quot;moveClimbMode&quot;, CMD_MECH | CMD_TANK | CMD_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_SWIM(&quot;moveSwim&quot;, CMD_MECH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_SHAKE_OFF(&quot;moveShakeOff&quot;, CMD_TANK | CMD_VTOL), //$NON-NLS-1$</b>
&nbsp;        //Convert command for a single button, which can cycle through modes because MovePath state is available
<b class="nc">&nbsp;        MOVE_MODE_CONVERT(&quot;moveModeConvert&quot;, CMD_CONVERTER), //$NON-NLS-1$</b>
&nbsp;        //Convert commands used for menus, where the MovePath state is unknown.
<b class="nc">&nbsp;        MOVE_MODE_LEG(&quot;moveModeLeg&quot;, CMD_NO_BUTTON), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_MODE_VEE(&quot;moveModeVee&quot;, CMD_NO_BUTTON), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_MODE_AIR(&quot;moveModeAir&quot;, CMD_NO_BUTTON), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_RECKLESS(&quot;moveReckless&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_CAREFUL_STAND(&quot;moveCarefulStand&quot;, CMD_NONE), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_EVADE(&quot;MoveEvade&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_BOOTLEGGER(&quot;moveBootlegger&quot;, CMD_TANK | CMD_VTOL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_SHUTDOWN(&quot;moveShutDown&quot;, CMD_NON_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_STARTUP(&quot;moveStartup&quot;, CMD_NON_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_SELF_DESTRUCT(&quot;moveSelfDestruct&quot;, CMD_NON_INF), //$NON-NLS-1$</b>
&nbsp;        // Infantry only
<b class="nc">&nbsp;        MOVE_DIG_IN(&quot;moveDigIn&quot;, CMD_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_FORTIFY(&quot;moveFortify&quot;, CMD_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_TAKE_COVER(&quot;moveTakeCover&quot;, CMD_INF), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_CALL_SUPPORT(&quot;moveCallSuport&quot;, CMD_INF), //$NON-NLS-1$</b>
&nbsp;        // VTOL attacks, declared in the movement phase
<b class="nc">&nbsp;        MOVE_STRAFE(&quot;moveStrafe&quot;, CMD_VTOL), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_BOMB(&quot;moveBomb&quot;, CMD_VTOL | CMD_AIRMECH), //$NON-NLS-1$</b>
&nbsp;        // Aero Movement
<b class="nc">&nbsp;        MOVE_ACC(&quot;MoveAccelerate&quot;, CMD_AERO), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_DEC(&quot;MoveDecelerate&quot;, CMD_AERO), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_EVADE_AERO(&quot;MoveEvadeAero&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_ACCN(&quot;MoveAccNext&quot;, CMD_AERO), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_DECN(&quot;MoveDecNext&quot;, CMD_AERO), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_ROLL(&quot;MoveRoll&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_LAUNCH(&quot;MoveLaunch&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_DOCK(&quot;MoveDock&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_RECOVER(&quot;MoveRecover&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_DROP(&quot;MoveDrop&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_DUMP(&quot;MoveDump&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_RAM(&quot;MoveRam&quot;, CMD_AERO_BOTH | CMD_AIRMECH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_HOVER(&quot;MoveHover&quot;, CMD_AERO | CMD_AIRMECH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_MANEUVER(&quot;MoveManeuver&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_JOIN(&quot;MoveJoin&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_FLY_OFF(&quot;MoveOff&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_TAKE_OFF(&quot;MoveTakeOff&quot;, CMD_TANK), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_VERT_TAKE_OFF(&quot;MoveVertTakeOff&quot;, CMD_TANK), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_LAND(&quot;MoveLand&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_VERT_LAND(&quot;MoveVLand&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</b>
&nbsp;        // Aero Vector Movement
<b class="nc">&nbsp;        MOVE_TURN_LEFT(&quot;MoveTurnLeft&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_TURN_RIGHT(&quot;MoveTurnRight&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_THRUST(&quot;MoveThrust&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_YAW(&quot;MoveYaw&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_END_OVER(&quot;MoveEndOver&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</b>
&nbsp;        // Move envelope
<b class="nc">&nbsp;        MOVE_ENVELOPE(&quot;MoveEnvelope&quot;, CMD_NONE), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_LONGEST_RUN(&quot;MoveLongestRun&quot;, CMD_NONE), //$NON-NLS-1$</b>
<b class="nc">&nbsp;        MOVE_LONGEST_WALK(&quot;MoveLongestWalk&quot;, CMD_NONE), //$NON-NLS-1$</b>
&nbsp;        // Traitor
<b class="nc">&nbsp;        MOVE_TRAITOR(&quot;Traitor&quot;, CMD_NONE), MOVE_MORE(&quot;MoveMore&quot;, CMD_NONE); //$NON-NLS-1$</b>
&nbsp;
&nbsp;        /**
&nbsp;         * The command text.
&nbsp;         */
&nbsp;        public final String cmd;
&nbsp;
&nbsp;        /**
&nbsp;         * Flag that determines what unit types can use a command.
&nbsp;         */
&nbsp;        public final int flag;
&nbsp;
&nbsp;        /**
&nbsp;         * Priority that determines this buttons order
&nbsp;         */
&nbsp;        public int priority;
&nbsp;
<b class="nc">&nbsp;        MoveCommand(String c, int f) {</b>
<b class="nc">&nbsp;            cmd = c;</b>
<b class="nc">&nbsp;            flag = f;</b>
<b class="nc">&nbsp;            priority = ordinal();</b>
&nbsp;        }
&nbsp;
&nbsp;        public String getCmd() {
<b class="nc">&nbsp;            return cmd;</b>
&nbsp;        }
&nbsp;
&nbsp;        public int getPriority() {
<b class="nc">&nbsp;            return priority;</b>
&nbsp;        }
&nbsp;
&nbsp;        public void setPriority(int p) {
<b class="nc">&nbsp;            priority = p;</b>
&nbsp;        }
&nbsp;
&nbsp;        public String toString() {
<b class="nc">&nbsp;            return Messages.getString(&quot;MovementDisplay.&quot; + getCmd());</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Return a list of valid commands for the given parameters.
&nbsp;         *
&nbsp;         * @param f          The unit flag to specify what unit type the commands are
&nbsp;         *                   for.
&nbsp;         * @param opts       A GameOptions reference for checking game options
&nbsp;         * @param forwardIni A flag to see if we can pass the turn to a teammate
&nbsp;         * @return An array of valid commands for the given parameters
&nbsp;         */
&nbsp;        public static MoveCommand[] values(int f, GameOptions opts,
&nbsp;                boolean forwardIni) {
<b class="nc">&nbsp;            boolean manualShutdown = false, selfDestruct = false, advVehicle = false, vtolStrafe = false;</b>
<b class="nc">&nbsp;            if (opts != null) {</b>
<b class="nc">&nbsp;                manualShutdown = opts.booleanOption(OptionsConstants.RPG_MANUAL_SHUTDOWN);</b>
<b class="nc">&nbsp;                selfDestruct = opts.booleanOption(OptionsConstants.ADVANCED_TACOPS_SELF_DESTRUCT);</b>
<b class="nc">&nbsp;                advVehicle = opts.booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS);</b>
<b class="nc">&nbsp;                vtolStrafe = opts.booleanOption(OptionsConstants.ADVCOMBAT_VTOL_STRAFING);</b>
&nbsp;            }
<b class="nc">&nbsp;            ArrayList&lt;MoveCommand&gt; flaggedCmds = new ArrayList&lt;MoveCommand&gt;();</b>
<b class="nc">&nbsp;            for (MoveCommand cmd : MoveCommand.values()) {</b>
&nbsp;                // Check for movements that with disabled game options
<b class="nc">&nbsp;                if ((cmd == MOVE_SHUTDOWN || cmd == MOVE_STARTUP)</b>
&nbsp;                    &amp;&amp; !manualShutdown) {
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (cmd == MOVE_SELF_DESTRUCT</b>
&nbsp;                    &amp;&amp; !selfDestruct) {
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (cmd == MOVE_FORWARD_INI &amp;&amp; !forwardIni) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                if (cmd == MOVE_BOOTLEGGER &amp;&amp; !advVehicle) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                if (cmd == MOVE_STRAFE &amp;&amp; !vtolStrafe) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // Check unit type flag
<b class="nc">&nbsp;                if ((cmd.flag &amp; f) != 0) {</b>
<b class="nc">&nbsp;                    flaggedCmds.add(cmd);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return flaggedCmds.toArray(new MoveCommand[0]);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    // buttons
&nbsp;    private Map&lt;MoveCommand, MegamekButton&gt; buttons;
&nbsp;
&nbsp;    // let&#39;s keep track of what we&#39;re moving, too
<b class="nc">&nbsp;    private int cen = Entity.NONE; // current entity number</b>
&nbsp;    private MovePath cmd; // considering movement data
&nbsp;    // what &quot;gear&quot; is our mech in?
&nbsp;    private int gear;
&nbsp;    // is the shift key held?
&nbsp;    private boolean shiftheld;
&nbsp;    /**
&nbsp;     * A local copy of the current entity&#39;s loaded units.
&nbsp;     */
<b class="nc">&nbsp;    private List&lt;Entity&gt; loadedUnits = null;</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * A local copy of the current entity&#39;s towed trailers.
&nbsp;     */
<b class="nc">&nbsp;    private List&lt;Entity&gt; towedUnits = null;</b>
&nbsp;
&nbsp;    public static final int GEAR_LAND = 0;
&nbsp;    public static final int GEAR_BACKUP = 1;
&nbsp;    public static final int GEAR_JUMP = 2;
&nbsp;    public static final int GEAR_CHARGE = 3;
&nbsp;    public static final int GEAR_DFA = 4;
&nbsp;    public static final int GEAR_TURN = 5;
&nbsp;    public static final int GEAR_SWIM = 6;
&nbsp;    public static final int GEAR_RAM = 7;
&nbsp;    public static final int GEAR_IMMEL = 8;
&nbsp;    public static final int GEAR_SPLIT_S = 9;
&nbsp;    public static final int GEAR_LONGEST_RUN = 10;
&nbsp;    public static final int GEAR_LONGEST_WALK = 11;
&nbsp;    public static final int GEAR_STRAFE = 12;
&nbsp;
&nbsp;    /**
&nbsp;     * Creates and lays out a new movement phase display for the specified
&nbsp;     * clientgui.getClient().
&nbsp;     */
&nbsp;    public MovementDisplay(final ClientGUI clientgui) {
<b class="nc">&nbsp;        super(clientgui);</b>
&nbsp;
<b class="nc">&nbsp;        this.clientgui = clientgui;</b>
<b class="nc">&nbsp;        if (clientgui != null) {</b>
<b class="nc">&nbsp;            clientgui.getClient().getGame().addGameListener(this);</b>
<b class="nc">&nbsp;            clientgui.getBoardView().addBoardViewListener(this);</b>
<b class="nc">&nbsp;            clientgui.getClient().getGame().setupTeams();</b>
<b class="nc">&nbsp;            clientgui.bv.addKeyListener(this);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setupStatusBar(Messages.getString(&quot;MovementDisplay.waitingForMovementPhase&quot;)); //$NON-NLS-1$</b>
&nbsp;
&nbsp;        // Create all of the buttons
<b class="nc">&nbsp;        buttons = new HashMap&lt;MoveCommand, MegamekButton&gt;(</b>
<b class="nc">&nbsp;                (int) (MoveCommand.values().length * 1.25 + 0.5));</b>
<b class="nc">&nbsp;        for (MoveCommand cmd : MoveCommand.values()) {</b>
<b class="nc">&nbsp;            String title = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.&quot; + cmd.getCmd());</b>
<b class="nc">&nbsp;            MegamekButton newButton = new MegamekButton(title,</b>
<b class="nc">&nbsp;                    SkinSpecification.UIComponents.PhaseDisplayButton.getComp());</b>
<b class="nc">&nbsp;            String ttKey = &quot;MovementDisplay.&quot; + cmd.getCmd() + &quot;.tooltip&quot;;</b>
<b class="nc">&nbsp;            if (Messages.keyExists(ttKey)) {</b>
<b class="nc">&nbsp;                newButton.setToolTipText(Messages.getString(ttKey));</b>
&nbsp;            }
<b class="nc">&nbsp;            newButton.addActionListener(this);</b>
<b class="nc">&nbsp;            newButton.setActionCommand(cmd.getCmd());</b>
<b class="nc">&nbsp;            if (clientgui != null) {</b>
<b class="nc">&nbsp;                newButton.setEnabled(false);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                newButton.setEnabled(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            buttons.put(cmd, newButton);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot;</b>
<b class="nc">&nbsp;                        + Messages.getString(&quot;MovementDisplay.butDone&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butDone.setEnabled(false);</b>
&nbsp;
<b class="nc">&nbsp;        layoutScreen();</b>
<b class="nc">&nbsp;        setupButtonPanel();</b>
&nbsp;
<b class="nc">&nbsp;        gear = MovementDisplay.GEAR_LAND;</b>
<b class="nc">&nbsp;        shiftheld = false;</b>
&nbsp;        
<b class="nc">&nbsp;        registerKeyCommands();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Register all of the &lt;code&gt;CommandAction&lt;/code&gt;s for this panel display.
&nbsp;     */
&nbsp;    private void registerKeyCommands() {
<b class="nc">&nbsp;        if (clientgui == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        MegaMekController controller = clientgui.controller;</b>
&nbsp;
<b class="nc">&nbsp;        if (controller == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        final StatusBarPhaseDisplay display = this;</b>
&nbsp;        // Register the action for TURN_LEFT
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.TURN_LEFT.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (!clientgui.getClient().isMyTurn()</b>
<b class="nc">&nbsp;                                || clientgui.bv.getChatterBoxActive()</b>
<b class="nc">&nbsp;                                || display.isIgnoringEvents()</b>
<b class="nc">&nbsp;                                || !display.isVisible()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        int curDir = cmd.getFinalFacing();</b>
<b class="nc">&nbsp;                        int dir = curDir;</b>
<b class="nc">&nbsp;                        dir = (dir + 5) % 6;</b>
<b class="nc">&nbsp;                        Coords curPos = cmd.getFinalCoords();</b>
<b class="nc">&nbsp;                        Coords target = curPos.translated(dir);</b>
&nbsp;                        // We need to set this to get the rotate behavior
<b class="nc">&nbsp;                        shiftheld = true;</b>
<b class="nc">&nbsp;                        currentMove(target);</b>
<b class="nc">&nbsp;                        shiftheld = false;</b>
<b class="nc">&nbsp;                        clientgui.bv.drawMovementData(ce(), cmd);</b>
&nbsp;                    }
&nbsp;                });
&nbsp;
&nbsp;        // Register the action for TURN_RIGHT
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.TURN_RIGHT.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (!clientgui.getClient().isMyTurn()</b>
<b class="nc">&nbsp;                                || clientgui.bv.getChatterBoxActive()</b>
<b class="nc">&nbsp;                                || display.isIgnoringEvents()</b>
<b class="nc">&nbsp;                                || !display.isVisible()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        int curDir = cmd.getFinalFacing();</b>
<b class="nc">&nbsp;                        int dir = curDir;</b>
<b class="nc">&nbsp;                        dir = (dir + 7) % 6;</b>
<b class="nc">&nbsp;                        Coords curPos = cmd.getFinalCoords();</b>
<b class="nc">&nbsp;                        Coords target = curPos.translated(dir);</b>
&nbsp;                        // We need to set this to get the rotate behavior
<b class="nc">&nbsp;                        shiftheld = true;</b>
<b class="nc">&nbsp;                        currentMove(target);</b>
<b class="nc">&nbsp;                        shiftheld = false;</b>
<b class="nc">&nbsp;                        clientgui.bv.drawMovementData(ce(), cmd);</b>
&nbsp;                    }
&nbsp;                });
&nbsp;
&nbsp;        // Register the action for UNDO
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.UNDO.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (!clientgui.getClient().isMyTurn()</b>
<b class="nc">&nbsp;                                || clientgui.bv.getChatterBoxActive()</b>
<b class="nc">&nbsp;                                || display.isIgnoringEvents()</b>
<b class="nc">&nbsp;                                || !display.isVisible()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        removeLastStep();</b>
<b class="nc">&nbsp;                        computeMovementEnvelope(ce());</b>
&nbsp;                    }
&nbsp;                });
&nbsp;
&nbsp;        // Register the action for NEXT_UNIT
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.NEXT_UNIT.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (!clientgui.getClient().isMyTurn()</b>
<b class="nc">&nbsp;                                || clientgui.bv.getChatterBoxActive()</b>
<b class="nc">&nbsp;                                || !display.isVisible()</b>
<b class="nc">&nbsp;                                || display.isIgnoringEvents()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        selectEntity(clientgui.getClient()</b>
<b class="nc">&nbsp;                                .getNextEntityNum(cen));</b>
&nbsp;                    }
&nbsp;                });
&nbsp;
&nbsp;        // Register the action for PREV_UNIT
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.PREV_UNIT.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (!clientgui.getClient().isMyTurn()</b>
<b class="nc">&nbsp;                                || clientgui.bv.getChatterBoxActive()</b>
<b class="nc">&nbsp;                                || !display.isVisible()</b>
<b class="nc">&nbsp;                                || display.isIgnoringEvents()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        selectEntity(clientgui.getClient()</b>
<b class="nc">&nbsp;                                .getPrevEntityNum(cen));</b>
&nbsp;                    }
&nbsp;                });
&nbsp;
&nbsp;        // Register the action for MOVE_ENVELOPE
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.MOVE_ENVELOPE.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (clientgui.bv.getChatterBoxActive()</b>
<b class="nc">&nbsp;                                || !display.isVisible()</b>
<b class="nc">&nbsp;                                || display.isIgnoringEvents()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        GUIPreferences.getInstance().setMoveEnvelope(</b>
<b class="nc">&nbsp;                                !GUIPreferences.getInstance().getMoveEnvelope());</b>
<b class="nc">&nbsp;                        if (GUIPreferences.getInstance().getMoveEnvelope()) {</b>
<b class="nc">&nbsp;                            computeMovementEnvelope(clientgui.mechD</b>
<b class="nc">&nbsp;                                    .getCurrentEntity());</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            clientgui.bv.clearMovementEnvelope();</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                });
&nbsp;
&nbsp;        // Register the action for CLEAR
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.CANCEL.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (clientgui.bv.getChatterBoxActive()</b>
<b class="nc">&nbsp;                                || !display.isVisible()</b>
<b class="nc">&nbsp;                                || display.isIgnoringEvents()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        clear();</b>
<b class="nc">&nbsp;                        computeMovementEnvelope(ce());</b>
&nbsp;                    }
&nbsp;                });
&nbsp;        
&nbsp;        // Command to toggle between jumping and walk/run
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.TOGGLE_MOVEMODE.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (!clientgui.getClient().isMyTurn()</b>
<b class="nc">&nbsp;                                || clientgui.bv.getChatterBoxActive()</b>
<b class="nc">&nbsp;                                || !display.isVisible()</b>
<b class="nc">&nbsp;                                || display.isIgnoringEvents()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        final Entity ce = ce();</b>
<b class="nc">&nbsp;                        boolean isAero = ce.isAero();</b>
&nbsp;                        // first check if jumping is available at all
<b class="nc">&nbsp;                        if (!isAero &amp;&amp; !ce.isImmobile() &amp;&amp; (ce.getJumpMP() &gt; 0)</b>
<b class="nc">&nbsp;                                &amp;&amp; !(ce.isStuck() &amp;&amp; !ce.canUnstickByJumping())) {</b>
<b class="nc">&nbsp;                            if (gear != MovementDisplay.GEAR_JUMP) {</b>
<b class="nc">&nbsp;                                if (!((cmd.getLastStep() != null)</b>
<b class="nc">&nbsp;                                        &amp;&amp; cmd.getLastStep().isFirstStep() </b>
<b class="nc">&nbsp;                                        &amp;&amp; (cmd.getLastStep().getType() </b>
&nbsp;                                                == MoveStepType.LAY_MINE))) {
<b class="nc">&nbsp;                                    clear();</b>
&nbsp;                                }
<b class="nc">&nbsp;                                if (!cmd.isJumping()) {</b>
<b class="nc">&nbsp;                                    cmd.addStep(MoveStepType.START_JUMP);</b>
&nbsp;                                }
<b class="nc">&nbsp;                                gear = MovementDisplay.GEAR_JUMP;</b>
<b class="nc">&nbsp;                                Color jumpColor = GUIPreferences.getInstance().getColor(</b>
&nbsp;                                        GUIPreferences.ADVANCED_MOVE_JUMP_COLOR);
<b class="nc">&nbsp;                                clientgui.getBoardView().setHighlightColor(jumpColor);</b>
<b class="nc">&nbsp;                            } else {</b>
<b class="nc">&nbsp;                                Color walkColor = GUIPreferences.getInstance().getColor(</b>
&nbsp;                                        GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<b class="nc">&nbsp;                                clientgui.getBoardView().setHighlightColor(walkColor);</b>
<b class="nc">&nbsp;                                gear = MovementDisplay.GEAR_LAND;</b>
<b class="nc">&nbsp;                                clear();</b>
<b class="nc">&nbsp;                            }</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            Color walkColor = GUIPreferences.getInstance().getColor(</b>
&nbsp;                                    GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<b class="nc">&nbsp;                            clientgui.getBoardView().setHighlightColor(walkColor);</b>
<b class="nc">&nbsp;                            gear = MovementDisplay.GEAR_LAND;</b>
<b class="nc">&nbsp;                            clear();</b>
&nbsp;                        }
<b class="nc">&nbsp;                        computeMovementEnvelope(ce); </b>
&nbsp;                    }
&nbsp;        });
&nbsp;
&nbsp;        // Register the action for mode conversion
<b class="nc">&nbsp;        controller.registerCommandAction(KeyCommandBind.TOGGLE_CONVERSIONMODE.cmd,</b>
<b class="nc">&nbsp;                new CommandAction() {</b>
&nbsp;
&nbsp;                    @Override
&nbsp;                    public boolean shouldPerformAction() {
<b class="nc">&nbsp;                        if (!clientgui.getClient().isMyTurn()</b>
<b class="nc">&nbsp;                                || clientgui.bv.getChatterBoxActive()</b>
<b class="nc">&nbsp;                                || display.isIgnoringEvents()</b>
<b class="nc">&nbsp;                                || !display.isVisible()) {</b>
<b class="nc">&nbsp;                            return false;</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void performAction() {
<b class="nc">&nbsp;                        EntityMovementMode nextMode = ce().nextConversionMode(cmd.getFinalConversionMode());</b>
&nbsp;                        // LAMs may have to skip the next mode due to damage
<b class="nc">&nbsp;                        if (ce() instanceof LandAirMech) {</b>
<b class="nc">&nbsp;                            if (!((LandAirMech)ce()).canConvertTo(nextMode)) {</b>
<b class="nc">&nbsp;                                nextMode = ce().nextConversionMode(nextMode);</b>
&nbsp;                            }
<b class="nc">&nbsp;                            if (!((LandAirMech)ce()).canConvertTo(nextMode)) {</b>
<b class="nc">&nbsp;                                nextMode = ce().getMovementMode();</b>
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                        adjustConvertSteps(nextMode);</b>
<b class="nc">&nbsp;                        clientgui.bv.drawMovementData(ce(), cmd);</b>
&nbsp;                    }
&nbsp;                });
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Return the button list: we need to determine what unit type is selected
&nbsp;     * and then get a button list appropriate for that unit.
&nbsp;     */
&nbsp;    protected ArrayList&lt;MegamekButton&gt; getButtonList() {
&nbsp;        int flag;
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        flag = CMD_MECH;</b>
<b class="nc">&nbsp;        if (ce != null) {</b>
<b class="nc">&nbsp;            if (ce instanceof Infantry) {</b>
<b class="nc">&nbsp;                flag = CMD_INF;</b>
<b class="nc">&nbsp;            } else if (ce instanceof VTOL) {</b>
<b class="nc">&nbsp;                flag = CMD_VTOL;</b>
<b class="nc">&nbsp;            } else if (ce instanceof Tank) {</b>
<b class="nc">&nbsp;                flag = CMD_TANK;</b>
<b class="nc">&nbsp;            } else if (ce.isAero()) {</b>
<b class="nc">&nbsp;                if (ce.isAirborne()</b>
<b class="nc">&nbsp;                    &amp;&amp; clientgui.getClient().getGame().useVectorMove()) {</b>
<b class="nc">&nbsp;                    flag = CMD_AERO_VECTORED;</b>
<b class="nc">&nbsp;                } else if (ce.isAirborne()</b>
<b class="nc">&nbsp;                           &amp;&amp; !clientgui.getClient().getGame().useVectorMove()) {</b>
<b class="nc">&nbsp;                    flag = CMD_AERO;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    flag = CMD_TANK;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (ce instanceof LandAirMech) {</b>
<b class="nc">&nbsp;                    flag |= CMD_CONVERTER;</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (ce instanceof QuadVee) {</b>
<b class="nc">&nbsp;                if (ce.getConversionMode() == QuadVee.CONV_MODE_MECH) {</b>
<b class="nc">&nbsp;                    flag = CMD_MECH | CMD_CONVERTER;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    flag = CMD_TANK | CMD_CONVERTER;</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (ce instanceof LandAirMech) {</b>
<b class="nc">&nbsp;                if (ce.getConversionMode() == LandAirMech.CONV_MODE_AIRMECH) {</b>
<b class="nc">&nbsp;                    flag = CMD_TANK | CMD_CONVERTER | CMD_AIRMECH;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    flag = CMD_MECH | CMD_CONVERTER;</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (ce instanceof Mech &amp;&amp; ((Mech)ce).hasTracks()) {</b>
<b class="nc">&nbsp;                flag = CMD_MECH | CMD_CONVERTER;</b>
<b class="nc">&nbsp;            } else if (ce instanceof Protomech &amp;&amp; ce.getMovementMode() == EntityMovementMode.WIGE) {</b>
<b class="nc">&nbsp;                flag = CMD_MECH | CMD_AIRMECH;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return getButtonList(flag);</b>
&nbsp;    }
&nbsp;
&nbsp;    private ArrayList&lt;MegamekButton&gt; getButtonList(int flag) {
<b class="nc">&nbsp;        boolean forwardIni = false;</b>
<b class="nc">&nbsp;        GameOptions opts = null;</b>
<b class="nc">&nbsp;        if (clientgui != null) {</b>
<b class="nc">&nbsp;            IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;            IPlayer localPlayer = clientgui.getClient().getLocalPlayer();</b>
<b class="nc">&nbsp;            forwardIni = (game.getTeamForPlayer(localPlayer) != null)</b>
<b class="nc">&nbsp;                    &amp;&amp; (game.getTeamForPlayer(localPlayer).getSize() &gt; 1);</b>
<b class="nc">&nbsp;            opts = game.getOptions();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ArrayList&lt;MegamekButton&gt; buttonList = new ArrayList&lt;MegamekButton&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        int i = 0;</b>
<b class="nc">&nbsp;        MoveCommand commands[] = MoveCommand.values(flag, opts, forwardIni);</b>
<b class="nc">&nbsp;        CommandComparator comparator = new CommandComparator();</b>
<b class="nc">&nbsp;        Arrays.sort(commands, comparator);</b>
<b class="nc">&nbsp;        for (MoveCommand cmd : commands) {</b>
<b class="nc">&nbsp;            if (i % buttonsPerGroup == 0) {</b>
<b class="nc">&nbsp;                buttonList.add(getBtn(MoveCommand.MOVE_NEXT));</b>
<b class="nc">&nbsp;                i++;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            buttonList.add(buttons.get(cmd));</b>
<b class="nc">&nbsp;            i++;</b>
&nbsp;
<b class="nc">&nbsp;            if ((i + 1) % buttonsPerGroup == 0) {</b>
<b class="nc">&nbsp;                buttonList.add(getBtn(MoveCommand.MOVE_MORE));</b>
<b class="nc">&nbsp;                i++;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (!buttonList.get(i - 1).getActionCommand()</b>
<b class="nc">&nbsp;                       .equals(MoveCommand.MOVE_MORE.getCmd())) {</b>
<b class="nc">&nbsp;            while ((i + 1) % buttonsPerGroup != 0) {</b>
<b class="nc">&nbsp;                buttonList.add(null);</b>
<b class="nc">&nbsp;                i++;</b>
&nbsp;            }
<b class="nc">&nbsp;            buttonList.add(getBtn(MoveCommand.MOVE_MORE));</b>
&nbsp;        }
<b class="nc">&nbsp;        numButtonGroups = (int) Math.ceil((buttonList.size() + 0.0)</b>
&nbsp;                                          / buttonsPerGroup);
<b class="nc">&nbsp;        return buttonList;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Hands over the current turn to the next valid player on the same team as
&nbsp;     * the supplied player. If no player on the team apart from this player has
&nbsp;     * any turns left it activates this player again.
&nbsp;     */
&nbsp;    public synchronized void selectNextPlayer() {
<b class="nc">&nbsp;        clientgui.getClient().sendNextPlayer();</b>
&nbsp;        // endMyTurn();
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Selects an entity, by number, for movement.
&nbsp;     */
&nbsp;    public synchronized void selectEntity(int en) {
<b class="nc">&nbsp;        final Entity ce = clientgui.getClient().getGame().getEntity(en);</b>
&nbsp;
&nbsp;        // hmm, sometimes this gets called when there&#39;s no ready entities?
<b class="nc">&nbsp;        if (ce == null) {</b>
<b class="nc">&nbsp;            System.err.println(&quot;MovementDisplay: tried to &quot;</b>
&nbsp;                               + &quot;select non-existant entity: &quot; + en); //$NON-NLS-1$
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if ((ce() != null) &amp;&amp; ce().isWeapOrderChanged()) {</b>
<b class="nc">&nbsp;            clientgui.getClient().sendEntityWeaponOrderUpdate(ce());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        cen = en;</b>
<b class="nc">&nbsp;        clientgui.setSelectedEntityNum(en);</b>
<b class="nc">&nbsp;        gear = MovementDisplay.GEAR_LAND;</b>
<b class="nc">&nbsp;        Color walkColor = GUIPreferences.getInstance().getColor(</b>
&nbsp;                GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<b class="nc">&nbsp;        clientgui.getBoardView().setHighlightColor(walkColor);</b>
<b class="nc">&nbsp;        clear();</b>
&nbsp;        
<b class="nc">&nbsp;        updateButtons();</b>
&nbsp;        // Update the menu bar.
<b class="nc">&nbsp;        clientgui.getMenuBar().setEntity(ce);</b>
<b class="nc">&nbsp;        clientgui.getBoardView().highlight(ce.getPosition());</b>
<b class="nc">&nbsp;        clientgui.getBoardView().select(null);</b>
<b class="nc">&nbsp;        clientgui.getBoardView().cursor(null);</b>
<b class="nc">&nbsp;        clientgui.mechD.displayEntity(ce);</b>
<b class="nc">&nbsp;        clientgui.mechD.showPanel(&quot;movement&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        if (!clientgui.bv.isMovingUnits()) {</b>
<b class="nc">&nbsp;            clientgui.bv.centerOnHex(ce.getPosition());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        String yourTurnMsg = Messages</b>
<b class="nc">&nbsp;                .getString(&quot;MovementDisplay.its_your_turn&quot;);</b>
<b class="nc">&nbsp;        if (ce.hasQuirk(OptionsConstants.QUIRK_NEG_POOR_PERFORMANCE)) {</b>
&nbsp;            String poorPerfMsg;
<b class="nc">&nbsp;            if (ce.getMpUsedLastRound() &lt; ce.getWalkMP()) {</b>
<b class="nc">&nbsp;                poorPerfMsg = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.NotUpToSpeed&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                poorPerfMsg = Messages.getString(&quot;MovementDisplay.UpToSpeed&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            setStatusBarText(&quot;&lt;html&gt;&lt;center&gt;&quot; + yourTurnMsg + &quot;&lt;br&gt;&quot;</b>
&nbsp;                             + poorPerfMsg + &quot;&lt;/center&gt;&lt;/html&gt;&quot;);
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            setStatusBarText(yourTurnMsg);</b>
&nbsp;        }
<b class="nc">&nbsp;        clientgui.bv.clearFieldofF();</b>
<b class="nc">&nbsp;        computeMovementEnvelope(ce);</b>
&nbsp;    }
&nbsp;
&nbsp;    private MegamekButton getBtn(MoveCommand c) {
<b class="nc">&nbsp;        return buttons.get(c);</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isEnabled(MoveCommand c) {
<b class="nc">&nbsp;        return buttons.get(c).isEnabled();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the buttons to their proper states
&nbsp;     */
&nbsp;    private void updateButtons() {
<b class="nc">&nbsp;        final GameOptions gOpts = clientgui.getClient().getGame().getOptions();</b>
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        boolean isMech = (ce instanceof Mech);</b>
<b class="nc">&nbsp;        boolean isInfantry = (ce instanceof Infantry);</b>
&nbsp;        // boolean isProtomech = (ce instanceof Protomech);
<b class="nc">&nbsp;        boolean isAero = ce.isAero();</b>
&nbsp;
<b class="nc">&nbsp;        if (numButtonGroups &gt; 1)</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_MORE).setEnabled(true);</b>
<b class="nc">&nbsp;        setWalkEnabled(!ce.isImmobile()</b>
<b class="nc">&nbsp;                       &amp;&amp; ((ce.getWalkMP() &gt; 0) || (ce.getRunMP() &gt; 0))</b>
<b class="nc">&nbsp;                       &amp;&amp; !ce.isStuck());</b>
<b class="nc">&nbsp;        setJumpEnabled(!isAero &amp;&amp; !ce.isImmobile() &amp;&amp; (ce.getJumpMP() &gt; 0)</b>
<b class="nc">&nbsp;                       &amp;&amp; !(ce.isStuck() &amp;&amp; !ce.canUnstickByJumping()));</b>
<b class="nc">&nbsp;        setSwimEnabled(!isAero &amp;&amp; !ce.isImmobile() &amp;&amp; ce.getActiveUMUCount() &gt; 0</b>
<b class="nc">&nbsp;                       &amp;&amp; ce.isUnderwater());</b>
<b class="nc">&nbsp;        setBackUpEnabled(!isAero &amp;&amp; isEnabled(MoveCommand.MOVE_WALK));</b>
<b class="nc">&nbsp;        setChargeEnabled(ce.canCharge());</b>
<b class="nc">&nbsp;        setDFAEnabled(ce.canDFA());</b>
<b class="nc">&nbsp;        setRamEnabled(ce.canRam());</b>
&nbsp;
<b class="nc">&nbsp;        if (isInfantry) {</b>
<b class="nc">&nbsp;            if (clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                         .containsMinefield(ce.getPosition())) {</b>
<b class="nc">&nbsp;                setClearEnabled(true);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                setClearEnabled(false);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            setClearEnabled(false);</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((ce.getMovementMode() == EntityMovementMode.HYDROFOIL)</b>
<b class="nc">&nbsp;            || (ce.getMovementMode() == EntityMovementMode.NAVAL)</b>
<b class="nc">&nbsp;            || (ce.getMovementMode() == EntityMovementMode.SUBMARINE)</b>
<b class="nc">&nbsp;            || (ce.getMovementMode() == EntityMovementMode.INF_UMU)</b>
<b class="nc">&nbsp;            || (ce.getMovementMode() == EntityMovementMode.VTOL)</b>
<b class="nc">&nbsp;            || (ce.getMovementMode() == EntityMovementMode.BIPED_SWIM)</b>
<b class="nc">&nbsp;            || (ce.getMovementMode() == EntityMovementMode.QUAD_SWIM)) {</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_CLIMB_MODE).setEnabled(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_CLIMB_MODE).setEnabled(true);</b>
&nbsp;        }
<b class="nc">&nbsp;        updateTurnButton();</b>
&nbsp;
<b class="nc">&nbsp;        updateProneButtons();</b>
<b class="nc">&nbsp;        updateRACButton();</b>
<b class="nc">&nbsp;        updateSearchlightButton();</b>
<b class="nc">&nbsp;        updateLoadButtons();</b>
<b class="nc">&nbsp;        updateElevationButtons();</b>
<b class="nc">&nbsp;        updateTakeOffButtons();</b>
<b class="nc">&nbsp;        updateLandButtons();</b>
<b class="nc">&nbsp;        updateJoinButton();</b>
<b class="nc">&nbsp;        updateRecoveryButton();</b>
<b class="nc">&nbsp;        updateDumpButton();</b>
<b class="nc">&nbsp;        updateEvadeButton();</b>
<b class="nc">&nbsp;        updateBootleggerButton();</b>
<b class="nc">&nbsp;        updateLayMineButton();</b>
&nbsp;
<b class="nc">&nbsp;        updateStartupButton();</b>
<b class="nc">&nbsp;        updateShutdownButton();</b>
&nbsp;
<b class="nc">&nbsp;        updateAeroButtons();</b>
&nbsp;
<b class="nc">&nbsp;        updateSpeedButtons();</b>
<b class="nc">&nbsp;        updateThrustButton();</b>
<b class="nc">&nbsp;        updateRollButton();</b>
<b class="nc">&nbsp;        checkFuel();</b>
<b class="nc">&nbsp;        checkOOC();</b>
<b class="nc">&nbsp;        checkAtmosphere();</b>
<b class="nc">&nbsp;        updateFlyOffButton();</b>
<b class="nc">&nbsp;        updateLaunchButton();</b>
<b class="nc">&nbsp;        updateDropButton();</b>
<b class="nc">&nbsp;        updateConvertModeButton();</b>
<b class="nc">&nbsp;        updateRecklessButton();</b>
<b class="nc">&nbsp;        updateHoverButton();</b>
<b class="nc">&nbsp;        updateManeuverButton();</b>
<b class="nc">&nbsp;        updateStrafeButton();</b>
<b class="nc">&nbsp;        updateBombButton();</b>
&nbsp;
&nbsp;        // Infantry - Fortify
<b class="nc">&nbsp;        if (isInfantry</b>
<b class="nc">&nbsp;            &amp;&amp; ce.hasWorkingMisc(MiscType.F_TOOLS, MiscType.S_VIBROSHOVEL)) {</b>
&nbsp;            // Crews adrift in space or atmosphere can&#39;t do this
<b class="nc">&nbsp;            if (ce instanceof EjectedCrew &amp;&amp; (ce.isSpaceborne() || ce.isAirborne())) {</b>
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(false);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_FORTIFY).setEnabled(true);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_FORTIFY).setEnabled(false);</b>
&nbsp;        }
&nbsp;        // Infantry - Digging in
<b class="nc">&nbsp;        if (isInfantry &amp;&amp; gOpts.booleanOption(OptionsConstants.ADVANCED_TACOPS_DIG_IN)) {</b>
&nbsp;            // Crews adrift in space or atmosphere can&#39;t do this
<b class="nc">&nbsp;            if (ce instanceof EjectedCrew &amp;&amp; (ce.isSpaceborne() || ce.isAirborne())) {</b>
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(false);</b>
&nbsp;            } else {
&nbsp;                // Allow infantry to dig in if they aren&#39;t currently dug in
<b class="nc">&nbsp;                int dugInState = ((Infantry) ce).getDugIn();</b>
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(</b>
&nbsp;                        dugInState == Infantry.DUG_IN_NONE);
<b class="nc">&nbsp;            }</b>
&nbsp;        } else {
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(false);</b>
&nbsp;        }
&nbsp;        // Infantry - Take Cover
&nbsp;        // Crews adrift in space or atmosphere can&#39;t do this
<b class="nc">&nbsp;        if (ce instanceof EjectedCrew &amp;&amp; (ce.isSpaceborne() || ce.isAirborne())) {</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_TAKE_COVER).setEnabled(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            updateTakeCoverButton();</b>
&nbsp;        }
&nbsp;
&nbsp;        // Infantry - Urban Guerrilla calling for support
<b class="nc">&nbsp;        if (isInfantry &amp;&amp; ce.hasAbility(OptionsConstants.INFANTRY_URBAN_GUERRILLA)</b>
<b class="nc">&nbsp;                &amp;&amp; ((Infantry) ce).getCanCallSupport()) {</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_CALL_SUPPORT).setEnabled(true);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_CALL_SUPPORT).setEnabled(false);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_SHAKE_OFF).setEnabled(</b>
&nbsp;                (ce instanceof Tank)
<b class="nc">&nbsp;                &amp;&amp; (ce.getSwarmAttackerId() != Entity.NONE));</b>
&nbsp;
<b class="nc">&nbsp;        setFleeEnabled(ce.canFlee());</b>
<b class="nc">&nbsp;        if (gOpts.booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLES_CAN_EJECT) &amp;&amp; (ce instanceof Tank)) {</b>
&nbsp;            // Vehicle don&#39;t have ejection systems so crews abandon, and must 
&nbsp;            // enter a valid hex, if they cannot they can&#39;t abandon TO pg 197
<b class="nc">&nbsp;            Coords pos = ce().getPosition();</b>
<b class="nc">&nbsp;            Infantry inf = new Infantry();</b>
<b class="nc">&nbsp;            inf.setGame(clientgui.getClient().getGame());</b>
<b class="nc">&nbsp;            boolean hasLegalHex = !inf.isLocationProhibited(pos);</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; 6; i++) {</b>
<b class="nc">&nbsp;                hasLegalHex |= !inf.isLocationProhibited(pos.translated(i));</b>
&nbsp;            }
<b class="nc">&nbsp;            setEjectEnabled(hasLegalHex);</b>
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            setEjectEnabled(((isMech &amp;&amp; (((Mech) ce).getCockpitType() != Mech.COCKPIT_TORSO_MOUNTED)) || isAero)</b>
<b class="nc">&nbsp;                    &amp;&amp; ce.isActive()</b>
<b class="nc">&nbsp;                    &amp;&amp; !ce.hasQuirk(OptionsConstants.QUIRK_NEG_NO_EJECT));</b>
&nbsp;        }
&nbsp;
&nbsp;        // if dropping unit only allow turning
<b class="nc">&nbsp;        if (!ce.isAero() &amp;&amp; cmd.getFinalAltitude() &gt; 0) {</b>
<b class="nc">&nbsp;            disableButtons();</b>
<b class="nc">&nbsp;            if (ce instanceof LandAirMech) {</b>
<b class="nc">&nbsp;                updateConvertModeButton();</b>
<b class="nc">&nbsp;                if (ce.getMovementMode() == EntityMovementMode.WIGE</b>
<b class="nc">&nbsp;                        &amp;&amp; ce.getAltitude() &lt;= 3) {</b>
<b class="nc">&nbsp;                    updateHoverButton();</b>
&nbsp;                }
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_MORE).setEnabled(numButtonGroups &gt; 1);</b>
&nbsp;            }
<b class="nc">&nbsp;            butDone.setEnabled(true);</b>
&nbsp;        }
&nbsp;
&nbsp;
&nbsp;        // if small craft/dropship that has unloaded units, then only allowed
&nbsp;        // to unload more
<b class="nc">&nbsp;        if (ce.hasUnloadedUnitsFromBays()) {</b>
<b class="nc">&nbsp;            disableButtons();</b>
<b class="nc">&nbsp;            updateLoadButtons();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setupButtonPanel();</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void updateAeroButtons() {
<b class="nc">&nbsp;        if (ce() != null &amp;&amp; ce().isAero()) {</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_THRUST).setEnabled(true);</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_YAW).setEnabled(true);</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_END_OVER).setEnabled(true);</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_TURN_LEFT).setEnabled(true);</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_TURN_RIGHT).setEnabled(true);</b>
<b class="nc">&nbsp;            setEvadeAeroEnabled(cmd != null &amp;&amp; !cmd.contains(MoveStepType.EVADE));</b>
<b class="nc">&nbsp;            setEjectEnabled(true);</b>
&nbsp;            // no turning for spheroids in atmosphere
<b class="nc">&nbsp;            if ((((IAero) ce()).isSpheroid() || clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                    .getPlanetaryConditions().isVacuum())</b>
<b class="nc">&nbsp;                    &amp;&amp; !clientgui.getClient().getGame().getBoard().inSpace()) {</b>
<b class="nc">&nbsp;                setTurnEnabled(false);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Enables relevant buttons and sets up for your turn.
&nbsp;     */
&nbsp;    private void beginMyTurn() {
<b class="nc">&nbsp;        setStatusBarText(Messages.getString(&quot;MovementDisplay.its_your_turn&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Done&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        butDone.setEnabled(true);</b>
<b class="nc">&nbsp;        setNextEnabled(true);</b>
<b class="nc">&nbsp;        setForwardIniEnabled(true);</b>
<b class="nc">&nbsp;        clientgui.bv.clearFieldofF();</b>
<b class="nc">&nbsp;        if (numButtonGroups &gt; 1)</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_MORE).setEnabled(true);</b>
<b class="nc">&nbsp;        if (!clientgui.bv.isMovingUnits()) {</b>
<b class="nc">&nbsp;            clientgui.setDisplayVisible(true);</b>
&nbsp;        }
<b class="nc">&nbsp;        selectEntity(clientgui.getClient().getFirstEntityNum());</b>
&nbsp;        //check if there should be a turn timer running
<b class="nc">&nbsp;        tt = TurnTimer.init(this, clientgui.getClient());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Clears out old movement data and disables relevant buttons.
&nbsp;     */
&nbsp;    private synchronized void endMyTurn() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
&nbsp;        //get rid of still running timer, if turn is concluded before time is up
<b class="nc">&nbsp;        if (tt != null) {</b>
<b class="nc">&nbsp;            tt.stopTimer();</b>
<b class="nc">&nbsp;            tt = null;</b>
&nbsp;        }
&nbsp;
&nbsp;        // end my turn, then.
<b class="nc">&nbsp;        disableButtons();</b>
<b class="nc">&nbsp;        Entity next = clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                .getNextEntity(clientgui.getClient().getGame().getTurnIndex());</b>
<b class="nc">&nbsp;        if ((IGame.Phase.PHASE_MOVEMENT == clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                .getPhase())</b>
&nbsp;                &amp;&amp; (null != next)
&nbsp;                &amp;&amp; (null != ce)
<b class="nc">&nbsp;                &amp;&amp; (next.getOwnerId() != ce.getOwnerId())) {</b>
<b class="nc">&nbsp;            clientgui.setDisplayVisible(false);</b>
&nbsp;        }
<b class="nc">&nbsp;        cen = Entity.NONE;</b>
<b class="nc">&nbsp;        clientgui.getBoardView().select(null);</b>
<b class="nc">&nbsp;        clientgui.getBoardView().highlight(null);</b>
&nbsp;        // Return the highlight sprite back to its original color
<b class="nc">&nbsp;        clientgui.getBoardView().setHighlightColor(Color.white);</b>
<b class="nc">&nbsp;        clientgui.getBoardView().cursor(null);</b>
<b class="nc">&nbsp;        clientgui.getBoardView().selectEntity(null);</b>
<b class="nc">&nbsp;        clientgui.setSelectedEntityNum(Entity.NONE);</b>
<b class="nc">&nbsp;        clientgui.bv.clearMovementData();</b>
<b class="nc">&nbsp;        clientgui.bv.clearFieldofF();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Disables all buttons in the interface
&nbsp;     */
&nbsp;    private void disableButtons() {
<b class="nc">&nbsp;        setWalkEnabled(false);</b>
<b class="nc">&nbsp;        setJumpEnabled(false);</b>
<b class="nc">&nbsp;        setBackUpEnabled(false);</b>
<b class="nc">&nbsp;        setTurnEnabled(false);</b>
<b class="nc">&nbsp;        setFleeEnabled(false);</b>
<b class="nc">&nbsp;        setFlyOffEnabled(false);</b>
<b class="nc">&nbsp;        setEjectEnabled(false);</b>
<b class="nc">&nbsp;        setUnjamEnabled(false);</b>
<b class="nc">&nbsp;        setSearchlightEnabled(false, false);</b>
<b class="nc">&nbsp;        setGetUpEnabled(false);</b>
<b class="nc">&nbsp;        setGoProneEnabled(false);</b>
<b class="nc">&nbsp;        setChargeEnabled(false);</b>
<b class="nc">&nbsp;        setDFAEnabled(false);</b>
<b class="nc">&nbsp;        setNextEnabled(false);</b>
<b class="nc">&nbsp;        setForwardIniEnabled(false);</b>
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_MORE).setEnabled(false);</b>
<b class="nc">&nbsp;        butDone.setEnabled(false);</b>
<b class="nc">&nbsp;        setLoadEnabled(false);</b>
<b class="nc">&nbsp;        setMountEnabled(false);</b>
<b class="nc">&nbsp;        setTowEnabled(false);</b>
<b class="nc">&nbsp;        setUnloadEnabled(false);</b>
<b class="nc">&nbsp;        setDisconnectEnabled(false);</b>
<b class="nc">&nbsp;        setClearEnabled(false);</b>
<b class="nc">&nbsp;        setHullDownEnabled(false);</b>
<b class="nc">&nbsp;        setSwimEnabled(false);</b>
<b class="nc">&nbsp;        setModeConvertEnabled(false);</b>
<b class="nc">&nbsp;        setAccEnabled(false);</b>
<b class="nc">&nbsp;        setDecEnabled(false);</b>
<b class="nc">&nbsp;        setEvadeEnabled(false);</b>
<b class="nc">&nbsp;        setBootleggerEnabled(false);</b>
<b class="nc">&nbsp;        setShutdownEnabled(false);</b>
<b class="nc">&nbsp;        setStartupEnabled(false);</b>
<b class="nc">&nbsp;        setSelfDestructEnabled(false);</b>
<b class="nc">&nbsp;        setTraitorEnabled(false);</b>
<b class="nc">&nbsp;        setEvadeAeroEnabled(false);</b>
<b class="nc">&nbsp;        setAccNEnabled(false);</b>
<b class="nc">&nbsp;        setDecNEnabled(false);</b>
<b class="nc">&nbsp;        setRollEnabled(false);</b>
<b class="nc">&nbsp;        setLaunchEnabled(false);</b>
<b class="nc">&nbsp;        setDockEnabled(false);</b>
<b class="nc">&nbsp;        setDropEnabled(false);</b>
<b class="nc">&nbsp;        setThrustEnabled(false);</b>
<b class="nc">&nbsp;        setYawEnabled(false);</b>
<b class="nc">&nbsp;        setEndOverEnabled(false);</b>
<b class="nc">&nbsp;        setTurnLeftEnabled(false);</b>
<b class="nc">&nbsp;        setTurnRightEnabled(false);</b>
<b class="nc">&nbsp;        setDumpEnabled(false);</b>
<b class="nc">&nbsp;        setRamEnabled(false);</b>
<b class="nc">&nbsp;        setHoverEnabled(false);</b>
<b class="nc">&nbsp;        setJoinEnabled(false);</b>
<b class="nc">&nbsp;        setTakeOffEnabled(false);</b>
<b class="nc">&nbsp;        setVTakeOffEnabled(false);</b>
<b class="nc">&nbsp;        setLandEnabled(false);</b>
<b class="nc">&nbsp;        setVLandEnabled(false);</b>
<b class="nc">&nbsp;        setLowerEnabled(false);</b>
<b class="nc">&nbsp;        setRaiseEnabled(false);</b>
<b class="nc">&nbsp;        setRecklessEnabled(false);</b>
<b class="nc">&nbsp;        setGoProneEnabled(false);</b>
<b class="nc">&nbsp;        setManeuverEnabled(false);</b>
<b class="nc">&nbsp;        setStrafeEnabled(false);</b>
<b class="nc">&nbsp;        setBombEnabled(false);</b>
&nbsp;
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_CLIMB_MODE).setEnabled(false);</b>
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(false);</b>
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_CALL_SUPPORT).setEnabled(false);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Clears out the currently selected movement data and resets it.
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void clear() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
&nbsp;        // clear board cursors
<b class="nc">&nbsp;        clientgui.getBoardView().select(null);</b>
<b class="nc">&nbsp;        clientgui.getBoardView().cursor(null);</b>
<b class="nc">&nbsp;        clientgui.getBoardView().clearMovementEnvelope();</b>
&nbsp;
<b class="nc">&nbsp;        if (ce == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Remove Careful stand, in case it was set
<b class="nc">&nbsp;        ce.setCarefulStand(false);</b>
<b class="nc">&nbsp;        ce.setIsJumpingNow(false);</b>
<b class="nc">&nbsp;        ce.setConvertingNow(false);</b>
<b class="nc">&nbsp;        ce.setClimbMode(GUIPreferences.getInstance().getBoolean(GUIPreferences.ADVANCED_MOVE_DEFAULT_CLIMB_MODE));</b>
&nbsp;
&nbsp;        // switch back from swimming to normal mode.
<b class="nc">&nbsp;        if (ce.getMovementMode() == EntityMovementMode.BIPED_SWIM) {</b>
<b class="nc">&nbsp;            ce.setMovementMode(EntityMovementMode.BIPED);</b>
<b class="nc">&nbsp;        } else if (ce.getMovementMode() == EntityMovementMode.QUAD_SWIM) {</b>
<b class="nc">&nbsp;            ce.setMovementMode(EntityMovementMode.QUAD);</b>
&nbsp;        }
&nbsp;        
&nbsp;        // create new current and considered paths
<b class="nc">&nbsp;        cmd = new MovePath(clientgui.getClient().getGame(), ce);</b>
<b class="nc">&nbsp;        clientgui.bv.setWeaponFieldofFire(ce, cmd);</b>
&nbsp;
&nbsp;        // set to &quot;walk,&quot; or the equivalent
<b class="nc">&nbsp;        if (gear != MovementDisplay.GEAR_JUMP) {</b>
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_LAND;</b>
<b class="nc">&nbsp;            Color walkColor = GUIPreferences.getInstance().getColor(</b>
&nbsp;                    GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<b class="nc">&nbsp;            clientgui.getBoardView().setHighlightColor(walkColor);</b>
<b class="nc">&nbsp;        } else if (!cmd.isJumping()) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.START_JUMP);</b>
&nbsp;        }
&nbsp;
&nbsp;        // update some GUI elements
<b class="nc">&nbsp;        clientgui.bv.clearMovementData();</b>
<b class="nc">&nbsp;        butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot;</b>
<b class="nc">&nbsp;                        + Messages.getString(&quot;MovementDisplay.Done&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        updateProneButtons();</b>
<b class="nc">&nbsp;        updateRACButton();</b>
<b class="nc">&nbsp;        updateSearchlightButton();</b>
<b class="nc">&nbsp;        updateElevationButtons();</b>
<b class="nc">&nbsp;        updateTakeOffButtons();</b>
<b class="nc">&nbsp;        updateLandButtons();</b>
<b class="nc">&nbsp;        updateFlyOffButton();</b>
<b class="nc">&nbsp;        updateLaunchButton();</b>
<b class="nc">&nbsp;        updateDropButton();</b>
<b class="nc">&nbsp;        updateConvertModeButton();</b>
<b class="nc">&nbsp;        updateRecklessButton();</b>
<b class="nc">&nbsp;        updateHoverButton();</b>
<b class="nc">&nbsp;        updateManeuverButton();</b>
<b class="nc">&nbsp;        updateAeroButtons();</b>
<b class="nc">&nbsp;        updateLayMineButton();</b>
&nbsp;
<b class="nc">&nbsp;        loadedUnits = ce.getLoadedUnits();</b>
<b class="nc">&nbsp;        if (ce instanceof Aero) {</b>
<b class="nc">&nbsp;            for (Entity e : ce.getUnitsUnloadableFromBays()) {</b>
<b class="nc">&nbsp;                if (!loadedUnits.contains(e)) {</b>
<b class="nc">&nbsp;                    loadedUnits.add(e);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        towedUnits = ce.getLoadedTrailers();</b>
&nbsp;
<b class="nc">&nbsp;        updateLoadButtons();</b>
<b class="nc">&nbsp;        updateJoinButton();</b>
<b class="nc">&nbsp;        updateRecoveryButton();</b>
<b class="nc">&nbsp;        updateSpeedButtons();</b>
<b class="nc">&nbsp;        updateThrustButton();</b>
<b class="nc">&nbsp;        updateRollButton();</b>
<b class="nc">&nbsp;        checkFuel();</b>
<b class="nc">&nbsp;        checkOOC();</b>
<b class="nc">&nbsp;        checkAtmosphere();</b>
&nbsp;
&nbsp;        // if dropping unit only allow turning
<b class="nc">&nbsp;        if (!ce.isAero() &amp;&amp; cmd.getFinalAltitude() &gt; 0) {</b>
<b class="nc">&nbsp;            disableButtons();</b>
<b class="nc">&nbsp;            if (ce instanceof LandAirMech) {</b>
<b class="nc">&nbsp;                updateConvertModeButton();</b>
<b class="nc">&nbsp;                if (ce.getMovementMode() == EntityMovementMode.WIGE</b>
<b class="nc">&nbsp;                        &amp;&amp; ce.getAltitude() &lt;= 3) {</b>
<b class="nc">&nbsp;                    updateHoverButton();</b>
&nbsp;                }
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_MORE).setEnabled(numButtonGroups &gt; 1);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                gear = MovementDisplay.GEAR_TURN;</b>
&nbsp;            }
<b class="nc">&nbsp;            butDone.setEnabled(true);</b>
&nbsp;        }
&nbsp;
&nbsp;        // if small craft/dropship that has unloaded units, then only allowed
&nbsp;        // to unload more
<b class="nc">&nbsp;        if (ce.hasUnloadedUnitsFromBays()) {</b>
<b class="nc">&nbsp;            disableButtons();</b>
<b class="nc">&nbsp;            updateLoadButtons();</b>
<b class="nc">&nbsp;            butDone.setEnabled(true);</b>
&nbsp;        }
&nbsp;        
&nbsp;    }
&nbsp;
&nbsp;    private void removeLastStep() {
<b class="nc">&nbsp;        cmd.removeLastStep();</b>
<b class="nc">&nbsp;        final Entity entity = ce();</b>
<b class="nc">&nbsp;        if (entity == null) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().warning(&quot;Cannot process removeLastStep for a null entity.&quot;);</b>
&nbsp;            return;
<b class="nc">&nbsp;        } else if (cmd.length() == 0) {</b>
<b class="nc">&nbsp;            clear();</b>
<b class="nc">&nbsp;            if ((gear == MovementDisplay.GEAR_JUMP) &amp;&amp; !cmd.isJumping()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.START_JUMP);</b>
<b class="nc">&nbsp;            } else if (entity.isConvertingNow()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.CONVERT_MODE);</b>
&nbsp;            }
&nbsp;        } else {
&nbsp;            // clear board cursors
<b class="nc">&nbsp;            clientgui.getBoardView().select(cmd.getFinalCoords());</b>
<b class="nc">&nbsp;            clientgui.getBoardView().cursor(cmd.getFinalCoords());</b>
<b class="nc">&nbsp;            clientgui.getBoardView().drawMovementData(entity, cmd);</b>
<b class="nc">&nbsp;            clientgui.bv.setWeaponFieldofFire(entity, cmd);</b>
&nbsp;
&nbsp;            // Set the button&#39;s label to &quot;Done&quot;
&nbsp;            // if the entire move is impossible.
<b class="nc">&nbsp;            MovePath possible = cmd.clone();</b>
<b class="nc">&nbsp;            possible.clipToPossible();</b>
<b class="nc">&nbsp;            if (possible.length() == 0) {</b>
<b class="nc">&nbsp;                butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Done&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        updateButtons();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sends a data packet indicating the chosen movement.
&nbsp;     */
&nbsp;    @Override
&nbsp;    public synchronized void ready() {
<b class="nc">&nbsp;        if (ce() == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        cmd.clipToPossible();</b>
<b class="nc">&nbsp;        if ((cmd.length() == 0) &amp;&amp; !ce().isAirborne()</b>
<b class="nc">&nbsp;            &amp;&amp; GUIPreferences.getInstance().getNagForNoAction()) {</b>
&nbsp;            // Hmm....no movement steps, comfirm this action
<b class="nc">&nbsp;            String title = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.ConfirmNoMoveDlg.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String body = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.ConfirmNoMoveDlg.message&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            ConfirmDialog response = clientgui.doYesNoBotherDialog(title, body);</b>
<b class="nc">&nbsp;            if (!response.getShowAgain()) {</b>
<b class="nc">&nbsp;                GUIPreferences.getInstance().setNagForNoAction(false);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!response.getAnswer()) {</b>
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (cmd.hasActiveMASC() &amp;&amp; GUIPreferences.getInstance().getNagForMASC()) {</b>
&nbsp;            // pop up are you sure dialog
<b class="nc">&nbsp;            if (!((ce() instanceof VTOL) &amp;&amp; ce().hasWorkingMisc(</b>
&nbsp;                    MiscType.F_JET_BOOSTER))) {
<b class="nc">&nbsp;                ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        Messages.getString(</b>
&nbsp;                                &quot;MovementDisplay.ConfirmMoveRoll&quot;,
<b class="nc">&nbsp;                                new Object[] { Integer.valueOf(ce().getMASCTarget()) }), //$NON-NLS-1$</b>
&nbsp;                        true);
<b class="nc">&nbsp;                nag.setVisible(true);</b>
<b class="nc">&nbsp;                if (nag.getAnswer()) {</b>
&nbsp;                    // do they want to be bothered again?
<b class="nc">&nbsp;                    if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                        GUIPreferences.getInstance().setNagForMASC(false);</b>
&nbsp;                    }
&nbsp;                } else {
&nbsp;                    return;
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if ((cmd.getLastStepMovementType() == EntityMovementType.MOVE_SPRINT</b>
<b class="nc">&nbsp;                || cmd.getLastStepMovementType() == EntityMovementType.MOVE_VTOL_SPRINT)</b>
<b class="nc">&nbsp;                &amp;&amp; GUIPreferences.getInstance().getNagForSprint()</b>
&nbsp;                // no need to nag for vehicles using overdrive if they already get a PSR nag
<b class="nc">&nbsp;                &amp;&amp; !((cmd.getEntity() instanceof Tank</b>
<b class="nc">&nbsp;                        || (cmd.getEntity() instanceof QuadVee</b>
<b class="nc">&nbsp;                                &amp;&amp; cmd.getEntity().getConversionMode() == QuadVee.CONV_MODE_VEHICLE)</b>
<b class="nc">&nbsp;                        &amp;&amp; GUIPreferences.getInstance().getNagForPSR()))) {</b>
<b class="nc">&nbsp;            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.ConfirmSprint&quot;), true);</b>
<b class="nc">&nbsp;            nag.setVisible(true);</b>
<b class="nc">&nbsp;            if (nag.getAnswer()) {</b>
&nbsp;                // do they want to be bothered again?
<b class="nc">&nbsp;                if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance().setNagForSprint(false);</b>
&nbsp;                }
&nbsp;            } else {
&nbsp;                return;
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        String check = SharedUtility.doPSRCheck(cmd);</b>
<b class="nc">&nbsp;        if ((check.length() &gt; 0) &amp;&amp; GUIPreferences.getInstance().getNagForPSR()) {</b>
<b class="nc">&nbsp;            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.ConfirmPilotingRoll&quot;) +</b>
&nbsp;                    //$NON-NLS-1$
&nbsp;                            check, true);
<b class="nc">&nbsp;            nag.setVisible(true);</b>
<b class="nc">&nbsp;            if (nag.getAnswer()) {</b>
&nbsp;                // do they want to be bothered again?
<b class="nc">&nbsp;                if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance().setNagForPSR(false);</b>
&nbsp;                }
&nbsp;            } else {
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Should we nag about taking fall damage with mechanical jump boosters?
<b class="nc">&nbsp;        if (cmd.shouldMechanicalJumpCauseFallDamage()</b>
<b class="nc">&nbsp;                &amp;&amp; GUIPreferences.getInstance()</b>
<b class="nc">&nbsp;                        .getNagForMechanicalJumpFallDamage()) {</b>
<b class="nc">&nbsp;            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(</b>
&nbsp;                            &quot;MovementDisplay.ConfirmMechanicalJumpFallDamage&quot;,
&nbsp;                            new Object[] {
<b class="nc">&nbsp;                                    cmd.getJumpMaxElevationChange(),</b>
<b class="nc">&nbsp;                                    ce().getJumpMP(),</b>
<b class="nc">&nbsp;                                    cmd.getJumpMaxElevationChange()</b>
<b class="nc">&nbsp;                                            - ce().getJumpMP() }), true);</b>
<b class="nc">&nbsp;            nag.setVisible(true);</b>
<b class="nc">&nbsp;            if (nag.getAnswer()) {</b>
&nbsp;                // do they want to be bothered again?
<b class="nc">&nbsp;                if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance()</b>
<b class="nc">&nbsp;                            .setNagForMechanicalJumpFallDamage(false);</b>
&nbsp;                }
&nbsp;            } else {
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // check for G-forces
<b class="nc">&nbsp;        check = SharedUtility.doThrustCheck(cmd, clientgui.getClient());</b>
<b class="nc">&nbsp;        if ((check.length() &gt; 0) &amp;&amp; GUIPreferences.getInstance().getNagForPSR()) {</b>
<b class="nc">&nbsp;            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.ConfirmPilotingRoll&quot;) +</b>
&nbsp;                    //$NON-NLS-1$
&nbsp;                            check, true);
<b class="nc">&nbsp;            nag.setVisible(true);</b>
<b class="nc">&nbsp;            if (nag.getAnswer()) {</b>
&nbsp;                // do they want to be bothered again?
<b class="nc">&nbsp;                if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance().setNagForPSR(false);</b>
&nbsp;                }
&nbsp;            } else {
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // check for unsafe takeoffs
<b class="nc">&nbsp;        if (cmd.contains(MoveStepType.VTAKEOFF)</b>
<b class="nc">&nbsp;                || cmd.contains(MoveStepType.TAKEOFF)) {</b>
<b class="nc">&nbsp;            boolean unsecure = false;</b>
<b class="nc">&nbsp;            for (Entity loaded : ce().getLoadedUnits()) {</b>
<b class="nc">&nbsp;                if (loaded.wasLoadedThisTurn() &amp;&amp; !(loaded instanceof Infantry)) {</b>
<b class="nc">&nbsp;                    unsecure = true;</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (unsecure) {</b>
<b class="nc">&nbsp;                ConfirmDialog nag = new ConfirmDialog(</b>
&nbsp;                        clientgui.frame,
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.UnsecuredTakeoff&quot;),</b>
&nbsp;                        true);
<b class="nc">&nbsp;                nag.setVisible(true);</b>
<b class="nc">&nbsp;                if (nag.getAnswer()) {</b>
&nbsp;                    // do they want to be bothered again?
<b class="nc">&nbsp;                    if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                        GUIPreferences.getInstance().setNagForPSR(false);</b>
&nbsp;                    }
&nbsp;                } else {
&nbsp;                    return;
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // check to see if spheroids will drop elevation
&nbsp;        // they will do so if they&#39;re not hovering, landing, or changing altitude voluntarily.
<b class="nc">&nbsp;        if (Compute.useSpheroidAtmosphere(clientgui.getClient().getGame(), ce()) </b>
<b class="nc">&nbsp;                &amp;&amp; !cmd.contains(MoveStepType.HOVER) </b>
<b class="nc">&nbsp;                &amp;&amp; !cmd.contains(MoveStepType.VLAND)</b>
<b class="nc">&nbsp;                &amp;&amp; !cmd.contains(MoveStepType.UP)</b>
<b class="nc">&nbsp;                &amp;&amp; !cmd.contains(MoveStepType.DOWN)) {</b>
<b class="nc">&nbsp;            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.SpheroidAltitudeLoss&quot;) +</b>
&nbsp;                    //$NON-NLS-1$
&nbsp;                            check, true);
<b class="nc">&nbsp;            nag.setVisible(true);</b>
<b class="nc">&nbsp;            if (nag.getAnswer()) {</b>
&nbsp;                // do they want to be bothered again?
<b class="nc">&nbsp;                if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance().setNagForPSR(false);</b>
&nbsp;                }
&nbsp;            } else {
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (ce().isAirborne() || ce().isSpaceborne()) {</b>
<b class="nc">&nbsp;            if (!clientgui.getClient().getGame().useVectorMove()) {</b>
<b class="nc">&nbsp;                if (ce().isAero() &amp;&amp; !((IAero)ce()).isOutControlTotal()) {</b>
&nbsp;                    // check for underuse of velocity
<b class="nc">&nbsp;                    boolean unusedVelocity = false;</b>
<b class="nc">&nbsp;                    if (null != cmd.getLastStep()) {</b>
<b class="nc">&nbsp;                        unusedVelocity = cmd.getLastStep().getVelocityLeft() &gt; 0;</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        unusedVelocity = (((IAero) ce()).getCurrentVelocity() &gt; 0) &amp;&amp;</b>
<b class="nc">&nbsp;                                (ce().delta_distance == 0);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    boolean flyoff = false;</b>
<b class="nc">&nbsp;                    if ((null != cmd)</b>
<b class="nc">&nbsp;                            &amp;&amp; (cmd.contains(MoveStepType.OFF) || cmd</b>
<b class="nc">&nbsp;                                    .contains(MoveStepType.RETURN))) {</b>
<b class="nc">&nbsp;                        flyoff = true;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    boolean landing = false;</b>
<b class="nc">&nbsp;                    if ((null != cmd) &amp;&amp; cmd.contains(MoveStepType.LAND)) {</b>
<b class="nc">&nbsp;                        landing = true;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    boolean ejecting = false;</b>
<b class="nc">&nbsp;                    if ((null != cmd) &amp;&amp; cmd.contains(MoveStepType.EJECT)) {</b>
<b class="nc">&nbsp;                        ejecting = true;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (unusedVelocity &amp;&amp; !flyoff &amp;&amp; !landing &amp;&amp; !ejecting) {</b>
<b class="nc">&nbsp;                        String title = Messages</b>
<b class="nc">&nbsp;                                .getString(&quot;MovementDisplay.VelocityLeft.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        String body = Messages</b>
<b class="nc">&nbsp;                                .getString(&quot;MovementDisplay.VelocityLeft.message&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        clientgui.doAlertDialog(title, body);</b>
&nbsp;                        return;
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;            // depending on the rules and location (i.e. space v. atmosphere),
&nbsp;            // Aeros might need to have additional move steps tacked on
&nbsp;            // This must be done after all prompts, otherwise a user who cancels
&nbsp;            // will still have steps added to the movepath.
<b class="nc">&nbsp;            cmd = SharedUtility.moveAero(cmd, clientgui.getClient());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (cmd.willCrushBuildings()</b>
<b class="nc">&nbsp;            &amp;&amp; GUIPreferences.getInstance().getNagForCrushingBuildings()) {</b>
<b class="nc">&nbsp;            ConfirmDialog nag = new ConfirmDialog(</b>
&nbsp;                    clientgui.frame,
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.ConfirmCrushingBuildings&quot;),</b>
&nbsp;                    true);
<b class="nc">&nbsp;            nag.setVisible(true);</b>
<b class="nc">&nbsp;            if (nag.getAnswer()) {</b>
&nbsp;                // do they want to be bothered again?
<b class="nc">&nbsp;                if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance().setNagForCrushingBuildings(</b>
&nbsp;                            false);
&nbsp;                }
&nbsp;            } else {
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // check to see if spheroids will drop an elevation
<b class="nc">&nbsp;        if (ce() instanceof LandAirMech &amp;&amp; ce().isAssaultDropInProgress()</b>
<b class="nc">&nbsp;                &amp;&amp; cmd.getFinalConversionMode() == EntityMovementMode.AERODYNE) {</b>
<b class="nc">&nbsp;            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.insufficientAltitudeForConversion&quot;) +</b>
&nbsp;                    //$NON-NLS-1$
&nbsp;                            check, false);
<b class="nc">&nbsp;            nag.setVisible(true);</b>
<b class="nc">&nbsp;            if (!nag.getAnswer()) {</b>
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if ((ce() instanceof Infantry) &amp;&amp; ((Infantry) ce()).hasMicrolite()</b>
<b class="nc">&nbsp;                &amp;&amp; (ce().isAirborneVTOLorWIGE() || (ce().getElevation() != cmd.getFinalElevation()))</b>
<b class="nc">&nbsp;                &amp;&amp; !cmd.contains(MoveStepType.FORWARDS)</b>
<b class="nc">&nbsp;                &amp;&amp; cmd.getFinalElevation() &gt; 0</b>
<b class="nc">&nbsp;                &amp;&amp; ce().getGame().getBoard().getHex(cmd.getFinalCoords())</b>
<b class="nc">&nbsp;                    .terrainLevel(Terrains.BLDG_ELEV) &lt; cmd.getFinalElevation()</b>
<b class="nc">&nbsp;                &amp;&amp; ce().getGame().getBoard().getHex(cmd.getFinalCoords())</b>
<b class="nc">&nbsp;                    .terrainLevel(Terrains.BRIDGE_ELEV) &lt; cmd.getFinalElevation()) {</b>
<b class="nc">&nbsp;            String title = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.MicroliteMove.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String body = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.MicroliteMove.message&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            clientgui.doAlertDialog(title, body);</b>
&nbsp;            return;            	
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (cmd.automaticWiGELanding(true)</b>
<b class="nc">&nbsp;                &amp;&amp; GUIPreferences.getInstance().getNagForWiGELanding()  ) {</b>
<b class="nc">&nbsp;            ConfirmDialog nag = new ConfirmDialog(</b>
&nbsp;                    clientgui.frame,
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.ConfirmWiGELanding&quot;),</b>
&nbsp;                    true);
<b class="nc">&nbsp;            nag.setVisible(true);</b>
<b class="nc">&nbsp;            if (nag.getAnswer()) {</b>
&nbsp;                // do they want to be bothered again?
<b class="nc">&nbsp;                if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance().setNagForWiGELanding(false);</b>
&nbsp;                }
&nbsp;            } else {
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        disableButtons();</b>
<b class="nc">&nbsp;        clientgui.bv.clearMovementData();</b>
<b class="nc">&nbsp;        clientgui.bv.clearMovementEnvelope();</b>
<b class="nc">&nbsp;        if (ce().hasUMU()) {</b>
<b class="nc">&nbsp;            clientgui.getClient().sendUpdateEntity(ce());</b>
&nbsp;        }
<b class="nc">&nbsp;        clientgui.getClient().moveEntity(cen, cmd);</b>
<b class="nc">&nbsp;        if (ce().isWeapOrderChanged()) {</b>
<b class="nc">&nbsp;            clientgui.getClient().sendEntityWeaponOrderUpdate(ce());</b>
&nbsp;        }
<b class="nc">&nbsp;        endMyTurn();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns the current entity.
&nbsp;     */
&nbsp;    private synchronized Entity ce() {
<b class="nc">&nbsp;        if (clientgui != null) {</b>
<b class="nc">&nbsp;            return clientgui.getClient().getGame().getEntity(cen);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Returns new MovePath for the currently selected movement type
&nbsp;     */
&nbsp;    private void currentMove(Coords dest) {
<b class="nc">&nbsp;        if (shiftheld || (gear == GEAR_TURN)) {</b>
<b class="nc">&nbsp;            cmd.rotatePathfinder(cmd.getFinalCoords().direction(dest), false);</b>
<b class="nc">&nbsp;        } else if ((gear == GEAR_JUMP)</b>
<b class="nc">&nbsp;                   &amp;&amp; (ce().getJumpType() == Mech.JUMP_BOOSTER)) {</b>
&nbsp;            // Jumps with mechanical jump boosters are special
&nbsp;            Coords src;
<b class="nc">&nbsp;            if (cmd.getLastStep() != null) {</b>
<b class="nc">&nbsp;                src = cmd.getLastStep().getPosition();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                src = ce().getPosition();</b>
&nbsp;            }
<b class="nc">&nbsp;            int dir = src.direction(dest);</b>
<b class="nc">&nbsp;            int facing = ce().getFacing();</b>
&nbsp;            // Adjust dir based upon facing
&nbsp;            // Java does mod different from how we want...
<b class="nc">&nbsp;            dir = (((dir - facing) % 6) + 6) % 6;</b>
<b class="nc">&nbsp;            switch (dir) {</b>
&nbsp;                case 0:
<b class="nc">&nbsp;                    cmd.findSimplePathTo(dest, MoveStepType.FORWARDS,</b>
<b class="nc">&nbsp;                            src.direction(dest), ce().getFacing());</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 1:
<b class="nc">&nbsp;                    cmd.findSimplePathTo(dest, MoveStepType.LATERAL_RIGHT,</b>
<b class="nc">&nbsp;                            src.direction(dest), ce().getFacing());</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 2:
&nbsp;                    // TODO: backwards lateral shifts are switched:
&nbsp;                    // LATERAL_LEFT_BACKWARDS moves back+right and vice-versa
<b class="nc">&nbsp;                    cmd.findSimplePathTo(dest,</b>
&nbsp;                            MoveStepType.LATERAL_LEFT_BACKWARDS,
<b class="nc">&nbsp;                            src.direction(dest), ce().getFacing());</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 3:
<b class="nc">&nbsp;                    cmd.findSimplePathTo(dest, MoveStepType.BACKWARDS,</b>
<b class="nc">&nbsp;                            src.direction(dest), ce().getFacing());</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 4:
&nbsp;                    // TODO: backwards lateral shifts are switched:
&nbsp;                    // LATERAL_LEFT_BACKWARDS moves back+right and vice-versa
<b class="nc">&nbsp;                    cmd.findSimplePathTo(dest,</b>
&nbsp;                            MoveStepType.LATERAL_RIGHT_BACKWARDS,
<b class="nc">&nbsp;                            src.direction(dest), ce().getFacing());</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case 5:
<b class="nc">&nbsp;                    cmd.findSimplePathTo(dest, MoveStepType.LATERAL_LEFT,</b>
<b class="nc">&nbsp;                            src.direction(dest), ce().getFacing());</b>
&nbsp;                    break;
&nbsp;            }
<b class="nc">&nbsp;        } else if (gear == GEAR_STRAFE) {</b>
&nbsp;            // Only set the steps that enter new hexes.
<b class="nc">&nbsp;            int start = cmd.length();</b>
<b class="nc">&nbsp;            cmd.findPathTo(dest, MoveStepType.FORWARDS);</b>
&nbsp;            // Skip turns at the beginning of the new part of the path unless we&#39;re extending
&nbsp;            // an existing strafing pattern.
<b class="nc">&nbsp;            if (start &gt; 0 &amp;&amp; !cmd.getStep(start - 1).isStrafingStep()) {</b>
<b class="nc">&nbsp;                while (start &lt; cmd.length()</b>
<b class="nc">&nbsp;                        &amp;&amp; cmd.getStep(start).getType() != MoveStepType.FORWARDS) {</b>
<b class="nc">&nbsp;                    start++;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            for (int i = cmd.length() - 1; i &gt;= start; i--) {</b>
<b class="nc">&nbsp;                cmd.setStrafingStep(cmd.getStep(i).getPosition());</b>
&nbsp;            }
<b class="nc">&nbsp;            cmd.compile(clientgui.getClient().getGame(), ce(), false);</b>
<b class="nc">&nbsp;            gear = GEAR_LAND;</b>
<b class="nc">&nbsp;        } else if ((gear == GEAR_LAND) || (gear == GEAR_JUMP)) {</b>
<b class="nc">&nbsp;            cmd.findPathTo(dest, MoveStepType.FORWARDS);</b>
<b class="nc">&nbsp;        } else if (gear == GEAR_BACKUP) {</b>
<b class="nc">&nbsp;            cmd.findPathTo(dest, MoveStepType.BACKWARDS);</b>
<b class="nc">&nbsp;        } else if (gear == GEAR_CHARGE) {</b>
<b class="nc">&nbsp;            cmd.findPathTo(dest, MoveStepType.CHARGE);</b>
&nbsp;            // The path planner shouldn&#39;t actually add the charge step
<b class="nc">&nbsp;            if (cmd.getFinalCoords().equals(dest)</b>
<b class="nc">&nbsp;                &amp;&amp; (cmd.getLastStep().getType() != MoveStepType.CHARGE)) {</b>
<b class="nc">&nbsp;                cmd.removeLastStep();</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.CHARGE);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (gear == GEAR_DFA) {</b>
<b class="nc">&nbsp;            cmd.findPathTo(dest, MoveStepType.DFA);</b>
&nbsp;            // The path planner shouldn&#39;t actually add the DFA step
<b class="nc">&nbsp;            if (cmd.getFinalCoords().equals(dest)</b>
<b class="nc">&nbsp;                &amp;&amp; (cmd.getLastStep().getType() != MoveStepType.DFA)) {</b>
<b class="nc">&nbsp;                cmd.removeLastStep();</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.DFA);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (gear == GEAR_SWIM) {</b>
<b class="nc">&nbsp;            cmd.findPathTo(dest, MoveStepType.SWIM);</b>
<b class="nc">&nbsp;        } else if (gear == GEAR_RAM) {</b>
<b class="nc">&nbsp;            cmd.findPathTo(dest, MoveStepType.FORWARDS);</b>
<b class="nc">&nbsp;        } else if (gear == GEAR_IMMEL) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.UP, true, true);</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.UP, true, true);</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.DEC, true, true);</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.DEC, true, true);</b>
<b class="nc">&nbsp;            cmd.rotatePathfinder(cmd.getFinalCoords().direction(dest), true);</b>
<b class="nc">&nbsp;            gear = GEAR_LAND;</b>
<b class="nc">&nbsp;        } else if (gear == GEAR_SPLIT_S) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.DOWN, true, true);</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.DOWN, true, true);</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.ACC, true, true);</b>
<b class="nc">&nbsp;            cmd.rotatePathfinder(cmd.getFinalCoords().direction(dest), true);</b>
<b class="nc">&nbsp;            gear = GEAR_LAND;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (gear == GEAR_LONGEST_WALK || gear == GEAR_LONGEST_RUN) {</b>
&nbsp;            int maxMp;
&nbsp;            MoveStepType stepType;
<b class="nc">&nbsp;            if (gear == GEAR_LONGEST_WALK) {</b>
<b class="nc">&nbsp;                maxMp = ce().getWalkMP();</b>
<b class="nc">&nbsp;                stepType = MoveStepType.BACKWARDS;</b>
<b class="nc">&nbsp;                gear = GEAR_BACKUP;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                maxMp = ce().getRunMPwithoutMASC();</b>
<b class="nc">&nbsp;                stepType = MoveStepType.FORWARDS;</b>
<b class="nc">&nbsp;                gear = GEAR_LAND;</b>
&nbsp;            }
&nbsp;
&nbsp;            LongestPathFinder lpf;
<b class="nc">&nbsp;            if (ce().isAero()) {</b>
<b class="nc">&nbsp;                lpf = LongestPathFinder.newInstanceOfAeroPath(maxMp, ce()</b>
<b class="nc">&nbsp;                        .getGame());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                lpf = LongestPathFinder.newInstanceOfLongestPath(maxMp,</b>
<b class="nc">&nbsp;                                                                 stepType, ce().getGame());</b>
&nbsp;            }
<b class="nc">&nbsp;            final int timeLimit = PreferenceManager.getClientPreferences()</b>
<b class="nc">&nbsp;                                                   .getMaxPathfinderTime();</b>
<b class="nc">&nbsp;            lpf.addStopCondition(new AbstractPathFinder.StopConditionTimeout&lt;MovePath&gt;(</b>
&nbsp;                    timeLimit * 4));
&nbsp;
<b class="nc">&nbsp;            lpf.run(cmd);</b>
<b class="nc">&nbsp;            MovePath lPath = lpf.getComputedPath(dest);</b>
<b class="nc">&nbsp;            if (lPath != null) {</b>
<b class="nc">&nbsp;                cmd = lPath;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        clientgui.bv.setWeaponFieldofFire(ce(), cmd);</b>
&nbsp;    }
&nbsp;
&nbsp;    //
&nbsp;    // BoardListener
&nbsp;    //
&nbsp;    @Override
&nbsp;    public synchronized void hexMoused(BoardViewEvent b) {
<b class="nc">&nbsp;        if (clientgui == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // don&#39;t make a movement path for aeros if advanced movement is on
<b class="nc">&nbsp;        boolean nopath = (ce != null &amp;&amp; ce.isAero())</b>
<b class="nc">&nbsp;                         &amp;&amp; clientgui.getClient().getGame().useVectorMove();</b>
&nbsp;
&nbsp;        // ignore buttons other than 1
<b class="nc">&nbsp;        if (!clientgui.getClient().isMyTurn()</b>
<b class="nc">&nbsp;            || ((b.getModifiers() &amp; InputEvent.BUTTON1_MASK) == 0)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        // control pressed means a line of sight check.
&nbsp;        // added ALT_MASK by kenn
<b class="nc">&nbsp;        if (((b.getModifiers() &amp; InputEvent.CTRL_MASK) != 0)</b>
<b class="nc">&nbsp;            || ((b.getModifiers() &amp; InputEvent.ALT_MASK) != 0)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        // check for shifty goodness
<b class="nc">&nbsp;        if (shiftheld != ((b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0)) {</b>
<b class="nc">&nbsp;            shiftheld = (b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0;</b>
&nbsp;        }
<b class="nc">&nbsp;        Coords currPosition = cmd != null ? cmd.getFinalCoords()</b>
<b class="nc">&nbsp;                                          : ce != null ? ce.getPosition() : null;</b>
&nbsp;
<b class="nc">&nbsp;        if ((b.getType() == BoardViewEvent.BOARD_HEX_DRAGGED) &amp;&amp; !nopath) {</b>
<b class="nc">&nbsp;            if (!b.getCoords().equals(currPosition) || shiftheld</b>
&nbsp;                || (gear == MovementDisplay.GEAR_TURN)) {
<b class="nc">&nbsp;                clientgui.getBoardView().cursor(b.getCoords());</b>
&nbsp;                // either turn or move
<b class="nc">&nbsp;                if (ce != null) {</b>
<b class="nc">&nbsp;                    currentMove(b.getCoords());</b>
<b class="nc">&nbsp;                    clientgui.bv.drawMovementData(ce(), cmd);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else if (b.getType() == BoardViewEvent.BOARD_HEX_CLICKED) {</b>
<b class="nc">&nbsp;            Coords moveto = b.getCoords();</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;            if (shiftheld || (gear == MovementDisplay.GEAR_TURN)) {</b>
<b class="nc">&nbsp;                butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot;</b>
<b class="nc">&nbsp;                        + Messages.getString(&quot;MovementDisplay.Move&quot;)</b>
&nbsp;                        + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$
&nbsp;
&nbsp;                // Set the button&#39;s label to &quot;Done&quot;
&nbsp;                // if the entire move is impossible.
<b class="nc">&nbsp;                MovePath possible = cmd.clone();</b>
<b class="nc">&nbsp;                possible.clipToPossible();</b>
<b class="nc">&nbsp;                if (possible.length() == 0) {</b>
<b class="nc">&nbsp;                    butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot;</b>
<b class="nc">&nbsp;                            + Messages.getString(&quot;MovementDisplay.Done&quot;)</b>
&nbsp;                            + &quot;&lt;/b&gt;&lt;/html&gt;&quot;);
&nbsp;                    //$NON-NLS-1$
&nbsp;                }
&nbsp;                return;
&nbsp;            } else {
<b class="nc">&nbsp;                clientgui.getBoardView().select(b.getCoords());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (gear == MovementDisplay.GEAR_RAM) {</b>
&nbsp;                // check if target is valid
<b class="nc">&nbsp;                final Targetable target = chooseTarget(b.getCoords());</b>
<b class="nc">&nbsp;                if ((target == null) || target.equals(ce)</b>
<b class="nc">&nbsp;                        || !target.isAero()) {</b>
<b class="nc">&nbsp;                    clientgui.doAlertDialog(</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.CantRam&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.NoTarget&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    clear();</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;
&nbsp;                // check if it&#39;s a valid ram
&nbsp;                // First I need to add moves to the path if advanced
<b class="nc">&nbsp;                if (ce.isAero()</b>
<b class="nc">&nbsp;                        &amp;&amp; clientgui.getClient().getGame().useVectorMove()) {</b>
<b class="nc">&nbsp;                    cmd.clipToPossible();</b>
&nbsp;                    // cmd = addSteps(cmd, ce, clientgui.getClient());
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.RAM);</b>
&nbsp;
<b class="nc">&nbsp;                ToHitData toHit = new RamAttackAction(cen,</b>
<b class="nc">&nbsp;                        target.getTargetType(), target.getTargetId(),</b>
<b class="nc">&nbsp;                        target.getPosition()).toHit(clientgui.getClient()</b>
<b class="nc">&nbsp;                        .getGame(), cmd);</b>
<b class="nc">&nbsp;                if (toHit.getValue() != TargetRoll.IMPOSSIBLE) {</b>
&nbsp;
&nbsp;                    // Determine how much damage the charger will take.
<b class="nc">&nbsp;                    IAero ta = (IAero) target;</b>
<b class="nc">&nbsp;                    IAero ae = (IAero) ce;</b>
<b class="nc">&nbsp;                    int toAttacker = RamAttackAction.getDamageTakenBy(ae, (Entity)ta,</b>
<b class="nc">&nbsp;                            cmd.getSecondFinalPosition(ce.getPosition()),</b>
<b class="nc">&nbsp;                            cmd.getHexesMoved(), ta.getCurrentVelocity());</b>
<b class="nc">&nbsp;                    int toDefender = RamAttackAction.getDamageFor(ae, (Entity)ta,</b>
<b class="nc">&nbsp;                            cmd.getSecondFinalPosition(ce.getPosition()),</b>
<b class="nc">&nbsp;                            cmd.getHexesMoved(), ta.getCurrentVelocity());</b>
&nbsp;
&nbsp;                    // Ask the player if they want to charge.
<b class="nc">&nbsp;                    if (clientgui</b>
<b class="nc">&nbsp;                            .doYesNoDialog(</b>
<b class="nc">&nbsp;                                    Messages.getString(</b>
&nbsp;                                            &quot;MovementDisplay.RamDialog.title&quot;,
&nbsp;                                            new Object[] { target
<b class="nc">&nbsp;                                                    .getDisplayName() }), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                    Messages.getString(</b>
&nbsp;                                            &quot;MovementDisplay.RamDialog.message&quot;, new Object[] { //$NON-NLS-1$
<b class="nc">&nbsp;                                                    toHit.getValueAsString(),</b>
<b class="nc">&nbsp;                                                    Double.valueOf(</b>
<b class="nc">&nbsp;                                                            Compute.oddsAbove(</b>
<b class="nc">&nbsp;                                                                    toHit.getValue(),</b>
<b class="nc">&nbsp;                                                                    ce().hasAbility(OptionsConstants.PILOT_APTITUDE_PILOTING))),</b>
<b class="nc">&nbsp;                                                    toHit.getDesc(),</b>
<b class="nc">&nbsp;                                                    Integer.valueOf(toDefender),</b>
<b class="nc">&nbsp;                                                    toHit.getTableDesc(),</b>
<b class="nc">&nbsp;                                                    Integer.valueOf(toAttacker) }))) {</b>
&nbsp;                        // if they answer yes, charge the target.
<b class="nc">&nbsp;                        cmd.getLastStep().setTarget(target);</b>
<b class="nc">&nbsp;                        ready();</b>
&nbsp;                    } else {
&nbsp;                        // else clear movement
<b class="nc">&nbsp;                        clear();</b>
&nbsp;                    }
&nbsp;                    return;
&nbsp;                }
&nbsp;                // if not valid, tell why
<b class="nc">&nbsp;                clientgui.doAlertDialog(</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.CantRam&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        toHit.getDesc());</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;                return;
<b class="nc">&nbsp;            } else if (gear == MovementDisplay.GEAR_CHARGE) {</b>
&nbsp;                // check if target is valid
<b class="nc">&nbsp;                final Targetable target = chooseTarget(b.getCoords());</b>
<b class="nc">&nbsp;                if ((target == null) || target.equals(ce)) {</b>
<b class="nc">&nbsp;                    clientgui.doAlertDialog(</b>
<b class="nc">&nbsp;                            Messages.getString(ce.isAirborneVTOLorWIGE()?</b>
<b class="nc">&nbsp;                                    &quot;MovementDisplay.CantRam&quot;:&quot;MovementDisplay.CantCharge&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.NoTarget&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    clear();</b>
<b class="nc">&nbsp;                    computeMovementEnvelope(ce);</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;
&nbsp;                // check if it&#39;s a valid charge
<b class="nc">&nbsp;                ToHitData toHit = null;</b>
<b class="nc">&nbsp;                if (ce.isAirborneVTOLorWIGE()) {</b>
<b class="nc">&nbsp;                    toHit = new AirmechRamAttackAction(cen,</b>
<b class="nc">&nbsp;                            target.getTargetType(), target.getTargetId(),</b>
<b class="nc">&nbsp;                            target.getPosition()).toHit(clientgui.getClient()</b>
<b class="nc">&nbsp;                                    .getGame(), cmd);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    toHit = new ChargeAttackAction(cen,</b>
<b class="nc">&nbsp;                            target.getTargetType(), target.getTargetId(),</b>
<b class="nc">&nbsp;                            target.getPosition()).toHit(clientgui.getClient()</b>
<b class="nc">&nbsp;                                    .getGame(), cmd);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (toHit.getValue() != TargetRoll.IMPOSSIBLE) {</b>
&nbsp;                    // Determine how much damage the charger will take.
<b class="nc">&nbsp;                    int toDefender = 0;</b>
<b class="nc">&nbsp;                    int toAttacker = 0;</b>
<b class="nc">&nbsp;                    if (ce.isAirborneVTOLorWIGE()) {</b>
<b class="nc">&nbsp;                        toAttacker = AirmechRamAttackAction.getDamageTakenBy(ce, target, cmd.getHexesMoved());</b>
<b class="nc">&nbsp;                        toDefender = AirmechRamAttackAction.getDamageFor(ce, cmd.getHexesMoved());</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        toDefender = ChargeAttackAction.getDamageFor(</b>
<b class="nc">&nbsp;                                        ce, clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                                                .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE),</b>
<b class="nc">&nbsp;                                        cmd.getHexesMoved());</b>
<b class="nc">&nbsp;                        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</b>
<b class="nc">&nbsp;                            Entity te = (Entity) target;</b>
<b class="nc">&nbsp;                            toAttacker = ChargeAttackAction.getDamageTakenBy(ce,</b>
&nbsp;                                    te,
<b class="nc">&nbsp;                                    clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                                            .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                    cmd.getHexesMoved());</b>
<b class="nc">&nbsp;                        } else if ((target.getTargetType() == Targetable.TYPE_FUEL_TANK)</b>
<b class="nc">&nbsp;                                   || (target.getTargetType() == Targetable.TYPE_BUILDING)) {</b>
<b class="nc">&nbsp;                            Building bldg = clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                                                     .getBoard().getBuildingAt(moveto);</b>
<b class="nc">&nbsp;                            toAttacker = ChargeAttackAction.getDamageTakenBy(ce,</b>
&nbsp;                                                                             bldg, moveto);
&nbsp;                        }
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    String title = &quot;MovementDisplay.ChargeDialog.title&quot;;</b>
<b class="nc">&nbsp;                    String msg = &quot;MovementDisplay.ChargeDialog.message&quot;;</b>
<b class="nc">&nbsp;                    if (ce.isAirborneVTOLorWIGE()) {</b>
<b class="nc">&nbsp;                        title = &quot;MovementDisplay.AirmechRamDialog.title&quot;;</b>
<b class="nc">&nbsp;                        msg = &quot;MovementDisplay.AirmechRamDialog.message&quot;;</b>
&nbsp;                    }
&nbsp;                    // Ask the player if they want to charge.
<b class="nc">&nbsp;                    if (clientgui</b>
<b class="nc">&nbsp;                            .doYesNoDialog(Messages.getString(title, new Object[] { target.getDisplayName() }), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                    Messages.getString(msg,new Object[] {//$NON-NLS-1$</b>
<b class="nc">&nbsp;                                            toHit.getValueAsString(),</b>
<b class="nc">&nbsp;                                            Double.valueOf(</b>
<b class="nc">&nbsp;                                                    Compute.oddsAbove(toHit</b>
<b class="nc">&nbsp;                                                            .getValue())),</b>
<b class="nc">&nbsp;                                            toHit.getDesc(),</b>
<b class="nc">&nbsp;                                            toDefender,</b>
<b class="nc">&nbsp;                                            toHit.getTableDesc(),</b>
<b class="nc">&nbsp;                                            Integer.valueOf(toAttacker) }))) {</b>
&nbsp;                        // if they answer yes, charge the target.
<b class="nc">&nbsp;                        cmd.getLastStep().setTarget(target);</b>
<b class="nc">&nbsp;                        ready();</b>
&nbsp;                    } else {
&nbsp;                        // else clear movement
<b class="nc">&nbsp;                        clear();</b>
&nbsp;                    }
&nbsp;                    return;
&nbsp;                }
&nbsp;                // if not valid, tell why
<b class="nc">&nbsp;                clientgui.doAlertDialog(</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.CantCharge&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        toHit.getDesc());</b>
<b class="nc">&nbsp;                clear();</b>
<b class="nc">&nbsp;                computeMovementEnvelope(ce);</b>
&nbsp;                return;
<b class="nc">&nbsp;            } else if (gear == MovementDisplay.GEAR_DFA) {</b>
&nbsp;                // check if target is valid
<b class="nc">&nbsp;                final Targetable target = chooseTarget(b.getCoords());</b>
<b class="nc">&nbsp;                if ((target == null) || target.equals(ce)) {</b>
<b class="nc">&nbsp;                    clientgui.doAlertDialog(</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.CantDFA&quot;),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.NoTarget&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                    clear();</b>
<b class="nc">&nbsp;                    computeMovementEnvelope(ce);</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;
&nbsp;                // check if it&#39;s a valid DFA
<b class="nc">&nbsp;                ToHitData toHit = DfaAttackAction.toHit(clientgui.getClient()</b>
<b class="nc">&nbsp;                                                                 .getGame(), cen, target, cmd);</b>
<b class="nc">&nbsp;                if (toHit.getValue() != TargetRoll.IMPOSSIBLE) {</b>
&nbsp;                    // if yes, ask them if they want to DFA
<b class="nc">&nbsp;                    if (clientgui</b>
<b class="nc">&nbsp;                            .doYesNoDialog(</b>
<b class="nc">&nbsp;                                    Messages.getString(</b>
&nbsp;                                            &quot;MovementDisplay.DFADialog.title&quot;,
&nbsp;                                            new Object[] { target
<b class="nc">&nbsp;                                                    .getDisplayName() }), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                    Messages.getString(</b>
&nbsp;                                            &quot;MovementDisplay.DFADialog.message&quot;, new Object[] {//$NON-NLS-1$
<b class="nc">&nbsp;                                                    toHit.getValueAsString(),</b>
<b class="nc">&nbsp;                                                    Double.valueOf(</b>
<b class="nc">&nbsp;                                                            Compute.oddsAbove(toHit</b>
<b class="nc">&nbsp;                                                                    .getValue())),</b>
<b class="nc">&nbsp;                                                    toHit.getDesc(),</b>
<b class="nc">&nbsp;                                                    Integer.valueOf(</b>
&nbsp;                                                            DfaAttackAction
<b class="nc">&nbsp;                                                                    .getDamageFor(</b>
&nbsp;                                                                            ce,
&nbsp;                                                                            (target instanceof Infantry)
&nbsp;                                                                                    &amp;&amp; !(target instanceof BattleArmor))),
<b class="nc">&nbsp;                                                    toHit.getTableDesc(),</b>
<b class="nc">&nbsp;                                                    Integer.valueOf(</b>
&nbsp;                                                            DfaAttackAction
<b class="nc">&nbsp;                                                                    .getDamageTakenBy(ce)) }))) {</b>
&nbsp;                        // if they answer yes, DFA the target
<b class="nc">&nbsp;                        cmd.getLastStep().setTarget(target);</b>
<b class="nc">&nbsp;                        ready();</b>
&nbsp;                    } else {
&nbsp;                        // else clear movement
<b class="nc">&nbsp;                        clear();</b>
&nbsp;                    }
&nbsp;                    return;
&nbsp;                }
&nbsp;                // if not valid, tell why
<b class="nc">&nbsp;                clientgui.doAlertDialog(</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.CantDFA&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        toHit.getDesc());</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Move&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            updateProneButtons();</b>
<b class="nc">&nbsp;            updateRACButton();</b>
<b class="nc">&nbsp;            updateSearchlightButton();</b>
<b class="nc">&nbsp;            updateLoadButtons();</b>
<b class="nc">&nbsp;            updateElevationButtons();</b>
<b class="nc">&nbsp;            updateTakeOffButtons();</b>
<b class="nc">&nbsp;            updateLandButtons();</b>
<b class="nc">&nbsp;            updateEvadeButton();</b>
<b class="nc">&nbsp;            updateBootleggerButton();</b>
<b class="nc">&nbsp;            updateShutdownButton();</b>
<b class="nc">&nbsp;            updateStartupButton();</b>
<b class="nc">&nbsp;            updateSelfDestructButton();</b>
<b class="nc">&nbsp;            updateTraitorButton();</b>
<b class="nc">&nbsp;            updateFlyOffButton();</b>
<b class="nc">&nbsp;            updateLaunchButton();</b>
<b class="nc">&nbsp;            updateDropButton();</b>
<b class="nc">&nbsp;            updateConvertModeButton();</b>
<b class="nc">&nbsp;            updateRecklessButton();</b>
<b class="nc">&nbsp;            updateHoverButton();</b>
<b class="nc">&nbsp;            updateManeuverButton();</b>
<b class="nc">&nbsp;            updateSpeedButtons();</b>
<b class="nc">&nbsp;            updateThrustButton();</b>
<b class="nc">&nbsp;            updateRollButton();</b>
<b class="nc">&nbsp;            updateTurnButton();</b>
<b class="nc">&nbsp;            updateTakeCoverButton();</b>
<b class="nc">&nbsp;            updateLayMineButton();</b>
<b class="nc">&nbsp;            checkFuel();</b>
<b class="nc">&nbsp;            checkOOC();</b>
<b class="nc">&nbsp;            checkAtmosphere();</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private void updateTakeCoverButton() {
<b class="nc">&nbsp;        final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        final GameOptions gOpts = game.getOptions();</b>
<b class="nc">&nbsp;        boolean isInfantry = (ce() instanceof Infantry);</b>
&nbsp;        
&nbsp;        // Infantry - Taking Cover
<b class="nc">&nbsp;        if (isInfantry &amp;&amp; gOpts.booleanOption(OptionsConstants.ADVANCED_TACOPS_TAKE_COVER)) {</b>
&nbsp;            // Determine the current position of the infantry
&nbsp;            Coords pos;
&nbsp;            int elevation;
<b class="nc">&nbsp;            if (cmd == null) {</b>
<b class="nc">&nbsp;                pos = ce().getPosition();</b>
<b class="nc">&nbsp;                elevation = ce().getElevation();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                pos = cmd.getFinalCoords();</b>
<b class="nc">&nbsp;                elevation = cmd.getFinalElevation();</b>
&nbsp;            }
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_TAKE_COVER).setEnabled(</b>
<b class="nc">&nbsp;                    Infantry.hasValidCover(game, pos, elevation));</b>
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_TAKE_COVER).setEnabled(false);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private synchronized void updateProneButtons() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (ce != null) {</b>
<b class="nc">&nbsp;            boolean isMech = ce instanceof Mech;</b>
&nbsp;
<b class="nc">&nbsp;            if (cmd.getFinalProne()) {</b>
<b class="nc">&nbsp;                setGetUpEnabled(!ce.isImmobile() &amp;&amp; !ce.isStuck());</b>
<b class="nc">&nbsp;                setGoProneEnabled(false);</b>
<b class="nc">&nbsp;                setHullDownEnabled(true);</b>
<b class="nc">&nbsp;            } else if (cmd.getFinalHullDown()) {</b>
<b class="nc">&nbsp;                if (isMech) {</b>
<b class="nc">&nbsp;                    setGetUpEnabled(!ce.isImmobile() &amp;&amp; !ce.isStuck()</b>
<b class="nc">&nbsp;                                    &amp;&amp; !((Mech) ce).cannotStandUpFromHullDown());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    setGetUpEnabled(!ce.isImmobile() &amp;&amp; !ce.isStuck());</b>
&nbsp;                }
<b class="nc">&nbsp;                setGoProneEnabled(!ce.isImmobile() &amp;&amp; isMech &amp;&amp; !ce.isStuck());</b>
<b class="nc">&nbsp;                setHullDownEnabled(false);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                setGetUpEnabled(false);</b>
<b class="nc">&nbsp;                setGoProneEnabled(!ce.isImmobile() &amp;&amp; isMech &amp;&amp; !ce.isStuck()</b>
<b class="nc">&nbsp;                                  &amp;&amp; !(getBtn(MoveCommand.MOVE_GET_UP).isEnabled()));</b>
<b class="nc">&nbsp;                if (!(ce instanceof Tank) &amp;&amp; !(ce instanceof QuadVee</b>
<b class="nc">&nbsp;                        &amp;&amp; ce.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)) {</b>
<b class="nc">&nbsp;                    setHullDownEnabled(ce.canGoHullDown());</b>
&nbsp;                } else {
&nbsp;                    // So that vehicle can move and go hull-down, we have to
&nbsp;                    // check if it&#39;s moved into a fortified position
<b class="nc">&nbsp;                    if (cmd.getLastStep() != null) {</b>
<b class="nc">&nbsp;                        boolean hullDownEnabled = clientgui.getClient()</b>
<b class="nc">&nbsp;                                                           .getGame().getOptions()</b>
<b class="nc">&nbsp;                                                           .booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_HULL_DOWN);</b>
<b class="nc">&nbsp;                        IHex occupiedHex = clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                                                    .getBoard()</b>
<b class="nc">&nbsp;                                                    .getHex(cmd.getLastStep().getPosition());</b>
<b class="nc">&nbsp;                        boolean fortifiedHex = occupiedHex</b>
<b class="nc">&nbsp;                                .containsTerrain(Terrains.FORTIFIED);</b>
<b class="nc">&nbsp;                        setHullDownEnabled(hullDownEnabled &amp;&amp; fortifiedHex);</b>
<b class="nc">&nbsp;                    } else {</b>
&nbsp;                        // If there&#39;s queued up movement, we can call the
&nbsp;                        // canGoHullDown() method in the Tank class.
<b class="nc">&nbsp;                        setHullDownEnabled(ce.canGoHullDown());</b>
&nbsp;                    }
&nbsp;
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            setGetUpEnabled(false);</b>
<b class="nc">&nbsp;            setGoProneEnabled(false);</b>
<b class="nc">&nbsp;            setHullDownEnabled(false);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void updateRACButton() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        GameOptions opts = clientgui.getClient().getGame().getOptions();</b>
<b class="nc">&nbsp;        setUnjamEnabled(ce.canUnjamRAC()</b>
&nbsp;                &amp;&amp; ((gear == MovementDisplay.GEAR_LAND)
&nbsp;                        || (gear == MovementDisplay.GEAR_TURN) 
&nbsp;                        || (gear == MovementDisplay.GEAR_BACKUP))
<b class="nc">&nbsp;                &amp;&amp; ((cmd.getMpUsed() &lt;= ce.getWalkMP()) </b>
<b class="nc">&nbsp;                        || (cmd.getLastStep().isOnlyPavement() </b>
<b class="nc">&nbsp;                                &amp;&amp; (cmd.getMpUsed() &lt;= (ce.getWalkMP() + 1))))</b>
<b class="nc">&nbsp;                &amp;&amp; !(opts.booleanOption(&quot;tacops_tank_crews&quot;)</b>
<b class="nc">&nbsp;                        &amp;&amp; (cmd.getMpUsed() &gt; 0) &amp;&amp; (ce instanceof Tank) </b>
<b class="nc">&nbsp;                        &amp;&amp; (ce.getCrew().getSize() &lt; 2)));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void updateSearchlightButton() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        setSearchlightEnabled(</b>
<b class="nc">&nbsp;                ce.hasSpotlight() &amp;&amp; !cmd.contains(MoveStepType.SEARCHLIGHT),</b>
<b class="nc">&nbsp;                ce().isUsingSpotlight());</b>
&nbsp;    }
&nbsp;
&nbsp;    private synchronized void updateElevationButtons() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ce.isAirborne()) {</b>
&nbsp;            // then use altitude not elevation
<b class="nc">&nbsp;            setRaiseEnabled(ce.canGoUp(cmd.getFinalAltitude(),</b>
<b class="nc">&nbsp;                                       cmd.getFinalCoords()));</b>
<b class="nc">&nbsp;            setLowerEnabled(ce.canGoDown(cmd.getFinalAltitude(),</b>
<b class="nc">&nbsp;                                         cmd.getFinalCoords()));</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        // WiGEs (and LAMs and glider protomechs) cannot go up if they&#39;ve used ground movement.
<b class="nc">&nbsp;        if ((ce.getMovementMode() == EntityMovementMode.WIGE)</b>
<b class="nc">&nbsp;                &amp;&amp; !ce.isAirborneVTOLorWIGE()</b>
<b class="nc">&nbsp;                &amp;&amp; (cmd.getMpUsed() &gt; 0)</b>
<b class="nc">&nbsp;                &amp;&amp; !cmd.contains(MoveStepType.UP)) {</b>
<b class="nc">&nbsp;            setRaiseEnabled(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setRaiseEnabled(ce.canGoUp(cmd.getFinalElevation(),</b>
<b class="nc">&nbsp;                                       cmd.getFinalCoords()));</b>
&nbsp;        }
<b class="nc">&nbsp;        setLowerEnabled(ce.canGoDown(cmd.getFinalElevation(),</b>
<b class="nc">&nbsp;                                     cmd.getFinalCoords()));</b>
&nbsp;    }
&nbsp;
&nbsp;    private synchronized void updateTakeOffButtons() {
&nbsp;
<b class="nc">&nbsp;        if ((null != cmd) &amp;&amp; (cmd.length() &gt; 0)) {</b>
&nbsp;            // you can&#39;t take off if you have already moved
&nbsp;            // http://www.classicbattletech.com/forums/index.php?topic=54112.0
<b class="nc">&nbsp;            setTakeOffEnabled(false);</b>
<b class="nc">&nbsp;            setVTakeOffEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ce.isAero()) {</b>
<b class="nc">&nbsp;            if (ce.isAirborne()) {</b>
<b class="nc">&nbsp;                setTakeOffEnabled(false);</b>
<b class="nc">&nbsp;                setVTakeOffEnabled(false);</b>
<b class="nc">&nbsp;            } else if (!ce.isShutDown()) {</b>
<b class="nc">&nbsp;                setTakeOffEnabled(((IAero) ce).canTakeOffHorizontally());</b>
<b class="nc">&nbsp;                setVTakeOffEnabled(((IAero) ce).canTakeOffVertically());</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            setTakeOffEnabled(false);</b>
<b class="nc">&nbsp;            setVTakeOffEnabled(false);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private synchronized void updateLandButtons() {
&nbsp;
<b class="nc">&nbsp;        if ((null != cmd) &amp;&amp; (cmd.length() &gt; 0)) {</b>
&nbsp;            // According to the link below, you can move in the air and then
&nbsp;            // land
&nbsp;            // but I have personal message to Welshman right now asking that
&nbsp;            // this be changed
&nbsp;            // because it creates all kinds of rules problems, the number one
&nbsp;            // being
&nbsp;            // the ability to use spheroid dropships to perform insta-Death From
&nbsp;            // Above attacks
&nbsp;            // that cannot be defended against
&nbsp;            // So we are going to disallow it
&nbsp;            // http://www.classicbattletech.com/forums/index.php?topic=54112.0
<b class="nc">&nbsp;            setLandEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // only allow landing on the ground map not atmosphere or space map
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getBoard().onGround()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ce.isAero()) {</b>
<b class="nc">&nbsp;            if (ce.isAirborne() &amp;&amp; (cmd.getFinalAltitude() == 1)) {</b>
<b class="nc">&nbsp;                setLandEnabled(((IAero) ce).canLandHorizontally());</b>
<b class="nc">&nbsp;                setVLandEnabled(((IAero) ce).canLandVertically());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private void updateRollButton() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.isAero()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setRollEnabled(true);</b>
&nbsp;
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getBoard().inSpace()) {</b>
<b class="nc">&nbsp;            setRollEnabled(false);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (cmd.contains(MoveStepType.ROLL)) {</b>
<b class="nc">&nbsp;            setRollEnabled(false);</b>
&nbsp;        }
&nbsp;
&nbsp;        return;
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private void updateHoverButton() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (ce.isAero()) {</b>
<b class="nc">&nbsp;            if (!((IAero)ce).isVSTOL()) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            if (clientgui.getClient().getGame().getBoard().inSpace()) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;        } else if (!(ce instanceof Protomech) &amp;&amp; !(ce instanceof LandAirMech</b>
<b class="nc">&nbsp;                &amp;&amp; (((LandAirMech)ce).getConversionMode() == LandAirMech.CONV_MODE_AIRMECH))</b>
<b class="nc">&nbsp;                &amp;&amp; (ce.getAltitude() &lt;= 3)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!cmd.contains(MoveStepType.HOVER)) {</b>
<b class="nc">&nbsp;            setHoverEnabled(true);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setHoverEnabled(false);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void updateThrustButton() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.isAero()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // only allow thrust if there is thrust left to spend
<b class="nc">&nbsp;        int mpUsed = 0;</b>
<b class="nc">&nbsp;        MoveStep last = cmd.getLastStep();</b>
<b class="nc">&nbsp;        if (null != last) {</b>
<b class="nc">&nbsp;            mpUsed = last.getMpUsed();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (mpUsed &gt;= ce.getRunMP()) {</b>
<b class="nc">&nbsp;            setThrustEnabled(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setThrustEnabled(true);</b>
&nbsp;        }
&nbsp;
&nbsp;        return;
&nbsp;    }
&nbsp;
&nbsp;    private synchronized void updateSpeedButtons() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.isAero()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        IAero a = (IAero) ce;</b>
&nbsp;
&nbsp;        // only allow acceleration and deceleration if the cmd is empty or the
&nbsp;        // last step was
&nbsp;        // acc/dec
&nbsp;
<b class="nc">&nbsp;        setAccEnabled(false);</b>
<b class="nc">&nbsp;        setDecEnabled(false);</b>
<b class="nc">&nbsp;        MoveStep last = cmd.getLastStep();</b>
&nbsp;        // figure out implied velocity so you can&#39;t decelerate below zero
<b class="nc">&nbsp;        int vel = a.getCurrentVelocity();</b>
<b class="nc">&nbsp;        int veln = a.getNextVelocity();</b>
<b class="nc">&nbsp;        if (null != last) {</b>
<b class="nc">&nbsp;            vel = last.getVelocity();</b>
<b class="nc">&nbsp;            veln = last.getVelocityN();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (null == last) {</b>
<b class="nc">&nbsp;            setAccEnabled(true);</b>
<b class="nc">&nbsp;            if (vel &gt; 0) {</b>
<b class="nc">&nbsp;                setDecEnabled(true);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (last.getType() == MoveStepType.ACC) {</b>
<b class="nc">&nbsp;            setAccEnabled(true);</b>
<b class="nc">&nbsp;        } else if ((last.getType() == MoveStepType.DEC) &amp;&amp; (vel &gt; 0)) {</b>
<b class="nc">&nbsp;            setDecEnabled(true);</b>
&nbsp;        }
&nbsp;
&nbsp;        // if the aero has failed a maneuver this turn, then don&#39;t allow
<b class="nc">&nbsp;        if (a.didFailManeuver()) {</b>
<b class="nc">&nbsp;            setAccEnabled(false);</b>
<b class="nc">&nbsp;            setDecEnabled(false);</b>
&nbsp;        }
&nbsp;
&nbsp;        // if accelerated/decelerate at the end of last turn then disable
<b class="nc">&nbsp;        if (a.didAccLast()) {</b>
<b class="nc">&nbsp;            setAccEnabled(false);</b>
<b class="nc">&nbsp;            setDecEnabled(false);</b>
&nbsp;        }
&nbsp;
&nbsp;        // allow acc/dec next if acceleration/deceleration hasn&#39;t been used
<b class="nc">&nbsp;        setAccNEnabled(false);</b>
<b class="nc">&nbsp;        setDecNEnabled(false);</b>
<b class="nc">&nbsp;        if (!cmd.contains(MoveStepType.ACC) &amp;&amp; !cmd.contains(MoveStepType.DEC)</b>
<b class="nc">&nbsp;            &amp;&amp; !cmd.contains(MoveStepType.DECN)) {</b>
<b class="nc">&nbsp;            setAccNEnabled(true);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!cmd.contains(MoveStepType.ACC) &amp;&amp; !cmd.contains(MoveStepType.DEC)</b>
<b class="nc">&nbsp;            &amp;&amp; !cmd.contains(MoveStepType.ACCN) &amp;&amp; (veln &gt; 0)) {</b>
<b class="nc">&nbsp;            setDecNEnabled(true);</b>
&nbsp;        }
&nbsp;
&nbsp;        // acc/dec next needs to be disabled if acc/dec used before a failed
&nbsp;        // maneuver
<b class="nc">&nbsp;        if (a.didFailManeuver() &amp;&amp; a.didAccDecNow()) {</b>
<b class="nc">&nbsp;            setDecNEnabled(false);</b>
<b class="nc">&nbsp;            setAccNEnabled(false);</b>
&nbsp;        }
&nbsp;
&nbsp;        // if in atmosphere, limit acceleration to 2x safe thrust
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getBoard().inSpace()</b>
<b class="nc">&nbsp;            &amp;&amp; (vel == (2 * ce.getWalkMP()))) {</b>
<b class="nc">&nbsp;            setAccEnabled(false);</b>
&nbsp;        }
&nbsp;        // velocity next will get halved before next turn so allow up to 4 times
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getBoard().inSpace()</b>
<b class="nc">&nbsp;            &amp;&amp; (veln == (4 * ce.getWalkMP()))) {</b>
<b class="nc">&nbsp;            setAccNEnabled(false);</b>
&nbsp;        }
&nbsp;
&nbsp;        // if this is a tele-operated missile then it can&#39;t decelerate no matter
&nbsp;        // what
<b class="nc">&nbsp;        if (a instanceof TeleMissile) {</b>
<b class="nc">&nbsp;            setDecEnabled(false);</b>
<b class="nc">&nbsp;            setDecNEnabled(false);</b>
&nbsp;        }
&nbsp;
&nbsp;        return;
&nbsp;    }
&nbsp;
&nbsp;    private void updateDumpButton() {
&nbsp;        /*
&nbsp;         * if (ce() instanceof Aero) { Aero a = (Aero) ce();
&nbsp;         * setDumpEnabled(a.hasBombs() &amp;&amp; cmd.length() == 0); } else {
&nbsp;         * setDumpEnabled(false); }
&nbsp;         */
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private void updateFlyOffButton() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
&nbsp;        // Aeros should be able to fly off if they reach a border hex with
&nbsp;        // velocity remaining and facing the right direction
<b class="nc">&nbsp;        if ((ce == null) || !ce.isAero() || !ce.isAirborne()) {</b>
<b class="nc">&nbsp;            setFlyOffEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        IAero a = (IAero) ce;</b>
<b class="nc">&nbsp;        MoveStep step = cmd.getLastStep();</b>
<b class="nc">&nbsp;        Coords position = ce.getPosition();</b>
<b class="nc">&nbsp;        int facing = ce.getFacing();</b>
&nbsp;
<b class="nc">&nbsp;        int velocityLeft = a.getCurrentVelocity();</b>
<b class="nc">&nbsp;        if (step != null) {</b>
<b class="nc">&nbsp;            position = step.getPosition();</b>
<b class="nc">&nbsp;            facing = step.getFacing();</b>
<b class="nc">&nbsp;            velocityLeft = step.getVelocityLeft();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        final IBoard board = clientgui.getClient().getGame().getBoard();</b>
&nbsp;        // for spheroids in atmosphere we just need to check being on the edge
<b class="nc">&nbsp;        if (a.isSpheroid() &amp;&amp; !board.inSpace()) {</b>
<b class="nc">&nbsp;            setFlyOffEnabled((position != null) &amp;&amp; (ce.getWalkMP() &gt; 0)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((position.getX() == 0)</b>
<b class="nc">&nbsp;                            || (position.getX() == (board.getWidth() - 1))</b>
<b class="nc">&nbsp;                            || (position.getY() == 0)</b>
<b class="nc">&nbsp;                            || (position.getY() == (board.getHeight() - 1))));</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // for all aerodynes and spheroids in space it is more complicated - the
&nbsp;        // nose of the aircraft
&nbsp;        // must be facing in the righ direction and there must be velocity
&nbsp;        // remaining
&nbsp;
<b class="nc">&nbsp;        boolean evenx = (position.getX() % 2) == 0;</b>
<b class="nc">&nbsp;        if ((velocityLeft &gt; 0) &amp;&amp; (((position.getX() == 0) &amp;&amp; ((facing == 5) || (facing == 4)))</b>
<b class="nc">&nbsp;                || ((position.getX() == (board.getWidth() - 1))</b>
&nbsp;                        &amp;&amp; ((facing == 1) || (facing == 2)))
<b class="nc">&nbsp;                || ((position.getY() == 0) &amp;&amp; ((facing == 1) || (facing == 5) || (facing == 0)) &amp;&amp; evenx)</b>
<b class="nc">&nbsp;                || ((position.getY() == 0) &amp;&amp; (facing == 0))</b>
<b class="nc">&nbsp;                || ((position.getY() == (board.getHeight() - 1))</b>
&nbsp;                        &amp;&amp; ((facing == 2) || (facing == 3) || (facing == 4)) &amp;&amp; !evenx)
<b class="nc">&nbsp;                || ((position.getY() == (board.getHeight() - 1))</b>
&nbsp;                        &amp;&amp; (facing == 3)))) {
<b class="nc">&nbsp;            setFlyOffEnabled(true);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setFlyOffEnabled(false);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void updateLaunchButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setLaunchEnabled((ce.getLaunchableFighters().size() &gt; 0)</b>
<b class="nc">&nbsp;                || (ce.getLaunchableSmallCraft().size() &gt; 0)</b>
<b class="nc">&nbsp;                || (ce.getLaunchableDropships().size() &gt; 0));</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    // private void updateDockButton() {
&nbsp;    //
&nbsp;    // final Entity ce = ce();
&nbsp;    //
&nbsp;    // if (null == ce) {
&nbsp;    // return;
&nbsp;    // }
&nbsp;    //
&nbsp;    // updateRecoveryButton();
&nbsp;    //
&nbsp;    // }
&nbsp;
&nbsp;    private void updateDropButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setDropEnabled(ce.isAirborne() &amp;&amp; (ce.getDroppableUnits().size() &gt; 0));</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private void updateEvadeButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                      .booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_EVADE)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!((ce instanceof Mech) || (ce instanceof Tank))) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setEvadeEnabled((cmd.getLastStepMovementType() != EntityMovementType.MOVE_JUMP)</b>
<b class="nc">&nbsp;                        &amp;&amp; (cmd.getLastStepMovementType() != EntityMovementType.MOVE_SPRINT));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void updateBootleggerButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                      .booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (!(ce instanceof Tank || ce instanceof QuadVee)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;                
<b class="nc">&nbsp;        if (ce.getMovementMode() != EntityMovementMode.WHEELED</b>
<b class="nc">&nbsp;                &amp;&amp; ce.getMovementMode() != EntityMovementMode.HOVER</b>
<b class="nc">&nbsp;                &amp;&amp; ce.getMovementMode() != EntityMovementMode.VTOL) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setBootleggerEnabled(cmd.getLastStep() != null &amp;&amp; cmd.getLastStep().getNStraight() &gt;= 3);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void updateShutdownButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                      .booleanOption(OptionsConstants.RPG_MANUAL_SHUTDOWN)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ce instanceof Infantry) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setShutdownEnabled(!ce.isManualShutdown() &amp;&amp; !ce.isStartupThisPhase());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void updateStartupButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                      .booleanOption(OptionsConstants.RPG_MANUAL_SHUTDOWN)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ce instanceof Infantry) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setStartupEnabled(ce.isManualShutdown() &amp;&amp; !ce.isShutDownThisPhase());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void updateSelfDestructButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                      .booleanOption(OptionsConstants.ADVANCED_TACOPS_SELF_DESTRUCT)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ce instanceof Infantry) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setSelfDestructEnabled(ce.hasEngine() &amp;&amp; ce.getEngine().isFusion()</b>
<b class="nc">&nbsp;                               &amp;&amp; !ce.getSelfDestructing() &amp;&amp; !ce.getSelfDestructInitiated());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void updateTraitorButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setTraitorEnabled(true);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void updateConvertModeButton() {
&nbsp;
<b class="nc">&nbsp;        if (cmd.length() &gt; 0 &amp;&amp; cmd.getLastStep().getType() != MoveStepType.CONVERT_MODE) {</b>
<b class="nc">&nbsp;            setModeConvertEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;        
<b class="nc">&nbsp;        if (null == ce) {</b>
<b class="nc">&nbsp;            setModeConvertEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (ce instanceof LandAirMech) {</b>
<b class="nc">&nbsp;            boolean canConvert = false;</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; 3; i++) {</b>
<b class="nc">&nbsp;                if (i != ce.getConversionMode()</b>
<b class="nc">&nbsp;                        &amp;&amp; ((LandAirMech)ce).canConvertTo(ce.getConversionMode(), i)) {</b>
<b class="nc">&nbsp;                    canConvert = true;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (!canConvert) {</b>
<b class="nc">&nbsp;                setModeConvertEnabled(false);</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;        } else if (!(ce instanceof QuadVee</b>
<b class="nc">&nbsp;                || (ce instanceof Mech &amp;&amp; ((Mech)ce).hasTracks()))) {</b>
<b class="nc">&nbsp;            setModeConvertEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        IHex currHex =  clientgui.getClient().getGame().getBoard().getHex(ce.getPosition());</b>
<b class="nc">&nbsp;        if (currHex.containsTerrain(Terrains.WATER)</b>
<b class="nc">&nbsp;                &amp;&amp; ce.getElevation() &lt; 0) {</b>
<b class="nc">&nbsp;            setModeConvertEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (ce instanceof LandAirMech &amp;&amp; ce.isGyroDestroyed()) {</b>
<b class="nc">&nbsp;            setModeConvertEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (ce instanceof QuadVee &amp;&amp; ((QuadVee)ce).conversionCost() &gt; ce.getRunMP()) {</b>
<b class="nc">&nbsp;            setModeConvertEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        setModeConvertEnabled(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void updateRecklessButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (ce.isAirborne()) {</b>
<b class="nc">&nbsp;            setRecklessEnabled(false);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ce instanceof Protomech) {</b>
<b class="nc">&nbsp;            setRecklessEnabled(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setRecklessEnabled((null == cmd) || (cmd.length() == 0));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void updateManeuverButton() {
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getBoard().inSpace()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.isAirborne()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.isAero()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        IAero a = (IAero) ce;</b>
&nbsp;
<b class="nc">&nbsp;        if (a.isSpheroid()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (a.didFailManeuver()) {</b>
<b class="nc">&nbsp;            setManeuverEnabled(false);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if ((null != cmd) &amp;&amp; cmd.contains(MoveStepType.MANEUVER)) {</b>
<b class="nc">&nbsp;            setManeuverEnabled(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setManeuverEnabled(true);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private void updateStrafeButton() {
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                .booleanOption(OptionsConstants.ADVCOMBAT_VTOL_STRAFING)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        setStrafeEnabled(ce() instanceof VTOL);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void updateBombButton() {
<b class="nc">&nbsp;        MoveStep lastStep = cmd.getLastStep();</b>
<b class="nc">&nbsp;        if ((lastStep == null)</b>
<b class="nc">&nbsp;                &amp;&amp; !ce().isAirborneVTOLorWIGE()) {</b>
<b class="nc">&nbsp;            setBombEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (lastStep != null</b>
<b class="nc">&nbsp;                &amp;&amp; lastStep.getClearance() &lt;= 0) {</b>
<b class="nc">&nbsp;            setBombEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (ce().isBomber()</b>
<b class="nc">&nbsp;                &amp;&amp; ((ce() instanceof LandAirMech)</b>
<b class="nc">&nbsp;                        || clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                        .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VTOL_ATTACKS))</b>
<b class="nc">&nbsp;                &amp;&amp; ((IBomber)ce()).getBombPoints() &gt; 0) {</b>
<b class="nc">&nbsp;            setBombEnabled(true);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private synchronized void updateLoadButtons() {
<b class="nc">&nbsp;        final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ce instanceof SmallCraft) {</b>
<b class="nc">&nbsp;            setUnloadEnabled((ce.getUnitsUnloadableFromBays().size() &gt; 0)</b>
<b class="nc">&nbsp;                             &amp;&amp; !ce.isAirborne());</b>
<b class="nc">&nbsp;            setLoadEnabled(false);</b>
<b class="nc">&nbsp;            setMountEnabled(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // can this unit mount a dropship/small craft/train?
<b class="nc">&nbsp;        setMountEnabled(false);</b>
<b class="nc">&nbsp;        Coords pos = ce.getPosition();</b>
<b class="nc">&nbsp;        int elev = ce.getElevation();</b>
<b class="nc">&nbsp;        int mpUsed = ce.mpUsed;</b>
<b class="nc">&nbsp;        if (null != cmd) {</b>
<b class="nc">&nbsp;            pos = cmd.getFinalCoords();</b>
<b class="nc">&nbsp;            elev = cmd.getFinalElevation();</b>
<b class="nc">&nbsp;            mpUsed = cmd.getMpUsed();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!ce.isAirborne()</b>
<b class="nc">&nbsp;                &amp;&amp; (mpUsed &lt;= Math.ceil((ce.getWalkMP() / 2.0)))</b>
<b class="nc">&nbsp;                &amp;&amp; !Compute.getMountableUnits(ce, pos,</b>
<b class="nc">&nbsp;                    elev + game.getBoard().getHex(pos).surface(), game).isEmpty()) {</b>
<b class="nc">&nbsp;            setMountEnabled(true);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        boolean legalGear = ((gear == MovementDisplay.GEAR_LAND)</b>
&nbsp;                             || (gear == MovementDisplay.GEAR_TURN)
&nbsp;                             || (gear == MovementDisplay.GEAR_BACKUP)
&nbsp;                             || (gear == MovementDisplay.GEAR_JUMP));
<b class="nc">&nbsp;        int unloadEl = cmd.getFinalElevation();</b>
<b class="nc">&nbsp;        IHex hex = ce.getGame().getBoard().getHex(cmd.getFinalCoords());</b>
&nbsp;        
<b class="nc">&nbsp;        boolean finalCoordinatesOnBoard = ce.getGame().getBoard().contains(cmd.getFinalCoords());</b>
<b class="nc">&nbsp;        boolean canUnloadHere = false;</b>
&nbsp;        
&nbsp;        // if the path&#39;s final coordinate are off-board (as could be the case on space maps with advanced movement)
&nbsp;        // we will say that it is not possible to unload units in such a situation.
<b class="nc">&nbsp;        if(finalCoordinatesOnBoard) {</b>
<b class="nc">&nbsp;            for (Entity en : loadedUnits) {</b>
<b class="nc">&nbsp;                if (en.isElevationValid(unloadEl, hex) || (en.getJumpMP() &gt; 0)) {</b>
<b class="nc">&nbsp;                    canUnloadHere = true;</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                }
&nbsp;                // Zip lines, TO pg 219
<b class="nc">&nbsp;                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_ZIPLINES)</b>
<b class="nc">&nbsp;                        &amp;&amp; (ce() instanceof VTOL) &amp;&amp; (en instanceof Infantry) </b>
<b class="nc">&nbsp;                        &amp;&amp; !((Infantry)en).isMechanized()) {</b>
<b class="nc">&nbsp;                    canUnloadHere = true;</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Disable the &quot;Unload&quot; button if we&#39;re in the wrong
&nbsp;        // gear or if the entity is not transporting units.
<b class="nc">&nbsp;        setUnloadEnabled(legalGear &amp;&amp; canUnloadHere &amp;&amp; !loadedUnits.isEmpty());</b>
&nbsp;
<b class="nc">&nbsp;        boolean canDropTrailerHere = false;</b>
<b class="nc">&nbsp;        if(finalCoordinatesOnBoard) {</b>
<b class="nc">&nbsp;            for (Entity en : towedUnits) {</b>
<b class="nc">&nbsp;                if (en.isElevationValid(unloadEl, hex)) {</b>
<b class="nc">&nbsp;                    canDropTrailerHere = true;</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Disable the &quot;Disconnect&quot; button if we&#39;re in the wrong
&nbsp;        // gear or if the entity is not transporting units.
<b class="nc">&nbsp;        setDisconnectEnabled(legalGear &amp;&amp; canDropTrailerHere &amp;&amp; !towedUnits.isEmpty());</b>
&nbsp;
&nbsp;        // If the current entity has moved, disable &quot;Load&quot; and &quot;Tow&quot; buttons.
<b class="nc">&nbsp;        setLoadEnabled(false);</b>
<b class="nc">&nbsp;        setTowEnabled(false);</b>
<b class="nc">&nbsp;        if ((cmd.length() == 0) &amp;&amp; (cen != Entity.NONE)) {</b>
&nbsp;            // Check the other entities in the current hex for friendly units.
<b class="nc">&nbsp;            for (Entity other : game.getEntitiesVector(ce.getPosition())) {</b>
&nbsp;                // If the other unit is friendly and not the current entity
&nbsp;                // and the current entity has at least 1 MP, if it can
&nbsp;                // transport the other unit, and if the other hasn&#39;t moved
&nbsp;                // then enable the &quot;Load&quot; button. Towing gets handled later,
&nbsp;                // and we don&#39;t want both buttons enabled.
<b class="nc">&nbsp;                if ((ce.getWalkMP() &gt; 0) &amp;&amp; ce.canLoad(other)</b>
<b class="nc">&nbsp;                    &amp;&amp; other.isLoadableThisTurn() &amp;&amp; !ce.canTow(other.getId())) {</b>
<b class="nc">&nbsp;                    setLoadEnabled(true);</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                }
<b class="nc">&nbsp;            } // Check the next entity in this position.</b>
&nbsp;            //Now check all eligible hexes for towable trailers
<b class="nc">&nbsp;            for (Coords c : ce.getHitchLocations()) {</b>
<b class="nc">&nbsp;                for (Entity other : game.getEntitiesVector(c)) {</b>
&nbsp;                    // If the other unit is friendly and not the current entity
&nbsp;                    // if it can tow the other unit, and if the other hasn&#39;t moved
&nbsp;                    // then enable the &quot;Tow&quot; button.
<b class="nc">&nbsp;                    if (ce.canTow(other.getId())) {</b>
<b class="nc">&nbsp;                        setTowEnabled(true);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
<b class="nc">&nbsp;                } // Check the next entity.</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        } // End ce-hasn&#39;t-moved
&nbsp;    } // private void updateLoadButtons
&nbsp;
&nbsp;    private void updateLayMineButton() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.canLayMine() || cmd.contains(MoveStepType.LAY_MINE)) {</b>
<b class="nc">&nbsp;            setLayMineEnabled(false);</b>
<b class="nc">&nbsp;        } else if (ce instanceof BattleArmor) {</b>
<b class="nc">&nbsp;            setLayMineEnabled(cmd.getLastStep() == null</b>
<b class="nc">&nbsp;                || cmd.isJumping()</b>
<b class="nc">&nbsp;                || cmd.getLastStepMovementType().equals(EntityMovementType.MOVE_VTOL_WALK));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setLayMineEnabled(true);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private Entity getMountedUnit() {
<b class="nc">&nbsp;        Entity ce = ce();</b>
<b class="nc">&nbsp;        Entity choice = null;</b>
<b class="nc">&nbsp;        Coords pos = ce.getPosition();</b>
<b class="nc">&nbsp;        int elev = ce.getElevation();</b>
<b class="nc">&nbsp;        if (null != cmd) {</b>
<b class="nc">&nbsp;            pos = cmd.getFinalCoords();</b>
<b class="nc">&nbsp;            elev = cmd.getFinalElevation();</b>
&nbsp;        }
<b class="nc">&nbsp;        IHex hex = clientgui.getClient().getGame().getBoard().getHex(pos);</b>
<b class="nc">&nbsp;        if (null != hex) {</b>
<b class="nc">&nbsp;            elev += hex.getLevel();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        List&lt;Entity&gt; mountableUnits = Compute.getMountableUnits(ce, pos, elev, clientgui.getClient().getGame());</b>
&nbsp;
&nbsp;        // Handle error condition.
<b class="nc">&nbsp;        if (mountableUnits.isEmpty()) {</b>
<b class="nc">&nbsp;            System.err.println(&quot;MovementDisplay#getMountedUnit() &quot; +</b>
&nbsp;                               &quot;called without mountable units.&quot;); //$NON-NLS-1$
&nbsp;        }
&nbsp;
&nbsp;        // If we have multiple choices, display a selection dialog.
<b class="nc">&nbsp;        else if (mountableUnits.size() &gt; 1) {</b>
<b class="nc">&nbsp;            String input = (String) JOptionPane</b>
<b class="nc">&nbsp;                    .showInputDialog(</b>
&nbsp;                            clientgui,
<b class="nc">&nbsp;                            Messages.getString(</b>
&nbsp;                                    &quot;MovementDisplay.MountUnitDialog.message&quot;, new Object[]{//$NON-NLS-1$
<b class="nc">&nbsp;                                                                                            ce.getShortName()}),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.MountUnitDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<b class="nc">&nbsp;                                    .getDisplayArray(mountableUnits), null);</b>
<b class="nc">&nbsp;            choice = (Entity) SharedUtility.getTargetPicked(mountableUnits,</b>
&nbsp;                                                            input);
<b class="nc">&nbsp;        } // End have-choices</b>
&nbsp;
&nbsp;        // Only one choice.
&nbsp;        else {
<b class="nc">&nbsp;            choice = mountableUnits.get(0);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!(ce instanceof Infantry)) {</b>
<b class="nc">&nbsp;            Vector&lt;Integer&gt; bayChoices = new Vector&lt;Integer&gt;();</b>
<b class="nc">&nbsp;            for (Transporter t : choice.getTransports()) {</b>
<b class="nc">&nbsp;                if (t.canLoad(ce) &amp;&amp; (t instanceof Bay)) {</b>
<b class="nc">&nbsp;                    bayChoices.add(((Bay) t).getBayNumber());</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            String[] retVal = new String[bayChoices.size()];</b>
<b class="nc">&nbsp;            int i = 0;</b>
<b class="nc">&nbsp;            for (Integer bn : bayChoices) {</b>
<b class="nc">&nbsp;                retVal[i++] = bn.toString() + &quot; (Free Slots: &quot;</b>
<b class="nc">&nbsp;                              + (int) choice.getBayById(bn).getUnused() + &quot;)&quot;;</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (bayChoices.size() &gt; 1) {</b>
<b class="nc">&nbsp;                String bayString = (String) JOptionPane</b>
<b class="nc">&nbsp;                        .showInputDialog(</b>
&nbsp;                                clientgui,
<b class="nc">&nbsp;                                Messages.getString(</b>
&nbsp;                                        &quot;MovementDisplay.MountUnitBayNumberDialog.message&quot;,
<b class="nc">&nbsp;                                        new Object[]{choice.getShortName()}), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.MountUnitBayNumberDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                                JOptionPane.QUESTION_MESSAGE, null, retVal,
&nbsp;                                null);
<b class="nc">&nbsp;                ce.setTargetBay(Integer.parseInt(bayString.substring(0,</b>
<b class="nc">&nbsp;                                                                     bayString.indexOf(&quot; &quot;))));</b>
&nbsp;                // We need to update the entity here so that the server knows
&nbsp;                // about our target bay
<b class="nc">&nbsp;                clientgui.getClient().sendUpdateEntity(ce);</b>
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                ce.setTargetBay(-1); // Safety set!</b>
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            ce.setTargetBay(-1); // Safety set!</b>
&nbsp;        }
&nbsp;
&nbsp;        // Return the chosen unit.
<b class="nc">&nbsp;        return choice;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Entity getLoadedUnit() {
<b class="nc">&nbsp;        final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        Entity choice = null;</b>
&nbsp;
<b class="nc">&nbsp;        Vector&lt;Entity&gt; choices = new Vector&lt;Entity&gt;();</b>
<b class="nc">&nbsp;        for (Entity other : game.getEntitiesVector(ce().getPosition())) {</b>
<b class="nc">&nbsp;            if (other.isLoadableThisTurn() &amp;&amp; (ce() != null)</b>
<b class="nc">&nbsp;                &amp;&amp; ce().canLoad(other, false)) {</b>
<b class="nc">&nbsp;                choices.addElement(other);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // Handle error condition.
<b class="nc">&nbsp;        if (choices.size() == 0) {</b>
<b class="nc">&nbsp;            System.err</b>
<b class="nc">&nbsp;                    .println(&quot;MovementDisplay#getLoadedUnit() called without loadable units.&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
&nbsp;        // If we have multiple choices, display a selection dialog.
<b class="nc">&nbsp;        if (choices.size() &gt; 1) {</b>
<b class="nc">&nbsp;            String input = (String) JOptionPane</b>
<b class="nc">&nbsp;                    .showInputDialog(clientgui,</b>
<b class="nc">&nbsp;                                     Messages.getString(</b>
&nbsp;                                             &quot;DeploymentDisplay.loadUnitDialog.message&quot;,
<b class="nc">&nbsp;                                             new Object[]{ce().getShortName(),</b>
<b class="nc">&nbsp;                                                          ce().getUnusedString()}), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                     Messages.getString(&quot;DeploymentDisplay.loadUnitDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                                     JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<b class="nc">&nbsp;                                    .getDisplayArray(choices), null);</b>
<b class="nc">&nbsp;            choice = (Entity) SharedUtility.getTargetPicked(choices, input);</b>
<b class="nc">&nbsp;        } // End have-choices</b>
&nbsp;
&nbsp;        // Only one choice.
&nbsp;        else {
<b class="nc">&nbsp;            choice = choices.get(0);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!(choice instanceof Infantry)) {</b>
<b class="nc">&nbsp;            List&lt;Integer&gt; bayChoices = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (Transporter t : ce().getTransports()) {</b>
<b class="nc">&nbsp;                if (t.canLoad(choice) &amp;&amp; (t instanceof Bay)) {</b>
<b class="nc">&nbsp;                    bayChoices.add(((Bay) t).getBayNumber());</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (bayChoices.size() &gt; 1) {</b>
<b class="nc">&nbsp;                String[] retVal = new String[bayChoices.size()];</b>
<b class="nc">&nbsp;                int i = 0;</b>
<b class="nc">&nbsp;                for (Integer bn : bayChoices) {</b>
<b class="nc">&nbsp;                    retVal[i++] = bn.toString() + &quot; (Free Slots: &quot;</b>
<b class="nc">&nbsp;                            + (int) ce().getBayById(bn).getUnused() + &quot;)&quot;;</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                String bayString = (String) JOptionPane</b>
<b class="nc">&nbsp;                        .showInputDialog(</b>
&nbsp;                                clientgui,
<b class="nc">&nbsp;                                Messages.getString(</b>
&nbsp;                                        &quot;MovementDisplay.loadUnitBayNumberDialog.message&quot;,
<b class="nc">&nbsp;                                        new Object[]{ce().getShortName()}), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.loadUnitBayNumberDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                                JOptionPane.QUESTION_MESSAGE, null, retVal,
&nbsp;                                null);
<b class="nc">&nbsp;                choice.setTargetBay(Integer.parseInt(bayString.substring(0,</b>
<b class="nc">&nbsp;                        bayString.indexOf(&quot; &quot;))));</b>
&nbsp;                // We need to update the entity here so that the server knows
&nbsp;                // about our target bay
<b class="nc">&nbsp;                clientgui.getClient().sendUpdateEntity(choice);</b>
<b class="nc">&nbsp;            } else if (choice.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</b>
<b class="nc">&nbsp;                bayChoices = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                for (Transporter t : ce().getTransports()) {</b>
<b class="nc">&nbsp;                    if ((t instanceof ProtomechClampMount)</b>
<b class="nc">&nbsp;                                &amp;&amp; t.canLoad(choice)) {</b>
<b class="nc">&nbsp;                        bayChoices.add(((ProtomechClampMount) t).isRear()? 1 : 0);</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                if (bayChoices.size() &gt; 1) {</b>
<b class="nc">&nbsp;                    String[] retVal = new String[bayChoices.size()];</b>
<b class="nc">&nbsp;                    int i = 0;</b>
<b class="nc">&nbsp;                    for (Integer bn : bayChoices) {</b>
<b class="nc">&nbsp;                        retVal[i++] = bn &gt; 0?</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.loadProtoClampMountDialog.rear&quot;) :</b>
<b class="nc">&nbsp;                                    Messages.getString(&quot;MovementDisplay.loadProtoClampMountDialog.front&quot;);</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    String bayString = (String) JOptionPane</b>
<b class="nc">&nbsp;                            .showInputDialog(</b>
&nbsp;                                    clientgui,
<b class="nc">&nbsp;                                    Messages.getString(</b>
&nbsp;                                            &quot;MovementDisplay.loadProtoClampMountDialog.message&quot;,
<b class="nc">&nbsp;                                            new Object[]{ce().getShortName()}), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                    Messages.getString(&quot;MovementDisplay.loadProtoClampMountDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                                    JOptionPane.QUESTION_MESSAGE, null, retVal,
&nbsp;                                    null);
<b class="nc">&nbsp;                    choice.setTargetBay(bayString.equals(Messages</b>
<b class="nc">&nbsp;                            .getString(&quot;MovementDisplay.loadProtoClampMountDialog.front&quot;))? 0 : 1);</b>
&nbsp;                    // We need to update the entity here so that the server knows
&nbsp;                    // about our target bay
<b class="nc">&nbsp;                    clientgui.getClient().sendUpdateEntity(choice);</b>
<b class="nc">&nbsp;                } else {</b>
<b class="nc">&nbsp;                    choice.setTargetBay(-1); // Safety set!</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            choice.setTargetBay(-1); // Safety set!</b>
&nbsp;        }
&nbsp;
&nbsp;        // Return the chosen unit.
<b class="nc">&nbsp;        return choice;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Get the unit (trailer) that the player wants to connect. This method will add the
&nbsp;     * trailer to our local copy of loaded units.
&nbsp;     *
&nbsp;     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to tow. This
&nbsp;     * value may be null if there are no eligible targets
&nbsp;     */
&nbsp;    private Entity getTowedUnit() {
<b class="nc">&nbsp;        final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        Entity choice = null;</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;Entity&gt; choices = new ArrayList&lt;Entity&gt;();</b>
&nbsp;        
&nbsp;        //We have to account for the positions of the whole train when looking to add new trailers
<b class="nc">&nbsp;        for (Coords pos : ce().getHitchLocations()) {</b>
<b class="nc">&nbsp;            for (Entity other : game.getEntitiesVector(pos)) {</b>
<b class="nc">&nbsp;                if (ce() != null &amp;&amp; ce().canTow(other.getId())) {</b>
<b class="nc">&nbsp;                    choices.add(other);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        
&nbsp;        // Handle error condition.
<b class="nc">&nbsp;        if (choices.size() == 0) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().debug(&quot;Method called without towable units.&quot;);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
&nbsp;        // If we have multiple choices, display a selection dialog.
<b class="nc">&nbsp;        if (choices.size() &gt; 1) {</b>
<b class="nc">&nbsp;            String input = (String) JOptionPane</b>
<b class="nc">&nbsp;                    .showInputDialog(clientgui,</b>
<b class="nc">&nbsp;                                     Messages.getString(</b>
&nbsp;                                             &quot;DeploymentDisplay.towUnitDialog.message&quot;,
<b class="nc">&nbsp;                                             new Object[]{ce().getShortName()}), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                     Messages.getString(&quot;DeploymentDisplay.towUnitDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                                     JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<b class="nc">&nbsp;                                    .getDisplayArray(choices), null);</b>
<b class="nc">&nbsp;            choice = (Entity) SharedUtility.getTargetPicked(choices, input);</b>
<b class="nc">&nbsp;        } // End have-choices</b>
&nbsp;
&nbsp;        // Only one choice.
&nbsp;        else {
<b class="nc">&nbsp;            choice = choices.get(0);</b>
&nbsp;        }
&nbsp;        
&nbsp;        //Set up the correct hitch/transporter to use
&nbsp;        //We need lots of data about the hitch to store in different places. Save that here
<b class="nc">&nbsp;        final class HitchChoice {</b>
&nbsp;            private final int id;
&nbsp;            private final int number;
&nbsp;            private final TankTrailerHitch hitch;
&nbsp;
<b class="nc">&nbsp;            private HitchChoice(int id, int number, TankTrailerHitch t) {</b>
<b class="nc">&nbsp;                this.id = id;</b>
<b class="nc">&nbsp;                this.number = number;</b>
<b class="nc">&nbsp;                this.hitch = t;</b>
&nbsp;            }
&nbsp;
&nbsp;            private int getId() {
<b class="nc">&nbsp;                return id;</b>
&nbsp;            }
&nbsp;
&nbsp;            private int getNumber() {
<b class="nc">&nbsp;                return number;</b>
&nbsp;            }
&nbsp;            
&nbsp;            private TankTrailerHitch getHitch() {
<b class="nc">&nbsp;                return hitch;</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public String toString() {
&nbsp;                // the string should tell the user if the hitch is mounted front or rear
<b class="nc">&nbsp;                if (getHitch().getRearMounted()) {</b>
<b class="nc">&nbsp;                    return String.format(&quot;%s Trailer Hitch #[%d] (rear)&quot;, game.getEntity(id).getShortName(), getNumber());</b>
&nbsp;                }
<b class="nc">&nbsp;                return String.format(&quot;%s Trailer Hitch #[%d] (front)&quot;, game.getEntity(id).getShortName(), getNumber());</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
&nbsp;        //Create a collection to keep my choices in
<b class="nc">&nbsp;        List&lt;HitchChoice&gt; hitchChoices = new ArrayList&lt;&gt;();</b>
&nbsp;        
&nbsp;        //next, set up a list of all the entities in this train
<b class="nc">&nbsp;        ArrayList&lt;Entity&gt; thisTrain = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        thisTrain.add(ce());</b>
<b class="nc">&nbsp;        for (int id : ce().getAllTowedUnits()) {</b>
<b class="nc">&nbsp;            Entity tr = game.getEntity(id);</b>
<b class="nc">&nbsp;            thisTrain.add(tr);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        //and store all the valid Hitch transporters that each one has
&nbsp;        //really, there shouldn&#39;t be but one per entity. &quot;Towing&quot; front and rear with the
&nbsp;        //tractor in the center isn&#39;t going to work well...
<b class="nc">&nbsp;        for (Entity e : thisTrain) {</b>
<b class="nc">&nbsp;            for (Transporter t : e.getTransports()) {</b>
<b class="nc">&nbsp;                if (t.canTow(choice)) {</b>
<b class="nc">&nbsp;                    TankTrailerHitch h = (TankTrailerHitch) t;</b>
<b class="nc">&nbsp;                    HitchChoice hitch = new HitchChoice(e.getId(), e.getTransports().indexOf(t), h);</b>
<b class="nc">&nbsp;                    hitchChoices.add(hitch);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        
&nbsp;        //Gah, multiple choice test! 
<b class="nc">&nbsp;        if (hitchChoices.size() &gt; 1) {</b>
&nbsp;            //Set up a dialog box for the hitch options
<b class="nc">&nbsp;            String[] retVal = new String[hitchChoices.size()];</b>
<b class="nc">&nbsp;            int i = 0;</b>
<b class="nc">&nbsp;            for (HitchChoice hc : hitchChoices) {</b>
<b class="nc">&nbsp;                retVal[i++] = hc.toString();</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            String selection = (String) JOptionPane</b>
<b class="nc">&nbsp;                    .showInputDialog(</b>
&nbsp;                            clientgui,
<b class="nc">&nbsp;                            Messages.getString(</b>
&nbsp;                                    &quot;MovementDisplay.loadUnitHitchDialog.message&quot;,
<b class="nc">&nbsp;                                    new Object[]{ce().getShortName()}), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.loadUnitHitchDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                            JOptionPane.QUESTION_MESSAGE, null, retVal,
&nbsp;                            null);
<b class="nc">&nbsp;            HitchChoice hc = null;</b>
<b class="nc">&nbsp;            if (selection != null) {</b>
<b class="nc">&nbsp;                for (int loop = 0; loop &lt; hitchChoices.size(); loop++) {</b>
<b class="nc">&nbsp;                    if (selection.equals(hitchChoices.get(loop).toString())) {</b>
<b class="nc">&nbsp;                        hc = hitchChoices.get(loop);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;            //Set the transporter number in the towed entity from the selection
<b class="nc">&nbsp;            choice.setTargetBay(hc.getNumber());</b>
&nbsp;            //and then the Entity id the transporter is attached to...
<b class="nc">&nbsp;            choice.setTowedBy(hc.getId());</b>
<b class="nc">&nbsp;        } else {</b>
&nbsp;            //and in case there&#39;s just one choice...
<b class="nc">&nbsp;            choice.setTargetBay(hitchChoices.get(0).getNumber());</b>
<b class="nc">&nbsp;            choice.setTowedBy(hitchChoices.get(0).getId());</b>
&nbsp;        }
&nbsp;
&nbsp;        // We need to update the entities here so that the server knows
&nbsp;        // about our changes
<b class="nc">&nbsp;        ce().setTowing(choice.getId());</b>
<b class="nc">&nbsp;        clientgui.getClient().sendUpdateEntity(ce());</b>
<b class="nc">&nbsp;        clientgui.getClient().sendUpdateEntity(choice);</b>
&nbsp;
&nbsp;        // Return the chosen unit.
<b class="nc">&nbsp;        return choice;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Get the unit that the player wants to unload. This method will remove the
&nbsp;     * unit from our local copy of loaded units.
&nbsp;     *
&nbsp;     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
&nbsp;     * value will not be &lt;code&gt;null&lt;/code&gt;.
&nbsp;     */
&nbsp;    private Entity getDisconnectedUnit() {
<b class="nc">&nbsp;        Entity ce = ce();</b>
<b class="nc">&nbsp;        Entity choice = null;</b>
&nbsp;        
&nbsp;        // Handle error condition.
<b class="nc">&nbsp;        if (ce.getAllTowedUnits().isEmpty()) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().debug(&quot;Method called without any towed units.&quot;);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;        
&nbsp;        // If we have multiple choices, display a selection dialog.
<b class="nc">&nbsp;        else if (ce.getAllTowedUnits().size() &gt; 1) {</b>
<b class="nc">&nbsp;            String input = (String) JOptionPane</b>
<b class="nc">&nbsp;                    .showInputDialog(</b>
&nbsp;                            clientgui,
<b class="nc">&nbsp;                            Messages.getString(</b>
&nbsp;                                    &quot;MovementDisplay.DisconnectUnitDialog.message&quot;, new Object[]{//$NON-NLS-1$
<b class="nc">&nbsp;                                                                                             ce.getShortName(), ce.getUnusedString()}),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.DisconnectUnitDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<b class="nc">&nbsp;                                    .getDisplayArray(towedUnits), null);</b>
<b class="nc">&nbsp;            choice = (Entity) SharedUtility.getTargetPicked(towedUnits, input);</b>
<b class="nc">&nbsp;        } // End have-choices</b>
&nbsp;
&nbsp;        // Only one choice.
&nbsp;        else {
<b class="nc">&nbsp;            choice = towedUnits.get(0);</b>
<b class="nc">&nbsp;            towedUnits.remove(0);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Return the chosen unit.
<b class="nc">&nbsp;        return choice;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the unit that the player wants to unload. This method will remove the
&nbsp;     * unit from our local copy of loaded units.
&nbsp;     *
&nbsp;     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
&nbsp;     * value will not be &lt;code&gt;null&lt;/code&gt;.
&nbsp;     */
&nbsp;    private Entity getUnloadedUnit() {
<b class="nc">&nbsp;        Entity ce = ce();</b>
<b class="nc">&nbsp;        Entity choice = null;</b>
&nbsp;        // Handle error condition.
<b class="nc">&nbsp;        if (loadedUnits.size() == 0) {</b>
<b class="nc">&nbsp;            System.err</b>
<b class="nc">&nbsp;                    .println(&quot;MovementDisplay#getUnloadedUnit() called without loaded units.&quot;); //$NON-NLS-1$</b>
&nbsp;        }
&nbsp;        // If we have multiple choices, display a selection dialog.
<b class="nc">&nbsp;        else if (loadedUnits.size() &gt; 1) {</b>
<b class="nc">&nbsp;            String input = (String) JOptionPane</b>
<b class="nc">&nbsp;                    .showInputDialog(</b>
&nbsp;                            clientgui,
<b class="nc">&nbsp;                            Messages.getString(</b>
&nbsp;                                    &quot;MovementDisplay.UnloadUnitDialog.message&quot;, new Object[]{//$NON-NLS-1$
<b class="nc">&nbsp;                                                                                             ce.getShortName(), ce.getUnusedString()}),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.UnloadUnitDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<b class="nc">&nbsp;                                    .getDisplayArray(loadedUnits), null);</b>
<b class="nc">&nbsp;            choice = (Entity) SharedUtility.getTargetPicked(loadedUnits, input);</b>
<b class="nc">&nbsp;        } // End have-choices</b>
&nbsp;
&nbsp;        // Only one choice.
&nbsp;        else {
<b class="nc">&nbsp;            choice = loadedUnits.get(0);</b>
<b class="nc">&nbsp;            loadedUnits.remove(0);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Return the chosen unit.
<b class="nc">&nbsp;        return choice;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Coords getUnloadPosition(Entity unloaded) {
<b class="nc">&nbsp;        Entity ce = ce();</b>
&nbsp;        // we need to allow the user to select a hex for offloading
<b class="nc">&nbsp;        Coords pos = ce.getPosition();</b>
<b class="nc">&nbsp;        if (null != cmd) {</b>
<b class="nc">&nbsp;            pos = cmd.getFinalCoords();</b>
&nbsp;        }
<b class="nc">&nbsp;        int elev = clientgui.getClient().getGame().getBoard().getHex(pos)</b>
<b class="nc">&nbsp;                            .getLevel()</b>
<b class="nc">&nbsp;                   + ce.getElevation();</b>
<b class="nc">&nbsp;        List&lt;Coords&gt; ring = pos.allAdjacent();</b>
<b class="nc">&nbsp;        if (ce instanceof Dropship) {</b>
<b class="nc">&nbsp;            ring = pos.allAtDistance(2);</b>
&nbsp;        }
&nbsp;        // ok now we need to go through the ring and identify available
&nbsp;        // Positions
<b class="nc">&nbsp;        ring = Compute.getAcceptableUnloadPositions(ring, unloaded, clientgui</b>
<b class="nc">&nbsp;                .getClient().getGame(), elev);</b>
&nbsp;        //If we&#39;re a train, eliminate positions held by any unit in the train. 
&nbsp;        //You get stacking violation weirdness if this isn&#39;t done.
<b class="nc">&nbsp;        Set&lt;Coords&gt; toRemove = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        if (ce.getTowing() != Entity.NONE) {</b>
<b class="nc">&nbsp;            for (int i : ce.getAllTowedUnits()) {</b>
<b class="nc">&nbsp;                Entity e = ce.getGame().getEntity(i);</b>
<b class="nc">&nbsp;                if (e != null &amp;&amp; e.getPosition() != null) {</b>
<b class="nc">&nbsp;                    toRemove.add(e.getPosition());</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        } else if (ce.getTractor() != Entity.NONE) {</b>
<b class="nc">&nbsp;            Entity tractor = ce.getGame().getEntity(ce.getTractor());</b>
<b class="nc">&nbsp;            if (tractor != null &amp;&amp; tractor.getPosition() != null) {</b>
<b class="nc">&nbsp;                toRemove.add(tractor.getPosition());</b>
<b class="nc">&nbsp;                for (int i : tractor.getAllTowedUnits()) {</b>
<b class="nc">&nbsp;                    Entity e = ce.getGame().getEntity(i);</b>
<b class="nc">&nbsp;                    if (e != null &amp;&amp; e.getPosition() != null) {</b>
<b class="nc">&nbsp;                        toRemove.add(e.getPosition());</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        ring.removeAll(toRemove);</b>
&nbsp;        
<b class="nc">&nbsp;        if (ring.size() &lt; 1) {</b>
<b class="nc">&nbsp;            String title = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.NoPlaceToUnload.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String body = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.NoPlaceToUnload.message&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            clientgui.doAlertDialog(title, body);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        String[] choices = new String[ring.size()];</b>
<b class="nc">&nbsp;        int i = 0;</b>
<b class="nc">&nbsp;        for (Coords c : ring) {</b>
<b class="nc">&nbsp;            choices[i++] = c.toString();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        String selected = (String) JOptionPane.showInputDialog(clientgui,</b>
<b class="nc">&nbsp;                                                               Messages.getString(</b>
&nbsp;                                                                       &quot;MovementDisplay.ChooseHex&quot; + &quot;.message&quot;, new Object[]{//$NON-NLS-1$
<b class="nc">&nbsp;                                                                                                                              ce.getShortName(), ce.getUnusedString()}), Messages</b>
<b class="nc">&nbsp;                                                                       .getString(&quot;MovementDisplay.ChooseHex.title&quot;),</b>
&nbsp;                                                               //$NON-NLS-1$
&nbsp;                                                               JOptionPane.QUESTION_MESSAGE, null, choices, null);
<b class="nc">&nbsp;        Coords choice = null;</b>
<b class="nc">&nbsp;        if (selected == null) {</b>
<b class="nc">&nbsp;            return choice;</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Coords c : ring) {</b>
<b class="nc">&nbsp;            if (selected.equals(c.toString())) {</b>
<b class="nc">&nbsp;                choice = c;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return choice;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Uses player input to find a legal hex where an EjectedCrew unit can be placed
&nbsp;     * @param abandoned - The vessel we&#39;re escaping from
&nbsp;     * @return
&nbsp;     */
&nbsp;    private Coords getEjectPosition(Entity abandoned) {
&nbsp;        // we need to allow the user to select a hex for offloading the unit&#39;s crew
<b class="nc">&nbsp;        Coords pos = abandoned.getPosition();</b>
&nbsp;        //Create a bogus crew entity to use for legal hex calculation
<b class="nc">&nbsp;        Entity crew = new EjectedCrew();</b>
<b class="nc">&nbsp;        crew.setId(clientgui.getClient().getGame().getNextEntityId());</b>
<b class="nc">&nbsp;        crew.setGame(clientgui.getClient().getGame());</b>
<b class="nc">&nbsp;        int elev = clientgui.getClient().getGame().getBoard().getHex(pos).getLevel() + abandoned.getElevation();</b>
<b class="nc">&nbsp;        List&lt;Coords&gt; ring = pos.allAdjacent();</b>
<b class="nc">&nbsp;        if (abandoned instanceof Dropship) {</b>
<b class="nc">&nbsp;            ring = pos.allAtDistance(2);</b>
&nbsp;        }
&nbsp;        // ok now we need to go through the ring and identify available
&nbsp;        // Positions
<b class="nc">&nbsp;        ring = Compute.getAcceptableUnloadPositions(ring, crew, clientgui</b>
<b class="nc">&nbsp;                .getClient().getGame(), elev);</b>
<b class="nc">&nbsp;        if (ring.size() &lt; 1) {</b>
<b class="nc">&nbsp;            String title = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.NoPlaceToEject.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String body = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.NoPlaceToEject.message&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            clientgui.doAlertDialog(title, body);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        String[] choices = new String[ring.size()];</b>
<b class="nc">&nbsp;        int i = 0;</b>
<b class="nc">&nbsp;        for (Coords c : ring) {</b>
<b class="nc">&nbsp;            choices[i++] = c.toString();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        String selected = (String) JOptionPane.showInputDialog(clientgui,</b>
<b class="nc">&nbsp;                                                               Messages.getString(</b>
&nbsp;                                                                       &quot;MovementDisplay.ChooseEjectHex.message&quot;, new Object[]{//$NON-NLS-1$
<b class="nc">&nbsp;                                                                               abandoned.getShortName(), abandoned.getUnusedString()}), Messages</b>
<b class="nc">&nbsp;                                                                       .getString(&quot;MovementDisplay.ChooseHex.title&quot;),</b>
&nbsp;                                                               //$NON-NLS-1$
&nbsp;                                                               JOptionPane.QUESTION_MESSAGE, null, choices, null);
<b class="nc">&nbsp;        Coords choice = null;</b>
<b class="nc">&nbsp;        if (selected == null) {</b>
<b class="nc">&nbsp;            return choice;</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Coords c : ring) {</b>
<b class="nc">&nbsp;            if (selected.equals(c.toString())) {</b>
<b class="nc">&nbsp;                choice = c;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return choice;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * FIGHTER RECOVERY fighter recovery will be handled differently than
&nbsp;     * loading other units. Namely, it will be an action of the fighter not the
&nbsp;     * carrier. So the fighter just flies right up to a carrier whose movement
&nbsp;     * is ended and hops on. need a new function
&nbsp;     */
&nbsp;    private synchronized void updateRecoveryButton() {
<b class="nc">&nbsp;        final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // I also want to handle fighter recovery here. If using advanced
&nbsp;        // movement
&nbsp;        // it is not a function of where carrier is but where the carrier will
&nbsp;        // be at the end
&nbsp;        // of its move
<b class="nc">&nbsp;        if (ce.isAero()) {</b>
<b class="nc">&nbsp;            Coords loadeePos = cmd.getFinalCoords();</b>
<b class="nc">&nbsp;            if (clientgui.getClient().getGame().useVectorMove()) {</b>
&nbsp;                // not where you are, but where you will be
<b class="nc">&nbsp;                loadeePos = Compute.getFinalPosition(ce.getPosition(),</b>
<b class="nc">&nbsp;                                                     cmd.getFinalVectors());</b>
&nbsp;            }
<b class="nc">&nbsp;            boolean isGood = false;</b>
<b class="nc">&nbsp;            for (Entity other : game.getEntitiesVector(loadeePos)) {</b>
&nbsp;                // Is the other unit friendly and not the current entity?
&nbsp;                // must be done with its movement
&nbsp;                // it also must be same heading and velocity
<b class="nc">&nbsp;                if ((other instanceof Aero) &amp;&amp; other.isDone()</b>
<b class="nc">&nbsp;                    &amp;&amp; other.canLoad(ce)</b>
<b class="nc">&nbsp;                    &amp;&amp; (cmd.getFinalFacing() == other.getFacing())</b>
<b class="nc">&nbsp;                    &amp;&amp; !other.isCapitalFighter()) {</b>
&nbsp;                    // now lets check velocity
&nbsp;                    // depends on movement rules
<b class="nc">&nbsp;                    Aero oa = (Aero) other;</b>
<b class="nc">&nbsp;                    if (clientgui.getClient().getGame().useVectorMove()) {</b>
<b class="nc">&nbsp;                        if (Compute.sameVectors(cmd.getFinalVectors(),</b>
<b class="nc">&nbsp;                                                oa.getVectors())) {</b>
<b class="nc">&nbsp;                            if (ce instanceof Dropship) {</b>
<b class="nc">&nbsp;                                setDockEnabled(true);</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                setRecoverEnabled(true);</b>
&nbsp;                            }
<b class="nc">&nbsp;                            isGood = true;</b>
&nbsp;
&nbsp;                            // We can stop looking now.
<b class="nc">&nbsp;                            break;</b>
&nbsp;                        }
<b class="nc">&nbsp;                    } else if (cmd.getFinalVelocity() == oa</b>
<b class="nc">&nbsp;                            .getCurrentVelocity()) {</b>
<b class="nc">&nbsp;                        if (ce instanceof Dropship) {</b>
<b class="nc">&nbsp;                            setDockEnabled(true);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            setRecoverEnabled(true);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        isGood = true;</b>
&nbsp;
&nbsp;                        // We can stop looking now.
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                // Nope. Discard it.
<b class="nc">&nbsp;                other = null;</b>
<b class="nc">&nbsp;            } // Check the next entity in this position.</b>
<b class="nc">&nbsp;            if (!isGood) {</b>
<b class="nc">&nbsp;                setRecoverEnabled(false);</b>
<b class="nc">&nbsp;                setDockEnabled(false);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Joining a squadron - Similar to fighter recovery. You can fly up and join
&nbsp;     * a squadron or another solo fighter
&nbsp;     */
&nbsp;    private synchronized void updateJoinButton() {
<b class="nc">&nbsp;        final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_CAPITAL_FIGHTER)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.isCapitalFighter()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Coords loadeePos = cmd.getFinalCoords();</b>
<b class="nc">&nbsp;        if (game.useVectorMove()) {</b>
&nbsp;            // not where you are, but where you will be
<b class="nc">&nbsp;            loadeePos = Compute.getFinalPosition(ce.getPosition(),</b>
<b class="nc">&nbsp;                                                 cmd.getFinalVectors());</b>
&nbsp;        }
<b class="nc">&nbsp;        boolean isGood = false;</b>
<b class="nc">&nbsp;        for (Entity other : game.getEntitiesVector(loadeePos)) {</b>
&nbsp;            // Is the other unit friendly and not the current entity?
&nbsp;            // must be done with its movement
&nbsp;            // it also must be same heading and velocity
<b class="nc">&nbsp;            if (ce.getOwner().equals(other.getOwner())</b>
<b class="nc">&nbsp;                &amp;&amp; other.isCapitalFighter() &amp;&amp; other.isDone()</b>
<b class="nc">&nbsp;                &amp;&amp; other.canLoad(ce)</b>
<b class="nc">&nbsp;                &amp;&amp; (cmd.getFinalFacing() == other.getFacing())) {</b>
&nbsp;                // now lets check velocity
&nbsp;                // depends on movement rules
<b class="nc">&nbsp;                Aero oa = (Aero) other;</b>
<b class="nc">&nbsp;                if (game.useVectorMove()) {</b>
&nbsp;                    // can you do equality with vectors?
<b class="nc">&nbsp;                    if (Compute.sameVectors(cmd.getFinalVectors(),</b>
<b class="nc">&nbsp;                                            oa.getVectors())) {</b>
<b class="nc">&nbsp;                        setJoinEnabled(true);</b>
<b class="nc">&nbsp;                        isGood = true;</b>
&nbsp;
&nbsp;                        // We&#39;re done looping now...
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else if (cmd.getFinalVelocity() == oa.getCurrentVelocity()) {</b>
<b class="nc">&nbsp;                    setJoinEnabled(true);</b>
<b class="nc">&nbsp;                    isGood = true;</b>
&nbsp;
&nbsp;                    // We&#39;re done looping now...
<b class="nc">&nbsp;                    break;</b>
&nbsp;                }
&nbsp;            }
&nbsp;            // Nope. Discard it.
<b class="nc">&nbsp;            other = null;</b>
<b class="nc">&nbsp;        } // Check the next entity in this position.</b>
<b class="nc">&nbsp;        if (!isGood) {</b>
<b class="nc">&nbsp;            setJoinEnabled(false);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the unit that the player wants to unload. This method will remove the
&nbsp;     * unit from our local copy of loaded units.
&nbsp;     *
&nbsp;     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
&nbsp;     * value will not be &lt;code&gt;null&lt;/code&gt;.
&nbsp;     */
&nbsp;    private TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; getLaunchedUnits() {
<b class="nc">&nbsp;        Entity ce = ce();</b>
<b class="nc">&nbsp;        TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; choices = new TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        Vector&lt;Entity&gt; launchableFighters = ce.getLaunchableFighters();</b>
<b class="nc">&nbsp;        Vector&lt;Entity&gt; launchableSmallCraft = ce.getLaunchableSmallCraft();</b>
<b class="nc">&nbsp;        Vector&lt;Entity&gt; launchableDropships = ce.getLaunchableDropships();</b>
&nbsp;
&nbsp;        // Handle error condition.
<b class="nc">&nbsp;        if ((launchableFighters.size() &lt;= 0)</b>
<b class="nc">&nbsp;            &amp;&amp; (launchableSmallCraft.size() &lt;= 0)</b>
<b class="nc">&nbsp;            &amp;&amp; (launchableDropships.size() &lt;= 0)) {</b>
<b class="nc">&nbsp;            System.err</b>
<b class="nc">&nbsp;                    .println(&quot;MovementDisplay#getLaunchedUnits() called without loaded units.&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            return choices;</b>
&nbsp;        }
&nbsp;
&nbsp;        // cycle through the fighter bays and then the small craft bays
<b class="nc">&nbsp;        int bayNum = 1;</b>
<b class="nc">&nbsp;        int i = 0;</b>
&nbsp;        Bay currentBay;
<b class="nc">&nbsp;        Vector&lt;Entity&gt; currentFighters = new Vector&lt;Entity&gt;();</b>
<b class="nc">&nbsp;        int doors = 0;</b>
<b class="nc">&nbsp;        Vector&lt;Bay&gt; FighterBays = ce.getFighterBays();</b>
<b class="nc">&nbsp;        for (i = 0; i &lt; FighterBays.size(); i++) {</b>
<b class="nc">&nbsp;            currentBay = FighterBays.elementAt(i);</b>
<b class="nc">&nbsp;            Vector&lt;Integer&gt; bayChoices = new Vector&lt;Integer&gt;();</b>
<b class="nc">&nbsp;            currentFighters = currentBay.getLaunchableUnits();</b>
&nbsp;            /*
&nbsp;             * We will assume that if more fighters are launched than is safe,
&nbsp;             * that these excess fighters will be distributed equally among
&nbsp;             * available doors
&nbsp;             */
<b class="nc">&nbsp;            doors = currentBay.getCurrentDoors();</b>
<b class="nc">&nbsp;            if (currentFighters.size() == 0) {</b>
<b class="nc">&nbsp;                bayNum++;</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            String[] names = new String[currentFighters.size()];</b>
<b class="nc">&nbsp;            String question = Messages</b>
<b class="nc">&nbsp;                    .getString(</b>
&nbsp;                            &quot;MovementDisplay.LaunchFighterDialog.message&quot;, new Object[]{ //$NON-NLS-1$
<b class="nc">&nbsp;                                                                                         ce.getShortName(), doors * 2, bayNum});</b>
<b class="nc">&nbsp;            for (int loop = 0; loop &lt; names.length; loop++) {</b>
<b class="nc">&nbsp;                names[loop] = currentFighters.elementAt(loop).getShortName();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            boolean doIt = false;</b>
<b class="nc">&nbsp;            ChoiceDialog choiceDialog = null;</b>
<b class="nc">&nbsp;            while (!doIt) {</b>
<b class="nc">&nbsp;                choiceDialog = new ChoiceDialog(</b>
&nbsp;                        clientgui.frame,
<b class="nc">&nbsp;                        Messages.getString(</b>
&nbsp;                                &quot;MovementDisplay.LaunchFighterDialog.title&quot;, new Object[]{ //$NON-NLS-1$
<b class="nc">&nbsp;                                                                                           currentBay.getType(), bayNum}), question,</b>
&nbsp;                        names);
<b class="nc">&nbsp;                choiceDialog.setVisible(true);</b>
<b class="nc">&nbsp;                if (choiceDialog.getChoices() == null) {</b>
<b class="nc">&nbsp;                    doIt = true;</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                int numChoices = choiceDialog.getChoices().length;</b>
<b class="nc">&nbsp;                if ((numChoices &gt; (doors * 2))</b>
<b class="nc">&nbsp;                    &amp;&amp; GUIPreferences.getInstance().getNagForLaunchDoors()) {</b>
<b class="nc">&nbsp;                    int aerosPerDoor = numChoices / doors;</b>
<b class="nc">&nbsp;                    int remainder = numChoices % doors;</b>
&nbsp;                    // Determine PSRs
<b class="nc">&nbsp;                    StringBuilder psrs = new StringBuilder();</b>
<b class="nc">&nbsp;                    for (int choice = 0; choice &lt; numChoices; choice++) {</b>
<b class="nc">&nbsp;                        int modifier = aerosPerDoor - 2;</b>
<b class="nc">&nbsp;                        if ((choice / aerosPerDoor) &gt;= (doors - 1)) {</b>
<b class="nc">&nbsp;                            modifier += remainder;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        modifier += currentFighters.get(choice).getCrew()</b>
<b class="nc">&nbsp;                                                   .getPiloting();</b>
<b class="nc">&nbsp;                        String damageMsg = Messages</b>
<b class="nc">&nbsp;                                .getString(</b>
&nbsp;                                        &quot;MovementDisplay.LaunchFighterDialog.controlroll&quot;,
&nbsp;                                        //$NON-NLS-1$
<b class="nc">&nbsp;                                        new Object[]{names[choice], modifier});</b>
<b class="nc">&nbsp;                        psrs.append(&quot;\t&quot; + damageMsg + &quot;\n&quot;);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</b>
<b class="nc">&nbsp;                                                          Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                                          Messages.getString(&quot;MovementDisplay.ConfirmLaunch&quot;)</b>
<b class="nc">&nbsp;                                                          + psrs.toString(), true);</b>
<b class="nc">&nbsp;                    nag.setVisible(true);</b>
<b class="nc">&nbsp;                    doIt = nag.getAnswer();</b>
<b class="nc">&nbsp;                    if (!nag.getShowAgain()) {</b>
<b class="nc">&nbsp;                        GUIPreferences.getInstance()</b>
<b class="nc">&nbsp;                                      .setNagForLaunchDoors(false);</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else {</b>
<b class="nc">&nbsp;                    doIt = true;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if ((choiceDialog.getAnswer() == true) &amp;&amp; doIt) {</b>
&nbsp;                // load up the choices
<b class="nc">&nbsp;                int[] unitsLaunched = choiceDialog.getChoices();</b>
<b class="nc">&nbsp;                for (int element : unitsLaunched) {</b>
<b class="nc">&nbsp;                    bayChoices.add(currentFighters.elementAt(element).getId());</b>
&nbsp;                    //Prompt the player to load passengers aboard small craft
<b class="nc">&nbsp;                    Entity en = clientgui.getClient().getGame().getEntity(currentFighters.elementAt(element).getId());</b>
<b class="nc">&nbsp;                    if (en instanceof SmallCraft) {</b>
<b class="nc">&nbsp;                        loadPassengerAtLaunch(en);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                choices.put(i, bayChoices);</b>
&nbsp;                // now remove them (must be a better way?)
<b class="nc">&nbsp;                for (int l = unitsLaunched.length; l &gt; 0; l--) {</b>
<b class="nc">&nbsp;                    currentFighters.remove(unitsLaunched[l - 1]);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            bayNum++;</b>
&nbsp;        }
<b class="nc">&nbsp;        return choices;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the unit that the player wants to unload. This method will remove the
&nbsp;     * unit from our local copy of loaded units.
&nbsp;     *
&nbsp;     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
&nbsp;     * value will not be &lt;code&gt;null&lt;/code&gt;.
&nbsp;     */
&nbsp;    private TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; getUndockedUnits() {
<b class="nc">&nbsp;        Entity ce = ce();</b>
<b class="nc">&nbsp;        TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; choices = new TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        Vector&lt;Entity&gt; launchableFighters = ce.getLaunchableFighters();</b>
<b class="nc">&nbsp;        Vector&lt;Entity&gt; launchableSmallCraft = ce.getLaunchableSmallCraft();</b>
<b class="nc">&nbsp;        Vector&lt;Entity&gt; launchableDropships = ce.getLaunchableDropships();</b>
&nbsp;
&nbsp;        // Handle error condition.
<b class="nc">&nbsp;        if ((launchableFighters.size() &lt;= 0)</b>
<b class="nc">&nbsp;            &amp;&amp; (launchableSmallCraft.size() &lt;= 0)</b>
<b class="nc">&nbsp;            &amp;&amp; (launchableDropships.size() &lt;= 0)) {</b>
<b class="nc">&nbsp;            System.err</b>
<b class="nc">&nbsp;                    .println(&quot;MovementDisplay#getUndockedUnits() called without loaded units.&quot;); //$NON-NLS-1$</b>
&nbsp;
&nbsp;        } else {
&nbsp;            // cycle through the docking collars
<b class="nc">&nbsp;            int i = 0;</b>
<b class="nc">&nbsp;            int collarNum = 1;</b>
<b class="nc">&nbsp;            Vector&lt;Entity&gt; currentDropships = new Vector&lt;Entity&gt;();</b>
<b class="nc">&nbsp;            for (DockingCollar collar : ce.getDockingCollars()) {</b>
<b class="nc">&nbsp;                currentDropships = collar.getLaunchableUnits();</b>
<b class="nc">&nbsp;                Vector&lt;Integer&gt; collarChoices = new Vector&lt;Integer&gt;();</b>
<b class="nc">&nbsp;                if (currentDropships.size() &gt; 0) {</b>
<b class="nc">&nbsp;                    String[] names = new String[currentDropships.size()];</b>
<b class="nc">&nbsp;                    String question = Messages</b>
<b class="nc">&nbsp;                            .getString(</b>
&nbsp;                                    &quot;MovementDisplay.LaunchDropshipDialog.message&quot;, new Object[]{ //$NON-NLS-1$
<b class="nc">&nbsp;                                                                                                  ce.getShortName(), 1, collarNum});</b>
<b class="nc">&nbsp;                    for (int loop = 0; loop &lt; names.length; loop++) {</b>
<b class="nc">&nbsp;                        names[loop] = currentDropships.elementAt(loop)</b>
<b class="nc">&nbsp;                                                      .getShortName();</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    boolean doIt = false;</b>
<b class="nc">&nbsp;                    ChoiceDialog choiceDialog = new ChoiceDialog(</b>
&nbsp;                            clientgui.frame,
<b class="nc">&nbsp;                            Messages.getString(</b>
&nbsp;                                    &quot;MovementDisplay.LaunchDropshipDialog.title&quot;, new Object[]{ //$NON-NLS-1$
<b class="nc">&nbsp;                                                                                                collar.getType(), collarNum}), question,</b>
&nbsp;                            names);
<b class="nc">&nbsp;                    while (!doIt) {</b>
<b class="nc">&nbsp;                        choiceDialog = new ChoiceDialog(</b>
&nbsp;                                clientgui.frame,
<b class="nc">&nbsp;                                Messages.getString(</b>
&nbsp;                                        &quot;MovementDisplay.LaunchDropshipDialog.title&quot;,
&nbsp;                                        new Object[]{ //$NON-NLS-1$
<b class="nc">&nbsp;                                                      collar.getType(), collarNum}),</b>
&nbsp;                                question, names);
<b class="nc">&nbsp;                        choiceDialog.setVisible(true);</b>
<b class="nc">&nbsp;                        if ((choiceDialog.getChoices() != null)</b>
<b class="nc">&nbsp;                            &amp;&amp; (choiceDialog.getChoices().length &gt; (1))) {</b>
<b class="nc">&nbsp;                            ConfirmDialog nag = new ConfirmDialog(</b>
&nbsp;                                    clientgui.frame,
<b class="nc">&nbsp;                                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                    Messages.getString(&quot;MovementDisplay.ConfirmLaunch&quot;),</b>
&nbsp;                                    true);
<b class="nc">&nbsp;                            nag.setVisible(true);</b>
<b class="nc">&nbsp;                            doIt = nag.getAnswer();</b>
<b class="nc">&nbsp;                        } else {</b>
<b class="nc">&nbsp;                            doIt = true;</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    if ((choiceDialog.getAnswer() == true) &amp;&amp; doIt) {</b>
&nbsp;                        // load up the choices
<b class="nc">&nbsp;                        int[] unitsLaunched = choiceDialog.getChoices();</b>
<b class="nc">&nbsp;                        for (int element : unitsLaunched) {</b>
<b class="nc">&nbsp;                            collarChoices.add(currentDropships.elementAt(</b>
<b class="nc">&nbsp;                                    element).getId());</b>
&nbsp;                            //Prompt the player to load passengers aboard the launching ship(s)
<b class="nc">&nbsp;                            Entity en = clientgui.getClient().getGame().getEntity(currentDropships.elementAt(element).getId());</b>
<b class="nc">&nbsp;                            if (en instanceof SmallCraft) {</b>
<b class="nc">&nbsp;                                loadPassengerAtLaunch(en);</b>
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                        choices.put(i, collarChoices);</b>
&nbsp;                        // now remove them (must be a better way?)
<b class="nc">&nbsp;                        for (int l = unitsLaunched.length; l &gt; 0; l--) {</b>
<b class="nc">&nbsp;                            currentDropships.remove(unitsLaunched[l - 1]);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                collarNum++;</b>
<b class="nc">&nbsp;                i++;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }// End have-choices
&nbsp;        // Return the chosen unit.
<b class="nc">&nbsp;        return choices;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Worker function that consolidates code for loading dropships/small craft with passengers
&nbsp;     * 
&nbsp;     * @param en - The launching entity, which has already been tested to see if it&#39;s a small craft
&nbsp;     */
&nbsp;     private void loadPassengerAtLaunch(Entity en) {
<b class="nc">&nbsp;         SmallCraft craft = (SmallCraft) en;</b>
<b class="nc">&nbsp;         int space = 0;</b>
<b class="nc">&nbsp;         for (Bay b : craft.getTransportBays()) {</b>
<b class="nc">&nbsp;             if (b instanceof CargoBay || b instanceof InfantryBay || b instanceof BattleArmorBay) {</b>
&nbsp;                 // Assume a passenger takes up 0.1 tons per single infantryman weight calculations
<b class="nc">&nbsp;                 space += (b.getUnused() / 0.1);</b>
&nbsp;             }
<b class="nc">&nbsp;         }</b>
&nbsp;         //Passengers don&#39;t actually &#39;load&#39; into bays to consume space, so update what&#39;s available for anyone
&nbsp;         //already aboard
<b class="nc">&nbsp;         space -= ((craft.getTotalOtherCrew() + craft.getTotalPassengers()) * 0.1);</b>
&nbsp;         //Make sure the text displays either the carrying capacity or the number of passengers left aboard
<b class="nc">&nbsp;         space = Math.min(space, ce().getNPassenger());</b>
<b class="nc">&nbsp;         ConfirmDialog takePassenger = new ConfirmDialog(clientgui.frame,</b>
<b class="nc">&nbsp;                 Messages.getString(&quot;MovementDisplay.FillSmallCraftPassengerDialog.Title&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                 Messages.getString(&quot;MovementDisplay.FillSmallCraftPassengerDialog.message&quot;,</b>
<b class="nc">&nbsp;                         new Object[]{craft.getShortName(), space, ce().getShortName() + &quot;&#39;&quot;, ce().getNPassenger()}), false);</b>
<b class="nc">&nbsp;         takePassenger.setVisible(true);</b>
<b class="nc">&nbsp;         if (takePassenger.getAnswer()) {</b>
&nbsp;             //Move the passengers
<b class="nc">&nbsp;             ce().setNPassenger(ce().getNPassenger() - space);</b>
<b class="nc">&nbsp;             if (ce() instanceof Aero) {</b>
<b class="nc">&nbsp;                 ((Aero)ce()).addEscapeCraft(craft.getExternalIdAsString());</b>
&nbsp;             }
<b class="nc">&nbsp;             clientgui.getClient().sendUpdateEntity(ce());</b>
<b class="nc">&nbsp;             craft.addPassengers(ce().getExternalIdAsString(), space);</b>
<b class="nc">&nbsp;             clientgui.getClient().sendUpdateEntity(craft);</b>
&nbsp;         }
&nbsp;     }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the unit that the player wants to drop. This method will remove the
&nbsp;     * unit from our local copy of loaded units.
&nbsp;     *
&nbsp;     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
&nbsp;     * value will not be &lt;code&gt;null&lt;/code&gt;.
&nbsp;     */
&nbsp;    private TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; getDroppedUnits() {
<b class="nc">&nbsp;        Entity ce = ce();</b>
<b class="nc">&nbsp;        TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; choices = new TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        Vector&lt;Entity&gt; droppableUnits = ce.getDroppableUnits();</b>
<b class="nc">&nbsp;        Set&lt;Integer&gt; alreadyDropped = cmd.getDroppedUnits();</b>
&nbsp;
&nbsp;        // Handle error condition.
<b class="nc">&nbsp;        if (droppableUnits.size() &lt;= 0) {</b>
<b class="nc">&nbsp;            System.err</b>
<b class="nc">&nbsp;                    .println(&quot;MovementDisplay#getDroppedUnits() called without loaded units.&quot;); //$NON-NLS-1$</b>
&nbsp;
&nbsp;        } else {
&nbsp;            // cycle through the bays
<b class="nc">&nbsp;            int bayNum = 1;</b>
&nbsp;            Bay currentBay;
<b class="nc">&nbsp;            List&lt;Entity&gt; currentUnits = new ArrayList&lt;Entity&gt;();</b>
<b class="nc">&nbsp;            int doors = 0;</b>
<b class="nc">&nbsp;            Vector&lt;Bay&gt; Bays = ce.getTransportBays();</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; Bays.size(); i++) {</b>
<b class="nc">&nbsp;                currentBay = Bays.elementAt(i);</b>
<b class="nc">&nbsp;                Vector&lt;Integer&gt; bayChoices = new Vector&lt;Integer&gt;();</b>
<b class="nc">&nbsp;                currentUnits = currentBay.getDroppableUnits().stream()</b>
<b class="nc">&nbsp;                        .filter(e -&gt; !alreadyDropped.contains(e.getId()))</b>
<b class="nc">&nbsp;                        .collect(Collectors.toList());</b>
&nbsp;
<b class="nc">&nbsp;                doors = currentBay.getCurrentDoors();</b>
<b class="nc">&nbsp;                if ((currentUnits.size() &gt; 0) &amp;&amp; (doors &gt; 0)) {</b>
<b class="nc">&nbsp;                    String[] names = new String[currentUnits.size()];</b>
<b class="nc">&nbsp;                    String question = Messages</b>
<b class="nc">&nbsp;                            .getString(</b>
&nbsp;                                    &quot;MovementDisplay.DropUnitDialog.message&quot;, new Object[]{ //$NON-NLS-1$
<b class="nc">&nbsp;                                                                                            doors, bayNum});</b>
<b class="nc">&nbsp;                    for (int loop = 0; loop &lt; names.length; loop++) {</b>
<b class="nc">&nbsp;                        names[loop] = currentUnits.get(loop)</b>
<b class="nc">&nbsp;                                                  .getShortName();</b>
&nbsp;                    }
<b class="nc">&nbsp;                    ChoiceDialog choiceDialog = new ChoiceDialog(</b>
&nbsp;                            clientgui.frame,
<b class="nc">&nbsp;                            Messages.getString(</b>
&nbsp;                                    &quot;MovementDisplay.DropUnitDialog.title&quot;, new Object[]{ //$NON-NLS-1$
<b class="nc">&nbsp;                                                                                          currentBay.getType(), bayNum}), question,</b>
&nbsp;                            names, false, doors);
<b class="nc">&nbsp;                    choiceDialog.setVisible(true);</b>
<b class="nc">&nbsp;                    if (choiceDialog.getAnswer() == true) {</b>
&nbsp;                        // load up the choices
<b class="nc">&nbsp;                        int[] unitsLaunched = choiceDialog.getChoices();</b>
<b class="nc">&nbsp;                        for (int element : unitsLaunched) {</b>
<b class="nc">&nbsp;                            bayChoices.add(currentUnits.get(element)</b>
<b class="nc">&nbsp;                                                       .getId());</b>
&nbsp;                        }
<b class="nc">&nbsp;                        choices.put(i, bayChoices);</b>
&nbsp;                        // now remove them (must be a better way?)
<b class="nc">&nbsp;                        for (int l = unitsLaunched.length; l &gt; 0; l--) {</b>
<b class="nc">&nbsp;                            currentUnits.remove(unitsLaunched[l - 1]);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                bayNum++;</b>
&nbsp;            }
&nbsp;        }// End have-choices
&nbsp;        // Return the chosen unit.
<b class="nc">&nbsp;        return choices;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * get the unit id that the player wants to be recovered by
&nbsp;     */
&nbsp;    private int getRecoveryUnit() {
<b class="nc">&nbsp;        final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        List&lt;Entity&gt; choices = new ArrayList&lt;Entity&gt;();</b>
&nbsp;
&nbsp;        // collect all possible choices
<b class="nc">&nbsp;        Coords loadeePos = cmd.getFinalCoords();</b>
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().useVectorMove()) {</b>
&nbsp;            // not where you are, but where you will be
<b class="nc">&nbsp;            loadeePos = Compute.getFinalPosition(ce.getPosition(),</b>
<b class="nc">&nbsp;                                                 cmd.getFinalVectors());</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Entity other : game.getEntitiesVector(loadeePos)) {</b>
&nbsp;            // Is the other unit friendly and not the current entity?
&nbsp;            // must be done with its movement
&nbsp;            // it also must be same heading and velocity
<b class="nc">&nbsp;            if ((other instanceof Aero) &amp;&amp; !((Aero) other).isOutControlTotal()</b>
<b class="nc">&nbsp;                &amp;&amp; other.isDone() &amp;&amp; other.canLoad(ce)</b>
<b class="nc">&nbsp;                &amp;&amp; ce.isLoadableThisTurn()</b>
<b class="nc">&nbsp;                &amp;&amp; (cmd.getFinalFacing() == other.getFacing())) {</b>
&nbsp;
&nbsp;                // now lets check velocity
&nbsp;                // depends on movement rules
<b class="nc">&nbsp;                Aero oa = (Aero) other;</b>
<b class="nc">&nbsp;                if (clientgui.getClient().getGame().useVectorMove()) {</b>
<b class="nc">&nbsp;                    if (Compute.sameVectors(cmd.getFinalVectors(),</b>
<b class="nc">&nbsp;                                            oa.getVectors())) {</b>
<b class="nc">&nbsp;                        choices.add(other);</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else if (cmd.getFinalVelocity() == oa.getCurrentVelocity()) {</b>
<b class="nc">&nbsp;                    choices.add(other);</b>
&nbsp;                }
&nbsp;            }
&nbsp;            // Nope. Discard it.
<b class="nc">&nbsp;            other = null;</b>
<b class="nc">&nbsp;        } // Check the next entity in this position.</b>
&nbsp;
<b class="nc">&nbsp;        if (choices.size() &lt; 1) {</b>
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (choices.size() == 1) {</b>
<b class="nc">&nbsp;            if (choices.get(0).mpUsed &gt; 0) {</b>
<b class="nc">&nbsp;                if (clientgui</b>
<b class="nc">&nbsp;                        .doYesNoDialog(</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.RecoverSureDialog.title&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.RecoverSureDialog.message&quot;) //$NON-NLS-1$</b>
&nbsp;                                      )) {
<b class="nc">&nbsp;                    return choices.get(0).getId();</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                return choices.get(0).getId();</b>
&nbsp;            }
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        String input = (String) JOptionPane</b>
<b class="nc">&nbsp;                .showInputDialog(</b>
&nbsp;                        clientgui,
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.RecoverFighterDialog.message&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.RecoverFighterDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                        JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<b class="nc">&nbsp;                                .getDisplayArray(choices), null);</b>
<b class="nc">&nbsp;        Entity picked = (Entity) SharedUtility.getTargetPicked(choices, input);</b>
&nbsp;
<b class="nc">&nbsp;        if (picked != null) {</b>
&nbsp;            // if this unit is thrusting, make sure they are aware
<b class="nc">&nbsp;            if (picked.mpUsed &gt; 0) {</b>
<b class="nc">&nbsp;                if (clientgui</b>
<b class="nc">&nbsp;                        .doYesNoDialog(</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.RecoverSureDialog.title&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.RecoverSureDialog.message&quot;) //$NON-NLS-1$</b>
&nbsp;                                      )) {
<b class="nc">&nbsp;                    return picked.getId();</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                return picked.getId();</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return -1;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return the unit id that the player wants to join
&nbsp;     */
&nbsp;    private int getUnitJoined() {
<b class="nc">&nbsp;        final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        List&lt;Entity&gt; choices = new ArrayList&lt;Entity&gt;();</b>
&nbsp;
&nbsp;        // collect all possible choices
<b class="nc">&nbsp;        Coords loadeePos = cmd.getFinalCoords();</b>
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().useVectorMove()) {</b>
&nbsp;            // not where you are, but where you will be
<b class="nc">&nbsp;            loadeePos = Compute.getFinalPosition(ce.getPosition(),</b>
<b class="nc">&nbsp;                                                 cmd.getFinalVectors());</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Entity other : game.getEntitiesVector(loadeePos)) {</b>
&nbsp;            // Is the other unit friendly and not the current entity?
&nbsp;            // must be done with its movement
&nbsp;            // it also must be same heading and velocity
<b class="nc">&nbsp;            if ((other instanceof Aero) &amp;&amp; !((Aero) other).isOutControlTotal()</b>
<b class="nc">&nbsp;                &amp;&amp; other.isDone() &amp;&amp; other.canLoad(ce)</b>
<b class="nc">&nbsp;                &amp;&amp; ce.isLoadableThisTurn()</b>
<b class="nc">&nbsp;                &amp;&amp; (cmd.getFinalFacing() == other.getFacing())) {</b>
&nbsp;
&nbsp;                // now lets check velocity
&nbsp;                // depends on movement rules
<b class="nc">&nbsp;                Aero oa = (Aero) other;</b>
<b class="nc">&nbsp;                if (clientgui.getClient().getGame().useVectorMove()) {</b>
<b class="nc">&nbsp;                    if (Compute.sameVectors(cmd.getFinalVectors(),</b>
<b class="nc">&nbsp;                                            oa.getVectors())) {</b>
<b class="nc">&nbsp;                        choices.add(other);</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else if (cmd.getFinalVelocity() == oa.getCurrentVelocity()) {</b>
<b class="nc">&nbsp;                    choices.add(other);</b>
&nbsp;                }
&nbsp;            }
&nbsp;            // Nope. Discard it.
<b class="nc">&nbsp;            other = null;</b>
<b class="nc">&nbsp;        } // Check the next entity in this position.</b>
&nbsp;
<b class="nc">&nbsp;        if (choices.size() &lt; 1) {</b>
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (choices.size() == 1) {</b>
<b class="nc">&nbsp;            return choices.get(0).getId();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        String input = (String) JOptionPane.showInputDialog(</b>
&nbsp;                clientgui,
<b class="nc">&nbsp;                Messages.getString(&quot;MovementDisplay.JoinSquadronDialog&quot;</b>
&nbsp;                                   + &quot;.message&quot;), //$NON-NLS-1$
<b class="nc">&nbsp;                Messages.getString(&quot;MovementDisplay.JoinSquadronDialog&quot;</b>
&nbsp;                                   + &quot;.title&quot;), //$NON-NLS-1$
&nbsp;                JOptionPane.QUESTION_MESSAGE, null,
<b class="nc">&nbsp;                SharedUtility.getDisplayArray(choices), null);</b>
<b class="nc">&nbsp;        Entity picked = (Entity) SharedUtility.getTargetPicked(choices, input);</b>
<b class="nc">&nbsp;        if (picked != null) {</b>
<b class="nc">&nbsp;            return picked.getId();</b>
&nbsp;        }
<b class="nc">&nbsp;        return -1;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * check for out of control and adjust buttons
&nbsp;     */
&nbsp;    private void checkOOC() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.isAero()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        IAero a = (IAero) ce;</b>
&nbsp;
<b class="nc">&nbsp;        if (a.isOutControlTotal() &amp;&amp; a.isAirborne()) {</b>
<b class="nc">&nbsp;            disableButtons();</b>
<b class="nc">&nbsp;            butDone.setEnabled(true);</b>
<b class="nc">&nbsp;            if (numButtonGroups &gt; 1)</b>
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_MORE).setEnabled(true);</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_NEXT).setEnabled(true);</b>
<b class="nc">&nbsp;            setForwardIniEnabled(true);</b>
<b class="nc">&nbsp;            if (ce instanceof Aero) {</b>
<b class="nc">&nbsp;                setLaunchEnabled((((Aero)ce).getLaunchableFighters().size() &gt; 0)</b>
<b class="nc">&nbsp;                        || (((Aero)ce).getLaunchableSmallCraft().size() &gt; 0)</b>
<b class="nc">&nbsp;                        || (((Aero)ce).getLaunchableDropships().size() &gt; 0));</b>
&nbsp;            }
&nbsp;        }
&nbsp;        return;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * check for fuel and adjust buttons
&nbsp;     */
&nbsp;    private void checkFuel() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.isAero()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        IAero a = (IAero) ce;</b>
<b class="nc">&nbsp;        if (a.getCurrentFuel() &lt; 1) {</b>
<b class="nc">&nbsp;            disableButtons();</b>
<b class="nc">&nbsp;            butDone.setEnabled(true);</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_NEXT).setEnabled(true);</b>
<b class="nc">&nbsp;            setForwardIniEnabled(true);</b>
<b class="nc">&nbsp;            if (ce instanceof Aero) {</b>
<b class="nc">&nbsp;                setLaunchEnabled((((Aero)ce).getLaunchableFighters().size() &gt; 0)</b>
<b class="nc">&nbsp;                        || (((Aero)ce).getLaunchableSmallCraft().size() &gt; 0)</b>
<b class="nc">&nbsp;                        || (((Aero)ce).getLaunchableDropships().size() &gt; 0));</b>
&nbsp;            }
<b class="nc">&nbsp;            updateRACButton();</b>
<b class="nc">&nbsp;            updateJoinButton();</b>
<b class="nc">&nbsp;            updateRecoveryButton();</b>
<b class="nc">&nbsp;            updateDumpButton();</b>
&nbsp;        }
&nbsp;        return;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * check for atmosphere and adjust buttons
&nbsp;     */
&nbsp;    private void checkAtmosphere() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!ce.isAero()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        IAero a = (IAero) ce;</b>
<b class="nc">&nbsp;        if (!clientgui.getClient().getGame().getBoard().inSpace()) {</b>
<b class="nc">&nbsp;            if (a.isSpheroid()</b>
<b class="nc">&nbsp;                || clientgui.getClient().getGame().getPlanetaryConditions()</b>
<b class="nc">&nbsp;                            .isVacuum()) {</b>
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_ACC).setEnabled(false);</b>
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_DEC).setEnabled(false);</b>
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_ACCN).setEnabled(false);</b>
<b class="nc">&nbsp;                getBtn(MoveCommand.MOVE_DECN).setEnabled(false);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        return;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Have the player select a target from the entities at the given coords.
&nbsp;     *
&nbsp;     * @param pos - the &lt;code&gt;Coords&lt;/code&gt; containing targets.
&nbsp;     */
&nbsp;    private Targetable chooseTarget(Coords pos) {
<b class="nc">&nbsp;        final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
&nbsp;        // Assume that we have *no* choice.
<b class="nc">&nbsp;        Targetable choice = null;</b>
&nbsp;
&nbsp;        // Get the available choices.
&nbsp;
&nbsp;        // Convert the choices into a List of targets.
<b class="nc">&nbsp;        ArrayList&lt;Targetable&gt; targets = new ArrayList&lt;Targetable&gt;();</b>
<b class="nc">&nbsp;        for (Entity ent : game.getEntitiesVector(pos)) {</b>
<b class="nc">&nbsp;            if ((ce == null) || !ce.equals(ent)) {</b>
<b class="nc">&nbsp;                targets.add(ent);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // Is there a building in the hex?
<b class="nc">&nbsp;        Building bldg = clientgui.getClient().getGame().getBoard()</b>
<b class="nc">&nbsp;                                 .getBuildingAt(pos);</b>
<b class="nc">&nbsp;        if (bldg != null) {</b>
<b class="nc">&nbsp;            targets.add(new BuildingTarget(pos, clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                                                         .getBoard(), false));</b>
&nbsp;        }
&nbsp;
&nbsp;        // Do we have a single choice?
<b class="nc">&nbsp;        if (targets.size() == 1) {</b>
&nbsp;            // Return that choice.
<b class="nc">&nbsp;            choice = targets.get(0);</b>
&nbsp;        }
&nbsp;
&nbsp;        // If we have multiple choices, display a selection dialog.
<b class="nc">&nbsp;        else if (targets.size() &gt; 1) {</b>
<b class="nc">&nbsp;            String input = (String) JOptionPane</b>
<b class="nc">&nbsp;                    .showInputDialog(</b>
&nbsp;                            clientgui,
<b class="nc">&nbsp;                            Messages.getString(</b>
&nbsp;                                    &quot;MovementDisplay.ChooseTargetDialog.message&quot;, new Object[]{//$NON-NLS-1$
<b class="nc">&nbsp;                                                                                               pos.getBoardNum()}),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.ChooseTargetDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<b class="nc">&nbsp;                                    .getDisplayArray(targets), null);</b>
<b class="nc">&nbsp;            choice = SharedUtility.getTargetPicked(targets, input);</b>
&nbsp;        } // End have-choices
&nbsp;
&nbsp;        // Return the chosen unit.
<b class="nc">&nbsp;        return choice;</b>
&nbsp;    } // End private Targetable chooseTarget( Coords )
&nbsp;
&nbsp;    private int chooseMineToLay() {
<b class="nc">&nbsp;        MineLayingDialog mld = new MineLayingDialog(clientgui.frame, ce());</b>
<b class="nc">&nbsp;        mld.setVisible(true);</b>
<b class="nc">&nbsp;        if (mld.getAnswer()) {</b>
<b class="nc">&nbsp;            return mld.getMine();</b>
&nbsp;        }
<b class="nc">&nbsp;        return -1;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void dumpBombs() {
&nbsp;
<b class="nc">&nbsp;        if (!ce().isAero()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        EntityMovementType overallMoveType = EntityMovementType.MOVE_NONE;</b>
<b class="nc">&nbsp;        if (null != cmd) {</b>
<b class="nc">&nbsp;            overallMoveType = cmd.getLastStepMovementType();</b>
&nbsp;        }
&nbsp;        // bring up dialog to dump bombs, then make a control roll and report
&nbsp;        // success or failure
&nbsp;        // should update mp available
<b class="nc">&nbsp;        int numFighters = ce().getActiveSubEntities().orElse(Collections.emptyList()).size();</b>
<b class="nc">&nbsp;        BombPayloadDialog dumpBombsDialog = new BombPayloadDialog(</b>
&nbsp;                clientgui.frame,
<b class="nc">&nbsp;                Messages.getString(&quot;MovementDisplay.BombDumpDialog.title&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                ce().getBombLoadout(), false, true, -1, numFighters);</b>
<b class="nc">&nbsp;        dumpBombsDialog.setVisible(true);</b>
<b class="nc">&nbsp;        if (dumpBombsDialog.getAnswer()) {</b>
&nbsp;            // int[] bombsDumped =
<b class="nc">&nbsp;            dumpBombsDialog.getChoices();</b>
&nbsp;            // first make a control roll
<b class="nc">&nbsp;            PilotingRollData psr = ce().getBasePilotingRoll(overallMoveType);</b>
<b class="nc">&nbsp;            int ctrlroll = Compute.d6(2);</b>
<b class="nc">&nbsp;            Report r = new Report(9500);</b>
<b class="nc">&nbsp;            r.subject = ce().getId();</b>
<b class="nc">&nbsp;            r.add(ce().getDisplayName());</b>
<b class="nc">&nbsp;            r.add(psr.getValue());</b>
<b class="nc">&nbsp;            r.add(ctrlroll);</b>
<b class="nc">&nbsp;            r.newlines = 0;</b>
<b class="nc">&nbsp;            r.indent(1);</b>
<b class="nc">&nbsp;            if (ctrlroll &lt; psr.getValue()) {</b>
<b class="nc">&nbsp;                r.choose(false);</b>
&nbsp;                // addReport(r);
<b class="nc">&nbsp;                String title = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.DumpingBombs.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                String body = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.DumpFailure.message&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(title, body);</b>
&nbsp;                // failed the roll, so dump all bombs
&nbsp;                // bombsDumped =
<b class="nc">&nbsp;                ce().getBombLoadout();</b>
<b class="nc">&nbsp;            } else {</b>
&nbsp;                // avoided damage
<b class="nc">&nbsp;                r.choose(true);</b>
<b class="nc">&nbsp;                String title = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.DumpingBombs.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                String body = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.DumpSuccessful.message&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(title, body);</b>
&nbsp;                // addReport(r);
&nbsp;            }
&nbsp;            /*
&nbsp;             * // now unload the bombs for (int j = 0; j &lt; bombsDumped.length;
&nbsp;             * j++) { if (bombsDumped[j] &gt; 0) { a.removeBombs(bombsDumped[j],
&nbsp;             * j); // Report r = new Report(5115); r.subject = ce().getId();
&nbsp;             * r.addDesc(ce()); r.add(&quot;&quot; + bombsDumped[j] + &quot; &quot; +
&nbsp;             * Aero.bombNames[j] + &quot;(s)&quot;); // addReport(r); } } // update the
&nbsp;             * bomb load immediately a.updateBombLoad();
&nbsp;             * clientgui.getClient().sendUpdateEntity(ce());
&nbsp;             */
&nbsp;            // not sure how to update mech display, but everything else is
&nbsp;            // working
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * based on maneuver type add the appropriate steps return true if we should
&nbsp;     * redraw the movement data
&nbsp;     */
&nbsp;    private boolean addManeuver(int type) {
<b class="nc">&nbsp;        cmd.addManeuver(type);</b>
<b class="nc">&nbsp;        switch (type) {</b>
&nbsp;            case (ManeuverType.MAN_HAMMERHEAD):
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.YAW, true, true);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            case (ManeuverType.MAN_HALF_ROLL):
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.ROLL, true, true);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            case (ManeuverType.MAN_BARREL_ROLL):
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.DEC, true, true);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            case (ManeuverType.MAN_IMMELMAN):
<b class="nc">&nbsp;                gear = MovementDisplay.GEAR_IMMEL;</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            case (ManeuverType.MAN_SPLIT_S):
<b class="nc">&nbsp;                gear = MovementDisplay.GEAR_SPLIT_S;</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            case (ManeuverType.MAN_VIFF):
<b class="nc">&nbsp;                if (!ce().isAero()) {</b>
<b class="nc">&nbsp;                    return false;</b>
&nbsp;                }
<b class="nc">&nbsp;                IAero a = (IAero) ce();</b>
<b class="nc">&nbsp;                MoveStep last = cmd.getLastStep();</b>
<b class="nc">&nbsp;                int vel = a.getCurrentVelocity();</b>
<b class="nc">&nbsp;                if (null != last) {</b>
<b class="nc">&nbsp;                    vel = last.getVelocityLeft();</b>
&nbsp;                }
<b class="nc">&nbsp;                while (vel &gt; 0) {</b>
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.DEC, true, true);</b>
<b class="nc">&nbsp;                    vel--;</b>
&nbsp;                }
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.UP);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            case (ManeuverType.MAN_SIDE_SLIP_LEFT):
&nbsp;                // If we are on a ground map, slide slip works slightly
&nbsp;                // differently
&nbsp;                // See Total Warfare pg 85
<b class="nc">&nbsp;                if (clientgui.getClient().getGame().getBoard().getType() == Board.T_GROUND) {</b>
<b class="nc">&nbsp;                    for (int i = 0; i &lt; 8; i++) {</b>
<b class="nc">&nbsp;                        cmd.addStep(MoveStepType.LATERAL_LEFT, true, true);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    for (int i = 0; i &lt; 8; i++) {</b>
<b class="nc">&nbsp;                        cmd.addStep(MoveStepType.FORWARDS, true, true);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.LATERAL_LEFT, true, true);</b>
&nbsp;                }
<b class="nc">&nbsp;                return true;</b>
&nbsp;            case (ManeuverType.MAN_SIDE_SLIP_RIGHT):
&nbsp;                // If we are on a ground map, slide slip works slightly
&nbsp;                // differently
&nbsp;                // See Total Warfare pg 85
<b class="nc">&nbsp;                if (clientgui.getClient().getGame().getBoard().getType() == Board.T_GROUND) {</b>
<b class="nc">&nbsp;                    for (int i = 0; i &lt; 8; i++) {</b>
<b class="nc">&nbsp;                        cmd.addStep(MoveStepType.LATERAL_RIGHT, true, true);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    for (int i = 0; i &lt; 8; i++) {</b>
<b class="nc">&nbsp;                        cmd.addStep(MoveStepType.FORWARDS, true, true);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.LATERAL_RIGHT, true, true);</b>
&nbsp;                }
<b class="nc">&nbsp;                return true;</b>
&nbsp;            case (ManeuverType.MAN_LOOP):
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.LOOP, true, true);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            default:
<b class="nc">&nbsp;                return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    //
&nbsp;    // GameListener
&nbsp;    //
&nbsp;    @Override
&nbsp;    public void gameTurnChange(GameTurnChangeEvent e) {
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        // On simultaneous phases, each player ending their turn will generalte a turn change
&nbsp;        // We want to ignore turns from other players and only listen to events we generated
&nbsp;        // Except on the first turn
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().isPhaseSimultaneous()</b>
<b class="nc">&nbsp;                &amp;&amp; (e.getPreviousPlayerId() != clientgui.getClient().getLocalPlayerNumber())</b>
<b class="nc">&nbsp;                &amp;&amp; (clientgui.getClient().getGame().getTurnIndex() != 0)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getPhase() != IGame.Phase.PHASE_MOVEMENT) {</b>
&nbsp;            // ignore
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (clientgui.getClient().isMyTurn()) {</b>
&nbsp;            // Can the player unload entities stranded on immobile transports?
<b class="nc">&nbsp;            if (clientgui.getClient().canUnloadStranded()) {</b>
<b class="nc">&nbsp;                unloadStranded();</b>
<b class="nc">&nbsp;            } else if (cen == Entity.NONE) {</b>
<b class="nc">&nbsp;                beginMyTurn();</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            endMyTurn();</b>
<b class="nc">&nbsp;            if ((e.getPlayer() == null)</b>
<b class="nc">&nbsp;                    &amp;&amp; (clientgui.getClient().getGame().getTurn() instanceof GameTurn.UnloadStrandedTurn)) {</b>
<b class="nc">&nbsp;                setStatusBarText(Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.waitForAnother&quot;)); //$NON-NLS-1$</b>
&nbsp;            } else {
&nbsp;                String playerName;
<b class="nc">&nbsp;                if (e.getPlayer() != null) {</b>
<b class="nc">&nbsp;                    playerName = e.getPlayer().getName();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    playerName = &quot;Unknown&quot;;</b>
&nbsp;                }
<b class="nc">&nbsp;                setStatusBarText(Messages.getString(</b>
&nbsp;                        &quot;MovementDisplay.its_others_turn&quot;, //$NON-NLS-1$
&nbsp;                        new Object[] { playerName }));
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void gamePhaseChange(GamePhaseChangeEvent e) {
&nbsp;        // In case of a /reset command, ensure the state gets reset
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getPhase() </b>
&nbsp;                == IGame.Phase.PHASE_LOUNGE) {
<b class="nc">&nbsp;            endMyTurn();</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (clientgui.getClient().isMyTurn()</b>
<b class="nc">&nbsp;            &amp;&amp; (clientgui.getClient().getGame().getPhase() != IGame.Phase.PHASE_MOVEMENT)) {</b>
<b class="nc">&nbsp;            endMyTurn();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getPhase() == IGame.Phase.PHASE_MOVEMENT) {</b>
<b class="nc">&nbsp;            setStatusBarText(Messages</b>
<b class="nc">&nbsp;                                     .getString(&quot;MovementDisplay.waitingForMovementPhase&quot;)); //$NON-NLS-1$</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Computes all of the possible moves for an Entity in a particular gear.
&nbsp;     * The Entity can either be a suggested Entity or the currently selected 
&nbsp;     * one.  If there is a selected entity (which implies it&#39;s the current 
&nbsp;     * players turn), then the current gear is used (which is set by the user).
&nbsp;     * If there is no selected entity, then the current gear is invalid, and it
&nbsp;     * defaults to GEAR_LAND (standard &quot;walk forward&quot;).
&nbsp;     * 
&nbsp;     * @param suggestion  The suggested Entity to use to compute the movement
&nbsp;     *                      envelope.  If used, the gear will be set to 
&nbsp;     *                      GEAR_LAND.  This takes precendence over the
&nbsp;     *                      currently selected unit. 
&nbsp;     * @param suggestion
&nbsp;     */
&nbsp;    public void computeMovementEnvelope(Entity suggestion) {
&nbsp;        // do nothing if deactivated in the settings
<b class="nc">&nbsp;        if (!GUIPreferences.getInstance()</b>
<b class="nc">&nbsp;                .getBoolean(GUIPreferences.MOVE_ENVELOPE)) {</b>
<b class="nc">&nbsp;            clientgui.bv.clearMovementEnvelope();</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        Entity en = ce();</b>
<b class="nc">&nbsp;        int mvMode = gear;</b>
<b class="nc">&nbsp;        if ((en == null) &amp;&amp; (suggestion == null)) {</b>
&nbsp;            return;
<b class="nc">&nbsp;        } else if (en == null) {</b>
<b class="nc">&nbsp;            en = suggestion;</b>
<b class="nc">&nbsp;            mvMode = GEAR_LAND;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            en = suggestion;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (en.isDone()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        Map&lt;Coords, MovePath&gt; mvEnvData = new HashMap&lt;Coords, MovePath&gt;();</b>
<b class="nc">&nbsp;        MovePath mp = new MovePath(clientgui.getClient().getGame(), en);</b>
&nbsp;
&nbsp;        int maxMP;
<b class="nc">&nbsp;        if (mvMode == GEAR_JUMP || mvMode == GEAR_DFA) {</b>
<b class="nc">&nbsp;            maxMP = en.getJumpMP();</b>
<b class="nc">&nbsp;        } else if (mvMode == GEAR_BACKUP) {</b>
<b class="nc">&nbsp;            maxMP = en.getWalkMP();</b>
<b class="nc">&nbsp;        } else if (ce() instanceof Mech &amp;&amp; !(ce() instanceof QuadVee)</b>
<b class="nc">&nbsp;                &amp;&amp; ce().getMovementMode() == EntityMovementMode.TRACKED) {</b>
&nbsp;            //A non-QuadVee &#39;Mech that is using tracked movement is limited to walking
<b class="nc">&nbsp;            maxMP = en.getWalkMP();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            if (clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                         .booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_SPRINT)) {</b>
<b class="nc">&nbsp;                maxMP = en.getSprintMP();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                maxMP = en.getRunMP();</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        MoveStepType stepType = (mvMode == GEAR_BACKUP) ? MoveStepType.BACKWARDS</b>
<b class="nc">&nbsp;                : MoveStepType.FORWARDS;</b>
<b class="nc">&nbsp;        if (mvMode == GEAR_JUMP || mvMode == GEAR_DFA) {</b>
<b class="nc">&nbsp;            mp.addStep(MoveStepType.START_JUMP);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ShortestPathFinder pf = ShortestPathFinder.newInstanceOfOneToAll(maxMP,</b>
<b class="nc">&nbsp;                stepType, en.getGame());</b>
<b class="nc">&nbsp;        pf.run(mp);</b>
<b class="nc">&nbsp;        mvEnvData = pf.getAllComputedPaths();</b>
<b class="nc">&nbsp;        Map&lt;Coords, Integer&gt; mvEnvMP = new HashMap&lt;Coords, Integer&gt;(</b>
<b class="nc">&nbsp;                (int) ((mvEnvData.size() * 1.25) + 1));</b>
<b class="nc">&nbsp;        for (Coords c : mvEnvData.keySet()) {</b>
<b class="nc">&nbsp;            mvEnvMP.put(c, mvEnvData.get(c).countMp(mvMode == GEAR_JUMP));</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        clientgui.bv.setMovementEnvelope(mvEnvMP, en.getWalkMP(), en</b>
<b class="nc">&nbsp;                .getRunMP(), en.getJumpMP(), mvMode);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void computeModifierEnvelope() {
<b class="nc">&nbsp;        if (ce() == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        int maxMP;
<b class="nc">&nbsp;        if (gear == GEAR_JUMP) {</b>
<b class="nc">&nbsp;            maxMP = ce().getJumpMP();</b>
<b class="nc">&nbsp;        } else if (gear == GEAR_BACKUP) {</b>
<b class="nc">&nbsp;            maxMP = ce().getWalkMP();</b>
<b class="nc">&nbsp;        } else if (ce() instanceof Mech &amp;&amp; !(ce() instanceof QuadVee)</b>
<b class="nc">&nbsp;                &amp;&amp; ce().getMovementMode() == EntityMovementMode.TRACKED){</b>
&nbsp;            //A non-QuadVee &#39;Mech that is using tracked movement (or converting to it) is limited to walking
<b class="nc">&nbsp;            maxMP = ce().getWalkMP();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            maxMP = ce().getRunMP();</b>
&nbsp;        }
<b class="nc">&nbsp;        MoveStepType stepType = (gear == GEAR_BACKUP) ? MoveStepType.BACKWARDS</b>
<b class="nc">&nbsp;                                                      : MoveStepType.FORWARDS;</b>
<b class="nc">&nbsp;        MovePath mp = new MovePath(clientgui.getClient().getGame(), ce());</b>
<b class="nc">&nbsp;        if (gear == GEAR_JUMP) {</b>
<b class="nc">&nbsp;            mp.addStep(MoveStepType.START_JUMP);</b>
&nbsp;        }
<b class="nc">&nbsp;        LongestPathFinder lpf = LongestPathFinder.newInstanceOfLongestPath(</b>
<b class="nc">&nbsp;                maxMP, stepType, ce().getGame());</b>
<b class="nc">&nbsp;        final int timeLimit = PreferenceManager.getClientPreferences()</b>
<b class="nc">&nbsp;                                               .getMaxPathfinderTime();</b>
<b class="nc">&nbsp;        AbstractPathFinder.StopConditionTimeout&lt;MovePath&gt; timeoutCondition = new AbstractPathFinder.StopConditionTimeout&lt;&gt;(</b>
&nbsp;                timeLimit * 10);
<b class="nc">&nbsp;        lpf.addStopCondition(timeoutCondition);</b>
<b class="nc">&nbsp;        lpf.run(mp);</b>
<b class="nc">&nbsp;        clientgui.bv.setMovementModifierEnvelope(lpf.getLongestComputedPaths());</b>
&nbsp;    }
&nbsp;
&nbsp;    //
&nbsp;    // ActionListener
&nbsp;    //
&nbsp;    public synchronized void actionPerformed(ActionEvent ev) {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
<b class="nc">&nbsp;        if (ce == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (statusBarActionPerformed(ev, clientgui.getClient())) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (!clientgui.getClient().isMyTurn()) {</b>
&nbsp;            // odd...
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        final String actionCmd = ev.getActionCommand();</b>
<b class="nc">&nbsp;        final IOptions opts = clientgui.getClient().getGame().getOptions();</b>
<b class="nc">&nbsp;        if (actionCmd.equals(MoveCommand.MOVE_NEXT.getCmd())) {</b>
<b class="nc">&nbsp;            selectEntity(clientgui.getClient().getNextEntityNum(cen));</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(</b>
<b class="nc">&nbsp;                MoveCommand.MOVE_FORWARD_INI.getCmd())) {</b>
<b class="nc">&nbsp;            selectNextPlayer();</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_CANCEL.getCmd())) {</b>
<b class="nc">&nbsp;            clear();</b>
<b class="nc">&nbsp;            computeMovementEnvelope(ce);</b>
<b class="nc">&nbsp;        } else if (ev.getSource().equals(getBtn(MoveCommand.MOVE_MORE))) {</b>
<b class="nc">&nbsp;            currentButtonGroup++;</b>
<b class="nc">&nbsp;            currentButtonGroup %= numButtonGroups;</b>
<b class="nc">&nbsp;            setupButtonPanel();</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_UNJAM.getCmd())) {</b>
<b class="nc">&nbsp;            String title = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.UnjamRAC.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String msg = Messages.getString(</b>
&nbsp;                    &quot;MovementDisplay.UnjamRAC.message&quot;); //$NON-NLS-1$
<b class="nc">&nbsp;            if ((gear == MovementDisplay.GEAR_JUMP)</b>
&nbsp;                    || (gear == MovementDisplay.GEAR_CHARGE)
&nbsp;                    || (gear == MovementDisplay.GEAR_DFA)
<b class="nc">&nbsp;                    || ((cmd.getMpUsed() &gt; ce.getWalkMP()) </b>
<b class="nc">&nbsp;                            &amp;&amp; !(cmd.getLastStep().isOnlyPavement() </b>
<b class="nc">&nbsp;                                    &amp;&amp; (cmd.getMpUsed() &lt;= (ce.getWalkMP() + 1))))</b>
<b class="nc">&nbsp;                    || (opts.booleanOption(&quot;tacops_tank_crews&quot;)</b>
<b class="nc">&nbsp;                            &amp;&amp; (cmd.getMpUsed() &gt; 0) &amp;&amp; (ce instanceof Tank) </b>
<b class="nc">&nbsp;                            &amp;&amp; (ce.getCrew().getSize() &lt; 2))</b>
&nbsp;                    || (gear == MovementDisplay.GEAR_SWIM)
&nbsp;                    || (gear == MovementDisplay.GEAR_RAM)) {
&nbsp;                // in the wrong gear
&nbsp;                // clearAllMoves();
&nbsp;                // gear = Compute.GEAR_LAND;
<b class="nc">&nbsp;                setUnjamEnabled(false);</b>
<b class="nc">&nbsp;            } else  if (clientgui.doYesNoDialog(title, msg)) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.UNJAM_RAC);</b>
<b class="nc">&nbsp;                ready();</b>
&nbsp;                // If ready() fires, it will call endMyTurn, which sets cen to
&nbsp;                // Entity.NONE.  If this doesn&#39;t happen, it means that the
&nbsp;                // ready() was cancelled (ie, not all Velocity is spent), if it
&nbsp;                // is cancelled we have to ensure the UNJAM_RAC step is removed,
&nbsp;                // otherwise it can fire multiple times.
<b class="nc">&nbsp;                if (cen != Entity.NONE) {</b>
<b class="nc">&nbsp;                    cmd.removeLastStep();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_SEARCHLIGHT.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.SEARCHLIGHT);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_WALK.getCmd())) {</b>
<b class="nc">&nbsp;            if ((gear == MovementDisplay.GEAR_JUMP)</b>
&nbsp;                    || (gear == MovementDisplay.GEAR_SWIM)) {
<b class="nc">&nbsp;                gear = MovementDisplay.GEAR_LAND;</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
<b class="nc">&nbsp;            Color walkColor = GUIPreferences.getInstance().getColor(</b>
&nbsp;                    GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<b class="nc">&nbsp;            clientgui.getBoardView().setHighlightColor(walkColor);</b>
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_LAND;</b>
<b class="nc">&nbsp;            computeMovementEnvelope(ce);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_JUMP.getCmd())) {</b>
<b class="nc">&nbsp;            if ((gear != MovementDisplay.GEAR_JUMP)</b>
<b class="nc">&nbsp;                    &amp;&amp; !((cmd.getLastStep() != null)</b>
<b class="nc">&nbsp;                            &amp;&amp; cmd.getLastStep().isFirstStep() </b>
<b class="nc">&nbsp;                            &amp;&amp; (cmd.getLastStep().getType() </b>
&nbsp;                                    == MoveStepType.LAY_MINE))) {
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!cmd.isJumping()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.START_JUMP);</b>
&nbsp;            }
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_JUMP;</b>
<b class="nc">&nbsp;            Color jumpColor = GUIPreferences.getInstance().getColor(</b>
&nbsp;                    GUIPreferences.ADVANCED_MOVE_JUMP_COLOR);
<b class="nc">&nbsp;            clientgui.getBoardView().setHighlightColor(jumpColor);</b>
<b class="nc">&nbsp;            computeMovementEnvelope(ce);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_SWIM.getCmd())) {</b>
<b class="nc">&nbsp;            if (gear != MovementDisplay.GEAR_SWIM) {</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
&nbsp;            // dcmd.addStep(MoveStepType.SWIM);
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_SWIM;</b>
<b class="nc">&nbsp;            ce.setMovementMode((ce instanceof BipedMech) ? EntityMovementMode.BIPED_SWIM</b>
<b class="nc">&nbsp;                    : EntityMovementMode.QUAD_SWIM);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_MODE_CONVERT.getCmd())) {</b>
<b class="nc">&nbsp;            EntityMovementMode nextMode = ce.nextConversionMode(cmd.getFinalConversionMode());</b>
&nbsp;            // LAMs may have to skip the next mode due to damage
<b class="nc">&nbsp;            if (ce instanceof LandAirMech) {</b>
<b class="nc">&nbsp;                if (!((LandAirMech)ce).canConvertTo(nextMode)) {</b>
<b class="nc">&nbsp;                    nextMode = ce.nextConversionMode(nextMode);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!((LandAirMech)ce).canConvertTo(nextMode)) {</b>
<b class="nc">&nbsp;                    nextMode = ce.getMovementMode();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            adjustConvertSteps(nextMode);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_MODE_LEG.getCmd())) {</b>
<b class="nc">&nbsp;            if ((ce.getEntityType() &amp; Entity.ETYPE_QUAD_MECH) == Entity.ETYPE_QUAD_MECH) {</b>
<b class="nc">&nbsp;                adjustConvertSteps(EntityMovementMode.QUAD);                </b>
<b class="nc">&nbsp;            } else if ((ce.getEntityType() &amp; Entity.ETYPE_TRIPOD_MECH) == Entity.ETYPE_TRIPOD_MECH) {</b>
<b class="nc">&nbsp;                adjustConvertSteps(EntityMovementMode.TRIPOD);</b>
<b class="nc">&nbsp;            } else if ((ce.getEntityType() &amp; Entity.ETYPE_BIPED_MECH) == Entity.ETYPE_BIPED_MECH) {</b>
<b class="nc">&nbsp;                adjustConvertSteps(EntityMovementMode.BIPED);</b>
&nbsp;            }
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_MODE_VEE.getCmd())) {</b>
<b class="nc">&nbsp;            if (ce instanceof QuadVee &amp;&amp; ((QuadVee)ce).getMotiveType() == QuadVee.MOTIVE_WHEEL) {</b>
<b class="nc">&nbsp;                adjustConvertSteps(EntityMovementMode.WHEELED);</b>
<b class="nc">&nbsp;            } else if ((ce instanceof Mech &amp;&amp; ((Mech)ce).hasTracks())</b>
&nbsp;                    || ce instanceof QuadVee) {
<b class="nc">&nbsp;                adjustConvertSteps(EntityMovementMode.TRACKED);</b>
<b class="nc">&nbsp;            } else if (ce instanceof LandAirMech</b>
<b class="nc">&nbsp;                    &amp;&amp; ((LandAirMech)ce).getLAMType() == LandAirMech.LAM_STANDARD) {</b>
<b class="nc">&nbsp;                adjustConvertSteps(EntityMovementMode.WIGE);</b>
&nbsp;            }
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_MODE_AIR.getCmd())) {</b>
<b class="nc">&nbsp;            if (ce instanceof LandAirMech) {</b>
<b class="nc">&nbsp;                adjustConvertSteps(EntityMovementMode.AERODYNE);</b>
&nbsp;            }
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_TURN.getCmd())) {</b>
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_TURN;</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_BACK_UP.getCmd())) {</b>
<b class="nc">&nbsp;            if (gear == MovementDisplay.GEAR_JUMP) {</b>
<b class="nc">&nbsp;                gear = MovementDisplay.GEAR_BACKUP; // on purpose...</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_BACKUP; // on purpose...</b>
<b class="nc">&nbsp;            Color backColor = GUIPreferences.getInstance().getColor(</b>
&nbsp;                    GUIPreferences.ADVANCED_MOVE_BACK_COLOR);
<b class="nc">&nbsp;            clientgui.getBoardView().setHighlightColor(backColor);</b>
<b class="nc">&nbsp;            computeMovementEnvelope(ce);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_LONGEST_RUN.getCmd())) {</b>
<b class="nc">&nbsp;            if (gear == MovementDisplay.GEAR_JUMP) {</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_LONGEST_RUN;</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_LONGEST_WALK.getCmd())) {</b>
<b class="nc">&nbsp;            if (gear == MovementDisplay.GEAR_JUMP) {</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_LONGEST_WALK;</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_CLEAR.getCmd())) {</b>
<b class="nc">&nbsp;            clear();</b>
<b class="nc">&nbsp;            if (!clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                    .containsMinefield(ce.getPosition())) {</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.CantClearMinefield&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.NoMinefield&quot;)); //$NON-NLS-1$</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            // Does the entity has a minesweeper?
<b class="nc">&nbsp;            int clear = Minefield.CLEAR_NUMBER_INFANTRY;</b>
<b class="nc">&nbsp;            int boom = Minefield.CLEAR_NUMBER_INFANTRY_ACCIDENT;</b>
&nbsp;            // Check for Minesweeping Engineers
<b class="nc">&nbsp;            if ((ce() instanceof Infantry)) {</b>
<b class="nc">&nbsp;                Infantry inf = (Infantry) ce();</b>
<b class="nc">&nbsp;                if (inf.hasSpecialization(Infantry.MINE_ENGINEERS)) {</b>
<b class="nc">&nbsp;                    clear = Minefield.CLEAR_NUMBER_INF_ENG;</b>
<b class="nc">&nbsp;                    boom = Minefield.CLEAR_NUMBER_INF_ENG_ACCIDENT;</b>
&nbsp;                }
&nbsp;            }
&nbsp;            // Check for Mine clearance manipulators on BA
<b class="nc">&nbsp;            if ((ce() instanceof BattleArmor)) {</b>
<b class="nc">&nbsp;                BattleArmor ba = (BattleArmor) ce();</b>
<b class="nc">&nbsp;                String mcmName = BattleArmor.MANIPULATOR_TYPE_STRINGS</b>
&nbsp;                        [BattleArmor.MANIPULATOR_BASIC_MINE_CLEARANCE];
<b class="nc">&nbsp;                if (ba.getLeftManipulatorName().equals(mcmName)) {</b>
<b class="nc">&nbsp;                    clear = Minefield.CLEAR_NUMBER_BA_SWEEPER;</b>
<b class="nc">&nbsp;                    boom = Minefield.CLEAR_NUMBER_BA_SWEEPER_ACCIDENT;</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // need to choose a mine
<b class="nc">&nbsp;            List&lt;Minefield&gt; mfs = clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                    .getMinefields(ce.getPosition());</b>
<b class="nc">&nbsp;            String[] choices = new String[mfs.size()];</b>
<b class="nc">&nbsp;            for (int loop = 0; loop &lt; choices.length; loop++) {</b>
<b class="nc">&nbsp;                choices[loop] = Minefield.getDisplayableName(mfs.get(loop)</b>
<b class="nc">&nbsp;                        .getType());</b>
&nbsp;            }
<b class="nc">&nbsp;            String input = (String) JOptionPane</b>
<b class="nc">&nbsp;                    .showInputDialog(</b>
&nbsp;                            clientgui,
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.ChooseMinefieldDialog.message&quot;),//$NON-NLS-1$</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.ChooseMinefieldDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                            JOptionPane.QUESTION_MESSAGE, null, choices, null);
<b class="nc">&nbsp;            Minefield mf = null;</b>
<b class="nc">&nbsp;            if (input != null) {</b>
<b class="nc">&nbsp;                for (int loop = 0; loop &lt; choices.length; loop++) {</b>
<b class="nc">&nbsp;                    if (input.equals(choices[loop])) {</b>
<b class="nc">&nbsp;                        mf = mfs.get(loop);</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            String title = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;MovementDisplay.ClearMinefieldDialog.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            String msg = Messages.getString(</b>
&nbsp;                    &quot;MovementDisplay.ClearMinefieldDialog.message&quot;, //$NON-NLS-1$
&nbsp;                    new Object[] {
<b class="nc">&nbsp;                    Integer.valueOf(clear), Integer.valueOf(boom) });</b>
<b class="nc">&nbsp;            if ((null != mf) &amp;&amp; clientgui.doYesNoDialog(title, msg)) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.CLEAR_MINEFIELD, mf);</b>
<b class="nc">&nbsp;                ready();</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_CHARGE.getCmd())) {</b>
<b class="nc">&nbsp;            if (gear != MovementDisplay.GEAR_LAND) {</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_CHARGE;</b>
<b class="nc">&nbsp;            computeMovementEnvelope(ce);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_DFA.getCmd())) {</b>
<b class="nc">&nbsp;            if (gear != MovementDisplay.GEAR_JUMP) {</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_DFA;</b>
<b class="nc">&nbsp;            computeMovementEnvelope(ce);</b>
<b class="nc">&nbsp;            if (!cmd.isJumping()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.START_JUMP);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_RAM.getCmd())) {</b>
<b class="nc">&nbsp;            if (gear != MovementDisplay.GEAR_LAND) {</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (ce.isAirborneVTOLorWIGE()) {</b>
<b class="nc">&nbsp;                gear = MovementDisplay.GEAR_CHARGE;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                gear = MovementDisplay.GEAR_RAM;</b>
&nbsp;            }
<b class="nc">&nbsp;            computeMovementEnvelope(ce);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_GET_UP.getCmd())) {</b>
&nbsp;            // if the unit has a hull down step
&nbsp;            // then don&#39;t clear the moves
<b class="nc">&nbsp;            if (!cmd.contains(MoveStepType.HULL_DOWN)) {</b>
<b class="nc">&nbsp;                clear();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (opts.booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_CAREFUL_STAND)</b>
<b class="nc">&nbsp;                    &amp;&amp; (ce.getWalkMP() &gt; 2)) {</b>
<b class="nc">&nbsp;                ConfirmDialog response = clientgui</b>
<b class="nc">&nbsp;                        .doYesNoBotherDialog(</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.CarefulStand.title&quot;),//$NON-NLS-1$</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.CarefulStand.message&quot;));</b>
<b class="nc">&nbsp;                if (response.getAnswer()) {</b>
<b class="nc">&nbsp;                    ce.setCarefulStand(true);</b>
<b class="nc">&nbsp;                    if (cmd.getFinalProne() || cmd.getFinalHullDown()) {</b>
<b class="nc">&nbsp;                        cmd.addStep(MoveStepType.CAREFUL_STAND);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    if (cmd.getFinalProne() || cmd.getFinalHullDown()) {</b>
<b class="nc">&nbsp;                        cmd.addStep(MoveStepType.GET_UP);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Move&quot;) + &quot;&lt;/b&gt;&lt;/html&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                if (cmd.getFinalProne() || cmd.getFinalHullDown()) {</b>
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.GET_UP);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_GO_PRONE.getCmd())) {</b>
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_LAND;</b>
<b class="nc">&nbsp;            if (!cmd.getFinalProne()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.GO_PRONE);</b>
&nbsp;            }
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;            butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Move&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_HULL_DOWN.getCmd())) {</b>
<b class="nc">&nbsp;            gear = MovementDisplay.GEAR_LAND;</b>
<b class="nc">&nbsp;            if (!cmd.getFinalHullDown()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.HULL_DOWN);</b>
&nbsp;            }
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;            butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Move&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_FLEE.getCmd())</b>
<b class="nc">&nbsp;                &amp;&amp; clientgui.doYesNoDialog(Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.EscapeDialog.title&quot;),</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay&quot; + &quot;.EscapeDialog&quot;</b>
&nbsp;                                + &quot;.message&quot;))) {
&nbsp;            //$NON-NLS-1$
&nbsp;            // $NON-NLS-2$
<b class="nc">&nbsp;            clear();</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.FLEE);</b>
<b class="nc">&nbsp;            ready();</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_FLY_OFF.getCmd())</b>
<b class="nc">&nbsp;                &amp;&amp; clientgui.doYesNoDialog(Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.FlyOffDialog.title&quot;),</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay&quot; + &quot;.FlyOffDialog&quot;</b>
&nbsp;                                + &quot;.message&quot;))) {
&nbsp;            //$NON-NLS-1$
&nbsp;            // $NON-NLS-2$
&nbsp;            // clear();
<b class="nc">&nbsp;            if (opts.booleanOption(OptionsConstants.ADVAERORULES_RETURN_FLYOVER)</b>
&nbsp;                    &amp;&amp; clientgui
<b class="nc">&nbsp;                            .doYesNoDialog(</b>
<b class="nc">&nbsp;                                    Messages.getString(&quot;MovementDisplay.ReturnFly.title&quot;),</b>
<b class="nc">&nbsp;                                    Messages.getString(&quot;MovementDisplay.ReturnFly.message&quot;))) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.RETURN);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.OFF);</b>
&nbsp;            }
<b class="nc">&nbsp;            ready();</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_EJECT.getCmd())) {</b>
<b class="nc">&nbsp;            if (ce instanceof Tank) {</b>
<b class="nc">&nbsp;                if (clientgui</b>
<b class="nc">&nbsp;                        .doYesNoDialog(</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.AbandonDialog.title&quot;),</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.AbandonDialog.message&quot;))) { //$NON-NLS-1$</b>
&nbsp;                    // $NON-NLS-2$
<b class="nc">&nbsp;                    clear();</b>
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.EJECT);</b>
<b class="nc">&nbsp;                    ready();</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (ce.isLargeCraft()) {</b>
<b class="nc">&nbsp;                if (clientgui</b>
<b class="nc">&nbsp;                        .doYesNoDialog(</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.AbandonDialog.title&quot;),</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.AbandonDialog.message&quot;))) { //$NON-NLS-1$</b>
&nbsp;                    // $NON-NLS-2$
<b class="nc">&nbsp;                    clear();</b>
&nbsp;                    // If we&#39;re abandoning while grounded, find a legal position to put an EjectedCrew unit
<b class="nc">&nbsp;                    if (!ce.isSpaceborne() &amp;&amp; ce.getAltitude() == 0) {</b>
<b class="nc">&nbsp;                        Coords pos = getEjectPosition(ce);</b>
<b class="nc">&nbsp;                        cmd.addStep(MoveStepType.EJECT, ce, pos);</b>
<b class="nc">&nbsp;                    } else {</b>
<b class="nc">&nbsp;                        cmd.addStep(MoveStepType.EJECT);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    ready();</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (clientgui</b>
<b class="nc">&nbsp;                    .doYesNoDialog(</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.AbandonDialog1.title&quot;),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.AbandonDialog1.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                clear();</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.EJECT);</b>
<b class="nc">&nbsp;                ready();</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_LOAD.getCmd())) {</b>
&nbsp;            // Find the other friendly unit in our hex, add it
&nbsp;            // to our local list of loaded units, and then stop.
<b class="nc">&nbsp;            Entity other = getLoadedUnit();</b>
<b class="nc">&nbsp;            if (other != null) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.LOAD);</b>
<b class="nc">&nbsp;                clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;                gear = MovementDisplay.GEAR_LAND;</b>
&nbsp;            } // else - didn&#39;t find a unit to load
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_TOW.getCmd())) {</b>
&nbsp;            // Find the other friendly unit in our hex, add it
&nbsp;            // to our local list of loaded units, and then stop.
<b class="nc">&nbsp;            Entity other = getTowedUnit();</b>
<b class="nc">&nbsp;            if (other != null) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.TOW);</b>
<b class="nc">&nbsp;                clientgui.bv.drawMovementData(ce(), cmd);</b>
&nbsp;            } // else - didn&#39;t find a unit to tow
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_DISCONNECT.getCmd())) {</b>
&nbsp;            // Ask the user if we&#39;re carrying multiple units.
<b class="nc">&nbsp;            Entity other = getDisconnectedUnit();</b>
<b class="nc">&nbsp;            if (other != null) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.DISCONNECT, other);</b>
<b class="nc">&nbsp;                clientgui.bv.drawMovementData(ce(), cmd);</b>
&nbsp;            } // else - didn&#39;t find a unit to tow
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_MOUNT.getCmd())) {</b>
<b class="nc">&nbsp;            Entity other = getMountedUnit();</b>
<b class="nc">&nbsp;            if (other != null) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.MOUNT, other);</b>
<b class="nc">&nbsp;                ready();</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_UNLOAD.getCmd())) {</b>
&nbsp;            // Ask the user if we&#39;re carrying multiple units.
<b class="nc">&nbsp;            Entity other = getUnloadedUnit();</b>
<b class="nc">&nbsp;            if (other != null) {</b>
<b class="nc">&nbsp;                if (ce() instanceof SmallCraft </b>
<b class="nc">&nbsp;                        || !ce().getAllTowedUnits().isEmpty()</b>
<b class="nc">&nbsp;                        || ce().getTowedBy() != Entity.NONE) {</b>
<b class="nc">&nbsp;                    Coords pos = getUnloadPosition(other);</b>
<b class="nc">&nbsp;                    if (null != pos) {</b>
&nbsp;                        // set other&#39;s position and end this turn - the
&nbsp;                        // unloading unit will get
&nbsp;                        // another turn for further unloading later
<b class="nc">&nbsp;                        cmd.addStep(MoveStepType.UNLOAD, other, pos);</b>
<b class="nc">&nbsp;                        clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;                        ready();</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else {</b>
&nbsp;                    // some different handling for small craft/dropship
&nbsp;                    // unloading
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.UNLOAD, other);</b>
<b class="nc">&nbsp;                    clientgui.bv.drawMovementData(ce(), cmd);</b>
&nbsp;                }
&nbsp;            } // else - Player canceled the unload.
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_RAISE_ELEVATION.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.UP);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_LOWER_ELEVATION.getCmd())) {</b>
<b class="nc">&nbsp;            if (ce.isAero()</b>
<b class="nc">&nbsp;                    &amp;&amp; (null != cmd.getLastStep())</b>
<b class="nc">&nbsp;                    &amp;&amp; (cmd.getLastStep().getNDown() == 1)</b>
<b class="nc">&nbsp;                    &amp;&amp; (cmd.getLastStep().getVelocity() &lt; 12)</b>
<b class="nc">&nbsp;                    &amp;&amp; !(((IAero) ce).isSpheroid() || clientgui.getClient()</b>
<b class="nc">&nbsp;                            .getGame().getPlanetaryConditions().isVacuum())) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.ACC, true);</b>
&nbsp;            }
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.DOWN);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_CLIMB_MODE.getCmd())) {</b>
<b class="nc">&nbsp;            MoveStep ms = cmd.getLastStep();</b>
<b class="nc">&nbsp;            if ((ms != null)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((ms.getType() == MoveStepType.CLIMB_MODE_ON) || (ms</b>
<b class="nc">&nbsp;                            .getType() == MoveStepType.CLIMB_MODE_OFF))) {</b>
<b class="nc">&nbsp;                MoveStep lastStep = cmd.getLastStep();</b>
<b class="nc">&nbsp;                cmd.removeLastStep();</b>
&nbsp;                // Add another climb mode step
&nbsp;                // Without this, we end up with 3 effect modes: no climb step, climb step on, climb step off
&nbsp;                // This affects how the StepSprite gets rendered, so it&#39;s more clear to keep a climb step
&nbsp;                // once one has been added
<b class="nc">&nbsp;                if (lastStep.getType() == MoveStepType.CLIMB_MODE_ON) {</b>
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.CLIMB_MODE_OFF);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.CLIMB_MODE_ON);</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (cmd.getFinalClimbMode()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.CLIMB_MODE_OFF);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.CLIMB_MODE_ON);</b>
&nbsp;            }
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;            computeMovementEnvelope(ce);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_LAY_MINE.getCmd())) {</b>
<b class="nc">&nbsp;            int i = chooseMineToLay();</b>
<b class="nc">&nbsp;            if (i != -1) {</b>
<b class="nc">&nbsp;                Mounted m = ce.getEquipment(i);</b>
<b class="nc">&nbsp;                if (m.getMineType() == Mounted.MINE_VIBRABOMB) {</b>
<b class="nc">&nbsp;                    VibrabombSettingDialog vsd = new VibrabombSettingDialog(</b>
&nbsp;                            clientgui.frame);
<b class="nc">&nbsp;                    vsd.setVisible(true);</b>
<b class="nc">&nbsp;                    m.setVibraSetting(vsd.getSetting());</b>
&nbsp;                }
<b class="nc">&nbsp;                if (cmd.getLastStep() == null</b>
&nbsp;                        &amp;&amp; ce instanceof BattleArmor
<b class="nc">&nbsp;                        &amp;&amp; ce.getMovementMode().equals(EntityMovementMode.INF_JUMP)) {</b>
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.START_JUMP);</b>
<b class="nc">&nbsp;                    gear = GEAR_JUMP;</b>
<b class="nc">&nbsp;                    Color jumpColor = GUIPreferences.getInstance().getColor(</b>
&nbsp;                            GUIPreferences.ADVANCED_MOVE_JUMP_COLOR);
<b class="nc">&nbsp;                    clientgui.getBoardView().setHighlightColor(jumpColor);</b>
<b class="nc">&nbsp;                    computeMovementEnvelope(ce);</b>
&nbsp;                }
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.LAY_MINE, i);</b>
<b class="nc">&nbsp;                clientgui.bv.drawMovementData(ce, cmd);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_CALL_SUPPORT.getCmd())) {</b>
<b class="nc">&nbsp;            ((Infantry) ce).createLocalSupport();</b>
<b class="nc">&nbsp;            clientgui.getClient().sendUpdateEntity(ce());</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_DIG_IN.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.DIG_IN);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_FORTIFY.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.FORTIFY);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_TAKE_COVER.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.TAKE_COVER);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_SHAKE_OFF.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.SHAKE_OFF_SWARMERS);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce(), cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_RECKLESS.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.setCareful(false);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_STRAFE.getCmd())) {</b>
<b class="nc">&nbsp;            gear = GEAR_STRAFE;</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_BOMB.getCmd())) {</b>
<b class="nc">&nbsp;            if (cmd.getLastStep() == null) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.NONE);</b>
&nbsp;            }
<b class="nc">&nbsp;            cmd.setVTOLBombStep(cmd.getFinalCoords());</b>
<b class="nc">&nbsp;            cmd.compile(clientgui.getClient().getGame(), ce, false);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_ACCN.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.ACCN);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_DECN.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.DECN);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_ACC.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.ACC);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_DEC.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.DEC);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_EVADE.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.EVADE);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_BOOTLEGGER.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.BOOTLEGGER);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_SHUTDOWN.getCmd())) {</b>
<b class="nc">&nbsp;            if (clientgui</b>
<b class="nc">&nbsp;                    .doYesNoDialog(</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.ShutdownDialog.title&quot;),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.ShutdownDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.SHUTDOWN);</b>
<b class="nc">&nbsp;                ready();</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_STARTUP.getCmd())) {</b>
<b class="nc">&nbsp;            if (clientgui</b>
<b class="nc">&nbsp;                    .doYesNoDialog(</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.StartupDialog.title&quot;),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.StartupDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                clear();</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.STARTUP);</b>
<b class="nc">&nbsp;                ready();</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_SELF_DESTRUCT.getCmd())) {</b>
<b class="nc">&nbsp;            if (clientgui</b>
<b class="nc">&nbsp;                    .doYesNoDialog(</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.SelfDestructDialog.title&quot;),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.SelfDestructDialog.message&quot;))) { //$NON-NLS-1$</b>
&nbsp;                // $NON-NLS-2$
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.SELF_DESTRUCT);</b>
<b class="nc">&nbsp;                ready();</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_EVADE_AERO.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.EVADE);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;            setEvadeAeroEnabled(false);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_ROLL.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.ROLL);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_HOVER.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.HOVER);</b>
<b class="nc">&nbsp;            if (ce instanceof LandAirMech</b>
<b class="nc">&nbsp;                    &amp;&amp; ce.getMovementMode() == EntityMovementMode.WIGE</b>
<b class="nc">&nbsp;                    &amp;&amp; ce.isAirborne()) {</b>
<b class="nc">&nbsp;                gear = GEAR_LAND;</b>
&nbsp;            }
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_MANEUVER.getCmd())) {</b>
<b class="nc">&nbsp;            ManeuverChoiceDialog choiceDialog = new ManeuverChoiceDialog(</b>
&nbsp;                    clientgui.frame,
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.ManeuverDialog.title&quot;), //$NON-NLS-1$</b>
&nbsp;                    &quot;huh?&quot;);
<b class="nc">&nbsp;            IAero a = (IAero) ce;</b>
<b class="nc">&nbsp;            MoveStep last = cmd.getLastStep();</b>
<b class="nc">&nbsp;            int vel = a.getCurrentVelocity();</b>
<b class="nc">&nbsp;            int altitude = ce.getAltitude();</b>
<b class="nc">&nbsp;            Coords pos = ce.getPosition();</b>
<b class="nc">&nbsp;            int distance = 0;</b>
<b class="nc">&nbsp;            if (null != last) {</b>
<b class="nc">&nbsp;                vel = last.getVelocityLeft();</b>
<b class="nc">&nbsp;                altitude = last.getAltitude();</b>
<b class="nc">&nbsp;                pos = last.getPosition();</b>
<b class="nc">&nbsp;                distance = last.getDistance();</b>
&nbsp;            }
<b class="nc">&nbsp;            IBoard board = clientgui.getClient().getGame().getBoard();</b>
&nbsp;            // On Atmospheric maps, elevations are treated as altitudes, so
&nbsp;            // hex ceiling is the ground
<b class="nc">&nbsp;            int ceil = board.getHex(pos).ceiling(board.inAtmosphere());</b>
&nbsp;            // On the ground map, Aeros ignore hex elevations
<b class="nc">&nbsp;            if (board.onGround()) {</b>
<b class="nc">&nbsp;                ceil = 0;</b>
&nbsp;            }
<b class="nc">&nbsp;            choiceDialog.checkPerformability(vel, altitude, ceil, a.isVSTOL(),</b>
<b class="nc">&nbsp;                    distance, clientgui.getClient().getGame(), cmd);</b>
<b class="nc">&nbsp;            choiceDialog.setVisible(true);</b>
<b class="nc">&nbsp;            int manType = choiceDialog.getChoice();</b>
<b class="nc">&nbsp;            if ((manType &gt; ManeuverType.MAN_NONE) &amp;&amp; addManeuver(manType)) {</b>
<b class="nc">&nbsp;                clientgui.bv.drawMovementData(ce, cmd);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_LAUNCH.getCmd())) {</b>
<b class="nc">&nbsp;            TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; undocked = getUndockedUnits();</b>
<b class="nc">&nbsp;            if (!undocked.isEmpty()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.UNDOCK, undocked);</b>
&nbsp;            }
<b class="nc">&nbsp;            TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; launched = getLaunchedUnits();</b>
<b class="nc">&nbsp;            if (!launched.isEmpty()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.LAUNCH, launched);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!launched.isEmpty() || !undocked.isEmpty()) {</b>
<b class="nc">&nbsp;                clientgui.bv.drawMovementData(ce, cmd);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_RECOVER.getCmd())</b>
<b class="nc">&nbsp;                || actionCmd.equals(MoveCommand.MOVE_DOCK.getCmd())) {</b>
&nbsp;            // if more than one unit is available as a carrier
&nbsp;            // then bring up an option dialog
<b class="nc">&nbsp;            int recoverer = getRecoveryUnit();</b>
<b class="nc">&nbsp;            if (recoverer != -1) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.RECOVER, recoverer, -1);</b>
<b class="nc">&nbsp;                clientgui.bv.drawMovementData(ce, cmd);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (actionCmd.equals(MoveCommand.MOVE_DOCK.getCmd())) {</b>
<b class="nc">&nbsp;                cmd.getLastStep().setDocking(true);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_DROP.getCmd())) {</b>
<b class="nc">&nbsp;            TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; dropped = getDroppedUnits();</b>
<b class="nc">&nbsp;            if (!dropped.isEmpty()) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.DROP, dropped);</b>
<b class="nc">&nbsp;                clientgui.bv.drawMovementData(ce, cmd);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_JOIN.getCmd())) {</b>
&nbsp;            // if more than one unit is available as a carrier
&nbsp;            // then bring up an option dialog
<b class="nc">&nbsp;            int joined = getUnitJoined();</b>
<b class="nc">&nbsp;            if (joined != -1) {</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.JOIN, joined, -1);</b>
<b class="nc">&nbsp;                clientgui.bv.drawMovementData(ce, cmd);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_TURN_LEFT.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.TURN_LEFT);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_TURN_RIGHT.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.TURN_RIGHT);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_THRUST.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.THRUST);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_YAW.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.YAW);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_END_OVER.getCmd())) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.YAW);</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.ROLL);</b>
<b class="nc">&nbsp;            clientgui.bv.drawMovementData(ce, cmd);</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_DUMP.getCmd())) {</b>
<b class="nc">&nbsp;            dumpBombs();</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_TAKE_OFF.getCmd())) {</b>
<b class="nc">&nbsp;            if (ce().isAero()</b>
<b class="nc">&nbsp;                    &amp;&amp; (null != ((IAero) ce()).hasRoomForHorizontalTakeOff())) {</b>
<b class="nc">&nbsp;                String title = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.NoTakeOffDialog.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                String body = Messages.getString(</b>
&nbsp;                        &quot;MovementDisplay.NoTakeOffDialog.message&quot;,
<b class="nc">&nbsp;                        new Object[] { ((IAero) ce())</b>
<b class="nc">&nbsp;                                .hasRoomForHorizontalTakeOff() }); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(title, body);</b>
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                if (clientgui</b>
<b class="nc">&nbsp;                        .doYesNoDialog(</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.TakeOffDialog.title&quot;),</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.TakeOffDialog.message&quot;))) { //$NON-NLS-1$</b>
&nbsp;                    // $NON-NLS-2$
<b class="nc">&nbsp;                    clear();</b>
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.TAKEOFF);</b>
<b class="nc">&nbsp;                    ready();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_VERT_TAKE_OFF.getCmd())) {</b>
<b class="nc">&nbsp;            if (clientgui</b>
<b class="nc">&nbsp;                    .doYesNoDialog(</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.TakeOffDialog.title&quot;),</b>
<b class="nc">&nbsp;                            Messages.getString(&quot;MovementDisplay.TakeOffDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                clear();</b>
<b class="nc">&nbsp;                cmd.addStep(MoveStepType.VTAKEOFF);</b>
<b class="nc">&nbsp;                ready();</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_LAND.getCmd())) {</b>
<b class="nc">&nbsp;            if (ce().isAero()</b>
<b class="nc">&nbsp;                    &amp;&amp; (null != ((IAero) ce()).hasRoomForHorizontalLanding())) {</b>
<b class="nc">&nbsp;                String title = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.NoLandingDialog.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                String body = Messages.getString(</b>
&nbsp;                        &quot;MovementDisplay.NoLandingDialog.message&quot;,
<b class="nc">&nbsp;                        new Object[] { ((IAero) ce())</b>
<b class="nc">&nbsp;                                .hasRoomForHorizontalLanding() }); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(title, body);</b>
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                if (clientgui</b>
<b class="nc">&nbsp;                        .doYesNoDialog(</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.LandDialog.title&quot;),</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.LandDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                    clear();</b>
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.LAND);</b>
<b class="nc">&nbsp;                    ready();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_VERT_LAND.getCmd())) {</b>
<b class="nc">&nbsp;            if (ce().isAero()</b>
<b class="nc">&nbsp;                    &amp;&amp; (null != ((IAero) ce()).hasRoomForVerticalLanding())) {</b>
<b class="nc">&nbsp;                String title = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;MovementDisplay.NoLandingDialog.title&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                String body = Messages.getString(</b>
&nbsp;                        &quot;MovementDisplay.NoLandingDialog.message&quot;,
<b class="nc">&nbsp;                        new Object[] { ((IAero) ce())</b>
<b class="nc">&nbsp;                                .hasRoomForVerticalLanding() }); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(title, body);</b>
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                if (clientgui</b>
<b class="nc">&nbsp;                        .doYesNoDialog(</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.LandDialog.title&quot;),</b>
<b class="nc">&nbsp;                                Messages.getString(&quot;MovementDisplay.LandDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</b>
<b class="nc">&nbsp;                    clear();</b>
<b class="nc">&nbsp;                    cmd.addStep(MoveStepType.VLAND);</b>
<b class="nc">&nbsp;                    ready();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_ENVELOPE.getCmd())) {</b>
<b class="nc">&nbsp;            computeMovementEnvelope(clientgui.mechD.getCurrentEntity());</b>
<b class="nc">&nbsp;        } else if (actionCmd.equals(MoveCommand.MOVE_TRAITOR.getCmd())) {</b>
&nbsp;            // Set up variables we need
&nbsp;            // We use a vector instead of enumeration here so we can grab the
&nbsp;            // size
<b class="nc">&nbsp;            Vector&lt;IPlayer&gt; players = clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                    .getPlayersVector();</b>
<b class="nc">&nbsp;            Integer[] playerIds = new Integer[players.size() - 1];</b>
<b class="nc">&nbsp;            String[] playerNames = new String[players.size() - 1];</b>
<b class="nc">&nbsp;            String[] options = new String[players.size() - 1];</b>
<b class="nc">&nbsp;            Entity e = ce();</b>
&nbsp;
&nbsp;            // Loop through the players vector and fill in the arrays
<b class="nc">&nbsp;            int idx = 0;</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; players.size(); i++) {</b>
<b class="nc">&nbsp;                IPlayer p = players.get(i);</b>
&nbsp;                // If this is us, we skip it since we can&#39;t transfer to
&nbsp;                // ourselves
<b class="nc">&nbsp;                if (p.getName().equals(</b>
<b class="nc">&nbsp;                        clientgui.getClient().getLocalPlayer().getName())) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                playerIds[idx] = p.getId();</b>
<b class="nc">&nbsp;                playerNames[idx] = p.getName();</b>
<b class="nc">&nbsp;                options[idx] = p.getName() + &quot; (ID: &quot; + p.getId() + &quot;)&quot;;</b>
<b class="nc">&nbsp;                idx++;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Dialog for choosing which player to transfer to
<b class="nc">&nbsp;            String option = (String) JOptionPane</b>
<b class="nc">&nbsp;                    .showInputDialog(</b>
<b class="nc">&nbsp;                            clientgui.getFrame(),</b>
&nbsp;                            &quot;Choose the player to gain ownership of this unit when it turns traitor&quot;,
&nbsp;                            &quot;Traitor&quot;, JOptionPane.QUESTION_MESSAGE, null,
&nbsp;                            options, options[0]);
&nbsp;
&nbsp;            // Verify that we have a valid option...
<b class="nc">&nbsp;            if (option != null) {</b>
&nbsp;                // Now that we&#39;ve selected a player, correctly associate the ID
&nbsp;                // and name
<b class="nc">&nbsp;                int id = playerIds[Arrays.asList(options).indexOf(option)];</b>
<b class="nc">&nbsp;                String name = playerNames[Arrays.asList(options)</b>
<b class="nc">&nbsp;                        .indexOf(option)];</b>
&nbsp;
&nbsp;                // And now we perform the actual transfer
<b class="nc">&nbsp;                int confirm = JOptionPane</b>
<b class="nc">&nbsp;                        .showConfirmDialog(</b>
<b class="nc">&nbsp;                                clientgui.getFrame(),</b>
<b class="nc">&nbsp;                                e.getDisplayName()</b>
&nbsp;                                        + &quot; will switch to &quot;
&nbsp;                                        + name
&nbsp;                                        + &quot;&#39;s side at the end of this turn. Are you &quot;
&nbsp;                                        + &quot;sure?&quot;, &quot;Confirm&quot;,
&nbsp;                                JOptionPane.YES_NO_OPTION);
&nbsp;                /*
&nbsp;                 * JOptionPane.showMessageDialog( clientgui.getFrame(),
&nbsp;                 * e.getDisplayName() + &quot; will switch to &quot; + name +
&nbsp;                 * &quot;&#39;s side at the end of this turn.&quot;, &quot;ERROR: Can&#39;t Switch&quot;,
&nbsp;                 * JOptionPane.INFORMATION_MESSAGE);
&nbsp;                 */
<b class="nc">&nbsp;                if (confirm == JOptionPane.YES_OPTION) {</b>
<b class="nc">&nbsp;                    e.setTraitorId(id);</b>
<b class="nc">&nbsp;                    clientgui.getClient().sendUpdateEntity(e);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        updateProneButtons();</b>
<b class="nc">&nbsp;        updateRACButton();</b>
<b class="nc">&nbsp;        updateSearchlightButton();</b>
<b class="nc">&nbsp;        updateElevationButtons();</b>
<b class="nc">&nbsp;        updateTakeOffButtons();</b>
<b class="nc">&nbsp;        updateLandButtons();</b>
<b class="nc">&nbsp;        updateFlyOffButton();</b>
<b class="nc">&nbsp;        updateLaunchButton();</b>
<b class="nc">&nbsp;        updateLoadButtons();</b>
<b class="nc">&nbsp;        updateDropButton();</b>
<b class="nc">&nbsp;        updateConvertModeButton();</b>
<b class="nc">&nbsp;        updateRecklessButton();</b>
<b class="nc">&nbsp;        updateHoverButton();</b>
<b class="nc">&nbsp;        updateManeuverButton();</b>
<b class="nc">&nbsp;        updateDumpButton();</b>
<b class="nc">&nbsp;        updateEvadeButton();</b>
<b class="nc">&nbsp;        updateBootleggerButton();</b>
<b class="nc">&nbsp;        updateShutdownButton();</b>
<b class="nc">&nbsp;        updateStartupButton();</b>
<b class="nc">&nbsp;        updateSelfDestructButton();</b>
<b class="nc">&nbsp;        updateTraitorButton();</b>
<b class="nc">&nbsp;        updateSpeedButtons();</b>
<b class="nc">&nbsp;        updateThrustButton();</b>
<b class="nc">&nbsp;        updateRollButton();</b>
<b class="nc">&nbsp;        updateTakeCoverButton();</b>
<b class="nc">&nbsp;        updateLayMineButton();</b>
<b class="nc">&nbsp;        checkFuel();</b>
<b class="nc">&nbsp;        checkOOC();</b>
<b class="nc">&nbsp;        checkAtmosphere();</b>
&nbsp;
&nbsp;        // if small craft/dropship that has unloaded units, then only allowed
&nbsp;        // to unload more
<b class="nc">&nbsp;        if (ce.hasUnloadedUnitsFromBays()) {</b>
<b class="nc">&nbsp;            disableButtons();</b>
<b class="nc">&nbsp;            updateLoadButtons();</b>
<b class="nc">&nbsp;            butDone.setEnabled(true);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Add enough &lt;code&gt;MoveStepType.CONVERT_MODE&lt;/code&gt; steps to get to the requested mode, or
&nbsp;     * clear the path if the unit is in the requested mode at the beginning of the turn.
&nbsp;     * 
&nbsp;     * @param endMode The mode to convert to
&nbsp;     */
&nbsp;    private void adjustConvertSteps(EntityMovementMode endMode) {
&nbsp;        //Since conversion is not allowed in water, we shouldn&#39;t have to deal with the possibility of swim modes.
<b class="nc">&nbsp;        if (ce().getMovementMode() == endMode</b>
&nbsp;                // Account for grounded LAMs in fighter mode with movement type wheeled 
<b class="nc">&nbsp;                || (ce().isAero() &amp;&amp; endMode == EntityMovementMode.AERODYNE)) {</b>
<b class="nc">&nbsp;            cmd.clear();</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (cmd.getFinalConversionMode() == endMode) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        clear();</b>
<b class="nc">&nbsp;        ce().setConvertingNow(true);</b>
<b class="nc">&nbsp;        cmd.addStep(MoveStepType.CONVERT_MODE);</b>
<b class="nc">&nbsp;        if (cmd.getFinalConversionMode() != endMode) {</b>
<b class="nc">&nbsp;            cmd.addStep(MoveStepType.CONVERT_MODE);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (ce() instanceof Mech &amp;&amp; ((Mech)ce()).hasTracks()) {</b>
<b class="nc">&nbsp;            ce().setMovementMode(endMode);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Give the player the opportunity to unload all entities that are stranded
&nbsp;     * on immobile transports.
&nbsp;     * &lt;p/&gt;
&nbsp;     * According to &lt;a href= &quot;http://www.classicbattletech.com/w3t/showflat
&nbsp;     * .php?Cat=&amp;Board=ask&amp;Number=555466&amp;page=2&amp;view=collapsed&amp;sb=5&amp;o=0&amp;fpart=&quot;
&nbsp;     * &gt; Randall Bills&lt;/a&gt;, the &quot;minimum move&quot; rule allow stranded units to
&nbsp;     * dismount at the start of the turn.
&nbsp;     */
&nbsp;    private void unloadStranded() {
<b class="nc">&nbsp;        Vector&lt;Entity&gt; stranded = new Vector&lt;Entity&gt;();</b>
<b class="nc">&nbsp;        String[] names = null;</b>
<b class="nc">&nbsp;        Entity entity = null;</b>
<b class="nc">&nbsp;        Entity transport = null;</b>
&nbsp;
&nbsp;        // Let the player know what&#39;s going on.
<b class="nc">&nbsp;        setStatusBarText(Messages.getString(&quot;MovementDisplay.AllPlayersUnload&quot;)); //$NON-NLS-1$</b>
&nbsp;
&nbsp;        // Collect the stranded entities into the vector.
<b class="nc">&nbsp;        Iterator&lt;Entity&gt; entities = clientgui.getClient().getSelectedEntities(</b>
<b class="nc">&nbsp;                new EntitySelector() {</b>
<b class="nc">&nbsp;                    private final IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;                    private final GameTurn turn = clientgui.getClient()</b>
<b class="nc">&nbsp;                            .getGame().getTurn();</b>
<b class="nc">&nbsp;                    private final int ownerId = clientgui.getClient()</b>
<b class="nc">&nbsp;                            .getLocalPlayer().getId();</b>
&nbsp;
&nbsp;                    public boolean accept(Entity acc) {
<b class="nc">&nbsp;                        if (turn.isValid(ownerId, acc, game)) {</b>
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        return false;</b>
&nbsp;                    }
&nbsp;                });
<b class="nc">&nbsp;        while (entities.hasNext()) {</b>
<b class="nc">&nbsp;            stranded.addElement(entities.next());</b>
&nbsp;        }
&nbsp;
&nbsp;        // Construct an array of stranded entity names
<b class="nc">&nbsp;        names = new String[stranded.size()];</b>
<b class="nc">&nbsp;        for (int index = 0; index &lt; names.length; index++) {</b>
<b class="nc">&nbsp;            entity = stranded.elementAt(index);</b>
<b class="nc">&nbsp;            transport = clientgui.getClient()</b>
<b class="nc">&nbsp;                                 .getEntity(entity.getTransportId());</b>
&nbsp;            String buffer;
<b class="nc">&nbsp;            if (null == transport) {</b>
<b class="nc">&nbsp;                buffer = entity.getDisplayName();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                buffer = Messages.getString(&quot;MovementDisplay.EntityAt&quot;, //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        new Object[] { entity.getDisplayName(),</b>
<b class="nc">&nbsp;                                transport.getPosition().getBoardNum() });</b>
&nbsp;            }
<b class="nc">&nbsp;            names[index] = buffer.toString();</b>
&nbsp;        }
&nbsp;
&nbsp;        // Show the choices to the player
<b class="nc">&nbsp;        int[] indexes = clientgui</b>
<b class="nc">&nbsp;                .doChoiceDialog(</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.UnloadStrandedUnitsDialog.title&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        Messages.getString(&quot;MovementDisplay.UnloadStrandedUnitsDialog.message&quot;), //$NON-NLS-1$</b>
&nbsp;                        names);
&nbsp;
&nbsp;        // Convert the indexes into selected entity IDs and tell the server.
<b class="nc">&nbsp;        int[] ids = null;</b>
<b class="nc">&nbsp;        if (null != indexes) {</b>
<b class="nc">&nbsp;            ids = new int[indexes.length];</b>
<b class="nc">&nbsp;            for (int index = 0; index &lt; indexes.length; index++) {</b>
<b class="nc">&nbsp;                entity = stranded.elementAt(index);</b>
<b class="nc">&nbsp;                ids[index] = entity.getId();</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        clientgui.getClient().sendUnloadStranded(ids);</b>
&nbsp;    }
&nbsp;
&nbsp;    // board view listener
&nbsp;    @Override
&nbsp;    public void finishedMovingUnits(BoardViewEvent b) {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
&nbsp;
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (clientgui.getClient().isMyTurn() &amp;&amp; (ce != null)) {</b>
<b class="nc">&nbsp;            clientgui.setDisplayVisible(true);</b>
<b class="nc">&nbsp;            clientgui.bv.centerOnHex(ce.getPosition());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void unitSelected(BoardViewEvent b) {
&nbsp;        // Are we ignoring events?
<b class="nc">&nbsp;        if (isIgnoringEvents()) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        Entity e = clientgui.getClient().getGame().getEntity(b.getEntityId());</b>
<b class="nc">&nbsp;        if (null == e) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (clientgui.getClient().isMyTurn()) {</b>
<b class="nc">&nbsp;            if (clientgui.getClient().getGame().getTurn()</b>
<b class="nc">&nbsp;                         .isValidEntity(e, clientgui.getClient().getGame())) {</b>
<b class="nc">&nbsp;                selectEntity(e.getId());</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            clientgui.setDisplayVisible(true);</b>
<b class="nc">&nbsp;            clientgui.mechD.displayEntity(e);</b>
<b class="nc">&nbsp;            if (e.isDeployed()) {</b>
<b class="nc">&nbsp;                clientgui.bv.centerOnHex(e.getPosition());</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void setWalkEnabled(boolean enabled) {
<b class="nc">&nbsp;        buttons.get(MoveCommand.MOVE_WALK).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveWalkEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setTurnEnabled(boolean enabled) {
<b class="nc">&nbsp;        buttons.get(MoveCommand.MOVE_TURN).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveTurnEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setNextEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_NEXT).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveNextEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setForwardIniEnabled(boolean enabled) {
&nbsp;        // forward initiative can only be done if Teams have an initiative!
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                     .booleanOption(OptionsConstants.BASE_TEAM_INITIATIVE)) {</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_FORWARD_INI).setEnabled(enabled);</b>
<b class="nc">&nbsp;            clientgui.getMenuBar().setMoveForwardIniEnabled(enabled);</b>
&nbsp;        } else { // turn them off regardless what is said!
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_FORWARD_INI).setEnabled(false);</b>
<b class="nc">&nbsp;            clientgui.getMenuBar().setMoveForwardIniEnabled(false);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void setLayMineEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_LAY_MINE).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveLayMineEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setLoadEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_LOAD).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveLoadEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setMountEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_MOUNT).setEnabled(enabled);</b>
&nbsp;        // clientgui.getMenuBar().setMoveMountEnabled(enabled);
&nbsp;    }
&nbsp;    
&nbsp;    private void setTowEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_TOW).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveTowEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setUnloadEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_UNLOAD).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveUnloadEnabled(enabled);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void setDisconnectEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_DISCONNECT).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveDisconnectEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setJumpEnabled(boolean enabled) {
<b class="nc">&nbsp;        buttons.get(MoveCommand.MOVE_JUMP).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveJumpEnabled(enabled);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void setModeConvertEnabled(boolean enabled) {
<b class="nc">&nbsp;        buttons.get(MoveCommand.MOVE_MODE_CONVERT).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveModeConvertEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setSwimEnabled(boolean enabled) {
<b class="nc">&nbsp;        buttons.get(MoveCommand.MOVE_SWIM).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveSwimEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setBackUpEnabled(boolean enabled) {
<b class="nc">&nbsp;        buttons.get(MoveCommand.MOVE_BACK_UP).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveBackUpEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setChargeEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_CHARGE).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveChargeEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setDFAEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_DFA).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveDFAEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setGoProneEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_GO_PRONE).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveGoProneEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setFleeEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_FLEE).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveFleeEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setFlyOffEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_FLY_OFF).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveFlyOffEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setEjectEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_EJECT).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveEjectEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setUnjamEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_UNJAM).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveUnjamEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setSearchlightEnabled(boolean enabled, boolean state) {
<b class="nc">&nbsp;        if (state) {</b>
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_SEARCHLIGHT).setText(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.butSearchlightOff&quot;));</b>
&nbsp;            //$NON-NLS-1$
&nbsp;        } else {
<b class="nc">&nbsp;            getBtn(MoveCommand.MOVE_SEARCHLIGHT).setText(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;MovementDisplay.butSearchlightOn&quot;));</b>
&nbsp;            //$NON-NLS-1$
&nbsp;        }
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_SEARCHLIGHT).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveSearchlightEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setHullDownEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_HULL_DOWN).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveHullDownEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setClearEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_CLEAR).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveClearEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setGetUpEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_GET_UP).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveGetUpEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setRaiseEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_RAISE_ELEVATION).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveRaiseEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setLowerEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_LOWER_ELEVATION).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveLowerEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setRecklessEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_RECKLESS).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveRecklessEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setAccEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_ACC).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveAccEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setDecEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_DEC).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveDecEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setAccNEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_ACCN).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveAccNEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setDecNEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_DECN).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveDecNEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setEvadeEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_EVADE).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveEvadeEnabled(enabled);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void setBootleggerEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_BOOTLEGGER).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveBootleggerEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setShutdownEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_SHUTDOWN).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveShutdownEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setStartupEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_STARTUP).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveStartupEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setSelfDestructEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_SELF_DESTRUCT).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveSelfDestructEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setTraitorEnabled(boolean enabled) {
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveTraitorEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setEvadeAeroEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_EVADE_AERO).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveEvadeAeroEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setRollEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_ROLL).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveRollEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setLaunchEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_LAUNCH).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveLaunchEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setDockEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_DOCK).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveLaunchEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setRecoverEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_RECOVER).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveRecoverEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setDropEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_DROP).setEnabled(enabled);</b>
&nbsp;        // clientgui.getMenuBar().setMoveDropEnabled(enabled);
&nbsp;    }
&nbsp;
&nbsp;    private void setJoinEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_JOIN).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveJoinEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setDumpEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_DUMP).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveDumpEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setRamEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_RAM).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveRamEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setHoverEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_HOVER).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveHoverEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setTakeOffEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_TAKE_OFF).setEnabled(enabled);</b>
&nbsp;        // clientgui.getMenuBar().setMoveTakeOffEnabled(enabled);
&nbsp;    }
&nbsp;
&nbsp;    private void setVTakeOffEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_VERT_TAKE_OFF).setEnabled(enabled);</b>
&nbsp;        // clientgui.getMenuBar().setMoveVTakeOffEnabled(enabled);
&nbsp;    }
&nbsp;
&nbsp;    private void setLandEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_LAND).setEnabled(enabled);</b>
&nbsp;        // clientgui.getMenuBar().setMoveLandEnabled(enabled);
&nbsp;    }
&nbsp;
&nbsp;    private void setVLandEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_VERT_LAND).setEnabled(enabled);</b>
&nbsp;        // clientgui.getMenuBar().setMoveVLandEnabled(enabled);
&nbsp;    }
&nbsp;
&nbsp;    private void setManeuverEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_MANEUVER).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveManeuverEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setTurnLeftEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_TURN_LEFT).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveTurnLeftEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setTurnRightEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_TURN_RIGHT).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveTurnRightEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setThrustEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_THRUST).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveThrustEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setYawEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_YAW).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveYawEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setEndOverEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_END_OVER).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveEndOverEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setStrafeEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_STRAFE).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveStrafeEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setBombEnabled(boolean enabled) {
<b class="nc">&nbsp;        getBtn(MoveCommand.MOVE_BOMB).setEnabled(enabled);</b>
<b class="nc">&nbsp;        clientgui.getMenuBar().setMoveBombEnabled(enabled);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Stop just ignoring events and actually stop listening to them.
&nbsp;     */
&nbsp;    public void removeAllListeners() {
<b class="nc">&nbsp;        if (clientgui != null) {</b>
<b class="nc">&nbsp;            clientgui.getClient().getGame().removeGameListener(this);</b>
<b class="nc">&nbsp;            clientgui.getBoardView().removeBoardViewListener(this);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void updateTurnButton() {
<b class="nc">&nbsp;        final Entity ce = ce();</b>
<b class="nc">&nbsp;        if (null == ce) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setTurnEnabled(!ce.isImmobile()</b>
<b class="nc">&nbsp;                       &amp;&amp; !ce.isStuck()</b>
<b class="nc">&nbsp;                       &amp;&amp; ((ce.getWalkMP() &gt; 0) || (ce.getJumpMP() &gt; 0))</b>
<b class="nc">&nbsp;                       &amp;&amp; !(cmd.isJumping() &amp;&amp; (ce instanceof Mech) &amp;&amp; (ce</b>
<b class="nc">&nbsp;                                                                                .getJumpType() == Mech.JUMP_BOOSTER)));</b>
&nbsp;    }
&nbsp;    
&nbsp;    public void FieldofFire(Entity unit, int[][] ranges, int arc, int loc) {
&nbsp;        // do nothing here outside the movement phase
<b class="nc">&nbsp;        if (!(clientgui.getClient().getGame().getPhase() == Phase.PHASE_MOVEMENT)) return;</b>
&nbsp;        
<b class="nc">&nbsp;        clientgui.bv.fieldofFireUnit = unit;</b>
<b class="nc">&nbsp;        clientgui.bv.fieldofFireRanges = ranges;</b>
<b class="nc">&nbsp;        clientgui.bv.fieldofFireWpArc = arc;</b>
<b class="nc">&nbsp;        clientgui.bv.fieldofFireWpLoc = loc;</b>
&nbsp;        
&nbsp;        // If the unit is the current unit, then work with
&nbsp;        // the current considered movement
<b class="nc">&nbsp;        if (unit.equals(ce())) </b>
<b class="nc">&nbsp;            clientgui.bv.setWeaponFieldofFire(ce(), cmd);</b>
&nbsp;        else
<b class="nc">&nbsp;            clientgui.bv.setWeaponFieldofFire(unit.getFacing(), unit.getPosition());</b>
&nbsp;    }
&nbsp;    
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
