


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > CustomMechDialog</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ui.swing</a>
</div>

<h1>Coverage Summary for Class: CustomMechDialog (megamek.client.ui.swing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CustomMechDialog</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/874)
  </span>
</td>
</tr>
  <tr>
    <td class="name">CustomMechDialog$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/876)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek - Copyright (C) 2000,2001,2002,2003,2004 Ben Mazur (bmazur@sev.org)
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;
&nbsp;/*
&nbsp; * CustomMechDialog.java
&nbsp; *
&nbsp; * Created on March 18, 2002, 2:56 PM
&nbsp; */
&nbsp;
&nbsp;package megamek.client.ui.swing;
&nbsp;
&nbsp;import java.awt.GridBagConstraints;
&nbsp;import java.awt.GridBagLayout;
&nbsp;import java.awt.GridLayout;
&nbsp;import java.awt.Insets;
&nbsp;import java.awt.event.ActionEvent;
&nbsp;import java.awt.event.ActionListener;
&nbsp;import java.awt.event.ItemEvent;
&nbsp;import java.awt.event.ItemListener;
&nbsp;import java.awt.event.WindowAdapter;
&nbsp;import java.awt.event.WindowEvent;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Enumeration;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.TreeSet;
&nbsp;
&nbsp;import javax.swing.JButton;
&nbsp;import javax.swing.JCheckBox;
&nbsp;import javax.swing.JComboBox;
&nbsp;import javax.swing.JLabel;
&nbsp;import javax.swing.JOptionPane;
&nbsp;import javax.swing.JPanel;
&nbsp;import javax.swing.JScrollPane;
&nbsp;import javax.swing.JTabbedPane;
&nbsp;import javax.swing.JTextField;
&nbsp;import javax.swing.SwingConstants;
&nbsp;
&nbsp;import megamek.client.Client;
&nbsp;import megamek.client.ui.GBC;
&nbsp;import megamek.client.ui.Messages;
&nbsp;import megamek.common.Aero;
&nbsp;import megamek.common.BattleArmor;
&nbsp;import megamek.common.Board;
&nbsp;import megamek.common.Configuration;
&nbsp;import megamek.common.Crew;
&nbsp;import megamek.common.Dropship;
&nbsp;import megamek.common.Entity;
&nbsp;import megamek.common.EntityMovementMode;
&nbsp;import megamek.common.EquipmentType;
&nbsp;import megamek.common.GunEmplacement;
&nbsp;import megamek.common.IAero;
&nbsp;import megamek.common.IGame;
&nbsp;import megamek.common.IPlayer;
&nbsp;import megamek.common.Infantry;
&nbsp;import megamek.common.Jumpship;
&nbsp;import megamek.common.LAMPilot;
&nbsp;import megamek.common.LandAirMech;
&nbsp;import megamek.common.Mech;
&nbsp;import megamek.common.MiscType;
&nbsp;import megamek.common.Mounted;
&nbsp;import megamek.common.OffBoardDirection;
&nbsp;import megamek.common.Protomech;
&nbsp;import megamek.common.QuadVee;
&nbsp;import megamek.common.SmallCraft;
&nbsp;import megamek.common.Tank;
&nbsp;import megamek.common.TechConstants;
&nbsp;import megamek.common.WeaponType;
&nbsp;import megamek.common.enums.Gender;
&nbsp;import megamek.common.options.IOption;
&nbsp;import megamek.common.options.IOptionGroup;
&nbsp;import megamek.common.options.OptionsConstants;
&nbsp;import megamek.common.options.PartialRepairs;
&nbsp;import megamek.common.options.PilotOptions;
&nbsp;import megamek.common.options.Quirks;
&nbsp;import megamek.common.options.WeaponQuirks;
&nbsp;import megamek.common.util.fileUtils.MegaMekFile;
&nbsp;import megamek.common.verifier.EntityVerifier;
&nbsp;import megamek.common.verifier.TestAero;
&nbsp;import megamek.common.verifier.TestBattleArmor;
&nbsp;import megamek.common.verifier.TestEntity;
&nbsp;import megamek.common.verifier.TestInfantry;
&nbsp;import megamek.common.verifier.TestMech;
&nbsp;import megamek.common.verifier.TestSupportVehicle;
&nbsp;import megamek.common.verifier.TestTank;
&nbsp;import megamek.common.weapons.bayweapons.ArtilleryBayWeapon;
&nbsp;import megamek.common.weapons.bayweapons.CapitalMissileBayWeapon;
&nbsp;
&nbsp;/**
&nbsp; * A dialog that a player can use to customize his mech before battle.
&nbsp; * Currently, changing pilots, setting up C3 networks, changing ammunition,
&nbsp; * deploying artillery offboard, setting MGs to rapidfire, setting auto-eject is
&nbsp; * supported.
&nbsp; *
&nbsp; * @author Ben
&nbsp; */
&nbsp;public class CustomMechDialog extends ClientDialog implements ActionListener,
&nbsp;        DialogOptionListener, ItemListener {
&nbsp;
&nbsp;    /**
&nbsp;     *
&nbsp;     */
&nbsp;    private static final long serialVersionUID = -6809436986445582731L;
&nbsp;
<b class="nc">&nbsp;    public static int DONE = 0;</b>
<b class="nc">&nbsp;    public static int NEXT = 1;</b>
<b class="nc">&nbsp;    public static int PREV = 2;</b>
&nbsp;
&nbsp;    private CustomPilotView[] panCrewMember;
&nbsp;    private JPanel panDeploy;
&nbsp;    private QuirksPanel panQuirks;
&nbsp;    private JPanel panPartReps;
&nbsp;
&nbsp;    private JPanel panOptions;
&nbsp;    // private JScrollPane scrOptions;
&nbsp;
&nbsp;    private JTabbedPane tabAll;
&nbsp;
<b class="nc">&nbsp;    private final JTextField fldFatigue = new JTextField(3);</b>
<b class="nc">&nbsp;    private JTextField fldInit = new JTextField(3);</b>
<b class="nc">&nbsp;    private JTextField fldCommandInit = new JTextField(3);</b>
<b class="nc">&nbsp;    private JCheckBox chCommander = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labDeploymentRound = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labDeployment&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labDeploymentZone = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labDeploymentZone&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JComboBox&lt;String&gt; choDeploymentRound = new JComboBox&lt;String&gt;();</b>
&nbsp;    
<b class="nc">&nbsp;    private JComboBox&lt;String&gt; choDeploymentZone = new JComboBox&lt;String&gt;();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labDeployShutdown = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labDeployShutdown&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JCheckBox chDeployShutdown = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labDeployProne = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labDeployProne&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JCheckBox chDeployProne = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labDeployHullDown = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labDeployHullDown&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JCheckBox chDeployHullDown = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labHidden = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labHidden&quot;), //$NON-NLS-1$</b>
&nbsp;            SwingConstants.RIGHT);
&nbsp;
<b class="nc">&nbsp;    private JCheckBox chHidden = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labOffBoard = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labOffBoard&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JCheckBox chOffBoard = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labOffBoardDirection = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labOffBoardDirection&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JComboBox&lt;String&gt; choOffBoardDirection = new JComboBox&lt;String&gt;();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labOffBoardDistance = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labOffBoardDistance&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JTextField fldOffBoardDistance = new JTextField(4);</b>
&nbsp;
<b class="nc">&nbsp;    private JButton butOffBoardDistance = new JButton(&quot;0&quot;);</b>
&nbsp;    
<b class="nc">&nbsp;    private JLabel labStartingMode = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labStartingMode&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;    
<b class="nc">&nbsp;    private JComboBox&lt;String&gt; choStartingMode = new JComboBox&lt;&gt;();</b>
&nbsp;       
<b class="nc">&nbsp;    private JLabel labCurrentFuel = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labCurrentFuel&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;    
<b class="nc">&nbsp;    private JTextField fldCurrentFuel = new JTextField(7);</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labStartVelocity = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labStartVelocity&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JTextField fldStartVelocity = new JTextField(3);</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labStartAltitude = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labStartAltitude&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JTextField fldStartAltitude = new JTextField(3);</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labStartHeight = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labStartHeight&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JTextField fldStartHeight = new JTextField(3);</b>
&nbsp;    
<b class="nc">&nbsp;    private JCheckBox chDeployAirborne = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JPanel panButtons = new JPanel();</b>
&nbsp;
<b class="nc">&nbsp;    private JButton butOkay = new JButton(Messages.getString(&quot;Okay&quot;)); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JButton butCancel = new JButton(Messages.getString(&quot;Cancel&quot;)); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;    private JButton butNext = new JButton(Messages.getString(&quot;Next&quot;));</b>
&nbsp;
<b class="nc">&nbsp;    private JButton butPrev = new JButton(Messages.getString(&quot;Previous&quot;));</b>
&nbsp;
&nbsp;    private EquipChoicePanel m_equip;
&nbsp;
<b class="nc">&nbsp;    private JPanel panEquip = new JPanel();</b>
&nbsp;
&nbsp;    private List&lt;Entity&gt; entities;
&nbsp;
&nbsp;    private boolean okay;
&nbsp;
<b class="nc">&nbsp;    private int status = CustomMechDialog.DONE;</b>
&nbsp;
&nbsp;    ClientGUI clientgui;
&nbsp;
&nbsp;    Client client;
&nbsp;
&nbsp;    private PilotOptions options;
&nbsp;    private Quirks quirks;
&nbsp;    private PartialRepairs partReps;
<b class="nc">&nbsp;    private HashMap&lt;Integer, WeaponQuirks&gt; h_wpnQuirks = new HashMap&lt;Integer, WeaponQuirks&gt;();</b>
&nbsp;
<b class="nc">&nbsp;    private ArrayList&lt;DialogOptionComponent&gt; optionComps = new ArrayList&lt;DialogOptionComponent&gt;();</b>
&nbsp;    // private ArrayList&lt;DialogOptionComponent&gt; quirkComps = new
&nbsp;    // ArrayList&lt;DialogOptionComponent&gt;();
<b class="nc">&nbsp;    private ArrayList&lt;DialogOptionComponent&gt; partRepsComps = new ArrayList&lt;DialogOptionComponent&gt;();</b>
&nbsp;    // private HashMap&lt;Integer, ArrayList&lt;DialogOptionComponent&gt;&gt;
&nbsp;    // h_wpnQuirkComps = new HashMap&lt;Integer,
&nbsp;    // ArrayList&lt;DialogOptionComponent&gt;&gt;();
&nbsp;
&nbsp;    private boolean editable;
&nbsp;
<b class="nc">&nbsp;    private OffBoardDirection direction = OffBoardDirection.NONE;</b>
&nbsp;
<b class="nc">&nbsp;    private int distance = 17;</b>
&nbsp;    
<b class="nc">&nbsp;    private int fuel = 0;</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Creates new CustomMechDialog
&nbsp;     */
&nbsp;    public CustomMechDialog(ClientGUI clientgui, Client client, List&lt;Entity&gt; entities,
&nbsp;            boolean editable) {
<b class="nc">&nbsp;        super(clientgui.frame,</b>
<b class="nc">&nbsp;                Messages.getString(&quot;CustomMechDialog.title&quot;), true); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;        this.entities = entities;</b>
<b class="nc">&nbsp;        this.clientgui = clientgui;</b>
<b class="nc">&nbsp;        this.client = client;</b>
&nbsp;
&nbsp;        // Ensure we have at least one passed entity
&nbsp;        //  Anything less makes no sense
<b class="nc">&nbsp;        if (entities.size() &lt; 1) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Must pass at least one Entity!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        boolean multipleEntities = entities.size() &gt; 1;</b>
<b class="nc">&nbsp;        boolean quirksEnabled = clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                .booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS);</b>
<b class="nc">&nbsp;        boolean partialRepairsEnabled = clientgui.getClient().getGame()</b>
<b class="nc">&nbsp;                .getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_PARTIALREPAIRS);</b>
<b class="nc">&nbsp;        final Entity entity = entities.get(0);</b>
<b class="nc">&nbsp;        boolean isAero = true;</b>
<b class="nc">&nbsp;        boolean isMech = true;</b>
<b class="nc">&nbsp;        boolean isShip = true;</b>
<b class="nc">&nbsp;        boolean isVTOL = true;</b>
<b class="nc">&nbsp;        boolean isWiGE = true;</b>
<b class="nc">&nbsp;        boolean isQuadVee = true;</b>
<b class="nc">&nbsp;        boolean isLAM = true;</b>
<b class="nc">&nbsp;        boolean isGlider = true;</b>
<b class="nc">&nbsp;        boolean eligibleForOffBoard = true;</b>
&nbsp;        
<b class="nc">&nbsp;        for (Entity e : entities) {</b>
<b class="nc">&nbsp;            isAero &amp;= (e instanceof Aero) &amp;&amp; !((e instanceof SmallCraft) || (e instanceof Jumpship));</b>
<b class="nc">&nbsp;            isMech &amp;= (e instanceof Mech);</b>
<b class="nc">&nbsp;            isShip &amp;= (e instanceof SmallCraft) || (e instanceof Jumpship);</b>
<b class="nc">&nbsp;            isVTOL &amp;= (e.getMovementMode() == EntityMovementMode.VTOL);</b>
<b class="nc">&nbsp;            isWiGE &amp;= (e instanceof Tank) &amp;&amp; (e.getMovementMode() == EntityMovementMode.WIGE);</b>
<b class="nc">&nbsp;            isQuadVee &amp;= (e instanceof QuadVee);</b>
<b class="nc">&nbsp;            isLAM &amp;= (e instanceof LandAirMech);</b>
<b class="nc">&nbsp;            isGlider &amp;= (e instanceof Protomech) &amp;&amp; (e.getMovementMode() == EntityMovementMode.WIGE);</b>
<b class="nc">&nbsp;            boolean entityEligibleForOffBoard = false;</b>
<b class="nc">&nbsp;            boolean space = clientgui.getClient().getMapSettings().getMedium() == Board.T_SPACE;</b>
&nbsp;            //TODO: This check is good for now, but at some point we want atmospheric flying droppers to be able to lob
&nbsp;            // offboard missiles and we could use it in space for extreme range bearings-only fights, plus Ortillery. 
<b class="nc">&nbsp;            if (!space &amp;&amp; e.getAltitude() == 0) {</b>
&nbsp;                // No need to bother checking weapons if the map and entity don&#39;t meet criteria for offboard units
<b class="nc">&nbsp;                for (Mounted mounted : e.getWeaponList()) {</b>
<b class="nc">&nbsp;                    WeaponType wtype = (WeaponType) mounted.getType();</b>
<b class="nc">&nbsp;                    if (wtype.hasFlag(WeaponType.F_ARTILLERY)</b>
&nbsp;                            || wtype instanceof CapitalMissileBayWeapon) {
<b class="nc">&nbsp;                        entityEligibleForOffBoard = true;</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;            eligibleForOffBoard &amp;= entityEligibleForOffBoard;</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // set up the panels
<b class="nc">&nbsp;        JPanel mainPanel = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;        tabAll = new JTabbedPane();</b>
&nbsp;        
<b class="nc">&nbsp;        JPanel panCrew = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;        panCrewMember = new CustomPilotView[entity.getCrew().getSlotCount()];</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; panCrewMember.length; i++) {</b>
<b class="nc">&nbsp;            panCrewMember[i] = new CustomPilotView(this, entity, i, editable);</b>
&nbsp;        }
<b class="nc">&nbsp;        panDeploy = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;        quirks = entity.getQuirks();</b>
<b class="nc">&nbsp;        panQuirks = new QuirksPanel(entity, quirks, editable, this, h_wpnQuirks);</b>
<b class="nc">&nbsp;        panPartReps = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;        setupEquip();</b>
&nbsp;        
<b class="nc">&nbsp;        mainPanel.add(tabAll,</b>
<b class="nc">&nbsp;                GBC.eol().fill(GridBagConstraints.BOTH).insets(5, 5, 5, 5));</b>
<b class="nc">&nbsp;        mainPanel.add(panButtons, GBC.eol().anchor(GridBagConstraints.CENTER));</b>
&nbsp;
<b class="nc">&nbsp;        JScrollPane scrEquip = new JScrollPane(panEquip);</b>
<b class="nc">&nbsp;        if (!multipleEntities) {</b>
<b class="nc">&nbsp;            if (panCrewMember.length &gt; 1) {</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt; panCrewMember.length; i++) {</b>
<b class="nc">&nbsp;                    tabAll.addTab(entity.getCrew().getCrewType().getRoleName(i),</b>
&nbsp;                            new JScrollPane(panCrewMember[i]));
&nbsp;                }
<b class="nc">&nbsp;                tabAll.addTab(Messages.getString(&quot;CustomMechDialog.tabCrew&quot;), new JScrollPane(panCrew));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                panCrew.add(panCrewMember[0], GBC.eop());</b>
<b class="nc">&nbsp;                tabAll.addTab(Messages.getString(&quot;CustomMechDialog.tabPilot&quot;), new JScrollPane(panCrew));</b>
&nbsp;            }
<b class="nc">&nbsp;            tabAll.addTab(Messages.getString(&quot;CustomMechDialog.tabEquipment&quot;),</b>
&nbsp;                    scrEquip);
&nbsp;        }
<b class="nc">&nbsp;        tabAll.addTab(Messages.getString(&quot;CustomMechDialog.tabDeployment&quot;),</b>
&nbsp;                new JScrollPane(panDeploy));
<b class="nc">&nbsp;        if (quirksEnabled &amp;&amp; !multipleEntities) {</b>
<b class="nc">&nbsp;            JScrollPane scrQuirks = new JScrollPane(panQuirks);</b>
<b class="nc">&nbsp;            scrQuirks.setPreferredSize(scrEquip.getPreferredSize());</b>
<b class="nc">&nbsp;            tabAll.addTab(&quot;Quirks&quot;, scrQuirks);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (partialRepairsEnabled &amp;&amp; !multipleEntities) {</b>
<b class="nc">&nbsp;            tabAll.addTab(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.tabPartialRepairs&quot;),</b>
&nbsp;                    new JScrollPane(panPartReps));
&nbsp;        }
<b class="nc">&nbsp;        getContentPane().add(mainPanel);</b>
&nbsp;
<b class="nc">&nbsp;        options = entity.getCrew().getOptions();</b>
<b class="nc">&nbsp;        partReps = entity.getPartialRepairs();</b>
<b class="nc">&nbsp;        for (Mounted m : entity.getWeaponList()) {</b>
<b class="nc">&nbsp;            h_wpnQuirks.put(entity.getEquipmentNum(m), m.getQuirks());</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        // Also need to consider melee weapons
<b class="nc">&nbsp;        for (Mounted m : entity.getMisc()) {</b>
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_CLUB)) {</b>
<b class="nc">&nbsp;                h_wpnQuirks.put(entity.getEquipmentNum(m), m.getQuirks());</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        this.editable = editable;</b>
&nbsp;        
&nbsp;        // **CREW TAB**//
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FATIGUE)) {</b>
<b class="nc">&nbsp;            panCrew.add(new JLabel(Messages.getString(&quot;CustomMechDialog.labFatigue&quot;), SwingConstants.RIGHT),</b>
<b class="nc">&nbsp;                    GBC.std()); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            panCrew.add(fldFatigue, GBC.eop());</b>
<b class="nc">&nbsp;            fldFatigue.setToolTipText(Messages.getString(&quot;CustomMechDialog.labFatigueToolTip&quot;));</b>
&nbsp;        }
<b class="nc">&nbsp;        fldFatigue.setText(Integer.toString(entity.getCrew().getFatigue()));</b>
&nbsp;
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                .booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</b>
<b class="nc">&nbsp;            panCrew.add(new JLabel(Messages.getString(&quot;CustomMechDialog.labInit&quot;), SwingConstants.RIGHT),</b>
<b class="nc">&nbsp;                    GBC.std()); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            panCrew.add(fldInit, GBC.eop());</b>
&nbsp;        }
<b class="nc">&nbsp;        fldInit.setText(Integer.toString(entity.getCrew().getInitBonus()));</b>
&nbsp;
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_COMMAND_INIT)) {</b>
<b class="nc">&nbsp;            panCrew.add(new JLabel(Messages.getString(&quot;CustomMechDialog.labCommandInit&quot;), SwingConstants.RIGHT),</b>
<b class="nc">&nbsp;                    GBC.std()); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            panCrew.add(fldCommandInit, GBC.eop());</b>
&nbsp;        }
<b class="nc">&nbsp;        fldCommandInit.setText(Integer.toString(entity.getCrew()</b>
<b class="nc">&nbsp;                .getCommandBonus()));</b>
&nbsp;
&nbsp;        // Set up commanders for commander killed victory condition
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                .booleanOption(OptionsConstants.VICTORY_COMMANDER_KILLED)) { //$NON-NLS-1$</b>
<b class="nc">&nbsp;            panCrew.add(new JLabel(Messages.getString(&quot;CustomMechDialog.labCommander&quot;), SwingConstants.RIGHT),</b>
<b class="nc">&nbsp;                    GBC.std()); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            panCrew.add(chCommander, GBC.eol());</b>
<b class="nc">&nbsp;            chCommander.setSelected(entity.isCommander());</b>
&nbsp;        }
<b class="nc">&nbsp;        panOptions = new JPanel(new GridBagLayout());</b>
<b class="nc">&nbsp;        panCrew.add(panOptions, GBC.eop());</b>
&nbsp;
&nbsp;        // **DEPLOYMENT TAB**//
&nbsp;        
<b class="nc">&nbsp;        if (isQuadVee || isLAM) {</b>
<b class="nc">&nbsp;            panDeploy.add(labStartingMode, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(choStartingMode, GBC.eol());</b>
<b class="nc">&nbsp;            choStartingMode.addItemListener(this);</b>
<b class="nc">&nbsp;            labStartingMode.setToolTipText(Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.startingModeToolTip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            choStartingMode.setToolTipText(Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.startingModeToolTip&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            refreshDeployment();</b>
&nbsp;            // Disable conversions for loaded units so we don&#39;t get fighter LAMs in mech bays and vice-versa
<b class="nc">&nbsp;            choStartingMode.setEnabled(entities.get(0).getTransportId() == Entity.NONE);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (isVTOL || isLAM || isGlider) {</b>
<b class="nc">&nbsp;            panDeploy.add(labStartHeight, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(fldStartHeight, GBC.eol());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (isWiGE) {</b>
<b class="nc">&nbsp;            panDeploy.add(new JLabel(Messages.getString(</b>
<b class="nc">&nbsp;                    &quot;CustomMechDialog.labDeployAirborne&quot;), SwingConstants.RIGHT), GBC.std()); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            panDeploy.add(chDeployAirborne, GBC.eol());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (isAero || isLAM || isShip) {</b>
<b class="nc">&nbsp;            panDeploy.add(labStartVelocity, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(fldStartVelocity, GBC.eol());</b>
&nbsp;
<b class="nc">&nbsp;            panDeploy.add(labStartAltitude, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(fldStartAltitude, GBC.eol());</b>
&nbsp;                        
<b class="nc">&nbsp;            panDeploy.add(labCurrentFuel, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(fldCurrentFuel, GBC.eol());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        choDeploymentRound.addItemListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        panDeploy.add(labDeploymentRound, GBC.std());</b>
<b class="nc">&nbsp;        panDeploy.add(choDeploymentRound, GBC.eol());</b>
<b class="nc">&nbsp;        panDeploy.add(labDeploymentZone, GBC.std());</b>
<b class="nc">&nbsp;        panDeploy.add(choDeploymentZone, GBC.eol());</b>
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                .booleanOption(OptionsConstants.RPG_BEGIN_SHUTDOWN)</b>
&nbsp;                &amp;&amp; !(entity instanceof Infantry)
&nbsp;                &amp;&amp; !(entity instanceof GunEmplacement)) {
<b class="nc">&nbsp;            panDeploy.add(labDeployShutdown, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(chDeployShutdown, GBC.eol());</b>
<b class="nc">&nbsp;            chDeployShutdown.setSelected(entity.isManualShutdown());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (isMech) {</b>
<b class="nc">&nbsp;            panDeploy.add(labDeployHullDown, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(chDeployHullDown, GBC.eol());</b>
<b class="nc">&nbsp;            chDeployHullDown.setSelected(entity.isHullDown()</b>
<b class="nc">&nbsp;                    &amp;&amp; !entity.isProne());</b>
<b class="nc">&nbsp;            chDeployHullDown.addItemListener(this);</b>
&nbsp;
<b class="nc">&nbsp;            panDeploy.add(labDeployProne, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(chDeployProne, GBC.eol());</b>
<b class="nc">&nbsp;            chDeployProne.setSelected(entity.isProne() &amp;&amp; !entity.isHullDown());</b>
<b class="nc">&nbsp;            chDeployProne.addItemListener(this);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        refreshDeployment();</b>
&nbsp;
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                .booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</b>
<b class="nc">&nbsp;            panDeploy.add(labHidden, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(chHidden, GBC.eol());</b>
<b class="nc">&nbsp;            chHidden.setSelected(entity.isHidden());</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (eligibleForOffBoard) {</b>
<b class="nc">&nbsp;            panDeploy.add(labOffBoard, GBC.std());</b>
<b class="nc">&nbsp;            panDeploy.add(chOffBoard, GBC.eol());</b>
<b class="nc">&nbsp;            chOffBoard.setSelected(entity.isOffBoard());</b>
&nbsp;
<b class="nc">&nbsp;            panDeploy.add(labOffBoardDirection, GBC.std());</b>
&nbsp;
<b class="nc">&nbsp;            choOffBoardDirection.addItem(Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.North&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            choOffBoardDirection.addItem(Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.South&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            choOffBoardDirection.addItem(Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.East&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            choOffBoardDirection.addItem(Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.West&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            direction = entity.getOffBoardDirection();</b>
<b class="nc">&nbsp;            if (OffBoardDirection.NONE == direction) {</b>
<b class="nc">&nbsp;                direction = OffBoardDirection.NORTH;</b>
&nbsp;            }
<b class="nc">&nbsp;            choOffBoardDirection.setSelectedIndex(direction.getValue());</b>
<b class="nc">&nbsp;            panDeploy.add(choOffBoardDirection, GBC.eol());</b>
&nbsp;
<b class="nc">&nbsp;            panDeploy.add(labOffBoardDistance, GBC.std());</b>
&nbsp;
<b class="nc">&nbsp;            butOffBoardDistance.addActionListener(this);</b>
<b class="nc">&nbsp;            butOffBoardDistance.setText(Integer.toString(distance));</b>
<b class="nc">&nbsp;            panDeploy.add(butOffBoardDistance, GBC.eol());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setupButtons();</b>
&nbsp;
<b class="nc">&nbsp;        if (isAero || isLAM || isShip) {</b>
<b class="nc">&nbsp;            IAero a = (IAero) entity;</b>
<b class="nc">&nbsp;            fldStartVelocity.setText(Integer.valueOf(a.getCurrentVelocity())</b>
<b class="nc">&nbsp;                    .toString());</b>
<b class="nc">&nbsp;            fldStartVelocity.addActionListener(this);</b>
&nbsp;
<b class="nc">&nbsp;            fldStartAltitude.setText(Integer.valueOf(entity.getAltitude()).toString());</b>
<b class="nc">&nbsp;            fldStartAltitude.addActionListener(this);</b>
&nbsp;            
<b class="nc">&nbsp;            fuel = a.getFuel();</b>
<b class="nc">&nbsp;            fldCurrentFuel.setText(Integer.valueOf(a.getCurrentFuel())</b>
<b class="nc">&nbsp;                    .toString());</b>
<b class="nc">&nbsp;            fldCurrentFuel.addActionListener(this);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (isVTOL || isLAM || isGlider) {</b>
<b class="nc">&nbsp;            fldStartHeight.setText(Integer.valueOf(entity.getElevation()).toString());</b>
<b class="nc">&nbsp;            fldStartHeight.addActionListener(this);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (isWiGE) {</b>
<b class="nc">&nbsp;            chDeployAirborne.setSelected(entity.getElevation() &gt; 0);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!editable) {</b>
<b class="nc">&nbsp;            fldFatigue.setEnabled(false);</b>
<b class="nc">&nbsp;            fldInit.setEnabled(false);</b>
<b class="nc">&nbsp;            fldCommandInit.setEnabled(false);</b>
<b class="nc">&nbsp;            chCommander.setEnabled(false);</b>
<b class="nc">&nbsp;            choDeploymentRound.setEnabled(false);</b>
<b class="nc">&nbsp;            chDeployShutdown.setEnabled(false);</b>
<b class="nc">&nbsp;            chDeployProne.setEnabled(false);</b>
<b class="nc">&nbsp;            chDeployHullDown.setEnabled(false);</b>
<b class="nc">&nbsp;            chCommander.setEnabled(false);</b>
<b class="nc">&nbsp;            chHidden.setEnabled(false);</b>
<b class="nc">&nbsp;            chOffBoard.setEnabled(false);</b>
<b class="nc">&nbsp;            choOffBoardDirection.setEnabled(false);</b>
<b class="nc">&nbsp;            fldOffBoardDistance.setEnabled(false);</b>
<b class="nc">&nbsp;            fldStartVelocity.setEnabled(false);</b>
<b class="nc">&nbsp;            fldStartAltitude.setEnabled(false);</b>
<b class="nc">&nbsp;            fldCurrentFuel.setEnabled(false);</b>
<b class="nc">&nbsp;            fldStartHeight.setEnabled(false);</b>
<b class="nc">&nbsp;            chDeployAirborne.setEnabled(false);</b>
<b class="nc">&nbsp;            m_equip.initialize();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        addWindowListener(new WindowAdapter() {</b>
&nbsp;            @Override
&nbsp;            public void windowClosing(WindowEvent e) {
<b class="nc">&nbsp;                setVisible(false);</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        pack();</b>
<b class="nc">&nbsp;        mainPanel.setSize(mainPanel.getSize().width,</b>
<b class="nc">&nbsp;                Math.min(mainPanel.getSize().height, 400));</b>
<b class="nc">&nbsp;        setResizable(true);</b>
<b class="nc">&nbsp;        setLocationRelativeTo(clientgui);</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getSelectedTab() {
<b class="nc">&nbsp;        return tabAll.getTitleAt(tabAll.getSelectedIndex());</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setSelectedTab(int idx) {
<b class="nc">&nbsp;        if (idx &lt; tabAll.getTabCount()) {</b>
<b class="nc">&nbsp;            tabAll.setSelectedIndex(idx);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    public void setSelectedTab(String tabName) {
<b class="nc">&nbsp;        for (int i = 0; i &lt; tabAll.getTabCount(); i++) {</b>
<b class="nc">&nbsp;            if (tabAll.getTitleAt(i).equals(tabName)) {</b>
<b class="nc">&nbsp;                tabAll.setSelectedIndex(i);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public ClientGUI getClientGUI() {
<b class="nc">&nbsp;        return clientgui;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setupButtons() {
<b class="nc">&nbsp;        butOkay.addActionListener(this);</b>
<b class="nc">&nbsp;        butCancel.addActionListener(this);</b>
<b class="nc">&nbsp;        butNext.addActionListener(this);</b>
<b class="nc">&nbsp;        butPrev.addActionListener(this);</b>
&nbsp;
&nbsp;        // layout
<b class="nc">&nbsp;        panButtons.setLayout(new GridLayout(1, 4, 10, 0));</b>
<b class="nc">&nbsp;        panButtons.add(butPrev);</b>
<b class="nc">&nbsp;        panButtons.add(butOkay);</b>
<b class="nc">&nbsp;        panButtons.add(butCancel);</b>
<b class="nc">&nbsp;        panButtons.add(butNext);</b>
&nbsp;
<b class="nc">&nbsp;        butNext.setEnabled(getNextEntity(true) != null);</b>
<b class="nc">&nbsp;        butPrev.setEnabled(getNextEntity(false) != null);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setOptions() {
<b class="nc">&nbsp;        Entity entity = entities.get(0);</b>
&nbsp;        IOption option;
<b class="nc">&nbsp;        for (final Object newVar : optionComps) {</b>
<b class="nc">&nbsp;            DialogOptionComponent comp = (DialogOptionComponent) newVar;</b>
<b class="nc">&nbsp;            option = comp.getOption();</b>
<b class="nc">&nbsp;            if ((comp.getValue() == Messages.getString(&quot;CustomMechDialog.None&quot;))) { // NON-NLS-$1</b>
<b class="nc">&nbsp;                entity.getCrew().getOptions().getOption(option.getName())</b>
<b class="nc">&nbsp;                        .setValue(&quot;None&quot;); // NON-NLS-$1</b>
&nbsp;            } else {
<b class="nc">&nbsp;                entity.getCrew().getOptions().getOption(option.getName())</b>
<b class="nc">&nbsp;                        .setValue(comp.getValue());</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public void refreshOptions() {
<b class="nc">&nbsp;        panOptions.removeAll();</b>
<b class="nc">&nbsp;        optionComps = new ArrayList&lt;DialogOptionComponent&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        GridBagLayout gridbag = new GridBagLayout();</b>
<b class="nc">&nbsp;        GridBagConstraints c = new GridBagConstraints();</b>
<b class="nc">&nbsp;        panOptions.setLayout(gridbag);</b>
&nbsp;
<b class="nc">&nbsp;        c.gridwidth = GridBagConstraints.REMAINDER;</b>
<b class="nc">&nbsp;        c.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        c.insets = new Insets(0, 0, 0, 0);</b>
<b class="nc">&nbsp;        c.ipadx = 0;</b>
<b class="nc">&nbsp;        c.ipady = 0;</b>
&nbsp;
<b class="nc">&nbsp;        for (Enumeration&lt;IOptionGroup&gt; i = options.getGroups(); i</b>
<b class="nc">&nbsp;                .hasMoreElements();) {</b>
<b class="nc">&nbsp;            IOptionGroup group = i.nextElement();</b>
&nbsp;
<b class="nc">&nbsp;            if (group.getKey().equalsIgnoreCase(PilotOptions.LVL3_ADVANTAGES)</b>
<b class="nc">&nbsp;                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                            .booleanOption(OptionsConstants.RPG_PILOT_ADVANTAGES)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (group.getKey().equalsIgnoreCase(PilotOptions.EDGE_ADVANTAGES)</b>
<b class="nc">&nbsp;                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                            .booleanOption(OptionsConstants.EDGE)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (group.getKey().equalsIgnoreCase(PilotOptions.MD_ADVANTAGES)</b>
<b class="nc">&nbsp;                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                            .booleanOption(OptionsConstants.RPG_MANEI_DOMINI)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            addGroup(group, gridbag, c);</b>
&nbsp;
<b class="nc">&nbsp;            Entity entity = entities.get(0);</b>
<b class="nc">&nbsp;            for (Enumeration&lt;IOption&gt; j = group.getOptions(); j</b>
<b class="nc">&nbsp;                    .hasMoreElements();) {</b>
<b class="nc">&nbsp;                IOption option = j.nextElement();</b>
&nbsp;
<b class="nc">&nbsp;                if (entity instanceof GunEmplacement) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // a bunch of stuf should get disabled for conv infantry
<b class="nc">&nbsp;                if ((((entity instanceof Infantry) &amp;&amp; !(entity instanceof BattleArmor)))</b>
<b class="nc">&nbsp;                        &amp;&amp; (option.getName().equals(OptionsConstants.MD_VDNI) || option.getName()</b>
<b class="nc">&nbsp;                                .equals(OptionsConstants.MD_BVDNI))) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // a bunch of stuff should get disabled for all but conventional
&nbsp;                // infantry
<b class="nc">&nbsp;                if (!((entity instanceof Infantry) &amp;&amp; !(entity instanceof BattleArmor))</b>
<b class="nc">&nbsp;                        &amp;&amp; (option.getName().equals(OptionsConstants.MD_PL_ENHANCED)</b>
<b class="nc">&nbsp;                                || option.getName().equals(OptionsConstants.MD_PL_MASC)</b>
<b class="nc">&nbsp;                                || option.getName().equals(OptionsConstants.MD_CYBER_IMP_AUDIO) || option</b>
<b class="nc">&nbsp;                                .getName().equals(OptionsConstants.MD_CYBER_IMP_VISUAL))) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                addOption(option, gridbag, c, editable);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        validate();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setPartReps() {
<b class="nc">&nbsp;        Entity entity = entities.get(0);</b>
&nbsp;        IOption option;
<b class="nc">&nbsp;        for (final Object newVar : partRepsComps) {</b>
<b class="nc">&nbsp;            DialogOptionComponent comp = (DialogOptionComponent) newVar;</b>
<b class="nc">&nbsp;            option = comp.getOption();</b>
<b class="nc">&nbsp;            if ((comp.getValue() == Messages.getString(&quot;CustomMechDialog.None&quot;))) { // NON-NLS-$1</b>
<b class="nc">&nbsp;                entity.getPartialRepairs().getOption(option.getName())</b>
<b class="nc">&nbsp;                        .setValue(&quot;None&quot;); // NON-NLS-$1</b>
&nbsp;            } else {
<b class="nc">&nbsp;                entity.getPartialRepairs().getOption(option.getName())</b>
<b class="nc">&nbsp;                        .setValue(comp.getValue());</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private void setQuirks() {
<b class="nc">&nbsp;        panQuirks.setQuirks();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void refreshPartReps() {
<b class="nc">&nbsp;        Entity entity = entities.get(0);</b>
<b class="nc">&nbsp;        panPartReps.removeAll();</b>
<b class="nc">&nbsp;        partRepsComps = new ArrayList&lt;DialogOptionComponent&gt;();</b>
<b class="nc">&nbsp;        for (Enumeration&lt;IOptionGroup&gt; i = partReps.getGroups(); i</b>
<b class="nc">&nbsp;                .hasMoreElements();) {</b>
<b class="nc">&nbsp;            IOptionGroup group = i.nextElement();</b>
<b class="nc">&nbsp;            panPartReps.add(new JLabel(group.getDisplayableName()), GBC.eol());</b>
&nbsp;
<b class="nc">&nbsp;            for (Enumeration&lt;IOption&gt; j = group.getSortedOptions(); j</b>
<b class="nc">&nbsp;                    .hasMoreElements();) {</b>
<b class="nc">&nbsp;                IOption option = j.nextElement();</b>
&nbsp;
<b class="nc">&nbsp;                if (!PartialRepairs.isPartRepLegalFor(option, entity)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                addPartRep(option, editable);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        validate();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void refreshQuirks() {
<b class="nc">&nbsp;        panQuirks.refreshQuirks();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void addGroup(IOptionGroup group, GridBagLayout gridbag,
&nbsp;            GridBagConstraints c) {
<b class="nc">&nbsp;        JLabel groupLabel = new JLabel(group.getDisplayableName());</b>
&nbsp;
<b class="nc">&nbsp;        gridbag.setConstraints(groupLabel, c);</b>
<b class="nc">&nbsp;        panOptions.add(groupLabel);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void addOption(IOption option, GridBagLayout gridbag, GridBagConstraints c, boolean editable) {
<b class="nc">&nbsp;        Entity entity = entities.get(0);</b>
<b class="nc">&nbsp;        DialogOptionComponent optionComp = new DialogOptionComponent(this, option, editable);</b>
&nbsp;
<b class="nc">&nbsp;        if ((OptionsConstants.GUNNERY_WEAPON_SPECIALIST).equals(option.getName())) { // $NON-NLS-1$</b>
<b class="nc">&nbsp;            optionComp.addValue(Messages.getString(&quot;CustomMechDialog.None&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            TreeSet&lt;String&gt; uniqueWeapons = new TreeSet&lt;String&gt;();</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; entity.getWeaponList().size(); i++) {</b>
<b class="nc">&nbsp;                Mounted m = entity.getWeaponList().get(i);</b>
<b class="nc">&nbsp;                uniqueWeapons.add(m.getName());</b>
&nbsp;            }
<b class="nc">&nbsp;            for (String name : uniqueWeapons) {</b>
<b class="nc">&nbsp;                optionComp.addValue(name);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            optionComp.setSelected(option.stringValue());</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if ((OptionsConstants.GUNNERY_SANDBLASTER).equals(option.getName())) { // $NON-NLS-1$</b>
<b class="nc">&nbsp;            optionComp.addValue(Messages.getString(&quot;CustomMechDialog.None&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            TreeSet&lt;String&gt; uniqueWeapons = new TreeSet&lt;String&gt;();</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; entity.getWeaponList().size(); i++) {</b>
<b class="nc">&nbsp;                Mounted m = entity.getWeaponList().get(i);</b>
<b class="nc">&nbsp;                uniqueWeapons.add(m.getName());</b>
&nbsp;            }
<b class="nc">&nbsp;            for (String name : uniqueWeapons) {</b>
<b class="nc">&nbsp;                optionComp.addValue(name);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            optionComp.setSelected(option.stringValue());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (OptionsConstants.GUNNERY_SPECIALIST               </b>
<b class="nc">&nbsp;                .equals(option.getName())) { //$NON-NLS-1$</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.SPECIAL_NONE);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.SPECIAL_ENERGY);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.SPECIAL_BALLISTIC);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.SPECIAL_MISSILE);</b>
<b class="nc">&nbsp;            optionComp.setSelected(option.stringValue());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (OptionsConstants.GUNNERY_RANGE_MASTER.equals(option.getName())) { //$NON-NLS-1$</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.RANGEMASTER_NONE);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.RANGEMASTER_MEDIUM);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.RANGEMASTER_LONG);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.RANGEMASTER_EXTREME);</b>
<b class="nc">&nbsp;            optionComp.setSelected(option.stringValue());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (OptionsConstants.MISC_HUMAN_TRO.equals(option.getName())) { //$NON-NLS-1$</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.HUMANTRO_NONE);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.HUMANTRO_MECH);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.HUMANTRO_AERO);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.HUMANTRO_VEE);</b>
<b class="nc">&nbsp;            optionComp.addValue(Crew.HUMANTRO_BA);</b>
<b class="nc">&nbsp;            optionComp.setSelected(option.stringValue());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        gridbag.setConstraints(optionComp, c);</b>
<b class="nc">&nbsp;        panOptions.add(optionComp);</b>
&nbsp;
<b class="nc">&nbsp;        optionComps.add(optionComp);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void addPartRep(IOption option, boolean editable) {
<b class="nc">&nbsp;        DialogOptionComponent optionComp = new DialogOptionComponent(this,</b>
&nbsp;                option, editable);
<b class="nc">&nbsp;        panPartReps.add(optionComp, GBC.eol());</b>
<b class="nc">&nbsp;        partRepsComps.add(optionComp);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void optionClicked(DialogOptionComponent comp, IOption option,
&nbsp;            boolean state) {
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public boolean isOkay() {
<b class="nc">&nbsp;        return okay;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getStatus() {
<b class="nc">&nbsp;        return status;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void refreshDeployment() {
<b class="nc">&nbsp;        Entity entity = entities.get(0);</b>
&nbsp;        
<b class="nc">&nbsp;        if (entity instanceof QuadVee) {</b>
<b class="nc">&nbsp;            choStartingMode.removeItemListener(this);</b>
<b class="nc">&nbsp;            choStartingMode.removeAllItems();</b>
<b class="nc">&nbsp;            choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeQuad&quot;));</b>
<b class="nc">&nbsp;            choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeVehicle&quot;));</b>
<b class="nc">&nbsp;            if (entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE) {</b>
<b class="nc">&nbsp;                choStartingMode.setSelectedIndex(1);</b>
&nbsp;            }
<b class="nc">&nbsp;            updateStartingModeOptions();</b>
<b class="nc">&nbsp;            choStartingMode.addItemListener(this);</b>
<b class="nc">&nbsp;        } else if (entity instanceof LandAirMech) {</b>
<b class="nc">&nbsp;            choStartingMode.removeItemListener(this);</b>
<b class="nc">&nbsp;            choStartingMode.removeAllItems();</b>
<b class="nc">&nbsp;            choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeBiped&quot;));</b>
<b class="nc">&nbsp;            if (((LandAirMech)entity).getLAMType() != LandAirMech.LAM_BIMODAL) {</b>
<b class="nc">&nbsp;                choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeAirMech&quot;));</b>
&nbsp;            }
<b class="nc">&nbsp;            choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeFighter&quot;));</b>
<b class="nc">&nbsp;            if (entity.getConversionMode() == LandAirMech.CONV_MODE_AIRMECH) {</b>
<b class="nc">&nbsp;                choStartingMode.setSelectedIndex(1);</b>
<b class="nc">&nbsp;            } else if (entity.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER) {</b>
<b class="nc">&nbsp;                choStartingMode.setSelectedIndex(choStartingMode.getItemCount() - 1);</b>
&nbsp;            }
<b class="nc">&nbsp;            updateStartingModeOptions();</b>
<b class="nc">&nbsp;            choStartingMode.addItemListener(this);</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        choDeploymentRound.removeItemListener(this);</b>
&nbsp;        
<b class="nc">&nbsp;        choDeploymentRound.removeAllItems();</b>
<b class="nc">&nbsp;        choDeploymentRound.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.StartOfGame&quot;)); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;        if (entity.getDeployRound() &lt; 1) {</b>
<b class="nc">&nbsp;            choDeploymentRound.setSelectedIndex(0);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        for (int i = 1; i &lt;= 40; i++) {</b>
<b class="nc">&nbsp;            choDeploymentRound.addItem(Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.AfterRound&quot;) + i); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;            if (entity.getDeployRound() == i) {</b>
<b class="nc">&nbsp;                choDeploymentRound.setSelectedIndex(i);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (entity.getTransportId() != Entity.NONE) {</b>
<b class="nc">&nbsp;            choDeploymentRound.setEnabled(false);</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        choDeploymentZone.removeAllItems();</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.useOwners&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deployAny&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deployNW&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deployN&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deployNE&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deployE&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deploySE&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deployS&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deploySW&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deployW&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deployEdge&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        choDeploymentZone.addItem(Messages</b>
<b class="nc">&nbsp;                .getString(&quot;CustomMechDialog.deployCenter&quot;)); //$NON-NLS-1$</b>
&nbsp;        
<b class="nc">&nbsp;        if (entity.getDeployRound() == 0) {</b>
<b class="nc">&nbsp;            choDeploymentZone.setEnabled(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            choDeploymentZone.setEnabled(true);</b>
&nbsp;        }
<b class="nc">&nbsp;        choDeploymentZone.setSelectedIndex(entity.getStartingPos(false) + 1);</b>
&nbsp;        
<b class="nc">&nbsp;        choDeploymentRound.addItemListener(this);</b>
&nbsp;
<b class="nc">&nbsp;        chHidden.removeActionListener(this);</b>
<b class="nc">&nbsp;        boolean enableHidden = true;</b>
&nbsp;        // Airborne units can&#39;t be hidden
<b class="nc">&nbsp;        if (entity.isAirborne() || entity.isAirborneVTOLorWIGE()) {</b>
<b class="nc">&nbsp;            enableHidden = false;</b>
&nbsp;        }
&nbsp;        // Landed dropships can&#39;t be hidden
<b class="nc">&nbsp;        if ((entity instanceof Dropship)) {</b>
<b class="nc">&nbsp;            enableHidden = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        labHidden.setEnabled(enableHidden);</b>
<b class="nc">&nbsp;        chHidden.setEnabled(enableHidden);</b>
<b class="nc">&nbsp;        chHidden.addActionListener(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void actionPerformed(ActionEvent actionEvent) {
&nbsp;
<b class="nc">&nbsp;        if (actionEvent.getSource().equals(butOffBoardDistance)) {</b>
&nbsp;            // We&#39;ll allow the player to deploy at the maximum possible
&nbsp;            // effective range, even if many of the unit&#39;s weapons would be out of range
<b class="nc">&nbsp;            int maxDistance = 0;</b>
<b class="nc">&nbsp;            for (Entity entity : entities) {</b>
<b class="nc">&nbsp;                for (Mounted wep : entity.getWeaponList()) {</b>
<b class="nc">&nbsp;                    EquipmentType e = wep.getType();</b>
<b class="nc">&nbsp;                    WeaponType w = (WeaponType) e;</b>
<b class="nc">&nbsp;                    int nDistance = 0;</b>
<b class="nc">&nbsp;                    if (w.hasFlag(WeaponType.F_ARTILLERY)) {</b>
<b class="nc">&nbsp;                        if (w instanceof ArtilleryBayWeapon) {</b>
&nbsp;                            // Artillery bays can mix and match, so limit the bay
&nbsp;                            // to the shortest range of the weapons in it
<b class="nc">&nbsp;                            int bayShortestRange = 150; // Cruise missile/120</b>
<b class="nc">&nbsp;                            for (int wId : wep.getBayWeapons()) {</b>
<b class="nc">&nbsp;                                Mounted bweap = entity.getEquipment(wId);</b>
<b class="nc">&nbsp;                                WeaponType bwtype = (WeaponType) bweap.getType();</b>
&nbsp;                                // Max TO range in mapsheets - 1 for the actual play area
<b class="nc">&nbsp;                                int currentDistance = (bwtype.getLongRange() - 1);</b>
<b class="nc">&nbsp;                                if (currentDistance &lt; bayShortestRange) {</b>
<b class="nc">&nbsp;                                    bayShortestRange = currentDistance;</b>
&nbsp;                                }
<b class="nc">&nbsp;                            }</b>
<b class="nc">&nbsp;                            nDistance = bayShortestRange;</b>
<b class="nc">&nbsp;                        } else {</b>
&nbsp;                            // Max TO range in mapsheets - 1 for the actual play area
<b class="nc">&nbsp;                            nDistance = (w.getLongRange() - 1);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    } else if (w.isCapital() || w.isSubCapital()) {</b>
&nbsp;                        // Capital weapons use their maximum space hex range as the mapsheet range
<b class="nc">&nbsp;                        if (w.getMaxRange(wep) == WeaponType.RANGE_EXT) {</b>
<b class="nc">&nbsp;                            nDistance = 50;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (w.getMaxRange(wep) == WeaponType.RANGE_LONG) {</b>
<b class="nc">&nbsp;                            nDistance = 40;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (w.getMaxRange(wep) == WeaponType.RANGE_MED) {</b>
<b class="nc">&nbsp;                            nDistance = 24;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (w.getMaxRange(wep) == WeaponType.RANGE_SHORT) {</b>
<b class="nc">&nbsp;                            nDistance = 12;</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                    // Now, convert to mapsheets
<b class="nc">&nbsp;                    nDistance = nDistance * Board.DEFAULT_BOARD_HEIGHT;</b>
&nbsp;                    // And set our maximum slider hex distance based on the calculations
<b class="nc">&nbsp;                    if (nDistance &gt; maxDistance) {</b>
<b class="nc">&nbsp;                        maxDistance = nDistance;</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;                
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            Slider sl = new Slider(</b>
&nbsp;                    clientgui.frame,
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.offboardDistanceTitle&quot;),</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.offboardDistanceQuestion&quot;),</b>
<b class="nc">&nbsp;                    Math.min(</b>
<b class="nc">&nbsp;                            Math.max(entities.get(0).getOffBoardDistance(), 17),</b>
&nbsp;                            maxDistance), 17, maxDistance);
<b class="nc">&nbsp;            if (!sl.showDialog()) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            distance = sl.getValue();</b>
<b class="nc">&nbsp;            butOffBoardDistance.setText(Integer.toString(distance));</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (actionEvent.getSource().equals(butCancel)) {</b>
<b class="nc">&nbsp;            setVisible(false);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (actionEvent.getSource().equals(chHidden)) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (actionEvent.getActionCommand().equals(&quot;missing&quot;)) {</b>
&nbsp;            //If we&#39;re down to a single crew member, do not allow any more to be removed.
<b class="nc">&nbsp;            final long remaining = Arrays.stream(panCrewMember).filter(p -&gt; !p.getMissing()).count();</b>
<b class="nc">&nbsp;            for (CustomPilotView v : panCrewMember) {</b>
<b class="nc">&nbsp;                v.enableMissing(remaining &gt; 1 || v.getMissing());</b>
&nbsp;            }
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Set instanceof flags
&nbsp;        String msg, title;
<b class="nc">&nbsp;        boolean isAero = true;</b>
<b class="nc">&nbsp;        boolean isShip = true;</b>
<b class="nc">&nbsp;        boolean isVTOL = true;</b>
<b class="nc">&nbsp;        boolean isWiGE = true;</b>
<b class="nc">&nbsp;        boolean isQuadVee = true;</b>
<b class="nc">&nbsp;        boolean isLAM = true;</b>
<b class="nc">&nbsp;        boolean isAirMech = true;</b>
<b class="nc">&nbsp;        boolean isGlider = true;         </b>
<b class="nc">&nbsp;        for (Entity e : entities) {</b>
<b class="nc">&nbsp;            isAero &amp;= ((e instanceof Aero) &amp;&amp; !((e instanceof SmallCraft) || (e instanceof Jumpship)))</b>
&nbsp;                    || ((e instanceof LandAirMech)
<b class="nc">&nbsp;                        &amp;&amp; (choStartingMode.getSelectedIndex() == 2</b>
<b class="nc">&nbsp;                            || ((LandAirMech)e).getLAMType() == LandAirMech.LAM_BIMODAL</b>
<b class="nc">&nbsp;                                &amp;&amp; choStartingMode.getSelectedIndex() == 1));</b>
<b class="nc">&nbsp;            isShip &amp;= (e instanceof SmallCraft) || (e instanceof Jumpship);</b>
<b class="nc">&nbsp;            isVTOL &amp;= (e.getMovementMode() == EntityMovementMode.VTOL);</b>
<b class="nc">&nbsp;            isWiGE &amp;= (e instanceof Tank) &amp;&amp; (e.getMovementMode() == EntityMovementMode.WIGE);</b>
<b class="nc">&nbsp;            isQuadVee &amp;= (e instanceof QuadVee);</b>
<b class="nc">&nbsp;            isLAM &amp;= (e instanceof LandAirMech);</b>
<b class="nc">&nbsp;            isAirMech &amp;= (e instanceof LandAirMech)</b>
<b class="nc">&nbsp;                    &amp;&amp; (((LandAirMech)e).getLAMType() == LandAirMech.LAM_STANDARD)</b>
<b class="nc">&nbsp;                    &amp;&amp; (choStartingMode.getSelectedIndex() == 1);</b>
<b class="nc">&nbsp;            isGlider &amp;= (e instanceof Protomech) &amp;&amp; (e.getMovementMode() == EntityMovementMode.WIGE);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // get values
<b class="nc">&nbsp;        int fatigue = 0;</b>
<b class="nc">&nbsp;        int init = 0;</b>
<b class="nc">&nbsp;        int command = 0;</b>
<b class="nc">&nbsp;        int velocity = 0;</b>
<b class="nc">&nbsp;        int altitude = 0;</b>
<b class="nc">&nbsp;        int currentfuel = 0;</b>
<b class="nc">&nbsp;        int height = 0;</b>
&nbsp;        int offBoardDistance;
&nbsp;        try {
<b class="nc">&nbsp;            init = Integer.parseInt(fldInit.getText());</b>
<b class="nc">&nbsp;            fatigue = Integer.parseInt(fldFatigue.getText());</b>
<b class="nc">&nbsp;            command = Integer.parseInt(fldCommandInit.getText());</b>
<b class="nc">&nbsp;            if (isAero || isShip) {</b>
<b class="nc">&nbsp;                velocity = Integer.parseInt(fldStartVelocity.getText());</b>
<b class="nc">&nbsp;                altitude = Integer.parseInt(fldStartAltitude.getText());</b>
<b class="nc">&nbsp;                currentfuel = Integer.parseInt(fldCurrentFuel.getText());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (isVTOL || isAirMech) {</b>
<b class="nc">&nbsp;                height = Integer.parseInt(fldStartHeight.getText());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (isWiGE) {</b>
<b class="nc">&nbsp;                height = chDeployAirborne.isSelected()? 1 : 0;</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (NumberFormatException e) {</b>
<b class="nc">&nbsp;            msg = Messages.getString(&quot;CustomMechDialog.EnterValidSkills&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            title = Messages.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(clientgui.frame, msg, title,</b>
&nbsp;                    JOptionPane.ERROR_MESSAGE);
&nbsp;            return;
<b class="nc">&nbsp;        }</b>
&nbsp;        
<b class="nc">&nbsp;        if (isAero || isShip) {</b>
<b class="nc">&nbsp;            if ((velocity &gt; (2 * entities.get(0).getWalkMP()))</b>
&nbsp;                    || (velocity &lt; 0)) {
<b class="nc">&nbsp;                msg = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;CustomMechDialog.EnterCorrectVelocity&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                title = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                JOptionPane.showMessageDialog(clientgui.frame, msg, title,</b>
&nbsp;                        JOptionPane.ERROR_MESSAGE);
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            if ((altitude &lt; 0) || (altitude &gt; 10)) {</b>
<b class="nc">&nbsp;                msg = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;CustomMechDialog.EnterCorrectAltitude&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                title = Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                JOptionPane.showMessageDialog(clientgui.frame, msg, title,</b>
&nbsp;                        JOptionPane.ERROR_MESSAGE);
&nbsp;                return;
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if ((currentfuel &lt; 0) || (currentfuel &gt; fuel)) {</b>
<b class="nc">&nbsp;            	msg = (Messages</b>
<b class="nc">&nbsp;            			 .getString(&quot;CustomMechDialog.EnterCorrectFuel&quot;) + fuel + &quot;.&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            	title = Messages</b>
<b class="nc">&nbsp;            			.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            	JOptionPane.showMessageDialog(clientgui.frame, msg, title,</b>
&nbsp;            			JOptionPane.ERROR_MESSAGE);
&nbsp;            	return;
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if ((isVTOL &amp;&amp; height &gt; 50)</b>
&nbsp;                || (isAirMech &amp;&amp; height &gt; 25)
&nbsp;                || (isGlider &amp;&amp; height &gt; 12)) {
<b class="nc">&nbsp;            msg = Messages.getString(&quot;CustomMechDialog.EnterCorrectHeight&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            title = Messages.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(clientgui.frame, msg, title,</b>
&nbsp;                    JOptionPane.ERROR_MESSAGE);
&nbsp;            return;
&nbsp;        }
&nbsp;        // Apply single-entity settings
<b class="nc">&nbsp;        if (entities.size() == 1) {</b>
<b class="nc">&nbsp;            Entity entity = entities.get(0);</b>
&nbsp;
<b class="nc">&nbsp;            for (int i = 0; i &lt; entities.get(0).getCrew().getSlotCount(); i++) {</b>
<b class="nc">&nbsp;                String name = panCrewMember[i].getPilotName();</b>
<b class="nc">&nbsp;                String nick = panCrewMember[i].getNickname();</b>
<b class="nc">&nbsp;                Gender gender = panCrewMember[i].getGender();</b>
<b class="nc">&nbsp;                if (gender == Gender.RANDOMIZE) {</b>
<b class="nc">&nbsp;                    gender = entities.get(0).getCrew().getGender(i);</b>
&nbsp;                }
<b class="nc">&nbsp;                boolean missing = panCrewMember[i].getMissing();</b>
&nbsp;                int gunnery;
&nbsp;                int gunneryL;
&nbsp;                int gunneryM;
&nbsp;                int gunneryB;
&nbsp;                int artillery;
&nbsp;                int piloting;
&nbsp;                int gunneryAero;
&nbsp;                int gunneryAeroL;
&nbsp;                int gunneryAeroM;
&nbsp;                int gunneryAeroB;
&nbsp;                int pilotingAero;
<b class="nc">&nbsp;                int tough = 0;</b>
<b class="nc">&nbsp;                int backup = panCrewMember[i].getBackup();</b>
&nbsp;                try {
<b class="nc">&nbsp;                    gunnery = panCrewMember[i].getGunnery();</b>
<b class="nc">&nbsp;                    gunneryL = panCrewMember[i].getGunneryL();</b>
<b class="nc">&nbsp;                    gunneryM = panCrewMember[i].getGunneryM();</b>
<b class="nc">&nbsp;                    gunneryB = panCrewMember[i].getGunneryB();</b>
<b class="nc">&nbsp;                    piloting = panCrewMember[i].getPiloting();</b>
<b class="nc">&nbsp;                    gunneryAero = panCrewMember[i].getGunneryAero();</b>
<b class="nc">&nbsp;                    gunneryAeroL = panCrewMember[i].getGunneryAeroL();</b>
<b class="nc">&nbsp;                    gunneryAeroM = panCrewMember[i].getGunneryAeroM();</b>
<b class="nc">&nbsp;                    gunneryAeroB = panCrewMember[i].getGunneryAeroB();</b>
<b class="nc">&nbsp;                    pilotingAero = panCrewMember[i].getPilotingAero();</b>
<b class="nc">&nbsp;                    artillery = panCrewMember[i].getArtillery();</b>
<b class="nc">&nbsp;                    tough = panCrewMember[i].getToughness();</b>
<b class="nc">&nbsp;                } catch (NumberFormatException e) {</b>
<b class="nc">&nbsp;                    msg = Messages.getString(&quot;CustomMechDialog.EnterValidSkills&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    title = Messages.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    JOptionPane.showMessageDialog(clientgui.frame, msg, title,</b>
&nbsp;                            JOptionPane.ERROR_MESSAGE);
&nbsp;                    return;
<b class="nc">&nbsp;                }</b>
&nbsp;        
&nbsp;                // keep these reasonable, please
<b class="nc">&nbsp;                if ((gunnery &lt; 0) || (gunnery &gt; 8) || (piloting &lt; 0) || (piloting &gt; 8)</b>
&nbsp;                        || (gunneryL &lt; 0) || (gunneryL &gt; 8) || (gunneryM &lt; 0)
&nbsp;                        || (gunneryM &gt; 8) || (gunneryB &lt; 0) || (gunneryB &gt; 8)
&nbsp;                        || (gunneryAero &lt; 0) || (gunneryAero &gt; 8) || (pilotingAero &lt; 0) || (pilotingAero &gt; 8)
&nbsp;                        || (gunneryAeroL &lt; 0) || (gunneryAeroL &gt; 8) || (gunneryAeroM &lt; 0)
&nbsp;                        || (gunneryAeroM &gt; 8) || (gunneryAeroB &lt; 0) || (gunneryAeroB &gt; 8)                        
&nbsp;                        || (artillery &lt; 0) || (artillery &gt; 8)) {
<b class="nc">&nbsp;                    msg = Messages.getString(&quot;CustomMechDialog.EnterSkillsBetween0_8&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    title = Messages.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    JOptionPane.showMessageDialog(clientgui.frame, msg, title,</b>
&nbsp;                            JOptionPane.ERROR_MESSAGE);
&nbsp;                    return;
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (entity.getCrew() instanceof LAMPilot) {</b>
<b class="nc">&nbsp;                    LAMPilot pilot = (LAMPilot)entity.getCrew();</b>
<b class="nc">&nbsp;                    if (client.getGame().getOptions().booleanOption(OptionsConstants.RPG_RPG_GUNNERY)) {</b>
<b class="nc">&nbsp;                        pilot.setGunneryMechL(gunneryL);</b>
<b class="nc">&nbsp;                        pilot.setGunneryMechB(gunneryB);</b>
<b class="nc">&nbsp;                        pilot.setGunneryMechM(gunneryM);</b>
<b class="nc">&nbsp;                        pilot.setGunneryMech((int) Math.round((gunneryL + gunneryB + gunneryM) / 3.0));</b>
<b class="nc">&nbsp;                        pilot.setGunneryAeroL(gunneryAeroL);</b>
<b class="nc">&nbsp;                        pilot.setGunneryAeroB(gunneryAeroB);</b>
<b class="nc">&nbsp;                        pilot.setGunneryAeroM(gunneryAeroM);</b>
<b class="nc">&nbsp;                        pilot.setGunneryAero((int) Math.round((gunneryAeroL + gunneryAeroB + gunneryAeroM) / 3.0));</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        pilot.setGunneryMechL(gunnery);</b>
<b class="nc">&nbsp;                        pilot.setGunneryMechB(gunnery);</b>
<b class="nc">&nbsp;                        pilot.setGunneryMechM(gunnery);</b>
<b class="nc">&nbsp;                        pilot.setGunneryMech(gunnery);</b>
<b class="nc">&nbsp;                        pilot.setGunneryAeroL(gunneryAero);</b>
<b class="nc">&nbsp;                        pilot.setGunneryAeroB(gunneryAero);</b>
<b class="nc">&nbsp;                        pilot.setGunneryAeroM(gunneryAero);</b>
<b class="nc">&nbsp;                        pilot.setGunneryAero(gunneryAero);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    pilot.setPilotingMech(piloting);</b>
<b class="nc">&nbsp;                    pilot.setPilotingAero(pilotingAero);</b>
<b class="nc">&nbsp;                } else {</b>
<b class="nc">&nbsp;                    if (client.getGame().getOptions().booleanOption(OptionsConstants.RPG_RPG_GUNNERY)) {</b>
<b class="nc">&nbsp;                        entity.getCrew().setGunneryL(gunneryL, i);</b>
<b class="nc">&nbsp;                        entity.getCrew().setGunneryB(gunneryB, i);</b>
<b class="nc">&nbsp;                        entity.getCrew().setGunneryM(gunneryM, i);</b>
<b class="nc">&nbsp;                        entity.getCrew().setGunnery((int) Math.round((gunneryL + gunneryB + gunneryM) / 3.0), i);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        entity.getCrew().setGunnery(gunnery, i);</b>
<b class="nc">&nbsp;                        entity.getCrew().setGunneryL(gunnery, i);</b>
<b class="nc">&nbsp;                        entity.getCrew().setGunneryB(gunnery, i);</b>
<b class="nc">&nbsp;                        entity.getCrew().setGunneryM(gunnery, i);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    entity.getCrew().setPiloting(piloting, i);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_ARTILLERY_SKILL)) {</b>
<b class="nc">&nbsp;                    entity.getCrew().setArtillery(artillery, i);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    entity.getCrew().setArtillery(entity.getCrew().getGunnery(i), i);</b>
&nbsp;                }
<b class="nc">&nbsp;                entity.getCrew().setMissing(missing, i);</b>
<b class="nc">&nbsp;                entity.getCrew().setToughness(tough, i);</b>
<b class="nc">&nbsp;                entity.getCrew().setName(name, i);</b>
<b class="nc">&nbsp;                entity.getCrew().setNickname(nick, i);</b>
<b class="nc">&nbsp;                entity.getCrew().setGender(gender, i);</b>
<b class="nc">&nbsp;                entity.getCrew().setPortraitCategory(panCrewMember[i].getPortraitCategory(), i);</b>
<b class="nc">&nbsp;                entity.getCrew().setPortraitFileName(panCrewMember[i].getPortraitFilename(), i);</b>
<b class="nc">&nbsp;                if (backup &gt;= 0) {</b>
<b class="nc">&nbsp;                    if (i == entity.getCrew().getCrewType().getPilotPos()) {</b>
<b class="nc">&nbsp;                        entity.getCrew().setBackupPilotPos(backup);</b>
<b class="nc">&nbsp;                    } else if (i == entity.getCrew().getCrewType().getGunnerPos()) {</b>
<b class="nc">&nbsp;                        entity.getCrew().setBackupGunnerPos(backup);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
&nbsp;                // If the player wants to swap unit numbers, update both
&nbsp;                // entities and send an update packet for the other entity.
<b class="nc">&nbsp;                Entity other = panCrewMember[i].getEntityUnitNumSwap();</b>
<b class="nc">&nbsp;                if (null != other) {</b>
<b class="nc">&nbsp;                    short temp = entity.getUnitNumber();</b>
<b class="nc">&nbsp;                    entity.setUnitNumber(other.getUnitNumber());</b>
<b class="nc">&nbsp;                    other.setUnitNumber(temp);</b>
<b class="nc">&nbsp;                    client.sendUpdateEntity(other);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            entity.getCrew().setFatigue(fatigue);</b>
<b class="nc">&nbsp;            entity.getCrew().setInitBonus(init);</b>
<b class="nc">&nbsp;            entity.getCrew().setCommandBonus(command);</b>
&nbsp;
&nbsp;            // update commander status
<b class="nc">&nbsp;            entity.setCommander(chCommander.isSelected());</b>
&nbsp;
<b class="nc">&nbsp;            setOptions();</b>
<b class="nc">&nbsp;            setQuirks();</b>
<b class="nc">&nbsp;            setPartReps();</b>
<b class="nc">&nbsp;            m_equip.applyChoices();</b>
&nbsp;
<b class="nc">&nbsp;            if (entity instanceof BattleArmor) {</b>
&nbsp;                // have to reset internals because of dermal armor option
<b class="nc">&nbsp;                if (entity.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</b>
<b class="nc">&nbsp;                    ((BattleArmor) entity).setInternal(2);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    ((BattleArmor) entity).setInternal(1);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Apply multiple-entity settings
<b class="nc">&nbsp;        for (Entity entity : entities) {</b>
<b class="nc">&nbsp;            entity.setHidden(chHidden.isSelected());</b>
&nbsp;
<b class="nc">&nbsp;            if (chOffBoard.isSelected()) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    offBoardDistance = distance;</b>
<b class="nc">&nbsp;                } catch (NumberFormatException e) {</b>
<b class="nc">&nbsp;                    msg = Messages</b>
<b class="nc">&nbsp;                            .getString(&quot;CustomMechDialog.EnterValidSkills&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    title = Messages</b>
<b class="nc">&nbsp;                            .getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    JOptionPane.showMessageDialog(clientgui.frame, msg, title,</b>
&nbsp;                            JOptionPane.ERROR_MESSAGE);
&nbsp;                    return;
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                if (offBoardDistance &lt; 17) {</b>
<b class="nc">&nbsp;                    msg = Messages</b>
<b class="nc">&nbsp;                            .getString(&quot;CustomMechDialog.OffboardDistance&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    title = Messages</b>
<b class="nc">&nbsp;                            .getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    JOptionPane.showMessageDialog(clientgui.frame, msg, title,</b>
&nbsp;                            JOptionPane.ERROR_MESSAGE);
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;                entity.setOffBoard(offBoardDistance, OffBoardDirection</b>
<b class="nc">&nbsp;                        .getDirection(choOffBoardDirection.getSelectedIndex()));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                entity.setOffBoard(0, OffBoardDirection.NONE);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (isAero || isShip) {</b>
<b class="nc">&nbsp;                IAero a = (IAero) entity;</b>
<b class="nc">&nbsp;                a.setCurrentVelocity(velocity);</b>
<b class="nc">&nbsp;                a.setNextVelocity(velocity);</b>
<b class="nc">&nbsp;                a.setCurrentFuel(currentfuel);</b>
&nbsp;                // we need to determine whether this aero is airborne or not in
&nbsp;                // order for prohibited terrain and stacking to work right in
&nbsp;                // the
&nbsp;                // deployment phase this is very tricky because in atmosphere,
&nbsp;                // zero
&nbsp;                // altitude does not necessarily mean grounded
<b class="nc">&nbsp;                if (altitude &lt;= 0) {</b>
<b class="nc">&nbsp;                    a.land();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    a.liftOff(altitude);</b>
&nbsp;                }
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if (isVTOL || isWiGE || isAirMech || isGlider) {</b>
<b class="nc">&nbsp;                entity.setElevation(height);</b>
&nbsp;            }
&nbsp;            
&nbsp;            //Set the entity&#39;s starting mode
<b class="nc">&nbsp;            if (isQuadVee) {</b>
<b class="nc">&nbsp;                entity.setConversionMode(choStartingMode.getSelectedIndex());</b>
<b class="nc">&nbsp;            } else if (isLAM) {</b>
<b class="nc">&nbsp;                if (choStartingMode.getSelectedIndex() == 2) {</b>
<b class="nc">&nbsp;                    entity.setConversionMode(LandAirMech.CONV_MODE_FIGHTER);</b>
<b class="nc">&nbsp;                } else if (choStartingMode.getSelectedIndex() == 1) {</b>
<b class="nc">&nbsp;                    entity.setConversionMode(LandAirMech.CONV_MODE_FIGHTER);</b>
<b class="nc">&nbsp;                    entity.setConversionMode(((LandAirMech)entity).getLAMType() == LandAirMech.LAM_BIMODAL?</b>
<b class="nc">&nbsp;                            LandAirMech.CONV_MODE_FIGHTER : LandAirMech.CONV_MODE_AIRMECH);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    entity.setConversionMode(LandAirMech.CONV_MODE_MECH);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // Set the entity&#39;s deployment position and round.
<b class="nc">&nbsp;            entity.setStartingPos(choDeploymentZone.getSelectedIndex() - 1);</b>
<b class="nc">&nbsp;            entity.setDeployRound(choDeploymentRound.getSelectedIndex());</b>
&nbsp;
&nbsp;            // Should the entity begin the game shutdown?
<b class="nc">&nbsp;            if (chDeployShutdown.isSelected()</b>
<b class="nc">&nbsp;                    &amp;&amp; clientgui.getClient().getGame().getOptions()</b>
<b class="nc">&nbsp;                            .booleanOption(OptionsConstants.RPG_BEGIN_SHUTDOWN)) {</b>
<b class="nc">&nbsp;                entity.performManualShutdown();</b>
&nbsp;            } else { // We need to else this in case someone turned the option
&nbsp;                     // on, set their units, and then turned the option off.
<b class="nc">&nbsp;                entity.performManualStartup();</b>
&nbsp;            }
&nbsp;
&nbsp;            // LAMs in fighter mode or airborne AirMechs ignore the prone and hull down selections.
<b class="nc">&nbsp;            if (!isLAM || (!isAero &amp;&amp; entity.getElevation() == 0)) {</b>
&nbsp;                // Should the entity begin the game prone?
<b class="nc">&nbsp;                entity.setProne(chDeployProne.isSelected());</b>
&nbsp;    
&nbsp;                // Should the entity begin the game prone?
<b class="nc">&nbsp;                entity.setHullDown(chDeployHullDown.isSelected());</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        okay = true;</b>
<b class="nc">&nbsp;        status = DONE;</b>
<b class="nc">&nbsp;        clientgui.chatlounge.refreshEntities();</b>
&nbsp;
&nbsp;        // Check validity of units after customization
<b class="nc">&nbsp;        for (Entity entity : entities) {</b>
<b class="nc">&nbsp;            EntityVerifier verifier = EntityVerifier.getInstance(new MegaMekFile(</b>
<b class="nc">&nbsp;                    Configuration.unitsDir(), EntityVerifier.CONFIG_FILENAME).getFile());</b>
<b class="nc">&nbsp;            TestEntity testEntity = null;</b>
<b class="nc">&nbsp;            if (entity instanceof Mech) {</b>
<b class="nc">&nbsp;                testEntity = new TestMech((Mech) entity, verifier.mechOption,</b>
&nbsp;                        null);
<b class="nc">&nbsp;            } else if ((entity instanceof Tank)</b>
&nbsp;                    &amp;&amp; !(entity instanceof GunEmplacement)) {
<b class="nc">&nbsp;                if (entity.isSupportVehicle()) {</b>
<b class="nc">&nbsp;                    testEntity = new TestSupportVehicle((Tank) entity,</b>
&nbsp;                            verifier.tankOption, null);
&nbsp;                } else {
<b class="nc">&nbsp;                    testEntity = new TestTank((Tank) entity,</b>
&nbsp;                            verifier.tankOption, null);
&nbsp;                }
<b class="nc">&nbsp;            } else if (entity.getEntityType() == Entity.ETYPE_AERO</b>
<b class="nc">&nbsp;                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_DROPSHIP</b>
<b class="nc">&nbsp;                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_SMALL_CRAFT</b>
<b class="nc">&nbsp;                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_FIGHTER_SQUADRON</b>
<b class="nc">&nbsp;                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_JUMPSHIP</b>
<b class="nc">&nbsp;                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_SPACE_STATION) {</b>
<b class="nc">&nbsp;                testEntity = new TestAero((Aero) entity, verifier.mechOption,</b>
&nbsp;                        null);
<b class="nc">&nbsp;            } else if (entity instanceof BattleArmor) {</b>
<b class="nc">&nbsp;                testEntity = new TestBattleArmor((BattleArmor) entity,</b>
&nbsp;                        verifier.baOption, null);
<b class="nc">&nbsp;            } else if (entity instanceof Infantry) {</b>
<b class="nc">&nbsp;                testEntity = new TestInfantry((Infantry) entity,</b>
&nbsp;                        verifier.infOption, null);
&nbsp;            }
<b class="nc">&nbsp;            int gameTL = TechConstants.getGameTechLevel(client.getGame(),</b>
<b class="nc">&nbsp;                    entity.isClan());</b>
<b class="nc">&nbsp;            if ((testEntity != null)</b>
<b class="nc">&nbsp;                    &amp;&amp; !testEntity.correctEntity(new StringBuffer(), gameTL)) {</b>
<b class="nc">&nbsp;                entity.setDesignValid(false);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                entity.setDesignValid(true);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if (actionEvent.getSource().equals(butPrev)) {</b>
<b class="nc">&nbsp;            status = PREV;</b>
<b class="nc">&nbsp;        } else if (actionEvent.getSource().equals(butNext)) {</b>
<b class="nc">&nbsp;            status = NEXT;</b>
&nbsp;        }
<b class="nc">&nbsp;        setVisible(false);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void itemStateChanged(ItemEvent itemEvent) {
<b class="nc">&nbsp;        if (itemEvent.getSource().equals(choStartingMode)) {</b>
<b class="nc">&nbsp;            updateStartingModeOptions();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (itemEvent.getSource().equals(chDeployProne)) {</b>
<b class="nc">&nbsp;            chDeployHullDown.setSelected(false);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (itemEvent.getSource().equals(chDeployHullDown)) {</b>
<b class="nc">&nbsp;            chDeployProne.setSelected(false);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (itemEvent.getSource().equals(choDeploymentRound)) {</b>
<b class="nc">&nbsp;            if (choDeploymentRound.getSelectedIndex() == 0) {</b>
<b class="nc">&nbsp;                choDeploymentZone.setEnabled(false);</b>
<b class="nc">&nbsp;                choDeploymentZone.setSelectedIndex(0);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                choDeploymentZone.setEnabled(true);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void updateStartingModeOptions() {
<b class="nc">&nbsp;        final int index = choStartingMode.getSelectedIndex();</b>
<b class="nc">&nbsp;        if (entities.get(0) instanceof QuadVee) {</b>
<b class="nc">&nbsp;            labDeployProne.setEnabled(index == 0);</b>
<b class="nc">&nbsp;            chDeployProne.setEnabled(index == 0);</b>
<b class="nc">&nbsp;        } else if (entities.get(0) instanceof LandAirMech) {</b>
<b class="nc">&nbsp;            int mode = index;</b>
<b class="nc">&nbsp;            if (((LandAirMech)entities.get(0)).getLAMType() == LandAirMech.LAM_BIMODAL</b>
&nbsp;                    &amp;&amp; mode == LandAirMech.CONV_MODE_AIRMECH) {
<b class="nc">&nbsp;                mode = LandAirMech.CONV_MODE_FIGHTER;</b>
&nbsp;            }
<b class="nc">&nbsp;            labDeployProne.setEnabled(mode &lt; LandAirMech.CONV_MODE_FIGHTER);</b>
<b class="nc">&nbsp;            chDeployProne.setEnabled(mode &lt; LandAirMech.CONV_MODE_FIGHTER);</b>
<b class="nc">&nbsp;            labDeployHullDown.setEnabled(mode == LandAirMech.CONV_MODE_MECH);</b>
<b class="nc">&nbsp;            chDeployHullDown.setEnabled(mode == LandAirMech.CONV_MODE_MECH);</b>
<b class="nc">&nbsp;            labStartHeight.setEnabled(mode == LandAirMech.CONV_MODE_AIRMECH);</b>
<b class="nc">&nbsp;            fldStartHeight.setEnabled(mode == LandAirMech.CONV_MODE_AIRMECH);</b>
<b class="nc">&nbsp;            labStartVelocity.setEnabled(mode == LandAirMech.CONV_MODE_FIGHTER);</b>
<b class="nc">&nbsp;            fldStartVelocity.setEnabled(mode == LandAirMech.CONV_MODE_FIGHTER);</b>
<b class="nc">&nbsp;            labStartAltitude.setEnabled(mode == LandAirMech.CONV_MODE_FIGHTER);</b>
<b class="nc">&nbsp;            fldStartAltitude.setEnabled(mode == LandAirMech.CONV_MODE_FIGHTER);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public Entity getNextEntity(boolean forward) {
<b class="nc">&nbsp;        IGame game = client.getGame();</b>
<b class="nc">&nbsp;        boolean bd = game.getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        boolean rbd = game.getOptions().booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        IPlayer p = client.getLocalPlayer();</b>
&nbsp;
&nbsp;        Entity nextOne;
&nbsp;        Entity entity;
<b class="nc">&nbsp;        if (forward) {</b>
<b class="nc">&nbsp;            entity = entities.get(entities.size() - 1);</b>
<b class="nc">&nbsp;            nextOne = game.getNextEntityFromList(entity);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            entity = entities.get(0);</b>
<b class="nc">&nbsp;            nextOne = game.getPreviousEntityFromList(entity);</b>
&nbsp;        }
<b class="nc">&nbsp;        while ((nextOne != null) &amp;&amp; !entities.contains(nextOne)) {</b>
<b class="nc">&nbsp;            if (nextOne.getOwner().equals(p)</b>
<b class="nc">&nbsp;                    || (!(bd || rbd) &amp;&amp; nextOne.getOwner().equals(</b>
<b class="nc">&nbsp;                            entity.getOwner()))) {</b>
<b class="nc">&nbsp;                return nextOne;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (forward) {</b>
<b class="nc">&nbsp;                nextOne = game.getNextEntityFromList(nextOne);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                nextOne = game.getPreviousEntityFromList(nextOne);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setupEquip() {
<b class="nc">&nbsp;        Entity entity = entities.get(0);</b>
<b class="nc">&nbsp;        GridBagLayout gbl = new GridBagLayout();</b>
<b class="nc">&nbsp;        panEquip.setLayout(gbl);</b>
&nbsp;
<b class="nc">&nbsp;        m_equip = new EquipChoicePanel(entity, clientgui, client);</b>
<b class="nc">&nbsp;        panEquip.add(m_equip, GBC.std());</b>
&nbsp;    }
&nbsp;    
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
