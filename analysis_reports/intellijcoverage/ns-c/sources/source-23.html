


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > EquipChoicePanel</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ui.swing</a>
</div>

<h1>Coverage Summary for Class: EquipChoicePanel (megamek.client.ui.swing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EquipChoicePanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/537)
  </span>
</td>
</tr>
  <tr>
    <td class="name">EquipChoicePanel$APWeaponChoicePanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/57)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EquipChoicePanel$InfantryArmorPanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/137)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EquipChoicePanel$MEAChoicePanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/46)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EquipChoicePanel$MineChoicePanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EquipChoicePanel$MunitionChoicePanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/81)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EquipChoicePanel$MunitionChoicePanel$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EquipChoicePanel$MunitionChoicePanel$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EquipChoicePanel$ProtomechMunitionChoicePanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EquipChoicePanel$RapidfireMGPanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EquipChoicePanel$WeaponAmmoChoicePanel</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/968)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek - Copyright (C) 2003, 2004 Ben Mazur (bmazur@sev.org)
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;
&nbsp;package megamek.client.ui.swing;
&nbsp;
&nbsp;import java.awt.GridBagConstraints;
&nbsp;import java.awt.GridBagLayout;
&nbsp;import java.awt.event.ItemEvent;
&nbsp;import java.awt.event.ItemListener;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Enumeration;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.List;
&nbsp;import java.util.Vector;
&nbsp;
&nbsp;import javax.swing.BorderFactory;
&nbsp;import javax.swing.Box;
&nbsp;import javax.swing.JCheckBox;
&nbsp;import javax.swing.JComboBox;
&nbsp;import javax.swing.JLabel;
&nbsp;import javax.swing.JPanel;
&nbsp;import javax.swing.JTextField;
&nbsp;import javax.swing.SwingConstants;
&nbsp;import javax.swing.border.TitledBorder;
&nbsp;
&nbsp;import megamek.client.Client;
&nbsp;import megamek.client.ui.GBC;
&nbsp;import megamek.client.ui.Messages;
&nbsp;import megamek.common.*;
&nbsp;import megamek.common.options.IOptions;
&nbsp;import megamek.common.options.OptionsConstants;
&nbsp;import megamek.common.util.fileUtils.MegaMekFile;
&nbsp;import megamek.common.verifier.EntityVerifier;
&nbsp;import megamek.common.verifier.TestBattleArmor;
&nbsp;import megamek.common.weapons.infantry.InfantryWeapon;
&nbsp;
&nbsp;/**
&nbsp; * This class builds the Equipment Panel for use in MegaMek and MekHQ
&nbsp; *
&nbsp; * @author Dylan Myers (ralgith-erian@users.sourceforge.net)
&nbsp; * @author arlith
&nbsp; * @since 2012-05-20
&nbsp; */
<b class="nc">&nbsp;public class EquipChoicePanel extends JPanel {</b>
&nbsp;    static final long serialVersionUID = 672299770230285567L;
&nbsp;
&nbsp;    private final Entity entity;
&nbsp;
&nbsp;    private int[] entityCorrespondance;
&nbsp;
<b class="nc">&nbsp;    private List&lt;MunitionChoicePanel&gt; m_vMunitions = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    private List&lt;WeaponAmmoChoicePanel&gt; m_vWeaponAmmoChoice = new ArrayList&lt;&gt;();</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * An &lt;code&gt;ArrayList&lt;/code&gt; to keep track of all of the 
&nbsp;     * &lt;code&gt;APWeaponChoicePanels&lt;/code&gt; that were added, so we can apply 
&nbsp;     * their choices when the dialog is closed.
&nbsp;     */
<b class="nc">&nbsp;    private ArrayList&lt;APWeaponChoicePanel&gt; m_vAPMounts = new ArrayList&lt;&gt;();</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * An &lt;code&gt;ArrayList&lt;/code&gt; to keep track of all of the 
&nbsp;     * &lt;code&gt;MEAChoicePanels&lt;/code&gt; that were added, so we can apply 
&nbsp;     * their choices when the dialog is closed.
&nbsp;     */
<b class="nc">&nbsp;    private ArrayList&lt;MEAChoicePanel&gt; m_vMEAdaptors = new ArrayList&lt;&gt;();</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * Panel for adding components related to selecting which anti-personnel
&nbsp;     * weapons are mounted in an AP Mount (armored gloves are also considered 
&nbsp;     * AP mounts)
&nbsp;     **/
<b class="nc">&nbsp;    private JPanel panAPMounts = new JPanel();</b>
<b class="nc">&nbsp;    private JPanel panMEAdaptors = new JPanel();</b>
<b class="nc">&nbsp;    private JPanel panMunitions = new JPanel();</b>
<b class="nc">&nbsp;    private JPanel panWeaponAmmoSelector = new JPanel();</b>
&nbsp;
<b class="nc">&nbsp;    private ArrayList&lt;RapidfireMGPanel&gt; m_vMGs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    private JPanel panRapidfireMGs = new JPanel();</b>
&nbsp;
<b class="nc">&nbsp;    private InfantryArmorPanel panInfArmor = new InfantryArmorPanel();</b>
&nbsp;
<b class="nc">&nbsp;    private ArrayList&lt;MineChoicePanel&gt; m_vMines = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    private JPanel panMines = new JPanel();</b>
&nbsp;
&nbsp;    private BombChoicePanel m_bombs;
<b class="nc">&nbsp;    private JPanel panBombs = new JPanel();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labAutoEject = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labAutoEject&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private JCheckBox chAutoEject = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labCondEjectAmmo = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labConditional_Ejection_Ammo&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private JCheckBox chCondEjectAmmo = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labCondEjectEngine = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labConditional_Ejection_Engine&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private JCheckBox chCondEjectEngine = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labCondEjectCTDest = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labConditional_Ejection_CT_Destroyed&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private JCheckBox chCondEjectCTDest = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labCondEjectHeadshot = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labConditional_Ejection_Headshot&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private JCheckBox chCondEjectHeadshot = new JCheckBox();</b>
&nbsp;    
<b class="nc">&nbsp;    private JLabel labCondEjectFuel = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labConditional_Ejection_Fuel&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private JCheckBox chCondEjectFuel = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labCondEjectSIDest = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labConditional_Ejection_SI_Destroyed&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private JCheckBox chCondEjectSIDest = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labSearchlight = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labSearchlight&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private JCheckBox chSearchlight = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;    private JLabel labC3 = new JLabel(</b>
<b class="nc">&nbsp;            Messages.getString(&quot;CustomMechDialog.labC3&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</b>
<b class="nc">&nbsp;    private JComboBox&lt;String&gt; choC3 = new JComboBox&lt;String&gt;();</b>
&nbsp;
&nbsp;    ClientGUI clientgui;
&nbsp;    Client client;
&nbsp;
<b class="nc">&nbsp;    public EquipChoicePanel(Entity entity, ClientGUI clientgui, Client client) {</b>
<b class="nc">&nbsp;        this.entity = entity;</b>
<b class="nc">&nbsp;        this.clientgui = clientgui;</b>
<b class="nc">&nbsp;        this.client = client;</b>
&nbsp;
<b class="nc">&nbsp;        GridBagLayout g = new GridBagLayout();</b>
<b class="nc">&nbsp;        setLayout(g);</b>
&nbsp;
&nbsp;        // **EQUIPMENT TAB**//
&nbsp;        // Auto-eject checkbox and conditional ejections.
<b class="nc">&nbsp;        if (entity instanceof Mech) {</b>
<b class="nc">&nbsp;            Mech mech = (Mech) entity;</b>
&nbsp;
&nbsp;            // Ejection Seat
<b class="nc">&nbsp;            boolean hasEjectSeat = true;</b>
&nbsp;            // torso mounted cockpits don&#39;t have an ejection seat
<b class="nc">&nbsp;            if (mech.getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED</b>
<b class="nc">&nbsp;                    || mech.hasQuirk(OptionsConstants.QUIRK_NEG_NO_EJECT)) {</b>
<b class="nc">&nbsp;                hasEjectSeat = false;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mech.isIndustrial()) {</b>
<b class="nc">&nbsp;                hasEjectSeat = false;</b>
&nbsp;                // industrials can only eject when they have an ejection seat
<b class="nc">&nbsp;                for (Mounted misc : mech.getMisc()) {</b>
<b class="nc">&nbsp;                    if (misc.getType().hasFlag(MiscType.F_EJECTION_SEAT)) {</b>
<b class="nc">&nbsp;                        hasEjectSeat = true;</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;            if (hasEjectSeat) {</b>
<b class="nc">&nbsp;                add(labAutoEject, GBC.std());</b>
<b class="nc">&nbsp;                add(chAutoEject, GBC.eol());</b>
<b class="nc">&nbsp;                chAutoEject.setSelected(!mech.isAutoEject());</b>
&nbsp;            }
&nbsp;
&nbsp;            // Conditional Ejections
<b class="nc">&nbsp;            if (clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</b>
&nbsp;                    &amp;&amp; hasEjectSeat) { // $NON-NLS-1$
<b class="nc">&nbsp;                add(labCondEjectAmmo, GBC.std());</b>
<b class="nc">&nbsp;                add(chCondEjectAmmo, GBC.eol());</b>
<b class="nc">&nbsp;                chCondEjectAmmo.setSelected(mech.isCondEjectAmmo());</b>
<b class="nc">&nbsp;                add(labCondEjectEngine, GBC.std());</b>
<b class="nc">&nbsp;                add(chCondEjectEngine, GBC.eol());</b>
<b class="nc">&nbsp;                chCondEjectEngine.setSelected(mech.isCondEjectEngine());</b>
<b class="nc">&nbsp;                add(labCondEjectCTDest, GBC.std());</b>
<b class="nc">&nbsp;                add(chCondEjectCTDest, GBC.eol());</b>
<b class="nc">&nbsp;                chCondEjectCTDest.setSelected(mech.isCondEjectCTDest());</b>
<b class="nc">&nbsp;                add(labCondEjectHeadshot, GBC.std());</b>
<b class="nc">&nbsp;                add(chCondEjectHeadshot, GBC.eol());</b>
<b class="nc">&nbsp;                chCondEjectHeadshot.setSelected(mech.isCondEjectHeadshot());</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (entity.isFighter()) {</b>
<b class="nc">&nbsp;            Aero aero = (Aero) entity;</b>
&nbsp;
&nbsp;            // Ejection Seat
<b class="nc">&nbsp;            boolean hasEjectSeat = !(entity.hasQuirk(OptionsConstants.QUIRK_NEG_NO_EJECT));</b>
<b class="nc">&nbsp;            if (hasEjectSeat) {</b>
<b class="nc">&nbsp;                add(labAutoEject, GBC.std());</b>
<b class="nc">&nbsp;                add(chAutoEject, GBC.eol());</b>
<b class="nc">&nbsp;                chAutoEject.setSelected(!aero.isAutoEject());</b>
&nbsp;            }
&nbsp;
&nbsp;            // Conditional Ejections
<b class="nc">&nbsp;            if (clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</b>
&nbsp;                    &amp;&amp; hasEjectSeat) { // $NON-NLS-1$
<b class="nc">&nbsp;                add(labCondEjectAmmo, GBC.std());</b>
<b class="nc">&nbsp;                add(chCondEjectAmmo, GBC.eol());</b>
<b class="nc">&nbsp;                chCondEjectAmmo.setSelected(aero.isCondEjectAmmo());</b>
<b class="nc">&nbsp;                add(labCondEjectFuel, GBC.std());</b>
<b class="nc">&nbsp;                add(chCondEjectFuel, GBC.eol());</b>
<b class="nc">&nbsp;                chCondEjectFuel.setSelected(aero.isCondEjectFuel());</b>
<b class="nc">&nbsp;                add(labCondEjectSIDest, GBC.std());</b>
<b class="nc">&nbsp;                add(chCondEjectSIDest, GBC.eol());</b>
<b class="nc">&nbsp;                chCondEjectSIDest.setSelected(aero.isCondEjectSIDest());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (entity.hasC3() || entity.hasC3i() || entity.hasNavalC3()) {</b>
<b class="nc">&nbsp;            add(labC3, GBC.std());</b>
<b class="nc">&nbsp;            add(choC3, GBC.eol());</b>
<b class="nc">&nbsp;            refreshC3();</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Setup AP mounts
<b class="nc">&nbsp;        if ((entity instanceof BattleArmor) </b>
<b class="nc">&nbsp;                &amp;&amp; entity.hasWorkingMisc(MiscType.F_AP_MOUNT)){</b>
<b class="nc">&nbsp;            setupAPMounts();</b>
<b class="nc">&nbsp;            panAPMounts.setBorder(BorderFactory.createTitledBorder(</b>
<b class="nc">&nbsp;                    BorderFactory.createEmptyBorder(), Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.APMountPanelTitle&quot;),</b>
&nbsp;                    TitledBorder.TOP, TitledBorder.DEFAULT_POSITION));
&nbsp;            
<b class="nc">&nbsp;            add(panAPMounts,GBC.eop().anchor(GridBagConstraints.CENTER));</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if ((entity instanceof BattleArmor) </b>
<b class="nc">&nbsp;                &amp;&amp; entity.hasWorkingMisc(MiscType.F_BA_MEA)){            </b>
<b class="nc">&nbsp;            panMEAdaptors.setBorder(BorderFactory.createTitledBorder(</b>
<b class="nc">&nbsp;                    BorderFactory.createEmptyBorder(), Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.MEAPanelTitle&quot;),</b>
&nbsp;                    TitledBorder.TOP, TitledBorder.DEFAULT_POSITION));
&nbsp;            // We need to determine how much weight is free, so the user can
&nbsp;            //  pick legal combinations of manipulators
<b class="nc">&nbsp;            BattleArmor ba = (BattleArmor) entity;</b>
<b class="nc">&nbsp;            EntityVerifier verifier = EntityVerifier.getInstance(</b>
<b class="nc">&nbsp;                    new MegaMekFile(Configuration.unitsDir(),</b>
<b class="nc">&nbsp;                            EntityVerifier.CONFIG_FILENAME).getFile());</b>
<b class="nc">&nbsp;            TestBattleArmor testBA = new TestBattleArmor(ba, </b>
&nbsp;                    verifier.baOption, null);
<b class="nc">&nbsp;            double maxTrooperWeight = 0;</b>
<b class="nc">&nbsp;            for (int i = 1; i &lt; ba.getTroopers(); i++){</b>
<b class="nc">&nbsp;                double trooperWeight = testBA.calculateWeight(i);</b>
<b class="nc">&nbsp;                if (trooperWeight &gt; maxTrooperWeight){</b>
<b class="nc">&nbsp;                    maxTrooperWeight = trooperWeight;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            String freeWeight = Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.freeWeight&quot;)</b>
<b class="nc">&nbsp;                    + String.format(&quot;: %1$.3f/%2$.3f&quot;, maxTrooperWeight,</b>
<b class="nc">&nbsp;                            ba.getTrooperWeight());</b>
&nbsp;                        
<b class="nc">&nbsp;            setupMEAdaptors(freeWeight);</b>
<b class="nc">&nbsp;            add(panMEAdaptors,GBC.eop().anchor(GridBagConstraints.CENTER));</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Can&#39;t set up munitions on infantry.
<b class="nc">&nbsp;        if (!((entity instanceof Infantry) &amp;&amp; !((Infantry) entity)</b>
<b class="nc">&nbsp;                .hasFieldGun()) || (entity instanceof BattleArmor)) {</b>
<b class="nc">&nbsp;            setupMunitions();</b>
<b class="nc">&nbsp;            panMunitions.setBorder(BorderFactory.createTitledBorder(</b>
<b class="nc">&nbsp;                    BorderFactory.createEmptyBorder(), Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.MunitionsPanelTitle&quot;),</b>
&nbsp;                    TitledBorder.TOP, TitledBorder.DEFAULT_POSITION));
<b class="nc">&nbsp;            add(panMunitions,</b>
<b class="nc">&nbsp;                    GBC.eop().anchor(GridBagConstraints.CENTER));</b>
&nbsp;            
<b class="nc">&nbsp;            setupWeaponAmmoChoice();</b>
<b class="nc">&nbsp;            panWeaponAmmoSelector.setBorder(BorderFactory.createTitledBorder(</b>
<b class="nc">&nbsp;                    BorderFactory.createEmptyBorder(), Messages</b>
<b class="nc">&nbsp;                    .getString(&quot;CustomMechDialog.WeaponSelectionTitle&quot;),</b>
&nbsp;                    TitledBorder.TOP, TitledBorder.DEFAULT_POSITION));
<b class="nc">&nbsp;            add(panWeaponAmmoSelector, GBC.eop().anchor(GridBagConstraints.CENTER));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (entity.isBomber()) {</b>
<b class="nc">&nbsp;            setupBombs();</b>
<b class="nc">&nbsp;            add(panBombs, GBC.eop().anchor(GridBagConstraints.CENTER));</b>
&nbsp;        }
&nbsp;
&nbsp;        // Set up rapidfire mg
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getOptions().booleanOption(</b>
&nbsp;                OptionsConstants.ADVCOMBAT_TACOPS_BURST)) { //$NON-NLS-1$
<b class="nc">&nbsp;            setupRapidfireMGs();</b>
<b class="nc">&nbsp;            add(panRapidfireMGs,</b>
<b class="nc">&nbsp;                    GBC.eop().anchor(GridBagConstraints.CENTER));</b>
&nbsp;        }
&nbsp;
&nbsp;        // set up infantry armor
<b class="nc">&nbsp;        if ((entity instanceof Infantry) &amp;&amp; !(entity instanceof BattleArmor)) {</b>
<b class="nc">&nbsp;            panInfArmor.initialize();</b>
<b class="nc">&nbsp;            add(panInfArmor,</b>
<b class="nc">&nbsp;                    GBC.eop().anchor(GridBagConstraints.CENTER));</b>
&nbsp;        }
&nbsp;
&nbsp;        // Set up searchlight
<b class="nc">&nbsp;        if (clientgui.getClient().getGame().getPlanetaryConditions().getLight() &gt; PlanetaryConditions.L_DUSK) {</b>
<b class="nc">&nbsp;            add(labSearchlight, GBC.std());</b>
<b class="nc">&nbsp;            add(chSearchlight, GBC.eol());</b>
<b class="nc">&nbsp;            chSearchlight.setSelected(entity.hasSpotlight()</b>
<b class="nc">&nbsp;                    || entity.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT));</b>
<b class="nc">&nbsp;            chSearchlight.setEnabled(!entity</b>
<b class="nc">&nbsp;                    .hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT));</b>
&nbsp;        }
&nbsp;
&nbsp;        // Set up mines
<b class="nc">&nbsp;        setupMines();</b>
<b class="nc">&nbsp;        add(panMines, GBC.eop().anchor(GridBagConstraints.CENTER));</b>
&nbsp;    }
&nbsp;
&nbsp;    public void initialize() {
<b class="nc">&nbsp;        choC3.setEnabled(false);</b>
<b class="nc">&nbsp;        chAutoEject.setEnabled(false);</b>
<b class="nc">&nbsp;        chSearchlight.setEnabled(false);</b>
<b class="nc">&nbsp;        if (m_bombs != null){</b>
<b class="nc">&nbsp;            m_bombs.setEnabled(false);</b>
&nbsp;        }
<b class="nc">&nbsp;        disableMunitionEditing();</b>
<b class="nc">&nbsp;        disableAPMEditing();</b>
<b class="nc">&nbsp;        disableMEAEditing();</b>
<b class="nc">&nbsp;        disableMGSetting();</b>
<b class="nc">&nbsp;        disableMineSetting();</b>
<b class="nc">&nbsp;        panInfArmor.setEnabled(false);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void applyChoices() {
&nbsp;        //Autoejection Options
<b class="nc">&nbsp;        boolean autoEject = chAutoEject.isSelected();</b>
<b class="nc">&nbsp;        boolean condEjectAmmo = chCondEjectAmmo.isSelected();</b>
&nbsp;        //Mechs and LAMs Only
<b class="nc">&nbsp;        boolean condEjectEngine = chCondEjectEngine.isSelected();</b>
<b class="nc">&nbsp;        boolean condEjectCTDest = chCondEjectCTDest.isSelected();</b>
<b class="nc">&nbsp;        boolean condEjectHeadshot = chCondEjectHeadshot.isSelected();</b>
&nbsp;        //Aeros Only
<b class="nc">&nbsp;        boolean condEjectFuel = chCondEjectFuel.isSelected();</b>
<b class="nc">&nbsp;        boolean condEjectSIDest = chCondEjectSIDest.isSelected();</b>
&nbsp;
<b class="nc">&nbsp;        if (entity instanceof Mech) {</b>
<b class="nc">&nbsp;            Mech mech = (Mech) entity;</b>
<b class="nc">&nbsp;            mech.setAutoEject(!autoEject);</b>
<b class="nc">&nbsp;            mech.setCondEjectAmmo(condEjectAmmo);</b>
<b class="nc">&nbsp;            mech.setCondEjectEngine(condEjectEngine);</b>
<b class="nc">&nbsp;            mech.setCondEjectCTDest(condEjectCTDest);</b>
<b class="nc">&nbsp;            mech.setCondEjectHeadshot(condEjectHeadshot);</b>
<b class="nc">&nbsp;        } else if (entity.isFighter()) {</b>
<b class="nc">&nbsp;            Aero aero = (Aero) entity;</b>
<b class="nc">&nbsp;            aero.setAutoEject(!autoEject);</b>
<b class="nc">&nbsp;            aero.setCondEjectAmmo(condEjectAmmo);</b>
<b class="nc">&nbsp;            aero.setCondEjectFuel(condEjectFuel);</b>
<b class="nc">&nbsp;            aero.setCondEjectSIDest(condEjectSIDest);</b>
&nbsp;        }
&nbsp;
&nbsp;        // update AP weapon selections
<b class="nc">&nbsp;        for (APWeaponChoicePanel apChoicePanel : m_vAPMounts) {</b>
<b class="nc">&nbsp;            apChoicePanel.applyChoice();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // update modular equipment adaptor selections
<b class="nc">&nbsp;        for (MEAChoicePanel meaChoicePanel : m_vMEAdaptors) {</b>
<b class="nc">&nbsp;            meaChoicePanel.applyChoice();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // update munitions selections
<b class="nc">&nbsp;        for (final Object newVar2 : m_vMunitions) {</b>
<b class="nc">&nbsp;            ((MunitionChoicePanel) newVar2).applyChoice();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (panMunitions instanceof BayMunitionsChoicePanel) {</b>
<b class="nc">&nbsp;            ((BayMunitionsChoicePanel) panMunitions).apply();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            if (panMunitions instanceof SmallSVMunitionsChoicePanel) {</b>
<b class="nc">&nbsp;                ((SmallSVMunitionsChoicePanel) panMunitions).apply();</b>
&nbsp;            }
&nbsp;            // update ammo names for weapon ammo choice selectors
<b class="nc">&nbsp;            for(WeaponAmmoChoicePanel wacPanel : m_vWeaponAmmoChoice) {</b>
<b class="nc">&nbsp;                wacPanel.applyChoice();</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
&nbsp;        // update MG rapid fire settings
<b class="nc">&nbsp;        for (final Object newVar1 : m_vMGs) {</b>
<b class="nc">&nbsp;            ((RapidfireMGPanel) newVar1).applyChoice();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        // update mines setting
<b class="nc">&nbsp;        for (final Object newVar : m_vMines) {</b>
<b class="nc">&nbsp;            ((MineChoicePanel) newVar).applyChoice();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        // update bomb setting
<b class="nc">&nbsp;        if (null != m_bombs) {</b>
<b class="nc">&nbsp;            m_bombs.applyChoice();</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((entity instanceof Infantry)</b>
&nbsp;                &amp;&amp; !(entity instanceof BattleArmor)) {
<b class="nc">&nbsp;            panInfArmor.applyChoice();</b>
&nbsp;        }
&nbsp;
&nbsp;        // update searchlight setting
<b class="nc">&nbsp;        entity.setExternalSpotlight(chSearchlight.isSelected());</b>
<b class="nc">&nbsp;        entity.setSpotlightState(chSearchlight.isSelected());</b>
&nbsp;
<b class="nc">&nbsp;        if (entity.hasC3() &amp;&amp; (choC3.getSelectedIndex() &gt; -1)) {</b>
<b class="nc">&nbsp;            Entity chosen = client.getEntity(entityCorrespondance[choC3</b>
<b class="nc">&nbsp;                                                                  .getSelectedIndex()]);</b>
<b class="nc">&nbsp;            int entC3nodeCount = client.getGame().getC3SubNetworkMembers(entity)</b>
<b class="nc">&nbsp;                    .size();</b>
<b class="nc">&nbsp;            int choC3nodeCount = client.getGame().getC3NetworkMembers(chosen)</b>
<b class="nc">&nbsp;                    .size();</b>
&nbsp;
<b class="nc">&nbsp;            if ((entC3nodeCount + choC3nodeCount) &lt;= Entity.MAX_C3_NODES</b>
&nbsp;                    &amp;&amp; ((chosen == null) 
<b class="nc">&nbsp;                            || entity.getC3MasterId() != chosen.getId())) {</b>
<b class="nc">&nbsp;                entity.setC3Master(chosen, true);</b>
<b class="nc">&nbsp;            } else if (entity.getC3MasterId() != chosen.getId()){</b>
<b class="nc">&nbsp;                String message = Messages</b>
<b class="nc">&nbsp;                        .getString(</b>
&nbsp;                                &quot;CustomMechDialog.NetworkTooBig.message&quot;, new Object[] {//$NON-NLS-1$
<b class="nc">&nbsp;                                        entity.getShortName(),</b>
<b class="nc">&nbsp;                                        chosen.getShortName(),</b>
<b class="nc">&nbsp;                                        Integer.valueOf(entC3nodeCount),</b>
<b class="nc">&nbsp;                                        Integer.valueOf(choC3nodeCount),</b>
<b class="nc">&nbsp;                                        Integer.valueOf(Entity.MAX_C3_NODES) });</b>
<b class="nc">&nbsp;                clientgui.doAlertDialog(Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;CustomMechDialog.NetworkTooBig.title&quot;), //$NON-NLS-1$</b>
&nbsp;                        message);
<b class="nc">&nbsp;                refreshC3();</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (entity.hasC3i() &amp;&amp; (choC3.getSelectedIndex() &gt; -1)) {</b>
<b class="nc">&nbsp;            entity.setC3NetId(client.getEntity(entityCorrespondance[choC3</b>
<b class="nc">&nbsp;                                                                    .getSelectedIndex()]));</b>
<b class="nc">&nbsp;        } else if (entity.hasNavalC3() &amp;&amp; (choC3.getSelectedIndex() &gt; -1)) {</b>
<b class="nc">&nbsp;            entity.setC3NetId(client.getEntity(entityCorrespondance[choC3</b>
<b class="nc">&nbsp;                                                                    .getSelectedIndex()]));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void setupBombs() {
<b class="nc">&nbsp;        GridBagLayout gbl = new GridBagLayout();</b>
<b class="nc">&nbsp;        panBombs.setLayout(gbl);</b>
&nbsp;
<b class="nc">&nbsp;        int techlvl = Arrays.binarySearch(TechConstants.T_SIMPLE_NAMES, client</b>
<b class="nc">&nbsp;                .getGame().getOptions().stringOption(OptionsConstants.ALLOWED_TECHLEVEL)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        boolean allowNukes = client.getGame().getOptions()</b>
<b class="nc">&nbsp;                .booleanOption(OptionsConstants.ADVAERORULES_AT2_NUKES); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        m_bombs = new BombChoicePanel((IBomber) entity, allowNukes,</b>
&nbsp;                techlvl &gt;= TechConstants.T_SIMPLE_ADVANCED);
<b class="nc">&nbsp;        panBombs.add(m_bombs, GBC.std());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setupRapidfireMGs() {
<b class="nc">&nbsp;        GridBagLayout gbl = new GridBagLayout();</b>
<b class="nc">&nbsp;        panRapidfireMGs.setLayout(gbl);</b>
<b class="nc">&nbsp;        for (Mounted m : entity.getWeaponList()) {</b>
<b class="nc">&nbsp;            WeaponType wtype = (WeaponType) m.getType();</b>
<b class="nc">&nbsp;            if (!wtype.hasFlag(WeaponType.F_MG)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            RapidfireMGPanel rmp = new RapidfireMGPanel(m);</b>
<b class="nc">&nbsp;            panRapidfireMGs.add(rmp, GBC.eol());</b>
<b class="nc">&nbsp;            m_vMGs.add(rmp);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setupMines() {
<b class="nc">&nbsp;        GridBagLayout gbl = new GridBagLayout();</b>
<b class="nc">&nbsp;        panMines.setLayout(gbl);</b>
<b class="nc">&nbsp;        GridBagConstraints gbc = new GridBagConstraints();</b>
&nbsp;
<b class="nc">&nbsp;        int row = 0;</b>
<b class="nc">&nbsp;        for (Mounted m : entity.getMisc()) {</b>
<b class="nc">&nbsp;            if (!m.getType().hasFlag((MiscType.F_MINE)) &amp;&amp;</b>
<b class="nc">&nbsp;                    !m.getType().hasFlag((MiscType.F_VEHICLE_MINE_DISPENSER))) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            gbc.gridy = row++;</b>
<b class="nc">&nbsp;            MineChoicePanel mcp = new MineChoicePanel(m);</b>
<b class="nc">&nbsp;            gbl.setConstraints(mcp, gbc);</b>
<b class="nc">&nbsp;            panMines.add(mcp);</b>
<b class="nc">&nbsp;            m_vMines.add(mcp);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Setup the layout of &lt;code&gt;panMEAdaptors&lt;/code&gt;, which contains components
&nbsp;     * for selecting which manipulators are mounted in a modular equipment 
&nbsp;     * adaptor
&nbsp;     */
&nbsp;    private void setupMEAdaptors(String freeWeight) {
<b class="nc">&nbsp;        GridBagLayout gbl = new GridBagLayout();</b>
<b class="nc">&nbsp;        panMEAdaptors.setLayout(gbl);</b>
&nbsp;        
<b class="nc">&nbsp;        JLabel lblFreeWeight = new JLabel(freeWeight);</b>
<b class="nc">&nbsp;        panMEAdaptors.add(lblFreeWeight,</b>
<b class="nc">&nbsp;                GBC.eol().anchor(GridBagConstraints.CENTER));</b>
&nbsp;
<b class="nc">&nbsp;        ArrayList&lt;MiscType&gt; manipTypes = new ArrayList&lt;MiscType&gt;();</b>
&nbsp;        
<b class="nc">&nbsp;        for (String manipTypeName : BattleArmor.MANIPULATOR_TYPE_STRINGS){</b>
&nbsp;            // Ignore the &quot;None&quot; option
<b class="nc">&nbsp;            if (manipTypeName.equals(BattleArmor.MANIPULATOR_TYPE_STRINGS[0])){</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            MiscType mType = (MiscType)EquipmentType.get(manipTypeName);</b>
<b class="nc">&nbsp;            manipTypes.add(mType);</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        for (Mounted m : entity.getMisc()){</b>
<b class="nc">&nbsp;            if (!m.getType().hasFlag(MiscType.F_BA_MEA)){</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            Mounted currentManip = null;</b>
<b class="nc">&nbsp;            if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_LARM){</b>
<b class="nc">&nbsp;                currentManip = ((BattleArmor)entity).getLeftManipulator();</b>
<b class="nc">&nbsp;            } else if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_RARM){</b>
<b class="nc">&nbsp;                currentManip = ((BattleArmor)entity).getRightManipulator();</b>
&nbsp;            } else {
&nbsp;                // We can only have MEA&#39;s in an arm
&nbsp;                continue;
&nbsp;            }
&nbsp;            MEAChoicePanel meacp;
<b class="nc">&nbsp;            meacp = new MEAChoicePanel(entity, m.getBaMountLoc(), currentManip, </b>
&nbsp;                    manipTypes);
&nbsp;            
<b class="nc">&nbsp;            panMEAdaptors.add(meacp, GBC.eol());</b>
<b class="nc">&nbsp;            m_vMEAdaptors.add(meacp);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Setup the layout of &lt;code&gt;panAPMounts&lt;/code&gt;, which contains components
&nbsp;     * for selecting which anti-personnel weapons are mounted in an AP mount. 
&nbsp;     */
&nbsp;    private void setupAPMounts() {
<b class="nc">&nbsp;        GridBagLayout gbl = new GridBagLayout();</b>
<b class="nc">&nbsp;        panAPMounts.setLayout(gbl);</b>
&nbsp;        
&nbsp;        // Weapons that can be used in an AP Mount
<b class="nc">&nbsp;        ArrayList&lt;WeaponType&gt; apWeapTypes = new ArrayList&lt;WeaponType&gt;(100);</b>
&nbsp;        // Weapons that can be used in an Armored Glove
<b class="nc">&nbsp;        ArrayList&lt;WeaponType&gt; agWeapTypes = new ArrayList&lt;WeaponType&gt;(100);</b>
<b class="nc">&nbsp;        Enumeration&lt;EquipmentType&gt; allTypes = EquipmentType.getAllTypes();</b>
<b class="nc">&nbsp;        int gameYear = clientgui.getClient().getGame().getOptions().intOption(OptionsConstants.ALLOWED_YEAR);</b>
<b class="nc">&nbsp;        SimpleTechLevel legalLevel = SimpleTechLevel.getGameTechLevel(clientgui.getClient().getGame());</b>
<b class="nc">&nbsp;        while (allTypes.hasMoreElements()){</b>
<b class="nc">&nbsp;            EquipmentType eq = allTypes.nextElement();</b>
&nbsp;            
&nbsp;            // If it&#39;s not an infantry weapon, we don&#39;t care
<b class="nc">&nbsp;            if (!(eq instanceof InfantryWeapon)){</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
&nbsp;            // Check to see if the tech level of the equipment is legal
<b class="nc">&nbsp;            if (!eq.isLegal(gameYear, legalLevel, entity.isClan(), entity.isMixedTech())) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
&nbsp;            // Check to see if we&#39;ve got a valid infantry weapon
<b class="nc">&nbsp;            InfantryWeapon infWeap = (InfantryWeapon)eq;</b>
<b class="nc">&nbsp;            if (infWeap.hasFlag(WeaponType.F_INFANTRY)</b>
<b class="nc">&nbsp;                    &amp;&amp; !infWeap.hasFlag(WeaponType.F_INF_POINT_BLANK)</b>
<b class="nc">&nbsp;                    &amp;&amp; !infWeap.hasFlag(WeaponType.F_INF_ARCHAIC)</b>
<b class="nc">&nbsp;                    &amp;&amp; !infWeap.hasFlag(WeaponType.F_INF_SUPPORT)){</b>
<b class="nc">&nbsp;                apWeapTypes.add(infWeap);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (infWeap.hasFlag(WeaponType.F_INFANTRY)</b>
<b class="nc">&nbsp;                    &amp;&amp; !infWeap.hasFlag(WeaponType.F_INF_POINT_BLANK)</b>
<b class="nc">&nbsp;                    &amp;&amp; !infWeap.hasFlag(WeaponType.F_INF_ARCHAIC)</b>
<b class="nc">&nbsp;                    &amp;&amp; (infWeap.getCrew() &lt; 2)){</b>
<b class="nc">&nbsp;                agWeapTypes.add(infWeap);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        Collections.sort(apWeapTypes, (w1, w2) -&gt; w1.getName().compareTo(w2.getName()));</b>
<b class="nc">&nbsp;        Collections.sort(agWeapTypes, (w1, w2) -&gt; w1.getName().compareTo(w2.getName()));</b>
&nbsp;
<b class="nc">&nbsp;        ArrayList&lt;Mounted&gt; armoredGloves = new ArrayList&lt;Mounted&gt;(2);</b>
<b class="nc">&nbsp;        for (Mounted m : entity.getMisc()){</b>
<b class="nc">&nbsp;            if (!m.getType().hasFlag(MiscType.F_AP_MOUNT)){</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            APWeaponChoicePanel apcp = null;</b>
&nbsp;            // Armored gloves need to be treated slightly differently, since
&nbsp;            // 1 or 2 armored gloves allow 1 additional AP weapon
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_ARMORED_GLOVE)) {</b>
<b class="nc">&nbsp;                armoredGloves.add(m);                </b>
&nbsp;            } else{
<b class="nc">&nbsp;                apcp = new APWeaponChoicePanel(entity, m, apWeapTypes);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (apcp != null) {</b>
<b class="nc">&nbsp;                panAPMounts.add(apcp, GBC.eol());</b>
<b class="nc">&nbsp;                m_vAPMounts.add(apcp);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        
&nbsp;        // If there is an armored glove with a weapon already mounted, we need
&nbsp;        //  to ensure that that glove is displayed, and not the empty glove
<b class="nc">&nbsp;        Mounted aGlove = null;</b>
<b class="nc">&nbsp;        for (Mounted ag : armoredGloves) {</b>
<b class="nc">&nbsp;            if (aGlove == null) {</b>
<b class="nc">&nbsp;                aGlove = ag;</b>
<b class="nc">&nbsp;            } else if ((aGlove.getLinked() == null) </b>
<b class="nc">&nbsp;                    &amp;&amp; (ag.getLinked() != null)) {</b>
<b class="nc">&nbsp;                aGlove = ag;</b>
&nbsp;            } 
&nbsp;            // If both are linked, TestBattleArmor will mark unit as invalid
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (aGlove != null) {</b>
<b class="nc">&nbsp;            APWeaponChoicePanel apcp = new APWeaponChoicePanel(entity, aGlove,</b>
&nbsp;                    agWeapTypes);
<b class="nc">&nbsp;            panAPMounts.add(apcp, GBC.eol());</b>
<b class="nc">&nbsp;            m_vAPMounts.add(apcp);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void setupMunitions() {
<b class="nc">&nbsp;        GridBagLayout gbl = new GridBagLayout();</b>
<b class="nc">&nbsp;        panMunitions.setLayout(gbl);</b>
<b class="nc">&nbsp;        IGame game = clientgui.getClient().getGame();</b>
<b class="nc">&nbsp;        IOptions gameOpts = game.getOptions();</b>
<b class="nc">&nbsp;        int gameYear = gameOpts.intOption(OptionsConstants.ALLOWED_YEAR);</b>
&nbsp;
<b class="nc">&nbsp;        if (entity.usesWeaponBays() || entity instanceof Dropship) {</b>
&nbsp;            //Grounded dropships don&#39;t *use* weapon bays as such, but should load ammo as if they did
<b class="nc">&nbsp;            panMunitions = new BayMunitionsChoicePanel(entity, game);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        // Small support vehicle ammo is part of the weapon, and the only munitions choice is
&nbsp;        // standard or inferno, and only for some weapons.
<b class="nc">&nbsp;        if (entity.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
<b class="nc">&nbsp;            panMunitions = new SmallSVMunitionsChoicePanel(entity);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        panMunitions.setLayout(gbl);</b>
&nbsp;
<b class="nc">&nbsp;        for (Mounted m : entity.getAmmo()) {</b>
<b class="nc">&nbsp;            AmmoType at = (AmmoType) m.getType();</b>
<b class="nc">&nbsp;            ArrayList&lt;AmmoType&gt; vTypes = new ArrayList&lt;AmmoType&gt;();</b>
<b class="nc">&nbsp;            Vector&lt;AmmoType&gt; vAllTypes = AmmoType.getMunitionsFor(at.getAmmoType());</b>
<b class="nc">&nbsp;            if (vAllTypes == null) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
&nbsp;            // don&#39;t allow ammo switching of most things for Aeros
&nbsp;            // allow only MML, ATM, and NARC. LRM/SRM can switch between Artemis and standard,
&nbsp;            // but not other munitions. Same with MRM.
<b class="nc">&nbsp;            if ((entity instanceof Aero)</b>
<b class="nc">&nbsp;                    &amp;&amp; !((at.getAmmoType() == AmmoType.T_MML)</b>
<b class="nc">&nbsp;                            || (at.getAmmoType() == AmmoType.T_SRM)</b>
<b class="nc">&nbsp;                            || (at.getAmmoType() == AmmoType.T_LRM)</b>
<b class="nc">&nbsp;                            || (at.getAmmoType() == AmmoType.T_MRM)</b>
<b class="nc">&nbsp;                            || (at.getAmmoType() == AmmoType.T_ATM)</b>
<b class="nc">&nbsp;                            || (at.getAmmoType() == AmmoType.T_IATM))) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            for (AmmoType atCheck : vAllTypes) {</b>
<b class="nc">&nbsp;                if (entity.hasETypeFlag(Entity.ETYPE_AERO)</b>
<b class="nc">&nbsp;                        &amp;&amp; !atCheck.canAeroUse(game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_ARTILLERY_MUNITIONS))) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                SimpleTechLevel legalLevel = SimpleTechLevel.getGameTechLevel(game);</b>
<b class="nc">&nbsp;                boolean bTechMatch = false;</b>
<b class="nc">&nbsp;                if (game.getOptions().booleanOption(OptionsConstants.ALLOWED_ERA_BASED)) {</b>
<b class="nc">&nbsp;                    bTechMatch = atCheck.isLegal(gameYear, legalLevel, entity.isClan(),</b>
<b class="nc">&nbsp;                            entity.isMixedTech());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    bTechMatch = atCheck.getStaticTechLevel().ordinal() &lt;= legalLevel.ordinal();</b>
&nbsp;                }
&nbsp;
&nbsp;                // If clan_ignore_eq_limits is unchecked,
&nbsp;                // do NOT allow Clans to use IS-only ammo.
&nbsp;                // N.B. play bit-shifting games to allow &quot;incendiary&quot;
&nbsp;                // to be combined to other munition types.
<b class="nc">&nbsp;                long muniType = atCheck.getMunitionType();</b>
<b class="nc">&nbsp;                muniType &amp;= ~AmmoType.M_INCENDIARY_LRM;</b>
<b class="nc">&nbsp;                if (!gameOpts.booleanOption(OptionsConstants.ALLOWED_CLAN_IGNORE_EQ_LIMITS) //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        &amp;&amp; entity.isClan()</b>
&nbsp;                        &amp;&amp; ((muniType == AmmoType.M_SEMIGUIDED)
&nbsp;                                || (muniType == AmmoType.M_SWARM_I)
&nbsp;                                || (muniType == AmmoType.M_THUNDER_AUGMENTED)
&nbsp;                                || (muniType == AmmoType.M_THUNDER_INFERNO)
&nbsp;                                || (muniType == AmmoType.M_THUNDER_VIBRABOMB)
&nbsp;                                || (muniType == AmmoType.M_THUNDER_ACTIVE)
&nbsp;                                || (muniType == AmmoType.M_INFERNO_IV)
&nbsp;                                || (muniType == AmmoType.M_VIBRABOMB_IV)
&nbsp;                                || (muniType == AmmoType.M_LISTEN_KILL)
&nbsp;                                || (muniType == AmmoType.M_ANTI_TSM)
&nbsp;                                || (muniType == AmmoType.M_DEAD_FIRE) 
&nbsp;                                || (muniType == AmmoType.M_MINE_CLEARANCE))) {
<b class="nc">&nbsp;                    bTechMatch = false;</b>
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                if ((muniType == AmmoType.M_ARTEMIS_CAPABLE)</b>
<b class="nc">&nbsp;                        &amp;&amp; !entity.hasWorkingMisc(MiscType.F_ARTEMIS)</b>
<b class="nc">&nbsp;                        &amp;&amp; !entity.hasWorkingMisc(MiscType.F_ARTEMIS_PROTO)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                if ((muniType == AmmoType.M_ARTEMIS_V_CAPABLE)</b>
<b class="nc">&nbsp;                        &amp;&amp; !entity.hasWorkingMisc(MiscType.F_ARTEMIS_V)</b>
<b class="nc">&nbsp;                        &amp;&amp; !entity.hasWorkingMisc(MiscType.F_ARTEMIS_PROTO)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (!gameOpts.booleanOption(OptionsConstants.ADVANCED_MINEFIELDS) &amp;&amp; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        AmmoType.canDeliverMinefield(atCheck)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // Only Protos can use Proto-specific ammo
<b class="nc">&nbsp;                if (atCheck.hasFlag(AmmoType.F_PROTOMECH)</b>
&nbsp;                        &amp;&amp; !(entity instanceof Protomech)) {
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // When dealing with machine guns, Protos can only
&nbsp;                // use proto-specific machine gun ammo
<b class="nc">&nbsp;                if ((entity instanceof Protomech)</b>
<b class="nc">&nbsp;                        &amp;&amp; atCheck.hasFlag(AmmoType.F_MG)</b>
<b class="nc">&nbsp;                        &amp;&amp; !atCheck.hasFlag(AmmoType.F_PROTOMECH)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // Battle Armor ammo can&#39;t be selected at all.
&nbsp;                // All other ammo types need to match on rack size and tech.
<b class="nc">&nbsp;                if (bTechMatch</b>
<b class="nc">&nbsp;                        &amp;&amp; (atCheck.getRackSize() == at.getRackSize())</b>
<b class="nc">&nbsp;                        &amp;&amp; (atCheck.hasFlag(AmmoType.F_BATTLEARMOR) == at</b>
<b class="nc">&nbsp;                                .hasFlag(AmmoType.F_BATTLEARMOR))</b>
<b class="nc">&nbsp;                        &amp;&amp; (atCheck.hasFlag(AmmoType.F_ENCUMBERING) == at</b>
<b class="nc">&nbsp;                                .hasFlag(AmmoType.F_ENCUMBERING))</b>
<b class="nc">&nbsp;                        &amp;&amp; (atCheck.getTonnage(entity) == at.getTonnage(entity))) {</b>
<b class="nc">&nbsp;                    vTypes.add(atCheck);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if ((vTypes.size() &lt; 1)</b>
<b class="nc">&nbsp;                    &amp;&amp; !client.getGame().getOptions()</b>
<b class="nc">&nbsp;                            .booleanOption(OptionsConstants.BASE_LOBBY_AMMO_DUMP)</b>
<b class="nc">&nbsp;                    &amp;&amp; !client.getGame().getOptions()</b>
<b class="nc">&nbsp;                            .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_HOTLOAD)) { //$NON-NLS-1$</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            MunitionChoicePanel mcp;
<b class="nc">&nbsp;            mcp = new MunitionChoicePanel(m, vTypes, m_vWeaponAmmoChoice);</b>
<b class="nc">&nbsp;            panMunitions.add(mcp, GBC.eol());</b>
<b class="nc">&nbsp;            m_vMunitions.add(mcp);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Worker function that creates a series of weapon ammo choice panels that allow the user to pick a particular ammo bin for an 
&nbsp;     * ammo-using weapon with matching ammo.
&nbsp;     */
&nbsp;    private void setupWeaponAmmoChoice() {
<b class="nc">&nbsp;        GridBagLayout gbl = new GridBagLayout();</b>
<b class="nc">&nbsp;        panWeaponAmmoSelector.setLayout(gbl);</b>
&nbsp;        
<b class="nc">&nbsp;        for(Mounted weapon : entity.getWeaponList()) {</b>
<b class="nc">&nbsp;            WeaponType weaponType = weapon.getType() instanceof WeaponType ? (WeaponType) weapon.getType() : null;</b>
&nbsp;            
&nbsp;            // don&#39;t deal with bay or grouped weapons for now 
<b class="nc">&nbsp;            if(weaponType == null || weaponType.getAmmoType() == AmmoType.T_NA) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            WeaponAmmoChoicePanel ammoChoicePanel = new WeaponAmmoChoicePanel(weapon);</b>
<b class="nc">&nbsp;            panWeaponAmmoSelector.add(ammoChoicePanel, GBC.eol());</b>
<b class="nc">&nbsp;            m_vWeaponAmmoChoice.add(ammoChoicePanel);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;    
&nbsp;        class MineChoicePanel extends JPanel {
&nbsp;            /**
&nbsp;             *
&nbsp;             */
&nbsp;            private static final long serialVersionUID = -1868675102440527538L;
&nbsp;
&nbsp;            private JComboBox&lt;String&gt; m_choice;
&nbsp;
&nbsp;            private Mounted m_mounted;
&nbsp;
<b class="nc">&nbsp;            MineChoicePanel(Mounted m) {</b>
<b class="nc">&nbsp;                m_mounted = m;</b>
<b class="nc">&nbsp;                m_choice = new JComboBox&lt;String&gt;();</b>
<b class="nc">&nbsp;                m_choice.addItem(Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;CustomMechDialog.Conventional&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                m_choice.addItem(Messages.getString(&quot;CustomMechDialog.Vibrabomb&quot;)); //$NON-NLS-1$</b>
&nbsp;                // m_choice.add(&quot;Messages.getString(&quot;CustomMechDialog.Command-detonated&quot;));
&nbsp;                // //$NON-NLS-1$
&nbsp;                int loc;
<b class="nc">&nbsp;                loc = m.getLocation();</b>
<b class="nc">&nbsp;                String sDesc = &#39;(&#39; + entity.getLocationAbbr(loc) + &#39;)&#39;;</b>
<b class="nc">&nbsp;                JLabel lLoc = new JLabel(sDesc);</b>
<b class="nc">&nbsp;                GridBagLayout gbl = new GridBagLayout();</b>
<b class="nc">&nbsp;                setLayout(gbl);</b>
<b class="nc">&nbsp;                add(lLoc, GBC.std());</b>
<b class="nc">&nbsp;                m_choice.setSelectedIndex(m.getMineType());</b>
<b class="nc">&nbsp;                add(m_choice, GBC.eol());</b>
&nbsp;            }
&nbsp;
&nbsp;            public void applyChoice() {
<b class="nc">&nbsp;                m_mounted.setMineType(m_choice.getSelectedIndex());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void setEnabled(boolean enabled) {
<b class="nc">&nbsp;                m_choice.setEnabled(enabled);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
&nbsp;        /**
&nbsp;         * A panel that houses a label and a combo box that allows for selecting
&nbsp;         * which anti-personnel weapon is mounted in an AP mount.
&nbsp;         * 
&nbsp;         * @author arlith
&nbsp;         *
&nbsp;         */
&nbsp;        class APWeaponChoicePanel extends JPanel {
&nbsp;            
&nbsp;            /**
&nbsp;             * 
&nbsp;             */
&nbsp;            private static final long serialVersionUID = 6189888202192403704L;
&nbsp;
&nbsp;            private Entity entity;
&nbsp;            
&nbsp;            private ArrayList&lt;WeaponType&gt; m_APWeaps;
&nbsp;
&nbsp;            private JComboBox&lt;String&gt; m_choice;
&nbsp;
&nbsp;            private Mounted m_APmounted;
&nbsp;
&nbsp;            APWeaponChoicePanel(Entity e, Mounted m, 
<b class="nc">&nbsp;                    ArrayList&lt;WeaponType&gt; weapons) {</b>
<b class="nc">&nbsp;                entity = e;</b>
<b class="nc">&nbsp;                m_APWeaps = weapons;</b>
<b class="nc">&nbsp;                m_APmounted = m;</b>
<b class="nc">&nbsp;                EquipmentType  curType = null;</b>
<b class="nc">&nbsp;                if (m != null &amp;&amp; m.getLinked() != null){</b>
<b class="nc">&nbsp;                    curType = m.getLinked().getType();</b>
&nbsp;                }
<b class="nc">&nbsp;                m_choice = new JComboBox&lt;String&gt;();</b>
<b class="nc">&nbsp;                m_choice.addItem(&quot;None&quot;);</b>
<b class="nc">&nbsp;                m_choice.setSelectedIndex(0);</b>
<b class="nc">&nbsp;                Iterator&lt;WeaponType&gt; it = m_APWeaps.iterator();</b>
<b class="nc">&nbsp;                for (int x = 1; it.hasNext(); x++) {</b>
<b class="nc">&nbsp;                    WeaponType weap = it.next();</b>
<b class="nc">&nbsp;                    m_choice.addItem(weap.getName());</b>
<b class="nc">&nbsp;                    if (curType != null &amp;&amp; </b>
<b class="nc">&nbsp;                            weap.getInternalName() == </b>
<b class="nc">&nbsp;                                curType.getInternalName()) {</b>
<b class="nc">&nbsp;                        m_choice.setSelectedIndex(x);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                String sDesc = &quot;&quot;;</b>
<b class="nc">&nbsp;                if (m.getBaMountLoc() != BattleArmor.MOUNT_LOC_NONE){</b>
<b class="nc">&nbsp;                    sDesc += &quot; (&quot; </b>
<b class="nc">&nbsp;                            + BattleArmor.MOUNT_LOC_NAMES[m.getBaMountLoc()] </b>
&nbsp;                            + &#39;)&#39;;
&nbsp;                } else {
<b class="nc">&nbsp;                    sDesc = &quot;None&quot;;</b>
&nbsp;                }
<b class="nc">&nbsp;                JLabel lLoc = new JLabel(sDesc);</b>
<b class="nc">&nbsp;                GridBagLayout g = new GridBagLayout();</b>
<b class="nc">&nbsp;                setLayout(g);</b>
<b class="nc">&nbsp;                add(lLoc, GBC.std());</b>
<b class="nc">&nbsp;                add(m_choice, GBC.std());</b>
&nbsp;                
&nbsp;            }
&nbsp;
&nbsp;            public void applyChoice() {
<b class="nc">&nbsp;                int n = m_choice.getSelectedIndex();</b>
&nbsp;                // If there&#39;s no selection, there&#39;s nothing we can do
<b class="nc">&nbsp;                if (n == -1){</b>
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;                WeaponType apType = null;</b>
<b class="nc">&nbsp;                if (n &gt; 0 &amp;&amp; n &lt;= m_APWeaps.size()){</b>
&nbsp;                    // Need to account for the &quot;None&quot; selection
<b class="nc">&nbsp;                    apType = m_APWeaps.get(n-1);</b>
&nbsp;                }
&nbsp;                
&nbsp;                // Remove any currently mounted AP weapon
<b class="nc">&nbsp;                if (m_APmounted.getLinked() != null </b>
<b class="nc">&nbsp;                        &amp;&amp; m_APmounted.getLinked().getType() != apType) {</b>
<b class="nc">&nbsp;                    Mounted apWeapon = m_APmounted.getLinked();</b>
<b class="nc">&nbsp;                    entity.getEquipment().remove(apWeapon);</b>
<b class="nc">&nbsp;                    entity.getWeaponList().remove(apWeapon);</b>
<b class="nc">&nbsp;                    entity.getTotalWeaponList().remove(apWeapon);</b>
&nbsp;                    // We need to make sure that the weapon has been removed
&nbsp;                    //  from the criticals, otherwise it can cause issues
<b class="nc">&nbsp;                    for (int loc = 0; loc &lt; entity.locations(); loc++) {</b>
<b class="nc">&nbsp;                        for (int c = 0; </b>
<b class="nc">&nbsp;                                c &lt; entity.getNumberOfCriticals(loc); c++) {</b>
<b class="nc">&nbsp;                            CriticalSlot crit = entity.getCritical(loc, c);</b>
<b class="nc">&nbsp;                            if (crit != null &amp;&amp; crit.getMount() != null </b>
<b class="nc">&nbsp;                                    &amp;&amp; crit.getMount().equals(apWeapon)) {</b>
<b class="nc">&nbsp;                                entity.setCritical(loc, c, null);</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;                
&nbsp;                // Did the selection not change, or no weapon was selected
<b class="nc">&nbsp;                if ((m_APmounted.getLinked() != null </b>
<b class="nc">&nbsp;                        &amp;&amp; m_APmounted.getLinked().getType() == apType)</b>
&nbsp;                        || n == 0){
&nbsp;                    return;
&nbsp;                }
&nbsp;                    
&nbsp;                // Add the newly mounted weapon
&nbsp;                try{
<b class="nc">&nbsp;                    Mounted newWeap =  entity.addEquipment(apType, </b>
<b class="nc">&nbsp;                            m_APmounted.getLocation());</b>
<b class="nc">&nbsp;                    m_APmounted.setLinked(newWeap);</b>
<b class="nc">&nbsp;                    newWeap.setLinked(m_APmounted);</b>
<b class="nc">&nbsp;                    newWeap.setAPMMounted(true);</b>
<b class="nc">&nbsp;                } catch (LocationFullException ex){</b>
&nbsp;                    // This shouldn&#39;t happen for BA...
<b class="nc">&nbsp;                    ex.printStackTrace();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void setEnabled(boolean enabled) {
<b class="nc">&nbsp;                m_choice.setEnabled(enabled);</b>
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;        
&nbsp;        /**
&nbsp;         * A panel that houses a label and a combo box that allows for selecting
&nbsp;         * which maniulator is mounted in a modular equipment adaptor.
&nbsp;         * 
&nbsp;         * @author arlith
&nbsp;         *
&nbsp;         */
&nbsp;        class MEAChoicePanel extends JPanel {
&nbsp;            
&nbsp;            /**
&nbsp;             * 
&nbsp;             */
&nbsp;            private static final long serialVersionUID = 6189888202192403704L;
&nbsp;
&nbsp;            private Entity entity;
&nbsp;            
&nbsp;            private ArrayList&lt;MiscType&gt; m_Manipulators;
&nbsp;
&nbsp;            private JComboBox&lt;String&gt; m_choice;
&nbsp;
&nbsp;            /**
&nbsp;             * The manipulator currently mounted by a modular equipment adaptor.
&nbsp;             */
&nbsp;            private Mounted m_Manipmounted;
&nbsp;            
&nbsp;            /**
&nbsp;             * The BattleArmor mount location of the modular equipment adaptor.
&nbsp;             */
&nbsp;            private int baMountLoc;
&nbsp;            
&nbsp;
&nbsp;            MEAChoicePanel(Entity e, int mountLoc, Mounted m, 
<b class="nc">&nbsp;                    ArrayList&lt;MiscType&gt; manips) {</b>
<b class="nc">&nbsp;                entity = e;</b>
<b class="nc">&nbsp;                m_Manipulators = manips;</b>
<b class="nc">&nbsp;                m_Manipmounted = m;</b>
<b class="nc">&nbsp;                baMountLoc = mountLoc;</b>
<b class="nc">&nbsp;                EquipmentType  curType = null;</b>
<b class="nc">&nbsp;                if (m != null){</b>
<b class="nc">&nbsp;                    curType = m.getType();</b>
&nbsp;                }
<b class="nc">&nbsp;                m_choice = new JComboBox&lt;String&gt;();</b>
<b class="nc">&nbsp;                m_choice.addItem(&quot;None&quot;);</b>
<b class="nc">&nbsp;                m_choice.setSelectedIndex(0);</b>
<b class="nc">&nbsp;                Iterator&lt;MiscType&gt; it = m_Manipulators.iterator();</b>
<b class="nc">&nbsp;                for (int x = 1; it.hasNext(); x++) {</b>
<b class="nc">&nbsp;                    MiscType manip = it.next();</b>
<b class="nc">&nbsp;                    String manipName = manip.getName() + &quot; (&quot;</b>
<b class="nc">&nbsp;                            + manip.getTonnage(entity) + &quot;kg)&quot;;</b>
<b class="nc">&nbsp;                    m_choice.addItem(manipName);</b>
<b class="nc">&nbsp;                    if (curType != null &amp;&amp; </b>
<b class="nc">&nbsp;                            manip.getInternalName() == </b>
<b class="nc">&nbsp;                                curType.getInternalName()) {</b>
<b class="nc">&nbsp;                        m_choice.setSelectedIndex(x);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                String sDesc = &quot;&quot;;</b>
<b class="nc">&nbsp;                if (baMountLoc != BattleArmor.MOUNT_LOC_NONE){</b>
<b class="nc">&nbsp;                    sDesc += &quot; (&quot; </b>
&nbsp;                            + BattleArmor.MOUNT_LOC_NAMES[baMountLoc] 
&nbsp;                            + &#39;)&#39;;
&nbsp;                } else {
<b class="nc">&nbsp;                    sDesc = &quot;None&quot;;</b>
&nbsp;                }
<b class="nc">&nbsp;                JLabel lLoc = new JLabel(sDesc);</b>
<b class="nc">&nbsp;                GridBagLayout g = new GridBagLayout();</b>
<b class="nc">&nbsp;                setLayout(g);</b>
<b class="nc">&nbsp;                add(lLoc, GBC.std());</b>
<b class="nc">&nbsp;                add(m_choice, GBC.std());</b>
&nbsp;                
&nbsp;            }
&nbsp;
&nbsp;            public void applyChoice() {
<b class="nc">&nbsp;                int n = m_choice.getSelectedIndex();</b>
&nbsp;                // If there&#39;s no selection, there&#39;s nothing we can do
<b class="nc">&nbsp;                if (n == -1){</b>
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;                MiscType manipType = null;</b>
<b class="nc">&nbsp;                if (n &gt; 0 &amp;&amp; n &lt;= m_Manipulators.size()){</b>
&nbsp;                    // Need to account for the &quot;None&quot; selection
<b class="nc">&nbsp;                    manipType = m_Manipulators.get(n-1);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (m_Manipmounted != null){</b>
<b class="nc">&nbsp;                    entity.getEquipment().remove(m_Manipmounted);</b>
<b class="nc">&nbsp;                    entity.getMisc().remove(m_Manipmounted);</b>
&nbsp;                }            
&nbsp;                
&nbsp;                // Was no manipulator selected?
<b class="nc">&nbsp;                if (n == 0){</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;                    
&nbsp;                // Add the newly mounted maniplator
&nbsp;                try{
<b class="nc">&nbsp;                    m_Manipmounted = entity.addEquipment(manipType, </b>
<b class="nc">&nbsp;                            m_Manipmounted.getLocation());</b>
<b class="nc">&nbsp;                    m_Manipmounted.setBaMountLoc(baMountLoc);</b>
<b class="nc">&nbsp;                } catch (LocationFullException ex){</b>
&nbsp;                    // This shouldn&#39;t happen for BA...
<b class="nc">&nbsp;                    ex.printStackTrace();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void setEnabled(boolean enabled) {
<b class="nc">&nbsp;                m_choice.setEnabled(enabled);</b>
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        class MunitionChoicePanel extends JPanel {</b>
&nbsp;            /**
&nbsp;             *
&nbsp;             */
&nbsp;            private static final long serialVersionUID = 3401106035583965326L;
&nbsp;
&nbsp;            private List&lt;AmmoType&gt; m_vTypes;
&nbsp;
&nbsp;            private JComboBox&lt;AmmoType&gt; m_choice;
&nbsp;            
&nbsp;            @SuppressWarnings(&quot;rawtypes&quot;)
&nbsp;            private JComboBox m_num_shots;
&nbsp;            private ItemListener numShotsListener;
&nbsp;           
<b class="nc">&nbsp;            boolean numShotsChanged = false;</b>
&nbsp;
&nbsp;            private Mounted m_mounted;
&nbsp;
<b class="nc">&nbsp;            JLabel labDump = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labDump&quot;)); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;            JCheckBox chDump = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;            JLabel labHotLoad = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.switchToHotLoading&quot;)); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;            JCheckBox chHotLoad = new JCheckBox();</b>
&nbsp;            
&nbsp;            @SuppressWarnings(&quot;unchecked&quot;)
<b class="nc">&nbsp;            MunitionChoicePanel(Mounted m, ArrayList&lt;AmmoType&gt; vTypes, List&lt;WeaponAmmoChoicePanel&gt; weaponAmmoChoicePanels) {</b>
<b class="nc">&nbsp;                m_vTypes = vTypes;</b>
<b class="nc">&nbsp;                m_mounted = m;</b>
&nbsp;                
<b class="nc">&nbsp;                AmmoType curType = (AmmoType) m.getType();</b>
<b class="nc">&nbsp;                m_choice = new JComboBox&lt;AmmoType&gt;();</b>
<b class="nc">&nbsp;                Iterator&lt;AmmoType&gt; e = m_vTypes.iterator();</b>
<b class="nc">&nbsp;                for (int x = 0; e.hasNext(); x++) {</b>
<b class="nc">&nbsp;                    AmmoType at = e.next();</b>
<b class="nc">&nbsp;                    m_choice.addItem(at);</b>
<b class="nc">&nbsp;                    if (at.equals(curType)) {</b>
<b class="nc">&nbsp;                        m_choice.setSelectedIndex(x);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                numShotsListener = new ItemListener() {</b>
&nbsp;                    @Override
&nbsp;                    public void itemStateChanged(ItemEvent evt) {
<b class="nc">&nbsp;                        numShotsChanged = true;</b>
&nbsp;                    }
&nbsp;                };
<b class="nc">&nbsp;                m_num_shots = new JComboBox&lt;String&gt;();</b>
<b class="nc">&nbsp;                int shotsPerTon = curType.getShots();</b>
&nbsp;                // BattleArmor always have a certain number of shots per slot
<b class="nc">&nbsp;                int stepSize = 1;</b>
&nbsp;                // Protomechs and BattleArmor are limited to the number of shots allocated in construction
<b class="nc">&nbsp;                if ((entity instanceof BattleArmor) || (entity instanceof Protomech)) {</b>
<b class="nc">&nbsp;                    shotsPerTon = m.getOriginalShots();</b>
&nbsp;                    // BA tube artillery always comes in pairs
<b class="nc">&nbsp;                    if (curType.getAmmoType() == AmmoType.T_BA_TUBE) {</b>
<b class="nc">&nbsp;                        stepSize = 2;</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                for (int i = 0; i &lt;= shotsPerTon; i += stepSize){</b>
<b class="nc">&nbsp;                    m_num_shots.addItem(i);</b>
&nbsp;                }
<b class="nc">&nbsp;                m_num_shots.setSelectedItem(m_mounted.getBaseShotsLeft());</b>
<b class="nc">&nbsp;                m_num_shots.addItemListener(numShotsListener);</b>
&nbsp;
<b class="nc">&nbsp;                m_choice.addItemListener(new ItemListener(){</b>
&nbsp;                    @Override
&nbsp;                    public void itemStateChanged(ItemEvent evt) {
<b class="nc">&nbsp;                        m_num_shots.removeItemListener(numShotsListener);</b>
<b class="nc">&nbsp;                        int currShots = (Integer) m_num_shots.getSelectedItem();</b>
<b class="nc">&nbsp;                        m_num_shots.removeAllItems();</b>
<b class="nc">&nbsp;                        int shotsPerTon = m_vTypes.get(m_choice.getSelectedIndex()).getShots();</b>
&nbsp;                        
&nbsp;                        // Protomechs are limited to number of shots added during construction
<b class="nc">&nbsp;                        if ((entity instanceof BattleArmor) || (entity instanceof Protomech)) {</b>
<b class="nc">&nbsp;                            shotsPerTon = m.getOriginalShots();</b>
&nbsp;                        }
<b class="nc">&nbsp;                        for (int i = 0; i &lt;= shotsPerTon; i++){</b>
<b class="nc">&nbsp;                            m_num_shots.addItem(i);</b>
&nbsp;                        }
&nbsp;                        // If the shots selection was changed, try to set that value, unless it&#39;s too large
<b class="nc">&nbsp;                        if (numShotsChanged &amp;&amp; currShots &lt;= shotsPerTon){</b>
<b class="nc">&nbsp;                            m_num_shots.setSelectedItem(currShots);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            m_num_shots.setSelectedItem(shotsPerTon);</b>
&nbsp;                        }
&nbsp;                        
<b class="nc">&nbsp;                        for(WeaponAmmoChoicePanel weaponAmmoChoicePanel : weaponAmmoChoicePanels) {</b>
<b class="nc">&nbsp;                            weaponAmmoChoicePanel.refreshAmmoBinName(m_mounted, m_vTypes.get(m_choice.getSelectedIndex()));</b>
<b class="nc">&nbsp;                        }</b>
&nbsp;                        
<b class="nc">&nbsp;                        m_num_shots.addItemListener(numShotsListener);</b>
&nbsp;                    }});
&nbsp;
&nbsp;
<b class="nc">&nbsp;                int loc = m.getLocation();</b>
<b class="nc">&nbsp;                boolean isOneShot = false;</b>
<b class="nc">&nbsp;                if (loc == Entity.LOC_NONE) {</b>
&nbsp;                    // oneshot weapons don&#39;t have a location of their own
&nbsp;                    // some weapons (e.g. fusillade) use the one-shot mechanic but have an extra reload
&nbsp;                    // which is chained to the first
<b class="nc">&nbsp;                    Mounted linkedBy = m.getLinkedBy();</b>
<b class="nc">&nbsp;                    while (linkedBy.getLinkedBy() != null) {</b>
<b class="nc">&nbsp;                        linkedBy = linkedBy.getLinkedBy();</b>
&nbsp;                    }
<b class="nc">&nbsp;                    loc = linkedBy.getLocation();</b>
<b class="nc">&nbsp;                    isOneShot = linkedBy.isOneShot();</b>
<b class="nc">&nbsp;                } else {</b>
<b class="nc">&nbsp;                    loc = m.getLocation();</b>
&nbsp;                }
<b class="nc">&nbsp;                m_num_shots.setVisible(!isOneShot);</b>
<b class="nc">&nbsp;                String sDesc = &#39;(&#39; + entity.getLocationAbbr(loc) + &#39;)&#39;;</b>
<b class="nc">&nbsp;                JLabel lLoc = new JLabel(sDesc);</b>
<b class="nc">&nbsp;                GridBagLayout g = new GridBagLayout();</b>
<b class="nc">&nbsp;                setLayout(g);</b>
<b class="nc">&nbsp;                add(lLoc, GBC.std());</b>
<b class="nc">&nbsp;                add(m_choice, GBC.std());</b>
<b class="nc">&nbsp;                add(m_num_shots, GBC.eol());</b>
<b class="nc">&nbsp;                chHotLoad.setSelected(m_mounted.isHotLoaded());</b>
<b class="nc">&nbsp;                if (clientgui.getClient().getGame().getOptions().booleanOption(</b>
&nbsp;                        OptionsConstants.BASE_LOBBY_AMMO_DUMP)) { //$NON-NLS-1$
<b class="nc">&nbsp;                    add(labDump, GBC.std());</b>
<b class="nc">&nbsp;                    add(chDump, GBC.eol());</b>
<b class="nc">&nbsp;                    if (clientgui.getClient().getGame().getOptions().booleanOption(</b>
&nbsp;                            OptionsConstants.ADVCOMBAT_TACOPS_HOTLOAD)
<b class="nc">&nbsp;                            &amp;&amp; curType.hasFlag(AmmoType.F_HOTLOAD)) {</b>
<b class="nc">&nbsp;                        add(labHotLoad, GBC.std());</b>
<b class="nc">&nbsp;                        add(chHotLoad, GBC.eol());</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else if (clientgui.getClient().getGame().getOptions().booleanOption(</b>
&nbsp;                        OptionsConstants.ADVCOMBAT_TACOPS_HOTLOAD)
<b class="nc">&nbsp;                        &amp;&amp; curType.hasFlag(AmmoType.F_HOTLOAD)) {</b>
<b class="nc">&nbsp;                    add(labHotLoad, GBC.std());</b>
<b class="nc">&nbsp;                    add(chHotLoad, GBC.eol());</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            public void applyChoice() {
<b class="nc">&nbsp;                int n = m_choice.getSelectedIndex();</b>
&nbsp;                // If there&#39;s no selection, there&#39;s nothing we can do
<b class="nc">&nbsp;                if (n == -1){</b>
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;                AmmoType at = m_vTypes.get(n);</b>
<b class="nc">&nbsp;                m_mounted.changeAmmoType(at);</b>
&nbsp;                
&nbsp;                // set # shots only for non-one shot weapons
<b class="nc">&nbsp;                if (m_mounted.getLocation() != Entity.LOC_NONE) {</b>
<b class="nc">&nbsp;                    m_mounted.setShotsLeft((Integer)m_num_shots.getSelectedItem());</b>
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                if (chDump.isSelected()) {</b>
<b class="nc">&nbsp;                    m_mounted.setShotsLeft(0);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (clientgui.getClient().getGame().getOptions().booleanOption(</b>
&nbsp;                        OptionsConstants.ADVCOMBAT_TACOPS_HOTLOAD)) {
<b class="nc">&nbsp;                    if (chHotLoad.isSelected() != m_mounted.isHotLoaded()) {</b>
<b class="nc">&nbsp;                        m_mounted.setHotLoad(chHotLoad.isSelected());</b>
&nbsp;                        // Set the mode too, so vehicles can switch back
<b class="nc">&nbsp;                        int numModes = m_mounted.getType().getModesCount();</b>
<b class="nc">&nbsp;                        for (int m = 0; m &lt; numModes; m++) {</b>
<b class="nc">&nbsp;                            if (m_mounted.getType().getMode(m).getName()</b>
<b class="nc">&nbsp;                                    .equals(&quot;HotLoad&quot;)) {</b>
<b class="nc">&nbsp;                                m_mounted.setMode(m);</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void setEnabled(boolean enabled) {
<b class="nc">&nbsp;                m_choice.setEnabled(enabled);</b>
&nbsp;            }
&nbsp;
&nbsp;            /**
&nbsp;             * Get the number of shots in the mount.
&nbsp;             *
&nbsp;             * @return the &lt;code&gt;int&lt;/code&gt; number of shots in the mount.
&nbsp;             */
&nbsp;            int getShotsLeft() {
<b class="nc">&nbsp;                return m_mounted.getBaseShotsLeft();</b>
&nbsp;            }
&nbsp;
&nbsp;            /**
&nbsp;             * Set the number of shots in the mount.
&nbsp;             *
&nbsp;             * @param shots
&nbsp;             *            the &lt;code&gt;int&lt;/code&gt; number of shots for the mount.
&nbsp;             */
&nbsp;            void setShotsLeft(int shots) {
<b class="nc">&nbsp;                m_mounted.setShotsLeft(shots);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;     * When a Protomech selects ammo, you need to adjust the shots on the unit
&nbsp;     * for the weight of the selected munition.
&nbsp;     * 
&nbsp;     * @deprecated I don&#39;t see any purpose for this anymore, but I can&#39;t tell
&nbsp;     *             why it was originally added. Using this for Protomechs ends
&nbsp;     *             up adjusting the ammo incorrectly. It is true that Protos use
&nbsp;     *             ammo as kg/shot, and they aren&#39;t restricted to the max per
&nbsp;     *             shots per slot, but this really doesn&#39;t handle that.  Really,
&nbsp;     *             we need a ProtomechVerifier to ensure users don&#39;t add more 
&nbsp;     *             ammo than the Proto can support.
&nbsp;     */
&nbsp;        @Deprecated
&nbsp;        class ProtomechMunitionChoicePanel extends MunitionChoicePanel {
&nbsp;            /**
&nbsp;             *
&nbsp;             */
&nbsp;            private static final long serialVersionUID = -8170286698673268120L;
&nbsp;
&nbsp;            private final float m_origShotsLeft;
&nbsp;
&nbsp;            private final AmmoType m_origAmmo;
&nbsp;
<b class="nc">&nbsp;            ProtomechMunitionChoicePanel(Mounted m, ArrayList&lt;AmmoType&gt; vTypes) {</b>
<b class="nc">&nbsp;                super(m, vTypes, null);</b>
<b class="nc">&nbsp;                m_origAmmo = (AmmoType) m.getType();</b>
<b class="nc">&nbsp;                m_origShotsLeft = m.getBaseShotsLeft();</b>
&nbsp;            }
&nbsp;
&nbsp;            /**
&nbsp;             * All ammo must be applied in ratios to the starting load.
&nbsp;             */
&nbsp;            @Override
&nbsp;            public void applyChoice() {
<b class="nc">&nbsp;                super.applyChoice();</b>
&nbsp;
&nbsp;                // Calculate the number of shots for the new ammo.
&nbsp;                // N.B. Some special ammos are twice as heavy as normal
&nbsp;                // so they have half the number of shots (rounded down).
<b class="nc">&nbsp;                setShotsLeft(Math.round((getShotsLeft() * m_origShotsLeft)</b>
<b class="nc">&nbsp;                        / m_origAmmo.getShots()));</b>
<b class="nc">&nbsp;                if (chDump.isSelected()) {</b>
<b class="nc">&nbsp;                    setShotsLeft(0);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        
&nbsp;        /**
&nbsp;         * A panel representing the option to choose a particular ammo bin for an individual weapon.
&nbsp;         * @author NickAragua
&nbsp;         *
&nbsp;         */
&nbsp;        class WeaponAmmoChoicePanel extends JPanel {
&nbsp;            /**
&nbsp;             * 
&nbsp;             */
&nbsp;            private static final long serialVersionUID = 604670659251519188L;
&nbsp;            // the weapon being displayed in this row
&nbsp;            private Mounted m_mounted;
&nbsp;            private ArrayList&lt;Mounted&gt; matchingAmmoBins;
&nbsp;            
&nbsp;            private JComboBox&lt;String&gt; ammoBins;
&nbsp;            
&nbsp;            /**
&nbsp;             * Constructor
&nbsp;             * @param weapon The mounted weapon. Assumes that the weapon uses ammo.
&nbsp;             */
<b class="nc">&nbsp;            public WeaponAmmoChoicePanel(Mounted weapon) {</b>
&nbsp;                // for safety purposes, if the given mounted isn&#39;t a weapon, don&#39;t do anything.
<b class="nc">&nbsp;                if (!(weapon.getType() instanceof WeaponType)) {</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                m_mounted = weapon;</b>
&nbsp;                
<b class="nc">&nbsp;                this.setLayout(new GridBagLayout());</b>
&nbsp;                
<b class="nc">&nbsp;                JLabel weaponName = new JLabel();</b>
<b class="nc">&nbsp;                weaponName.setText(&quot;(&quot; + weapon.getEntity().getLocationAbbr(weapon.getLocation()) + &quot;) &quot; + weapon.getName());</b>
<b class="nc">&nbsp;                add(weaponName, GBC.std());</b>
&nbsp;                
<b class="nc">&nbsp;                ammoBins = new JComboBox&lt;&gt;();</b>
<b class="nc">&nbsp;                matchingAmmoBins = new ArrayList&lt;&gt;();</b>
&nbsp;                
<b class="nc">&nbsp;                if (m_mounted.isOneShot() || (entity.isSupportVehicle()</b>
<b class="nc">&nbsp;                        &amp;&amp; (m_mounted.getType() instanceof InfantryWeapon))) {</b>
&nbsp;                    // One-shot weapons can only access their own bin
<b class="nc">&nbsp;                    matchingAmmoBins.add(m_mounted.getLinked());</b>
&nbsp;                    // Fusillade and some small SV weapons are treated like one-shot
&nbsp;                    // weapons but may have a second munition type available.
<b class="nc">&nbsp;                    if ((m_mounted.getLinked().getLinked() != null)</b>
<b class="nc">&nbsp;                            &amp;&amp; (((AmmoType) m_mounted.getLinked().getType()).getMunitionType()</b>
<b class="nc">&nbsp;                                != (((AmmoType) m_mounted.getLinked().getLinked().getType()).getMunitionType()))) {</b>
<b class="nc">&nbsp;                        matchingAmmoBins.add(m_mounted.getLinked().getLinked());</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    for (Mounted ammoBin : weapon.getEntity().getAmmo()) {</b>
<b class="nc">&nbsp;                        if ((ammoBin.getLocation() != Entity.LOC_NONE)</b>
<b class="nc">&nbsp;                            &amp;&amp; AmmoType.canSwitchToAmmo(weapon, (AmmoType) ammoBin.getType())) {</b>
<b class="nc">&nbsp;                            matchingAmmoBins.add(ammoBin);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                add(ammoBins, GBC.eol());</b>
<b class="nc">&nbsp;                refreshAmmoBinNames();</b>
&nbsp;            }
&nbsp;
&nbsp;            /**
&nbsp;             * Worker function that refreshes the combo box with &quot;up-to-date&quot; ammo names.
&nbsp;             */
&nbsp;            public void refreshAmmoBinNames() {
<b class="nc">&nbsp;                int selectedIndex = ammoBins.getSelectedIndex();</b>
<b class="nc">&nbsp;                ammoBins.removeAllItems();</b>
&nbsp;                
<b class="nc">&nbsp;                int currentIndex = 0;</b>
<b class="nc">&nbsp;                for (Mounted ammoBin : matchingAmmoBins) {</b>
<b class="nc">&nbsp;                    ammoBins.addItem(&quot;(&quot; + ammoBin.getEntity().getLocationAbbr(ammoBin.getLocation()) + &quot;) &quot; + ammoBin.getName());</b>
<b class="nc">&nbsp;                    if (m_mounted.getLinked() == ammoBin) {</b>
<b class="nc">&nbsp;                        selectedIndex = currentIndex;</b>
&nbsp;                    }
&nbsp;                    
<b class="nc">&nbsp;                    currentIndex++;</b>
<b class="nc">&nbsp;                }</b>
&nbsp;                
<b class="nc">&nbsp;                if (selectedIndex &gt;= 0) {</b>
<b class="nc">&nbsp;                    ammoBins.setSelectedIndex(selectedIndex);</b>
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                validate();</b>
&nbsp;            }
&nbsp;            
&nbsp;            /**
&nbsp;             * Refreshes a single item in the ammo type combo box to display the correct ammo type name.
&nbsp;             * Because the underlying ammo bin hasn&#39;t been updated yet, we carry out the name swap &quot;in-place&quot;.
&nbsp;             * @param ammoBin The ammo bin whose ammo type has probably changed.
&nbsp;             * @param selectedAmmoType The new ammo type.
&nbsp;             */
&nbsp;            public void refreshAmmoBinName(Mounted ammoBin, AmmoType selectedAmmoType) {
<b class="nc">&nbsp;                int index = 0;</b>
<b class="nc">&nbsp;                boolean matchFound = false;</b>
&nbsp;                
<b class="nc">&nbsp;                for (index = 0; index &lt; matchingAmmoBins.size(); index++) {</b>
<b class="nc">&nbsp;                    if (matchingAmmoBins.get(index) == ammoBin) {</b>
<b class="nc">&nbsp;                        matchFound = true;</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                if (matchFound) {</b>
<b class="nc">&nbsp;                    int currentBinIndex = ammoBins.getSelectedIndex();</b>
&nbsp;                    
<b class="nc">&nbsp;                    ammoBins.removeItemAt(index);</b>
<b class="nc">&nbsp;                    ammoBins.insertItemAt(&quot;(&quot; + ammoBin.getEntity().getLocationAbbr(ammoBin.getLocation()) + &quot;) &quot; + selectedAmmoType.getName(), index);</b>
&nbsp;                    
<b class="nc">&nbsp;                    if (currentBinIndex == index) {</b>
<b class="nc">&nbsp;                        ammoBins.setSelectedIndex(index);</b>
&nbsp;                    }
&nbsp;                    
<b class="nc">&nbsp;                    validate();</b>
&nbsp;                }
&nbsp;            }
&nbsp;            
&nbsp;            /**
&nbsp;             * Common functionality that applies the panel&#39;s current ammo bin choice to the panel&#39;s weapon.
&nbsp;             */
&nbsp;            public void applyChoice() {
<b class="nc">&nbsp;                int selectedIndex = ammoBins.getSelectedIndex();</b>
<b class="nc">&nbsp;                if ((selectedIndex &gt;= 0) &amp;&amp; (selectedIndex &lt; matchingAmmoBins.size())) {</b>
<b class="nc">&nbsp;                    entity.loadWeapon(m_mounted, matchingAmmoBins.get(selectedIndex));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        class RapidfireMGPanel extends JPanel {
&nbsp;            /**
&nbsp;             *
&nbsp;             */
&nbsp;            private static final long serialVersionUID = 5261919826318225201L;
&nbsp;
&nbsp;            private Mounted m_mounted;
&nbsp;
<b class="nc">&nbsp;            JCheckBox chRapid = new JCheckBox();</b>
&nbsp;
<b class="nc">&nbsp;            RapidfireMGPanel(Mounted m) {</b>
<b class="nc">&nbsp;                m_mounted = m;</b>
<b class="nc">&nbsp;                int loc = m.getLocation();</b>
<b class="nc">&nbsp;                String sDesc = Messages</b>
<b class="nc">&nbsp;                        .getString(</b>
<b class="nc">&nbsp;                                &quot;CustomMechDialog.switchToRapidFire&quot;, new Object[] { entity.getLocationAbbr(loc) }); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                JLabel labRapid = new JLabel(sDesc);</b>
<b class="nc">&nbsp;                GridBagLayout g = new GridBagLayout();</b>
<b class="nc">&nbsp;                setLayout(g);</b>
<b class="nc">&nbsp;                add(labRapid, GBC.std().anchor(GridBagConstraints.EAST));</b>
<b class="nc">&nbsp;                chRapid.setSelected(m.isRapidfire());</b>
<b class="nc">&nbsp;                add(chRapid, GBC.eol());</b>
&nbsp;            }
&nbsp;
&nbsp;            public void applyChoice() {
<b class="nc">&nbsp;                boolean b = chRapid.isSelected();</b>
<b class="nc">&nbsp;                m_mounted.setRapidfire(b);</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void setEnabled(boolean enabled) {
<b class="nc">&nbsp;                chRapid.setEnabled(enabled);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        class InfantryArmorPanel extends JPanel {
&nbsp;            /**
&nbsp;             *
&nbsp;             */
&nbsp;            private static final long serialVersionUID = -909995917737642853L;
&nbsp;
&nbsp;            private Infantry inf;
<b class="nc">&nbsp;            JLabel labArmor = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labInfantryArmor&quot;));</b>
<b class="nc">&nbsp;            JLabel labDivisor = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labDamageDivisor&quot;));</b>
<b class="nc">&nbsp;            JLabel labEncumber = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labEncumber&quot;));</b>
<b class="nc">&nbsp;            JLabel labSpaceSuit = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labSpaceSuit&quot;));</b>
<b class="nc">&nbsp;            JLabel labDEST = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labDEST&quot;));</b>
<b class="nc">&nbsp;            JLabel labSneakCamo = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labSneakCamo&quot;));</b>
<b class="nc">&nbsp;            JLabel labSneakIR = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labSneakIR&quot;));</b>
<b class="nc">&nbsp;            JLabel labSneakECM = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labSneakECM&quot;));</b>
<b class="nc">&nbsp;            JLabel labSpec = new JLabel(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CustomMechDialog.labInfSpec&quot;));</b>
<b class="nc">&nbsp;            private JComboBox&lt;String&gt; cbArmorKit = new JComboBox&lt;&gt;();</b>
<b class="nc">&nbsp;            private JTextField fldDivisor = new JTextField(3);</b>
<b class="nc">&nbsp;            JCheckBox chEncumber = new JCheckBox();</b>
<b class="nc">&nbsp;            JCheckBox chSpaceSuit = new JCheckBox();</b>
<b class="nc">&nbsp;            JCheckBox chDEST = new JCheckBox();</b>
<b class="nc">&nbsp;            JCheckBox chSneakCamo = new JCheckBox();</b>
<b class="nc">&nbsp;            JCheckBox chSneakIR = new JCheckBox();</b>
<b class="nc">&nbsp;            JCheckBox chSneakECM = new JCheckBox();</b>
<b class="nc">&nbsp;            List&lt;JCheckBox&gt; chSpecs = new ArrayList&lt;&gt;(</b>
&nbsp;                    Infantry.NUM_SPECIALIZATIONS);
&nbsp;            
<b class="nc">&nbsp;            List&lt;EquipmentType&gt; armorKits = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;            InfantryArmorPanel() {</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt; Infantry.NUM_SPECIALIZATIONS; i++) {</b>
<b class="nc">&nbsp;                    int spec = 1 &lt;&lt; i;</b>
<b class="nc">&nbsp;                    JCheckBox newSpec = new JCheckBox();</b>
<b class="nc">&nbsp;                    newSpec.setText(Infantry.getSpecializationName(spec));</b>
<b class="nc">&nbsp;                    newSpec.setToolTipText(Infantry.getSpecializationTooltip(spec));</b>
<b class="nc">&nbsp;                    chSpecs.add(newSpec);</b>
&nbsp;                }
&nbsp;                
<b class="nc">&nbsp;                GridBagLayout g = new GridBagLayout();</b>
<b class="nc">&nbsp;                setLayout(g);</b>
<b class="nc">&nbsp;                add(labArmor, GBC.std());</b>
<b class="nc">&nbsp;                add(cbArmorKit, GBC.eol());</b>
<b class="nc">&nbsp;                add(labDivisor, GBC.std());</b>
<b class="nc">&nbsp;                add(fldDivisor, GBC.eol());</b>
<b class="nc">&nbsp;                add(labEncumber, GBC.std());</b>
<b class="nc">&nbsp;                add(chEncumber, GBC.eol());</b>
<b class="nc">&nbsp;                add(labSpaceSuit, GBC.std());</b>
<b class="nc">&nbsp;                add(chSpaceSuit, GBC.eol());</b>
<b class="nc">&nbsp;                add(labDEST, GBC.std());</b>
<b class="nc">&nbsp;                add(chDEST, GBC.eol());</b>
<b class="nc">&nbsp;                add(labSneakCamo, GBC.std());</b>
<b class="nc">&nbsp;                add(chSneakCamo, GBC.eol());</b>
<b class="nc">&nbsp;                add(labSneakIR, GBC.std());</b>
<b class="nc">&nbsp;                add(chSneakIR, GBC.eol());</b>
<b class="nc">&nbsp;                add(labSneakECM, GBC.std());</b>
<b class="nc">&nbsp;                add(chSneakECM, GBC.eol());</b>
<b class="nc">&nbsp;                add(Box.createVerticalStrut(10), GBC.eol());</b>
<b class="nc">&nbsp;                add(labSpec, GBC.eol());</b>
<b class="nc">&nbsp;                for (JCheckBox spec : chSpecs) {</b>
<b class="nc">&nbsp;                    add(spec, GBC.eol());</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;
&nbsp;            public void initialize() {
<b class="nc">&nbsp;                inf = (Infantry) entity;</b>
&nbsp;                
<b class="nc">&nbsp;                SimpleTechLevel gameTechLevel = SimpleTechLevel.getGameTechLevel(client.getGame());</b>
<b class="nc">&nbsp;                int year = client.getGame().getOptions().intOption(&quot;year&quot;);</b>
<b class="nc">&nbsp;                for (Enumeration&lt;EquipmentType&gt; e = MiscType.getAllTypes(); e.hasMoreElements();) {</b>
<b class="nc">&nbsp;                    final EquipmentType et = e.nextElement();</b>
<b class="nc">&nbsp;                    if (et.hasFlag(MiscType.F_ARMOR_KIT)</b>
<b class="nc">&nbsp;                            &amp;&amp; et.isLegal(year, gameTechLevel, entity.isClan(), entity.isMixedTech())) {</b>
<b class="nc">&nbsp;                        armorKits.add(et);</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                Collections.sort(armorKits, (et1, et2) -&gt; et1.getName().compareTo(et2.getName()));</b>
&nbsp;
<b class="nc">&nbsp;                cbArmorKit.addItem(Messages.getString(&quot;CustomMechDialog.Custom&quot;));</b>
<b class="nc">&nbsp;                armorKits.forEach(k -&gt; cbArmorKit.addItem(k.getName()));</b>
<b class="nc">&nbsp;                EquipmentType kit = inf.getArmorKit();</b>
<b class="nc">&nbsp;                if (kit == null) {</b>
<b class="nc">&nbsp;                    cbArmorKit.setSelectedIndex(0);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    cbArmorKit.setSelectedIndex(armorKits.indexOf(kit) + 1);</b>
&nbsp;                }
<b class="nc">&nbsp;                fldDivisor.setText(Double.toString(inf.calcDamageDivisor()));</b>
<b class="nc">&nbsp;                chEncumber.setSelected(inf.isArmorEncumbering());</b>
<b class="nc">&nbsp;                chSpaceSuit.setSelected(inf.hasSpaceSuit());</b>
<b class="nc">&nbsp;                chDEST.setSelected(inf.hasDEST());</b>
<b class="nc">&nbsp;                chSneakCamo.setSelected(inf.hasSneakCamo());</b>
<b class="nc">&nbsp;                chSneakIR.setSelected(inf.hasSneakIR());</b>
<b class="nc">&nbsp;                chSneakECM.setSelected(inf.hasSneakECM());</b>
<b class="nc">&nbsp;                armorStateChanged();</b>
<b class="nc">&nbsp;                cbArmorKit.addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;                    armorStateChanged();</b>
<b class="nc">&nbsp;                    updateArmorValues();</b>
&nbsp;                });
<b class="nc">&nbsp;                chDEST.addItemListener(e -&gt; armorStateChanged());</b>
&nbsp;
<b class="nc">&nbsp;                for (int i = 0; i &lt; Infantry.NUM_SPECIALIZATIONS; i++) {</b>
<b class="nc">&nbsp;                    int spec = 1 &lt;&lt; i;</b>
<b class="nc">&nbsp;                    chSpecs.get(i).setSelected(inf.hasSpecialization(spec));</b>
&nbsp;                }
&nbsp;            }
&nbsp;            
&nbsp;            public void armorStateChanged() {
<b class="nc">&nbsp;                fldDivisor.setEnabled(cbArmorKit.getSelectedIndex() == 0);</b>
<b class="nc">&nbsp;                chEncumber.setEnabled(cbArmorKit.getSelectedIndex() == 0);</b>
<b class="nc">&nbsp;                chSpaceSuit.setEnabled(cbArmorKit.getSelectedIndex() == 0);</b>
<b class="nc">&nbsp;                chDEST.setEnabled(cbArmorKit.getSelectedIndex() == 0);</b>
<b class="nc">&nbsp;                chSneakCamo.setEnabled(cbArmorKit.getSelectedIndex() == 0</b>
<b class="nc">&nbsp;                        &amp;&amp; !chDEST.isSelected());</b>
<b class="nc">&nbsp;                chSneakIR.setEnabled(cbArmorKit.getSelectedIndex() == 0</b>
<b class="nc">&nbsp;                        &amp;&amp; !chDEST.isSelected());</b>
<b class="nc">&nbsp;                chSneakECM.setEnabled(cbArmorKit.getSelectedIndex() == 0</b>
<b class="nc">&nbsp;                        &amp;&amp; !chDEST.isSelected());</b>
&nbsp;            }
&nbsp;
&nbsp;            public void updateArmorValues() {
<b class="nc">&nbsp;                if (cbArmorKit.getSelectedIndex() &gt; 0) {</b>
<b class="nc">&nbsp;                    EquipmentType kit = armorKits.get(cbArmorKit.getSelectedIndex() - 1);</b>
<b class="nc">&nbsp;                    fldDivisor.setText(Double.toString(((MiscType)kit).getDamageDivisor()));</b>
<b class="nc">&nbsp;                    chEncumber.setSelected((kit.getSubType() &amp; MiscType.S_ENCUMBERING) != 0);</b>
<b class="nc">&nbsp;                    chSpaceSuit.setSelected((kit.getSubType() &amp; MiscType.S_SPACE_SUIT) != 0);</b>
<b class="nc">&nbsp;                    chDEST.setSelected((kit.getSubType() &amp; MiscType.S_DEST) != 0);</b>
<b class="nc">&nbsp;                    chSneakCamo.setSelected((kit.getSubType() &amp; MiscType.S_SNEAK_CAMO) != 0);</b>
<b class="nc">&nbsp;                    chSneakIR.setSelected((kit.getSubType() &amp; MiscType.S_SNEAK_IR) != 0);</b>
<b class="nc">&nbsp;                    chSneakECM.setSelected((kit.getSubType() &amp; MiscType.S_SNEAK_ECM) != 0);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            public void applyChoice() {
<b class="nc">&nbsp;                if (cbArmorKit.getSelectedIndex() &gt; 0) {</b>
<b class="nc">&nbsp;                    inf.setArmorKit(armorKits.get(cbArmorKit.getSelectedIndex() - 1));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    inf.setArmorKit(null);</b>
<b class="nc">&nbsp;                    inf.setArmorDamageDivisor(Double.valueOf(fldDivisor.getText()));</b>
<b class="nc">&nbsp;                    inf.setArmorEncumbering(chEncumber.isSelected());</b>
<b class="nc">&nbsp;                    inf.setSpaceSuit(chSpaceSuit.isSelected());</b>
<b class="nc">&nbsp;                    inf.setDEST(chDEST.isSelected());</b>
<b class="nc">&nbsp;                    if (!chDEST.isSelected()) {</b>
<b class="nc">&nbsp;                        inf.setSneakCamo(chSneakCamo.isSelected());</b>
<b class="nc">&nbsp;                        inf.setSneakIR(chSneakIR.isSelected());</b>
<b class="nc">&nbsp;                        inf.setSneakECM(chSneakECM.isSelected());</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                int spec = 0;</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt; Infantry.NUM_SPECIALIZATIONS; i++) {</b>
<b class="nc">&nbsp;                    if (chSpecs.get(i).isSelected()) {</b>
<b class="nc">&nbsp;                        spec |= 1 &lt;&lt; i;</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                inf.setSpecializations(spec);</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void setEnabled(boolean enabled) {
<b class="nc">&nbsp;                cbArmorKit.setEnabled(enabled);</b>
<b class="nc">&nbsp;                if (enabled) {</b>
<b class="nc">&nbsp;                    armorStateChanged();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    fldDivisor.setEnabled(enabled);</b>
<b class="nc">&nbsp;                    chEncumber.setEnabled(enabled);</b>
<b class="nc">&nbsp;                    chSpaceSuit.setEnabled(enabled);</b>
<b class="nc">&nbsp;                    chDEST.setEnabled(enabled);</b>
<b class="nc">&nbsp;                    chSneakCamo.setEnabled(enabled);</b>
<b class="nc">&nbsp;                    chSneakIR.setEnabled(enabled);</b>
<b class="nc">&nbsp;                    chSneakECM.setEnabled(enabled);</b>
&nbsp;                }
<b class="nc">&nbsp;                for (JCheckBox spec : chSpecs) {</b>
<b class="nc">&nbsp;                    spec.setEnabled(enabled);</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        private void disableMunitionEditing() {
<b class="nc">&nbsp;            for (int i = 0; i &lt; m_vMunitions.size(); i++) {</b>
<b class="nc">&nbsp;                m_vMunitions.get(i).setEnabled(false);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
&nbsp;        private void disableAPMEditing() {
<b class="nc">&nbsp;            for (int i = 0; i &lt; m_vAPMounts.size(); i++) {</b>
<b class="nc">&nbsp;                m_vAPMounts.get(i).setEnabled(false);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
&nbsp;        private void disableMEAEditing() {
<b class="nc">&nbsp;            for (int i = 0; i &lt; m_vMEAdaptors.size(); i++) {</b>
<b class="nc">&nbsp;                m_vMEAdaptors.get(i).setEnabled(false);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        private void disableMGSetting() {
<b class="nc">&nbsp;            for (int i = 0; i &lt; m_vMGs.size(); i++) {</b>
<b class="nc">&nbsp;                m_vMGs.get(i).setEnabled(false);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        private void disableMineSetting() {
<b class="nc">&nbsp;            for (int i = 0; i &lt; m_vMines.size(); i++) {</b>
<b class="nc">&nbsp;                m_vMines.get(i).setEnabled(false);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        private void refreshC3() {
<b class="nc">&nbsp;            choC3.removeAllItems();</b>
<b class="nc">&nbsp;            int listIndex = 0;</b>
<b class="nc">&nbsp;            entityCorrespondance = new int[client.getGame().getNoOfEntities() + 2];</b>
&nbsp;
<b class="nc">&nbsp;            if (entity.hasC3i() || entity.hasNavalC3()) {</b>
<b class="nc">&nbsp;                choC3.addItem(Messages</b>
<b class="nc">&nbsp;                        .getString(&quot;CustomMechDialog.CreateNewNetwork&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                if (entity.getC3Master() == null) {</b>
<b class="nc">&nbsp;                    choC3.setSelectedIndex(listIndex);</b>
&nbsp;                }
<b class="nc">&nbsp;                entityCorrespondance[listIndex++] = entity.getId();</b>
<b class="nc">&nbsp;            } else if (entity.hasC3MM()) {</b>
<b class="nc">&nbsp;                int mNodes = entity.calculateFreeC3MNodes();</b>
<b class="nc">&nbsp;                int sNodes = entity.calculateFreeC3Nodes();</b>
&nbsp;
<b class="nc">&nbsp;                choC3.addItem(Messages</b>
<b class="nc">&nbsp;                        .getString(</b>
<b class="nc">&nbsp;                                &quot;CustomMechDialog.setCompanyMaster&quot;, new Object[] { Integer.valueOf(mNodes), Integer.valueOf(sNodes) })); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;                if (entity.C3MasterIs(entity)) {</b>
<b class="nc">&nbsp;                    choC3.setSelectedIndex(listIndex);</b>
&nbsp;                }
<b class="nc">&nbsp;                entityCorrespondance[listIndex++] = entity.getId();</b>
&nbsp;
<b class="nc">&nbsp;                choC3.addItem(Messages</b>
<b class="nc">&nbsp;                        .getString(</b>
<b class="nc">&nbsp;                                &quot;CustomMechDialog.setIndependentMaster&quot;, new Object[] { Integer.valueOf(sNodes) })); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                if (entity.getC3Master() == null) {</b>
<b class="nc">&nbsp;                    choC3.setSelectedIndex(listIndex);</b>
&nbsp;                }
<b class="nc">&nbsp;                entityCorrespondance[listIndex++] = -1;</b>
&nbsp;
<b class="nc">&nbsp;            } else if (entity.hasC3M()) {</b>
<b class="nc">&nbsp;                int nodes = entity.calculateFreeC3Nodes();</b>
&nbsp;
<b class="nc">&nbsp;                choC3.addItem(Messages</b>
<b class="nc">&nbsp;                        .getString(</b>
<b class="nc">&nbsp;                                &quot;CustomMechDialog.setCompanyMaster1&quot;, new Object[] { Integer.valueOf(nodes) })); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                if (entity.C3MasterIs(entity)) {</b>
<b class="nc">&nbsp;                    choC3.setSelectedIndex(listIndex);</b>
&nbsp;                }
<b class="nc">&nbsp;                entityCorrespondance[listIndex++] = entity.getId();</b>
&nbsp;
<b class="nc">&nbsp;                choC3.addItem(Messages</b>
<b class="nc">&nbsp;                        .getString(</b>
<b class="nc">&nbsp;                                &quot;CustomMechDialog.setIndependentMaster&quot;, new Object[] { Integer.valueOf(nodes) })); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                if (entity.getC3Master() == null) {</b>
<b class="nc">&nbsp;                    choC3.setSelectedIndex(listIndex);</b>
&nbsp;                }
<b class="nc">&nbsp;                entityCorrespondance[listIndex++] = -1;</b>
&nbsp;
&nbsp;            }
<b class="nc">&nbsp;            for (Entity e : client.getEntitiesVector()) {</b>
&nbsp;                // ignore enemies or self
<b class="nc">&nbsp;                if (entity.isEnemyOf(e) || entity.equals(e)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // c3i only links with c3i
<b class="nc">&nbsp;                if (entity.hasC3i() != e.hasC3i()) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // NC3 only links with NC3
<b class="nc">&nbsp;                if (entity.hasNavalC3() != e.hasNavalC3()) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // likewise can&#39;t connect c3 to nova
<b class="nc">&nbsp;                if (entity.hasNovaCEWS() != e.hasNovaCEWS()) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // maximum depth of a c3 network is 2 levels.
<b class="nc">&nbsp;                Entity eCompanyMaster = e.getC3Master();</b>
<b class="nc">&nbsp;                if ((eCompanyMaster != null)</b>
<b class="nc">&nbsp;                        &amp;&amp; (eCompanyMaster.getC3Master() != eCompanyMaster)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                int nodes = e.calculateFreeC3Nodes();</b>
<b class="nc">&nbsp;                if (e.hasC3MM() &amp;&amp; entity.hasC3M() &amp;&amp; e.C3MasterIs(e)) {</b>
<b class="nc">&nbsp;                    nodes = e.calculateFreeC3MNodes();</b>
&nbsp;                }
<b class="nc">&nbsp;                if (entity.C3MasterIs(e) &amp;&amp; !entity.equals(e)) {</b>
<b class="nc">&nbsp;                    nodes++;</b>
&nbsp;                }
<b class="nc">&nbsp;                if ((entity.hasC3i() || entity.hasNavalC3())</b>
<b class="nc">&nbsp;                        &amp;&amp; (entity.onSameC3NetworkAs(e) || entity.equals(e))) {</b>
<b class="nc">&nbsp;                    nodes++;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (nodes == 0) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (e.hasC3i() || e.hasNavalC3()) {</b>
<b class="nc">&nbsp;                    if (entity.onSameC3NetworkAs(e)) {</b>
<b class="nc">&nbsp;                        choC3.addItem(Messages</b>
<b class="nc">&nbsp;                                .getString(</b>
<b class="nc">&nbsp;                                        &quot;CustomMechDialog.join1&quot;, new Object[] { e.getDisplayName(), e.getC3NetId(), Integer.valueOf(nodes - 1) })); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                        choC3.setSelectedIndex(listIndex);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        choC3.addItem(Messages</b>
<b class="nc">&nbsp;                                .getString(</b>
<b class="nc">&nbsp;                                        &quot;CustomMechDialog.join2&quot;, new Object[] { e.getDisplayName(), e.getC3NetId(), Integer.valueOf(nodes) })); //$NON-NLS-1$</b>
&nbsp;                    }
<b class="nc">&nbsp;                    entityCorrespondance[listIndex++] = e.getId();</b>
<b class="nc">&nbsp;                } else if (e.C3MasterIs(e) &amp;&amp; e.hasC3MM()) {</b>
&nbsp;                    // Company masters with 2 computers can have
&nbsp;                    // *both* sub-masters AND slave units.
<b class="nc">&nbsp;                    choC3.addItem(Messages</b>
<b class="nc">&nbsp;                            .getString(</b>
<b class="nc">&nbsp;                                    &quot;CustomMechDialog.connect2&quot;, new Object[] { e.getDisplayName(), e.getC3NetId(), Integer.valueOf(nodes) })); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    entityCorrespondance[listIndex] = e.getId();</b>
<b class="nc">&nbsp;                    if (entity.C3MasterIs(e)) {</b>
<b class="nc">&nbsp;                        choC3.setSelectedIndex(listIndex);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    listIndex++;</b>
<b class="nc">&nbsp;                } else if (e.C3MasterIs(e) != entity.hasC3M()) {</b>
&nbsp;                    // If we&#39;re a slave-unit, we can only connect to sub-masters,
&nbsp;                    // not main masters likewise, if we&#39;re a master unit, we can
&nbsp;                    // only connect to main master units, not sub-masters.
<b class="nc">&nbsp;                } else if (entity.C3MasterIs(e)) {</b>
<b class="nc">&nbsp;                    choC3.addItem(Messages</b>
<b class="nc">&nbsp;                            .getString(</b>
<b class="nc">&nbsp;                                    &quot;CustomMechDialog.connect1&quot;, new Object[] { e.getDisplayName(), e.getC3NetId(), Integer.valueOf(nodes - 1) })); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    choC3.setSelectedIndex(listIndex);</b>
<b class="nc">&nbsp;                    entityCorrespondance[listIndex++] = e.getId();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    choC3.addItem(Messages</b>
<b class="nc">&nbsp;                            .getString(</b>
<b class="nc">&nbsp;                                    &quot;CustomMechDialog.connect2&quot;, new Object[] { e.getDisplayName(), e.getC3NetId(), Integer.valueOf(nodes) })); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    entityCorrespondance[listIndex++] = e.getId();</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
