


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ClientGUI</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.client.ui.swing</a>
</div>

<h1>Coverage Summary for Class: ClientGUI (megamek.client.ui.swing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ClientGUI</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/92)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/957)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ClientGUI$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ClientGUI$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ClientGUI$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ClientGUI$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ClientGUI$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/242)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ClientGUI$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ClientGUI$7</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/116)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1226)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek - Copyright (C) 2000,2001,2002,2003,2004 Ben Mazur (bmazur@sev.org)
&nbsp; * Copyright 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
&nbsp; *
&nbsp; * This program is free software; you can redistribute it and/or modify it
&nbsp; * under the terms of the GNU General Public License as published by the Free
&nbsp; * Software Foundation; either version 2 of the License, or (at your option)
&nbsp; * any later version.
&nbsp; *
&nbsp; * This program is distributed in the hope that it will be useful, but
&nbsp; * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; * for more details.
&nbsp; */
&nbsp;package megamek.client.ui.swing;
&nbsp;
&nbsp;import java.applet.Applet;
&nbsp;import java.applet.AudioClip;
&nbsp;import java.awt.BorderLayout;
&nbsp;import java.awt.CardLayout;
&nbsp;import java.awt.Component;
&nbsp;import java.awt.Cursor;
&nbsp;import java.awt.Dimension;
&nbsp;import java.awt.GraphicsConfiguration;
&nbsp;import java.awt.GraphicsDevice;
&nbsp;import java.awt.GraphicsEnvironment;
&nbsp;import java.awt.GridBagConstraints;
&nbsp;import java.awt.Image;
&nbsp;import java.awt.Rectangle;
&nbsp;import java.awt.SystemColor;
&nbsp;import java.awt.event.*;
&nbsp;import java.io.File;
&nbsp;import java.io.FileOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.io.OutputStream;
&nbsp;import java.net.MalformedURLException;
&nbsp;import java.net.URL;
&nbsp;import java.util.*;
&nbsp;
&nbsp;import javax.imageio.ImageIO;
&nbsp;import javax.swing.*;
&nbsp;import javax.swing.filechooser.FileFilter;
&nbsp;import javax.swing.filechooser.FileNameExtensionFilter;
&nbsp;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.client.Client;
&nbsp;import megamek.client.TimerSingleton;
&nbsp;import megamek.client.bot.BotClient;
&nbsp;import megamek.client.bot.TestBot;
&nbsp;import megamek.client.bot.princess.Princess;
&nbsp;import megamek.client.event.BoardViewEvent;
&nbsp;import megamek.client.event.BoardViewListener;
&nbsp;import megamek.client.ui.GBC;
&nbsp;import megamek.client.ui.IBoardView;
&nbsp;import megamek.client.ui.Messages;
&nbsp;import megamek.client.ui.swing.boardview.BoardView1;
&nbsp;import megamek.client.ui.swing.dialog.AbstractUnitSelectorDialog;
&nbsp;import megamek.client.ui.swing.dialog.MegaMekUnitSelectorDialog;
&nbsp;import megamek.client.ui.swing.unitDisplay.UnitDisplay;
&nbsp;import megamek.client.ui.swing.util.BASE64ToolKit;
&nbsp;import megamek.client.ui.swing.util.MegaMekController;
&nbsp;import megamek.common.Configuration;
&nbsp;import megamek.common.Coords;
&nbsp;import megamek.common.Entity;
&nbsp;import megamek.common.EntityListFile;
&nbsp;import megamek.common.IBomber;
&nbsp;import megamek.common.IGame;
&nbsp;import megamek.common.IGame.Phase;
&nbsp;import megamek.common.IPlayer;
&nbsp;import megamek.common.MechSummaryCache;
&nbsp;import megamek.common.Mounted;
&nbsp;import megamek.common.MovePath;
&nbsp;import megamek.common.MovePath.MoveStepType;
&nbsp;import megamek.common.Targetable;
&nbsp;import megamek.common.WeaponOrderHandler;
&nbsp;import megamek.common.actions.WeaponAttackAction;
&nbsp;import megamek.common.event.GameCFREvent;
&nbsp;import megamek.common.event.GameEndEvent;
&nbsp;import megamek.common.event.GameListener;
&nbsp;import megamek.common.event.GameListenerAdapter;
&nbsp;import megamek.common.event.GameMapQueryEvent;
&nbsp;import megamek.common.event.GamePhaseChangeEvent;
&nbsp;import megamek.common.event.GamePlayerChangeEvent;
&nbsp;import megamek.common.event.GamePlayerChatEvent;
&nbsp;import megamek.common.event.GamePlayerConnectedEvent;
&nbsp;import megamek.common.event.GamePlayerDisconnectedEvent;
&nbsp;import megamek.common.event.GameReportEvent;
&nbsp;import megamek.common.event.GameSettingsChangeEvent;
&nbsp;import megamek.common.icons.Camouflage;
&nbsp;import megamek.common.net.Packet;
&nbsp;import megamek.common.preference.PreferenceManager;
&nbsp;import megamek.common.util.AddBotUtil;
&nbsp;import megamek.common.util.Distractable;
&nbsp;import megamek.common.util.fileUtils.MegaMekFile;
&nbsp;import megamek.common.util.SharedConfiguration;
&nbsp;import megamek.common.util.StringUtil;
&nbsp;
<b class="nc">&nbsp;public class ClientGUI extends JPanel implements WindowListener, BoardViewListener, ActionListener, ComponentListener {</b>
&nbsp;    //region Variable Declarations
&nbsp;    private static final long serialVersionUID = 3913466735610109147L;
&nbsp;
&nbsp;    private static final String FILENAME_ICON_16X16 = &quot;megamek-icon-16x16.png&quot;;
&nbsp;    private static final String FILENAME_ICON_32X32 = &quot;megamek-icon-32x32.png&quot;;
&nbsp;    private static final String FILENAME_ICON_48X48 = &quot;megamek-icon-48x48.png&quot;;
&nbsp;    private static final String FILENAME_ICON_256X256 = &quot;megamek-icon-256x256.png&quot;;
&nbsp;
&nbsp;    //region action commands
&nbsp;    //region main menu
&nbsp;    //Note: anything located in menu bars is not located here but in their menu
&nbsp;    public static final String MAIN_SKIN_NEW = &quot;mainSkinNew&quot;;
&nbsp;    public static final String MAIN_QUIT = &quot;mainQuit&quot;;
&nbsp;    //region file menu
&nbsp;    //game submenu
&nbsp;    public static final String FILE_GAME_NEW = &quot;fileGameNew&quot;;
&nbsp;    public static final String FILE_GAME_OPEN = &quot;fileGameOpen&quot;;
&nbsp;    public static final String FILE_GAME_SAVE = &quot;fileGameSave&quot;;
&nbsp;    public static final String FILE_GAME_SAVE_SERVER = &quot;fileGameSaveServer&quot;;
&nbsp;    public static final String FILE_GAME_SCENARIO = &quot;fileGameScenario&quot;;
&nbsp;    public static final String FILE_GAME_CONNECT_BOT = &quot;fileGameConnectBot&quot;;
&nbsp;    public static final String FILE_GAME_CONNECT = &quot;fileGameConnect&quot;;
&nbsp;    public static final String FILE_GAME_REPLACE_PLAYER = &quot;replacePlayer&quot;;
&nbsp;    //board submenu
&nbsp;    public static final String FILE_BOARD_NEW = &quot;fileBoardNew&quot;;
&nbsp;    public static final String FILE_BOARD_OPEN = &quot;fileBoardOpen&quot;;
&nbsp;    public static final String FILE_BOARD_SAVE = &quot;fileBoardSave&quot;;
&nbsp;    public static final String FILE_BOARD_SAVE_AS = &quot;fileBoardSaveAs&quot;;
&nbsp;    public static final String FILE_BOARD_SAVE_AS_IMAGE = &quot;fileBoardSaveAsImage&quot;;
&nbsp;    public static final String FILE_BOARD_SAVE_AS_IMAGE_UNITS = &quot;fileBoardSaveAsImageUnits&quot;;
&nbsp;    //unit list submenu
&nbsp;    public static final String FILE_UNITS_REINFORCE = &quot;fileUnitsReinforce&quot;;
&nbsp;    public static final String FILE_UNITS_REINFORCE_RAT = &quot;fileUnitsReinforceRAT&quot;;
&nbsp;    public static final String FILE_UNITS_OPEN = &quot;fileUnitsOpen&quot;;
&nbsp;    public static final String FILE_UNITS_CLEAR = &quot;fileUnitsClear&quot;;
&nbsp;    public static final String FILE_UNITS_SAVE = &quot;fileUnitsSave&quot;;
&nbsp;    //file menu
&nbsp;    public static final String FILE_PRINT = &quot;filePrint&quot;;
&nbsp;    //endregion file menu
&nbsp;
&nbsp;    //region view menu
&nbsp;    public static final String VIEW_MEK_DISPLAY = &quot;viewMekDisplay&quot;;
&nbsp;    public static final String VIEW_ACCESSIBILITY_WINDOW = &quot;viewAccessibilityWindow&quot;;
&nbsp;    public static final String VIEW_KEYBINDS_OVERLAY = &quot;viewKeyboardShortcuts&quot;;
&nbsp;    public static final String VIEW_MINI_MAP = &quot;viewMiniMap&quot;;
&nbsp;    public static final String VIEW_UNIT_OVERVIEW = &quot;viewUnitOverview&quot;;
&nbsp;    public static final String VIEW_ZOOM_IN = &quot;viewZoomIn&quot;;
&nbsp;    public static final String VIEW_ZOOM_OUT = &quot;viewZoomOut&quot;;
&nbsp;    public static final String VIEW_TOGGLE_ISOMETRIC = &quot;viewToggleIsometric&quot;;
&nbsp;    public static final String VIEW_TOGGLE_FIELD_OF_FIRE = &quot;viewToggleFieldOfFire&quot;;
&nbsp;    public static final String VIEW_TOGGLE_FOV_DARKEN = &quot;viewToggleFovDarken&quot;;
&nbsp;    public static final String VIEW_TOGGLE_FOV_HIGHLIGHT = &quot;viewToggleFovHighlight&quot;;
&nbsp;    public static final String VIEW_TOGGLE_FIRING_SOLUTIONS = &quot;viewToggleFiringSolutions&quot;;
&nbsp;    public static final String VIEW_MOVE_ENV = &quot;viewMovementEnvelope&quot;;
&nbsp;    public static final String VIEW_MOVE_MOD_ENV = &quot;viewMovModEnvelope&quot;;
&nbsp;    public static final String VIEW_CHANGE_THEME = &quot;viewChangeTheme&quot;;
&nbsp;    public static final String VIEW_ROUND_REPORT = &quot;viewRoundReport&quot;;
&nbsp;    public static final String VIEW_GAME_OPTIONS = &quot;viewGameOptions&quot;;
&nbsp;    public static final String VIEW_CLIENT_SETTINGS = &quot;viewClientSettings&quot;;
&nbsp;    public static final String VIEW_LOS_SETTING = &quot;viewLOSSetting&quot;;
&nbsp;    public static final String VIEW_PLAYER_SETTINGS = &quot;viewPlayerSettings&quot;;
&nbsp;    public static final String VIEW_PLAYER_LIST = &quot;viewPlayerList&quot;;
&nbsp;    public static final String VIEW_RESET_WINDOW_POSITIONS = &quot;viewResetWindowPos&quot;;
&nbsp;    //endregion view menu
&nbsp;
&nbsp;    //region fire menu
&nbsp;    public static final String FIRE_SAVE_WEAPON_ORDER = &quot;saveWeaponOrder&quot;;
&nbsp;    //endregion fire menu
&nbsp;
&nbsp;    //region help menu
&nbsp;    public static final String HELP_CONTENTS = &quot;helpContents&quot;;
&nbsp;    public static final String HELP_SKINNING = &quot;helpSkinning&quot;;
&nbsp;    public static final String HELP_ABOUT = &quot;helpAbout&quot;;
&nbsp;    //endregion help menu
&nbsp;    //endregion action commands
&nbsp;
&nbsp;    // a frame, to show stuff in
&nbsp;    public JFrame frame;
&nbsp;
&nbsp;    // A menu bar to contain all actions.
&nbsp;    protected CommonMenuBar menuBar;
&nbsp;    private CommonAboutDialog about;
&nbsp;    private CommonHelpDialog help;
&nbsp;    private CommonSettingsDialog setdlg;
&nbsp;    private AccessibilityWindow aw;
<b class="nc">&nbsp;    private String helpFileName =</b>
<b class="nc">&nbsp;            SharedConfiguration.getInstance().getProperty(&quot;megamek.CommonMenuBar.helpFilePath&quot;,</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;CommonMenuBar.helpFilePath&quot;));</b>
&nbsp;
&nbsp;    public MegaMekController controller;
&nbsp;    private ChatterBox cb;
&nbsp;    public ChatterBox2 cb2;
&nbsp;    public BoardView1 bv;
&nbsp;    private Component bvc;
&nbsp;    public JDialog mechW;
&nbsp;    public UnitDisplay mechD;
&nbsp;    public JDialog minimapW;
&nbsp;    public MiniMap minimap;
&nbsp;    private MapMenu popup;
&nbsp;    private UnitOverview uo;
&nbsp;    private Ruler ruler;
&nbsp;    protected JComponent curPanel;
&nbsp;    public ChatLounge chatlounge;
&nbsp;    private OffBoardTargetOverlay offBoardOverlay;
&nbsp;
&nbsp;    // some dialogs...
&nbsp;    private GameOptionsDialog gameOptionsDialog;
&nbsp;    private AbstractUnitSelectorDialog mechSelectorDialog;
&nbsp;    private StartingPositionDialog startingPositionDialog;
&nbsp;    private PlayerListDialog playerListDialog;
&nbsp;    private RandomArmyDialog randomArmyDialog;
&nbsp;    private RandomSkillDialog randomSkillDialog;
&nbsp;    private PlanetaryConditionsDialog conditionsDialog;
&nbsp;    /**
&nbsp;     * Save and Open dialogs for MegaMek Unit List (mul) files.
&nbsp;     */
&nbsp;    private JFileChooser dlgLoadList;
&nbsp;    private JFileChooser dlgSaveList;
&nbsp;    private Client client;
&nbsp;
&nbsp;    private File curfileBoardImage;
&nbsp;    private File curfileBoard;
&nbsp;
&nbsp;    /**
&nbsp;     * Cache for the &quot;bing&quot; soundclip.
&nbsp;     */
&nbsp;    private AudioClip bingClip;
&nbsp;
&nbsp;    /**
&nbsp;     * Map each phase to the name of the card for the main display area.
&nbsp;     */
<b class="nc">&nbsp;    private Map&lt;String, String&gt; mainNames = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    /**
&nbsp;     * The &lt;code&gt;JPanel&lt;/code&gt; containing the main display area.
&nbsp;     */
<b class="nc">&nbsp;    private JPanel panMain = new JPanel();</b>
&nbsp;
&nbsp;    /**
&nbsp;     * The &lt;code&gt;CardLayout&lt;/code&gt; of the main display area.
&nbsp;     */
<b class="nc">&nbsp;    private CardLayout cardsMain = new CardLayout();</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Map each phase to the name of the card for the secondary area.
&nbsp;     */
<b class="nc">&nbsp;    private Map&lt;String, String&gt; secondaryNames = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    /**
&nbsp;     * The &lt;code&gt;JPanel&lt;/code&gt; containing the secondary display area.
&nbsp;     */
<b class="nc">&nbsp;    private JPanel panSecondary = new JPanel();</b>
&nbsp;
&nbsp;    private StatusBarPhaseDisplay currPhaseDisplay;
&nbsp;
&nbsp;    /**
&nbsp;     * The &lt;code&gt;CardLayout&lt;/code&gt; of the secondary display area.
&nbsp;     */
<b class="nc">&nbsp;    private CardLayout cardsSecondary = new CardLayout();</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Map phase component names to phase component objects.
&nbsp;     */
<b class="nc">&nbsp;    private Map&lt;String, JComponent&gt; phaseComponents = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Current Selected entity
&nbsp;     */
<b class="nc">&nbsp;    private int selectedEntityNum = Entity.NONE;</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Flag that indicates whether hotkeys should be ignored or not.  This is
&nbsp;     * used for disabling hot keys when various dialogs are displayed.
&nbsp;     */
<b class="nc">&nbsp;    private boolean ignoreHotKeys = false;</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Keeps track of the Entity ID for the entity currently taking a pointblank
&nbsp;     * shot.
&nbsp;     */
<b class="nc">&nbsp;    private int pointblankEID = Entity.NONE;</b>
&nbsp;    //endregion Variable Declarations
&nbsp;
&nbsp;    /**
&nbsp;     * Construct a client which will display itself in a new frame. It will not
&nbsp;     * try to connect to a server yet. When the frame closes, this client will
&nbsp;     * clean up after itself as much as possible, but will not call
&nbsp;     * System.exit().
&nbsp;     */
&nbsp;    public ClientGUI(Client client, MegaMekController c) {
<b class="nc">&nbsp;        super(new BorderLayout());</b>
<b class="nc">&nbsp;        this.addComponentListener(this);</b>
<b class="nc">&nbsp;        this.client = client;</b>
<b class="nc">&nbsp;        controller = c;</b>
<b class="nc">&nbsp;        loadSoundClip();</b>
<b class="nc">&nbsp;        panMain.setLayout(cardsMain);</b>
<b class="nc">&nbsp;        panSecondary.setLayout(cardsSecondary);</b>
<b class="nc">&nbsp;        JPanel panDisplay = new JPanel(new BorderLayout());</b>
<b class="nc">&nbsp;        panDisplay.add(panMain, BorderLayout.CENTER);</b>
<b class="nc">&nbsp;        panDisplay.add(panSecondary, BorderLayout.SOUTH);</b>
<b class="nc">&nbsp;        add(panDisplay, BorderLayout.CENTER);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public IBoardView getBoardView() {
<b class="nc">&nbsp;        return bv;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Try to load the &quot;bing&quot; sound clip.
&nbsp;     */
&nbsp;    private void loadSoundClip() {
<b class="nc">&nbsp;        if (GUIPreferences.getInstance().getSoundBingFilename() == null) {</b>
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            File file = new File(GUIPreferences.getInstance().getSoundBingFilename());</b>
<b class="nc">&nbsp;            if (!file.exists()) {</b>
<b class="nc">&nbsp;                MegaMek.getLogger().error(&quot;Failed to load audio file: &quot; + GUIPreferences.getInstance().getSoundBingFilename());</b>
<b class="nc">&nbsp;                return;</b>
&nbsp;            }
<b class="nc">&nbsp;            bingClip = Applet.newAudioClip(file.toURI().toURL());</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(e);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Display a system message in the chat box.
&nbsp;     *
&nbsp;     * @param message the &lt;code&gt;String&lt;/code&gt; message to be shown.
&nbsp;     */
&nbsp;    public void systemMessage(String message) {
<b class="nc">&nbsp;        cb.systemMessage(message);</b>
<b class="nc">&nbsp;        cb2.addChatMessage(&quot;Megamek: &quot; + message);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * @return the &#39;virtual bounds&#39; of the screen. That is, the union of the displayable space on
&nbsp;     * all available screen devices.
&nbsp;     */
&nbsp;    private Rectangle getVirtualBounds() {
<b class="nc">&nbsp;        Rectangle virtualBounds = new Rectangle();</b>
<b class="nc">&nbsp;        GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();</b>
<b class="nc">&nbsp;        GraphicsDevice[] gs = ge.getScreenDevices();</b>
<b class="nc">&nbsp;        for (GraphicsDevice gd : gs) {</b>
<b class="nc">&nbsp;            GraphicsConfiguration[] gc = gd.getConfigurations();</b>
<b class="nc">&nbsp;            for (GraphicsConfiguration element : gc) {</b>
<b class="nc">&nbsp;                virtualBounds = virtualBounds.union(element.getBounds());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return virtualBounds;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Initializes a number of things about this frame.
&nbsp;     */
&nbsp;    private void initializeFrame() {
<b class="nc">&nbsp;        frame = new JFrame(Messages.getString(&quot;ClientGUI.title&quot;));</b>
<b class="nc">&nbsp;        menuBar.setGame(client.getGame());</b>
<b class="nc">&nbsp;        frame.setJMenuBar(menuBar);</b>
<b class="nc">&nbsp;        Rectangle virtualBounds = getVirtualBounds();</b>
<b class="nc">&nbsp;        if (GUIPreferences.getInstance().getWindowSizeHeight() != 0) {</b>
<b class="nc">&nbsp;            int x = GUIPreferences.getInstance().getWindowPosX();</b>
<b class="nc">&nbsp;            int y = GUIPreferences.getInstance().getWindowPosY();</b>
<b class="nc">&nbsp;            int w = GUIPreferences.getInstance().getWindowSizeWidth();</b>
<b class="nc">&nbsp;            int h = GUIPreferences.getInstance().getWindowSizeHeight();</b>
<b class="nc">&nbsp;            if ((x &lt; virtualBounds.getMinX()) || ((x + w) &gt; virtualBounds.getMaxX())) {</b>
<b class="nc">&nbsp;                x = 0;</b>
&nbsp;            }
<b class="nc">&nbsp;            if ((y &lt; virtualBounds.getMinY()) || ((y + h) &gt; virtualBounds.getMaxY())) {</b>
<b class="nc">&nbsp;                y = 0;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (w &gt; virtualBounds.getWidth()) {</b>
<b class="nc">&nbsp;                w = (int) virtualBounds.getWidth();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (h &gt; virtualBounds.getHeight()) {</b>
<b class="nc">&nbsp;                h = (int) virtualBounds.getHeight();</b>
&nbsp;            }
<b class="nc">&nbsp;            frame.setLocation(x, y);</b>
<b class="nc">&nbsp;            frame.setSize(w, h);</b>
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            frame.setSize(800, 600);</b>
&nbsp;        }
<b class="nc">&nbsp;        frame.setMinimumSize(new Dimension(640,480));</b>
<b class="nc">&nbsp;        frame.setBackground(SystemColor.menu);</b>
<b class="nc">&nbsp;        frame.setForeground(SystemColor.menuText);</b>
<b class="nc">&nbsp;        List&lt;Image&gt; iconList = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        iconList.add(frame.getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_16X16).toString()</b>
&nbsp;        ));
<b class="nc">&nbsp;        iconList.add(frame.getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_32X32).toString()</b>
&nbsp;        ));
<b class="nc">&nbsp;        iconList.add(frame.getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_48X48).toString()</b>
&nbsp;        ));
<b class="nc">&nbsp;        iconList.add(frame.getToolkit().getImage(</b>
<b class="nc">&nbsp;                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_256X256).toString()</b>
&nbsp;        ));
<b class="nc">&nbsp;        frame.setIconImages(iconList);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Lays out the frame by setting this Client object to take up the full
&nbsp;     * frame display area.
&nbsp;     */
&nbsp;    private void layoutFrame() {
<b class="nc">&nbsp;        frame.setTitle(client.getName() + Messages.getString(&quot;ClientGUI.clientTitleSuffix&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;        frame.getContentPane().setLayout(new BorderLayout());</b>
<b class="nc">&nbsp;        frame.getContentPane().add(this, BorderLayout.CENTER);</b>
<b class="nc">&nbsp;        frame.validate();</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Have the client register itself as a listener wherever it&#39;s needed.
&nbsp;     * &lt;p/&gt;
&nbsp;     * According to
&nbsp;     * http://www-106.ibm.com/developerworks/java/library/j-jtp0618.html it is a
&nbsp;     * major bad no-no to perform these registrations before the constructor
&nbsp;     * finishes, so this function has to be called after the &lt;code&gt;Client&lt;/code&gt;
&nbsp;     * is created.
&nbsp;     */
&nbsp;    public void initialize() {
<b class="nc">&nbsp;        menuBar = new CommonMenuBar(getClient());</b>
<b class="nc">&nbsp;        initializeFrame();</b>
&nbsp;        try {
<b class="nc">&nbsp;            client.getGame().addGameListener(gameListener);</b>
&nbsp;            // Create the board viewer.
<b class="nc">&nbsp;            bv = new BoardView1(client.getGame(), controller, this);</b>
<b class="nc">&nbsp;            bv.setPreferredSize(getSize());</b>
<b class="nc">&nbsp;            bvc = bv.getComponent();</b>
<b class="nc">&nbsp;            bvc.setName(&quot;BoardView&quot;);</b>
<b class="nc">&nbsp;            bv.addBoardViewListener(this);</b>
<b class="nc">&nbsp;            client.setBoardView(bv);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().fatal(e);</b>
<b class="nc">&nbsp;            doAlertDialog(Messages.getString(&quot;ClientGUI.FatalError.title&quot;),</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;ClientGUI.FatalError.message&quot;) + e);</b>
<b class="nc">&nbsp;            die();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        layoutFrame();</b>
<b class="nc">&nbsp;        menuBar.addActionListener(this);</b>
<b class="nc">&nbsp;        frame.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</b>
<b class="nc">&nbsp;        frame.addWindowListener(new WindowAdapter() {</b>
&nbsp;            @Override
&nbsp;            public void windowClosing(WindowEvent e) {
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                int savePrompt = JOptionPane.showConfirmDialog(null,</b>
&nbsp;                        &quot;Do you want to save the game before quitting MegaMek?&quot;,
&nbsp;                        &quot;Save First?&quot;,
&nbsp;                        JOptionPane.YES_NO_CANCEL_OPTION,
&nbsp;                        JOptionPane.WARNING_MESSAGE);
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                if (savePrompt == JOptionPane.YES_OPTION) {</b>
<b class="nc">&nbsp;                    if (!saveGame()) {</b>
&nbsp;                        // When the user did not actually save the game, don&#39;t close MM
&nbsp;                        return;
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if ((savePrompt == JOptionPane.NO_OPTION) || (savePrompt == JOptionPane.YES_OPTION)) {</b>
<b class="nc">&nbsp;                    frame.setVisible(false);</b>
<b class="nc">&nbsp;                    saveSettings();</b>
<b class="nc">&nbsp;                    die();</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        cb2 = new ChatterBox2(this, bv, controller);</b>
<b class="nc">&nbsp;        bv.addDisplayable(cb2);</b>
<b class="nc">&nbsp;        bv.addKeyListener(cb2);</b>
<b class="nc">&nbsp;        uo = new UnitOverview(this);</b>
<b class="nc">&nbsp;        offBoardOverlay = new OffBoardTargetOverlay(this);</b>
&nbsp;
<b class="nc">&nbsp;        aw = new AccessibilityWindow(this);</b>
<b class="nc">&nbsp;        aw.setLocation(0, 0);</b>
<b class="nc">&nbsp;        aw.addWindowListener(this);</b>
<b class="nc">&nbsp;        aw.setSize(300, 300);</b>
&nbsp;
<b class="nc">&nbsp;        bv.addDisplayable(uo);</b>
<b class="nc">&nbsp;        bv.addDisplayable(offBoardOverlay);</b>
&nbsp;        int x;
&nbsp;        int y;
&nbsp;        int h;
&nbsp;        int w;
<b class="nc">&nbsp;        mechW = new JDialog(frame, Messages.getString(&quot;ClientGUI.MechDisplay&quot;), false) {</b>
&nbsp;            /**
&nbsp;             * In addition to the default Dialog processKeyEvent, this method
&nbsp;             * dispatches a KeyEvent to the client gui.
&nbsp;             * This enables all of the gui hotkeys.
&nbsp;             */
&nbsp;            @Override
&nbsp;            protected void processKeyEvent(KeyEvent e) {
&nbsp;                //menuBar.dispatchEvent(e);
&nbsp;                // Make the source be the ClientGUI and not the dialog
&nbsp;                // This prevents a ClassCastException in ToolTipManager
<b class="nc">&nbsp;                e.setSource(ClientGUI.this);</b>
<b class="nc">&nbsp;                curPanel.dispatchEvent(e);</b>
<b class="nc">&nbsp;                if (!e.isConsumed()) {</b>
<b class="nc">&nbsp;                    super.processKeyEvent(e);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        };
<b class="nc">&nbsp;        Rectangle virtualBounds = getVirtualBounds();</b>
<b class="nc">&nbsp;        x = GUIPreferences.getInstance().getDisplayPosX();</b>
<b class="nc">&nbsp;        y = GUIPreferences.getInstance().getDisplayPosY();</b>
<b class="nc">&nbsp;        h = GUIPreferences.getInstance().getDisplaySizeHeight();</b>
<b class="nc">&nbsp;        w = GUIPreferences.getInstance().getDisplaySizeWidth();</b>
<b class="nc">&nbsp;        if ((x + w) &gt; virtualBounds.getWidth()) {</b>
<b class="nc">&nbsp;            x = 0;</b>
<b class="nc">&nbsp;            w = Math.min(w, (int)virtualBounds.getWidth());</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((y + h) &gt; virtualBounds.getHeight()) {</b>
<b class="nc">&nbsp;            y = 0;</b>
<b class="nc">&nbsp;            h = Math.min(h, (int)virtualBounds.getHeight());</b>
&nbsp;        }
<b class="nc">&nbsp;        mechW.setLocation(x, y);</b>
<b class="nc">&nbsp;        mechW.setSize(w, h);</b>
<b class="nc">&nbsp;        mechW.setResizable(true);</b>
<b class="nc">&nbsp;        mechW.addWindowListener(this);</b>
<b class="nc">&nbsp;        mechD = new UnitDisplay(this, controller);</b>
<b class="nc">&nbsp;        mechD.addMechDisplayListener(bv);</b>
<b class="nc">&nbsp;        mechW.add(mechD);</b>
&nbsp;
<b class="nc">&nbsp;        Ruler.color1 = GUIPreferences.getInstance().getRulerColor1();</b>
<b class="nc">&nbsp;        Ruler.color2 = GUIPreferences.getInstance().getRulerColor2();</b>
<b class="nc">&nbsp;        ruler = new Ruler(frame, client, bv);</b>
<b class="nc">&nbsp;        x = GUIPreferences.getInstance().getRulerPosX();</b>
<b class="nc">&nbsp;        y = GUIPreferences.getInstance().getRulerPosY();</b>
<b class="nc">&nbsp;        h = GUIPreferences.getInstance().getRulerSizeHeight();</b>
<b class="nc">&nbsp;        w = GUIPreferences.getInstance().getRulerSizeWidth();</b>
<b class="nc">&nbsp;        if ((x + w) &gt; virtualBounds.getWidth()) {</b>
<b class="nc">&nbsp;            x = 0;</b>
<b class="nc">&nbsp;            w = Math.min(w, (int)virtualBounds.getWidth());</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((y + h) &gt; virtualBounds.getHeight()) {</b>
<b class="nc">&nbsp;            y = 0;</b>
<b class="nc">&nbsp;            h = Math.min(h, (int)virtualBounds.getHeight());</b>
&nbsp;        }
<b class="nc">&nbsp;        ruler.setLocation(x, y);</b>
<b class="nc">&nbsp;        ruler.setSize(w, h);</b>
&nbsp;        // minimap
<b class="nc">&nbsp;        minimapW = new JDialog(frame, Messages.getString(&quot;ClientGUI.MiniMap&quot;), false) {</b>
&nbsp;            /**
&nbsp;             * In addition to the default Dialog processKeyEvent, this method
&nbsp;             * dispatches a KeyEvent to the client gui.
&nbsp;             * This enables all of the gui hotkeys.
&nbsp;             */
&nbsp;            @Override
&nbsp;            protected void processKeyEvent(KeyEvent e) {
&nbsp;                //menuBar.dispatchEvent(e);
<b class="nc">&nbsp;                e.setSource(ClientGUI.this);// avoid ClassCastException in TooltipManager</b>
<b class="nc">&nbsp;                curPanel.dispatchEvent(e);</b>
<b class="nc">&nbsp;                if (!e.isConsumed()) {</b>
<b class="nc">&nbsp;                    super.processKeyEvent(e);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        };
&nbsp;
<b class="nc">&nbsp;        x = GUIPreferences.getInstance().getMinimapPosX();</b>
<b class="nc">&nbsp;        y = GUIPreferences.getInstance().getMinimapPosY();</b>
&nbsp;        try {
<b class="nc">&nbsp;            minimap = new MiniMap(minimapW, this, bv);</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().fatal(e);</b>
<b class="nc">&nbsp;            doAlertDialog(Messages.getString(&quot;ClientGUI.FatalError.title&quot;),</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;ClientGUI.FatalError.message1&quot;) + e);</b>
<b class="nc">&nbsp;            die();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        h = minimap.getSize().height;</b>
<b class="nc">&nbsp;        w = minimap.getSize().width;</b>
<b class="nc">&nbsp;        if (((x + 10) &gt;= virtualBounds.getWidth()) || ((x + w) &lt; 10)) {</b>
<b class="nc">&nbsp;            x = (int)virtualBounds.getWidth() - w;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (((y + 10) &gt; virtualBounds.getHeight()) || ((y + h) &lt; 10)) {</b>
<b class="nc">&nbsp;            y = (int)virtualBounds.getHeight() - h;</b>
&nbsp;        }
<b class="nc">&nbsp;        minimapW.setLocation(x, y);</b>
<b class="nc">&nbsp;        minimapW.addWindowListener(this);</b>
<b class="nc">&nbsp;        minimapW.add(minimap);</b>
<b class="nc">&nbsp;        cb = new ChatterBox(this);</b>
<b class="nc">&nbsp;        cb.setChatterBox2(cb2);</b>
<b class="nc">&nbsp;        cb2.setChatterBox(cb);</b>
<b class="nc">&nbsp;        client.changePhase(IGame.Phase.PHASE_UNKNOWN);</b>
<b class="nc">&nbsp;        UnitLoadingDialog unitLoadingDialog = new UnitLoadingDialog(frame);</b>
<b class="nc">&nbsp;        if (!MechSummaryCache.getInstance().isInitialized()) {</b>
<b class="nc">&nbsp;            unitLoadingDialog.setVisible(true);</b>
&nbsp;        }
<b class="nc">&nbsp;        mechSelectorDialog = new MegaMekUnitSelectorDialog(this, unitLoadingDialog);</b>
<b class="nc">&nbsp;        randomArmyDialog = new RandomArmyDialog(this);</b>
<b class="nc">&nbsp;        randomSkillDialog = new RandomSkillDialog(this);</b>
<b class="nc">&nbsp;        new Thread(mechSelectorDialog, &quot;Mech Selector Dialog&quot;).start();</b>
<b class="nc">&nbsp;        frame.setVisible(true);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Get the menu bar for this client.
&nbsp;     *
&nbsp;     * @return the &lt;code&gt;CommonMenuBar&lt;/code&gt; of this client.
&nbsp;     */
&nbsp;    public CommonMenuBar getMenuBar() {
<b class="nc">&nbsp;        return menuBar;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Called when the user selects the &quot;Help-&gt;About&quot; menu item.
&nbsp;     */
&nbsp;    private void showAbout() {
&nbsp;        // Do we need to create the &quot;about&quot; dialog?
<b class="nc">&nbsp;        if (about == null) {</b>
<b class="nc">&nbsp;            about = new CommonAboutDialog(frame);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Show the about dialog.
<b class="nc">&nbsp;        about.setVisible(true);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Called when the user selects the &quot;Help-&gt;Contents&quot; menu item.
&nbsp;     * &lt;p/&gt;
&nbsp;     * This method can be called by subclasses.
&nbsp;     */
&nbsp;    private void showHelp() {
&nbsp;        // Do we need to create the &quot;help&quot; dialog?
<b class="nc">&nbsp;        if (help == null) {</b>
<b class="nc">&nbsp;            help = new CommonHelpDialog(frame, new File(helpFileName));</b>
&nbsp;        }
&nbsp;        // Show the help dialog.
<b class="nc">&nbsp;        help.setVisible(true);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private void showSkinningHowTo(){
&nbsp;        try {
&nbsp;            // Get the correct help file.
<b class="nc">&nbsp;            StringBuilder helpPath = new StringBuilder(&quot;file:///&quot;);</b>
<b class="nc">&nbsp;            helpPath.append(System.getProperty(&quot;user.dir&quot;));</b>
<b class="nc">&nbsp;            if (!helpPath.toString().endsWith(File.separator)) {</b>
<b class="nc">&nbsp;                helpPath.append(File.separator);</b>
&nbsp;            }
<b class="nc">&nbsp;            helpPath.append(Messages.getString(&quot;ClientGUI.skinningHelpPath&quot;));</b>
<b class="nc">&nbsp;            URL helpUrl = new URL(helpPath.toString());</b>
&nbsp;
&nbsp;            // Launch the help dialog.
<b class="nc">&nbsp;            HelpDialog helpDialog = new HelpDialog(</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;ClientGUI.skinningHelpPath.title&quot;),</b>
&nbsp;                    helpUrl);
<b class="nc">&nbsp;            helpDialog.setVisible(true);</b>
<b class="nc">&nbsp;        } catch (MalformedURLException e) {</b>
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(this, e.getMessage(), &quot;ERROR&quot;,</b>
&nbsp;                    JOptionPane.ERROR_MESSAGE);
<b class="nc">&nbsp;            MegaMek.getLogger().error(e);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Called when the user selects the &quot;View-&gt;Client Settings&quot; menu item.
&nbsp;     */
&nbsp;    private void showSettings() {
&nbsp;        // Do we need to create the &quot;settings&quot; dialog?
<b class="nc">&nbsp;        if (setdlg == null) {</b>
<b class="nc">&nbsp;            setdlg = new CommonSettingsDialog(frame, this);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Show the settings dialog.
<b class="nc">&nbsp;        setdlg.setVisible(true);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Called when the user selects the &quot;View-&gt;Game Options&quot; menu item.
&nbsp;     */
&nbsp;    private void showOptions() {
<b class="nc">&nbsp;        if (client.getGame().getPhase() == IGame.Phase.PHASE_LOUNGE) {</b>
<b class="nc">&nbsp;            getGameOptionsDialog().setEditable(true);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            getGameOptionsDialog().setEditable(false);</b>
&nbsp;        }
&nbsp;        // Display the game options dialog.
<b class="nc">&nbsp;        getGameOptionsDialog().update(client.getGame().getOptions());</b>
<b class="nc">&nbsp;        getGameOptionsDialog().setVisible(true);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public void customizePlayer() {
<b class="nc">&nbsp;        PlayerSettingsDialog psd = new PlayerSettingsDialog(this, client);</b>
<b class="nc">&nbsp;        psd.setVisible(true);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Called when the user selects the &quot;View-&gt;Player List&quot; menu item.
&nbsp;     */
&nbsp;    private void showPlayerList() {
<b class="nc">&nbsp;        if (playerListDialog == null) {</b>
<b class="nc">&nbsp;            playerListDialog = new PlayerListDialog(frame, client);</b>
&nbsp;        }
<b class="nc">&nbsp;        playerListDialog.setVisible(true);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Called when the user selects the &quot;View-&gt;Round Report&quot; menu item.
&nbsp;     */
&nbsp;    private void showRoundReport() {
<b class="nc">&nbsp;        ignoreHotKeys = true;</b>
<b class="nc">&nbsp;        new MiniReportDisplay(frame, client).setVisible(true);</b>
<b class="nc">&nbsp;        ignoreHotKeys = false;</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Implement the &lt;code&gt;ActionListener&lt;/code&gt; interface.
&nbsp;     */
&nbsp;    public void actionPerformed(ActionEvent event) {
<b class="nc">&nbsp;        switch (event.getActionCommand()) {</b>
&nbsp;            case VIEW_RESET_WINDOW_POSITIONS:
<b class="nc">&nbsp;                minimapW.setBounds(0, 0, minimapW.getWidth(), minimapW.getHeight());</b>
<b class="nc">&nbsp;                mechW.setBounds(0, 0, mechD.getWidth(), mechD.getHeight());</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_GAME_SAVE:
<b class="nc">&nbsp;                saveGame();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_GAME_SAVE_SERVER:
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                String filename = (String) JOptionPane.showInputDialog(frame, Messages.getString(&quot;ClientGUI.FileSaveServerDialog.message&quot;), Messages.getString(&quot;ClientGUI.FileSaveServerDialog.title&quot;), JOptionPane.QUESTION_MESSAGE, null, null, &quot;savegame.sav&quot;);</b>
<b class="nc">&nbsp;                if (filename != null) {</b>
<b class="nc">&nbsp;                    client.sendChat(&quot;/save &quot; + filename);</b>
&nbsp;                }
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case HELP_ABOUT:
<b class="nc">&nbsp;                showAbout();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case HELP_SKINNING:
<b class="nc">&nbsp;                showSkinningHowTo();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case HELP_CONTENTS:
<b class="nc">&nbsp;                showHelp();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_UNITS_SAVE:
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                doSaveUnit();</b>
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_UNITS_OPEN:
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                loadListFile();</b>
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_UNITS_CLEAR:
<b class="nc">&nbsp;                deleteAllUnits(client);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_UNITS_REINFORCE:
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                loadListFile(client.getLocalPlayer(), true);</b>
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_UNITS_REINFORCE_RAT:
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                if (client.getLocalPlayer().getTeam() == IPlayer.TEAM_UNASSIGNED) {</b>
<b class="nc">&nbsp;                    String title = Messages.getString(</b>
&nbsp;                            &quot;ClientGUI.openUnitListFileDialog.noReinforceTitle&quot;); //$NON-NLS-1$
<b class="nc">&nbsp;                    String msg = Messages.getString(</b>
&nbsp;                            &quot;ClientGUI.openUnitListFileDialog.noReinforceMessage&quot;);  //$NON-NLS-1$
<b class="nc">&nbsp;                    JOptionPane.showMessageDialog(frame, msg, title,</b>
&nbsp;                            JOptionPane.OK_OPTION, null);
<b class="nc">&nbsp;                    return;</b>
&nbsp;                }
<b class="nc">&nbsp;                getRandomArmyDialog().setVisible(true);</b>
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_CLIENT_SETTINGS:
<b class="nc">&nbsp;                showSettings();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_GAME_OPTIONS:
<b class="nc">&nbsp;                showOptions();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_PLAYER_SETTINGS:
<b class="nc">&nbsp;                customizePlayer();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_PLAYER_LIST:
<b class="nc">&nbsp;                showPlayerList();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_ROUND_REPORT:
<b class="nc">&nbsp;                showRoundReport();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_BOARD_SAVE:
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                boardSave();</b>
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_BOARD_SAVE_AS:
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                boardSaveAs();</b>
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_BOARD_SAVE_AS_IMAGE:
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                boardSaveAsImage(true);</b>
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_BOARD_SAVE_AS_IMAGE_UNITS:
<b class="nc">&nbsp;                ignoreHotKeys = true;</b>
<b class="nc">&nbsp;                boardSaveAsImage(false);</b>
<b class="nc">&nbsp;                ignoreHotKeys = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FILE_GAME_REPLACE_PLAYER:
<b class="nc">&nbsp;                replacePlayer();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_MEK_DISPLAY:
<b class="nc">&nbsp;                toggleDisplay();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_ACCESSIBILITY_WINDOW:
<b class="nc">&nbsp;                toggleAccessibilityWindow();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_KEYBINDS_OVERLAY:
<b class="nc">&nbsp;                bv.toggleKeybindsOverlay();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_MINI_MAP:
<b class="nc">&nbsp;                toggleMap();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_UNIT_OVERVIEW:
<b class="nc">&nbsp;                toggleUnitOverview();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_LOS_SETTING:
<b class="nc">&nbsp;                showLOSSettingDialog();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_ZOOM_IN:
<b class="nc">&nbsp;                bv.zoomIn();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_ZOOM_OUT:
<b class="nc">&nbsp;                bv.zoomOut();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_TOGGLE_ISOMETRIC:
<b class="nc">&nbsp;                GUIPreferences.getInstance().setIsometricEnabled(bv.toggleIsometric());</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_TOGGLE_FOV_HIGHLIGHT:
<b class="nc">&nbsp;                GUIPreferences.getInstance().setFovHighlight(</b>
<b class="nc">&nbsp;                        !GUIPreferences.getInstance().getFovHighlight());</b>
<b class="nc">&nbsp;                bv.refreshDisplayables();</b>
<b class="nc">&nbsp;                if (client.getGame().getPhase() == Phase.PHASE_MOVEMENT) {</b>
<b class="nc">&nbsp;                    bv.clearHexImageCache();</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case VIEW_TOGGLE_FIELD_OF_FIRE:
<b class="nc">&nbsp;                GUIPreferences.getInstance().setShowFieldOfFire(</b>
<b class="nc">&nbsp;                        !GUIPreferences.getInstance().getShowFieldOfFire());</b>
<b class="nc">&nbsp;                bv.repaint();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_TOGGLE_FOV_DARKEN:
<b class="nc">&nbsp;                GUIPreferences.getInstance().setFovDarken(!GUIPreferences.getInstance().getFovDarken());</b>
<b class="nc">&nbsp;                bv.refreshDisplayables();</b>
<b class="nc">&nbsp;                if (client.getGame().getPhase() == Phase.PHASE_MOVEMENT) {</b>
<b class="nc">&nbsp;                    bv.clearHexImageCache();</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case VIEW_TOGGLE_FIRING_SOLUTIONS:
<b class="nc">&nbsp;                GUIPreferences.getInstance().setFiringSolutions(</b>
<b class="nc">&nbsp;                        !GUIPreferences.getInstance().getFiringSolutions());</b>
<b class="nc">&nbsp;                if (!GUIPreferences.getInstance().getFiringSolutions()) {</b>
<b class="nc">&nbsp;                    bv.clearFiringSolutionData();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    if (curPanel instanceof FiringDisplay) {</b>
<b class="nc">&nbsp;                        ((FiringDisplay) curPanel).setFiringSolutions();</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                bv.refreshDisplayables();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case VIEW_MOVE_ENV:
<b class="nc">&nbsp;                if (curPanel instanceof MovementDisplay) {</b>
<b class="nc">&nbsp;                    GUIPreferences.getInstance().setMoveEnvelope(</b>
<b class="nc">&nbsp;                            !GUIPreferences.getInstance().getMoveEnvelope());</b>
<b class="nc">&nbsp;                    ((MovementDisplay) curPanel).computeMovementEnvelope(mechD.getCurrentEntity());</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case VIEW_MOVE_MOD_ENV:
<b class="nc">&nbsp;                if (curPanel instanceof MovementDisplay) {</b>
<b class="nc">&nbsp;                    ((MovementDisplay) curPanel).computeModifierEnvelope();</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case VIEW_CHANGE_THEME:
<b class="nc">&nbsp;                bv.changeTheme();</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FIRE_SAVE_WEAPON_ORDER:
<b class="nc">&nbsp;                Entity ent = mechD.getCurrentEntity();</b>
<b class="nc">&nbsp;                if (ent != null) {</b>
<b class="nc">&nbsp;                    WeaponOrderHandler.setWeaponOrder(ent.getChassis(),</b>
<b class="nc">&nbsp;                            ent.getModel(), ent.getWeaponSortOrder(),</b>
<b class="nc">&nbsp;                            ent.getCustomWeaponOrder());</b>
<b class="nc">&nbsp;                    getMenuBar().updateSaveWeaponOrderMenuItem();</b>
<b class="nc">&nbsp;                    client.sendEntityWeaponOrderUpdate(ent);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Save all the current in use Entities each grouped by
&nbsp;     * player name
&nbsp;     * &lt;p/&gt;
&nbsp;     * and a file for salvage
&nbsp;     */
&nbsp;    public void doSaveUnit() {
<b class="nc">&nbsp;        for (Enumeration&lt;IPlayer&gt; iter = getClient().getGame().getPlayers(); iter.hasMoreElements(); ) {</b>
<b class="nc">&nbsp;            IPlayer p = iter.nextElement();</b>
<b class="nc">&nbsp;            ArrayList&lt;Entity&gt; l = getClient().getGame().getPlayerEntities(p, false);</b>
&nbsp;            // Be sure to include all units that have retreated.
<b class="nc">&nbsp;            for (Enumeration&lt;Entity&gt; iter2 = getClient().getGame().getRetreatedEntities(); iter2.hasMoreElements(); ) {</b>
<b class="nc">&nbsp;                Entity e = iter2.nextElement();</b>
<b class="nc">&nbsp;                if (e.getOwnerId() == p.getId()) {</b>
<b class="nc">&nbsp;                    l.add(e);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            saveListFile(l, p.getName());</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // save all destroyed units in a separate &quot;salvage MUL&quot;
<b class="nc">&nbsp;        ArrayList&lt;Entity&gt; destroyed = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        Enumeration&lt;Entity&gt; graveyard = getClient().getGame().getGraveyardEntities();</b>
<b class="nc">&nbsp;        while (graveyard.hasMoreElements()) {</b>
<b class="nc">&nbsp;            Entity entity = graveyard.nextElement();</b>
<b class="nc">&nbsp;            if (entity.isSalvage()) {</b>
<b class="nc">&nbsp;                destroyed.add(entity);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (destroyed.size() &gt; 0) {</b>
<b class="nc">&nbsp;            String sLogDir = PreferenceManager.getClientPreferences().getLogDirectory();</b>
<b class="nc">&nbsp;            File logDir = new File(sLogDir);</b>
<b class="nc">&nbsp;            if (!logDir.exists()) {</b>
<b class="nc">&nbsp;                logDir.mkdir();</b>
&nbsp;            }
<b class="nc">&nbsp;            String fileName = &quot;salvage.mul&quot;;</b>
<b class="nc">&nbsp;            if (PreferenceManager.getClientPreferences().stampFilenames()) {</b>
<b class="nc">&nbsp;                fileName = StringUtil.addDateTimeStamp(fileName);</b>
&nbsp;            }
<b class="nc">&nbsp;            File unitFile = new File(sLogDir + File.separator + fileName);</b>
&nbsp;            try {
&nbsp;                // Save the destroyed entities to the file.
<b class="nc">&nbsp;                EntityListFile.saveTo(unitFile, destroyed);</b>
<b class="nc">&nbsp;            } catch (IOException e) {</b>
<b class="nc">&nbsp;                MegaMek.getLogger().error(e);</b>
<b class="nc">&nbsp;                doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), e.getMessage());</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Saves the current settings to the cfg file.
&nbsp;     */
&nbsp;    void saveSettings() {
&nbsp;        // save frame location
<b class="nc">&nbsp;        GUIPreferences.getInstance().setWindowPosX(frame.getLocation().x);</b>
<b class="nc">&nbsp;        GUIPreferences.getInstance().setWindowPosY(frame.getLocation().y);</b>
<b class="nc">&nbsp;        GUIPreferences.getInstance().setWindowSizeWidth(frame.getSize().width);</b>
<b class="nc">&nbsp;        GUIPreferences.getInstance().setWindowSizeHeight(frame.getSize().height);</b>
&nbsp;
&nbsp;        // also minimap
<b class="nc">&nbsp;        if ((minimapW != null) &amp;&amp; ((minimapW.getSize().width * minimapW.getSize().height) &gt; 0)) {</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setMinimapPosX(minimapW.getLocation().x);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setMinimapPosY(minimapW.getLocation().y);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setMinimapZoom(minimap.getZoom());</b>
&nbsp;        }
&nbsp;
&nbsp;        // also mech display
<b class="nc">&nbsp;        if ((mechW != null) &amp;&amp; ((mechW.getSize().width * mechW.getSize().height) &gt; 0)) {</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setDisplayPosX(mechW.getLocation().x);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setDisplayPosY(mechW.getLocation().y);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setDisplaySizeWidth(mechW.getSize().width);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setDisplaySizeHeight(mechW.getSize().height);</b>
&nbsp;        }
&nbsp;
&nbsp;        // also ruler display
<b class="nc">&nbsp;        if ((ruler != null) &amp;&amp; (ruler.getSize().width != 0) &amp;&amp; (ruler.getSize().height != 0)) {</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setRulerPosX(ruler.getLocation().x);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setRulerPosY(ruler.getLocation().y);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setRulerSizeWidth(ruler.getSize().width);</b>
<b class="nc">&nbsp;            GUIPreferences.getInstance().setRulerSizeHeight(ruler.getSize().height);</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Shuts down threads and sockets
&nbsp;     */
&nbsp;    void die() {
&nbsp;        // Tell all the displays to remove themselves as listeners.
<b class="nc">&nbsp;        boolean reportHandled = false;</b>
<b class="nc">&nbsp;        if (bv != null) {</b>
&nbsp;            //cleanup our timers first
<b class="nc">&nbsp;            bv.die();</b>
&nbsp;        }
<b class="nc">&nbsp;        for (String s : phaseComponents.keySet()) {</b>
<b class="nc">&nbsp;            JComponent component = phaseComponents.get(s);</b>
<b class="nc">&nbsp;            if (component instanceof ReportDisplay) {</b>
<b class="nc">&nbsp;                if (reportHandled) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                reportHandled = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (component instanceof Distractable) {</b>
<b class="nc">&nbsp;                ((Distractable) component).removeAllListeners();</b>
&nbsp;            }
<b class="nc">&nbsp;        } // Handle the next component</b>
<b class="nc">&nbsp;        phaseComponents.clear();</b>
&nbsp;
<b class="nc">&nbsp;        frame.removeAll();</b>
<b class="nc">&nbsp;        frame.setVisible(false);</b>
&nbsp;        try {
<b class="nc">&nbsp;            frame.dispose();</b>
<b class="nc">&nbsp;        } catch (Throwable error) {</b>
<b class="nc">&nbsp;            error.printStackTrace();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        client.die();</b>
&nbsp;
&nbsp;        // TODO Is there a better solution?
&nbsp;        // This is required because the ChatLounge adds the listener to the
&nbsp;        // MechSummaryCache that must be removed explicitly.
<b class="nc">&nbsp;        if (chatlounge != null) {</b>
<b class="nc">&nbsp;            chatlounge.die();</b>
&nbsp;        }
<b class="nc">&nbsp;        TimerSingleton.getInstance().killTimer();</b>
&nbsp;
<b class="nc">&nbsp;        if (controller != null) {</b>
<b class="nc">&nbsp;            controller.removeAllActions();</b>
<b class="nc">&nbsp;            controller.clientgui = null;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (menuBar != null) {</b>
<b class="nc">&nbsp;            menuBar.die();</b>
<b class="nc">&nbsp;            menuBar = null;</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public GameOptionsDialog getGameOptionsDialog() {
<b class="nc">&nbsp;        if (gameOptionsDialog == null) {</b>
<b class="nc">&nbsp;            gameOptionsDialog = new GameOptionsDialog(this);</b>
&nbsp;        }
<b class="nc">&nbsp;        return gameOptionsDialog;</b>
&nbsp;    }
&nbsp;
&nbsp;    public AbstractUnitSelectorDialog getMechSelectorDialog() {
<b class="nc">&nbsp;        return mechSelectorDialog;</b>
&nbsp;    }
&nbsp;
&nbsp;    public StartingPositionDialog getStartingPositionDialog() {
<b class="nc">&nbsp;        if (startingPositionDialog == null) {</b>
<b class="nc">&nbsp;            startingPositionDialog = new StartingPositionDialog(this);</b>
&nbsp;        }
<b class="nc">&nbsp;        return startingPositionDialog;</b>
&nbsp;    }
&nbsp;
&nbsp;    public PlanetaryConditionsDialog getPlanetaryConditionsDialog() {
<b class="nc">&nbsp;        if (conditionsDialog == null) {</b>
<b class="nc">&nbsp;            conditionsDialog = new PlanetaryConditionsDialog(this);</b>
&nbsp;        }
<b class="nc">&nbsp;        return conditionsDialog;</b>
&nbsp;    }
&nbsp;
&nbsp;    void switchPanel(IGame.Phase phase) {
&nbsp;        // Clear the old panel&#39;s listeners.
<b class="nc">&nbsp;        if (curPanel instanceof BoardViewListener) {</b>
<b class="nc">&nbsp;            bv.removeBoardViewListener((BoardViewListener) curPanel);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (curPanel instanceof ActionListener) {</b>
<b class="nc">&nbsp;            menuBar.removeActionListener((ActionListener) curPanel);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (curPanel instanceof Distractable) {</b>
<b class="nc">&nbsp;            ((Distractable) curPanel).setIgnoringEvents(true);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Get the new panel.
<b class="nc">&nbsp;        String name = String.valueOf(phase);</b>
<b class="nc">&nbsp;        curPanel = phaseComponents.get(name);</b>
<b class="nc">&nbsp;        if (curPanel == null) {</b>
<b class="nc">&nbsp;            curPanel = initializePanel(phase);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Handle phase-specific items.
<b class="nc">&nbsp;        switch (phase) {</b>
&nbsp;            case PHASE_LOUNGE:
&nbsp;                // reset old report tabs and images, if any
<b class="nc">&nbsp;                ReportDisplay rD = (ReportDisplay) phaseComponents.get(String.valueOf(IGame.Phase.PHASE_INITIATIVE_REPORT));</b>
<b class="nc">&nbsp;                if (rD != null) {</b>
<b class="nc">&nbsp;                    rD.resetTabs();</b>
&nbsp;                }
<b class="nc">&nbsp;                ChatLounge cl = (ChatLounge) phaseComponents.get(String.valueOf(IGame.Phase.PHASE_LOUNGE));</b>
<b class="nc">&nbsp;                cb.setDoneButton(cl.butDone);</b>
<b class="nc">&nbsp;                cl.add(cb.getComponent(), BorderLayout.SOUTH);</b>
<b class="nc">&nbsp;                getBoardView().getTilesetManager().reset();</b>
<b class="nc">&nbsp;                mechW.setVisible(false);</b>
<b class="nc">&nbsp;                setMapVisible(false);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_POINTBLANK_SHOT:
&nbsp;            case PHASE_SET_ARTYAUTOHITHEXES:
&nbsp;            case PHASE_DEPLOY_MINEFIELDS:
&nbsp;            case PHASE_DEPLOYMENT:
&nbsp;            case PHASE_TARGETING:
&nbsp;            case PHASE_MOVEMENT:
&nbsp;            case PHASE_OFFBOARD:
&nbsp;            case PHASE_FIRING:
&nbsp;            case PHASE_PHYSICAL:
<b class="nc">&nbsp;                if (GUIPreferences.getInstance().getMinimapEnabled() &amp;&amp; !minimapW.isVisible()) {</b>
<b class="nc">&nbsp;                    setMapVisible(true);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case PHASE_INITIATIVE_REPORT:
&nbsp;            case PHASE_TARGETING_REPORT:
&nbsp;            case PHASE_MOVEMENT_REPORT:
&nbsp;            case PHASE_OFFBOARD_REPORT:
&nbsp;            case PHASE_FIRING_REPORT:
&nbsp;            case PHASE_PHYSICAL_REPORT:
&nbsp;            case PHASE_END_REPORT:
&nbsp;            case PHASE_VICTORY:
<b class="nc">&nbsp;                rD = (ReportDisplay) phaseComponents.get(String.valueOf(IGame.Phase.PHASE_INITIATIVE_REPORT));</b>
<b class="nc">&nbsp;                cb.setDoneButton(rD.butDone);</b>
<b class="nc">&nbsp;                rD.add(cb.getComponent(), GBC.eol().fill(GridBagConstraints.HORIZONTAL));</b>
<b class="nc">&nbsp;                setMapVisible(false);</b>
<b class="nc">&nbsp;                mechW.setVisible(false);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            default:
&nbsp;                break;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        cardsMain.show(panMain, mainNames.get(name));</b>
<b class="nc">&nbsp;        String secondaryToShow = secondaryNames.get(name);</b>
&nbsp;        // only show the secondary component if there is one to show
<b class="nc">&nbsp;        if (secondaryToShow != null) {</b>
<b class="nc">&nbsp;            panSecondary.setVisible(true);</b>
<b class="nc">&nbsp;            cardsSecondary.show(panSecondary, secondaryNames.get(name));</b>
&nbsp;        } else {
&nbsp;            // otherwise, hide the panel
<b class="nc">&nbsp;            panSecondary.setVisible(false);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Set the new panel&#39;s listeners
<b class="nc">&nbsp;        if (curPanel instanceof BoardViewListener) {</b>
<b class="nc">&nbsp;            bv.addBoardViewListener((BoardViewListener) curPanel);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (curPanel instanceof ActionListener) {</b>
<b class="nc">&nbsp;            menuBar.addActionListener((ActionListener) curPanel);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (curPanel instanceof Distractable) {</b>
<b class="nc">&nbsp;            ((Distractable) curPanel).setIgnoringEvents(false);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Make the new panel the focus, if the Client option says so
<b class="nc">&nbsp;        if (GUIPreferences.getInstance().getFocus() &amp;&amp; !(client instanceof TestBot)) {</b>
<b class="nc">&nbsp;            curPanel.requestFocus();</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public void updateButtonPanel(IGame.Phase phase) {
<b class="nc">&nbsp;        if ((currPhaseDisplay != null)</b>
<b class="nc">&nbsp;                &amp;&amp; client.getGame().getPhase().equals(phase)) {</b>
<b class="nc">&nbsp;            currPhaseDisplay.setupButtonPanel();</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private JComponent initializePanel(IGame.Phase phase) {
&nbsp;        // Create the components for this phase.
<b class="nc">&nbsp;        String name = String.valueOf(phase);</b>
&nbsp;        JComponent component;
<b class="nc">&nbsp;        String secondary = null;</b>
&nbsp;        String main;
<b class="nc">&nbsp;        switch (phase) {</b>
&nbsp;            case PHASE_LOUNGE:
<b class="nc">&nbsp;                component = new ChatLounge(this);</b>
<b class="nc">&nbsp;                chatlounge = (ChatLounge) component;</b>
<b class="nc">&nbsp;                main = &quot;ChatLounge&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(main);</b>
<b class="nc">&nbsp;                panMain.add(component, main);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_STARTING_SCENARIO:
<b class="nc">&nbsp;                component = new JLabel(Messages.getString(&quot;ClientGUI.StartingScenario&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                main = &quot;JLabel-StartingScenario&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(main);</b>
<b class="nc">&nbsp;                panMain.add(component, main);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_EXCHANGE:
<b class="nc">&nbsp;                component = new JLabel(Messages.getString(&quot;ClientGUI.TransmittingData&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                main = &quot;JLabel-Exchange&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(main);</b>
<b class="nc">&nbsp;                panMain.add(component, main);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_SET_ARTYAUTOHITHEXES:
<b class="nc">&nbsp;                component = new SelectArtyAutoHitHexDisplay(this);</b>
<b class="nc">&nbsp;                main = &quot;BoardView&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = &quot;SelectArtyAutoHitHexDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(secondary);</b>
<b class="nc">&nbsp;                if (!mainNames.containsValue(main)) {</b>
<b class="nc">&nbsp;                    panMain.add(bvc, main);</b>
&nbsp;                }
<b class="nc">&nbsp;                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</b>
<b class="nc">&nbsp;                panSecondary.add(component, secondary);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_DEPLOY_MINEFIELDS:
<b class="nc">&nbsp;                component = new DeployMinefieldDisplay(this);</b>
<b class="nc">&nbsp;                main = &quot;BoardView&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = &quot;DeployMinefieldDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(secondary);</b>
<b class="nc">&nbsp;                if (!mainNames.containsValue(main)) {</b>
<b class="nc">&nbsp;                    panMain.add(bvc, main);</b>
&nbsp;                }
<b class="nc">&nbsp;                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</b>
<b class="nc">&nbsp;                panSecondary.add(component, secondary);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_DEPLOYMENT:
<b class="nc">&nbsp;                component = new DeploymentDisplay(this);</b>
<b class="nc">&nbsp;                main = &quot;BoardView&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = &quot;DeploymentDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(secondary);</b>
<b class="nc">&nbsp;                if (!mainNames.containsValue(main)) {</b>
<b class="nc">&nbsp;                    panMain.add(bvc, main);</b>
&nbsp;                }
<b class="nc">&nbsp;                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</b>
<b class="nc">&nbsp;                panSecondary.add(component, secondary);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_TARGETING:
<b class="nc">&nbsp;                component = new TargetingPhaseDisplay(this, false);</b>
<b class="nc">&nbsp;                ((TargetingPhaseDisplay) component).initializeListeners();</b>
<b class="nc">&nbsp;                main = &quot;BoardView&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = &quot;TargetingPhaseDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(secondary);</b>
<b class="nc">&nbsp;                if (!mainNames.containsValue(main)) {</b>
<b class="nc">&nbsp;                    panMain.add(bvc, main);</b>
&nbsp;                }
<b class="nc">&nbsp;                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</b>
<b class="nc">&nbsp;                panSecondary.add(component, secondary);</b>
<b class="nc">&nbsp;                offBoardOverlay.setTargetingPhaseDisplay((TargetingPhaseDisplay) component);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_MOVEMENT:
<b class="nc">&nbsp;                component = new MovementDisplay(this);</b>
<b class="nc">&nbsp;                main = &quot;BoardView&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = &quot;MovementDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(secondary);</b>
<b class="nc">&nbsp;                if (!mainNames.containsValue(main)) {</b>
<b class="nc">&nbsp;                    panMain.add(bvc, main);</b>
&nbsp;                }
<b class="nc">&nbsp;                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</b>
<b class="nc">&nbsp;                panSecondary.add(component, secondary);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_OFFBOARD:
<b class="nc">&nbsp;                component = new TargetingPhaseDisplay(this, true);</b>
<b class="nc">&nbsp;                ((TargetingPhaseDisplay) component).initializeListeners();</b>
<b class="nc">&nbsp;                main = &quot;BoardView&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = &quot;OffboardDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(secondary);</b>
<b class="nc">&nbsp;                if (!mainNames.containsValue(main)) {</b>
<b class="nc">&nbsp;                    panMain.add(bvc, main);</b>
&nbsp;                }
<b class="nc">&nbsp;                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</b>
<b class="nc">&nbsp;                panSecondary.add(component, secondary);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_FIRING:
<b class="nc">&nbsp;                component = new FiringDisplay(this);</b>
<b class="nc">&nbsp;                main = &quot;BoardView&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = &quot;FiringDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(secondary);</b>
<b class="nc">&nbsp;                if (!mainNames.containsValue(main)) {</b>
<b class="nc">&nbsp;                    panMain.add(bvc, main);</b>
&nbsp;                }
<b class="nc">&nbsp;                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</b>
<b class="nc">&nbsp;                panSecondary.add(component, secondary);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_POINTBLANK_SHOT:
<b class="nc">&nbsp;                component = new PointblankShotDisplay(this);</b>
<b class="nc">&nbsp;                main = &quot;BoardView&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = &quot;PointblankShotDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(secondary);</b>
<b class="nc">&nbsp;                if (!mainNames.containsValue(main)) {</b>
<b class="nc">&nbsp;                    panMain.add(bvc, main);</b>
&nbsp;                }
<b class="nc">&nbsp;                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</b>
<b class="nc">&nbsp;                panSecondary.add(component, secondary);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_PHYSICAL:
<b class="nc">&nbsp;                component = new PhysicalDisplay(this);</b>
<b class="nc">&nbsp;                main = &quot;BoardView&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = &quot;PhysicalDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(secondary);</b>
<b class="nc">&nbsp;                if (!mainNames.containsValue(main)) {</b>
<b class="nc">&nbsp;                    panMain.add(bvc, main);</b>
&nbsp;                }
<b class="nc">&nbsp;                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</b>
<b class="nc">&nbsp;                panSecondary.add(component, secondary);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_INITIATIVE_REPORT:
<b class="nc">&nbsp;                component = new ReportDisplay(this);</b>
<b class="nc">&nbsp;                main = &quot;ReportDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                component.setName(main);</b>
<b class="nc">&nbsp;                panMain.add(main, component);</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case PHASE_TARGETING_REPORT:
&nbsp;            case PHASE_MOVEMENT_REPORT:
&nbsp;            case PHASE_OFFBOARD_REPORT:
&nbsp;            case PHASE_FIRING_REPORT:
&nbsp;            case PHASE_PHYSICAL_REPORT:
&nbsp;            case PHASE_END_REPORT:
&nbsp;            case PHASE_VICTORY:
&nbsp;                // Try to reuse the ReportDisplay for other phases...
<b class="nc">&nbsp;                component = phaseComponents.get(String.valueOf(IGame.Phase.PHASE_INITIATIVE_REPORT));</b>
<b class="nc">&nbsp;                if (component == null) {</b>
&nbsp;                    // no ReportDisplay to reuse -- get a new one
<b class="nc">&nbsp;                    component = initializePanel(IGame.Phase.PHASE_INITIATIVE_REPORT);</b>
&nbsp;                }
<b class="nc">&nbsp;                main = &quot;ReportDisplay&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            default:
<b class="nc">&nbsp;                component = new JLabel(Messages.getString(&quot;ClientGUI.waitingOnTheServer&quot;)); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                main = &quot;JLabel-Default&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                secondary = main;</b>
<b class="nc">&nbsp;                component.setName(main);</b>
<b class="nc">&nbsp;                panMain.add(main, component);</b>
&nbsp;        }
<b class="nc">&nbsp;        phaseComponents.put(name, component);</b>
<b class="nc">&nbsp;        mainNames.put(name, main);</b>
<b class="nc">&nbsp;        if (secondary != null) {</b>
<b class="nc">&nbsp;            secondaryNames.put(name, secondary);</b>
&nbsp;        }
<b class="nc">&nbsp;        return component;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void showBoardPopup(Coords c) {
<b class="nc">&nbsp;        if (fillPopup(c)) {</b>
<b class="nc">&nbsp;            bv.showPopup(popup, c);</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /** Switches the Minimap and the MechDisplay an and off together.
&nbsp;     *  If the MechDisplay is active, both will be hidden, else
&nbsp;     *  both will be shown.
&nbsp;     */
&nbsp;    public void toggleMMUDDisplays() {
<b class="nc">&nbsp;        if (mechW.isVisible()) {</b>
<b class="nc">&nbsp;            setDisplayVisible(false);</b>
<b class="nc">&nbsp;            setMapVisible(false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            setDisplayVisible(true);</b>
<b class="nc">&nbsp;            setMapVisible(true);</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Toggles the entity display window
&nbsp;     */
&nbsp;    private void toggleDisplay() {
<b class="nc">&nbsp;        mechW.setVisible(!mechW.isVisible());</b>
<b class="nc">&nbsp;        if (mechW.isVisible()) {</b>
<b class="nc">&nbsp;            frame.requestFocus();</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Toggles the accessibility window
&nbsp;     */
&nbsp;    private void toggleAccessibilityWindow() {
<b class="nc">&nbsp;        aw.setVisible(!aw.isVisible());</b>
<b class="nc">&nbsp;        if (aw.isVisible()) {</b>
<b class="nc">&nbsp;            frame.requestFocus();</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the visibility of the entity display window
&nbsp;     */
&nbsp;    public void setDisplayVisible(boolean visible) {
&nbsp;        // If no unit displayed, select a unit so display can be safely shown
&nbsp;        // This can happen when using mouse button 4
<b class="nc">&nbsp;        Entity unitToSelect = null;</b>
<b class="nc">&nbsp;        IGame game = (getClient() != null) ? getClient().getGame() : null;</b>
<b class="nc">&nbsp;        if ((mechD.getCurrentEntity() == null) &amp;&amp; (game != null)) {</b>
<b class="nc">&nbsp;            List&lt;Entity&gt; es = getClient().getGame().getEntitiesVector();</b>
<b class="nc">&nbsp;            if ((es != null) &amp;&amp; (es.size() &gt; 0)) {</b>
<b class="nc">&nbsp;                unitToSelect = es.get(0);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        mechW.setVisible(visible);</b>
<b class="nc">&nbsp;        if (unitToSelect != null) {</b>
<b class="nc">&nbsp;            mechD.displayEntity(unitToSelect);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (visible) {</b>
<b class="nc">&nbsp;            frame.requestFocus();</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private void toggleUnitOverview() {
<b class="nc">&nbsp;        uo.setVisible(!uo.isVisible());</b>
<b class="nc">&nbsp;        GUIPreferences.getInstance().setShowUnitOverview(uo.isVisible());</b>
<b class="nc">&nbsp;        bv.refreshDisplayables();</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Toggles the minimap window Also, toggles the minimap enabled setting
&nbsp;     */
&nbsp;    private void toggleMap() {
<b class="nc">&nbsp;        minimapW.setVisible(!minimapW.isVisible());</b>
<b class="nc">&nbsp;        GUIPreferences.getInstance().setMinimapEnabled(minimapW.isVisible());</b>
<b class="nc">&nbsp;        if (minimapW.isVisible()) {</b>
<b class="nc">&nbsp;            frame.requestFocus();</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the visibility of the minimap window
&nbsp;     */
&nbsp;    void setMapVisible(boolean visible) {
<b class="nc">&nbsp;        minimapW.setVisible(visible);</b>
<b class="nc">&nbsp;        if (visible) {</b>
<b class="nc">&nbsp;            frame.requestFocus();</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private boolean fillPopup(Coords coords) {
<b class="nc">&nbsp;        popup = new MapMenu(coords, client, curPanel, this);</b>
<b class="nc">&nbsp;        return popup.getHasMenu();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Pops up a dialog box giving the player a series of choices that are not
&nbsp;     * mutually exclusive.
&nbsp;     *
&nbsp;     * @param title    the &lt;code&gt;String&lt;/code&gt; title of the dialog box.
&nbsp;     * @param question the &lt;code&gt;String&lt;/code&gt; question that has a &quot;Yes&quot; or &quot;No&quot;
&nbsp;     *                 answer. The question will be split across multiple line on the
&nbsp;     *                 &#39;\n&#39; characters.
&nbsp;     * @param choices  the array of &lt;code&gt;String&lt;/code&gt; choices that the player can
&nbsp;     *                 select from.
&nbsp;     * @return The array of the &lt;code&gt;int&lt;/code&gt; indexes of the from the input
&nbsp;     *         array that match the selected choices. If no choices were
&nbsp;     *         available, if the player did not select a choice, or if the
&nbsp;     *         player canceled the choice, a &lt;code&gt;null&lt;/code&gt; value is
&nbsp;     *         returned.
&nbsp;     */
&nbsp;    public int[] doChoiceDialog(String title, String question, String[] choices) {
<b class="nc">&nbsp;        ChoiceDialog choice = new ChoiceDialog(frame, title, question, choices);</b>
<b class="nc">&nbsp;        choice.setVisible(true);</b>
<b class="nc">&nbsp;        return choice.getChoices();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Pops up a dialog box showing an alert
&nbsp;     */
&nbsp;    public void doAlertDialog(String title, String message) {
<b class="nc">&nbsp;        JTextPane textArea = new JTextPane();</b>
<b class="nc">&nbsp;        ReportDisplay.setupStylesheet(textArea);</b>
<b class="nc">&nbsp;        BASE64ToolKit toolKit = new BASE64ToolKit();</b>
<b class="nc">&nbsp;        textArea.setEditorKit(toolKit);</b>
<b class="nc">&nbsp;        textArea.setEditable(false);</b>
<b class="nc">&nbsp;        JScrollPane scrollPane = new JScrollPane(textArea,</b>
&nbsp;                ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,
&nbsp;                ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<b class="nc">&nbsp;        textArea.setText(&quot;&lt;pre&gt;&quot; + message + &quot;&lt;/pre&gt;&quot;);</b>
<b class="nc">&nbsp;        scrollPane.setPreferredSize(new Dimension(</b>
<b class="nc">&nbsp;                (int) (getSize().getWidth() / 1.5), (int) (getSize()</b>
<b class="nc">&nbsp;                        .getHeight() / 1.5)));</b>
<b class="nc">&nbsp;        JOptionPane.showMessageDialog(frame, scrollPane, title,</b>
&nbsp;                JOptionPane.ERROR_MESSAGE);
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Pops up a dialog box asking a yes/no question
&nbsp;     *
&nbsp;     * @param title    the &lt;code&gt;String&lt;/code&gt; title of the dialog box.
&nbsp;     * @param question the &lt;code&gt;String&lt;/code&gt; question that has a &quot;Yes&quot; or &quot;No&quot;
&nbsp;     *                 answer. The question will be split across multiple line on the
&nbsp;     *                 &#39;\n&#39; characters.
&nbsp;     * @return &lt;code&gt;true&lt;/code&gt; if yes
&nbsp;     */
&nbsp;    public boolean doYesNoDialog(String title, String question) {
<b class="nc">&nbsp;        ConfirmDialog confirm = new ConfirmDialog(frame, title, question);</b>
<b class="nc">&nbsp;        confirm.setVisible(true);</b>
<b class="nc">&nbsp;        return confirm.getAnswer();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Pops up a dialog box asking a yes/no question
&nbsp;     * &lt;p/&gt;
&nbsp;     * The player will be given a chance to not show the dialog again.
&nbsp;     *
&nbsp;     * @param title    the &lt;code&gt;String&lt;/code&gt; title of the dialog box.
&nbsp;     * @param question the &lt;code&gt;String&lt;/code&gt; question that has a &quot;Yes&quot; or &quot;No&quot;
&nbsp;     *                 answer. The question will be split across multiple line on the
&nbsp;     *                 &#39;\n&#39; characters.
&nbsp;     * @return the &lt;code&gt;ConfirmDialog&lt;/code&gt; containing the player&#39;s responses.
&nbsp;     *         The dialog will already have been shown to the player, and is
&nbsp;     *         only being returned so the calling function can see the answer to
&nbsp;     *         the question and the state of the &quot;Show again?&quot; question.
&nbsp;     */
&nbsp;    public ConfirmDialog doYesNoBotherDialog(String title, String question) {
<b class="nc">&nbsp;        ConfirmDialog confirm = new ConfirmDialog(frame, title, question, true);</b>
<b class="nc">&nbsp;        confirm.setVisible(true);</b>
<b class="nc">&nbsp;        return confirm;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Allow the player to select a MegaMek Unit List file to load. The
&nbsp;     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
&nbsp;     * already selected. As such, this method should only be called in the chat
&nbsp;     * lounge. The file can record damage sustained, non- standard munitions
&nbsp;     * selected, and ammunition expended in a prior engagement.
&nbsp;     */
&nbsp;    protected void loadListFile() {
<b class="nc">&nbsp;        loadListFile(client.getLocalPlayer());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Allow the player to select a MegaMek Unit List file to load. The
&nbsp;     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
&nbsp;     * already selected. As such, this method should only be called in the chat
&nbsp;     * lounge. The file can record damage sustained, non- standard munitions
&nbsp;     * selected, and ammunition expended in a prior engagement.
&nbsp;     *
&nbsp;     * @param c
&nbsp;     */
&nbsp;    protected void loadListFile(Client c) {
<b class="nc">&nbsp;        loadListFile(c.getLocalPlayer());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Allow the player to select a MegaMek Unit List file to load. The
&nbsp;     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
&nbsp;     * already selected. As such, this method should only be called in the chat
&nbsp;     * lounge. The file can record damage sustained, non- standard munitions
&nbsp;     * selected, and ammunition expended in a prior engagement.
&nbsp;     *
&nbsp;     * @param player
&nbsp;     */
&nbsp;    protected void loadListFile(IPlayer player) {
<b class="nc">&nbsp;        loadListFile(player, false);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Allow the player to select a MegaMek Unit List file to load. The
&nbsp;     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
&nbsp;     * already selected. As such, this method should only be called in the chat
&nbsp;     * lounge. The file can record damage sustained, non- standard munitions
&nbsp;     * selected, and ammunition expended in a prior engagement.
&nbsp;     *
&nbsp;     * @param player
&nbsp;     */
&nbsp;    protected void loadListFile(IPlayer player, boolean reinforce) {
<b class="nc">&nbsp;        boolean addedUnits = false;</b>
&nbsp;
<b class="nc">&nbsp;        if (reinforce &amp;&amp; player.getTeam() == IPlayer.TEAM_UNASSIGNED){</b>
<b class="nc">&nbsp;            String title = Messages.getString(</b>
&nbsp;                    &quot;ClientGUI.openUnitListFileDialog.noReinforceTitle&quot;); //$NON-NLS-1$
<b class="nc">&nbsp;            String msg = Messages.getString(</b>
&nbsp;                    &quot;ClientGUI.openUnitListFileDialog.noReinforceMessage&quot;);  //$NON-NLS-1$
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(frame, msg, title,</b>
&nbsp;                    JOptionPane.OK_OPTION, null);
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
&nbsp;        // Build the &quot;load unit&quot; dialog, if necessary.
<b class="nc">&nbsp;        if (dlgLoadList == null) {</b>
<b class="nc">&nbsp;            dlgLoadList = new JFileChooser(&quot;.&quot;);</b>
<b class="nc">&nbsp;            dlgLoadList.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</b>
<b class="nc">&nbsp;            dlgLoadList.setDialogTitle(Messages.getString(&quot;ClientGUI.openUnitListFileDialog.title&quot;));</b>
<b class="nc">&nbsp;            dlgLoadList.setFileFilter(new FileFilter() {</b>
&nbsp;                @Override
&nbsp;                public boolean accept(File dir) {
<b class="nc">&nbsp;                    return (dir.getName().endsWith(&quot;.mul&quot;) || dir.isDirectory()); //$NON-NLS-1$</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                public String getDescription() {
<b class="nc">&nbsp;                    return &quot;*.mul&quot;;</b>
&nbsp;                }
&nbsp;            });
&nbsp;            // Default to the player&#39;s name.
<b class="nc">&nbsp;            dlgLoadList.setSelectedFile(new File(player.getName() + &quot;.mul&quot;)); //$NON-NLS-1$</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int returnVal = dlgLoadList.showOpenDialog(frame);</b>
<b class="nc">&nbsp;        if ((returnVal != JFileChooser.APPROVE_OPTION) || (dlgLoadList.getSelectedFile() == null)) {</b>
&nbsp;            // I want a file, y&#39;know!
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Did the player select a file?
<b class="nc">&nbsp;        File unitFile = dlgLoadList.getSelectedFile();</b>
<b class="nc">&nbsp;        if (unitFile != null) {</b>
&nbsp;            try {
&nbsp;                // Read the units from the file.
<b class="nc">&nbsp;                Vector&lt;Entity&gt; loadedUnits = EntityListFile.loadFrom(unitFile);</b>
&nbsp;
&nbsp;                // Add the units from the file.
<b class="nc">&nbsp;                for (Entity entity : loadedUnits) {</b>
<b class="nc">&nbsp;                    entity.setOwner(player);</b>
<b class="nc">&nbsp;                    if (reinforce) {</b>
<b class="nc">&nbsp;                        entity.setDeployRound(client.getGame().getRoundCount()+1);</b>
<b class="nc">&nbsp;                        entity.setGame(client.getGame());</b>
&nbsp;                        // Set these to true, otherwise units reinforced in
&nbsp;                        // the movement turn are considered selectable
<b class="nc">&nbsp;                        entity.setDone(true);</b>
<b class="nc">&nbsp;                        entity.setUnloaded(true);</b>
<b class="nc">&nbsp;                        if (entity instanceof IBomber) {</b>
<b class="nc">&nbsp;                            ((IBomber)entity).applyBombs();</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                if (loadedUnits.size() &gt; 0){</b>
<b class="nc">&nbsp;                    client.sendAddEntity(loadedUnits);</b>
<b class="nc">&nbsp;                    addedUnits = true;</b>
&nbsp;                }
<b class="nc">&nbsp;            } catch (IOException excep) {</b>
<b class="nc">&nbsp;                excep.printStackTrace(System.err);</b>
<b class="nc">&nbsp;                doAlertDialog(Messages.getString(&quot;ClientGUI.errorLoadingFile&quot;), excep.getMessage()); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
&nbsp;        // If we&#39;ve added reinforcements, then we need to set the round deployment up again.
<b class="nc">&nbsp;        if (addedUnits &amp;&amp; reinforce) {</b>
<b class="nc">&nbsp;            client.getGame().setupRoundDeployment();</b>
<b class="nc">&nbsp;            client.sendResetRoundDeployment();</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public void deleteAllUnits(Client c) {
<b class="nc">&nbsp;        ArrayList&lt;Entity&gt; currentUnits = c.getGame().getPlayerEntities(</b>
<b class="nc">&nbsp;                c.getLocalPlayer(), false);</b>
<b class="nc">&nbsp;        ArrayList&lt;Integer&gt; ids = new ArrayList&lt;&gt;(currentUnits.size());</b>
<b class="nc">&nbsp;        for (Entity e : currentUnits){</b>
<b class="nc">&nbsp;            ids.add(e.getId());</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        c.sendDeleteEntities(ids);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private boolean saveGame() {
<b class="nc">&nbsp;        ignoreHotKeys = true;</b>
<b class="nc">&nbsp;        JFileChooser fc = new JFileChooser(&quot;./savegames&quot;);</b>
<b class="nc">&nbsp;        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</b>
<b class="nc">&nbsp;        fc.setDialogTitle(Messages.getString(&quot;ClientGUI.FileSaveDialog.title&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        int returnVal = fc.showSaveDialog(frame);</b>
<b class="nc">&nbsp;        ignoreHotKeys = false;</b>
<b class="nc">&nbsp;        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</b>
&nbsp;            // I want a file, y&#39;know!
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (fc.getSelectedFile() != null) {</b>
<b class="nc">&nbsp;            String file = fc.getSelectedFile().getName();</b>
&nbsp;            // stupid hack to allow for savegames in folders with spaces in
&nbsp;            // the name
<b class="nc">&nbsp;            String path = fc.getSelectedFile().getParentFile().getPath();</b>
<b class="nc">&nbsp;            path = path.replace(&quot; &quot;, &quot;|&quot;);</b>
<b class="nc">&nbsp;            client.sendChat(&quot;/localsave &quot; + file + &quot; &quot; + path); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Allow the player to save a list of entities to a MegaMek Unit List file.
&nbsp;     * A &quot;Save As&quot; dialog will be displayed that allows the user to select the
&nbsp;     * file&#39;s name and directory. The player can later load this file to quickly
&nbsp;     * select the units for a new game. The file will record damage sustained,
&nbsp;     * non-standard munitions selected, and ammunition expended during the
&nbsp;     * course of the current engagement.
&nbsp;     *
&nbsp;     * @param unitList - the &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Entity&lt;/code&gt;s to be saved
&nbsp;     *                 to a file. If this value is &lt;code&gt;null&lt;/code&gt; or empty, the
&nbsp;     *                 &quot;Save As&quot; dialog will not be displayed.
&nbsp;     */
&nbsp;    protected void saveListFile(ArrayList&lt;Entity&gt; unitList) {
<b class="nc">&nbsp;        saveListFile(unitList, client.getLocalPlayer().getName());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    protected void saveListFile(ArrayList&lt;Entity&gt; unitList, String filename) {
&nbsp;        // Handle empty lists.
<b class="nc">&nbsp;        if ((unitList == null) || unitList.isEmpty()) {</b>
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Build the &quot;save unit&quot; dialog, if necessary.
<b class="nc">&nbsp;        if (dlgSaveList == null) {</b>
<b class="nc">&nbsp;            dlgSaveList = new JFileChooser(&quot;.&quot;);</b>
<b class="nc">&nbsp;            dlgSaveList.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</b>
<b class="nc">&nbsp;            dlgSaveList.setDialogTitle(Messages.getString(&quot;ClientGUI.saveUnitListFileDialog.title&quot;));</b>
<b class="nc">&nbsp;            FileNameExtensionFilter filter = new FileNameExtensionFilter(&quot;Mul Files&quot;, &quot;mul&quot;);</b>
<b class="nc">&nbsp;            dlgSaveList.setFileFilter(filter);</b>
&nbsp;        }
&nbsp;        // Default to the player&#39;s name.
<b class="nc">&nbsp;        dlgSaveList.setSelectedFile(new File(filename + &quot;.mul&quot;)); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;        int returnVal = dlgSaveList.showSaveDialog(frame);</b>
<b class="nc">&nbsp;        if ((returnVal != JFileChooser.APPROVE_OPTION) || (dlgSaveList.getSelectedFile() == null)) {</b>
&nbsp;            // I want a file, y&#39;know!
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Did the player select a file?
<b class="nc">&nbsp;        File unitFile = dlgSaveList.getSelectedFile();</b>
<b class="nc">&nbsp;        if (unitFile != null) {</b>
<b class="nc">&nbsp;            if (!(unitFile.getName().toLowerCase().endsWith(&quot;.mul&quot;) //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    || unitFile.getName().toLowerCase().endsWith(&quot;.xml&quot;))) { //$NON-NLS-1$</b>
&nbsp;                try {
<b class="nc">&nbsp;                    unitFile = new File(unitFile.getCanonicalPath() + &quot;.mul&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                } catch (IOException ie) {</b>
&nbsp;                    // nothing needs to be done here
<b class="nc">&nbsp;                    return;</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;            try {
&nbsp;                // Save the player&#39;s entities to the file.
<b class="nc">&nbsp;                EntityListFile.saveTo(unitFile, unitList);</b>
<b class="nc">&nbsp;            } catch (IOException excep) {</b>
<b class="nc">&nbsp;                excep.printStackTrace(System.err);</b>
<b class="nc">&nbsp;                doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), excep.getMessage()); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    protected void saveVictoryList() {
<b class="nc">&nbsp;        String filename = client.getLocalPlayer().getName();</b>
&nbsp;
&nbsp;        // Build the &quot;save unit&quot; dialog, if necessary.
<b class="nc">&nbsp;        if (dlgSaveList == null) {</b>
<b class="nc">&nbsp;            dlgSaveList = new JFileChooser(&quot;.&quot;);</b>
<b class="nc">&nbsp;            dlgSaveList.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</b>
<b class="nc">&nbsp;            dlgSaveList.setDialogTitle(Messages.getString(&quot;ClientGUI.saveUnitListFileDialog.title&quot;));</b>
<b class="nc">&nbsp;            FileNameExtensionFilter filter = new FileNameExtensionFilter(&quot;Mul Files&quot;, &quot;mul&quot;);</b>
<b class="nc">&nbsp;            dlgSaveList.setFileFilter(filter);</b>
&nbsp;        }
&nbsp;        // Default to the player&#39;s name.
<b class="nc">&nbsp;        dlgSaveList.setSelectedFile(new File(filename + &quot;.mul&quot;)); //$NON-NLS-1$</b>
&nbsp;
<b class="nc">&nbsp;        int returnVal = dlgSaveList.showSaveDialog(frame);</b>
<b class="nc">&nbsp;        if ((returnVal != JFileChooser.APPROVE_OPTION) || (dlgSaveList.getSelectedFile() == null)) {</b>
&nbsp;            // I want a file, y&#39;know!
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Did the player select a file?
<b class="nc">&nbsp;        File unitFile = dlgSaveList.getSelectedFile();</b>
<b class="nc">&nbsp;        if (unitFile != null) {</b>
<b class="nc">&nbsp;            if (!(unitFile.getName().toLowerCase().endsWith(&quot;.mul&quot;) //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    || unitFile.getName().toLowerCase().endsWith(&quot;.xml&quot;))) { //$NON-NLS-1$</b>
&nbsp;                try {
<b class="nc">&nbsp;                    unitFile = new File(unitFile.getCanonicalPath() + &quot;.mul&quot;); //$NON-NLS-1$</b>
<b class="nc">&nbsp;                } catch (IOException ie) {</b>
&nbsp;                    // nothing needs to be done here
<b class="nc">&nbsp;                    return;</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;            try {
&nbsp;                // Save the player&#39;s entities to the file.
<b class="nc">&nbsp;                EntityListFile.saveTo(unitFile, getClient());</b>
<b class="nc">&nbsp;            } catch (IOException excep) {</b>
<b class="nc">&nbsp;                excep.printStackTrace(System.err);</b>
<b class="nc">&nbsp;                doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), excep.getMessage()); //$NON-NLS-1$</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    //region Window Listeners
&nbsp;    @Override
&nbsp;    public void windowActivated(WindowEvent windowEvent) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void windowClosed(WindowEvent windowEvent) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void windowClosing(WindowEvent windowEvent) {
<b class="nc">&nbsp;        if (windowEvent.getWindow().equals(minimapW)) {</b>
<b class="nc">&nbsp;            setMapVisible(false);</b>
<b class="nc">&nbsp;        } else if (windowEvent.getWindow().equals(mechW)) {</b>
<b class="nc">&nbsp;            setDisplayVisible(false);</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void windowDeactivated(WindowEvent windowEvent) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void windowDeiconified(WindowEvent windowEvent) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void windowIconified(WindowEvent windowEvent) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void windowOpened(WindowEvent windowEvent) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;    //endregion Window Listeners
&nbsp;
&nbsp;    /**
&nbsp;     * @return the frame this client is displayed in
&nbsp;     */
&nbsp;    public JFrame getFrame() {
<b class="nc">&nbsp;        return frame;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Shows a dialog where the player can select the entity types
&nbsp;     * used in the LOS tool.
&nbsp;     */
&nbsp;    private void showLOSSettingDialog() {
<b class="nc">&nbsp;        GUIPreferences gp = GUIPreferences.getInstance();</b>
<b class="nc">&nbsp;        LOSDialog ld = new LOSDialog(frame, gp.getMechInFirst(), gp.getMechInSecond());</b>
<b class="nc">&nbsp;        ld.setVisible(true);</b>
<b class="nc">&nbsp;        gp.setMechInFirst(ld.getMechInFirst());</b>
<b class="nc">&nbsp;        gp.setMechInSecond(ld.getMechInSecond());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Loads a preview image of the unit into the BufferedPanel.
&nbsp;     *
&nbsp;     * @param bp
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    public void loadPreviewImage(JLabel bp, Entity entity) {
<b class="nc">&nbsp;        IPlayer player = client.getGame().getPlayer(entity.getOwnerId());</b>
<b class="nc">&nbsp;        loadPreviewImage(bp, entity, player);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public void loadPreviewImage(JLabel bp, Entity entity, IPlayer player) {
<b class="nc">&nbsp;        final Camouflage camouflage = entity.getCamouflageOrElse(player.getCamouflage());</b>
<b class="nc">&nbsp;        Image icon = bv.getTilesetManager().loadPreviewImage(entity, camouflage, bp);</b>
<b class="nc">&nbsp;        bp.setIcon((icon == null) ? null : new ImageIcon(icon));</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Make a &quot;bing&quot; sound.
&nbsp;     */
&nbsp;    void bing() {
<b class="nc">&nbsp;        if (!GUIPreferences.getInstance().getSoundMute() &amp;&amp; (bingClip != null)) {</b>
<b class="nc">&nbsp;            bingClip.play();</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
<b class="nc">&nbsp;    private GameListener gameListener = new GameListenerAdapter() {</b>
&nbsp;        @Override
&nbsp;        public void gamePlayerChange(GamePlayerChangeEvent e){
<b class="nc">&nbsp;             if (playerListDialog != null) {</b>
<b class="nc">&nbsp;                 playerListDialog.refreshPlayerList();</b>
&nbsp;             }
&nbsp;
<b class="nc">&nbsp;             if ((curPanel instanceof ReportDisplay) &amp;&amp; !client.getLocalPlayer().isDone()) {</b>
<b class="nc">&nbsp;                 ((ReportDisplay) curPanel).resetReadyButton();</b>
&nbsp;             }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void gamePlayerDisconnected(GamePlayerDisconnectedEvent e) {
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(frame,</b>
<b class="nc">&nbsp;                Messages.getString(&quot;ClientGUI.Disconnected.message&quot;),</b>
<b class="nc">&nbsp;                Messages.getString(&quot;ClientGUI.Disconnected.title&quot;),</b>
&nbsp;                JOptionPane.ERROR_MESSAGE);
<b class="nc">&nbsp;            frame.setVisible(false);</b>
<b class="nc">&nbsp;            die();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void gamePlayerChat(GamePlayerChatEvent e) {
<b class="nc">&nbsp;            bing();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void gamePhaseChange(GamePhaseChangeEvent e) {
&nbsp;            // This is a really lame place for this, but I couldn&#39;t find a
&nbsp;            // better one without making massive changes (which didn&#39;t seem
&nbsp;            // worth it for one little feature).
<b class="nc">&nbsp;            if (bv.getLocalPlayer() != client.getLocalPlayer()) {</b>
&nbsp;                // The adress based comparison is somewhat important.
&nbsp;                //  Use of the /reset command can cause the player to get reset,
&nbsp;                //  and the equals function of Player isn&#39;t powerful enough.
<b class="nc">&nbsp;                bv.setLocalPlayer(client.getLocalPlayer());</b>
&nbsp;            }
&nbsp;            // Make sure the ChatterBox starts out deactived.
<b class="nc">&nbsp;            bv.setChatterBoxActive(false);            </b>
&nbsp;
&nbsp;            // Swap to this phase&#39;s panel.
<b class="nc">&nbsp;            switchPanel(getClient().getGame().getPhase());</b>
&nbsp;
<b class="nc">&nbsp;            menuBar.setPhase(getClient().getGame().getPhase());</b>
<b class="nc">&nbsp;            validate();</b>
<b class="nc">&nbsp;            cb.moveToEnd();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void gamePlayerConnected(GamePlayerConnectedEvent e) {
<b class="nc">&nbsp;            System.err.println(&quot;gamePlayerConnected&quot;);</b>
<b class="nc">&nbsp;            System.err.flush();</b>
<b class="nc">&nbsp;            if (curPanel instanceof ReportDisplay) {</b>
<b class="nc">&nbsp;                ((ReportDisplay) curPanel).resetReadyButton();</b>
<b class="nc">&nbsp;                System.err.println(&quot;resetReadyButton&quot;);</b>
<b class="nc">&nbsp;                System.err.flush();</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void gameReport(GameReportEvent e) {
&nbsp;            // Normally the Report Display is updated when the panel is
&nbsp;            // switched during a phase change.
&nbsp;            // This update is for reports that get sent at odd times,
&nbsp;            // currently Tactical Genius reroll requests and when
&nbsp;            // a player wishes to continue moving after a fall.
<b class="nc">&nbsp;            if (curPanel instanceof ReportDisplay) {</b>
&nbsp;                // Tactical Genius
<b class="nc">&nbsp;                ((ReportDisplay) curPanel).appendReportTab(getClient().phaseReport);</b>
<b class="nc">&nbsp;                ((ReportDisplay) curPanel).resetReadyButton();</b>
&nbsp;                // Check if the player deserves an active reroll button
&nbsp;                // (possible, if he gets one which he didn&#39;t use, and his
&nbsp;                // opponent got and used one) and if so activates it.
<b class="nc">&nbsp;                if (getClient().getGame().hasTacticalGenius(getClient().getLocalPlayer())) {</b>
<b class="nc">&nbsp;                    if (!((ReportDisplay) curPanel).hasRerolled()) {</b>
<b class="nc">&nbsp;                        ((ReportDisplay) curPanel).resetRerollButton();</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                // Show a popup to the players so that we know whats up!
<b class="nc">&nbsp;                if (!(getClient() instanceof TestBot)) {</b>
<b class="nc">&nbsp;                    doAlertDialog(&quot;Tactical Genius Report&quot;, e.getReport());</b>
&nbsp;                }
&nbsp;            } else {
&nbsp;                // Continued movement after getting up
<b class="nc">&nbsp;                if (!(getClient() instanceof TestBot)) {</b>
<b class="nc">&nbsp;                    doAlertDialog(&quot;Movement Report&quot;, e.getReport());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;
&nbsp;        @Override
&nbsp;        public void gameEnd(GameEndEvent e) {
<b class="nc">&nbsp;            bv.clearMovementData();</b>
<b class="nc">&nbsp;            bv.clearFieldofF();</b>
<b class="nc">&nbsp;            for (Client client2 : getBots().values()) {</b>
<b class="nc">&nbsp;                client2.die();</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            getBots().clear();</b>
&nbsp;
&nbsp;            // Make a list of the player&#39;s living units.
<b class="nc">&nbsp;            ArrayList&lt;Entity&gt; living = getClient().getGame().getPlayerEntities(getClient().getLocalPlayer(), false);</b>
&nbsp;
&nbsp;            // Be sure to include all units that have retreated.
<b class="nc">&nbsp;            for (Enumeration&lt;Entity&gt; iter = getClient().getGame().getRetreatedEntities(); iter.hasMoreElements(); ) {</b>
<b class="nc">&nbsp;                Entity ent = iter.nextElement();</b>
<b class="nc">&nbsp;                if (ent.getOwnerId() == getClient().getLocalPlayer().getId()) {</b>
<b class="nc">&nbsp;                    living.add(ent);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            // Allow players to save their living units to a file.
&nbsp;            // Don&#39;t bother asking if none survived.
<b class="nc">&nbsp;            if (!living.isEmpty() &amp;&amp; doYesNoDialog(Messages.getString(&quot;ClientGUI.SaveUnitsDialog.title&quot;), //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    Messages.getString(&quot;ClientGUI.SaveUnitsDialog.message&quot;))) { //$NON-NLS-1$</b>
&nbsp;
&nbsp;                // Allow the player to save the units to a file.
<b class="nc">&nbsp;                saveVictoryList();</b>
&nbsp;            } // End user-wants-a-MUL
&nbsp;
&nbsp;            // save all destroyed units in a separate &quot;salvage MUL&quot;
<b class="nc">&nbsp;            ArrayList&lt;Entity&gt; destroyed = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            Enumeration&lt;Entity&gt; graveyard = getClient().getGame().getGraveyardEntities();</b>
<b class="nc">&nbsp;            while (graveyard.hasMoreElements()) {</b>
<b class="nc">&nbsp;                Entity entity = graveyard.nextElement();</b>
<b class="nc">&nbsp;                if (entity.isSalvage()) {</b>
<b class="nc">&nbsp;                    destroyed.add(entity);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (destroyed.size() &gt; 0) {</b>
<b class="nc">&nbsp;                String sLogDir = PreferenceManager.getClientPreferences().getLogDirectory();</b>
<b class="nc">&nbsp;                File logDir = new File(sLogDir);</b>
<b class="nc">&nbsp;                if (!logDir.exists()) {</b>
<b class="nc">&nbsp;                    logDir.mkdir();</b>
&nbsp;                }
<b class="nc">&nbsp;                String fileName = &quot;salvage.mul&quot;;</b>
<b class="nc">&nbsp;                if (PreferenceManager.getClientPreferences().stampFilenames()) {</b>
<b class="nc">&nbsp;                    fileName = StringUtil.addDateTimeStamp(fileName);</b>
&nbsp;                }
<b class="nc">&nbsp;                File unitFile = new File(sLogDir + File.separator + fileName);</b>
&nbsp;                try {
&nbsp;                    // Save the destroyed entities to the file.
<b class="nc">&nbsp;                    EntityListFile.saveTo(unitFile, destroyed);</b>
<b class="nc">&nbsp;                } catch (IOException ex) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(ex);</b>
<b class="nc">&nbsp;                    doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), ex.getMessage());</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void gameSettingsChange(GameSettingsChangeEvent e) {
<b class="nc">&nbsp;            if ((gameOptionsDialog != null) &amp;&amp; gameOptionsDialog.isVisible() &amp;&amp;</b>
<b class="nc">&nbsp;                    !e.isMapSettingsOnlyChange()) {</b>
<b class="nc">&nbsp;                gameOptionsDialog.update(getClient().getGame().getOptions());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (curPanel instanceof ChatLounge) {</b>
<b class="nc">&nbsp;                ChatLounge cl = (ChatLounge) curPanel;</b>
<b class="nc">&nbsp;                cl.updateMapSettings(getClient().getMapSettings());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void gameMapQuery(GameMapQueryEvent e) {
&nbsp;
<b class="nc">&nbsp;        }</b>
&nbsp;        
&nbsp;        @Override
&nbsp;        public void gameClientFeedbackRequest(GameCFREvent evt) {
<b class="nc">&nbsp;            Entity e = client.getGame().getEntity(evt.getEntityId());</b>
&nbsp;            Object result;
<b class="nc">&nbsp;            switch (evt.getCFRType()){</b>
&nbsp;                case Packet.COMMAND_CFR_DOMINO_EFFECT:                    
&nbsp;                    // If the client connects to a game as a bot, it&#39;s possible
&nbsp;                    // to have the bot respond AND have the client ask the
&nbsp;                    // player. This is bad, ignore this if the client is a bot
<b class="nc">&nbsp;                    if (client instanceof BotClient){</b>
&nbsp;                        return;
&nbsp;                    }
<b class="nc">&nbsp;                    MovePath stepForward = new MovePath(client.getGame(), e);</b>
<b class="nc">&nbsp;                    MovePath stepBackward = new MovePath(client.getGame(), e);</b>
<b class="nc">&nbsp;                    stepForward.addStep(MoveStepType.FORWARDS);</b>
<b class="nc">&nbsp;                    stepBackward.addStep(MoveStepType.BACKWARDS);</b>
<b class="nc">&nbsp;                    stepForward.compile(client.getGame(), e, false);</b>
<b class="nc">&nbsp;                    stepBackward.compile(client.getGame(), e, false);</b>
&nbsp;                    
<b class="nc">&nbsp;                    String title = Messages.getString(&quot;CFRDomino.Title&quot;);</b>
<b class="nc">&nbsp;                    String msg = Messages.getString(&quot;CFRDomino.Message&quot;, e.getDisplayName());</b>
&nbsp;                    int choice;
&nbsp;                    Object[] options;
&nbsp;                    MovePath[] paths;
&nbsp;                    int optionType;
<b class="nc">&nbsp;                    if (stepForward.isMoveLegal() </b>
<b class="nc">&nbsp;                            &amp;&amp; stepBackward.isMoveLegal()){</b>
<b class="nc">&nbsp;                        options = new Object[3];</b>
<b class="nc">&nbsp;                        paths = new MovePath[3];</b>
<b class="nc">&nbsp;                        options[0] = Messages.getString(&quot;CFRDomino.Forward&quot;, stepForward.getMpUsed());</b>
<b class="nc">&nbsp;                        options[1] = Messages.getString(&quot;CFRDomino.Backward&quot;, stepForward.getMpUsed());</b>
<b class="nc">&nbsp;                        options[2] = Messages.getString(&quot;CFRDomino.NoAction&quot;);</b>
<b class="nc">&nbsp;                        paths[0] = stepForward;</b>
<b class="nc">&nbsp;                        paths[1] = stepBackward;</b>
<b class="nc">&nbsp;                        paths[2] = null;</b>
<b class="nc">&nbsp;                        optionType = JOptionPane.YES_NO_CANCEL_OPTION;</b>
<b class="nc">&nbsp;                    } else if (stepForward.isMoveLegal()){</b>
<b class="nc">&nbsp;                        options = new Object[2];</b>
<b class="nc">&nbsp;                        paths = new MovePath[2];</b>
<b class="nc">&nbsp;                        options[0] = Messages.getString(&quot;CFRDomino.Forward&quot;,</b>
<b class="nc">&nbsp;                                new Object[] { stepForward.getMpUsed() });</b>
<b class="nc">&nbsp;                        options[1] = Messages.getString(&quot;CFRDomino.NoAction&quot;);</b>
<b class="nc">&nbsp;                        paths[0] = stepForward;</b>
<b class="nc">&nbsp;                        paths[1] = null;</b>
<b class="nc">&nbsp;                        optionType = JOptionPane.YES_NO_OPTION;</b>
&nbsp;                    } else { // No request is sent if both moves are illegal
<b class="nc">&nbsp;                        options = new Object[2];</b>
<b class="nc">&nbsp;                        paths = new MovePath[2];</b>
<b class="nc">&nbsp;                        options[0] = Messages.getString(&quot;CFRDomino.Backward&quot;,</b>
<b class="nc">&nbsp;                                new Object[] { stepForward.getMpUsed() });</b>
<b class="nc">&nbsp;                        options[1] = Messages.getString(&quot;CFRDomino.NoAction&quot;);</b>
<b class="nc">&nbsp;                        paths[0] = stepBackward;</b>
<b class="nc">&nbsp;                        paths[1] = null;</b>
<b class="nc">&nbsp;                        optionType = JOptionPane.YES_NO_OPTION;</b>
&nbsp;                    }            
<b class="nc">&nbsp;                    choice = JOptionPane.showOptionDialog(frame, msg, title, </b>
&nbsp;                            optionType, JOptionPane.QUESTION_MESSAGE, null, 
&nbsp;                            options, options[0]);
&nbsp;                    // If they closed it, assume no action
<b class="nc">&nbsp;                    if (choice == JOptionPane.CLOSED_OPTION){</b>
<b class="nc">&nbsp;                        choice = options.length - 1;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    client.sendDominoCFRResponse(paths[choice]);</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case Packet.COMMAND_CFR_AMS_ASSIGN:
<b class="nc">&nbsp;                    ArrayList&lt;String&gt; amsOptions = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                    amsOptions.add(&quot;None&quot;);</b>
<b class="nc">&nbsp;                    for (WeaponAttackAction waa : evt.getWAAs()) {</b>
<b class="nc">&nbsp;                        Entity ae = waa.getEntity(client.getGame());</b>
&nbsp;                        String waaMsg;
<b class="nc">&nbsp;                        if (ae != null) {</b>
<b class="nc">&nbsp;                            Mounted weapon = ae.getEquipment(waa.getWeaponId());</b>
<b class="nc">&nbsp;                            waaMsg = weapon.getDesc() + &quot; from &quot;</b>
<b class="nc">&nbsp;                                    + ae.getDisplayName();</b>
<b class="nc">&nbsp;                        } else {</b>
<b class="nc">&nbsp;                            waaMsg = &quot;Missiles from unknown attacker&quot;;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        amsOptions.add(waaMsg);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                    
<b class="nc">&nbsp;                    optionType = JOptionPane.OK_CANCEL_OPTION;</b>
<b class="nc">&nbsp;                    title = Messages.getString(&quot;CFRAMSAssign.Title&quot;,</b>
<b class="nc">&nbsp;                            new Object[] { e.getDisplayName() });</b>
<b class="nc">&nbsp;                    msg = Messages.getString(&quot;CFRAMSAssign.Message&quot;,</b>
<b class="nc">&nbsp;                            new Object[] { e.getDisplayName() });</b>
<b class="nc">&nbsp;                    result = JOptionPane.showInputDialog(frame, msg, title,</b>
&nbsp;                            JOptionPane.QUESTION_MESSAGE, null, 
<b class="nc">&nbsp;                           amsOptions.toArray(), null);</b>
&nbsp;                    // If they closed it, assume no action
<b class="nc">&nbsp;                    if ((result == null) || result.equals(&quot;None&quot;)) {</b>
<b class="nc">&nbsp;                        client.sendAMSAssignCFRResponse(null);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        client.sendAMSAssignCFRResponse(</b>
<b class="nc">&nbsp;                                amsOptions.indexOf(result) - 1);                 </b>
&nbsp;                    }
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case Packet.COMMAND_CFR_APDS_ASSIGN:
<b class="nc">&nbsp;                    ArrayList&lt;String&gt; apdsOptions = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                    apdsOptions.add(&quot;None&quot;);</b>
<b class="nc">&nbsp;                    Iterator&lt;Integer&gt; distIt = evt.getApdsDists().iterator();</b>
<b class="nc">&nbsp;                    for (WeaponAttackAction waa : evt.getWAAs()) {</b>
<b class="nc">&nbsp;                        Entity ae = waa.getEntity(client.getGame());</b>
<b class="nc">&nbsp;                        int dist = distIt.next();</b>
&nbsp;                        String waaMsg;
<b class="nc">&nbsp;                        if (ae != null) {</b>
<b class="nc">&nbsp;                            Mounted weapon = ae.getEquipment(waa.getWeaponId());</b>
<b class="nc">&nbsp;                            waaMsg = weapon.getDesc() + &quot; from &quot;</b>
<b class="nc">&nbsp;                                    + ae.getDisplayName() + &quot; (distance: &quot;</b>
&nbsp;                                    + dist + &quot;)&quot;;
<b class="nc">&nbsp;                        } else {</b>
<b class="nc">&nbsp;                            waaMsg = &quot;Missiles from unknown attacker&quot;;</b>
&nbsp;                        }
<b class="nc">&nbsp;                        apdsOptions.add(waaMsg);</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;
<b class="nc">&nbsp;                    optionType = JOptionPane.OK_CANCEL_OPTION;</b>
<b class="nc">&nbsp;                    title = Messages.getString(&quot;CFRAPDSAssign.Title&quot;,</b>
<b class="nc">&nbsp;                            new Object[] { e.getDisplayName() });</b>
<b class="nc">&nbsp;                    msg = Messages.getString(&quot;CFRAPDSAssign.Message&quot;,</b>
<b class="nc">&nbsp;                            new Object[] { e.getDisplayName() });</b>
<b class="nc">&nbsp;                    result = JOptionPane.showInputDialog(frame, msg, title,</b>
&nbsp;                            JOptionPane.QUESTION_MESSAGE, null,
<b class="nc">&nbsp;                            apdsOptions.toArray(), null);</b>
&nbsp;                    // If they closed it, assume no action
<b class="nc">&nbsp;                    if ((result == null) || result.equals(&quot;None&quot;)) {</b>
<b class="nc">&nbsp;                        client.sendAPDSAssignCFRResponse(null);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        client.sendAPDSAssignCFRResponse(</b>
<b class="nc">&nbsp;                                apdsOptions.indexOf(result) - 1);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case Packet.COMMAND_CFR_HIDDEN_PBS:
<b class="nc">&nbsp;                    Entity attacker = client.getGame().getEntity(</b>
<b class="nc">&nbsp;                            evt.getEntityId());</b>
<b class="nc">&nbsp;                    Entity target = client.getGame().getEntity(</b>
<b class="nc">&nbsp;                            evt.getTargetId());</b>
&nbsp;                    // Are we not the client handling the PBS?
<b class="nc">&nbsp;                    if ((attacker == null) || (target == null)) {</b>
<b class="nc">&nbsp;                        if (curPanel instanceof StatusBarPhaseDisplay) {</b>
<b class="nc">&nbsp;                            ((StatusBarPhaseDisplay) curPanel)</b>
<b class="nc">&nbsp;                                    .setStatusBarText(Messages</b>
<b class="nc">&nbsp;                                            .getString(&quot;StatusBarPhaseDisplay.pointblankShot&quot;));</b>
&nbsp;                        }
&nbsp;                        return;
&nbsp;                    }
&nbsp;                    // If this is the client to handle the PBS, take care of it
<b class="nc">&nbsp;                    bv.centerOnHex(attacker.getPosition());</b>
<b class="nc">&nbsp;                    bv.highlight(attacker.getPosition());</b>
<b class="nc">&nbsp;                    bv.select(target.getPosition());</b>
<b class="nc">&nbsp;                    bv.cursor(target.getPosition());</b>
<b class="nc">&nbsp;                    msg = Messages.getString(&quot;ClientGUI.PointBlankShot.Message&quot;,</b>
<b class="nc">&nbsp;                            target.getShortName(), attacker.getShortName());</b>
<b class="nc">&nbsp;                    title = Messages.getString(&quot;ClientGUI.PointBlankShot.Title&quot;);</b>
&nbsp;                    // Ask whether the player wants to take a PBS or not
<b class="nc">&nbsp;                    int pbsChoice = JOptionPane.showConfirmDialog(frame, msg,</b>
&nbsp;                            title, JOptionPane.YES_NO_OPTION,
&nbsp;                            JOptionPane.QUESTION_MESSAGE);
&nbsp;                    // Process the PBS - switch to PointblankShotDisplay
<b class="nc">&nbsp;                    if (pbsChoice == JOptionPane.YES_OPTION) {</b>
&nbsp;                        // Send a non-null response to indicate PBS is accepted
&nbsp;                        // This allows the servers to notify the clients,
&nbsp;                        // as they may be in for a wait
<b class="nc">&nbsp;                        client.sendHiddenPBSCFRResponse(new Vector&lt;&gt;());</b>
&nbsp;                        // Used to indicate it&#39;s this player&#39;s turn
<b class="nc">&nbsp;                        setPointblankEID(evt.getEntityId());</b>
&nbsp;                        // Switch to the right display
<b class="nc">&nbsp;                        switchPanel(IGame.Phase.PHASE_POINTBLANK_SHOT);</b>
<b class="nc">&nbsp;                        PointblankShotDisplay curDisp = ((PointblankShotDisplay) curPanel);</b>
&nbsp;                        // Set targeting info
<b class="nc">&nbsp;                        curDisp.beginMyTurn();</b>
<b class="nc">&nbsp;                        curDisp.selectEntity(evt.getEntityId());</b>
<b class="nc">&nbsp;                        curDisp.target(target);</b>
<b class="nc">&nbsp;                        bv.select(target.getPosition());</b>
<b class="nc">&nbsp;                    } else { // PBS declined</b>
<b class="nc">&nbsp;                        client.sendHiddenPBSCFRResponse(null);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    break;</b>
&nbsp;                case Packet.COMMAND_CFR_TELEGUIDED_TARGET:
<b class="nc">&nbsp;                    List&lt;Integer&gt; targetIds = evt.getTelemissileTargetIds();</b>
<b class="nc">&nbsp;                    List&lt;Integer&gt; toHitValues = evt.getTmToHitValues();</b>
<b class="nc">&nbsp;                    List&lt;String&gt; targetDescriptions = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                    for (int i = 0; i &lt; targetIds.size(); i++) {</b>
<b class="nc">&nbsp;                        int id = targetIds.get(i);</b>
<b class="nc">&nbsp;                        int th = toHitValues.get(i);</b>
<b class="nc">&nbsp;                        Entity tgt = client.getGame().getEntity(id);</b>
<b class="nc">&nbsp;                        if (tgt != null) {</b>
<b class="nc">&nbsp;                            targetDescriptions.add(String.format(Messages.getString(&quot;TeleMissileTargetDialog.target&quot;), tgt.getDisplayName(), th));</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                    //Set up the selection pane
<b class="nc">&nbsp;                    String i18nString = &quot;TeleMissileTargetDialog.message&quot;; //$NON-NLS-1$;</b>
<b class="nc">&nbsp;                    msg = Messages.getString(i18nString);</b>
<b class="nc">&nbsp;                    i18nString = &quot;TeleMissileTargetDialog.title&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    title = Messages.getString(i18nString);</b>
<b class="nc">&nbsp;                    String input = (String) JOptionPane.showInputDialog(frame, msg,</b>
&nbsp;                            title, JOptionPane.QUESTION_MESSAGE, null,
<b class="nc">&nbsp;                            targetDescriptions.toArray(), targetDescriptions.get(0));</b>
<b class="nc">&nbsp;                    if (input != null) {</b>
<b class="nc">&nbsp;                        for (int i = 0; i &lt; targetDescriptions.size(); i++) {</b>
<b class="nc">&nbsp;                            if (input.equals(targetDescriptions.get(i))) {</b>
<b class="nc">&nbsp;                                client.sendTelemissileTargetCFRResponse(i);</b>
<b class="nc">&nbsp;                                break;</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    } else {
&nbsp;                        //If input IS null, as in the case of pressing the close or cancel buttons...
&nbsp;                        //Just pick the first target in the list, or server will be left waiting indefinitely.
<b class="nc">&nbsp;                        client.sendTelemissileTargetCFRResponse(0);</b>
&nbsp;                    }
&nbsp;                case Packet.COMMAND_CFR_TAG_TARGET:
<b class="nc">&nbsp;                    List&lt;Integer&gt; TAGTargets = evt.getTAGTargets();</b>
<b class="nc">&nbsp;                    List&lt;Integer&gt; TAGTargetTypes = evt.getTAGTargetTypes();</b>
<b class="nc">&nbsp;                    List&lt;String&gt; TAGTargetDescriptions = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                    for (int i = 0; i &lt; TAGTargets.size(); i++) {</b>
<b class="nc">&nbsp;                        int id = TAGTargets.get(i);</b>
<b class="nc">&nbsp;                        int nType = TAGTargetTypes.get(i);</b>
<b class="nc">&nbsp;                        Targetable tgt = client.getGame().getTarget(nType, id);</b>
<b class="nc">&nbsp;                        if (tgt != null) {</b>
<b class="nc">&nbsp;                            TAGTargetDescriptions.add(tgt.getDisplayName());</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                    //Set up the selection pane
<b class="nc">&nbsp;                    i18nString = &quot;TAGTargetDialog.message&quot;; //$NON-NLS-1$;</b>
<b class="nc">&nbsp;                    msg = Messages.getString(i18nString);</b>
<b class="nc">&nbsp;                    i18nString = &quot;TAGTargetDialog.title&quot;; //$NON-NLS-1$</b>
<b class="nc">&nbsp;                    title = Messages.getString(i18nString);</b>
<b class="nc">&nbsp;                    input = (String) JOptionPane.showInputDialog(frame, msg,</b>
&nbsp;                            title, JOptionPane.QUESTION_MESSAGE, null,
<b class="nc">&nbsp;                            TAGTargetDescriptions.toArray(), TAGTargetDescriptions.get(0));</b>
<b class="nc">&nbsp;                    if (input != null) {</b>
<b class="nc">&nbsp;                        for (int i = 0; i &lt; TAGTargetDescriptions.size(); i++) {</b>
<b class="nc">&nbsp;                            if (input.equals(TAGTargetDescriptions.get(i))) {</b>
<b class="nc">&nbsp;                                client.sendTAGTargetCFRResponse(i);</b>
<b class="nc">&nbsp;                                break;</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    } else {
&nbsp;                        //If input IS null, as in the case of pressing the close or cancel buttons...
&nbsp;                        //Just pick the first target in the list, or server will be left waiting indefinitely.
<b class="nc">&nbsp;                        client.sendTAGTargetCFRResponse(0);</b>
&nbsp;                    }
&nbsp;            }
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    public Client getClient() {
<b class="nc">&nbsp;        return client;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Map&lt;String, Client&gt; getBots() {
<b class="nc">&nbsp;        return client.bots;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return Returns the selectedEntityNum.
&nbsp;     */
&nbsp;    public int getSelectedEntityNum() {
<b class="nc">&nbsp;        return selectedEntityNum;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param selectedEntityNum The selectedEntityNum to set.
&nbsp;     */
&nbsp;    public void setSelectedEntityNum(int selectedEntityNum) {
<b class="nc">&nbsp;        this.selectedEntityNum = selectedEntityNum;</b>
<b class="nc">&nbsp;        bv.selectEntity(client.getGame().getEntity(selectedEntityNum));</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public RandomArmyDialog getRandomArmyDialog() {
<b class="nc">&nbsp;        return randomArmyDialog;</b>
&nbsp;    }
&nbsp;
&nbsp;    public RandomSkillDialog getRandomSkillDialog() {
<b class="nc">&nbsp;        return randomSkillDialog;</b>
&nbsp;    }
&nbsp;
&nbsp;    public RandomNameDialog getRandomNameDialog() {
<b class="nc">&nbsp;        return new RandomNameDialog(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks to see if there is already a path and name stored; if not, calls
&nbsp;     * &quot;save as&quot;; otherwise, saves the board to the specified file.
&nbsp;     */
&nbsp;    private void boardSave() {
<b class="nc">&nbsp;        if (curfileBoard == null) {</b>
<b class="nc">&nbsp;            boardSaveAs();</b>
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
&nbsp;        // save!
<b class="nc">&nbsp;        try (OutputStream os = new FileOutputStream(curfileBoard)) {</b>
<b class="nc">&nbsp;            client.getGame().getBoard().save(os);</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            MegaMek.getLogger().error(&quot;Error opening file to save!&quot;, e);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Saves the board in PNG image format.
&nbsp;     */
&nbsp;    private void boardSaveImage(boolean ignoreUnits) {
<b class="nc">&nbsp;        if (curfileBoardImage == null) {</b>
<b class="nc">&nbsp;            boardSaveAsImage(ignoreUnits);</b>
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
<b class="nc">&nbsp;        JDialog waitD = new JDialog(frame, Messages.getString(&quot;BoardEditor.waitDialog.title&quot;));</b>
<b class="nc">&nbsp;        waitD.add(new JLabel(Messages.getString(&quot;BoardEditor.waitDialog.message&quot;)));</b>
<b class="nc">&nbsp;        waitD.setSize(250, 130);</b>
&nbsp;        // move to middle of screen
<b class="nc">&nbsp;        waitD.setLocation(</b>
<b class="nc">&nbsp;                (frame.getSize().width / 2) - (waitD.getSize().width / 2), (frame</b>
<b class="nc">&nbsp;                .getSize().height</b>
<b class="nc">&nbsp;                / 2) - (waitD.getSize().height / 2));</b>
<b class="nc">&nbsp;        waitD.setVisible(true);</b>
<b class="nc">&nbsp;        frame.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</b>
<b class="nc">&nbsp;        waitD.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</b>
&nbsp;        // save!
&nbsp;        try {
<b class="nc">&nbsp;            ImageIO.write(bv.getEntireBoardImage(ignoreUnits), &quot;png&quot;, curfileBoardImage);</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        waitD.setVisible(false);</b>
<b class="nc">&nbsp;        frame.setCursor(Cursor.getDefaultCursor());</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Opens a file dialog box to select a file to save as; saves the board to
&nbsp;     * the file.
&nbsp;     */
&nbsp;    private void boardSaveAs() {
<b class="nc">&nbsp;        JFileChooser fc = new JFileChooser(&quot;data&quot; + File.separator + &quot;boards&quot;);</b>
<b class="nc">&nbsp;        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</b>
<b class="nc">&nbsp;        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveBoardAs&quot;));</b>
<b class="nc">&nbsp;        fc.setFileFilter(new BoardFileFilter());</b>
<b class="nc">&nbsp;        int returnVal = fc.showSaveDialog(frame);</b>
<b class="nc">&nbsp;        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</b>
&nbsp;            // I want a file, y&#39;know!
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
<b class="nc">&nbsp;        curfileBoard = fc.getSelectedFile();</b>
&nbsp;
&nbsp;        // make sure the file ends in board
<b class="nc">&nbsp;        if (!curfileBoard.getName().toLowerCase(Locale.ENGLISH).endsWith(&quot;.board&quot;)) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                curfileBoard = new File(curfileBoard.getCanonicalPath() + &quot;.board&quot;);</b>
<b class="nc">&nbsp;            } catch (IOException ie) {</b>
&nbsp;                // failure!
<b class="nc">&nbsp;                return;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        boardSave();</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Opens a file dialog box to select a file to save as; saves the board to
&nbsp;     * the file as an image. Useful for printing boards.
&nbsp;     */
&nbsp;    private void boardSaveAsImage(boolean ignoreUnits) {
<b class="nc">&nbsp;        JFileChooser fc = new JFileChooser(&quot;.&quot;);</b>
<b class="nc">&nbsp;        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</b>
<b class="nc">&nbsp;        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveAsImage&quot;));</b>
<b class="nc">&nbsp;        fc.setFileFilter(new FileFilter() {</b>
&nbsp;            @Override
&nbsp;            public boolean accept(File dir) {
<b class="nc">&nbsp;                return (dir.getName().endsWith(&quot;.png&quot;) || dir.isDirectory());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public String getDescription() {
<b class="nc">&nbsp;                return &quot;.png&quot;;</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        int returnVal = fc.showSaveDialog(frame);</b>
<b class="nc">&nbsp;        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</b>
&nbsp;            // I want a file, y&#39;know!
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
<b class="nc">&nbsp;        curfileBoardImage = fc.getSelectedFile();</b>
&nbsp;
&nbsp;        // make sure the file ends in png
<b class="nc">&nbsp;        if (!curfileBoardImage.getName().toLowerCase(Locale.ENGLISH).endsWith(&quot;.png&quot;)) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                curfileBoardImage = new File(curfileBoardImage.getCanonicalPath() + &quot;.png&quot;);</b>
<b class="nc">&nbsp;            } catch (IOException ie) {</b>
&nbsp;                // failure!
<b class="nc">&nbsp;                return;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        boardSaveImage(ignoreUnits);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void hexMoused(BoardViewEvent b) {
<b class="nc">&nbsp;        if (b.getType() == BoardViewEvent.BOARD_HEX_POPUP) {</b>
<b class="nc">&nbsp;            showBoardPopup(b.getCoords());</b>
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void hexCursor(BoardViewEvent b) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void boardHexHighlighted(BoardViewEvent b) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void hexSelected(BoardViewEvent b) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void firstLOSHex(BoardViewEvent b) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void secondLOSHex(BoardViewEvent b, Coords c) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void finishedMovingUnits(BoardViewEvent b) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void unitSelected(BoardViewEvent b) {
&nbsp;        // ignored
<b class="nc">&nbsp;    }</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * Returns true if a dialog is visible on top of the &lt;code&gt;ClientGUI&lt;/code&gt;.
&nbsp;     * For example, the &lt;code&gt;MegaMekController&lt;/code&gt; should ignore hotkeys
&nbsp;     * if there is a dialog, like the &lt;code&gt;CommonSettingsDialog&lt;/code&gt;, open.
&nbsp;     * @return
&nbsp;     */
&nbsp;    public boolean shouldIgnoreHotKeys(){
<b class="nc">&nbsp;        return ignoreHotKeys </b>
<b class="nc">&nbsp;                || ((gameOptionsDialog != null) &amp;&amp; gameOptionsDialog.isVisible())</b>
<b class="nc">&nbsp;                || ((about != null) &amp;&amp; about.isVisible())</b>
<b class="nc">&nbsp;                || ((help != null) &amp;&amp; help.isVisible())</b>
<b class="nc">&nbsp;                || ((setdlg != null) &amp;&amp; setdlg.isVisible())</b>
<b class="nc">&nbsp;                || ((aw != null) &amp;&amp; aw.isVisible());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void componentHidden(ComponentEvent arg0) {
&nbsp;
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void componentMoved(ComponentEvent arg0) {
&nbsp;
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void componentResized(ComponentEvent arg0) {
<b class="nc">&nbsp;        bv.setPreferredSize(getSize());        </b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void componentShown(ComponentEvent arg0) {
&nbsp;
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    void replacePlayer() {
<b class="nc">&nbsp;        Set&lt;IPlayer&gt; ghostPlayers = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        for (IPlayer p : client.getGame().getPlayersVector()) {</b>
<b class="nc">&nbsp;            if (p.isGhost()) {</b>
<b class="nc">&nbsp;                ghostPlayers.add(p);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (ghostPlayers.isEmpty()) {</b>
<b class="nc">&nbsp;            JOptionPane.showMessageDialog(this, &quot;No ghost players to replace.&quot;, &quot;No Ghosts&quot;,</b>
&nbsp;                                          JOptionPane.INFORMATION_MESSAGE);
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        BotConfigDialog botConfigDialog = new BotConfigDialog(this.frame, ghostPlayers);</b>
<b class="nc">&nbsp;        botConfigDialog.setModal(true);</b>
<b class="nc">&nbsp;        botConfigDialog.setVisible(true);</b>
<b class="nc">&nbsp;        if (botConfigDialog.dialogAborted) {</b>
<b class="nc">&nbsp;            return;</b>
&nbsp;        }
<b class="nc">&nbsp;        AddBotUtil util = new AddBotUtil();</b>
<b class="nc">&nbsp;        BotClient botClient = botConfigDialog.getSelectedBot(client.getHost(), client.getPort());</b>
&nbsp;        String[] args;
<b class="nc">&nbsp;        Collection&lt;String&gt; playersToReplace = botConfigDialog.getPlayerToReplace();</b>
<b class="nc">&nbsp;        Collection&lt;String[]&gt; replaceCommands = new HashSet&lt;&gt;(playersToReplace.size());</b>
<b class="nc">&nbsp;        if (botClient instanceof Princess) {</b>
<b class="nc">&nbsp;            for (String player : playersToReplace) {</b>
<b class="nc">&nbsp;                args = new String[]{</b>
&nbsp;                        &quot;/replacePlayer&quot;,
&nbsp;                        &quot;-b:Princess&quot;,
<b class="nc">&nbsp;                        &quot;-c:&quot; + ((Princess) botClient).getBehaviorSettings().getDescription(),</b>
<b class="nc">&nbsp;                        &quot;-v:&quot; + ((Princess) botClient).getVerbosity(),</b>
&nbsp;                        &quot;-p:&quot; + player
&nbsp;                };
<b class="nc">&nbsp;                replaceCommands.add(args);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        } else {
<b class="nc">&nbsp;            for (String player : playersToReplace) {</b>
<b class="nc">&nbsp;                args = new String[]{</b>
&nbsp;                        &quot;/replacePlayer&quot;,
&nbsp;                        player
&nbsp;                };
<b class="nc">&nbsp;                replaceCommands.add(args);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        botClient.die();</b>
<b class="nc">&nbsp;        for (String[] cmd : replaceCommands) {</b>
<b class="nc">&nbsp;            util.addBot(cmd, client.getGame(), client.getHost(), client.getPort());</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;    }</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * Returns the panel for the current phase.  The ClientGUI is split into
&nbsp;     * the main panel (view) at the top, which takes up the majority of the view
&nbsp;     * and the the &quot;current panel&quot; which has different controls  based on the
&nbsp;     * phase.
&nbsp;     * 
&nbsp;     * @return
&nbsp;     */
&nbsp;    public JComponent getCurrentPanel() {
<b class="nc">&nbsp;        return curPanel;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isProcessingPointblankShot() {
<b class="nc">&nbsp;        return pointblankEID != Entity.NONE;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setPointblankEID(int eid) {
<b class="nc">&nbsp;        this.pointblankEID = eid;</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public int getPointblankEID() {
<b class="nc">&nbsp;        return pointblankEID;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
