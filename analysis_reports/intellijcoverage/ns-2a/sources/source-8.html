


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > TestBattleArmor</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.common.verifier</a>
</div>

<h1>Coverage Summary for Class: TestBattleArmor (megamek.common.verifier)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TestBattleArmor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/54)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/562)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TestBattleArmor$BAArmor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestBattleArmor$BAManipulator</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestBattleArmor$BAMotiveSystems</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/70)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/636)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek -
&nbsp; * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;
&nbsp;/*
&nbsp; * Author: Jay Lawson (Taharqa)
&nbsp; */
&nbsp;
&nbsp;package megamek.common.verifier;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Vector;
&nbsp;
&nbsp;import megamek.common.*;
&nbsp;import megamek.common.annotations.Nullable;
&nbsp;import megamek.common.util.StringUtil;
&nbsp;import megamek.common.weapons.infantry.InfantryWeapon;
&nbsp;
&nbsp;public class TestBattleArmor extends TestEntity {
&nbsp;
&nbsp;    /**
&nbsp;     * Keeps track of the number of free MP a Bipedal BA gets.
&nbsp;     */
<b class="nc">&nbsp;    public static int BIPED_FREE_MP = 1;</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Keeps track of the number of free MP a Quad BA gets.
&nbsp;     */
<b class="nc">&nbsp;    public static int QUAD_FREE_MP = 2;</b>
&nbsp;    
&nbsp;    /**
&nbsp;     * Base chassis weight by suit weight class for Inner Sphere suits
&nbsp;     */
<b class="nc">&nbsp;    public static double CHASSIS_WEIGHT_IS[] = { 0.08, 0.1, 0.175, 0.3, 0.55 };</b>
&nbsp;    /**
&nbsp;     * Base chassis weight by suit weight class for Clan suits
&nbsp;     */
<b class="nc">&nbsp;    public static double CHASSIS_WEIGHT_CLAN[] = { 0.13, 0.15, 0.25, 0.4, 0.7 };</b>
&nbsp;    /**
&nbsp;     * Weight for additional ground MP by suit weight class
&nbsp;     */
<b class="nc">&nbsp;    public static double ADDITIONAL_GROUND_MP_WEIGHT[] = { 0.025, 0.03, 0.04, 0.08, 0.16 };</b>
&nbsp;
&nbsp;    /**
&nbsp;     * BattleArmor can have a variable number of shots per slot of ammo, this
&nbsp;     * variable defines the maximum number of shots per slot they can have.
&nbsp;     */
<b class="nc">&nbsp;    public static int NUM_SHOTS_PER_CRIT = 4;</b>
&nbsp;
&nbsp;    /**
&nbsp;     * BA Tube Artillery gets to be special and has 8 shots per-crit and comes
&nbsp;     * in 2-shot clips.
&nbsp;     */
<b class="nc">&nbsp;    public static int NUM_SHOTS_PER_CRIT_TA = 8;</b>
&nbsp;
&nbsp;    /**
&nbsp;     * An enumeration that keeps track of the legal armors for BattleArmor. Each
&nbsp;     * entry consists of the type, which corresponds to the types defined in
&nbsp;     * &lt;code&gt;EquipmentType&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @author arlith
&nbsp;     *
&nbsp;     */
<b class="nc">&nbsp;    public static enum BAArmor {</b>
<b class="nc">&nbsp;        STANDARD(EquipmentType.T_ARMOR_BA_STANDARD,0,false),</b>
<b class="nc">&nbsp;        CLAN_STANDARD(EquipmentType.T_ARMOR_BA_STANDARD,0,true),</b>
<b class="nc">&nbsp;        STANDARD_PROTOTYPE(EquipmentType.T_ARMOR_BA_STANDARD_PROTOTYPE,4,false),</b>
<b class="nc">&nbsp;        STANDARD_ADVANCED(EquipmentType.T_ARMOR_BA_STANDARD_ADVANCED,5,false),</b>
<b class="nc">&nbsp;        STEALTH_BASIC(EquipmentType.T_ARMOR_BA_STEALTH_BASIC,3,false),</b>
<b class="nc">&nbsp;        CLAN_STEALTH_BASIC(EquipmentType.T_ARMOR_BA_STEALTH_BASIC,3,true),</b>
<b class="nc">&nbsp;        STEALTH(EquipmentType.T_ARMOR_BA_STEALTH,4,false),</b>
<b class="nc">&nbsp;        CLAN_STEALTH(EquipmentType.T_ARMOR_BA_STEALTH,4,true),</b>
<b class="nc">&nbsp;        STEALTH_IMPROVED(EquipmentType.T_ARMOR_BA_STEALTH_IMP,5,false),</b>
<b class="nc">&nbsp;        CLAN_STEALTH_IMPROVED(EquipmentType.T_ARMOR_BA_STEALTH_IMP,5,true),</b>
<b class="nc">&nbsp;        STEALTH_PROTOTYPE(EquipmentType.T_ARMOR_BA_STEALTH_PROTOTYPE,4,false),</b>
<b class="nc">&nbsp;        FIRE_RESISTANT(EquipmentType.T_ARMOR_BA_FIRE_RESIST,5,false),</b>
<b class="nc">&nbsp;        CLAN_FIRE_RESISTANT(EquipmentType.T_ARMOR_BA_FIRE_RESIST,5,true),</b>
<b class="nc">&nbsp;        MIMETIC(EquipmentType.T_ARMOR_BA_MIMETIC,7,false),</b>
<b class="nc">&nbsp;        CLAN_MIMETIC(EquipmentType.T_ARMOR_BA_MIMETIC,7,true),</b>
<b class="nc">&nbsp;        REFLECTIVE(EquipmentType.T_ARMOR_BA_REFLECTIVE,7,false),</b>
<b class="nc">&nbsp;        CLAN_REFLECTIVE(EquipmentType.T_ARMOR_BA_REFLECTIVE,7,true),</b>
<b class="nc">&nbsp;        REACTIVE(EquipmentType.T_ARMOR_BA_REACTIVE,7,false),</b>
<b class="nc">&nbsp;        CLAN_REACTIVE(EquipmentType.T_ARMOR_BA_REACTIVE,7,true);</b>
&nbsp;
&nbsp;        /**
&nbsp;         * The type, corresponding to types defined in
&nbsp;         * &lt;code&gt;EquipmentType&lt;/code&gt;.
&nbsp;         */
&nbsp;        public int type;
&nbsp;
&nbsp;        /**
&nbsp;         * The number of spaces occupied by the armor type.
&nbsp;         */
&nbsp;        public int space;
&nbsp;
&nbsp;        /**
&nbsp;         * Denotes whether this armor is Clan or not.
&nbsp;         */
&nbsp;        public boolean isClan;
&nbsp;
<b class="nc">&nbsp;        BAArmor(int t, int s, boolean c) {</b>
<b class="nc">&nbsp;            type = t;</b>
<b class="nc">&nbsp;            space = s;</b>
<b class="nc">&nbsp;            isClan = c;</b>
&nbsp;        }
&nbsp;
&nbsp;        public static int getNumBAArmors() {
<b class="nc">&nbsp;            return values().length;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Given an armor type, return the &lt;code&gt;BAArmor&lt;/code&gt; instance that
&nbsp;         * represents that type.
&nbsp;         *
&nbsp;         * @param t
&nbsp;         *            The armor type.
&nbsp;         * @param c
&nbsp;         *            Whether this armor type is Clan or not.
&nbsp;         * @return The &lt;code&gt;BAArmor&lt;/code&gt; that correspondes to the given type
&nbsp;         *         or null if no match was found.
&nbsp;         */
&nbsp;        public static BAArmor getArmor(int t, boolean c) {
<b class="nc">&nbsp;            for (BAArmor a : values()) {</b>
<b class="nc">&nbsp;                if ((a.type == t) &amp;&amp; (a.isClan == c)) {</b>
<b class="nc">&nbsp;                    return a;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;        
&nbsp;        /**
&nbsp;         * @return The &lt;code&gt;MiscType&lt;/code&gt; for this armor.
&nbsp;         */
&nbsp;        public EquipmentType getArmorEqType() {
<b class="nc">&nbsp;            String name = EquipmentType.getArmorTypeName(type, isClan);</b>
<b class="nc">&nbsp;            return EquipmentType.get(name);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Filters all ba armor according to given tech constraints
&nbsp;     * 
&nbsp;     * @param techManager
&nbsp;     * @return A list of all armors that meet the tech constraints
&nbsp;     */
&nbsp;    public static List&lt;EquipmentType&gt; legalArmorsFor(ITechManager techManager) {
<b class="nc">&nbsp;        List&lt;EquipmentType&gt; retVal = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (BAArmor armor : BAArmor.values()) {</b>
<b class="nc">&nbsp;            final EquipmentType eq = armor.getArmorEqType();</b>
<b class="nc">&nbsp;            if ((null != eq) &amp;&amp; techManager.isLegal(eq)) {</b>
<b class="nc">&nbsp;                retVal.add(eq);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * An enumeration that keeps track of the legal manipulators for
&nbsp;     * BattleArmor.
&nbsp;     *
&nbsp;     * @author arlith
&nbsp;     *
&nbsp;     */
<b class="nc">&nbsp;    public static enum BAManipulator {</b>
<b class="nc">&nbsp;        NONE(BattleArmor.MANIPULATOR_NONE,false),</b>
<b class="nc">&nbsp;        ARMORED_GLOVE(BattleArmor.MANIPULATOR_ARMORED_GLOVE,false),</b>
<b class="nc">&nbsp;        BASIC(BattleArmor.MANIPULATOR_BASIC,false),</b>
<b class="nc">&nbsp;        BASIC_MINE_CLEARANCE(BattleArmor.MANIPULATOR_BASIC_MINE_CLEARANCE,true),</b>
<b class="nc">&nbsp;        BATTLE(BattleArmor.MANIPULATOR_BATTLE,false),</b>
<b class="nc">&nbsp;        BATTLE_MAGNET(BattleArmor.MANIPULATOR_BATTLE_MAGNET,true),</b>
<b class="nc">&nbsp;        BATTLE_VIBRO(BattleArmor.MANIPULATOR_BATTLE_VIBRO,false),</b>
<b class="nc">&nbsp;        CARGO_LIFTER(BattleArmor.MANIPULATOR_CARGO_LIFTER,true),</b>
<b class="nc">&nbsp;        HEAVY_BATTLE(BattleArmor.MANIPULATOR_HEAVY_BATTLE,false),</b>
<b class="nc">&nbsp;        HEAVY_BATTLE_MAGNET(BattleArmor.MANIPULATOR_HEAVY_BATTLE_MAGNET,true),</b>
<b class="nc">&nbsp;        HEAVY_BATTLE_VIBRO(BattleArmor.MANIPULATOR_HEAVY_BATTLE_VIBRO,false),</b>
<b class="nc">&nbsp;        SALVAGE_ARM(BattleArmor.MANIPULATOR_SALVAGE_ARM,false),</b>
<b class="nc">&nbsp;        DRILL(BattleArmor.MANIPULATOR_INDUSTRIAL_DRILL,false);</b>
&nbsp;
&nbsp;        /**
&nbsp;         * The type, corresponding to types defined in
&nbsp;         * &lt;code&gt;EquipmentType&lt;/code&gt;.
&nbsp;         */
&nbsp;        public int type;
&nbsp;
&nbsp;        /**
&nbsp;         * The name of this manipulator
&nbsp;         */
&nbsp;        public String internalName;
&nbsp;
&nbsp;        public String displayName;
&nbsp;
&nbsp;        /**
&nbsp;         * Denotes whether this armor is Clan or not.
&nbsp;         */
&nbsp;        public boolean pairMounted;
&nbsp;
<b class="nc">&nbsp;        BAManipulator(int t, boolean p) {</b>
<b class="nc">&nbsp;            type = t;</b>
<b class="nc">&nbsp;            internalName = BattleArmor.MANIPULATOR_TYPE_STRINGS[t];</b>
<b class="nc">&nbsp;            displayName = BattleArmor.MANIPULATOR_NAME_STRINGS[t];</b>
<b class="nc">&nbsp;            pairMounted = p;</b>
&nbsp;        }
&nbsp;
&nbsp;        public static int getNumBAArmors() {
<b class="nc">&nbsp;            return values().length;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Given an manipulator internal name, return the
&nbsp;         * &lt;code&gt;BAManipulator&lt;/code&gt; instance that represents that internal
&nbsp;         * name.
&nbsp;         *
&nbsp;         * @param name
&nbsp;         *            The internal name.
&nbsp;         * @return The &lt;code&gt;BAManipulator&lt;/code&gt; that correspondes to the given
&nbsp;         *         internal name or null if no match was found.
&nbsp;         */
&nbsp;        public static BAManipulator getManipulator(String name) {
<b class="nc">&nbsp;            for (BAManipulator m : values()) {</b>
<b class="nc">&nbsp;                if (m.internalName.equals(name) || m.displayName.equals(name)) {</b>
<b class="nc">&nbsp;                    return m;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public enum BAMotiveSystems {</b>
<b class="nc">&nbsp;        BA_JUMP (EquipmentTypeLookup.BA_JUMP_JET, EntityMovementMode.INF_JUMP, new int[] { 25, 25, 50, 125, 250 }),</b>
<b class="nc">&nbsp;        BA_VTOL (EquipmentTypeLookup.BA_VTOL, EntityMovementMode.VTOL, new int[] { 30, 40, 60 }),</b>
<b class="nc">&nbsp;        BA_UMU (EquipmentTypeLookup.BA_UMU, EntityMovementMode.INF_UMU, new int[] { 45, 45, 85, 160, 250});</b>
&nbsp;
&nbsp;        private final String internalName;
&nbsp;        private final EntityMovementMode mode;
&nbsp;        private final int[] weightsKg;
&nbsp;        
<b class="nc">&nbsp;        BAMotiveSystems(String internalName, EntityMovementMode mode, int[] weights) {</b>
<b class="nc">&nbsp;            this.internalName = internalName;</b>
<b class="nc">&nbsp;            this.mode = mode;</b>
<b class="nc">&nbsp;            this.weightsKg = weights;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public String getName() {
<b class="nc">&nbsp;            return internalName;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public EntityMovementMode getMovementMode() {
<b class="nc">&nbsp;            return mode;</b>
&nbsp;        }
&nbsp;
&nbsp;        public static List&lt;EquipmentType&gt; allSystems() {
<b class="nc">&nbsp;            List&lt;EquipmentType&gt; retVal = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (BAMotiveSystems ms : values()) {</b>
<b class="nc">&nbsp;                retVal.add(EquipmentType.get(ms.internalName));</b>
&nbsp;            }
<b class="nc">&nbsp;            return retVal;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public static EquipmentType getEquipment(EntityMovementMode mode) {
<b class="nc">&nbsp;            for (BAMotiveSystems ms : values()) {</b>
<b class="nc">&nbsp;                if (ms.getMovementMode() == mode) {</b>
<b class="nc">&nbsp;                    return EquipmentType.get(ms.internalName);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;        
&nbsp;        /**
&nbsp;         * @param weightClass The EntityWeightClass index for the suit
&nbsp;         * @return            The mass of the motive system per MP
&nbsp;         * @throws IndexOutOfBoundsException if the weight class is not in the range allowed by the suit 
&nbsp;         */
&nbsp;        public double getWeight(int weightClass) {
<b class="nc">&nbsp;        	return weightsKg[weightClass] / 1000.0;</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Checks to see if the supplied &lt;code&gt;Mounted&lt;/code&gt; is valid to be mounted
&nbsp;     * in the given location on the supplied &lt;code&gt;BattleArmor&lt;/code&gt;.
&nbsp;     *
&nbsp;     * This method will check that there is available space in the given
&nbsp;     * location make sure that weapon mounting restrictions hold.
&nbsp;     *
&nbsp;     * @param ba
&nbsp;     * @param newMount
&nbsp;     * @param loc
&nbsp;     * @return
&nbsp;     */
&nbsp;    public static boolean isMountLegal(BattleArmor ba, Mounted newMount, int loc) {
<b class="nc">&nbsp;        return isMountLegal(ba, newMount, loc, BattleArmor.LOC_SQUAD);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks to see if the supplied &lt;code&gt;Mounted&lt;/code&gt; is valid to be mounted
&nbsp;     * in the given location on the supplied &lt;code&gt;BattleArmor&lt;/code&gt; for the
&nbsp;     * specified suit in the squad.
&nbsp;     *
&nbsp;     * This method will check that there is available space in the given
&nbsp;     * location make sure that weapon mounting restrictions hold.
&nbsp;     *
&nbsp;     * @param ba
&nbsp;     * @param newMount
&nbsp;     * @param loc
&nbsp;     * @param trooper
&nbsp;     * @return
&nbsp;     */
&nbsp;    public static boolean isMountLegal(BattleArmor ba, Mounted newMount,
&nbsp;            int loc, int trooper) {
<b class="nc">&nbsp;        int numUsedCrits = 0;</b>
<b class="nc">&nbsp;        int numAntiMechWeapons = 0;</b>
<b class="nc">&nbsp;        int numAntiPersonnelWeapons = 0;</b>
<b class="nc">&nbsp;        if ((ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD)</b>
&nbsp;                &amp;&amp; ((loc == BattleArmor.MOUNT_LOC_LARM) || (loc == BattleArmor.MOUNT_LOC_RARM))) {
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((loc == BattleArmor.MOUNT_LOC_TURRET) &amp;&amp; (ba.getTurretCapacity() == 0)) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Mounted m : ba.getEquipment()) {</b>
&nbsp;            // Manipulators don&#39;t take up slots in BA
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_BA_MANIPULATOR)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
&nbsp;            // AP weapons don&#39;t take up slots in BA (the AP Mount does)
<b class="nc">&nbsp;            if (m.getType().hasFlag(WeaponType.F_INFANTRY)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if (m.getBaMountLoc() == loc </b>
<b class="nc">&nbsp;                    &amp;&amp; (m.getLocation() == trooper </b>
<b class="nc">&nbsp;                        || m.getLocation() == BattleArmor.LOC_SQUAD)) {</b>
&nbsp;                
<b class="nc">&nbsp;                if ((m.getType() instanceof WeaponType) </b>
<b class="nc">&nbsp;                        &amp;&amp; !(m.getType() instanceof InfantryWeapon)) {</b>
<b class="nc">&nbsp;                    numAntiMechWeapons++;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (m.getType().hasFlag(MiscType.F_AP_MOUNT)) {</b>
<b class="nc">&nbsp;                    numAntiPersonnelWeapons++;</b>
&nbsp;                }             
<b class="nc">&nbsp;                if (m.getType().isSpreadable()) {</b>
<b class="nc">&nbsp;                    numUsedCrits++;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    numUsedCrits += m.getCriticals();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        
&nbsp;        // In the case of quads with turrets, we need to apply the total of body + turret to the limitation
<b class="nc">&nbsp;        if ((loc == BattleArmor.MOUNT_LOC_TURRET)</b>
&nbsp;                || ((loc == BattleArmor.MOUNT_LOC_BODY)
<b class="nc">&nbsp;                        &amp;&amp; (ba.getTurretCapacity() &gt; 0))) {</b>
<b class="nc">&nbsp;            int otherLoc = (loc == BattleArmor.MOUNT_LOC_BODY)?</b>
<b class="nc">&nbsp;                    BattleArmor.MOUNT_LOC_TURRET : BattleArmor.MOUNT_LOC_BODY;</b>
<b class="nc">&nbsp;            for (Mounted m : ba.getEquipment()) {</b>
<b class="nc">&nbsp;                if (m.getBaMountLoc() == otherLoc </b>
<b class="nc">&nbsp;                        &amp;&amp; (m.getLocation() == trooper </b>
<b class="nc">&nbsp;                            || m.getLocation() == BattleArmor.LOC_SQUAD)) {</b>
&nbsp;                    
<b class="nc">&nbsp;                    if ((m.getType() instanceof WeaponType) </b>
<b class="nc">&nbsp;                            &amp;&amp; !(m.getType() instanceof InfantryWeapon)) {</b>
<b class="nc">&nbsp;                        numAntiMechWeapons++;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (m.getType().hasFlag(MiscType.F_AP_MOUNT)) {</b>
<b class="nc">&nbsp;                        numAntiPersonnelWeapons++;</b>
&nbsp;                    }             
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
&nbsp;        // Do we have free space to mount this equipment?
&nbsp;        int newCrits;
<b class="nc">&nbsp;        if (newMount.getType().isSpreadable()) {</b>
<b class="nc">&nbsp;            newCrits = 1;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            newCrits = newMount.getCriticals();</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((numUsedCrits + newCrits) &lt;= ba.getNumCrits(loc)) {</b>
&nbsp;            // Weapons require extra criticism
<b class="nc">&nbsp;            if (newMount.getType() instanceof WeaponType) {</b>
<b class="nc">&nbsp;                if ((numAntiMechWeapons + 1) &lt;= </b>
<b class="nc">&nbsp;                        ba.getNumAllowedAntiMechWeapons(loc)) {</b>
<b class="nc">&nbsp;                    return true;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return false;</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (newMount.getType().hasFlag(MiscType.F_AP_MOUNT)) {</b>
<b class="nc">&nbsp;                if ((numAntiPersonnelWeapons + 1) &lt;= </b>
<b class="nc">&nbsp;                        ba.getNumAllowedAntiPersonnelWeapons(loc,trooper)) {</b>
<b class="nc">&nbsp;                    return true;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return false;</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    public static int maxWalkMP(BattleArmor ba) {
<b class="nc">&nbsp;        int max = 3;</b>
<b class="nc">&nbsp;        if (ba.getWeightClass() &gt;= EntityWeightClass.WEIGHT_HEAVY) {</b>
<b class="nc">&nbsp;            max--;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD) {</b>
<b class="nc">&nbsp;            max += 2;</b>
&nbsp;        }
<b class="nc">&nbsp;        return max;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public static int maxJumpMP(BattleArmor ba) {
<b class="nc">&nbsp;        if (ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD) {</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return maxWalkMP(ba);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    public static int maxVtolMP(BattleArmor ba) {
<b class="nc">&nbsp;        if ((ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD)</b>
<b class="nc">&nbsp;                || (ba.getWeightClass() &gt; EntityWeightClass.WEIGHT_MEDIUM)) {</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return 7 - ba.getWeightClass() + EntityWeightClass.WEIGHT_ULTRA_LIGHT;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    public static int maxUmuMP(BattleArmor ba) {
<b class="nc">&nbsp;        if (ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD) {</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return Math.min(5, 5 - ba.getWeightClass() + EntityWeightClass.WEIGHT_LIGHT);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private BattleArmor ba;
&nbsp;
&nbsp;    public TestBattleArmor(BattleArmor armor, TestEntityOption option,
&nbsp;            String fileString) {
<b class="nc">&nbsp;        super(option, null, null, null);</b>
<b class="nc">&nbsp;        ba = armor;</b>
<b class="nc">&nbsp;        this.fileString = fileString;</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public Entity getEntity() {
<b class="nc">&nbsp;        return ba;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isTank() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isMech() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isAero() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    public boolean isSmallCraft() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    public boolean isAdvancedAerospace() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    public boolean isProtomech() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightControls() {
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return The weight of the turret mount, or zero if there isn&#39;t one.
&nbsp;     */
&nbsp;    public double getWeightTurret() {
<b class="nc">&nbsp;        int turret = ba.getTurretCapacity();</b>
<b class="nc">&nbsp;        if (turret &gt; 0) {</b>
<b class="nc">&nbsp;            double weight = turret * 0.01 + 0.03;</b>
<b class="nc">&nbsp;            if (ba.hasModularTurretMount()) {</b>
&nbsp;                // modular turret has the same base weight as a standard turret with one more slot,
&nbsp;                // plus another 10 kg for being modular
<b class="nc">&nbsp;                weight += 0.02;</b>
&nbsp;            }
<b class="nc">&nbsp;            return weight;</b>
&nbsp;        }
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightMisc() {
<b class="nc">&nbsp;    	return getWeightTurret();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightHeatSinks() {
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightEngine() {
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public double getWeightChassis() {
<b class="nc">&nbsp;    	if (ba.isClan()</b>
<b class="nc">&nbsp;    			&amp;&amp; !((ba.getWeightClass() &gt; EntityWeightClass.WEIGHT_ULTRA_LIGHT)</b>
<b class="nc">&nbsp;    					&amp;&amp; (ba.isClanExoWithoutHarjel()))) {</b>
<b class="nc">&nbsp;    		return CHASSIS_WEIGHT_CLAN[ba.getWeightClass()];</b>
&nbsp;    	} else {
<b class="nc">&nbsp;    		return CHASSIS_WEIGHT_IS[ba.getWeightClass()];</b>
&nbsp;    	}
&nbsp;    }
&nbsp;    
&nbsp;    public double getWeightGroundMP() {
<b class="nc">&nbsp;        int walkMP = ba.getOriginalWalkMP();</b>
<b class="nc">&nbsp;        if (ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD) {</b>
<b class="nc">&nbsp;            walkMP -= QUAD_FREE_MP;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            walkMP -= BIPED_FREE_MP;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (walkMP &gt; 0) {</b>
<b class="nc">&nbsp;        	return ADDITIONAL_GROUND_MP_WEIGHT[ba.getWeightClass()] * walkMP;</b>
&nbsp;        } else {
<b class="nc">&nbsp;        	return 0;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    public double getWeightSecondaryMotiveSystem() {
<b class="nc">&nbsp;    	int jumpMP = ba.getOriginalJumpMP();</b>
<b class="nc">&nbsp;    	if (ba.getMovementMode() == EntityMovementMode.VTOL) {</b>
<b class="nc">&nbsp;    		return jumpMP * BAMotiveSystems.BA_VTOL.getWeight(ba.getWeightClass());</b>
<b class="nc">&nbsp;    	} else if (ba.getMovementMode() == EntityMovementMode.INF_UMU) {</b>
<b class="nc">&nbsp;    		return jumpMP * BAMotiveSystems.BA_UMU.getWeight(ba.getWeightClass());</b>
&nbsp;    	} else {
<b class="nc">&nbsp;    		return jumpMP * BAMotiveSystems.BA_JUMP.getWeight(ba.getWeightClass());</b>
&nbsp;    	}
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightStructure() {
<b class="nc">&nbsp;    	return getWeightChassis() + getWeightGroundMP() + getWeightSecondaryMotiveSystem();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightArmor() {
<b class="nc">&nbsp;        return ba.getOArmor(1)</b>
<b class="nc">&nbsp;                * EquipmentType.getBaArmorWeightPerPoint(ba.getArmorType(1),</b>
<b class="nc">&nbsp;                        TechConstants.isClan(ba.getArmorTechLevel(1)));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean hasDoubleHeatSinks() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int getCountHeatSinks() {
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeight() {
<b class="nc">&nbsp;        return ba.getTrooperWeight() * ba.getTroopers();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printWeightMisc() {
<b class="nc">&nbsp;        return &quot;&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printWeightControls() {
<b class="nc">&nbsp;        return &quot;&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printWeightStructure() {
<b class="nc">&nbsp;        return StringUtil.makeLength(&quot;Structure: &quot;, getPrintSize() + 9)</b>
<b class="nc">&nbsp;                + TestEntity.makeWeightString(getWeightStructure(), true) + &quot;\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printWeightArmor() {
<b class="nc">&nbsp;        String armorName = EquipmentType.getArmorTypeName(ba</b>
<b class="nc">&nbsp;                .getArmorType(BattleArmor.LOC_SQUAD), TechConstants.isClan(ba</b>
<b class="nc">&nbsp;                .getArmorTechLevel(BattleArmor.LOC_SQUAD)));</b>
&nbsp;
<b class="nc">&nbsp;        return StringUtil.makeLength(</b>
<b class="nc">&nbsp;                &quot;Armor: &quot; + Integer.toString(getTotalOArmor()) + &quot; &quot;</b>
<b class="nc">&nbsp;                        + armorName, getPrintSize() - 5)</b>
<b class="nc">&nbsp;                + TestEntity.makeWeightString(getWeightArmor(), true) + &quot;\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printArmorPlacement() {
<b class="nc">&nbsp;        StringBuffer buff = new StringBuffer();</b>
<b class="nc">&nbsp;        buff.append(&quot;Armor Placement:\n&quot;);</b>
<b class="nc">&nbsp;        for (int loc = 1; loc &lt; getEntity().locations(); loc++) {</b>
<b class="nc">&nbsp;            buff.append(printArmorLocation(loc)).append(&quot;\n&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return buff.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printArmorLocation(int loc) {
<b class="nc">&nbsp;        return StringUtil</b>
<b class="nc">&nbsp;                .makeLength(getEntity().getLocationAbbr(loc) + &quot;:&quot;, 10)</b>
<b class="nc">&nbsp;                + StringUtil.makeLength(getEntity().getOInternal(loc), 4)</b>
<b class="nc">&nbsp;                + StringUtil.makeLength(getEntity().getOArmor(loc), 6) + &quot;  &quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks to see if this unit has valid armor assignment.
&nbsp;     *
&nbsp;     * @param buff
&nbsp;     * @return
&nbsp;     */
&nbsp;    public boolean correctArmor(StringBuffer buff) {
<b class="nc">&nbsp;        boolean correct = true;</b>
<b class="nc">&nbsp;        int maxArmorPoints = ba.getMaximumArmorPoints();</b>
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; ba.locations(); loc++) {</b>
<b class="nc">&nbsp;            if (ba.getOArmor(loc) &gt; maxArmorPoints) {</b>
<b class="nc">&nbsp;                buff.append(printArmorLocation(loc))</b>
<b class="nc">&nbsp;                        .append(printArmorLocProp(loc, maxArmorPoints))</b>
<b class="nc">&nbsp;                        .append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return correct;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printArmorLocProp(int loc, int wert) {
<b class="nc">&nbsp;        return &quot; is greater than &quot; + Integer.toString(wert) + &quot;!&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean correctMovement(StringBuffer buff) {
<b class="nc">&nbsp;        if (ba.getOriginalWalkMP() &gt; ba.getMaximumWalkMP()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Walk MP is &quot; + ba.getOriginalWalkMP()</b>
<b class="nc">&nbsp;                    + &quot; but maximum is &quot; + ba.getMaximumWalkMP() + &quot;!&quot;);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ba.getOriginalJumpMP() &gt; ba.getMaximumJumpMP()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Jump MP is &quot; + ba.getOriginalWalkMP()</b>
<b class="nc">&nbsp;                    + &quot; but maximum is &quot; + ba.getMaximumWalkMP() + &quot;!&quot;);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ba.hasWorkingMisc(MiscType.F_JUMP_BOOSTER)</b>
<b class="nc">&nbsp;                &amp;&amp; ((ba.getMovementMode() != EntityMovementMode.INF_JUMP) || (ba</b>
<b class="nc">&nbsp;                        .getJumpMP() &lt; 1))) {</b>
<b class="nc">&nbsp;            buff.append(&quot;BattleArmor with jump boosters &quot;</b>
&nbsp;                    + &quot;must have jump jets with a least 1MP!&quot;);
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ba.hasWorkingMisc(MiscType.F_PARTIAL_WING)</b>
<b class="nc">&nbsp;                &amp;&amp; ((ba.getMovementMode() != EntityMovementMode.INF_JUMP) || (ba</b>
<b class="nc">&nbsp;                        .getJumpMP() &lt; 1))) {</b>
<b class="nc">&nbsp;            buff.append(&quot;BattleArmor with a partial wing &quot;</b>
&nbsp;                    + &quot;must have jump jets with a least 1MP!&quot;);
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ba.hasWorkingMisc(MiscType.F_JUMP_BOOSTER)</b>
<b class="nc">&nbsp;                &amp;&amp; ba.hasWorkingMisc(MiscType.F_PARTIAL_WING)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;BattleArmor may not mount a jump booster &quot;</b>
&nbsp;                    + &quot;and a partial wing!&quot;);
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ba.hasWorkingMisc(MiscType.F_MECHANICAL_JUMP_BOOSTER)</b>
<b class="nc">&nbsp;                &amp;&amp; ba.hasMyomerBooster()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;BattleArmor may not mount a mechanical jump booster &quot;</b>
&nbsp;                    + &quot;and a myomer booster!&quot;);
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ba.hasMyomerBooster()</b>
<b class="nc">&nbsp;                &amp;&amp; (ba.getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_MIMETIC)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;BattleArmor may not mount a myomer booster &quot;</b>
&nbsp;                    + &quot;and mimetic armor!&quot;);
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ba.hasMyomerBooster()</b>
<b class="nc">&nbsp;                &amp;&amp; ((ba.getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_STEALTH)</b>
<b class="nc">&nbsp;                        || (ba.getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_STEALTH_BASIC)</b>
<b class="nc">&nbsp;                        || (ba.getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_STEALTH_IMP) || (ba</b>
<b class="nc">&nbsp;                        .getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_STEALTH_PROTOTYPE))) {</b>
<b class="nc">&nbsp;            buff.append(&quot;BattleArmor may not mount a myomer booster &quot;</b>
&nbsp;                    + &quot;and stealth armor!&quot;);
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (ba.countWorkingMisc(MiscType.F_MECHANICAL_JUMP_BOOSTER) &gt; 1) {</b>
<b class="nc">&nbsp;            buff.append(&quot;BattleArmor may only mount 1 &quot;</b>
&nbsp;                    + &quot;mechanical jump booster!&quot;);
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        EquipmentType boosterType = EquipmentType.get(EquipmentTypeLookup.BA_MYOMER_BOOSTER);</b>
<b class="nc">&nbsp;        if (ba.countWorkingMisc(MiscType.F_MASC) &gt; boosterType.getCriticals(ba)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;BattleArmor may only mount 1 &quot; + &quot;myomer booster!&quot;);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean correctCriticals(StringBuffer buff) {
<b class="nc">&nbsp;        Vector&lt;Mounted&gt; unallocated = new Vector&lt;Mounted&gt;();</b>
<b class="nc">&nbsp;        getUnallocatedEquipment(ba, unallocated);</b>
<b class="nc">&nbsp;        boolean correct = true;</b>
&nbsp;
<b class="nc">&nbsp;        if (!unallocated.isEmpty()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Unallocated Equipment:\n&quot;);</b>
<b class="nc">&nbsp;            for (Mounted mount : unallocated) {</b>
<b class="nc">&nbsp;                buff.append(mount.getType().getInternalName()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int critsUsed[][] = new int[ba.getTroopers() + 1]</b>
&nbsp;                [BattleArmor.MOUNT_NUM_LOCS];
<b class="nc">&nbsp;        int numAPWeapons[][] = new int[ba.getTroopers() + 1]</b>
&nbsp;                [BattleArmor.MOUNT_NUM_LOCS];
<b class="nc">&nbsp;        int numAMWeapons[][] = new int[ba.getTroopers() + 1]</b>
&nbsp;                [BattleArmor.MOUNT_NUM_LOCS];
<b class="nc">&nbsp;        int numSSWMs = 0;</b>
<b class="nc">&nbsp;        int numGloveMountedAPWeapons = 0;</b>
<b class="nc">&nbsp;        Mounted squadSupportWeapon = null;</b>
&nbsp;        // Count used crits, AM/AP weaps for each squad member and location
<b class="nc">&nbsp;        for (Mounted m : ba.getEquipment()) {</b>
&nbsp;            // BA Tasers should be mounted individually
<b class="nc">&nbsp;            if (m.getType().hasFlag(WeaponType.F_TASER)</b>
<b class="nc">&nbsp;                    &amp;&amp; m.getLocation() == BattleArmor.LOC_SQUAD){</b>
<b class="nc">&nbsp;                buff.append(&quot;BA Tasers should be mounted individually &quot; +</b>
&nbsp;                        &quot;instead of as a squad weapon!&quot;);
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
&nbsp;            
&nbsp;            // BA NARC should be mounted individually
<b class="nc">&nbsp;            if ((m.getType() instanceof WeaponType)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((WeaponType)m.getType()).getAmmoType() </b>
&nbsp;                        == AmmoType.T_NARC
<b class="nc">&nbsp;                    &amp;&amp; m.getLocation() == BattleArmor.LOC_SQUAD){</b>
<b class="nc">&nbsp;                buff.append(&quot;BA NARC should be mounted individually &quot; +</b>
&nbsp;                        &quot;instead of as a squad weapon!&quot;);
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
&nbsp;            
&nbsp;            // Ignore unmounted equipment, we&#39;ll deal with that elsewhere
<b class="nc">&nbsp;            if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
&nbsp;            int critSize;
<b class="nc">&nbsp;            if (m.getType().isSpreadable()) {</b>
<b class="nc">&nbsp;                critSize = 1;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                critSize = m.getCriticals();</b>
&nbsp;            }
&nbsp;            
&nbsp;            // Manipulators don&#39;t take up slots in BA
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_BA_MANIPULATOR)) {</b>
<b class="nc">&nbsp;                critSize = 0;</b>
&nbsp;            }
&nbsp;
&nbsp;            // AP Weapons that are mounted in an AP Mount don&#39;t take up slots
<b class="nc">&nbsp;            if (m.isAPMMounted() &amp;&amp; (m.getLinkedBy() != null)</b>
<b class="nc">&nbsp;                    &amp;&amp; m.getLinkedBy().getType().hasFlag(MiscType.F_AP_MOUNT)) {</b>
<b class="nc">&nbsp;                critSize = 0;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if ((m.getType() instanceof WeaponType) </b>
<b class="nc">&nbsp;                    &amp;&amp; m.isSquadSupportWeapon()) {</b>
<b class="nc">&nbsp;                numSSWMs++;</b>
<b class="nc">&nbsp;                squadSupportWeapon = m;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Check for valid BA weapon
<b class="nc">&nbsp;            if ((m.getType() instanceof WeaponType)</b>
<b class="nc">&nbsp;                    &amp;&amp; !m.getType().hasFlag(WeaponType.F_BA_WEAPON)</b>
<b class="nc">&nbsp;                    &amp;&amp; !m.getType().hasFlag(WeaponType.F_INFANTRY)) {</b>
<b class="nc">&nbsp;                buff.append(m.getName() + &quot; is not a BattleArmor weapon!\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Special considerations for AP weapons
<b class="nc">&nbsp;            if ((m.getType() instanceof WeaponType) </b>
<b class="nc">&nbsp;                    &amp;&amp; m.getType().hasFlag(WeaponType.F_INFANTRY)) {</b>
<b class="nc">&nbsp;                Mounted link = m.getLinkedBy();</b>
<b class="nc">&nbsp;                if (link == null) {</b>
<b class="nc">&nbsp;                    correct = false;</b>
<b class="nc">&nbsp;                    buff.append(m.getName() + &quot; is an infantry weapon but &quot; +</b>
&nbsp;                            &quot;has no mount point!\n&quot;);
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // No AP melee weapons
<b class="nc">&nbsp;                if (m.getType().hasFlag(WeaponType.F_INF_POINT_BLANK)) {</b>
<b class="nc">&nbsp;                    buff.append(m.getName() + &quot; is a melee AP weapon and &quot; +</b>
&nbsp;                            &quot;BattleArmor cannot mount melee AP weapons!\n&quot;);
<b class="nc">&nbsp;                    correct = false;   </b>
&nbsp;                }
&nbsp;                // Special considerations for AP mounts
<b class="nc">&nbsp;                if (link.getType().hasFlag(MiscType.F_AP_MOUNT)) {</b>
<b class="nc">&nbsp;                    if (m.getType().hasFlag(WeaponType.F_INF_SUPPORT)) {</b>
<b class="nc">&nbsp;                        buff.append(m.getName() + &quot; is a support weapon and &quot; +</b>
&nbsp;                            &quot;BattleArmor AP mounts cannot mount &quot; +
&nbsp;                            &quot;support weapons!\n&quot;);
<b class="nc">&nbsp;                        correct = false; </b>
&nbsp;                    }
&nbsp;                // Special considerations for armored gloves
<b class="nc">&nbsp;                } else if (link.getType().hasFlag(MiscType.F_ARMORED_GLOVE)) {</b>
<b class="nc">&nbsp;                    if (m.getType().hasFlag(WeaponType.F_INF_SUPPORT)){</b>
<b class="nc">&nbsp;                        if ((m.getType() instanceof InfantryWeapon)) {</b>
<b class="nc">&nbsp;                            int crew = ((InfantryWeapon)m.getType()).getCrew();</b>
<b class="nc">&nbsp;                            if (crew &gt; 1) {</b>
<b class="nc">&nbsp;                                buff.append(m.getName()</b>
&nbsp;                                        + &quot; has a crew size of &quot; + crew
&nbsp;                                        + &quot; but size can be no greater &quot;
&nbsp;                                        + &quot;than 1E!\n&quot;);
<b class="nc">&nbsp;                                correct = false;</b>
&nbsp;                            }
<b class="nc">&nbsp;                        } else if (!(m.getType() instanceof InfantryWeapon)) {</b>
<b class="nc">&nbsp;                            buff.append(m.getName() + &quot; has the INF_SUPPORT &quot; +</b>
&nbsp;                                    &quot;flag but is not an InfantryWeapon!\n&quot;);
<b class="nc">&nbsp;                            correct = false;   </b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // Check for valid BA equipment
<b class="nc">&nbsp;            if ((m.getType() instanceof MiscType)</b>
<b class="nc">&nbsp;                    &amp;&amp; !m.getType().hasFlag(MiscType.F_BA_EQUIPMENT)) {</b>
<b class="nc">&nbsp;                buff.append(m.getName() + &quot; is not BattleArmor equipment!\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (m.getType() instanceof AmmoType) {</b>
&nbsp;                final int maxShots;
<b class="nc">&nbsp;                if (((AmmoType) m.getType()).getAmmoType() != AmmoType.T_BA_TUBE) {</b>
<b class="nc">&nbsp;                    maxShots = NUM_SHOTS_PER_CRIT;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    maxShots = NUM_SHOTS_PER_CRIT_TA;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (m.getBaseShotsLeft() &gt; maxShots) {</b>
<b class="nc">&nbsp;                    buff.append(m.getName()).append(&quot; has &quot;).append(m.getBaseShotsLeft())</b>
<b class="nc">&nbsp;                        .append(&quot; shots, but BattleArmor may only have at most &quot;)</b>
<b class="nc">&nbsp;                        .append(maxShots).append(&quot; shots per slot.\n&quot;);</b>
<b class="nc">&nbsp;                    correct = false;</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // Ensure that jump boosters are mounted in the body
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_JUMP_BOOSTER)</b>
<b class="nc">&nbsp;                    &amp;&amp; (m.getBaMountLoc() != BattleArmor.MOUNT_LOC_BODY)) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Jump Boosters must be mounted in the body!\n&quot;);</b>
&nbsp;            }
&nbsp;
&nbsp;            // Ensure partial wing are mounted in the body
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_PARTIAL_WING)</b>
<b class="nc">&nbsp;                    &amp;&amp; (m.getBaMountLoc() != BattleArmor.MOUNT_LOC_BODY)) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Partial wing must be mounted in the body!\n&quot;);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (m.getLocation() != BattleArmor.LOC_SQUAD) {</b>
<b class="nc">&nbsp;                critsUsed[m.getLocation()][m.getBaMountLoc()] += critSize;</b>
<b class="nc">&nbsp;                if ((m.getType() instanceof WeaponType)){</b>
<b class="nc">&nbsp;                    numAMWeapons[m.getLocation()][m.getBaMountLoc()]++;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (m.getType().hasFlag(MiscType.F_AP_MOUNT)){</b>
<b class="nc">&nbsp;                    numAPWeapons[m.getLocation()][m.getBaMountLoc()]++;</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                for (int t = 0; t &lt;= ba.getTroopers(); t++) {</b>
<b class="nc">&nbsp;                    critsUsed[t][m.getBaMountLoc()] += critSize;</b>
<b class="nc">&nbsp;                    if ((m.getType() instanceof WeaponType) </b>
<b class="nc">&nbsp;                            &amp;&amp; !(m.getType() instanceof InfantryWeapon)) {</b>
<b class="nc">&nbsp;                        numAMWeapons[t][m.getBaMountLoc()]++;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (m.getType().hasFlag(MiscType.F_AP_MOUNT)) {</b>
<b class="nc">&nbsp;                        numAPWeapons[t][m.getBaMountLoc()]++;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;                        
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_ARMORED_GLOVE)) {</b>
<b class="nc">&nbsp;                if ((m.getLinked() != null) </b>
<b class="nc">&nbsp;                        &amp;&amp; (m.getLinked().getType() instanceof InfantryWeapon)) {</b>
<b class="nc">&nbsp;                    numGloveMountedAPWeapons++;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        
<b class="nc">&nbsp;        if (numSSWMs &gt; 1){</b>
<b class="nc">&nbsp;            buff.append(&quot;Squad has &quot; + numSSWMs + &quot; squad support &quot; +</b>
&nbsp;                    &quot;weapon mounts, but only 1 is allowed!\n&quot;);
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (numSSWMs &gt; 0 </b>
<b class="nc">&nbsp;                &amp;&amp; ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD){</b>
<b class="nc">&nbsp;            buff.append(&quot;Quad BattleArmor cannot use squad support &quot; +</b>
&nbsp;                    &quot;weapon mounts!\n&quot;);
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (numGloveMountedAPWeapons &gt; 1) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Batle Armor with armored gloves may only mount 1 &quot; +</b>
&nbsp;                    &quot;additional AP weapon, but &quot; + numGloveMountedAPWeapons 
&nbsp;                    + &quot; are mounted!\n&quot;);
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (squadSupportWeapon != null){</b>
<b class="nc">&nbsp;            WeaponType sswType = (WeaponType)squadSupportWeapon.getType();</b>
<b class="nc">&nbsp;            for (Mounted ammo : ba.getAmmo()){</b>
<b class="nc">&nbsp;                if (ammo.isSquadSupportWeapon() &amp;&amp; </b>
<b class="nc">&nbsp;                        !AmmoType.isAmmoValid(ammo, sswType)){</b>
<b class="nc">&nbsp;                    buff.append(ammo.getName() + &quot; is squad support weapon &quot; +</b>
&nbsp;                            &quot;mounted, but it is not a legal ammo type for &quot; +
&nbsp;                            &quot;the squad support weapon!\n&quot;);
<b class="nc">&nbsp;                    correct = false;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
&nbsp;        // Turret-mounted weapons on quad BA count against the body weapon limits
<b class="nc">&nbsp;        for (int t = 0; t &lt; ba.locations(); t++) {</b>
<b class="nc">&nbsp;            numAMWeapons[t][BattleArmor.MOUNT_LOC_BODY] += numAMWeapons[t][BattleArmor.MOUNT_LOC_TURRET];</b>
<b class="nc">&nbsp;            numAPWeapons[t][BattleArmor.MOUNT_LOC_BODY] += numAPWeapons[t][BattleArmor.MOUNT_LOC_TURRET];</b>
&nbsp;        }
&nbsp;
&nbsp;        // Now check to make sure the counts are valid
<b class="nc">&nbsp;        for (int t = 0; t &lt;= ba.getTroopers(); t++) {</b>
<b class="nc">&nbsp;            for (int loc = 0; loc &lt; BattleArmor.MOUNT_NUM_LOCS; loc++) {</b>
<b class="nc">&nbsp;                if (critsUsed[t][loc] &gt; ba.getNumCrits(loc)) {</b>
<b class="nc">&nbsp;                    buff.append(BattleArmor.getBaMountLocAbbr(loc) + &quot; of &quot;</b>
<b class="nc">&nbsp;                            + ba.getLocationAbbr(t) + &quot; has &quot;</b>
&nbsp;                            + critsUsed[t][loc]
&nbsp;                            + &quot; used criticals, but only has &quot;
<b class="nc">&nbsp;                            + ba.getNumCrits(loc) + &quot; available criticsl!\n&quot;);</b>
<b class="nc">&nbsp;                    correct = false;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (BattleArmor.MOUNT_LOC_TURRET == loc) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (numAMWeapons[t][loc] &gt; </b>
<b class="nc">&nbsp;                        ba.getNumAllowedAntiMechWeapons(loc)) {</b>
<b class="nc">&nbsp;                    buff.append(BattleArmor.getBaMountLocAbbr(loc) + &quot; of &quot;</b>
<b class="nc">&nbsp;                            + ba.getLocationAbbr(t) + &quot; has &quot;</b>
&nbsp;                            + numAMWeapons[t][loc]
&nbsp;                            + &quot; anti-mech weapons, but only &quot;
<b class="nc">&nbsp;                            + ba.getNumAllowedAntiMechWeapons(loc)</b>
&nbsp;                            + &quot; are allowed!\n&quot;);
<b class="nc">&nbsp;                    correct = false;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (numAPWeapons[t][loc] &gt; ba</b>
<b class="nc">&nbsp;                        .getNumAllowedAntiPersonnelWeapons(loc, t)) {</b>
<b class="nc">&nbsp;                    buff.append(BattleArmor.getBaMountLocAbbr(loc) + &quot; of &quot;</b>
<b class="nc">&nbsp;                            + ba.getLocationAbbr(t) + &quot; has &quot;</b>
&nbsp;                            + numAPWeapons[t][loc]
&nbsp;                            + &quot; anti-personnel weapons, but only &quot;
<b class="nc">&nbsp;                            + ba.getNumAllowedAntiPersonnelWeapons(loc, t)</b>
&nbsp;                            + &quot; are allowed!\n&quot;);
<b class="nc">&nbsp;                    correct = false;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return correct;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void getUnallocatedEquipment(Entity entity,
&nbsp;            Vector&lt;Mounted&gt; unallocated) {
<b class="nc">&nbsp;        for (Mounted m : entity.getEquipment()) {</b>
<b class="nc">&nbsp;            if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE) {</b>
&nbsp;                // OS-launcher ammo doesn&#39;t take up a slot
<b class="nc">&nbsp;                if ((m.getType() instanceof AmmoType)</b>
<b class="nc">&nbsp;                        &amp;&amp; (m.getLinkedBy() != null)</b>
<b class="nc">&nbsp;                        &amp;&amp; m.getLinkedBy().getType()</b>
<b class="nc">&nbsp;                                .hasFlag(WeaponType.F_ONESHOT)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // Equipment taking up no slots doesn&#39;t need to be mounted
<b class="nc">&nbsp;                if ((m.getCriticals() == 0)</b>
<b class="nc">&nbsp;                        &amp;&amp; !((m.getType() instanceof InfantryWeapon) </b>
<b class="nc">&nbsp;                                &amp;&amp; !m.isAPMMounted())) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // Weapons mounted in a DWP don&#39;t get assigned a location
<b class="nc">&nbsp;                if (((m.getLinked() != null) &amp;&amp; m.getLinked().getType()</b>
<b class="nc">&nbsp;                        .hasFlag(MiscType.F_DETACHABLE_WEAPON_PACK))</b>
<b class="nc">&nbsp;                        || ((m.getLinkedBy() != null) &amp;&amp; m.getLinkedBy()</b>
<b class="nc">&nbsp;                                .getType()</b>
<b class="nc">&nbsp;                                .hasFlag(MiscType.F_DETACHABLE_WEAPON_PACK))) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                
&nbsp;                // Ammo mounted in a DWP doesn&#39;t get assigned a location
<b class="nc">&nbsp;                if ((m.getType() instanceof AmmoType) </b>
<b class="nc">&nbsp;                        &amp;&amp; (m.getLinkedBy() != null) </b>
<b class="nc">&nbsp;                        &amp;&amp; m.getLinkedBy().isDWPMounted() ) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // Anything else is unassigned equipment
<b class="nc">&nbsp;                unallocated.addElement(m);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public boolean correctManipulators(StringBuffer buff) {
<b class="nc">&nbsp;        boolean correct = true;</b>
<b class="nc">&nbsp;        int numLAManipulators = 0;</b>
<b class="nc">&nbsp;        int numRAManipulators = 0;</b>
<b class="nc">&nbsp;        BAManipulator laManipType = BAManipulator.NONE;</b>
<b class="nc">&nbsp;        BAManipulator raManipType = BAManipulator.NONE;</b>
<b class="nc">&nbsp;        for (Mounted m : ba.getEquipment()) {</b>
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_BA_MANIPULATOR)) {</b>
<b class="nc">&nbsp;                if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_LARM) {</b>
<b class="nc">&nbsp;                    numLAManipulators++;</b>
<b class="nc">&nbsp;                    laManipType = BAManipulator.getManipulator(m.getType().getInternalName());</b>
<b class="nc">&nbsp;                } else if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_RARM) {</b>
<b class="nc">&nbsp;                    numRAManipulators++;</b>
<b class="nc">&nbsp;                    raManipType = BAManipulator.getManipulator(m.getType().getInternalName());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    if (m.getBaMountLoc() != BattleArmor.MOUNT_LOC_NONE) {</b>
<b class="nc">&nbsp;                        buff.append(m.getName()</b>
&nbsp;                                + &quot;mounted in &quot;
<b class="nc">&nbsp;                                + BattleArmor.MOUNT_LOC_NAMES[m.getBaMountLoc()]</b>
&nbsp;                                + &quot;, but manipulators must be mounted in arms!&quot;);
&nbsp;                    } else {
<b class="nc">&nbsp;                        buff.append(m.getName()</b>
&nbsp;                                + &quot; not allocated!\n&quot;);  
&nbsp;                    }
<b class="nc">&nbsp;                    correct = false;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if (numLAManipulators &gt; 1) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Found more than 1 manipulator in the left arm!&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (numRAManipulators &gt; 1) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Found more than 1 manipulator in the right arm!&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if ((laManipType.pairMounted || raManipType.pairMounted)</b>
&nbsp;                &amp;&amp; (laManipType.type != raManipType.type)) {
<b class="nc">&nbsp;            if (laManipType.pairMounted) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Left Arm manipulator must be mounted as a &quot;</b>
&nbsp;                        + &quot;pair, but the right arm manipulator doesn&#39;t match! &quot;);
&nbsp;            } else {
<b class="nc">&nbsp;                buff.append(&quot;Right Arm manipulator must be mounted as a &quot;</b>
&nbsp;                        + &quot;pair, but the left arm manipulator doesn&#39;t match! &quot;);
&nbsp;            }
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return correct;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean correctWeight(StringBuffer buff, boolean showO, boolean showU) {
<b class="nc">&nbsp;        double weightSum = calculateWeight();</b>
<b class="nc">&nbsp;        double weight = getWeight();</b>
<b class="nc">&nbsp;        boolean correct = true;</b>
<b class="nc">&nbsp;        String baDesig = ba.getLocationAbbr(BattleArmor.LOC_SQUAD);</b>
<b class="nc">&nbsp;        if (showO &amp;&amp; ((weight + getMaxOverweight()) &lt; weightSum)) {</b>
<b class="nc">&nbsp;            buff.append(baDesig + &quot;Weight: &quot;).append(calculateWeight())</b>
<b class="nc">&nbsp;                    .append(&quot; is greater than &quot;).append(getWeight())</b>
<b class="nc">&nbsp;                    .append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (showU &amp;&amp; ((weight - getMinUnderweight()) &gt; weightSum)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Weight: &quot;).append(calculateWeight())</b>
<b class="nc">&nbsp;                    .append(&quot; is less than &quot;).append(getWeight()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        for (int t = 1; t &lt; ba.getTroopers(); t++) {</b>
<b class="nc">&nbsp;            double trooperWeight = calculateWeight(t);</b>
<b class="nc">&nbsp;            if (trooperWeight &gt; ba.getTrooperWeight()) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Trooper &quot; + t + &quot; Weight: &quot; + trooperWeight</b>
<b class="nc">&nbsp;                        + &quot; is greater than &quot; + ba.getTrooperWeight() + &quot;\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return correct;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean correctEntity(StringBuffer buff) {
<b class="nc">&nbsp;        return correctEntity(buff, getEntity().getTechLevel());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean correctEntity(StringBuffer buff, int ammoTechLvl) {
<b class="nc">&nbsp;        boolean correct = true;</b>
<b class="nc">&nbsp;        if (skip()) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!correctWeight(buff)) {</b>
<b class="nc">&nbsp;            buff.insert(0, printTechLevel() + printShortMovement());</b>
<b class="nc">&nbsp;            buff.append(printWeightCalculation());</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (showCorrectArmor() &amp;&amp; !correctArmor(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (showCorrectCritical() &amp;&amp; !correctCriticals(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (showFailedEquip() &amp;&amp; hasFailedEquipment(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (hasIllegalTechLevels(buff, ammoTechLvl)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (showIncorrectIntroYear() &amp;&amp; hasIncorrectIntroYear(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (hasIllegalEquipmentCombinations(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        correct &amp;= correctManipulators(buff);</b>
&nbsp;
<b class="nc">&nbsp;        correct &amp;= correctMovement(buff);</b>
&nbsp;
<b class="nc">&nbsp;        return correct;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param eq        The equipment
&nbsp;     * @param buffer    If non-null and the location is invalid, will be appended with an explanation
&nbsp;     * @return          Whether the equipment can be mounted in the BattleArmor suit
&nbsp;     */
&nbsp;    public static boolean isValidBALocation(EquipmentType eq, @Nullable StringBuffer buffer) {
&nbsp;        // Infantry weapons can only be mounted in armored gloves/APMs
<b class="nc">&nbsp;        if ((eq instanceof WeaponType) &amp;&amp; eq.hasFlag(WeaponType.F_INFANTRY)) {</b>
<b class="nc">&nbsp;            if (buffer != null) {</b>
<b class="nc">&nbsp;                buffer.append(eq.getName())</b>
<b class="nc">&nbsp;                        .append(&quot; can only be mounted in an anti-personnel mount or an armored glove.\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public StringBuffer printEntity() {
<b class="nc">&nbsp;        StringBuffer buff = new StringBuffer();</b>
<b class="nc">&nbsp;        buff.append(&quot;BattleArmor: &quot;).append(ba.getDisplayName()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        buff.append(&quot;Found in: &quot;).append(fileString).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        buff.append(printTechLevel());</b>
<b class="nc">&nbsp;        buff.append(&quot;Intro year: &quot;).append(ba.getYear()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        buff.append(printSource());</b>
<b class="nc">&nbsp;        buff.append(printShortMovement());</b>
<b class="nc">&nbsp;        if (correctWeight(buff, true, true)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Weight: &quot;).append(getWeight() * 1000).append(&quot; kg (&quot;)</b>
<b class="nc">&nbsp;                    .append(calculateWeight() * 1000).append(&quot; kg)\n&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        buff.append(printWeightCalculation()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        buff.append(printArmorPlacement());</b>
<b class="nc">&nbsp;        correctArmor(buff);</b>
<b class="nc">&nbsp;        buff.append(printLocations());</b>
<b class="nc">&nbsp;        correctCriticals(buff);</b>
<b class="nc">&nbsp;        printFailedEquipment(buff);</b>
<b class="nc">&nbsp;        return buff;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printWeightCalculation() {
<b class="nc">&nbsp;        return printWeightStructure() + printWeightArmor() + &quot;Equipment:\n&quot;</b>
<b class="nc">&nbsp;                + printWeapon() + printAmmo() + printMiscEquip();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getName() {
<b class="nc">&nbsp;        return &quot;Battle Armor: &quot; + ba.getDisplayName();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightPowerAmp() {
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Performs the same functionality as &lt;code&gt;TestEntity.getWeightMiscEquip
&nbsp;     * &lt;/code&gt; but only considers equipment mounted on the specified trooper.
&nbsp;     * That is, only misc equipment that is squad mounted or on the specific
&nbsp;     * trooper is added.
&nbsp;     *
&nbsp;     * @param trooper
&nbsp;     * @return
&nbsp;     */
&nbsp;    public double getWeightMiscEquip(int trooper) {
<b class="nc">&nbsp;        double weightSum = 0.0;</b>
<b class="nc">&nbsp;        for (Mounted m : getEntity().getMisc()) {</b>
<b class="nc">&nbsp;            MiscType mt = (MiscType) m.getType();</b>
&nbsp;            // If this equipment isn&#39;t mounted on the squad or this particular
&nbsp;            // trooper, skip it
<b class="nc">&nbsp;            if ((m.getLocation() != BattleArmor.LOC_SQUAD)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((m.getLocation() != trooper) || (trooper == BattleArmor.LOC_SQUAD))) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Equipment assigned to this trooper but not mounted shouldn&#39;t be
&nbsp;            // counted, unless it&#39;s squad-level equipment
<b class="nc">&nbsp;            if ((m.getLocation() == trooper) &amp;&amp; (trooper != BattleArmor.LOC_SQUAD)</b>
<b class="nc">&nbsp;                    &amp;&amp; (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (mt.hasFlag(MiscType.F_ENDO_STEEL)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ENDO_STEEL_PROTO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_COMPOSITE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_INDUSTRIAL_STRUCTURE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_REINFORCED)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS_PROTO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_FERRO_LAMELLOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_LIGHT_FERRO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HEAVY_FERRO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_REACTIVE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_REFLECTIVE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HARDENED_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_PRIMITIVE_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_COMMERCIAL_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_INDUSTRIAL_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HEAVY_INDUSTRIAL_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ANTI_PENETRATIVE_ABLATIVE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HEAT_DISSIPATING)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_IMPACT_RESISTANT)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_BALLISTIC_REINFORCED)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HEAT_SINK)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_DOUBLE_HEAT_SINK)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_IS_DOUBLE_HEAT_SINK_PROTOTYPE)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            weightSum += m.getTonnage();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return weightSum;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightWeapon(int trooper) {
<b class="nc">&nbsp;        double weight = 0.0;</b>
<b class="nc">&nbsp;        for (Mounted m : getEntity().getWeaponList()) {</b>
&nbsp;            // If this equipment isn&#39;t mounted on the squad or this particular
&nbsp;            // trooper, skip it
<b class="nc">&nbsp;            if ((m.getLocation() != BattleArmor.LOC_SQUAD)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((m.getLocation() != trooper) || (trooper == BattleArmor.LOC_SQUAD))) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Equipment assigned to this trooper but not mounted shouldn&#39;t be
&nbsp;            // counted, unless it&#39;s squad-level equipment
<b class="nc">&nbsp;            if ((m.getLocation() == trooper) &amp;&amp; (trooper != BattleArmor.LOC_SQUAD)</b>
<b class="nc">&nbsp;                    &amp;&amp; (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
&nbsp;            // The weight of an anti-personnel weapon in an AP mount or armored glove manipulator doesn&#39;t
&nbsp;            // count toward suit weight limit.
<b class="nc">&nbsp;            if (m.isAPMMounted()) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            weight += m.getTonnage();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        // Round weight to prevent odd behavior
<b class="nc">&nbsp;        return Math.round(weight * 1000) / 1000.0;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightAmmo(int trooper) {
<b class="nc">&nbsp;        double weight = 0.0;</b>
<b class="nc">&nbsp;        for (Mounted m : getEntity().getAmmo()) {</b>
&nbsp;
&nbsp;            // If this equipment isn&#39;t mounted on the squad or this particular
&nbsp;            // trooper, skip it
<b class="nc">&nbsp;            if ((m.getLocation() != BattleArmor.LOC_SQUAD)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((m.getLocation() != trooper) </b>
&nbsp;                            || (trooper == BattleArmor.LOC_SQUAD))) {
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Equipment assigned to this trooper but not mounted shouldn&#39;t be
&nbsp;            // counted, unless it&#39;s squad-level equipment
<b class="nc">&nbsp;            if ((m.getLocation() == trooper) </b>
&nbsp;                    &amp;&amp; (trooper != BattleArmor.LOC_SQUAD)
<b class="nc">&nbsp;                    &amp;&amp; (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            double modifier = 1;</b>
&nbsp;            // Ammo mounted in a DWP has its weight reduced by 25%
<b class="nc">&nbsp;            if (m.getLinkedBy() != null &amp;&amp; m.getLinkedBy().isDWPMounted()){</b>
<b class="nc">&nbsp;                modifier = 0.75f;</b>
<b class="nc">&nbsp;            } else if (m.isSquadSupportWeapon()) {</b>
<b class="nc">&nbsp;                if (ba.isClan()){</b>
<b class="nc">&nbsp;                    modifier = 0.4;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    modifier = 0.5;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            AmmoType mt = (AmmoType) m.getType();</b>
<b class="nc">&nbsp;            weight += (mt.getKgPerShot() * m.getBaseShotsLeft()) / 1000.0</b>
&nbsp;                    * modifier;
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return weight;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * There are some cases where we need to know the weight of an individual
&nbsp;     * trooper in the BattleArmor squad, this method provides that.
&nbsp;     *
&nbsp;     * @param trooper
&nbsp;     * @return
&nbsp;     */
&nbsp;    public double calculateWeight(int trooper) {
<b class="nc">&nbsp;        double weight = 0;</b>
<b class="nc">&nbsp;        weight += getWeightStructure();</b>
<b class="nc">&nbsp;        weight += getWeightArmor();</b>
<b class="nc">&nbsp;        weight += getWeightMisc();</b>
&nbsp;
<b class="nc">&nbsp;        weight += getWeightMiscEquip(trooper);</b>
<b class="nc">&nbsp;        weight += getWeightWeapon(trooper);</b>
<b class="nc">&nbsp;        weight += getWeightAmmo(trooper);</b>
&nbsp;
&nbsp;        // Round weight to prevent odd behavior
<b class="nc">&nbsp;        return Math.round(weight*1000) / 1000.0;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double calculateWeight() {
<b class="nc">&nbsp;        double totalWeight = 0.0;</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; ba.getTroopers(); i++) {</b>
<b class="nc">&nbsp;            totalWeight += calculateWeight(i);</b>
&nbsp;        }
<b class="nc">&nbsp;        return totalWeight;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
