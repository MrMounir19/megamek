


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > TestSupportVehicle</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.common.verifier</a>
</div>

<h1>Coverage Summary for Class: TestSupportVehicle (megamek.common.verifier)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TestSupportVehicle</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/59)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/653)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TestSupportVehicle$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestSupportVehicle$AdvancedSVArmor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestSupportVehicle$ChassisModification</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (5/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    64.5%
  </span>
  <span class="absValue">
    (49/76)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestSupportVehicle$SVEngine</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestSupportVehicle$SVType</td>
<td class="coverageStat">
  <span class="percent">
    40%
  </span>
  <span class="absValue">
    (4/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    37.3%
  </span>
  <span class="absValue">
    (19/51)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    9.8%
  </span>
  <span class="absValue">
    (9/92)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    8.1%
  </span>
  <span class="absValue">
    (68/841)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek -
&nbsp; * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;
&nbsp;package megamek.common.verifier;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.common.*;
&nbsp;import megamek.common.annotations.Nullable;
&nbsp;import megamek.common.util.StringUtil;
&nbsp;import megamek.common.weapons.flamers.VehicleFlamerWeapon;
&nbsp;import megamek.common.weapons.infantry.InfantryWeapon;
&nbsp;import megamek.common.weapons.lasers.CLChemicalLaserWeapon;
&nbsp;
&nbsp;import java.math.BigInteger;
&nbsp;import java.util.*;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;/**
&nbsp; * Author: arlith
&nbsp; */
&nbsp;public class TestSupportVehicle extends TestEntity {
&nbsp;
&nbsp;    /**
&nbsp;     * Support vehicle categories for construction purposes. Most of these match with a particular movement
&nbsp;     * mode, but the construction rules treat naval and rail units as single types.
&nbsp;     */
<b class="fc">&nbsp;    public enum SVType implements ITechnologyDelegator {</b>
<b class="fc">&nbsp;        AIRSHIP (300, EntityMovementMode.AIRSHIP,</b>
&nbsp;                new double[]{0.2, 0.25, 0.3}, new double[]{0.004, 0.008, 0.012}),
<b class="fc">&nbsp;        FIXED_WING (200, EntityMovementMode.AERODYNE,</b>
&nbsp;                new double[]{0.08, 0.1, 0.15}, new double[]{0.005, 0.01, 0.015}),
<b class="fc">&nbsp;        HOVERCRAFT (100, EntityMovementMode.HOVER,</b>
&nbsp;                new double[]{0.2, 0.25, 0.3}, new double[]{0.0025, 0.004, 0.007}),
<b class="fc">&nbsp;        NAVAL (300, EntityMovementMode.NAVAL,</b>
&nbsp;                new double[]{0.12, 0.15, 0.17}, new double[]{0.004, 0.007, 0.009}),
<b class="fc">&nbsp;        TRACKED (200, EntityMovementMode.TRACKED,</b>
&nbsp;                new double[]{0.13, 0.15, 0.25}, new double[]{0.006, 0.013, 0.025}),
<b class="fc">&nbsp;        VTOL (60, EntityMovementMode.VTOL,</b>
&nbsp;                new double[]{0.2, 0.25, 0.3}, new double[]{0.002, 0.0025, 0.004}),
<b class="fc">&nbsp;        WHEELED (160, EntityMovementMode.WHEELED,</b>
&nbsp;                new double[]{0.12, 0.15, 0.18}, new double[]{0.0025, 0.0075, 0.015}),
<b class="fc">&nbsp;        WIGE (240, EntityMovementMode.WIGE,</b>
&nbsp;                new double[]{0.12, 0.15, 0.17}, new double[]{0.003, 0.005, 0.006}),
<b class="fc">&nbsp;        RAIL (600, EntityMovementMode.RAIL,</b>
&nbsp;                new double[]{0.15, 0.2, 0.3}, new double[]{0.003, 0.004, 0.005}),
<b class="fc">&nbsp;        SATELLITE (300, EntityMovementMode.STATION_KEEPING,</b>
&nbsp;                new double[]{0.08, 0.12, 0.16}, new double[]{0.1, 0.1, 0.1});
&nbsp;
&nbsp;        /** The maximum tonnage for a large support vehicle of this type; for airship this is the
&nbsp;         *  maximum for a medium for now.
&nbsp;         */
&nbsp;        public final int maxTonnage;
&nbsp;        public final EntityMovementMode defaultMovementMode;
&nbsp;        /** Used to calculate chassis weight for small, medium, large weight classes */
&nbsp;        private final double[] baseChassisValue;
&nbsp;        /** Used to calculate engine weight for small, medium, large weight classes */
&nbsp;        private final double[] baseEngineValue;
&nbsp;
&nbsp;        SVType(int maxTonnage, EntityMovementMode defaultMovementMode,
<b class="fc">&nbsp;               double[] baseChassisValue, double[] baseEngineValue) {</b>
<b class="fc">&nbsp;            this.maxTonnage = maxTonnage;</b>
<b class="fc">&nbsp;            this.defaultMovementMode = defaultMovementMode;</b>
<b class="fc">&nbsp;            this.baseChassisValue = baseChassisValue;</b>
<b class="fc">&nbsp;            this.baseEngineValue = baseEngineValue;</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
&nbsp;        static Set&lt;SVType&gt; allBut(SVType type) {
<b class="fc">&nbsp;            return EnumSet.complementOf(EnumSet.of(type));</b>
&nbsp;        }
&nbsp;
&nbsp;        static Set&lt;SVType&gt; allBut(SVType first, SVType... rest) {
<b class="fc">&nbsp;            return EnumSet.complementOf(EnumSet.of(first, rest));</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Finds the enum value corresponding to a support vehicle based on movement mode.
&nbsp;         *
&nbsp;         * @param entity The support vehicle
&nbsp;         * @return       The support vehicle type, or {@code null} if the entity&#39;s movement type is not
&nbsp;         *               a valid one for a support vehicle.
&nbsp;         */
&nbsp;        public static @Nullable
&nbsp;        SVType getVehicleType(Entity entity) {
<b class="nc">&nbsp;            switch (entity.getMovementMode()) {</b>
&nbsp;                case AIRSHIP:
<b class="nc">&nbsp;                    return AIRSHIP;</b>
&nbsp;                case AERODYNE:
<b class="nc">&nbsp;                    return FIXED_WING;</b>
&nbsp;                case HOVER:
<b class="nc">&nbsp;                    return HOVERCRAFT;</b>
&nbsp;                case TRACKED:
<b class="nc">&nbsp;                    return TRACKED;</b>
&nbsp;                case WHEELED:
<b class="nc">&nbsp;                    return WHEELED;</b>
&nbsp;                case NAVAL:
&nbsp;                case HYDROFOIL:
&nbsp;                case SUBMARINE:
<b class="nc">&nbsp;                    return NAVAL;</b>
&nbsp;                case VTOL:
<b class="nc">&nbsp;                    return VTOL;</b>
&nbsp;                case WIGE:
<b class="nc">&nbsp;                    return WIGE;</b>
&nbsp;                case RAIL:
&nbsp;                case MAGLEV:
<b class="nc">&nbsp;                    return RAIL;</b>
&nbsp;                case STATION_KEEPING:
<b class="nc">&nbsp;                    return SATELLITE;</b>
&nbsp;                default:
<b class="nc">&nbsp;                    return null;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * The base chassis value is used for calculating the chassis weight.
&nbsp;         *
&nbsp;         * @param sizeClass The {@link EntityWeightClass} of the support vehicle.
&nbsp;         * @return          The base chassis value. Returns 0 if not a support vehicle weight class.
&nbsp;         */
&nbsp;        public double getBaseChassisValue(int sizeClass) {
<b class="nc">&nbsp;            int index = sizeClass - EntityWeightClass.WEIGHT_SMALL_SUPPORT;</b>
<b class="nc">&nbsp;            if ((index &gt;= 0) &amp;&amp; (index &lt; baseChassisValue.length)) {</b>
<b class="nc">&nbsp;                return baseChassisValue[index];</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return 0.0;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * The base chassis value is used for calculating the chassis weight.
&nbsp;         *
&nbsp;         * @param sv A support vehicle
&nbsp;         * @return   The base chassis value. Returns 0 if the entity is not a support vehicle.
&nbsp;         */
&nbsp;        public static double getBaseChassisValue(Entity sv) {
<b class="nc">&nbsp;            SVType type = getVehicleType(sv);</b>
<b class="nc">&nbsp;            if (null != type) {</b>
<b class="nc">&nbsp;                return type.getBaseChassisValue(sv.getWeightClass());</b>
&nbsp;            }
<b class="nc">&nbsp;            return 0.0;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * The base engine value is used for calculating the engine weight.
&nbsp;         *
&nbsp;         * @param sizeClass The {@link EntityWeightClass} of the support vehicle.
&nbsp;         * @return          The base engine value. Returns 0 if not a support vehicle weight class.
&nbsp;         */
&nbsp;        public double getBaseEngineValue(int sizeClass) {
<b class="nc">&nbsp;            int index = sizeClass - EntityWeightClass.WEIGHT_SMALL_SUPPORT;</b>
<b class="nc">&nbsp;            if ((index &gt;= 0) &amp;&amp; (index &lt; baseEngineValue.length)) {</b>
<b class="nc">&nbsp;                return baseEngineValue[index];</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return 0.0;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * The base engine value is used for calculating the engine weight.
&nbsp;         *
&nbsp;         * @param sv A support vehicle
&nbsp;         * @return   The base engine value. Returns 0 if the entity is not a support vehicle.
&nbsp;         */
&nbsp;        public static double getBaseEngineValue(Entity sv) {
<b class="nc">&nbsp;            SVType type = getVehicleType(sv);</b>
<b class="nc">&nbsp;            if (null != type) {</b>
<b class="nc">&nbsp;                return type.getBaseEngineValue(sv.getWeightClass());</b>
&nbsp;            }
<b class="nc">&nbsp;            return 0.0;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public ITechnology getTechSource() {
&nbsp;            /* Support vehicle availability advancement can vary with the size class.
&nbsp;               The small is the least restrictive, so it serves as the base line for each
&nbsp;               type as a whole. */
<b class="nc">&nbsp;            switch (defaultMovementMode) {</b>
&nbsp;                case AERODYNE:
&nbsp;                case AIRSHIP:
&nbsp;                case STATION_KEEPING:
<b class="nc">&nbsp;                    return FixedWingSupport.getConstructionTechAdvancement(defaultMovementMode,</b>
&nbsp;                            EntityWeightClass.WEIGHT_SMALL_SUPPORT);
&nbsp;                case VTOL:
<b class="nc">&nbsp;                    return SupportVTOL.getConstructionTechAdvancement(EntityWeightClass.WEIGHT_SMALL_SUPPORT);</b>
&nbsp;                default:
<b class="nc">&nbsp;                    return SupportTank.getConstructionTechAdvancement(defaultMovementMode,</b>
&nbsp;                            EntityWeightClass.WEIGHT_SMALL_SUPPORT);
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Additional construction data for chassis mods, used to determine whether they are legal for particular
&nbsp;     * units.
&nbsp;     */
<b class="fc">&nbsp;    public enum ChassisModification implements ITechnologyDelegator {</b>
<b class="fc">&nbsp;        AMPHIBIOUS (1.75,EquipmentTypeLookup.AMPHIBIOUS_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                SVType.allBut(SVType.HOVERCRAFT, SVType.NAVAL)),</b>
<b class="fc">&nbsp;        ARMORED (1.5,EquipmentTypeLookup.ARMORED_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                SVType.allBut(SVType.AIRSHIP)),</b>
<b class="fc">&nbsp;        BICYCLE (0.75,EquipmentTypeLookup.BICYCLE_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.HOVERCRAFT, SVType.WHEELED)),</b>
<b class="fc">&nbsp;        CONVERTIBLE (1.1,EquipmentTypeLookup.CONVERTIBLE_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.HOVERCRAFT, SVType.WHEELED, SVType.TRACKED)),</b>
<b class="fc">&nbsp;        DUNE_BUGGY (1.5,EquipmentTypeLookup.DUNE_BUGGY_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.WHEELED)),</b>
<b class="fc">&nbsp;        ENVIRONMENTAL_SEALING (2.0,EquipmentTypeLookup.SV_ENVIRONMENTAL_SEALING_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.allOf(SVType.class)),</b>
<b class="fc">&nbsp;        EXTERNAL_POWER_PICKUP (1.1,EquipmentTypeLookup.EXTERNAL_POWER_PICKUP_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.RAIL)),</b>
<b class="fc">&nbsp;        HYDROFOIL (1.7,EquipmentTypeLookup.HYDROFOIL_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.NAVAL)),</b>
<b class="fc">&nbsp;        MONOCYCLE (0.5,EquipmentTypeLookup.MONOCYCLE_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.HOVERCRAFT, SVType.WHEELED), true),</b>
<b class="fc">&nbsp;        OFFROAD (1.5,EquipmentTypeLookup.OFFROAD_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.WHEELED)),</b>
<b class="fc">&nbsp;        OMNI (1.0,EquipmentTypeLookup.OMNI_CHASSIS_MOD),</b>
<b class="fc">&nbsp;        PROP (1.2,EquipmentTypeLookup.PROP_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.FIXED_WING)),</b>
<b class="fc">&nbsp;        SNOWMOBILE (1.75,EquipmentTypeLookup.SNOWMOBILE_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.WHEELED, SVType.TRACKED)),</b>
<b class="fc">&nbsp;        STOL (1.5,EquipmentTypeLookup.STOL_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.FIXED_WING)),</b>
<b class="fc">&nbsp;        SUBMERSIBLE (1.8,EquipmentTypeLookup.SUBMERSIBLE_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.NAVAL)),</b>
<b class="fc">&nbsp;        TRACTOR (1.2,EquipmentTypeLookup.TRACTOR_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.WHEELED, SVType.TRACKED, SVType.NAVAL, SVType.RAIL)),</b>
<b class="fc">&nbsp;        TRAILER (0.8,EquipmentTypeLookup.TRAILER_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.WHEELED, SVType.TRACKED, SVType.RAIL)),</b>
<b class="fc">&nbsp;        ULTRA_LIGHT (0.5,EquipmentTypeLookup.ULTRALIGHT_CHASSIS_MOD,</b>
&nbsp;                true),
<b class="fc">&nbsp;        VSTOL (2.0,EquipmentTypeLookup.VSTOL_CHASSIS_MOD,</b>
<b class="fc">&nbsp;                EnumSet.of(SVType.FIXED_WING));</b>
&nbsp;
&nbsp;        public final double multiplier;
&nbsp;        public final MiscType equipment;
&nbsp;        public final boolean smallOnly;
&nbsp;        public final Set&lt;SVType&gt; allowedTypes;
&nbsp;
&nbsp;        ChassisModification(double multiplier, String eqTypeKey) {
<b class="fc">&nbsp;            this(multiplier, eqTypeKey, EnumSet.allOf(SVType.class), false);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
&nbsp;        ChassisModification(double multiplier, String eqTypeKey, boolean smallOnly) {
<b class="fc">&nbsp;            this(multiplier, eqTypeKey, EnumSet.allOf(SVType.class), smallOnly);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
&nbsp;        ChassisModification(double multiplier, String eqTypeKey, Set&lt;SVType&gt; allowedTypes) {
<b class="fc">&nbsp;            this(multiplier, eqTypeKey, allowedTypes, false);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        ChassisModification(double multiplier, String eqTypeKey, Set&lt;SVType&gt; allowedTypes, boolean smallOnly) {</b>
<b class="fc">&nbsp;            this.multiplier = multiplier;</b>
<b class="fc">&nbsp;            this.equipment = (MiscType) EquipmentType.get(eqTypeKey);</b>
<b class="fc">&nbsp;            this.allowedTypes = allowedTypes;</b>
<b class="fc">&nbsp;            this.smallOnly = smallOnly;</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
&nbsp;        /**
&nbsp;         * Checks for compatibility with a support vehicle type and weight class
&nbsp;         *
&nbsp;         * @param sv The support vehicle
&nbsp;         * @return   Whether the mod is valid for the vehicle
&nbsp;         */
&nbsp;        public boolean validFor(Entity sv) {
<b class="nc">&nbsp;            return sv.isSupportVehicle() &amp;&amp; allowedTypes.contains(SVType.getVehicleType(sv))</b>
<b class="nc">&nbsp;                    &amp;&amp; (!smallOnly || (sv.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT))</b>
&nbsp;                    // Hydrofoil has a specific upper weight limit rather than a weight class.
<b class="nc">&nbsp;                    &amp;&amp; (!this.equals(HYDROFOIL) || sv.getWeight() &lt;= 100.0)</b>
&nbsp;                    // Can&#39;t put a turret on a convertible
<b class="nc">&nbsp;                    &amp;&amp; (!this.equals(CONVERTIBLE) || !(sv instanceof Tank)</b>
<b class="nc">&nbsp;                        || ((Tank) sv).hasNoTurret())</b>
&nbsp;                    // External power pickup (rail) is only valid with the external engine type
<b class="nc">&nbsp;                    &amp;&amp; (!this.equals(EXTERNAL_POWER_PICKUP)</b>
<b class="nc">&nbsp;                        || (sv.getEngine().getEngineType() == Engine.EXTERNAL));</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Checks whether something about the vehicle requires a specific chassis mod.
&nbsp;         *
&nbsp;         * @param sv A support vehicle
&nbsp;         * @return   Whether this chassis mod is required by the vehicle.
&nbsp;         */
&nbsp;        public boolean requiredFor(Entity sv) {
<b class="nc">&nbsp;            switch (this) {</b>
&nbsp;                case PROP:
<b class="nc">&nbsp;                    return sv instanceof FixedWingSupport</b>
<b class="nc">&nbsp;                            &amp;&amp; SVEngine.getEngineType(sv.getEngine()).electric;</b>
&nbsp;                case EXTERNAL_POWER_PICKUP:
<b class="nc">&nbsp;                    return sv.getMovementMode().equals(EntityMovementMode.RAIL)</b>
<b class="nc">&nbsp;                            &amp;&amp; SVEngine.getEngineType(sv.getEngine()).equals(SVEngine.EXTERNAL);</b>
&nbsp;                default:
<b class="nc">&nbsp;                    return false;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Checks for compatibility between different chassis modifications
&nbsp;         *
&nbsp;         * @param other Another chassis mod
&nbsp;         * @return      Whether this chassis mod can be installed on the same vehicle as another mod.
&nbsp;         */
&nbsp;        public boolean compatibleWith(ChassisModification other) {
<b class="nc">&nbsp;            switch (this) {</b>
&nbsp;                case ARMORED:
<b class="nc">&nbsp;                    return other != ULTRA_LIGHT;</b>
&nbsp;                case ULTRA_LIGHT:
<b class="nc">&nbsp;                    return other != ARMORED;</b>
&nbsp;                case BICYCLE:
<b class="nc">&nbsp;                    return other != MONOCYCLE;</b>
&nbsp;                case MONOCYCLE:
<b class="nc">&nbsp;                    return other != BICYCLE;</b>
&nbsp;                case SNOWMOBILE:
<b class="nc">&nbsp;                    return other != DUNE_BUGGY</b>
&nbsp;                            &amp;&amp; other != AMPHIBIOUS
&nbsp;                            &amp;&amp; other != OFFROAD;
&nbsp;                case DUNE_BUGGY:
<b class="nc">&nbsp;                    return other != SNOWMOBILE</b>
&nbsp;                            &amp;&amp; other != AMPHIBIOUS
&nbsp;                            &amp;&amp; other != OFFROAD;
&nbsp;                case AMPHIBIOUS:
&nbsp;                case OFFROAD:
<b class="nc">&nbsp;                    return other != SNOWMOBILE</b>
&nbsp;                            &amp;&amp; other != DUNE_BUGGY;
&nbsp;                default:
<b class="nc">&nbsp;                    return true;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public ITechnology getTechSource() {
<b class="nc">&nbsp;            return equipment;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Find the enum value that corresponds to an {@link EquipmentType} instance.
&nbsp;         *
&nbsp;         * @param eq The equipment to match
&nbsp;         * @return   The corresponding enum value, or {@code null} if there is no match.
&nbsp;         */
&nbsp;        public @Nullable
&nbsp;        static ChassisModification getChassisMod(EquipmentType eq) {
<b class="nc">&nbsp;            for (ChassisModification mod : values()) {</b>
<b class="nc">&nbsp;                if (mod.equipment.equals(eq)) {</b>
<b class="nc">&nbsp;                    return mod;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Additional construction data for engine types, used to determine which ones are available for which
&nbsp;     * vehicle types.
&nbsp;     */
<b class="nc">&nbsp;    public enum SVEngine implements ITechnologyDelegator {</b>
<b class="nc">&nbsp;        STEAM (Engine.STEAM, EnumSet.of(SVType.WHEELED, SVType.TRACKED,</b>
&nbsp;                SVType.AIRSHIP, SVType.NAVAL, SVType.RAIL)),
<b class="nc">&nbsp;        COMBUSTION (Engine.COMBUSTION_ENGINE, SVType.allBut(SVType.SATELLITE)),</b>
<b class="nc">&nbsp;        BATTERY (Engine.BATTERY, true),</b>
<b class="nc">&nbsp;        FUEL_CELL (Engine.FUEL_CELL, true),</b>
<b class="nc">&nbsp;        SOLAR (Engine.SOLAR, EnumSet.of(SVType.WHEELED, SVType.TRACKED, SVType.AIRSHIP, SVType.FIXED_WING,</b>
&nbsp;                SVType.NAVAL, SVType.WIGE, SVType.SATELLITE), true),
<b class="nc">&nbsp;        FISSION (Engine.FISSION),</b>
<b class="nc">&nbsp;        FUSION (Engine.NORMAL_ENGINE),</b>
<b class="nc">&nbsp;        MAGLEV (Engine.MAGLEV, EnumSet.of(SVType.RAIL)),</b>
<b class="nc">&nbsp;        EXTERNAL (Engine.EXTERNAL, EnumSet.of(SVType.RAIL), true),</b>
<b class="nc">&nbsp;        NONE (Engine.NONE, EnumSet.of(SVType.WHEELED, SVType.TRACKED, SVType.RAIL), false);</b>
&nbsp;
&nbsp;        /** The engine type constant used to create a new {@link Engine}. */
&nbsp;        public final Engine engine;
&nbsp;        /** Fixed-wing must have prop chassis mod to use an electric engine */
&nbsp;        public final boolean electric;
&nbsp;        private final Set&lt;SVType&gt; allowedTypes;
&nbsp;
&nbsp;        SVEngine(int engineType) {
<b class="nc">&nbsp;            this(engineType, EnumSet.allOf(SVType.class), false);</b>
&nbsp;        }
&nbsp;
&nbsp;        SVEngine(int engineType, boolean electric) {
<b class="nc">&nbsp;            this(engineType, EnumSet.allOf(SVType.class), electric);</b>
&nbsp;        }
&nbsp;
&nbsp;        SVEngine(int engineType, Set&lt;SVType&gt; allowedTypes) {
<b class="nc">&nbsp;            this(engineType, allowedTypes, false);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        SVEngine(int engineType, Set&lt;SVType&gt; allowedTypes, boolean electric) {</b>
<b class="nc">&nbsp;            this.engine = new Engine(0, engineType, Engine.SUPPORT_VEE_ENGINE);</b>
<b class="nc">&nbsp;            this.allowedTypes = allowedTypes;</b>
<b class="nc">&nbsp;            this.electric = electric;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Finds the enum value corresponding to an {@link Engine}.
&nbsp;         *
&nbsp;         * @param engine The engine
&nbsp;         * @return       The enum value for the engine, or {@code null} if it is not a valid SV engine type.
&nbsp;         */
&nbsp;        public @Nullable
&nbsp;        static SVEngine getEngineType(Engine engine) {
<b class="nc">&nbsp;            if (null != engine) {</b>
<b class="nc">&nbsp;                for (SVEngine e : values()) {</b>
<b class="nc">&nbsp;                    if (e.engine.getEngineType() == engine.getEngineType()) {</b>
<b class="nc">&nbsp;                        return e;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * @param type The support vehicle type
&nbsp;         * @return     Whether the engine is valid for the support vee.
&nbsp;         */
&nbsp;        public boolean isValidFor(SVType type) {
<b class="nc">&nbsp;            return allowedTypes.contains(type);</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * @param entity A support vehicle
&nbsp;         * @return       Whether the engine is valid for the support vee.
&nbsp;         */
&nbsp;        public boolean isValidFor(Entity entity) {
<b class="nc">&nbsp;            if ((this == NONE) &amp;&amp; !entity.isTrailer()) {</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
<b class="nc">&nbsp;            return isValidFor(SVType.getVehicleType(entity));</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public ITechnology getTechSource() {
<b class="nc">&nbsp;            return engine;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Tech advancement data for structural components with variable tech levels (structure,
&nbsp;     * armor, engine). This is assembled from the table on TM, p. 122 and IO, p. 49, primitive construction
&nbsp;     * rules (IO, p. 120-121) and a pending proposal to the rules committee for E.
&nbsp;     */
<b class="nc">&nbsp;    public static final TechAdvancement[] TECH_LEVEL_TA = {</b>
<b class="nc">&nbsp;            new TechAdvancement(ITechnology.TECH_BASE_ALL).setTechRating(ITechnology.RATING_A)</b>
<b class="nc">&nbsp;                    .setAdvancement(ITechnology.DATE_PS, ITechnology.DATE_PS, ITechnology.DATE_PS)</b>
<b class="nc">&nbsp;                    .setAvailability(ITechnology.RATING_A, ITechnology.RATING_A,</b>
&nbsp;                    ITechnology.RATING_A, ITechnology.RATING_A),
<b class="nc">&nbsp;            new TechAdvancement(ITechnology.TECH_BASE_ALL).setTechRating(ITechnology.RATING_B)</b>
<b class="nc">&nbsp;                    .setAdvancement(ITechnology.DATE_PS, ITechnology.DATE_PS, ITechnology.DATE_PS)</b>
<b class="nc">&nbsp;                    .setAvailability(ITechnology.RATING_B, ITechnology.RATING_B,</b>
&nbsp;                    ITechnology.RATING_B, ITechnology.RATING_A),
<b class="nc">&nbsp;            new TechAdvancement(ITechnology.TECH_BASE_ALL).setTechRating(ITechnology.RATING_C)</b>
<b class="nc">&nbsp;                    .setAdvancement(ITechnology.DATE_ES, ITechnology.DATE_ES, ITechnology.DATE_ES)</b>
<b class="nc">&nbsp;                    .setPrototypeFactions(ITechnology.F_TA).setProductionFactions(ITechnology.F_TA)</b>
<b class="nc">&nbsp;                    .setAvailability(ITechnology.RATING_C, ITechnology.RATING_B,</b>
&nbsp;                    ITechnology.RATING_B, ITechnology.RATING_B),
<b class="nc">&nbsp;            new TechAdvancement(ITechnology.TECH_BASE_ALL).setTechRating(ITechnology.RATING_D)</b>
<b class="nc">&nbsp;                    .setAdvancement(2420, 2430, 2435).setApproximate(true, true, false)</b>
<b class="nc">&nbsp;                    .setPrototypeFactions(ITechnology.F_TH).setProductionFactions(ITechnology.F_TH)</b>
<b class="nc">&nbsp;                    .setAvailability(ITechnology.RATING_C, ITechnology.RATING_C,</b>
&nbsp;                    ITechnology.RATING_C, ITechnology.RATING_B),
<b class="nc">&nbsp;            new TechAdvancement(ITechnology.TECH_BASE_ALL).setTechRating(ITechnology.RATING_E)</b>
<b class="nc">&nbsp;                    .setISAdvancement(2557, 2571, 3055).setClanAdvancement(2557, 2571, 2815)</b>
<b class="nc">&nbsp;                    .setAvailability(ITechnology.RATING_D, ITechnology.RATING_F,</b>
&nbsp;                    ITechnology.RATING_D, ITechnology.RATING_C),
<b class="nc">&nbsp;            new TechAdvancement(ITechnology.TECH_BASE_ALL).setTechRating(ITechnology.RATING_F)</b>
<b class="nc">&nbsp;                    .setISAdvancement(ITechnology.DATE_NONE, ITechnology.DATE_NONE, 3065).setISApproximate(false, false, true)</b>
<b class="nc">&nbsp;                    .setClanAdvancement(2820, 2825, 2830).setClanApproximate(true, true, false)</b>
<b class="nc">&nbsp;                    .setAvailability(ITechnology.RATING_E, ITechnology.RATING_E,</b>
&nbsp;                    ITechnology.RATING_D, ITechnology.RATING_C)
&nbsp;    };
&nbsp;
&nbsp;    /**
&nbsp;     * The chassis weight multiplier for tech ratings A-F
&nbsp;     */
<b class="nc">&nbsp;    private static final double[] STRUCTURE_TECH_MULTIPLIER = {</b>
&nbsp;            1.6, 1.3, 1.15, 1.0, 0.85, 0.66
&nbsp;    };
&nbsp;
&nbsp;    /**
&nbsp;     * Filters all vehicle armor according to given tech constraints. Standard armor is treated as basic
&nbsp;     * support vehicle armor.
&nbsp;     *
&nbsp;     * @param techManager Applies the filtering criteria
&nbsp;     * @return            A list of armor equipment that meets the tech constraints
&nbsp;     */
&nbsp;    public static List&lt;EquipmentType&gt; legalArmorsFor(ITechManager techManager) {
<b class="nc">&nbsp;        if (techManager.getTechLevel().ordinal() &lt; SimpleTechLevel.ADVANCED.ordinal()) {</b>
<b class="nc">&nbsp;            return Collections.singletonList(EquipmentType.get(EquipmentType.armorNames[EquipmentType.T_ARMOR_STANDARD]));</b>
&nbsp;        }
<b class="nc">&nbsp;        List&lt;EquipmentType&gt; retVal = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int at = 0; at &lt; EquipmentType.armorNames.length; at++) {</b>
<b class="nc">&nbsp;            if (at == EquipmentType.T_ARMOR_PATCHWORK) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            String name = EquipmentType.getArmorTypeName(at, techManager.useClanTechBase());</b>
<b class="nc">&nbsp;            EquipmentType eq = EquipmentType.get(name);</b>
<b class="nc">&nbsp;            if ((null != eq)</b>
<b class="nc">&nbsp;                    &amp;&amp; eq.hasFlag(MiscType.F_SUPPORT_TANK_EQUIPMENT)</b>
<b class="nc">&nbsp;                    &amp;&amp; techManager.isLegal(eq)) {</b>
<b class="nc">&nbsp;                retVal.add(eq);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (techManager.useMixedTech()) {</b>
<b class="nc">&nbsp;                name = EquipmentType.getArmorTypeName(at, !techManager.useClanTechBase());</b>
<b class="nc">&nbsp;                EquipmentType eq2 = EquipmentType.get(name);</b>
<b class="nc">&nbsp;                if ((null != eq2) &amp;&amp; (eq != eq2)</b>
<b class="nc">&nbsp;                        &amp;&amp; eq2.hasFlag(MiscType.F_SUPPORT_TANK_EQUIPMENT)</b>
<b class="nc">&nbsp;                        &amp;&amp; techManager.isLegal(eq2)) {</b>
<b class="nc">&nbsp;                    retVal.add(eq2);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * The maximum number of armor points a support vehicle is computed by multiplying the total tonnage by a factor
&nbsp;     * determined by the vehicle type and adding four.
&nbsp;     *
&nbsp;     * @param vee The support vehicle
&nbsp;     * @return    The maximum number of armor points. If the entity cannot be identified as a support vehicle, returns 0.
&nbsp;     */
&nbsp;    public static int maxArmorFactor(Entity vee) {
<b class="nc">&nbsp;        SVType type = SVType.getVehicleType(vee);</b>
<b class="nc">&nbsp;        if (null == type) {</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
<b class="nc">&nbsp;        double factor = 0;</b>
<b class="nc">&nbsp;        switch (type) {</b>
&nbsp;            case AIRSHIP:
&nbsp;            case NAVAL:
<b class="nc">&nbsp;                if (vee.getWeightClass() == EntityWeightClass.WEIGHT_LARGE_SUPPORT) {</b>
<b class="nc">&nbsp;                    factor = 0.05;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    factor = 0.334;</b>
&nbsp;                }
<b class="nc">&nbsp;                break;</b>
&nbsp;            case WIGE:
&nbsp;            case RAIL:
&nbsp;            case SATELLITE:
<b class="nc">&nbsp;                factor = 0.5;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case FIXED_WING:
&nbsp;            case HOVERCRAFT:
&nbsp;            case VTOL:
<b class="nc">&nbsp;                factor = 1.0;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case TRACKED:
&nbsp;            case WHEELED:
<b class="nc">&nbsp;                factor = 2.0;</b>
&nbsp;                break;
&nbsp;        }
<b class="nc">&nbsp;        return 4 + (int) (vee.getWeight() * factor);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Calculates the weight of each point of armor. For standard SV armor this is based on the tech and BAR
&nbsp;     * ratings. For advanced armors this is the reciprocal of the number of points per ton.
&nbsp;     *
&nbsp;     * @param vee The support vehicle
&nbsp;     * @return    The weight of each armor point in tons, rounded to the kilogram.
&nbsp;     */
&nbsp;    public static double armorWeightPerPoint(Entity vee) {
<b class="nc">&nbsp;        final int at = vee.getArmorType(vee.firstArmorIndex());</b>
<b class="nc">&nbsp;        if (at == EquipmentType.T_ARMOR_STANDARD) {</b>
<b class="nc">&nbsp;            return EquipmentType.getSupportVehicleArmorWeightPerPoint(vee.getBARRating(vee.firstArmorIndex()),</b>
<b class="nc">&nbsp;                    vee.getArmorTechRating());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            final double ppt = 16.0 * EquipmentType.getArmorPointMultiplier(</b>
<b class="nc">&nbsp;                    at, vee.getArmorTechLevel(vee.firstArmorIndex()));</b>
<b class="nc">&nbsp;            return round(1.0 / ppt, Ceil.KILO);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks whether the support vehicle can mount sponson turrets (TO, p. 348)
&nbsp;     *
&nbsp;     * @param type  The support vehicle type
&nbsp;     * @param small Whether the {@link Entity} is a small support vehicle
&nbsp;     * @return      Whether the vehicle can use sponson turrets.
&nbsp;     */
&nbsp;    public static boolean sponsonLegal(SVType type, boolean small) {
<b class="nc">&nbsp;        return !small</b>
&nbsp;                &amp;&amp; (type != SVType.FIXED_WING)
&nbsp;                &amp;&amp; (type != SVType.AIRSHIP)
&nbsp;                &amp;&amp; (type != SVType.SATELLITE);
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks whether the support vehicle can mount pintle turrets (TM, p. 348)
&nbsp;     *
&nbsp;     * @param type  The support vehicle type
&nbsp;     * @param small Whether the {@link Entity} is a small support vehicle
&nbsp;     * @return      Whether the vehicle can use pintle turrets.
&nbsp;     */
&nbsp;    public static boolean pintleLegal(SVType type, boolean small) {
<b class="nc">&nbsp;        return small</b>
&nbsp;                &amp;&amp; (type != SVType.FIXED_WING)
&nbsp;                &amp;&amp; (type != SVType.NAVAL);
&nbsp;    }
&nbsp;
&nbsp;    private final Entity supportVee;
&nbsp;    /** Used by support tanks for calculation of turret weight */
&nbsp;    private final TestTank testTank;
&nbsp;    /** Used by fixed wing, airship, and satellite for some calculations and validation */
&nbsp;    private final TestAero testAero;
&nbsp;    
&nbsp;    public TestSupportVehicle(Entity sv, TestEntityOption options,
&nbsp;            String fileString) {
<b class="nc">&nbsp;        super(options, sv.getEngine(), null, null);</b>
<b class="nc">&nbsp;        this.supportVee = sv;</b>
<b class="nc">&nbsp;        testTank = sv instanceof Tank ? new TestTank((Tank) sv, options, fileString) : null;</b>
<b class="nc">&nbsp;        testAero = sv instanceof Aero ? new TestAero((Aero) sv, options, fileString) : null;</b>
<b class="nc">&nbsp;    }</b>
&nbsp;    
&nbsp;    @Override
&nbsp;    public String printWeightStructure() {
<b class="nc">&nbsp;        return StringUtil.makeLength(</b>
<b class="nc">&nbsp;                &quot;Chassis: &quot;, getPrintSize() - 5)</b>
<b class="nc">&nbsp;                + TestEntity.makeWeightString(getWeightStructure(), usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printWeightEngine() {
<b class="nc">&nbsp;        return StringUtil.makeLength(String.format(&quot;Engine: %s (%s)&quot;,</b>
<b class="nc">&nbsp;                engine.getEngineName(), ITechnology.getRatingName(getEntity().getEngineTechRating())),</b>
<b class="nc">&nbsp;                getPrintSize() - 5)</b>
<b class="nc">&nbsp;                + TestEntity.makeWeightString(getWeightEngine(), usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printWeightArmor() {
&nbsp;        String name;
<b class="nc">&nbsp;        if (getEntity().hasBARArmor(getEntity().firstArmorIndex())) {</b>
<b class="nc">&nbsp;            name = String.format(&quot;BAR %d [%s]&quot;,</b>
<b class="nc">&nbsp;                    getEntity().getBARRating(getEntity().firstArmorIndex()),</b>
<b class="nc">&nbsp;                    ITechnology.getRatingName(getEntity().getArmorTechRating()));</b>
<b class="nc">&nbsp;        } else if (!getEntity().hasPatchworkArmor()) {</b>
<b class="nc">&nbsp;            name = EquipmentType.getArmorTypeName(getEntity()</b>
<b class="nc">&nbsp;                            .getArmorType(getEntity().firstArmorIndex()));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            name = &quot;Patchwork&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        return StringUtil.makeLength(</b>
<b class="nc">&nbsp;                String.format(&quot;Armor: %d (%s)&quot;, getTotalOArmor(), name),</b>
<b class="nc">&nbsp;                getPrintSize() - 5)</b>
<b class="nc">&nbsp;                + TestEntity.makeWeightString(getWeightArmor(), usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Entity getEntity() {
<b class="nc">&nbsp;        return supportVee;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isTank() {
<b class="nc">&nbsp;        return supportVee instanceof Tank;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isMech() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isAero() {
<b class="nc">&nbsp;        return supportVee.isAero();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isSmallCraft() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isAdvancedAerospace() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isProtomech() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Rounds up to the nearest half ton or kilogram as appropriate to the vehicle
&nbsp;     *
&nbsp;     * @param val The weight to round, in tons
&nbsp;     * @return    The rounded weight, in tons
&nbsp;     */
&nbsp;    private double ceilWeight(double val) {
<b class="nc">&nbsp;        if (supportVee.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
&nbsp;            // Deal first with possible variances from floating point precision
&nbsp;            // by rounding to the gram, then round the result up to the next kilogram.
&nbsp;            // Then convert back to metric tons.
<b class="nc">&nbsp;            return Math.ceil(Math.round(val * 1000000.0) / 1000.0) / 1000.0;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return ceil(val, Ceil.HALFTON);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double calculateWeight() {
<b class="nc">&nbsp;        return ceilWeight(super.calculateWeight() + getFuelTonnage());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightStructure() {
<b class="nc">&nbsp;        double weight = supportVee.getWeight();</b>
<b class="nc">&nbsp;        weight *= SVType.getBaseChassisValue(supportVee);</b>
<b class="nc">&nbsp;        weight *= STRUCTURE_TECH_MULTIPLIER[supportVee.getStructuralTechRating()];</b>
<b class="nc">&nbsp;        for (Mounted m : supportVee.getMisc()) {</b>
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_CHASSIS_MODIFICATION)) {</b>
<b class="nc">&nbsp;                ChassisModification mod = ChassisModification.getChassisMod(m.getType());</b>
<b class="nc">&nbsp;                if (null != mod) {</b>
<b class="nc">&nbsp;                    weight *= mod.multiplier;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    MegaMek.getLogger().warning(&quot;Could not find multiplier for &quot; </b>
<b class="nc">&nbsp;                            + m.getType().getName() + &quot; chassis mod.&quot;);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return ceilWeight(weight);</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getFuelTonnage() {
<b class="nc">&nbsp;        if (supportVee instanceof Aero) {</b>
<b class="nc">&nbsp;            return ((Aero) supportVee).getFuelTonnage();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return ((Tank) supportVee).getFuelTonnage();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private double getWeightFireControl() {
<b class="nc">&nbsp;        for (Mounted m : supportVee.getMisc()) {</b>
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_BASIC_FIRECONTROL)</b>
<b class="nc">&nbsp;                    || m.getType().hasFlag(MiscType.F_ADVANCED_FIRECONTROL)) {</b>
<b class="nc">&nbsp;                return m.getTonnage();</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return 0.0;</b>
&nbsp;    }
&nbsp;
&nbsp;    private double getWeightCrewAccomodations() {
<b class="nc">&nbsp;        double weight = 0;</b>
<b class="nc">&nbsp;        for (Transporter t : supportVee.getTransports()) {</b>
<b class="nc">&nbsp;            if ((t instanceof Bay) &amp;&amp; ((Bay) t).isQuarters()) {</b>
<b class="nc">&nbsp;                weight += ((Bay) t).getWeight();</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return round(weight, Ceil.KILO);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightControls() {
<b class="nc">&nbsp;        return getWeightFireControl() + getWeightCrewAccomodations();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightMisc() {
<b class="nc">&nbsp;        return getTankWeightTurret()</b>
<b class="nc">&nbsp;                + getTankWeightDualTurret();</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getTankWeightTurret() {
<b class="nc">&nbsp;        if (null != testTank) {</b>
<b class="nc">&nbsp;            return testTank.getTankWeightTurret();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return 0.0;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public double getTankWeightDualTurret() {
<b class="nc">&nbsp;        if (null != testTank) {</b>
<b class="nc">&nbsp;            return testTank.getTankWeightDualTurret();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return 0.0;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightAmmo() {
<b class="nc">&nbsp;        if (getEntity().getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
<b class="nc">&nbsp;            double weight = 0;</b>
<b class="nc">&nbsp;            for (Mounted m : getEntity().getWeaponList()) {</b>
<b class="nc">&nbsp;                weight += getSmallSVAmmoWeight(m);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            return weight;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return super.getWeightAmmo();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightPowerAmp() {
&nbsp;        // Small support vees only use infantry weapons, which do not require amplifiers.
<b class="nc">&nbsp;        if (supportVee.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
<b class="nc">&nbsp;            return 0.0;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!engine.isFusion() &amp;&amp; (engine.getEngineType() != Engine.FISSION)) {</b>
<b class="nc">&nbsp;            double weight = 0;</b>
<b class="nc">&nbsp;            for (Mounted m : supportVee.getWeaponList()) {</b>
<b class="nc">&nbsp;                WeaponType wt = (WeaponType) m.getType();</b>
<b class="nc">&nbsp;                if (wt.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !(wt instanceof CLChemicalLaserWeapon) &amp;&amp; !(wt instanceof VehicleFlamerWeapon)) {</b>
<b class="nc">&nbsp;                    weight += m.getTonnage();</b>
&nbsp;                }
<b class="nc">&nbsp;                if ((m.getLinkedBy() != null) &amp;&amp; (m.getLinkedBy().getType() instanceof</b>
<b class="nc">&nbsp;                        MiscType) &amp;&amp; m.getLinkedBy().getType().</b>
<b class="nc">&nbsp;                        hasFlag(MiscType.F_PPC_CAPACITOR)) {</b>
<b class="nc">&nbsp;                    weight += m.getLinkedBy().getTonnage();</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            for (Mounted m : supportVee.getMisc()) {</b>
<b class="nc">&nbsp;                if (m.getType().hasFlag(MiscType.F_CLUB) &amp;&amp; m.getType().hasSubType(MiscType.S_SPOT_WELDER)) {</b>
<b class="nc">&nbsp;                    weight += m.getTonnage();</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            return ceilWeight(weight / 10);</b>
&nbsp;        }
<b class="nc">&nbsp;        return 0.0;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected boolean includeMiscEquip(MiscType eq) {
&nbsp;        // fire control is counted with control system weight and chassis mods are part of
&nbsp;        // the structure weight
<b class="nc">&nbsp;        final BigInteger exclude = MiscType.F_BASIC_FIRECONTROL.or(MiscType.F_ADVANCED_FIRECONTROL)</b>
<b class="nc">&nbsp;                .or(MiscType.F_CHASSIS_MODIFICATION);</b>
<b class="nc">&nbsp;        return !eq.hasFlag(exclude);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightHeatSinks() {
&nbsp;        // Unlike other units, support vehicles do not get any free engine heat sinks.
<b class="nc">&nbsp;        return getCountHeatSinks();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean hasDoubleHeatSinks() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int getCountHeatSinks() {
&nbsp;        // Small support vees can&#39;t mount heavy weapons, so no reason to iterate through them to check.
<b class="nc">&nbsp;        if (supportVee.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
<b class="nc">&nbsp;        return heatNeutralHSRequirement();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printWeightMisc() {
<b class="nc">&nbsp;        if (null != testTank) {</b>
<b class="nc">&nbsp;            return testTank.printWeightMisc();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return getWeightPowerAmp() != 0 ? StringUtil.makeLength(</b>
<b class="nc">&nbsp;                    &quot;Power Amp:&quot;, getPrintSize() - 5)</b>
<b class="nc">&nbsp;                    + TestEntity.makeWeightString(getWeightPowerAmp(), usesKgStandard()) + &quot;\n&quot; : &quot;&quot;;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String printWeightControls() {
<b class="nc">&nbsp;        String fireCon = &quot;&quot;;</b>
<b class="nc">&nbsp;        for (Mounted m : supportVee.getMisc()) {</b>
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_BASIC_FIRECONTROL)</b>
<b class="nc">&nbsp;                    || m.getType().hasFlag(MiscType.F_ADVANCED_FIRECONTROL)) {</b>
<b class="nc">&nbsp;                fireCon = StringUtil.makeLength(m.getName(), getPrintSize() - 5)</b>
<b class="nc">&nbsp;                        + TestEntity.makeWeightString(m.getTonnage(), usesKgStandard()) + &quot;\n&quot;;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        double weight = getWeightCrewAccomodations();</b>
<b class="nc">&nbsp;        String crewStr = weight &gt; 0 ?</b>
<b class="nc">&nbsp;                StringUtil.makeLength(&quot;Crew Accomodations:&quot;, getPrintSize() - 5)</b>
<b class="nc">&nbsp;                    + TestEntity.makeWeightString(weight, usesKgStandard()) + &quot;\n&quot; : &quot;&quot;;</b>
<b class="nc">&nbsp;        return fireCon + crewStr;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public StringBuffer printAmmo(StringBuffer buff, int posLoc, int posWeight) {
<b class="nc">&nbsp;        if (getEntity().getWeightClass() != EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
<b class="nc">&nbsp;            return super.printAmmo(buff, posLoc, posWeight);</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Mounted m : getEntity().getWeaponList()) {</b>
<b class="nc">&nbsp;            double weight = getSmallSVAmmoWeight(m);</b>
<b class="nc">&nbsp;            if (weight &gt; 0) {</b>
<b class="nc">&nbsp;                buff.append(StringUtil.makeLength(&quot;Ammo [&quot; + m.getName() + &quot;]&quot;, 20));</b>
<b class="nc">&nbsp;                buff.append(&quot; &quot;).append(</b>
<b class="nc">&nbsp;                        StringUtil.makeLength(getLocationAbbr(m.getLocation()),</b>
<b class="nc">&nbsp;                                getPrintSize() - 5 - 20))</b>
<b class="nc">&nbsp;                        .append(TestEntity.makeWeightString(weight, true)).append(&quot;\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return buff;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static double getSmallSVAmmoWeight(Mounted mounted) {
&nbsp;        // first clip is free
<b class="nc">&nbsp;        if ((mounted.getSize() &gt; 1) &amp;&amp; (mounted.getType() instanceof InfantryWeapon)) {</b>
<b class="nc">&nbsp;            return RoundWeight.nextKg((mounted.getSize() - 1)</b>
<b class="nc">&nbsp;                    * ((InfantryWeapon) mounted.getType()).getAmmoWeight());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return 0.0;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public boolean canUseSponsonTurret() {
<b class="nc">&nbsp;        return sponsonLegal(SVType.getVehicleType(getEntity()),</b>
<b class="nc">&nbsp;                getEntity().getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean canUsePintleTurret() {
<b class="nc">&nbsp;        return pintleLegal(SVType.getVehicleType(getEntity()),</b>
<b class="nc">&nbsp;                getEntity().getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean correctEntity(StringBuffer buff) {
<b class="nc">&nbsp;        return correctEntity(buff, getEntity().getTechLevel());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean correctEntity(StringBuffer buff, int ammoTechLvl) {
<b class="nc">&nbsp;        boolean correct = true;</b>
<b class="nc">&nbsp;        if (skip()) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!correctWeight(buff)) {</b>
<b class="nc">&nbsp;            buff.insert(0, printTechLevel() + printShortMovement());</b>
<b class="nc">&nbsp;            buff.append(printWeightCalculation()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!engine.engineValid) {</b>
<b class="nc">&nbsp;            buff.append(engine.problem.toString()).append(&quot;\n\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((supportVee instanceof Tank) &amp;&amp; (((Tank) supportVee).fuelTonnagePer100km() &gt; 0.0)</b>
<b class="nc">&nbsp;                &amp;&amp; (((Tank) supportVee).getFuelTonnage() &lt;= 0.0)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Support vehicles with &quot;).append(engine.getEngineName())</b>
<b class="nc">&nbsp;                    .append(&quot; engine must allocate some weight for fuel.\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
<b class="nc">&nbsp;        } else if ((supportVee instanceof FixedWingSupport)</b>
<b class="nc">&nbsp;                &amp;&amp; (((FixedWingSupport) supportVee).getOriginalFuel() &lt;= 0.0)</b>
<b class="nc">&nbsp;                &amp;&amp; ((FixedWingSupport) supportVee).kgPerFuelPoint() &gt; 0) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Aerospace units must allocate some weight for fuel.\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (occupiedSlotCount() &gt; totalSlotCount()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Not enough item slots available! Using &quot;);</b>
<b class="nc">&nbsp;            buff.append(Math.abs(occupiedSlotCount() - totalSlotCount()));</b>
<b class="nc">&nbsp;            buff.append(&quot; slot(s) too many.\n&quot;);</b>
<b class="nc">&nbsp;            buff.append(printSlotCalculation()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        int armorLimit = maxArmorFactor(supportVee);</b>
<b class="nc">&nbsp;        if (supportVee.getTotalOArmor() &gt; armorLimit) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Armor exceeds point limit for &quot;);</b>
<b class="nc">&nbsp;            buff.append(supportVee.getWeight());</b>
<b class="nc">&nbsp;            buff.append(&quot;-ton &quot;);</b>
<b class="nc">&nbsp;            buff.append(supportVee.getMovementModeAsString());</b>
<b class="nc">&nbsp;            buff.append(&quot; support vehicle: &quot;);</b>
<b class="nc">&nbsp;            buff.append(supportVee.getTotalOArmor());</b>
<b class="nc">&nbsp;            buff.append(&quot; points &gt; &quot;);</b>
<b class="nc">&nbsp;            buff.append(armorLimit);</b>
<b class="nc">&nbsp;            buff.append(&quot;.\n\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (supportVee.hasBARArmor(supportVee.firstArmorIndex())) {</b>
<b class="nc">&nbsp;            int bar = supportVee.getBARRating(supportVee.firstArmorIndex());</b>
<b class="nc">&nbsp;            if ((bar &lt; 2) || (bar &gt; 10)) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Armor must have a BAR between 2 and 10.\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                double perPoint = EquipmentType.getSupportVehicleArmorWeightPerPoint(bar, supportVee.getArmorTechRating());</b>
<b class="nc">&nbsp;                if (perPoint &lt; 0.001) {</b>
<b class="nc">&nbsp;                    buff.append(&quot;BAR &quot;).append(bar).append(&quot; exceeds maximum for armor tech rating &quot;)</b>
<b class="nc">&nbsp;                            .append(ITechnology.getRatingName(supportVee.getArmorTechRating()))</b>
<b class="nc">&nbsp;                            .append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                    correct = false;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (supportVee instanceof VTOL) {</b>
<b class="nc">&nbsp;            if (!supportVee.hasWorkingMisc(MiscType.F_MAST_MOUNT)) {</b>
<b class="nc">&nbsp;                for (Mounted m : supportVee.getEquipment()) {</b>
<b class="nc">&nbsp;                    if (m.getLocation() == VTOL.LOC_ROTOR) {</b>
<b class="nc">&nbsp;                        buff.append(&quot;rotor equipment must be placed in mast mount&quot;);</b>
<b class="nc">&nbsp;                        correct = false;</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;            if (supportVee.getOArmor(VTOL.LOC_ROTOR) &gt; TestTank.VTOL_MAX_ROTOR_ARMOR) {</b>
<b class="nc">&nbsp;                buff.append(supportVee.getOArmor(VTOL.LOC_ROTOR));</b>
<b class="nc">&nbsp;                buff.append(&quot; points of VTOL rotor armor exceed &quot;);</b>
<b class="nc">&nbsp;                buff.append(TestTank.VTOL_MAX_ROTOR_ARMOR);</b>
<b class="nc">&nbsp;                buff.append(&quot;-point limit.\n\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        int hardpoints = 0;</b>
<b class="nc">&nbsp;        boolean sponson = false;</b>
<b class="nc">&nbsp;        boolean pintle = false;</b>
<b class="nc">&nbsp;        for (Mounted m : supportVee.getMisc()) {</b>
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_ARMORED_MOTIVE_SYSTEM)</b>
<b class="nc">&nbsp;                    &amp;&amp; (getEntity() instanceof Aero || getEntity() instanceof VTOL)) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Armored Motive system and incompatible movemement mode!\n\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
<b class="nc">&nbsp;            } else if (m.getType().hasFlag(MiscType.F_LIFEBOAT)</b>
<b class="nc">&nbsp;                    &amp;&amp; m.getType().hasSubType(MiscType.S_MARITIME_ESCAPE_POD | MiscType.S_MARITIME_LIFEBOAT)</b>
<b class="nc">&nbsp;                    &amp;&amp; !SVType.NAVAL.equals(SVType.getVehicleType(supportVee))</b>
<b class="nc">&nbsp;                    &amp;&amp; !supportVee.hasWorkingMisc(MiscType.F_AMPHIBIOUS)) {</b>
<b class="nc">&nbsp;                buff.append(m.getName()).append(&quot; requires naval support vehicle or amphibious chassis modification.\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
<b class="nc">&nbsp;            } else if (m.getType().hasFlag(MiscType.F_EXTERNAL_STORES_HARDPOINT)) {</b>
<b class="nc">&nbsp;                hardpoints++;</b>
<b class="nc">&nbsp;            } else if (m.getType().hasFlag(MiscType.F_SPONSON_TURRET)) {</b>
<b class="nc">&nbsp;                sponson = true;</b>
<b class="nc">&nbsp;            } else if (m.getType().hasFlag(MiscType.F_PINTLE_TURRET)) {</b>
<b class="nc">&nbsp;                pintle = true;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (hardpoints &gt; supportVee.getWeight() / 10.0) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Exceeds maximum of one external stores hardpoint per 10 tons.\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (sponson &amp;&amp; !canUseSponsonTurret()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Only medium and large surface vehicles can use a sponson turret.\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (sponson &amp;&amp; supportVee.getOriginalJumpMP() &gt; 0) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Cannot mount both jump jets and sponson turrets.\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (pintle &amp;&amp; !canUsePintleTurret()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Only small surface support vehicles can use a pintle turret.\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        double weaponWeight = 0.0;</b>
<b class="nc">&nbsp;        for (Mounted m : supportVee.getWeaponList()) {</b>
<b class="nc">&nbsp;            if (!isValidWeapon(m)) {</b>
<b class="nc">&nbsp;                buff.append(m.getType().getName()).append(&quot; is not a valid weapon for this unit.\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
&nbsp;            }
<b class="nc">&nbsp;            weaponWeight += m.getTonnage();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (supportVee.isOmni() &amp;&amp; (supportVee.hasWorkingMisc(MiscType.F_BASIC_FIRECONTROL)</b>
<b class="nc">&nbsp;                    || supportVee.hasWorkingMisc(MiscType.F_ADVANCED_FIRECONTROL))</b>
<b class="nc">&nbsp;                &amp;&amp; (weaponWeight / 10.0 &gt; supportVee.getBaseChassisFireConWeight())) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Omni configuration exceeds weapon capacity of base chassis fire control system.\n&quot;);</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Mounted m : supportVee.getEquipment()) {</b>
<b class="nc">&nbsp;            if ((m.getType() instanceof MiscType) &amp;&amp; !m.getType().hasFlag(MiscType.F_SUPPORT_TANK_EQUIPMENT)) {</b>
<b class="nc">&nbsp;                buff.append(m.getType().getName()).append(&quot; cannot be used by support vehicles.\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
<b class="nc">&nbsp;            } else if ((supportVee.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT)</b>
<b class="nc">&nbsp;                    &amp;&amp; (((m.getType() instanceof WeaponType)</b>
<b class="nc">&nbsp;                        &amp;&amp; !m.getType().hasFlag(WeaponType.F_INFANTRY))</b>
<b class="nc">&nbsp;                    || ((m.getType() instanceof MiscType) &amp;&amp; m.getType().hasFlag(MiscType.F_HEAVY_EQUIPMENT)))) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Small support vehicles cannot mount heavy weapons or equipment (&quot;)</b>
<b class="nc">&nbsp;                        .append(m.getName()).append(&quot;).\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
<b class="nc">&nbsp;            } else if ((m.getType() instanceof WeaponType)</b>
<b class="nc">&nbsp;                    &amp;&amp; (supportVee.getWeightClass() != EntityWeightClass.WEIGHT_SMALL_SUPPORT)</b>
<b class="nc">&nbsp;                    &amp;&amp; !m.getType().hasFlag(WeaponType.F_TANK_WEAPON)) {</b>
<b class="nc">&nbsp;                buff.append(m.getType().getName()).append(&quot; cannot be used by support vehicles.\n&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
<b class="nc">&nbsp;            } else if (!TestTank.legalForMotiveType(m.getType(), supportVee.getMovementMode(), true)) {</b>
<b class="nc">&nbsp;                buff.append(m.getType().getName()).append(&quot; is incompatible with &quot;)</b>
<b class="nc">&nbsp;                        .append(supportVee.getMovementModeAsString());</b>
<b class="nc">&nbsp;                correct = false;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; supportVee.locations(); loc++) {</b>
<b class="nc">&nbsp;            int count = 0;</b>
<b class="nc">&nbsp;            for (Mounted misc : supportVee.getMisc()) {</b>
<b class="nc">&nbsp;                if ((misc.getLocation() == loc) &amp;&amp; misc.getType().hasFlag(MiscType.F_MANIPULATOR)) {</b>
<b class="nc">&nbsp;                    count++;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (count &gt; 2) {</b>
<b class="nc">&nbsp;                buff.append(&quot;max of 2 manipulators per location&quot;);</b>
<b class="nc">&nbsp;                correct = false;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (supportVee.isAero() &amp;&amp; testAero.hasMismatchedLateralWeapons(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (hasIllegalChassisMods(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (hasInsufficientSeating(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (showFailedEquip() &amp;&amp; hasFailedEquipment(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (hasIllegalTechLevels(buff, ammoTechLvl)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (showIncorrectIntroYear() &amp;&amp; hasIncorrectIntroYear(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (hasIllegalEquipmentCombinations(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!correctCriticals(buff)) {</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return correct;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean hasIllegalEquipmentCombinations(StringBuffer buffer) {
<b class="nc">&nbsp;        boolean illegal = super.hasIllegalEquipmentCombinations(buffer);</b>
<b class="nc">&nbsp;        for (Mounted mounted : supportVee.getMisc()) {</b>
<b class="nc">&nbsp;            if (mounted.getType().hasFlag(MiscType.F_ARMORED_CHASSIS)</b>
<b class="nc">&nbsp;                    || mounted.getType().hasFlag(MiscType.F_AMPHIBIOUS)</b>
<b class="nc">&nbsp;                    || mounted.getType().hasFlag(MiscType.F_ENVIRONMENTAL_SEALING)</b>
<b class="nc">&nbsp;                    || mounted.getType().hasFlag(MiscType.F_SUBMERSIBLE)) {</b>
<b class="nc">&nbsp;                for (int loc = supportVee.firstArmorIndex(); loc &lt; supportVee.locations(); loc++) {</b>
&nbsp;                    // Tanks have the body location first. Aero SVs have it last, but also have the
&nbsp;                    // squadron wings location.
<b class="nc">&nbsp;                    if (supportVee.isAero() &amp;&amp; (loc &gt;= FixedWingSupport.LOC_WINGS)) {</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (supportVee.getOArmor(loc) == 0) {</b>
<b class="nc">&nbsp;                        buffer.append(mounted.getType().getName())</b>
<b class="nc">&nbsp;                                .append(&quot; requires at least one point of armor in every location.\n&quot;);</b>
<b class="nc">&nbsp;                        illegal = true;</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                break;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return illegal;</b>
&nbsp;    }
&nbsp;
&nbsp;    boolean hasIllegalChassisMods(StringBuffer buff) {
<b class="nc">&nbsp;        boolean illegal = false;</b>
<b class="nc">&nbsp;        final Set&lt;ChassisModification&gt; chassisMods = supportVee.getMisc().stream()</b>
<b class="nc">&nbsp;                .filter(m -&gt; m.getType().hasFlag(MiscType.F_CHASSIS_MODIFICATION))</b>
<b class="nc">&nbsp;                .map(m -&gt; ChassisModification.getChassisMod(m.getType()))</b>
<b class="nc">&nbsp;                .filter(Objects::nonNull).collect(Collectors.toSet());</b>
<b class="nc">&nbsp;        if (!chassisMods.contains(ChassisModification.ARMORED)) {</b>
<b class="nc">&nbsp;            if (!supportVee.hasBARArmor(supportVee.firstArmorIndex())) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Advanced armor requires the Armored Chassis Mod.\n&quot;);</b>
<b class="nc">&nbsp;                illegal = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (EquipmentType.getSupportVehicleArmorWeightPerPoint(</b>
<b class="nc">&nbsp;                    supportVee.getBARRating(supportVee.firstArmorIndex()),</b>
<b class="nc">&nbsp;                            supportVee.getArmorTechRating()) &gt; 0.05) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Armor heavier than 50kg/point requires the Armored Chassis Mod.\n&quot;);</b>
<b class="nc">&nbsp;                illegal = true;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (supportVee.isAero() &amp;&amp; SVEngine.getEngineType(supportVee.getEngine()).electric</b>
<b class="nc">&nbsp;                &amp;&amp; !chassisMods.contains(ChassisModification.PROP)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Fixed Wing and Airship support vehicles with electric engines requires the Prop Chassis Mod.\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((supportVee.getEngine().getEngineType() == Engine.EXTERNAL)</b>
<b class="nc">&nbsp;                &amp;&amp; !chassisMods.contains(ChassisModification.EXTERNAL_POWER_PICKUP)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;An external engine requires the External Power Pickup Chassis Mod.\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (chassisMods.contains(ChassisModification.HYDROFOIL)</b>
<b class="nc">&nbsp;                &amp;&amp; (supportVee.getWeight() &gt; 100.0)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;The Hydrofoil Chassis Mod may not be used on naval support vehicles larger than 100 tons.\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (chassisMods.contains(ChassisModification.CONVERTIBLE)</b>
<b class="nc">&nbsp;                &amp;&amp; (supportVee instanceof Tank) &amp;&amp; !((Tank) supportVee).hasNoTurret()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;The Convertible Chassis Mod may not be used with a turret.\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        for (ChassisModification mod : chassisMods) {</b>
<b class="nc">&nbsp;            if (!mod.allowedTypes.contains(SVType.getVehicleType(supportVee))) {</b>
<b class="nc">&nbsp;                buff.append(mod.equipment.getName())</b>
<b class="nc">&nbsp;                        .append(&quot; is not valid for &quot;)</b>
<b class="nc">&nbsp;                        .append(supportVee.getMovementModeAsString())</b>
<b class="nc">&nbsp;                        .append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                illegal = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mod.smallOnly &amp;&amp; (supportVee.getWeightClass() != EntityWeightClass.WEIGHT_SMALL_SUPPORT)) {</b>
<b class="nc">&nbsp;                buff.append(mod.equipment.getName())</b>
<b class="nc">&nbsp;                        .append(&quot; is only valid with small support vehicles.\n&quot;);</b>
<b class="nc">&nbsp;                illegal = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!mod.validFor(supportVee)) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Incompatible chassis mod: &quot;)</b>
<b class="nc">&nbsp;                        .append(mod.equipment.getName())</b>
<b class="nc">&nbsp;                        .append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                illegal = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            for (ChassisModification mod2 : chassisMods) {</b>
&nbsp;                // Only compare to mods with higher ordinals to make sure each combination
&nbsp;                // only gets checked once.
<b class="nc">&nbsp;                if ((mod2.ordinal() &gt; mod.ordinal())</b>
<b class="nc">&nbsp;                        &amp;&amp; !mod.compatibleWith(mod2)) {</b>
<b class="nc">&nbsp;                    buff.append(mod.equipment.getName())</b>
<b class="nc">&nbsp;                            .append(&quot; is incompatible with &quot;)</b>
<b class="nc">&nbsp;                            .append(mod2.equipment.getName())</b>
<b class="nc">&nbsp;                            .append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                    illegal = true;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return illegal;</b>
&nbsp;    }
&nbsp;
&nbsp;    boolean hasInsufficientSeating(StringBuffer buff) {
&nbsp;        // Small SVs are required to provide seating for all crew. M/L have
&nbsp;        // seating provided as part of the structure.
<b class="nc">&nbsp;        if (supportVee.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
<b class="nc">&nbsp;            int minCrew = Compute.getFullCrewSize(supportVee);</b>
&nbsp;            // Pillion and ejection seating are subclasses of StandardSeatCargoBay
<b class="nc">&nbsp;            int seating = supportVee.getTransports().stream()</b>
<b class="nc">&nbsp;                    .filter(t -&gt; t instanceof StandardSeatCargoBay)</b>
<b class="nc">&nbsp;                    .mapToInt(t -&gt; (int) ((Bay) t).getCapacity())</b>
<b class="nc">&nbsp;                    .sum();</b>
<b class="nc">&nbsp;            if (seating &lt; minCrew) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Minimum crew is &quot;).append(minCrew)</b>
<b class="nc">&nbsp;                        .append(&quot; but there is only seating for &quot;)</b>
<b class="nc">&nbsp;                        .append(seating).append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isValidWeapon(Mounted weapon) {
<b class="nc">&nbsp;        if (supportVee.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
<b class="nc">&nbsp;            return weapon.getType().hasFlag(WeaponType.F_INFANTRY)</b>
<b class="nc">&nbsp;                    &amp;&amp; !weapon.getType().hasFlag(WeaponType.F_INFANTRY_ONLY);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return weapon.getType().hasFlag(WeaponType.F_TANK_WEAPON);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public boolean correctCriticals(StringBuffer buff) {
<b class="nc">&nbsp;        List&lt;Mounted&gt; unallocated = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        boolean correct = true;</b>
&nbsp;
<b class="nc">&nbsp;        for (Mounted mount : supportVee.getMisc()) {</b>
<b class="nc">&nbsp;            if ((mount.getLocation() == Entity.LOC_NONE)</b>
<b class="nc">&nbsp;                    &amp;&amp; (mount.getType().getSupportVeeSlots(supportVee) != 0)) {</b>
<b class="nc">&nbsp;                unallocated.add(mount);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        for (Mounted mount : supportVee.getWeaponList()) {</b>
<b class="nc">&nbsp;            if (mount.getLocation() == Entity.LOC_NONE) {</b>
<b class="nc">&nbsp;                unallocated.add(mount);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (supportVee.getWeightClass() != EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
<b class="nc">&nbsp;            for (Mounted mount : supportVee.getAmmo()) {</b>
<b class="nc">&nbsp;                if ((mount.getLocation() == Entity.LOC_NONE) &amp;&amp;</b>
<b class="nc">&nbsp;                        !mount.isOneShotAmmo()) {</b>
<b class="nc">&nbsp;                    unallocated.add(mount);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!unallocated.isEmpty()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Unallocated Equipment:\n&quot;);</b>
<b class="nc">&nbsp;            for (Mounted mount : unallocated) {</b>
<b class="nc">&nbsp;                buff.append(mount.getType().getInternalName()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            correct = false;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return correct;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public StringBuffer printEntity() {
<b class="nc">&nbsp;        StringBuffer buff = new StringBuffer();</b>
<b class="nc">&nbsp;        buff.append(getName()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        buff.append(&quot;Found in: &quot;).append(fileString).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        buff.append(printTechLevel());</b>
<b class="nc">&nbsp;        buff.append(&quot;Intro year: &quot;).append(supportVee.getYear()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        buff.append(printSource());</b>
<b class="nc">&nbsp;        buff.append(printShortMovement());</b>
<b class="nc">&nbsp;        if (correctWeight(buff, true, true)) {</b>
<b class="nc">&nbsp;            if (!usesKgStandard()) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Weight: &quot;).append(getWeight()).append(&quot; (&quot;)</b>
<b class="nc">&nbsp;                        .append(calculateWeight()).append(&quot;)\n&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                buff.append(&quot;Weight: &quot;).append(getWeight() * 1000).append(&quot; kg (&quot;)</b>
<b class="nc">&nbsp;                        .append(calculateWeight() * 1000).append(&quot; kg)\n&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        buff.append(printWeightCalculation()).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        printFailedEquipment(buff);</b>
<b class="nc">&nbsp;        return buff;</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printSlotCalculation() {
<b class="nc">&nbsp;        StringBuffer buff = new StringBuffer();</b>
<b class="nc">&nbsp;        buff.append(&quot;Available slots: &quot;).append(totalSlotCount()).append(&quot;\n&quot;);</b>
&nbsp;        // different engines take different amounts of slots
&nbsp;
&nbsp;        // JJs take just 1 slot
<b class="nc">&nbsp;        if (supportVee.getJumpMP(false) &gt; 0) {</b>
<b class="nc">&nbsp;            buff.append(StringUtil.makeLength(&quot;Jump Jets&quot;, 30)).append(&quot;1\n&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        boolean addedCargo = false;</b>
<b class="nc">&nbsp;        for (Mounted mount : supportVee.getEquipment()) {</b>
<b class="nc">&nbsp;            if ((mount.getType() instanceof MiscType)</b>
<b class="nc">&nbsp;                    &amp;&amp; mount.getType().hasFlag(MiscType.F_CARGO)) {</b>
<b class="nc">&nbsp;                if (!addedCargo) {</b>
<b class="nc">&nbsp;                    buff.append(StringUtil.makeLength(mount.getName(), 30));</b>
<b class="nc">&nbsp;                    buff.append(mount.getType().getSupportVeeSlots(supportVee)).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                    addedCargo = true;</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                } else {
&nbsp;                    continue;
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!(mount.getType() instanceof AmmoType)</b>
<b class="nc">&nbsp;                    &amp;&amp; (EquipmentType.getArmorType(mount.getType()) == EquipmentType.T_ARMOR_UNKNOWN)</b>
<b class="nc">&nbsp;                    &amp;&amp; !mount.getType().hasFlag(MiscType.F_JUMP_JET)) {</b>
<b class="nc">&nbsp;                buff.append(StringUtil.makeLength(mount.getName(), 30));</b>
<b class="nc">&nbsp;                buff.append(mount.getType().getSupportVeeSlots(supportVee)).append(&quot;\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (getCrewSlots() &gt; 0) {</b>
<b class="nc">&nbsp;            buff.append(StringUtil.makeLength(&quot;Crew Seats/Quarters:&quot;, 30));</b>
<b class="nc">&nbsp;            buff.append(getCrewSlots()).append(&quot;\n&quot;);</b>
&nbsp;        }
&nbsp;        // different armor types take different amount of slots
<b class="nc">&nbsp;        int armorSlots = 0;</b>
<b class="nc">&nbsp;        if (!supportVee.hasPatchworkArmor()) {</b>
<b class="nc">&nbsp;            int at = supportVee.getArmorType(supportVee.firstArmorIndex());</b>
<b class="nc">&nbsp;            if (at == EquipmentType.T_ARMOR_STANDARD) {</b>
&nbsp;                // Support vehicle armor takes slots like ferro-fibrous at BAR 10/TL E/F
<b class="nc">&nbsp;                if (supportVee.getBARRating(supportVee.firstArmorIndex()) == 10) {</b>
<b class="nc">&nbsp;                    if (supportVee.getArmorTechRating() == ITechnology.RATING_E) {</b>
<b class="nc">&nbsp;                        armorSlots += AdvancedSVArmor.FERRO_FIBROUS.space;</b>
<b class="nc">&nbsp;                    } else if (supportVee.getArmorTechRating() == ITechnology.RATING_F) {</b>
<b class="nc">&nbsp;                        armorSlots += AdvancedSVArmor.CLAN_FERRO_FIBROUS.space;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                AdvancedSVArmor armor = AdvancedSVArmor.getArmor(at,</b>
<b class="nc">&nbsp;                        TechConstants.isClan(supportVee.getArmorTechLevel(supportVee.firstArmorIndex())));</b>
<b class="nc">&nbsp;                if (null != armor) {</b>
<b class="nc">&nbsp;                    armorSlots += armor.space;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;            for (int loc = 0; loc &lt; supportVee.locations(); loc++) {</b>
<b class="nc">&nbsp;                AdvancedSVArmor armor = AdvancedSVArmor.getArmor(supportVee.getArmorType(loc),</b>
<b class="nc">&nbsp;                        TechConstants.isClan(supportVee.getArmorTechLevel(loc)));</b>
<b class="nc">&nbsp;                if (null != armor) {</b>
<b class="nc">&nbsp;                    armorSlots += armor.patchworkSpace;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (armorSlots != 0) {</b>
<b class="nc">&nbsp;            buff.append(StringUtil.makeLength(&quot;Armor&quot;, 30));</b>
<b class="nc">&nbsp;            buff.append(armorSlots).append(&quot;\n&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        // for ammo, each type of ammo takes one slots, regardless of
&nbsp;        // submunition type
<b class="nc">&nbsp;        Set&lt;String&gt; foundAmmo = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        for (Mounted ammo : supportVee.getAmmo()) {</b>
<b class="nc">&nbsp;            if (ammo.isOneShotAmmo()) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            AmmoType at = (AmmoType) ammo.getType();</b>
<b class="nc">&nbsp;            if (!foundAmmo.contains(at.getAmmoType() + &quot;:&quot; + at.getRackSize())) {</b>
<b class="nc">&nbsp;                buff.append(StringUtil.makeLength(at.getName(), 30));</b>
<b class="nc">&nbsp;                buff.append(&quot;1\n&quot;);</b>
<b class="nc">&nbsp;                foundAmmo.add(at.getAmmoType() + &quot;:&quot; + at.getRackSize());</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // if a tank has an infantry bay, add 1 slots (multiple bays take 1 slot
&nbsp;        // total)
<b class="nc">&nbsp;        boolean troopspaceFound = false;</b>
<b class="nc">&nbsp;        for (Transporter transport : supportVee.getTransports()) {</b>
<b class="nc">&nbsp;            if ((transport instanceof TroopSpace) &amp;&amp; !troopspaceFound) {</b>
<b class="nc">&nbsp;                buff.append(StringUtil.makeLength(&quot;Troop Space&quot;, 30));</b>
<b class="nc">&nbsp;                buff.append(&quot;1\n&quot;);</b>
<b class="nc">&nbsp;                troopspaceFound = true;</b>
<b class="nc">&nbsp;            } else if ((transport instanceof Bay) &amp;&amp; !((Bay) transport).isQuarters()) {</b>
<b class="nc">&nbsp;                buff.append(StringUtil.makeLength(((Bay) transport).getType(), 30))</b>
<b class="nc">&nbsp;                        .append(&quot;1\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return buff;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getName() {
<b class="nc">&nbsp;        return &quot;Support Vehicle: &quot; + supportVee.getDisplayName();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getWeightArmor() {
<b class="nc">&nbsp;        return supportVee.getArmorWeight();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return   The total slot space
&nbsp;     */
&nbsp;    public int totalSlotCount() {
<b class="nc">&nbsp;        return 5 + (int) Math.floor(supportVee.getWeight() / 10.0);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return The number of slots taken up by installed equipment
&nbsp;     */
&nbsp;    public int occupiedSlotCount() {
<b class="nc">&nbsp;        return getCrewSlots() + getArmorSlots() + getAmmoSlots()</b>
<b class="nc">&nbsp;                + getWeaponSlots() + getMiscEquipSlots() + getTransportSlots();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return The number of slots taken up by armor
&nbsp;     */
&nbsp;    public int getArmorSlots() {
<b class="nc">&nbsp;        if (!supportVee.hasPatchworkArmor()) {</b>
<b class="nc">&nbsp;            int at = supportVee.getArmorType(supportVee.firstArmorIndex());</b>
<b class="nc">&nbsp;            if (at == EquipmentType.T_ARMOR_STANDARD) {</b>
&nbsp;                // Support vehicle armor takes slots like ferro-fibrous at BAR 10/TL E/F
<b class="nc">&nbsp;                if (supportVee.getBARRating(supportVee.firstArmorIndex()) == 10) {</b>
<b class="nc">&nbsp;                    if (supportVee.getArmorTechRating() == ITechnology.RATING_E) {</b>
<b class="nc">&nbsp;                        return AdvancedSVArmor.FERRO_FIBROUS.space;</b>
<b class="nc">&nbsp;                    } else if (supportVee.getArmorTechRating() == ITechnology.RATING_F) {</b>
<b class="nc">&nbsp;                        return AdvancedSVArmor.CLAN_FERRO_FIBROUS.space;</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                return 0;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                AdvancedSVArmor armor = AdvancedSVArmor.getArmor(at,</b>
<b class="nc">&nbsp;                        TechConstants.isClan(supportVee.getArmorTechLevel(supportVee.firstArmorIndex())));</b>
<b class="nc">&nbsp;                if (null != armor) {</b>
<b class="nc">&nbsp;                    return armor.space;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return 0;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            int space = 0;</b>
<b class="nc">&nbsp;            for (int loc = 0; loc &lt; supportVee.locations(); loc++) {</b>
<b class="nc">&nbsp;                AdvancedSVArmor armor = AdvancedSVArmor.getArmor(supportVee.getArmorType(loc),</b>
<b class="nc">&nbsp;                        TechConstants.isClan(supportVee.getArmorTechLevel(loc)));</b>
<b class="nc">&nbsp;                if (null != armor) {</b>
<b class="nc">&nbsp;                    space += armor.patchworkSpace;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return space;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return The number of slots taken up by weapons
&nbsp;     */
&nbsp;    public int getWeaponSlots() {
<b class="nc">&nbsp;        int slots = 0;</b>
<b class="nc">&nbsp;        for (Mounted m : supportVee.getWeaponList()) {</b>
<b class="nc">&nbsp;            slots += m.getType().getSupportVeeSlots(supportVee);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return slots;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return The number of slots taken up by ammo.
&nbsp;     */
&nbsp;    public int getAmmoSlots() {
&nbsp;        // Small SV ammo occupies the same slot as the weapon.
<b class="nc">&nbsp;        if (supportVee.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
<b class="nc">&nbsp;        int slots = 0;</b>
<b class="nc">&nbsp;        Set&lt;String&gt; foundAmmo = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        for (Mounted ammo : supportVee.getAmmo()) {</b>
&nbsp;            // don&#39;t count oneshot
<b class="nc">&nbsp;            if (ammo.isOneShotAmmo()) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            AmmoType at = (AmmoType) ammo.getType();</b>
<b class="nc">&nbsp;            if (!foundAmmo.contains(at.getAmmoType() + &quot;:&quot; + at.getRackSize())) {</b>
<b class="nc">&nbsp;                slots++;</b>
<b class="nc">&nbsp;                foundAmmo.add(at.getAmmoType() + &quot;:&quot; + at.getRackSize());</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return slots;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return The number of slots taken by miscellaneous equipment.
&nbsp;     */
&nbsp;    public int getMiscEquipSlots() {
<b class="nc">&nbsp;        int slots = 0;</b>
<b class="nc">&nbsp;        for (Mounted m : supportVee.getMisc()) {</b>
&nbsp;            // Skip armor and jump jets
<b class="nc">&nbsp;            if ((EquipmentType.getArmorType(m.getType()) == EquipmentType.T_ARMOR_UNKNOWN)</b>
<b class="nc">&nbsp;                    &amp;&amp; !m.getType().hasFlag(MiscType.F_JUMP_JET)) {</b>
<b class="nc">&nbsp;                slots += m.getType().getSupportVeeSlots(supportVee);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // Jump jets take a single slot regardless of the number.
<b class="nc">&nbsp;        if (supportVee.hasWorkingMisc(MiscType.F_JUMP_JET)) {</b>
<b class="nc">&nbsp;            slots++;</b>
&nbsp;        }
<b class="nc">&nbsp;        return slots;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static final int INDEX_FIRST_CLASS = 0;
&nbsp;    public static final int INDEX_SECOND_CLASS = 1;
&nbsp;    public static final int INDEX_STD_CREW = 2;
&nbsp;    public static final int INDEX_STEERAGE = 3;
&nbsp;    /**
&nbsp;     * Calculates capacity of quarters above the minimum crew requirement. Only quarters above the minimum
&nbsp;     * crew requirement take up equipment slots. Second class quarters are considered passenger accomodations
&nbsp;     * and always count toward slots. Others are assigned to the least bulky type first.
&nbsp;     *
&nbsp;     * @param sv A support vehicle
&nbsp;     * @return   An array of the count of each type of quarters that require slots. See INDEX_* constants for
&nbsp;     *           indices.
&nbsp;     */
&nbsp;    public static int[] extraCrewQuartersCount(Entity sv) {
<b class="nc">&nbsp;        int firstClass = 0;</b>
<b class="nc">&nbsp;        int stdCrew = 0;</b>
<b class="nc">&nbsp;        int steerage = 0;</b>
<b class="nc">&nbsp;        int[] retVal = { 0, 0, 0, 0 };</b>
<b class="nc">&nbsp;        for (Transporter t : sv.getTransports()) {</b>
<b class="nc">&nbsp;            if (t instanceof FirstClassQuartersCargoBay) {</b>
<b class="nc">&nbsp;                firstClass += ((Bay) t).getCapacity();</b>
<b class="nc">&nbsp;            } else if (t instanceof SecondClassQuartersCargoBay) {</b>
<b class="nc">&nbsp;                retVal[INDEX_SECOND_CLASS] += ((Bay) t).getCapacity();</b>
<b class="nc">&nbsp;            } else if (t instanceof CrewQuartersCargoBay) {</b>
<b class="nc">&nbsp;                stdCrew += ((Bay) t).getCapacity();</b>
<b class="nc">&nbsp;            } else if (t instanceof SteerageQuartersCargoBay) {</b>
<b class="nc">&nbsp;                steerage += ((Bay) t).getCapacity();</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        int extraCrew = firstClass + stdCrew + steerage - Compute.getFullCrewSize(sv);</b>
<b class="nc">&nbsp;        if ((extraCrew &gt; 0) &amp;&amp; (steerage &gt; 0)) {</b>
<b class="nc">&nbsp;            retVal[INDEX_STEERAGE] = Math.min(extraCrew, steerage);</b>
<b class="nc">&nbsp;            extraCrew -= retVal[INDEX_STEERAGE];</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((extraCrew &gt; 0) &amp;&amp; (stdCrew &gt; 0)) {</b>
<b class="nc">&nbsp;            retVal[INDEX_STD_CREW] = Math.min(extraCrew, stdCrew);</b>
<b class="nc">&nbsp;            extraCrew -= retVal[INDEX_STD_CREW];</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((extraCrew &gt; 0) &amp;&amp; (firstClass &gt; 0)) {</b>
<b class="nc">&nbsp;            retVal[INDEX_FIRST_CLASS] = Math.min(extraCrew, firstClass);</b>
&nbsp;        }
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Calculates the number of equipment slots taken up by crew quarters. Quarters for minimum crew
&nbsp;     * do not take up slots.
&nbsp;     *
&nbsp;     * @return The number of equipment slots required by crew quarters.
&nbsp;     */
&nbsp;    public int getCrewSlots() {
<b class="nc">&nbsp;        int[] excess = extraCrewQuartersCount(getEntity());</b>
<b class="nc">&nbsp;        return (int) Math.ceil(excess[INDEX_FIRST_CLASS] / 5.0)</b>
<b class="nc">&nbsp;                + (int) Math.ceil(excess[INDEX_SECOND_CLASS] / 20.0)</b>
<b class="nc">&nbsp;                + (int) Math.ceil(excess[INDEX_STD_CREW] / 20.0)</b>
<b class="nc">&nbsp;                + (int) Math.ceil(excess[INDEX_STEERAGE] / 50.0);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Each distinct bay requires a slot, regardless of size. All {@link TroopSpace} is treated as a single
&nbsp;     * bay.
&nbsp;     *
&nbsp;     * @return The number of slots required by transporters.
&nbsp;     */
&nbsp;    public int getTransportSlots() {
<b class="nc">&nbsp;        int slots = 0;</b>
<b class="nc">&nbsp;        boolean foundTroopSpace = false;</b>
<b class="nc">&nbsp;        for (Transporter t : supportVee.getTransports()) {</b>
<b class="nc">&nbsp;            if ((t instanceof Bay) &amp;&amp; !((Bay) t).isQuarters()) {</b>
<b class="nc">&nbsp;                slots++;</b>
<b class="nc">&nbsp;            } else if ((t instanceof TroopSpace) &amp;&amp; !foundTroopSpace) {</b>
<b class="nc">&nbsp;                slots++;</b>
<b class="nc">&nbsp;                foundTroopSpace = true;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return slots;</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public enum AdvancedSVArmor {</b>
<b class="nc">&nbsp;        CLAN_FERRO_FIBROUS(EquipmentType.T_ARMOR_FERRO_FIBROUS, 1, 1, true),</b>
<b class="nc">&nbsp;        CLAN_FERRO_ALUM(EquipmentType.T_ARMOR_ALUM, 1, 1, true),</b>
<b class="nc">&nbsp;        FERRO_LAMELLOR(EquipmentType.T_ARMOR_FERRO_LAMELLOR, 2, 1, true),</b>
<b class="nc">&nbsp;        CLAN_REACTIVE(EquipmentType.T_ARMOR_REACTIVE, 1, 1, true),</b>
<b class="nc">&nbsp;        CLAN_REFLECTIVE(EquipmentType.T_ARMOR_REFLECTIVE, 1, 1, true),</b>
<b class="nc">&nbsp;        ANTI_PENETRATIVE_ABLATION(</b>
&nbsp;                EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION, 1, 1, false),
<b class="nc">&nbsp;        BALLISTIC_REINFORCED(</b>
&nbsp;                EquipmentType.T_ARMOR_BALLISTIC_REINFORCED, 2, 1, false),
<b class="nc">&nbsp;        FERRO_FIBROUS(EquipmentType.T_ARMOR_ALUM, 2, 1, false),</b>
<b class="nc">&nbsp;        FERRO_ALUM(EquipmentType.T_ARMOR_ALUM, 2, 1, false),</b>
<b class="nc">&nbsp;        FERRO_FIBROUS_PROTO(EquipmentType.T_ARMOR_FERRO_FIBROUS_PROTO, 3, 1, false),</b>
<b class="nc">&nbsp;        FERRO__ALUM_PROTO(EquipmentType.T_ARMOR_FERRO_ALUM_PROTO, 3, 1, false),</b>
<b class="nc">&nbsp;        HEAVY_FERRO_FIBROUS(EquipmentType.T_ARMOR_HEAVY_FERRO, 4, 2, false),</b>
<b class="nc">&nbsp;        LIGHT_FERRO_FIBROUS(EquipmentType.T_ARMOR_LIGHT_FERRO, 1, 1, false),</b>
<b class="nc">&nbsp;        HEAVY_FERRO_ALUM(EquipmentType.T_ARMOR_HEAVY_ALUM, 4, 2, false),</b>
<b class="nc">&nbsp;        LIGHT_FERRO_ALUM(EquipmentType.T_ARMOR_LIGHT_ALUM, 1, 1, false),</b>
<b class="nc">&nbsp;        PRIMITIVE(EquipmentType.T_ARMOR_PRIMITIVE_FIGHTER, 0, 0, false),</b>
<b class="nc">&nbsp;        REACTIVE(EquipmentType.T_ARMOR_REACTIVE, 3, 1, false),</b>
<b class="nc">&nbsp;        REFLECTIVE(EquipmentType.T_ARMOR_REFLECTIVE, 2, 1, false),</b>
<b class="nc">&nbsp;        STEALTH_VEHICLE(EquipmentType.T_ARMOR_STEALTH_VEHICLE, 2, 1, false);</b>
&nbsp;
&nbsp;        public final int armorType;
&nbsp;        /**
&nbsp;         * The type, corresponding to types defined in
&nbsp;         * &lt;code&gt;EquipmentType&lt;/code&gt;.
&nbsp;         */
&nbsp;        public final EquipmentType eqType;
&nbsp;
&nbsp;        /**
&nbsp;         * The number of spaces occupied by the armor type.
&nbsp;         */
&nbsp;        public final int space;
&nbsp;
&nbsp;        /**
&nbsp;         * The number of weapon spaces occupied by patchwork armor.
&nbsp;         */
&nbsp;        public final int patchworkSpace;
&nbsp;
&nbsp;        /**
&nbsp;         * Denotes whether this armor is Clan or not.
&nbsp;         */
&nbsp;        public final boolean isClan;
&nbsp;
<b class="nc">&nbsp;        AdvancedSVArmor(int at, int space, int patchworkSpace, boolean clan){</b>
<b class="nc">&nbsp;            this.armorType = at;</b>
<b class="nc">&nbsp;            eqType = EquipmentType.get(EquipmentType.getArmorTypeName(at, clan));</b>
<b class="nc">&nbsp;            this.space = space;</b>
<b class="nc">&nbsp;            this.patchworkSpace = patchworkSpace;</b>
<b class="nc">&nbsp;            isClan = clan;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Given an armor type, return the &lt;code&gt;AdvancedSVArmor&lt;/code&gt; instance that
&nbsp;         * represents that type.
&nbsp;         *
&nbsp;         * @param at The armor type.
&nbsp;         * @param c  Whether this armor type is Clan or not.
&nbsp;         * @return   The &lt;code&gt;AdvancedSVArmor&lt;/code&gt; that correspondes to the given
&nbsp;         *              type or null if no match was found.
&nbsp;         */
&nbsp;        public static @Nullable AdvancedSVArmor getArmor(int at, boolean c){
<b class="nc">&nbsp;            for (AdvancedSVArmor a : values()){</b>
<b class="nc">&nbsp;                if ((a.armorType == at) &amp;&amp; (a.isClan == c)) {</b>
<b class="nc">&nbsp;                    return a;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
