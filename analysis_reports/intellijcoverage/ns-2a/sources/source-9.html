


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > TestEntity</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.common.verifier</a>
</div>

<h1>Coverage Summary for Class: TestEntity (megamek.common.verifier)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TestEntity</td>
<td class="coverageStat">
  <span class="percent">
    20.5%
  </span>
  <span class="absValue">
    (18/88)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    7.6%
  </span>
  <span class="absValue">
    (72/943)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TestEntity$Ceil</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (5/5)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    22.2%
  </span>
  <span class="absValue">
    (20/90)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    8.1%
  </span>
  <span class="absValue">
    (77/948)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaMek -
&nbsp; * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;
&nbsp;/*
&nbsp; * Author: Reinhard Vicinus
&nbsp; */
&nbsp;
&nbsp;package megamek.common.verifier;
&nbsp;
&nbsp;import java.text.DecimalFormat;
&nbsp;import java.util.*;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import megamek.common.*;
&nbsp;import megamek.common.annotations.Nullable;
&nbsp;import megamek.common.util.StringUtil;
&nbsp;
&nbsp;/**
&nbsp; * Abstract parent class for testing and validating instantiations of &lt;code&gt;
&nbsp; * Entity&lt;/code&gt; subclasses.
&nbsp; *
&nbsp; */
&nbsp;public abstract class TestEntity implements TestEntityOption {
<b class="fc">&nbsp;    public static enum Ceil {</b>
<b class="fc">&nbsp;        TON(1.0), HALFTON(2.0), QUARTERTON(4.0), TENTHTON(10.0), KILO(1000.0);</b>
&nbsp;        
&nbsp;        public final double mult;
&nbsp;        
<b class="fc">&nbsp;        private Ceil(double mult) {</b>
<b class="fc">&nbsp;            this.mult = mult;</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;    
<b class="fc">&nbsp;    protected Engine engine = null;</b>
<b class="fc">&nbsp;    protected Armor[] armor = null;</b>
<b class="fc">&nbsp;    protected Structure structure = null;</b>
<b class="fc">&nbsp;    private TestEntityOption options = null;</b>
&nbsp;
&nbsp;    public abstract Entity getEntity();
&nbsp;
&nbsp;    public abstract boolean isTank();
&nbsp;
&nbsp;    public abstract boolean isMech();
&nbsp;
&nbsp;    public abstract boolean isAero();
&nbsp;    
&nbsp;    public abstract boolean isSmallCraft();
&nbsp;    
&nbsp;    public abstract boolean isAdvancedAerospace();
&nbsp;    
&nbsp;    public abstract boolean isProtomech();
&nbsp;
&nbsp;    public abstract double getWeightControls();
&nbsp;
&nbsp;    public abstract double getWeightMisc();
&nbsp;
&nbsp;    public abstract double getWeightHeatSinks();
&nbsp;
&nbsp;    public abstract boolean hasDoubleHeatSinks();
&nbsp;
&nbsp;    public abstract int getCountHeatSinks();
&nbsp;
&nbsp;    public abstract String printWeightMisc();
&nbsp;
&nbsp;    public abstract String printWeightControls();
&nbsp;
&nbsp;    public abstract boolean correctEntity(StringBuffer buff);
&nbsp;
&nbsp;    public abstract boolean correctEntity(StringBuffer buff, int ammoTechLvl);
&nbsp;
&nbsp;    public abstract StringBuffer printEntity();
&nbsp;
&nbsp;    public abstract String getName();
&nbsp;
<b class="fc">&nbsp;    public String fileString = null; // where the unit came from</b>
&nbsp;
&nbsp;    public TestEntity(TestEntityOption options, Engine engine, Armor[] armor,
<b class="fc">&nbsp;            Structure structure) {</b>
<b class="fc">&nbsp;        this.options = options;</b>
<b class="fc">&nbsp;        this.engine = engine;</b>
<b class="fc">&nbsp;        this.armor = armor;</b>
<b class="fc">&nbsp;        this.structure = structure;</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    public boolean isClan() {
<b class="nc">&nbsp;        return getEntity().isClan();</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isClanArmor() {
<b class="nc">&nbsp;        return getEntity().isClanArmor(0) &amp;&amp; !getEntity().hasPatchworkArmor();</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeight() {
<b class="fc">&nbsp;        return getEntity().getWeight();</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getTotalOArmor() {
<b class="nc">&nbsp;        return getEntity().getTotalOArmor();</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getLocationAbbr(int location) {
<b class="nc">&nbsp;        return getEntity().getLocationAbbr(location);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingEngine() {
<b class="nc">&nbsp;        return options.getWeightCeilingEngine();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingStructure() {
<b class="nc">&nbsp;        return options.getWeightCeilingStructure();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingArmor() {
<b class="nc">&nbsp;        return options.getWeightCeilingArmor();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingControls() {
<b class="nc">&nbsp;        return options.getWeightCeilingControls();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingWeapons() {
<b class="nc">&nbsp;        return options.getWeightCeilingWeapons();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingTargComp() {
<b class="nc">&nbsp;        return options.getWeightCeilingTargComp();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingGyro() {
<b class="nc">&nbsp;        return options.getWeightCeilingGyro();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingTurret() {
<b class="nc">&nbsp;        return options.getWeightCeilingTurret();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingLifting() {
<b class="nc">&nbsp;        return options.getWeightCeilingLifting();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Ceil getWeightCeilingPowerAmp() {
<b class="nc">&nbsp;        return options.getWeightCeilingPowerAmp();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getMaxOverweight() {
<b class="fc">&nbsp;        return options.getMaxOverweight();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean showOverweightedEntity() {
<b class="fc">&nbsp;        return options.showOverweightedEntity();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getMinUnderweight() {
<b class="nc">&nbsp;        return options.getMinUnderweight();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean showUnderweightedEntity() {
<b class="fc">&nbsp;        return options.showUnderweightedEntity();</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean showCorrectArmor() {
<b class="nc">&nbsp;        return options.showCorrectArmor();</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean showCorrectCritical() {
<b class="nc">&nbsp;        return options.showCorrectCritical();</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean showFailedEquip() {
<b class="nc">&nbsp;        return options.showFailedEquip();</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean ignoreFailedEquip(String name) {
<b class="nc">&nbsp;        return options.ignoreFailedEquip(name);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public boolean showIncorrectIntroYear() {
<b class="nc">&nbsp;        return options.showIncorrectIntroYear();</b>
&nbsp;    }
&nbsp;    
&nbsp;    public int getIntroYearMargin() {
<b class="nc">&nbsp;        return options.getIntroYearMargin();</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean skip() {
<b class="nc">&nbsp;        return options.skip();</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getTargCompCrits() {
<b class="nc">&nbsp;        return options.getTargCompCrits();</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getPrintSize() {
<b class="nc">&nbsp;        return options.getPrintSize();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Used to round values up based on the specified type.
&nbsp;     *
&nbsp;     * @param f     Value to round
&nbsp;     * @param type  Specifies the number of decimals to round to, see
&nbsp;     *              TestEntity.CEIL_TON, etc.
&nbsp;     * @return      Rounded value
&nbsp;     */
&nbsp;    public static double ceil(double f, Ceil type) {
<b class="fc">&nbsp;        return Math.ceil(f * type.mult) / type.mult;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static double ceilMaxHalf(double f, Ceil type) {
<b class="nc">&nbsp;        if (type == Ceil.TON) {</b>
<b class="nc">&nbsp;            return TestEntity.ceil(f, Ceil.HALFTON);</b>
&nbsp;        }
<b class="nc">&nbsp;        return TestEntity.ceil(f, type);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static double floor(double f, Ceil type) {
<b class="nc">&nbsp;        return Math.floor(f * type.mult) / type.mult;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static double round(double f, Ceil type) {
<b class="fc">&nbsp;        return Math.round(f * type.mult) / type.mult;</b>
&nbsp;    }
&nbsp;
&nbsp;    static String makeWeightString(double weight) {
<b class="nc">&nbsp;        return makeWeightString(weight, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    static String makeWeightString(double weight, boolean kg) {
<b class="nc">&nbsp;        if (kg) {</b>
<b class="nc">&nbsp;            weight *= 1000;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (weight &lt; 0.5) {</b>
&nbsp;            // For small equipment show as many decimal places as needed.
<b class="nc">&nbsp;            return DecimalFormat.getInstance().format(weight);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return String.format(&quot;%3.1f%s&quot;, weight, (kg ? &quot; kg&quot; : &quot;&quot;));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Allows a value to be truncuated to an arbitrary number of decimal places.
&nbsp;     *
&nbsp;     * @param value
&nbsp;     *            The input value
&nbsp;     * @param precision
&nbsp;     *            The number of decimals to truncate at
&nbsp;     *
&nbsp;     * @return The input value truncated to the number of decimal places
&nbsp;     *         supplied
&nbsp;     */
&nbsp;    public static double setPrecision(double value, int precision) {
<b class="nc">&nbsp;        return Math.round(value * Math.pow(10, precision))</b>
<b class="nc">&nbsp;                / Math.pow(10, precision);</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Filters all armor according to given tech constraints
&nbsp;     *
&nbsp;     * @param etype         The entity type bit mask
&nbsp;     * @param industrial    For mechs; industrial mechs can only use certain armor types
&nbsp;     *                      unless allowing experimental rules
&nbsp;     * @param primitive     Whether the unit is primitive/retrotech
&nbsp;     * @param movementMode  For vehicles; hardened armor is illegal for some movement modes 
&nbsp;     * @param techManager   The constraints used to filter the armor types
&nbsp;     * @return A list of all armors that meet the tech constraints
&nbsp;     */
&nbsp;    public static List&lt;EquipmentType&gt; legalArmorsFor(long etype, boolean industrial, boolean primitive,
&nbsp;            EntityMovementMode movementMode, ITechManager techManager) {
<b class="nc">&nbsp;        if ((etype &amp; Entity.ETYPE_BATTLEARMOR) != 0) {</b>
<b class="nc">&nbsp;            return TestBattleArmor.legalArmorsFor(techManager);</b>
<b class="nc">&nbsp;        } else if ((etype &amp; Entity.ETYPE_SMALL_CRAFT) != 0) {</b>
<b class="nc">&nbsp;            return TestSmallCraft.legalArmorsFor(techManager);</b>
<b class="nc">&nbsp;        } else if ((etype &amp; Entity.ETYPE_JUMPSHIP) != 0) {</b>
<b class="nc">&nbsp;            return TestAdvancedAerospace.legalArmorsFor(techManager, primitive);</b>
<b class="nc">&nbsp;        } else if ((etype &amp; (Entity.ETYPE_FIXED_WING_SUPPORT | Entity.ETYPE_SUPPORT_TANK | Entity.ETYPE_SUPPORT_VTOL)) != 0) {</b>
<b class="nc">&nbsp;            return TestSupportVehicle.legalArmorsFor(techManager);</b>
<b class="nc">&nbsp;        } else if ((etype &amp; Entity.ETYPE_AERO) != 0) {</b>
<b class="nc">&nbsp;            return TestAero.legalArmorsFor(techManager);</b>
<b class="nc">&nbsp;        } else if ((etype &amp; Entity.ETYPE_TANK) != 0) {</b>
<b class="nc">&nbsp;            return TestTank.legalArmorsFor(movementMode, techManager);</b>
<b class="nc">&nbsp;        } else if ((etype &amp; Entity.ETYPE_MECH) != 0) {</b>
<b class="nc">&nbsp;            return TestMech.legalArmorsFor(etype, industrial, techManager);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return Collections.emptyList();</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    public static List&lt;EquipmentType&gt; validJumpJets(long entitytype, boolean industrial) {
<b class="nc">&nbsp;        if ((entitytype &amp; Entity.ETYPE_MECH) != 0) {</b>
<b class="nc">&nbsp;            return TestMech.MechJumpJets.allJJs(industrial);</b>
<b class="nc">&nbsp;        } else if ((entitytype &amp; Entity.ETYPE_TANK) != 0) {</b>
<b class="nc">&nbsp;            return Collections.singletonList(EquipmentType.get(EquipmentTypeLookup.VEHICLE_JUMP_JET));</b>
<b class="nc">&nbsp;        } else if ((entitytype &amp; Entity.ETYPE_BATTLEARMOR) != 0) {</b>
<b class="nc">&nbsp;            return TestBattleArmor.BAMotiveSystems.allSystems();</b>
<b class="nc">&nbsp;        } else if ((entitytype &amp; Entity.ETYPE_PROTOMECH) != 0) {</b>
&nbsp;            // Until we have a TestProtomech
<b class="nc">&nbsp;            return Arrays.asList(new EquipmentType[] {</b>
<b class="nc">&nbsp;                EquipmentType.get(EquipmentTypeLookup.PROTOMECH_JUMP_JET),</b>
<b class="nc">&nbsp;                EquipmentType.get(EquipmentTypeLookup.EXTENDED_JUMP_JET_SYSTEM),</b>
<b class="nc">&nbsp;                EquipmentType.get(EquipmentTypeLookup.PROTOMECH_UMU)});</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return Collections.emptyList();</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Additional crew requirements for vehicles and aerospace vessels for certain types of
&nbsp;     * equipment.
&nbsp;     */
&nbsp;    public static int equipmentCrewRequirements(Mounted mounted) {
<b class="nc">&nbsp;        if (mounted.getType() instanceof MiscType) {</b>
<b class="nc">&nbsp;            if (mounted.getType().hasFlag(MiscType.F_MOBILE_FIELD_BASE)) {</b>
<b class="nc">&nbsp;                return 5;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mounted.getType().hasFlag(MiscType.F_MASH)) {</b>
<b class="nc">&nbsp;                return 5 * (int) mounted.getSize();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mounted.getType().hasFlag(MiscType.F_FIELD_KITCHEN)) {</b>
<b class="nc">&nbsp;                return 3;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mounted.getType().hasFlag(MiscType.F_COMMUNICATIONS)) {</b>
<b class="nc">&nbsp;                return (int) mounted.getTonnage();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mounted.getType().hasFlag(MiscType.F_MOBILE_HPG)) {</b>
&nbsp;                // Mobile HPG has crew requirement of 10; ground-mobile has requirement of 1.
<b class="nc">&nbsp;                return mounted.getType().hasFlag(MiscType.F_TANK_EQUIPMENT)? 1 : 10;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mounted.getType().hasFlag(MiscType.F_SMALL_COMM_SCANNER_SUITE)) {</b>
<b class="nc">&nbsp;                return 6;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mounted.getType().hasFlag(MiscType.F_LARGE_COMM_SCANNER_SUITE)) {</b>
<b class="nc">&nbsp;                return 12;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Determines whether a type of equipment requires a particular location on an {@link Entity}.
&nbsp;     * What this means depends on the type of unit, but typically it does not take up a slot or
&nbsp;     * is not assigned a firing arc.
&nbsp;     * 
&nbsp;     * @param entity The Entity the equipment is to be placed on
&nbsp;     * @param eq     The equipment to place on the Entity
&nbsp;     * @return       Whether the equipment requires a location
&nbsp;     * @see #getSystemWideLocation(Entity)
&nbsp;     */
&nbsp;    public static boolean eqRequiresLocation(Entity entity, EquipmentType eq) {
<b class="nc">&nbsp;        if (entity.hasETypeFlag(Entity.ETYPE_AERO)) {</b>
<b class="nc">&nbsp;            return TestAero.eqRequiresLocation(eq, entity.isFighter());</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</b>
<b class="nc">&nbsp;            return TestProtomech.requiresSlot(eq);</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_TANK)) {</b>
<b class="nc">&nbsp;            return !TestTank.isBodyEquipment(eq);</b>
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Determines where to place equipment that does not require a specific location. What
&nbsp;     * this means varies by {@link Entity} type.
&nbsp;     * 
&nbsp;     * @param entity  The Entity to place the equipment in
&nbsp;     * @return        The location to place equipment that is not required to be assigned a location,
&nbsp;     *                defaulting to Entity.LOC_NONE for unit types that do not have such a location.
&nbsp;     */
&nbsp;    public static int getSystemWideLocation(Entity entity) {
<b class="nc">&nbsp;        if (entity.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</b>
<b class="nc">&nbsp;            return Jumpship.LOC_HULL;</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</b>
<b class="nc">&nbsp;            return SmallCraft.LOC_HULL;</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_AERO)) {</b>
<b class="nc">&nbsp;            return Aero.LOC_FUSELAGE;</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_TANK)) {</b>
<b class="nc">&nbsp;            return Tank.LOC_BODY;</b>
<b class="nc">&nbsp;        } else if (entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</b>
<b class="nc">&nbsp;            return Protomech.LOC_BODY;</b>
&nbsp;        }
<b class="nc">&nbsp;        return Entity.LOC_NONE;</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean hasMASC() {
<b class="nc">&nbsp;        if (getEntity() instanceof Mech) {</b>
<b class="nc">&nbsp;            return ((Mech) getEntity()).hasMASC();</b>
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public String printShortMovement() {
<b class="nc">&nbsp;        return &quot;Movement: &quot;</b>
<b class="nc">&nbsp;                + Integer.toString(getEntity().getOriginalWalkMP())</b>
&nbsp;                + &quot;/&quot;
<b class="nc">&nbsp;                + Integer.toString((int) Math.ceil(getEntity()</b>
<b class="nc">&nbsp;                        .getOriginalWalkMP() * 1.5))</b>
<b class="nc">&nbsp;                + (hasMASC() ? &quot;(&quot;</b>
<b class="nc">&nbsp;                        + Integer.toString(getEntity().getOriginalWalkMP() * 2)</b>
<b class="nc">&nbsp;                        + &quot;)&quot; : &quot;&quot;)</b>
<b class="nc">&nbsp;                + (getEntity().getOriginalJumpMP() != 0 ? &quot;/&quot;</b>
<b class="nc">&nbsp;                        + Integer.toString(getEntity().getOriginalJumpMP())</b>
<b class="nc">&nbsp;                        : &quot;&quot;) + &quot;\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printWeightHeatSinks() {
<b class="nc">&nbsp;        return StringUtil.makeLength(</b>
&nbsp;                &quot;Heat Sinks: &quot;
<b class="nc">&nbsp;                        + Integer.toString(getCountHeatSinks())</b>
<b class="nc">&nbsp;                        + (hasDoubleHeatSinks() ? &quot; [&quot;</b>
<b class="nc">&nbsp;                                + Integer.toString(2 * getCountHeatSinks())</b>
<b class="nc">&nbsp;                                + &quot;]&quot; : &quot;&quot;), getPrintSize() - 5)</b>
<b class="nc">&nbsp;                + TestEntity.makeWeightString(getWeightHeatSinks(), usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printWeightEngine() {
<b class="nc">&nbsp;        return StringUtil.makeLength(&quot;Engine: &quot; + ((null != engine) ? engine.getEngineName() : &quot;---&quot;),</b>
<b class="nc">&nbsp;                getPrintSize() - 5)</b>
<b class="nc">&nbsp;                + TestEntity.makeWeightString(getWeightEngine(), usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightEngine() {
<b class="nc">&nbsp;        return ((null != engine) ? engine.getWeightEngine(getEntity()) : 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printWeightStructure() {
<b class="nc">&nbsp;        return StringUtil.makeLength(</b>
&nbsp;                &quot;Structure: &quot;
<b class="nc">&nbsp;                        + Integer.toString(getEntity().getTotalOInternal())</b>
<b class="nc">&nbsp;                        + &quot; &quot; + structure.getShortName(), getPrintSize() - 5)</b>
<b class="nc">&nbsp;                + TestEntity.makeWeightString(getWeightStructure(), usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightStructure() {
<b class="nc">&nbsp;        return structure.getWeightStructure(getWeight(),</b>
<b class="nc">&nbsp;                getWeightCeilingStructure());</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printWeightArmor() {
<b class="nc">&nbsp;        if (!getEntity().hasPatchworkArmor()) {</b>
<b class="nc">&nbsp;            return StringUtil.makeLength(</b>
<b class="nc">&nbsp;                    &quot;Armor: &quot; + Integer.toString(getTotalOArmor()) + &quot; &quot;</b>
<b class="nc">&nbsp;                            + armor[0].getShortName(), getPrintSize() - 5)</b>
<b class="nc">&nbsp;                    + TestEntity.makeWeightString(getWeightArmor(), usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return StringUtil.makeLength(</b>
<b class="nc">&nbsp;                    &quot;Armor: &quot; + Integer.toString(getTotalOArmor()) + &quot; &quot;</b>
<b class="nc">&nbsp;                            + &quot;Patchwork&quot;, getPrintSize() - 5)</b>
<b class="nc">&nbsp;                    + TestEntity.makeWeightString(getWeightArmor(), usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightArmor() {
<b class="fc">&nbsp;        return getEntity().getLabArmorTonnage();</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightAllocatedArmor() {
<b class="nc">&nbsp;        if (!getEntity().hasPatchworkArmor()) {</b>
<b class="nc">&nbsp;            return (armor[0].getWeightArmor(getTotalOArmor(), getWeightCeilingArmor()));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            double armorWeight = 0;</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; armor.length; i++) {</b>
<b class="nc">&nbsp;                int points = getEntity().getOArmor(i);</b>
<b class="nc">&nbsp;                if (getEntity().hasRearArmor(i) &amp;&amp;</b>
<b class="nc">&nbsp;                        (getEntity().getOArmor(i, true) &gt; 0)) {</b>
<b class="nc">&nbsp;                    points += getEntity().getOArmor(i, true);</b>
&nbsp;                }
<b class="nc">&nbsp;                armorWeight += armor[i].getRawWeightArmor(points);</b>
&nbsp;            }
<b class="nc">&nbsp;            return TestEntity.ceilMaxHalf(armorWeight, getWeightCeilingArmor());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Gives subclasses a chance to exclude certain misc equipment if it is accounted for in a different
&nbsp;     * category.
&nbsp;     *
&nbsp;     * @param misc The misc equipment type
&nbsp;     * @return     Whether to include the equipment in the misc equipment category
&nbsp;     * @see #getWeightMiscEquip()
&nbsp;     */
&nbsp;    protected boolean includeMiscEquip(MiscType misc) {
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightMiscEquip() {
<b class="fc">&nbsp;        double weightSum = 0.0;</b>
<b class="fc">&nbsp;        for (Mounted m : getEntity().getMisc()) {</b>
<b class="nc">&nbsp;            MiscType mt = (MiscType) m.getType();</b>
<b class="nc">&nbsp;            if (!includeMiscEquip(mt)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ENDO_STEEL)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ENDO_STEEL_PROTO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_COMPOSITE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_INDUSTRIAL_STRUCTURE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_REINFORCED)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS_PROTO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_FERRO_LAMELLOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_LIGHT_FERRO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HEAVY_FERRO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_REACTIVE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_REFLECTIVE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HARDENED_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_PRIMITIVE_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_COMMERCIAL_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_INDUSTRIAL_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HEAVY_INDUSTRIAL_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ANTI_PENETRATIVE_ABLATIVE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HEAT_DISSIPATING)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_IMPACT_RESISTANT)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_BALLISTIC_REINFORCED)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ELECTRIC_DISCHARGE_ARMOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HEAT_SINK)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_DOUBLE_HEAT_SINK)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_IS_DOUBLE_HEAT_SINK_PROTOTYPE)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            weightSum += m.getTonnage();</b>
<b class="nc">&nbsp;        }</b>
<b class="fc">&nbsp;        return weightSum;</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printMiscEquip() {
<b class="nc">&nbsp;        return printMiscEquip(new StringBuffer());</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printMiscEquip(StringBuffer buff) {
<b class="nc">&nbsp;        return printMiscEquip(buff, 20, getPrintSize());</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printMiscEquip(StringBuffer buff, int posLoc,
&nbsp;            int posWeight) {
<b class="nc">&nbsp;        for (Mounted m : getEntity().getMisc()) {</b>
<b class="nc">&nbsp;            MiscType mt = (MiscType) m.getType();</b>
&nbsp;
<b class="nc">&nbsp;            if (m.getLocation() == Entity.LOC_NONE) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ENDO_STEEL)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_ENDO_STEEL_PROTO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_REINFORCED)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS_PROTO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_LIGHT_FERRO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_HEAVY_FERRO)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_REACTIVE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_REFLECTIVE)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_FERRO_LAMELLOR)</b>
<b class="nc">&nbsp;                    || mt.hasFlag(MiscType.F_INDUSTRIAL_STRUCTURE)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (m.getTonnage() == 0f) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            buff.append(StringUtil.makeLength(m.getName(), 20));</b>
<b class="nc">&nbsp;            buff.append(</b>
<b class="nc">&nbsp;                    StringUtil.makeLength(getLocationAbbr(m.getLocation()),</b>
<b class="nc">&nbsp;                            getPrintSize() - 5 - 20)).append(</b>
<b class="nc">&nbsp;                    TestEntity.makeWeightString(m.getTonnage(), usesKgStandard()));</b>
<b class="nc">&nbsp;            buff.append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return buff;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightWeapon() {
<b class="fc">&nbsp;        double weight = 0.0;</b>
<b class="fc">&nbsp;        for (Mounted m : getEntity().getTotalWeaponList()) {</b>
<b class="nc">&nbsp;            if (m.isWeaponGroup()) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            weight += m.getTonnage();</b>
<b class="nc">&nbsp;        }</b>
<b class="fc">&nbsp;        return weight;</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printWeapon() {
<b class="nc">&nbsp;        return printWeapon(new StringBuffer());</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printWeapon(StringBuffer buff) {
<b class="nc">&nbsp;        return printWeapon(buff, 20, getPrintSize());</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printWeapon(StringBuffer buff, int posLoc, int posWeight) {
<b class="nc">&nbsp;        for (Mounted m : getEntity().getWeaponList()) {</b>
<b class="nc">&nbsp;            WeaponType mt = (WeaponType) m.getType();</b>
&nbsp;
&nbsp;            // Don&#39;t think this can happen, but ...
<b class="nc">&nbsp;            if (m.getLocation() == Entity.LOC_NONE) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            buff.append(StringUtil.makeLength(mt.getName(), 20));</b>
<b class="nc">&nbsp;            buff.append(</b>
<b class="nc">&nbsp;                    StringUtil.makeLength(getLocationAbbr(m.getLocation()),</b>
<b class="nc">&nbsp;                            getPrintSize() - 5 - 20))</b>
<b class="nc">&nbsp;                    .append(TestEntity.makeWeightString(m.getTonnage(), usesKgStandard())).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return buff;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightAmmo() {
<b class="nc">&nbsp;        double weight = 0.0;</b>
<b class="nc">&nbsp;        for (Mounted m : getEntity().getAmmo()) {</b>
&nbsp;
&nbsp;            // One Shot Ammo
<b class="nc">&nbsp;            if (m.getLocation() == Entity.LOC_NONE) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Bombs on ASF don&#39;t count!
<b class="nc">&nbsp;            if ((getEntity() instanceof Aero) &amp;&amp; (m.getType() instanceof BombType)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            weight += m.getTonnage();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return weight;</b>
&nbsp;    }
&nbsp;
&nbsp;    public abstract double getWeightPowerAmp();
&nbsp;
&nbsp;    public StringBuffer printAmmo() {
<b class="nc">&nbsp;        return printAmmo(new StringBuffer());</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printAmmo(StringBuffer buff) {
<b class="nc">&nbsp;        return printAmmo(buff, 20, getPrintSize());</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printAmmo(StringBuffer buff, int posLoc, int posWeight) {
<b class="nc">&nbsp;        for (Mounted m : getEntity().getAmmo()) {</b>
<b class="nc">&nbsp;            AmmoType mt = (AmmoType) m.getType();</b>
&nbsp;
&nbsp;            // Don&#39;t think this can happen, but ...
<b class="nc">&nbsp;            if (m.getLocation() == Entity.LOC_NONE) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            buff.append(StringUtil.makeLength(mt.getName(), 20));</b>
<b class="nc">&nbsp;            buff.append(&quot; &quot;).append(</b>
<b class="nc">&nbsp;                    StringUtil.makeLength(getLocationAbbr(m.getLocation()),</b>
<b class="nc">&nbsp;                            getPrintSize() - 5 - 20))</b>
<b class="nc">&nbsp;                    .append(TestEntity.makeWeightString(m.getTonnage(), usesKgStandard())).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return buff;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printLocations() {
<b class="nc">&nbsp;        StringBuffer buff = new StringBuffer();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; getEntity().locations(); i++) {</b>
<b class="nc">&nbsp;            String locationName = getEntity().getLocationName(i);</b>
<b class="nc">&nbsp;            buff.append(locationName + &quot;:&quot;);</b>
<b class="nc">&nbsp;            buff.append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;            for (int j = 0; j &lt; getEntity().getNumberOfCriticals(i); j++) {</b>
<b class="nc">&nbsp;                CriticalSlot slot = getEntity().getCritical(i, j);</b>
<b class="nc">&nbsp;                if (slot == null) {</b>
<b class="nc">&nbsp;                    buff.append(Integer.toString(j) + &quot;. -Emtpy-&quot;);</b>
<b class="nc">&nbsp;                    buff.append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                } else if (slot.getType() == CriticalSlot.TYPE_SYSTEM) {</b>
<b class="nc">&nbsp;                    if (isMech()) {</b>
<b class="nc">&nbsp;                        buff.append(Integer.toString(j));</b>
<b class="nc">&nbsp;                        buff.append(&quot;. &quot;);</b>
<b class="nc">&nbsp;                        buff.append(((Mech) getEntity()).getSystemName(slot</b>
<b class="nc">&nbsp;                                .getIndex()));</b>
<b class="nc">&nbsp;                        buff.append(&quot;\n&quot;);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        buff.append(Integer.toString(j)</b>
&nbsp;                                + &quot;. UNKNOWN SYSTEM NAME&quot;);
<b class="nc">&nbsp;                        buff.append(&quot;\n&quot;);</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else if (slot.getType() == CriticalSlot.TYPE_EQUIPMENT) {</b>
<b class="nc">&nbsp;                    EquipmentType e = getEntity().getEquipmentType(slot);</b>
<b class="nc">&nbsp;                    buff.append(Integer.toString(j) + &quot;. &quot;</b>
<b class="nc">&nbsp;                            + e.getInternalName());</b>
<b class="nc">&nbsp;                    buff.append(&quot;\n&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return buff.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    public int calcMiscCrits(MiscType mt, double size) {
<b class="nc">&nbsp;        if (mt.hasFlag(MiscType.F_CLUB)</b>
<b class="nc">&nbsp;                &amp;&amp; (mt.hasSubType(MiscType.S_HATCHET)</b>
<b class="nc">&nbsp;                        || mt.hasSubType(MiscType.S_SWORD)</b>
<b class="nc">&nbsp;                        || mt.hasSubType(MiscType.S_CHAIN_WHIP) || mt</b>
<b class="nc">&nbsp;                            .hasSubType(MiscType.S_MACE_THB))) {</b>
<b class="nc">&nbsp;            return (int) Math.ceil(getWeight() / 15.0);</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_CLUB)</b>
<b class="nc">&nbsp;                &amp;&amp; mt.hasSubType(MiscType.S_MACE)) {</b>
<b class="nc">&nbsp;            return (int) Math.ceil(getWeight() / 10.0);</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_CLUB)</b>
<b class="nc">&nbsp;                &amp;&amp; mt.hasSubType(MiscType.S_RETRACTABLE_BLADE)) {</b>
<b class="nc">&nbsp;            return 1 + (int) Math.ceil(getWeight() / 20.0);</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_CLUB)</b>
<b class="nc">&nbsp;                &amp;&amp; mt.hasSubType(MiscType.S_PILE_DRIVER)) {</b>
<b class="nc">&nbsp;            return 8;</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_CLUB)</b>
<b class="nc">&nbsp;                &amp;&amp; mt.hasSubType(MiscType.S_CHAINSAW)) {</b>
<b class="nc">&nbsp;            return 5;</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_CLUB)</b>
<b class="nc">&nbsp;                &amp;&amp; mt.hasSubType(MiscType.S_DUAL_SAW)) {</b>
<b class="nc">&nbsp;            return 7;</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_CLUB)</b>
<b class="nc">&nbsp;                &amp;&amp; mt.hasSubType(MiscType.S_BACKHOE)) {</b>
<b class="nc">&nbsp;            return 6;</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_MASC)) {</b>
<b class="nc">&nbsp;            if (mt.getInternalName().equals(&quot;ISMASC&quot;)) {</b>
<b class="nc">&nbsp;                return (int) Math.round(getWeight() / 20.0);</b>
<b class="nc">&nbsp;            } else if (mt.getInternalName().equals(&quot;CLMASC&quot;)) {</b>
<b class="nc">&nbsp;                return (int) Math.round(getWeight() / 25.0);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_TARGCOMP)) {</b>
<b class="nc">&nbsp;            double fTons = 0.0f;</b>
<b class="nc">&nbsp;            for (Mounted mo : getEntity().getWeaponList()) {</b>
<b class="nc">&nbsp;                WeaponType wt = (WeaponType) mo.getType();</b>
<b class="nc">&nbsp;                if (wt.hasFlag(WeaponType.F_DIRECT_FIRE)) {</b>
<b class="nc">&nbsp;                    fTons += mo.getTonnage();</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            for (Mounted mo : getEntity().getMisc()) {</b>
<b class="nc">&nbsp;                MiscType mt2 = (MiscType) mo.getType();</b>
<b class="nc">&nbsp;                if (mt2.hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</b>
<b class="nc">&nbsp;                    fTons += mo.getTonnage();</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            double weight = 0.0f;</b>
<b class="nc">&nbsp;            if (mt.getInternalName().equals(&quot;ISTargeting Computer&quot;)) {</b>
<b class="nc">&nbsp;                weight = TestEntity.ceil(fTons / 4.0f,</b>
<b class="nc">&nbsp;                        getWeightCeilingTargComp());</b>
<b class="nc">&nbsp;            } else if (mt.getInternalName().equals(&quot;CLTargeting Computer&quot;)) {</b>
<b class="nc">&nbsp;                weight = TestEntity.ceil(fTons / 5.0f,</b>
<b class="nc">&nbsp;                        getWeightCeilingTargComp());</b>
&nbsp;            }
<b class="nc">&nbsp;            switch (getTargCompCrits()) {</b>
&nbsp;                case CEIL_TARGCOMP_CRITS:
<b class="nc">&nbsp;                    return (int) Math.ceil(weight);</b>
&nbsp;                case ROUND_TARGCOMP_CRITS:
<b class="nc">&nbsp;                    return (int) Math.round(weight);</b>
&nbsp;                case FLOOR_TARGCOMP_CRITS:
<b class="nc">&nbsp;                    return (int) Math.floor(weight);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (EquipmentType.getArmorTypeName(</b>
<b class="nc">&nbsp;                EquipmentType.T_ARMOR_FERRO_FIBROUS).equals(</b>
<b class="nc">&nbsp;                mt.getInternalName())) {</b>
<b class="nc">&nbsp;            if (isClanArmor()) {</b>
<b class="nc">&nbsp;                return 7;</b>
&nbsp;            }
<b class="nc">&nbsp;            return 14;</b>
<b class="nc">&nbsp;        } else if (EquipmentType.getArmorTypeName(</b>
<b class="nc">&nbsp;                EquipmentType.T_ARMOR_FERRO_FIBROUS_PROTO).equals(</b>
<b class="nc">&nbsp;                mt.getInternalName())) {</b>
<b class="nc">&nbsp;            return 16;</b>
<b class="nc">&nbsp;        } else if (EquipmentType.getArmorTypeName(</b>
<b class="nc">&nbsp;                EquipmentType.T_ARMOR_LIGHT_FERRO).equals(mt.getInternalName())) {</b>
<b class="nc">&nbsp;            return 7;</b>
<b class="nc">&nbsp;        } else if (EquipmentType.getArmorTypeName(</b>
<b class="nc">&nbsp;                EquipmentType.T_ARMOR_HEAVY_FERRO).equals(mt.getInternalName())) {</b>
<b class="nc">&nbsp;            return 21;</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_ENDO_STEEL)) {</b>
<b class="nc">&nbsp;            if (isClan()</b>
<b class="nc">&nbsp;                    || mt.getInternalName()</b>
<b class="nc">&nbsp;                            .equals(&quot;Clan &quot;</b>
&nbsp;                                    + EquipmentType
<b class="nc">&nbsp;                                            .getStructureTypeName(EquipmentType.T_STRUCTURE_ENDO_STEEL))) {</b>
<b class="nc">&nbsp;                return 7;</b>
&nbsp;            }
<b class="nc">&nbsp;            return 14;</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_ENDO_STEEL_PROTO)) {</b>
<b class="nc">&nbsp;            return 16;</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_ENDO_COMPOSITE)) {</b>
<b class="nc">&nbsp;            if (isClan()</b>
<b class="nc">&nbsp;                    || mt.getInternalName()</b>
<b class="nc">&nbsp;                            .equals(&quot;Clan &quot;</b>
&nbsp;                                    + EquipmentType
<b class="nc">&nbsp;                                            .getStructureTypeName(EquipmentType.T_STRUCTURE_ENDO_COMPOSITE))) {</b>
<b class="nc">&nbsp;                return 4;</b>
&nbsp;            }
<b class="nc">&nbsp;            return 7;</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_REACTIVE)) {</b>
<b class="nc">&nbsp;            if (isClanArmor()) {</b>
<b class="nc">&nbsp;                return 7;</b>
&nbsp;            }
<b class="nc">&nbsp;            return 14;</b>
<b class="nc">&nbsp;        } else if (mt.hasFlag(MiscType.F_REFLECTIVE)) {</b>
<b class="nc">&nbsp;            if (isClanArmor()) {</b>
<b class="nc">&nbsp;                return 5;</b>
&nbsp;            }
<b class="nc">&nbsp;            return 10;</b>
&nbsp;        }
<b class="nc">&nbsp;        return mt.getCriticals(getEntity(), size);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Computes heat sink requirement for heat-neutral units (vehicles, conventional fighters,
&nbsp;     * protomechs). This is a total of energy weapons that don&#39;t use ammo and some other miscellaneous
&nbsp;     * equipment.
&nbsp;     * 
&nbsp;     * @return The number of heat sinks required in construction
&nbsp;     */
&nbsp;    protected int heatNeutralHSRequirement() {
<b class="fc">&nbsp;        return calcHeatNeutralHSRequirement(getEntity());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Computes heat sink requirement for heat-neutral units (vehicles, conventional fighters,
&nbsp;     * protomechs). This is a total of energy weapons that don&#39;t use ammo and some other miscellaneous
&nbsp;     * equipment.
&nbsp;     *
&nbsp;     * @return The number of heat sinks required in construction
&nbsp;     */
&nbsp;    public static int calcHeatNeutralHSRequirement(Entity entity) {
<b class="fc">&nbsp;        int heat = 0;</b>
<b class="fc">&nbsp;        for (Mounted m : entity.getWeaponList()) {</b>
<b class="fc">&nbsp;            WeaponType wt = (WeaponType) m.getType();</b>
<b class="fc">&nbsp;            if ((wt.hasFlag(WeaponType.F_LASER) &amp;&amp; (wt.getAmmoType() == AmmoType.T_NA))</b>
<b class="fc">&nbsp;                    || wt.hasFlag(WeaponType.F_PPC)</b>
<b class="fc">&nbsp;                    || wt.hasFlag(WeaponType.F_PLASMA)</b>
<b class="fc">&nbsp;                    || wt.hasFlag(WeaponType.F_PLASMA_MFUK)</b>
<b class="fc">&nbsp;                    || (wt.hasFlag(WeaponType.F_FLAMER) &amp;&amp; (wt.getAmmoType() == AmmoType.T_NA))) {</b>
<b class="fc">&nbsp;                heat += wt.getHeat();</b>
&nbsp;            }
&nbsp;            // laser insulator reduce heat by 1, to a minimum of 1
<b class="fc">&nbsp;            if (wt.hasFlag(WeaponType.F_LASER) &amp;&amp; (m.getLinkedBy() != null)</b>
<b class="nc">&nbsp;                    &amp;&amp; !m.getLinkedBy().isInoperable()</b>
<b class="nc">&nbsp;                    &amp;&amp; m.getLinkedBy().getType().hasFlag(MiscType.F_LASER_INSULATOR)) {</b>
<b class="nc">&nbsp;                heat -= 1;</b>
<b class="nc">&nbsp;                if (heat == 0) {</b>
<b class="nc">&nbsp;                    heat++;</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if ((m.getLinkedBy() != null) &amp;&amp; (m.getLinkedBy().getType() instanceof</b>
<b class="nc">&nbsp;                    MiscType) &amp;&amp; m.getLinkedBy().getType().</b>
<b class="nc">&nbsp;                    hasFlag(MiscType.F_PPC_CAPACITOR)) {</b>
<b class="nc">&nbsp;                heat += 5;</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        for (Mounted m : entity.getMisc()) {</b>
&nbsp;            // Spot welders are treated as energy weapons on units that don&#39;t have a fusion or fission engine
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_CLUB) &amp;&amp; m.getType().hasSubType(MiscType.S_SPOT_WELDER)</b>
<b class="nc">&nbsp;                &amp;&amp; entity.hasEngine() &amp;&amp; (entity.getEngine().isFusion()</b>
<b class="nc">&nbsp;                                                || (entity.getEngine().getEngineType() == Engine.FISSION))) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            heat += m.getType().getHeat();</b>
<b class="nc">&nbsp;        }</b>
<b class="fc">&nbsp;        if (entity.hasStealth()) {</b>
<b class="nc">&nbsp;            heat += 10;</b>
&nbsp;        }
<b class="fc">&nbsp;        return heat;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double calculateWeight() {
<b class="fc">&nbsp;        double weight = 0;</b>
<b class="fc">&nbsp;        weight += getWeightEngine();</b>
<b class="fc">&nbsp;        weight += getWeightStructure();</b>
<b class="fc">&nbsp;        weight += getWeightControls();</b>
<b class="fc">&nbsp;        weight += getWeightHeatSinks();</b>
<b class="fc">&nbsp;        weight += getWeightArmor();</b>
<b class="fc">&nbsp;        weight += getWeightMisc();</b>
&nbsp;
<b class="fc">&nbsp;        weight += getWeightMiscEquip();</b>
<b class="fc">&nbsp;        weight += getWeightWeapon();</b>
<b class="fc">&nbsp;        weight += getWeightAmmo();</b>
<b class="fc">&nbsp;        weight += getWeightPowerAmp();</b>
&nbsp;
<b class="fc">&nbsp;        weight += getWeightCarryingSpace();</b>
&nbsp;
<b class="fc">&nbsp;        weight += getArmoredComponentWeight();</b>
&nbsp;        // If the unit used kg standard, we just need to get rid of floating-point math anomalies.
&nbsp;        // Otherwise accumulated kg-scale equipment needs to be rounded up to the nearest half-ton.
<b class="fc">&nbsp;        weight = round(weight, Ceil.KILO);</b>
<b class="fc">&nbsp;        if (usesKgStandard()) {</b>
<b class="nc">&nbsp;            return weight;</b>
&nbsp;        } else {
<b class="fc">&nbsp;            return ceil(weight, Ceil.HALFTON);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public String printWeightCalculation() {
<b class="nc">&nbsp;        return printWeightEngine() + printWeightStructure()</b>
<b class="nc">&nbsp;                + printWeightControls() + printWeightHeatSinks()</b>
<b class="nc">&nbsp;                + printWeightArmor() + printWeightMisc()</b>
<b class="nc">&nbsp;                + printWeightCarryingSpace() + &quot;Equipment:\n&quot;</b>
<b class="nc">&nbsp;                + printMiscEquip() + printWeapon() + printAmmo();</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean correctWeight(StringBuffer buff) {
<b class="fc">&nbsp;        return correctWeight(buff, showOverweightedEntity(),</b>
<b class="fc">&nbsp;                showUnderweightedEntity());</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean correctWeight(StringBuffer buff, boolean showO, boolean showU) {
<b class="fc">&nbsp;        double weightSum = calculateWeight();</b>
<b class="fc">&nbsp;        double weight = getWeight();</b>
&nbsp;
<b class="fc">&nbsp;        if (showO &amp;&amp; ((weight + getMaxOverweight()) &lt; weightSum)) {</b>
<b class="fc">&nbsp;            buff.append(&quot;Weight: &quot;).append(calculateWeight())</b>
<b class="fc">&nbsp;                    .append(&quot; is greater than &quot;).append(getWeight())</b>
<b class="fc">&nbsp;                    .append(&quot;\n&quot;);</b>
&nbsp;            // buff.append(printWeightCalculation()).append(&quot;\n&quot;);
<b class="fc">&nbsp;            return false;</b>
&nbsp;        }
<b class="fc">&nbsp;        if (showU &amp;&amp; ((weight - getMinUnderweight()) &gt; weightSum)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Weight: &quot;).append(calculateWeight())</b>
<b class="nc">&nbsp;                    .append(&quot; is less than &quot;).append(getWeight()).append(&quot;\n&quot;);</b>
&nbsp;            // buff.append(printWeightCalculation()).append(&quot;\n&quot;);
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="fc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean hasIllegalTechLevels(StringBuffer buff) {
<b class="nc">&nbsp;        return hasIllegalTechLevels(buff, getEntity().getTechLevel());</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean hasIllegalTechLevels(StringBuffer buff, int ammoTechLvl) {
&nbsp;        /* A large number of units have official tech levels lower than their components at the
&nbsp;         * intro date. We test instead whether the stated tech level is ever possible based on the
&nbsp;         * equipment. We also test for mixed IS/Clan tech in units that are not designated as mixed.
&nbsp;         */
<b class="nc">&nbsp;        boolean retVal = false;</b>
<b class="nc">&nbsp;        int eTechLevel = SimpleTechLevel.convertCompoundToSimple(getEntity().getTechLevel()).ordinal();</b>
<b class="nc">&nbsp;        int ammoRulesLevel = SimpleTechLevel.convertCompoundToSimple(ammoTechLvl).ordinal();</b>
<b class="nc">&nbsp;        int eRulesLevel = getEntity().findMinimumRulesLevel().ordinal();</b>
<b class="nc">&nbsp;        if ((eTechLevel &gt;= eRulesLevel) &amp;&amp; (getEntity().getEarliestTechDate() &lt;= getEntity().getYear())) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        int eTLYear = getEntity().getTechLevelYear();</b>
<b class="nc">&nbsp;        for (Mounted mounted : getEntity().getEquipment()) {</b>
<b class="nc">&nbsp;            EquipmentType nextE = mounted.getType();</b>
<b class="nc">&nbsp;            int eqRulesLevel = getEntity().isMixedTech()?</b>
<b class="nc">&nbsp;                    nextE.findMinimumRulesLevel().ordinal() : nextE.findMinimumRulesLevel(getEntity().isClan()).ordinal();</b>
<b class="nc">&nbsp;            boolean illegal = eqRulesLevel &gt; eRulesLevel;</b>
<b class="nc">&nbsp;            if (!getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                illegal |= getEntity().isClan() &amp;&amp; nextE.getTechBase() == ITechnology.TECH_BASE_IS;</b>
<b class="nc">&nbsp;                illegal |= !getEntity().isClan() &amp;&amp; nextE.getTechBase() == ITechnology.TECH_BASE_CLAN;</b>
&nbsp;            }
<b class="nc">&nbsp;            int eqTechLevel = TechConstants.convertFromSimplelevel(eqRulesLevel, nextE.isClan());</b>
<b class="nc">&nbsp;            if (nextE instanceof AmmoType) {</b>
<b class="nc">&nbsp;                if (eqRulesLevel &gt; ammoRulesLevel) {</b>
<b class="nc">&nbsp;                    if (!retVal) {</b>
<b class="nc">&nbsp;                        buff.append(&quot;Ammo illegal at unit&#39;s tech level (&quot;);</b>
<b class="nc">&nbsp;                        buff.append(TechConstants</b>
<b class="nc">&nbsp;                                .getLevelDisplayableName(ammoTechLvl));</b>
<b class="nc">&nbsp;                        buff.append(&quot;, &quot;);</b>
<b class="nc">&nbsp;                        buff.append(eTLYear);</b>
<b class="nc">&nbsp;                        buff.append(&quot;):\n&quot;);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    retVal = true;</b>
<b class="nc">&nbsp;                    buff.append(nextE.getName());</b>
<b class="nc">&nbsp;                    buff.append(&quot;, (&quot;);</b>
<b class="nc">&nbsp;                    buff.append(TechConstants</b>
<b class="nc">&nbsp;                            .getLevelDisplayableName(eqTechLevel));</b>
<b class="nc">&nbsp;                    buff.append(&quot;)\n&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (illegal) {</b>
<b class="nc">&nbsp;                if (!retVal) {</b>
<b class="nc">&nbsp;                    buff.append(&quot;Equipment illegal at unit&#39;s tech level &quot;);</b>
<b class="nc">&nbsp;                    buff.append(TechConstants</b>
<b class="nc">&nbsp;                            .getLevelDisplayableName(ammoTechLvl));</b>
<b class="nc">&nbsp;                    buff.append(&quot;, &quot;);</b>
<b class="nc">&nbsp;                    buff.append(eTLYear);</b>
<b class="nc">&nbsp;                    buff.append(&quot;):\n&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                retVal = true;</b>
<b class="nc">&nbsp;                buff.append(nextE.getName());</b>
<b class="nc">&nbsp;                buff.append(&quot;, (&quot;);</b>
<b class="nc">&nbsp;                buff.append(TechConstants</b>
<b class="nc">&nbsp;                        .getLevelDisplayableName(eqTechLevel));</b>
<b class="nc">&nbsp;                buff.append(&quot;)\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // Check cockpit TL
<b class="nc">&nbsp;        ITechnology cockpit = null;</b>
<b class="nc">&nbsp;        String cockpitName = null;</b>
<b class="nc">&nbsp;        if (getEntity().getEntityType() == Entity.ETYPE_AERO) {</b>
<b class="nc">&nbsp;            cockpit = ((Aero)getEntity()).getCockpitTechAdvancement();</b>
<b class="nc">&nbsp;            cockpitName = ((Aero)getEntity()).getCockpitTypeString();</b>
<b class="nc">&nbsp;        } else if (getEntity() instanceof Mech) {</b>
<b class="nc">&nbsp;            cockpit = ((Mech)getEntity()).getCockpitTechAdvancement();</b>
<b class="nc">&nbsp;            cockpitName = ((Mech)getEntity()).getCockpitTypeString();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (cockpit != null) {</b>
<b class="nc">&nbsp;            int eqRulesLevel = getEntity().isMixedTech()?</b>
<b class="nc">&nbsp;                    cockpit.findMinimumRulesLevel().ordinal() : cockpit.findMinimumRulesLevel(getEntity().isClan()).ordinal();</b>
<b class="nc">&nbsp;            boolean illegal = eqRulesLevel &gt; eRulesLevel;</b>
<b class="nc">&nbsp;            if (!getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                illegal |= getEntity().isClan() &amp;&amp; cockpit.getTechBase() == ITechnology.TECH_BASE_IS;</b>
<b class="nc">&nbsp;                illegal |= !getEntity().isClan() &amp;&amp; cockpit.getTechBase() == ITechnology.TECH_BASE_CLAN;                </b>
&nbsp;            }
<b class="nc">&nbsp;            if (illegal) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Cockpit is illegal at unit&#39;s tech level (&quot;);</b>
<b class="nc">&nbsp;                buff.append(TechConstants</b>
<b class="nc">&nbsp;                        .getLevelDisplayableName(eTechLevel));</b>
<b class="nc">&nbsp;                buff.append(&quot;, &quot;);</b>
<b class="nc">&nbsp;                buff.append(eTLYear);</b>
<b class="nc">&nbsp;                buff.append(&quot;): &quot;);</b>
<b class="nc">&nbsp;                buff.append(cockpitName);</b>
<b class="nc">&nbsp;                buff.append(&quot; (&quot;);</b>
<b class="nc">&nbsp;                buff.append(TechConstants</b>
<b class="nc">&nbsp;                        .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel, cockpit.isClan())));</b>
<b class="nc">&nbsp;                buff.append(&quot;)\n&quot;);</b>
<b class="nc">&nbsp;                retVal = true;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (getEntity() instanceof Mech) {</b>
<b class="nc">&nbsp;            ITechnology gyro = ((Mech)getEntity()).getGyroTechAdvancement();</b>
<b class="nc">&nbsp;            if (gyro != null) {</b>
<b class="nc">&nbsp;                int eqRulesLevel = getEntity().isMixedTech()?</b>
<b class="nc">&nbsp;                        gyro.findMinimumRulesLevel().ordinal() : gyro.findMinimumRulesLevel(getEntity().isClan()).ordinal();</b>
<b class="nc">&nbsp;                boolean illegal = eqRulesLevel &gt; eRulesLevel;</b>
<b class="nc">&nbsp;                if (!getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                    illegal |= getEntity().isClan() &amp;&amp; gyro.getTechBase() == ITechnology.TECH_BASE_IS;</b>
<b class="nc">&nbsp;                    illegal |= !getEntity().isClan() &amp;&amp; gyro.getTechBase() == ITechnology.TECH_BASE_CLAN;                </b>
&nbsp;                }
<b class="nc">&nbsp;                if (illegal) {</b>
<b class="nc">&nbsp;                    buff.append(&quot;Gyro is illegal at unit&#39;s tech level (&quot;);</b>
<b class="nc">&nbsp;                    buff.append(TechConstants</b>
<b class="nc">&nbsp;                            .getLevelDisplayableName(eTechLevel));</b>
<b class="nc">&nbsp;                    buff.append(&quot;, &quot;);</b>
<b class="nc">&nbsp;                    buff.append(eTLYear);</b>
<b class="nc">&nbsp;                    buff.append(&quot;): &quot;);</b>
<b class="nc">&nbsp;                    buff.append(((Mech)getEntity()).getGyroTypeString());</b>
<b class="nc">&nbsp;                    buff.append(&quot; (&quot;);</b>
<b class="nc">&nbsp;                    buff.append(TechConstants</b>
<b class="nc">&nbsp;                            .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel,</b>
<b class="nc">&nbsp;                                    gyro.isClan())));</b>
<b class="nc">&nbsp;                    buff.append(&quot;)\n&quot;);</b>
<b class="nc">&nbsp;                    retVal = true;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (getEntity().hasEngine()) {</b>
<b class="nc">&nbsp;            ITechnology engine = getEntity().getEngine().getTechAdvancement();</b>
<b class="nc">&nbsp;            int eqRulesLevel = getEntity().isMixedTech()?</b>
<b class="nc">&nbsp;                    engine.findMinimumRulesLevel().ordinal() : engine.findMinimumRulesLevel(getEntity().isClan()).ordinal();</b>
<b class="nc">&nbsp;            boolean illegal = eqRulesLevel &gt; eRulesLevel;</b>
<b class="nc">&nbsp;            if (!getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                illegal |= getEntity().isClan() &amp;&amp; engine.getTechBase() == ITechnology.TECH_BASE_IS;</b>
<b class="nc">&nbsp;                illegal |= !getEntity().isClan() &amp;&amp; engine.getTechBase() == ITechnology.TECH_BASE_CLAN;                </b>
&nbsp;            }
<b class="nc">&nbsp;            if (illegal) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Engine is illegal at unit&#39;s tech level (&quot;);</b>
<b class="nc">&nbsp;                buff.append(TechConstants</b>
<b class="nc">&nbsp;                        .getLevelDisplayableName(eTechLevel));</b>
<b class="nc">&nbsp;                buff.append(&quot;, &quot;);</b>
<b class="nc">&nbsp;                buff.append(eTLYear);</b>
<b class="nc">&nbsp;                buff.append(&quot;): &quot;);</b>
<b class="nc">&nbsp;                buff.append(getEntity().getEngine().getShortEngineName());</b>
<b class="nc">&nbsp;                buff.append(&quot; (&quot;);</b>
<b class="nc">&nbsp;                buff.append(TechConstants</b>
<b class="nc">&nbsp;                        .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel,</b>
<b class="nc">&nbsp;                                engine.isClan())));</b>
<b class="nc">&nbsp;                buff.append(&quot;)\n&quot;);</b>
<b class="nc">&nbsp;                buff.append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                retVal = true;</b>
&nbsp;            }
&nbsp;        }
&nbsp;        Set&lt;String&gt; armors;
<b class="nc">&nbsp;        if (!getEntity().hasPatchworkArmor()) {</b>
<b class="nc">&nbsp;            armors = Collections.singleton(EquipmentType.getArmorTypeName(getEntity().getArmorType(1),</b>
<b class="nc">&nbsp;                    TechConstants.isClan(getEntity().getArmorTechLevel(1))));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            int eqRulesLevel = getEntity().isMixedTech()?</b>
<b class="nc">&nbsp;                    Entity.getPatchworkArmorAdvancement().findMinimumRulesLevel().ordinal() :</b>
<b class="nc">&nbsp;                        Entity.getPatchworkArmorAdvancement().findMinimumRulesLevel(getEntity().isClan()).ordinal();</b>
<b class="nc">&nbsp;            if (eqRulesLevel &gt; eRulesLevel) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Armor is illegal at unit&#39;s tech level (&quot;);</b>
<b class="nc">&nbsp;                buff.append(TechConstants</b>
<b class="nc">&nbsp;                        .getLevelDisplayableName(eTechLevel));</b>
<b class="nc">&nbsp;                buff.append(&quot;, &quot;);</b>
<b class="nc">&nbsp;                buff.append(eTLYear);</b>
<b class="nc">&nbsp;                buff.append(&quot;): Patchwork (&quot;);</b>
<b class="nc">&nbsp;                buff.append(TechConstants</b>
<b class="nc">&nbsp;                        .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel,</b>
<b class="nc">&nbsp;                                getEntity().isClan())));</b>
<b class="nc">&nbsp;                buff.append(&quot;)\n&quot;);</b>
<b class="nc">&nbsp;                buff.append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                retVal = true;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            armors = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;            for (int loc = 0; loc &lt; getEntity().locations(); loc++) {</b>
<b class="nc">&nbsp;                armors.add(EquipmentType.getArmorTypeName(getEntity().getArmorType(loc),</b>
<b class="nc">&nbsp;                        TechConstants.isClan(getEntity().getArmorTechLevel(loc))));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        for (String atName : armors) {</b>
<b class="nc">&nbsp;            EquipmentType at = EquipmentType.get(atName);</b>
&nbsp;            // Can be null in the case of vehicle body or asf wings.   
<b class="nc">&nbsp;            if (null ==  at) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int eqRulesLevel = getEntity().isMixedTech()?</b>
<b class="nc">&nbsp;                    at.findMinimumRulesLevel().ordinal() : at.findMinimumRulesLevel(getEntity().isClan()).ordinal();</b>
<b class="nc">&nbsp;            boolean illegal = eqRulesLevel &gt; eRulesLevel;</b>
<b class="nc">&nbsp;            if (!getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                illegal |= getEntity().isClan() &amp;&amp; at.getTechBase() == ITechnology.TECH_BASE_IS;</b>
<b class="nc">&nbsp;                illegal |= !getEntity().isClan() &amp;&amp; at.getTechBase() == ITechnology.TECH_BASE_CLAN;                </b>
&nbsp;            }
<b class="nc">&nbsp;            if (illegal) {</b>
<b class="nc">&nbsp;                buff.append(&quot;Armor is illegal at unit&#39;s tech level (&quot;);</b>
<b class="nc">&nbsp;                buff.append(TechConstants</b>
<b class="nc">&nbsp;                        .getLevelDisplayableName(eTechLevel));</b>
<b class="nc">&nbsp;                buff.append(&quot;, &quot;);</b>
<b class="nc">&nbsp;                buff.append(eTLYear);</b>
<b class="nc">&nbsp;                buff.append(&quot;): &quot;);</b>
<b class="nc">&nbsp;                buff.append(atName);</b>
<b class="nc">&nbsp;                buff.append(&quot; (&quot;);</b>
<b class="nc">&nbsp;                buff.append(TechConstants</b>
<b class="nc">&nbsp;                        .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel,</b>
<b class="nc">&nbsp;                                at.isClan())));</b>
<b class="nc">&nbsp;                buff.append(&quot;)\n&quot;);</b>
<b class="nc">&nbsp;                buff.append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                retVal = true;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Compares intro dates of all components to the unit intro year.
&nbsp;     * 
&nbsp;     * @param buff Descriptions of problems will be added to the buffer.
&nbsp;     * @return     Whether the unit has an intro year equal to or later than all the components.
&nbsp;     */
&nbsp;    public boolean hasIncorrectIntroYear(StringBuffer buff) {
<b class="nc">&nbsp;        boolean retVal = false;</b>
<b class="nc">&nbsp;        if (getEntity().getEarliestTechDate() &lt;= getEntity().getYear() + getIntroYearMargin()) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        int useIntroYear = getEntity().getYear() + getIntroYearMargin();</b>
<b class="nc">&nbsp;        if (getEntity().isOmni()) {</b>
<b class="nc">&nbsp;            int introDate = Entity.getOmniAdvancement(getEntity())</b>
<b class="nc">&nbsp;                    .getIntroductionDate(getEntity().isClan() || getEntity().isMixedTech());</b>
<b class="nc">&nbsp;            if (useIntroYear &lt; introDate) {</b>
<b class="nc">&nbsp;                retVal = true;</b>
<b class="nc">&nbsp;                buff.append(&quot;Omni technology has intro date of &quot;);</b>
<b class="nc">&nbsp;                buff.append(introDate);</b>
<b class="nc">&nbsp;                buff.append(&quot;\n&quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        Set&lt;EquipmentType&gt; checked = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        for (Mounted mounted : getEntity().getEquipment()) {</b>
<b class="nc">&nbsp;            final EquipmentType nextE = mounted.getType();</b>
<b class="nc">&nbsp;            if (checked.contains(nextE) || (nextE instanceof AmmoType)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            checked.add(nextE);</b>
<b class="nc">&nbsp;            int introDate = nextE.getIntroductionDate(getEntity().isClan());</b>
<b class="nc">&nbsp;            if (getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                introDate = nextE.getIntroductionDate();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (introDate &gt; useIntroYear) {</b>
<b class="nc">&nbsp;                retVal = true;</b>
<b class="nc">&nbsp;                buff.append(nextE.getName());</b>
<b class="nc">&nbsp;                buff.append(&quot; has intro date of &quot;);</b>
<b class="nc">&nbsp;                buff.append(introDate);</b>
<b class="nc">&nbsp;                buff.append(&quot;\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        Set&lt;String&gt; armors;
<b class="nc">&nbsp;        if (!getEntity().hasPatchworkArmor()) {</b>
<b class="nc">&nbsp;            armors = Collections.singleton(EquipmentType.getArmorTypeName(getEntity().getArmorType(1),</b>
<b class="nc">&nbsp;                    TechConstants.isClan(getEntity().getArmorTechLevel(1))));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            int intro = getEntity().isMixedTech()?</b>
<b class="nc">&nbsp;                    Entity.getPatchworkArmorAdvancement().getIntroductionDate() :</b>
<b class="nc">&nbsp;                        Entity.getPatchworkArmorAdvancement().getIntroductionDate(getEntity().isClan());</b>
<b class="nc">&nbsp;            if (useIntroYear &lt; intro) {</b>
<b class="nc">&nbsp;                retVal = true;</b>
<b class="nc">&nbsp;                buff.append(&quot;Patchwork armor has intro date of &quot;);</b>
<b class="nc">&nbsp;                buff.append(intro);</b>
<b class="nc">&nbsp;                buff.append(&quot;\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            armors = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;            for (int loc = 0; loc &lt; getEntity().locations(); loc++) {</b>
<b class="nc">&nbsp;                armors.add(EquipmentType.getArmorTypeName(getEntity().getArmorType(loc),</b>
<b class="nc">&nbsp;                        TechConstants.isClan(getEntity().getArmorTechLevel(loc))));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        for (String atName : armors) {</b>
<b class="nc">&nbsp;            EquipmentType at = EquipmentType.get(atName);</b>
<b class="nc">&nbsp;            if (checked.contains(at)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            checked.add(at);</b>
&nbsp;            // Can be null in the case of vehicle body or asf wings.   
<b class="nc">&nbsp;            if (null ==  at) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int introDate = at.getIntroductionDate(getEntity().isClan());</b>
<b class="nc">&nbsp;            if (getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                introDate = at.getIntroductionDate();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (introDate &gt; useIntroYear) {</b>
<b class="nc">&nbsp;                retVal = true;</b>
<b class="nc">&nbsp;                buff.append(at.getName());</b>
<b class="nc">&nbsp;                buff.append(&quot; armor has intro date of &quot;);</b>
<b class="nc">&nbsp;                buff.append(introDate);</b>
<b class="nc">&nbsp;                buff.append(&quot;\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // Check cockpit TL
<b class="nc">&nbsp;        ITechnology cockpit = null;</b>
<b class="nc">&nbsp;        String cockpitName = null;</b>
<b class="nc">&nbsp;        if ((getEntity() instanceof Aero) &amp;&amp; !getEntity().isSupportVehicle()) {</b>
<b class="nc">&nbsp;            cockpit = ((Aero)getEntity()).getCockpitTechAdvancement();</b>
<b class="nc">&nbsp;            cockpitName = ((Aero)getEntity()).getCockpitTypeString();</b>
<b class="nc">&nbsp;        } else if (getEntity() instanceof Mech) {</b>
<b class="nc">&nbsp;            cockpit = ((Mech)getEntity()).getCockpitTechAdvancement();</b>
<b class="nc">&nbsp;            cockpitName = ((Mech)getEntity()).getCockpitTypeString();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (null != cockpit) {</b>
<b class="nc">&nbsp;            int introDate = cockpit.getIntroductionDate(getEntity().isClan());</b>
<b class="nc">&nbsp;            if (getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                introDate = cockpit.getIntroductionDate();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (introDate &gt; useIntroYear) {</b>
<b class="nc">&nbsp;                retVal = true;</b>
<b class="nc">&nbsp;                buff.append(cockpitName);</b>
<b class="nc">&nbsp;                buff.append(&quot; has intro date of &quot;);</b>
<b class="nc">&nbsp;                buff.append(introDate);</b>
<b class="nc">&nbsp;                buff.append(&quot;\n&quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (getEntity() instanceof Mech) {</b>
<b class="nc">&nbsp;            ITechnology gyro = ((Mech)getEntity()).getGyroTechAdvancement();</b>
<b class="nc">&nbsp;            if (null != gyro) {</b>
<b class="nc">&nbsp;                int introDate = gyro.getIntroductionDate(getEntity().isClan());</b>
<b class="nc">&nbsp;                if (getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                    introDate = gyro.getIntroductionDate();</b>
&nbsp;                }
<b class="nc">&nbsp;                if (introDate &gt; useIntroYear) {</b>
<b class="nc">&nbsp;                    retVal = true;</b>
<b class="nc">&nbsp;                    buff.append(((Mech)getEntity()).getGyroTypeString());</b>
<b class="nc">&nbsp;                    buff.append(&quot; has intro date of &quot;);</b>
<b class="nc">&nbsp;                    buff.append(introDate);</b>
<b class="nc">&nbsp;                    buff.append(&quot;\n&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (getEntity().hasEngine()) {</b>
<b class="nc">&nbsp;            ITechnology engine = getEntity().getEngine().getTechAdvancement();</b>
<b class="nc">&nbsp;            int introDate = engine.getIntroductionDate(getEntity().isClan());</b>
<b class="nc">&nbsp;            if (getEntity().isMixedTech()) {</b>
<b class="nc">&nbsp;                introDate = engine.getIntroductionDate();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (introDate &gt; useIntroYear) {</b>
<b class="nc">&nbsp;                retVal = true;</b>
<b class="nc">&nbsp;                buff.append(getEntity().getEngine().getShortEngineName());</b>
<b class="nc">&nbsp;                buff.append(&quot; has intro date of &quot;);</b>
<b class="nc">&nbsp;                buff.append(introDate);</b>
<b class="nc">&nbsp;                buff.append(&quot;\n&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean hasFailedEquipment(StringBuffer buff) {
<b class="nc">&nbsp;        boolean hasFailedEquipment = false;</b>
<b class="nc">&nbsp;        for (Iterator&lt;String&gt; e = getEntity().getFailedEquipment(); e.hasNext();) {</b>
<b class="nc">&nbsp;            String name = e.next();</b>
<b class="nc">&nbsp;            if (!ignoreFailedEquip(name)) {</b>
<b class="nc">&nbsp;                if (!hasFailedEquipment) {</b>
<b class="nc">&nbsp;                    buff.append(&quot;Equipment that Failed to Load:\n&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                buff.append(name).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                hasFailedEquipment = true;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        return hasFailedEquipment;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Check if the unit has combinations of equipment which are not allowed in
&nbsp;     * the construction rules.
&nbsp;     *
&nbsp;     * @param buff
&nbsp;     *            diagnostics are appended to this
&nbsp;     * @return true if the entity is illegal
&nbsp;     */
&nbsp;    public boolean hasIllegalEquipmentCombinations(StringBuffer buff) {
<b class="nc">&nbsp;        boolean illegal = false;</b>
<b class="nc">&nbsp;        int fieldKitchenCount = 0;</b>
<b class="nc">&nbsp;        int minesweeperCount = 0;</b>
<b class="nc">&nbsp;        boolean hasHarjelII = false;</b>
<b class="nc">&nbsp;        boolean hasHarjelIII = false;</b>
<b class="nc">&nbsp;        boolean hasCoolantPod = false;</b>
<b class="nc">&nbsp;        int emergencyCoolantCount = 0;</b>
<b class="nc">&nbsp;        int networks = 0;</b>
<b class="nc">&nbsp;        boolean countedC3 = false;</b>
<b class="nc">&nbsp;        int robotics = 0;</b>
<b class="nc">&nbsp;        boolean hasExternalFuelTank = false;</b>
<b class="nc">&nbsp;        int liftHoists = 0;</b>
<b class="nc">&nbsp;        Map&lt;Integer, Integer&gt; bridgeLayersByLocation = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        Map&lt;Integer, List&lt;EquipmentType&gt;&gt; physicalWeaponsByLocation = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        for (Mounted m : getEntity().getAmmo()) {</b>
<b class="nc">&nbsp;            if (((AmmoType)m.getType()).getAmmoType() == AmmoType.T_COOLANT_POD) {</b>
<b class="nc">&nbsp;                hasCoolantPod = true;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        for (Mounted m : getEntity().getMisc()) {</b>
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</b>
<b class="nc">&nbsp;                emergencyCoolantCount++;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_FIELD_KITCHEN)) {</b>
<b class="nc">&nbsp;                fieldKitchenCount++;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_MINESWEEPER)) {</b>
<b class="nc">&nbsp;                minesweeperCount++;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_LIGHT_FLUID_SUCTION_SYSTEM)) {</b>
<b class="nc">&nbsp;                if (getEntity() instanceof Protomech) {</b>
<b class="nc">&nbsp;                    illegal = true;</b>
<b class="nc">&nbsp;                    buff.append(&quot;ProtoMech can&#39;t mount light fluid suction system\n&quot;);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_VOIDSIG)</b>
<b class="nc">&nbsp;                    &amp;&amp; !getEntity().hasWorkingMisc(MiscType.F_ECM)) {</b>
<b class="nc">&nbsp;                illegal = true;</b>
<b class="nc">&nbsp;                buff.append(&quot;void signature system needs ECM suite\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_HARJEL_II)) {</b>
<b class="nc">&nbsp;                hasHarjelII = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_HARJEL_III)) {</b>
<b class="nc">&nbsp;                hasHarjelIII = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_FUEL)) {</b>
<b class="nc">&nbsp;                hasExternalFuelTank = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            if ((m.getType().hasFlag(MiscType.F_C3S) || m.getType().hasFlag(MiscType.F_C3SBS)) &amp;&amp; !countedC3) {</b>
<b class="nc">&nbsp;                networks++;</b>
<b class="nc">&nbsp;                countedC3 = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_C3I) || m.getType().hasFlag(MiscType.F_NOVA)) {</b>
<b class="nc">&nbsp;                networks++;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_SRCS) || m.getType().hasFlag(MiscType.F_SASRCS)</b>
<b class="nc">&nbsp;                    || m.getType().hasFlag(MiscType.F_CASPAR) || m.getType().hasFlag(MiscType.F_CASPARII)) {</b>
<b class="nc">&nbsp;                robotics++;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_LIFTHOIST)) {</b>
<b class="nc">&nbsp;                liftHoists++;</b>
<b class="nc">&nbsp;            } else if ((m.getLocation() &gt; 0)</b>
<b class="nc">&nbsp;                    &amp;&amp; ((m.getType().hasFlag(MiscType.F_CLUB) &amp;&amp; !((MiscType) m.getType()).isShield())</b>
<b class="nc">&nbsp;                    || m.getType().hasFlag(MiscType.F_BULLDOZER)</b>
<b class="nc">&nbsp;                    || m.getType().hasFlag(MiscType.F_HAND_WEAPON))) {</b>
<b class="nc">&nbsp;                physicalWeaponsByLocation.computeIfAbsent(m.getLocation(), ArrayList::new).add(m.getType());</b>
<b class="nc">&nbsp;            } else if (m.getType().hasFlag(MiscType.F_LIGHT_BRIDGE_LAYER)</b>
<b class="nc">&nbsp;                    || m.getType().hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</b>
<b class="nc">&nbsp;                    || m.getType().hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)) {</b>
<b class="nc">&nbsp;                bridgeLayersByLocation.merge(m.getLocation(), 1, Integer::sum);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if ((networks &gt; 0) &amp;&amp; !countedC3) {</b>
<b class="nc">&nbsp;            for (Mounted m : getEntity().getIndividualWeaponList()) {</b>
<b class="nc">&nbsp;                if (m.getType().hasFlag(WeaponType.F_C3M) || m.getType().hasFlag(WeaponType.F_C3MBS)) {</b>
<b class="nc">&nbsp;                    networks++;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((isMech() || isTank() || isAero())</b>
<b class="nc">&nbsp;                &amp;&amp; (!getEntity().hasEngine()</b>
<b class="nc">&nbsp;                        || (!getEntity().getEngine().isFusion()</b>
<b class="nc">&nbsp;                                &amp;&amp; (getEntity().getEngine().getEngineType() != Engine.FISSION)))) {</b>
<b class="nc">&nbsp;            for (Mounted m : getEntity().getWeaponList()) {</b>
<b class="nc">&nbsp;                if (((WeaponType) m.getType()).getAmmoType() == AmmoType.T_IGAUSS_HEAVY) {</b>
<b class="nc">&nbsp;                    buff.append(&quot;Improved Heavy Gauss requires a fusion or fission engine.\n&quot;);</b>
<b class="nc">&nbsp;                    illegal = true;</b>
<b class="nc">&nbsp;                } else if (m.getType().hasFlag(WeaponType.F_FLAMER)</b>
<b class="nc">&nbsp;                        &amp;&amp; (((WeaponType) m.getType()).getAmmoType() == AmmoType.T_NA)</b>
<b class="nc">&nbsp;                        &amp;&amp; (!getEntity().hasEngine() || (!getEntity().getEngine().isFusion()</b>
<b class="nc">&nbsp;                                &amp;&amp; (getEntity().getEngine().getEngineType() != Engine.FISSION)))) {</b>
<b class="nc">&nbsp;                    buff.append(&quot;Standard flamers require a fusion or fission engine.\n&quot;);</b>
<b class="nc">&nbsp;                    illegal = true;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        if (hasExternalFuelTank</b>
<b class="nc">&nbsp;                &amp;&amp; (!getEntity().hasEngine() ||((getEntity().getEngine().getEngineType() != Engine.COMBUSTION_ENGINE)</b>
<b class="nc">&nbsp;                &amp;&amp; (getEntity().getEngine().getEngineType() != Engine.FUEL_CELL)))) {</b>
<b class="nc">&nbsp;            illegal = true;</b>
<b class="nc">&nbsp;            buff.append(&quot;Extended fuel tanks can only be used with internal combustion or fuel cell engines.\n&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (minesweeperCount &gt; 1) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Unit has more than one minesweeper!\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (fieldKitchenCount &gt; 3) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Unit has more than three Field Kitchens\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (hasCoolantPod &amp;&amp; (emergencyCoolantCount &gt; 0)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Unit has coolant pod and RISC emergency coolant system\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (emergencyCoolantCount &gt; 1) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Unit has more than one RISC emergency coolant system\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!(getEntity() instanceof Mech) &amp;&amp; (hasHarjelII || hasHarjelIII)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Cannot mount HarJel repair system on non-Mech\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (networks &gt; 1) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Cannot have multiple network types on the same unit.\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (robotics &gt; 1) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Unit has multiple drone control systems.\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (getEntity().hasStealth() &amp;&amp; !getEntity().hasWorkingMisc(MiscType.F_ECM)) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Stealth armor requires an ECM generator.\n&quot;);</b>
<b class="nc">&nbsp;            illegal = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if ((getEntity() instanceof Mech) &amp;&amp; (liftHoists &gt; 2)) {</b>
<b class="nc">&nbsp;            illegal = true;</b>
<b class="nc">&nbsp;            buff.append(&quot;Can mount a maximum of two lift hoists.\n&quot;);</b>
<b class="nc">&nbsp;        } else if ((getEntity().isSupportVehicle() || (getEntity() instanceof Tank)) &amp;&amp; (liftHoists &gt; 4)) {</b>
<b class="nc">&nbsp;            illegal = true;</b>
<b class="nc">&nbsp;            buff.append(&quot;Can mount a maximum of four lift hoists.\n&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        for (List&lt;EquipmentType&gt; list : physicalWeaponsByLocation.values()) {</b>
<b class="nc">&nbsp;            if (list.size() &gt; 1) {</b>
<b class="nc">&nbsp;                illegal = true;</b>
<b class="nc">&nbsp;                buff.append(list.stream().map(EquipmentType::getName).collect(Collectors.joining(&quot;, &quot;)))</b>
<b class="nc">&nbsp;                        .append(&quot; cannot be mounted in the same location.\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        for (int count : bridgeLayersByLocation.values()) {</b>
<b class="nc">&nbsp;            if (count &gt; 1) {</b>
<b class="nc">&nbsp;                illegal = true;</b>
<b class="nc">&nbsp;                buff.append(&quot;Cannot mount more than one bridge builder in the same location.\n&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if (getEntity().isOmni()) {</b>
<b class="nc">&nbsp;            for (Mounted m : getEntity().getEquipment()) {</b>
<b class="nc">&nbsp;                if (m.isOmniPodMounted() &amp;&amp; m.getType().isOmniFixedOnly()) {</b>
<b class="nc">&nbsp;                    illegal = true;</b>
<b class="nc">&nbsp;                    buff.append(m.getType().getName()).append(&quot; cannot be pod mounted.&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        } else {
<b class="nc">&nbsp;            for (Mounted m : getEntity().getEquipment()) {</b>
<b class="nc">&nbsp;                if (m.isOmniPodMounted()) {</b>
<b class="nc">&nbsp;                    buff.append(m.getType().getName()).append(&quot; is pod mounted in non-omni unit\n&quot;);</b>
<b class="nc">&nbsp;                    illegal = true;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            for (Transporter t : getEntity().getTransports()) {</b>
<b class="nc">&nbsp;                if (getEntity().isPodMountedTransport(t)) {</b>
<b class="nc">&nbsp;                    buff.append(&quot;Pod mounted troop space in non-omni unit\n&quot;);</b>
<b class="nc">&nbsp;                    illegal = true;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Mounted mounted : getEntity().getEquipment()) {</b>
<b class="nc">&nbsp;            if (mounted.getLocation() &gt; Entity.LOC_NONE) {</b>
<b class="nc">&nbsp;                illegal |= !isValidLocation(getEntity(), mounted.getType(), mounted.getLocation(), buff);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return illegal;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param entity    The entity
&nbsp;     * @param eq        The equipment
&nbsp;     * @param location  A location index on the Entity
&nbsp;     * @param buffer    If non-null and the location is invalid, will be appended with an explanation
&nbsp;     * @return          Whether the equipment can be mounted in the location on the Entity
&nbsp;     */
&nbsp;    public static boolean isValidLocation(Entity entity, EquipmentType eq, int location,
&nbsp;                                          @Nullable StringBuffer buffer) {
<b class="nc">&nbsp;        if (entity instanceof Mech) {</b>
<b class="nc">&nbsp;            return TestMech.isValidMechLocation((Mech) entity, eq, location, buffer);</b>
<b class="nc">&nbsp;        } else if (entity instanceof Tank) {</b>
<b class="nc">&nbsp;            return TestTank.isValidTankLocation((Tank) entity, eq, location, buffer);</b>
<b class="nc">&nbsp;        } else if (entity instanceof Protomech) {</b>
<b class="nc">&nbsp;            return TestProtomech.isValidProtomechLocation((Protomech) entity, eq, location, buffer);</b>
<b class="nc">&nbsp;        } else if (entity.isFighter()) {</b>
<b class="nc">&nbsp;            return TestAero.isValidAeroLocation(eq, location, buffer);</b>
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    public StringBuffer printFailedEquipment(StringBuffer buff) {
<b class="nc">&nbsp;        if (getEntity().getFailedEquipment().hasNext()) {</b>
<b class="nc">&nbsp;            buff.append(&quot;Equipment that Failed to Load:\n&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Iterator&lt;String&gt; e = getEntity().getFailedEquipment(); e.hasNext();) {</b>
<b class="nc">&nbsp;            buff.append(e.next()).append(&quot;\n&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return buff;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightCarryingSpace() {
<b class="nc">&nbsp;        double weight = getEntity().getTroopCarryingSpace();</b>
<b class="nc">&nbsp;        for (Bay bay : getEntity().getTransportBays()) {</b>
<b class="nc">&nbsp;            if (!bay.isQuarters()) {</b>
<b class="nc">&nbsp;                TestEntity.ceil(weight += bay.getWeight(), Ceil.KILO);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return weight;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printWeightCarryingSpace() {
<b class="nc">&nbsp;        String carryingSpace = &quot;&quot;;</b>
<b class="nc">&nbsp;        if (getEntity().getTroopCarryingSpace() != 0) {</b>
<b class="nc">&nbsp;            carryingSpace = StringUtil.makeLength(&quot;Carrying Capacity:&quot;,</b>
<b class="nc">&nbsp;                    getPrintSize() - 5)</b>
<b class="nc">&nbsp;                    + TestEntity.makeWeightString(getEntity()</b>
<b class="nc">&nbsp;                            .getTroopCarryingSpace(), usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        String cargoWeightString = &quot;&quot;;</b>
<b class="nc">&nbsp;        double cargoWeight = 0;</b>
<b class="nc">&nbsp;        for (Bay bay : getEntity().getTransportBays()) {</b>
<b class="nc">&nbsp;            cargoWeight += bay.getWeight();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (cargoWeight &gt; 0) {</b>
<b class="nc">&nbsp;            cargoWeightString = StringUtil.makeLength(&quot;Cargo Weight:&quot;,</b>
<b class="nc">&nbsp;                    getPrintSize() - 5)</b>
<b class="nc">&nbsp;                    + TestEntity.makeWeightString(cargoWeight, usesKgStandard()) + &quot;\n&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        return carryingSpace + cargoWeightString;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printArmorLocation(int loc) {
<b class="nc">&nbsp;        if (getEntity().hasRearArmor(loc)) {</b>
<b class="nc">&nbsp;            return StringUtil.makeLength(</b>
<b class="nc">&nbsp;                    getEntity().getLocationAbbr(loc) + &quot;:&quot;, 5)</b>
<b class="nc">&nbsp;                    + StringUtil.makeLength(getEntity().getOInternal(loc), 4)</b>
<b class="nc">&nbsp;                    + StringUtil.makeLength(getEntity().getOArmor(loc), 3)</b>
&nbsp;                    + &quot; / &quot;
&nbsp;                    + StringUtil
<b class="nc">&nbsp;                            .makeLength(getEntity().getOArmor(loc, true), 2);</b>
&nbsp;        }
<b class="nc">&nbsp;        return StringUtil.makeLength(getEntity().getLocationAbbr(loc) + &quot;:&quot;, 5)</b>
<b class="nc">&nbsp;                + StringUtil.makeLength(getEntity().getOInternal(loc), 4)</b>
<b class="nc">&nbsp;                + StringUtil.makeLength(getEntity().getOArmor(loc), 6) + &quot;  &quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printArmorPlacement() {
<b class="nc">&nbsp;        StringBuffer buff = new StringBuffer();</b>
<b class="nc">&nbsp;        buff.append(&quot;Armor Placement:\n&quot;);</b>
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; getEntity().locations(); loc++) {</b>
<b class="nc">&nbsp;            buff.append(printArmorLocation(loc)).append(&quot;\n&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return buff.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printSource(){
<b class="nc">&nbsp;        return &quot;Source: &quot; + getEntity().getSource() + &quot;\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String printTechLevel() {
<b class="nc">&nbsp;        return &quot;Chassis: &quot; + getEntity().getDisplayName() + &quot; - &quot;</b>
<b class="nc">&nbsp;                + TechConstants.getLevelName(getEntity().getTechLevel()) + &quot; (&quot;</b>
<b class="nc">&nbsp;                + getEntity().getYear() + &quot;)\n&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double getArmoredComponentWeight() {
<b class="fc">&nbsp;        return 0.0;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static boolean usesKgStandard(Entity entity) {
<b class="fc">&nbsp;        return entity.hasETypeFlag(Entity.ETYPE_BATTLEARMOR)</b>
<b class="fc">&nbsp;                || entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)</b>
<b class="fc">&nbsp;                || (EntityWeightClass.getWeightClass(entity.getWeight(), entity)</b>
&nbsp;                        == EntityWeightClass.WEIGHT_SMALL_SUPPORT);
&nbsp;    }
&nbsp;
&nbsp;    boolean usesKgStandard() {
<b class="fc">&nbsp;        return usesKgStandard(getEntity());</b>
&nbsp;    }
&nbsp;
&nbsp;} // End class TestEntity
&nbsp;
&nbsp;class Armor {
&nbsp;    public static final int CLAN_ARMOR = 0x01;
&nbsp;
&nbsp;    private int armorType;
&nbsp;
&nbsp;    private int armorFlags;
&nbsp;
&nbsp;    public Armor(int armorType, int armorFlags) {
&nbsp;        this.armorType = armorType;
&nbsp;        this.armorFlags = armorFlags;
&nbsp;    }
&nbsp;    
&nbsp;    public double getWeightArmor(int totalOArmor, TestEntity.Ceil roundWeight) {
&nbsp;        return Armor.getWeightArmor(armorType, armorFlags, totalOArmor,
&nbsp;                roundWeight);
&nbsp;    }
&nbsp;    
&nbsp;    public double getRawWeightArmor(int totalOArmor) {
&nbsp;        return Armor.getRawWeightArmor(armorType, armorFlags, totalOArmor);
&nbsp;    }
&nbsp;    
&nbsp;    public static double getRawWeightArmor(int armorType, int armorFlags,
&nbsp;            int totalOArmor) {
&nbsp;        double points = totalOArmor;
&nbsp;        int techLevel;
&nbsp;        if ((armorFlags &amp; CLAN_ARMOR) != 0) {
&nbsp;            techLevel = TechConstants.T_CLAN_TW;
&nbsp;        } else {
&nbsp;            techLevel = TechConstants.T_IS_TW_NON_BOX;
&nbsp;        }
&nbsp;        double multiplier = EquipmentType.getArmorPointMultiplier(armorType,
&nbsp;                techLevel);
&nbsp;        points /= multiplier;
&nbsp;        double pointsPerTon = 16.0f;
&nbsp;        return points / pointsPerTon;
&nbsp;    }
&nbsp;
&nbsp;    public static double getWeightArmor(int armorType, int armorFlags,
&nbsp;            int totalOArmor, TestEntity.Ceil roundWeight) {
&nbsp;        return TestEntity.ceilMaxHalf(getRawWeightArmor(armorType, armorFlags, totalOArmor), roundWeight);
&nbsp;    }
&nbsp;
&nbsp;    public String getShortName() {
&nbsp;        return &quot;(&quot; + EquipmentType.getArmorTypeName(armorType) + &quot;)&quot;;
&nbsp;    }
&nbsp;
&nbsp;} // end class Armor
&nbsp;
&nbsp;class Structure {
&nbsp;
&nbsp;    private int structureType;
&nbsp;    private boolean isSuperHeavy;
&nbsp;    private EntityMovementMode movementmode;
&nbsp;
&nbsp;    public Structure() {
&nbsp;    }
&nbsp;
&nbsp;    public Structure(int structureType, boolean superHeavy,
&nbsp;            EntityMovementMode movementMode) {
&nbsp;        this.structureType = structureType;
&nbsp;        isSuperHeavy = superHeavy;
&nbsp;        movementmode = movementMode;
&nbsp;    }
&nbsp;
&nbsp;    public double getWeightStructure(double weight, TestEntity.Ceil roundWeight) {
&nbsp;        return Structure.getWeightStructure(structureType, weight, roundWeight,
&nbsp;                isSuperHeavy, movementmode);
&nbsp;    }
&nbsp;
&nbsp;    public static double getWeightStructure(int structureType, double weight,
&nbsp;            TestEntity.Ceil roundWeight, boolean isSuperHeavy,
&nbsp;            EntityMovementMode movementmode) {
&nbsp;        double multiplier = 1.0;
&nbsp;        if (movementmode == EntityMovementMode.TRIPOD) {
&nbsp;            multiplier = 1.1;
&nbsp;        }
&nbsp;        if (structureType == EquipmentType.T_STRUCTURE_ENDO_STEEL) {
&nbsp;            if (isSuperHeavy) {
&nbsp;                return TestEntity.ceilMaxHalf((weight / 10.0f) * multiplier,
&nbsp;                        roundWeight);
&nbsp;            } else {
&nbsp;                return TestEntity.ceilMaxHalf((weight / 20.0f) * multiplier,
&nbsp;                        roundWeight);
&nbsp;            }
&nbsp;        } else if (structureType == EquipmentType.T_STRUCTURE_ENDO_PROTOTYPE) {
&nbsp;            return TestEntity.ceilMaxHalf((weight / 20.0f) * multiplier,
&nbsp;                    roundWeight);
&nbsp;        } else if (structureType == EquipmentType.T_STRUCTURE_REINFORCED) {
&nbsp;            return TestEntity.ceilMaxHalf((weight / 5.0f) * multiplier,
&nbsp;                    roundWeight);
&nbsp;        } else if (structureType == EquipmentType.T_STRUCTURE_COMPOSITE) {
&nbsp;            return TestEntity.ceilMaxHalf((weight / 20.0f) * multiplier,
&nbsp;                    roundWeight);
&nbsp;        } else if (structureType == EquipmentType.T_STRUCTURE_INDUSTRIAL) {
&nbsp;            if (isSuperHeavy) {
&nbsp;                return TestEntity.ceilMaxHalf((weight / 2.5f) * multiplier,
&nbsp;                        roundWeight);
&nbsp;            } else {
&nbsp;                return TestEntity.ceilMaxHalf((weight / 5.0f) * multiplier,
&nbsp;                        roundWeight);
&nbsp;            }
&nbsp;
&nbsp;        } else if (structureType == EquipmentType.T_STRUCTURE_ENDO_COMPOSITE) {
&nbsp;            if (isSuperHeavy) {
&nbsp;                return TestEntity.ceilMaxHalf((weight / 10.0f) * 1.5f
&nbsp;                        * multiplier, roundWeight);
&nbsp;            } else {
&nbsp;                return TestEntity.ceilMaxHalf((weight / 10.0f) * 0.75f
&nbsp;                        * multiplier, roundWeight);
&nbsp;            }
&nbsp;        }
&nbsp;        if (isSuperHeavy
&nbsp;                &amp;&amp; ((movementmode != EntityMovementMode.NAVAL)
&nbsp;                        &amp;&amp; (movementmode != EntityMovementMode.SUBMARINE))) {
&nbsp;            return TestEntity.ceilMaxHalf((weight / 5.0f) * multiplier,
&nbsp;                    roundWeight);
&nbsp;        } else {
&nbsp;            return TestEntity.ceilMaxHalf((weight / 10.0f) * multiplier,
&nbsp;                    roundWeight);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public String getShortName() {
&nbsp;        return &quot;(&quot; + EquipmentType.getStructureTypeName(structureType) + &quot;)&quot;;
&nbsp;    }
&nbsp;
&nbsp;} // End class Structure
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
