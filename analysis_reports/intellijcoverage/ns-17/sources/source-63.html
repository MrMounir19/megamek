


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > MULParser</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.common</a>
</div>

<h1>Coverage Summary for Class: MULParser (megamek.common)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MULParser</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/57)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1243)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp;* MegaMek -
&nbsp;* Copyright (C) 2014 The MegaMek Team
&nbsp;*
&nbsp;* This program is free software; you can redistribute it and/or modify it under
&nbsp;* the terms of the GNU General Public License as published by the Free Software
&nbsp;* Foundation; either version 2 of the License, or (at your option) any later
&nbsp;* version.
&nbsp;*
&nbsp;* This program is distributed in the hope that it will be useful, but WITHOUT
&nbsp;* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
&nbsp;* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
&nbsp;* details.
&nbsp;*/
&nbsp;
&nbsp;package megamek.common;
&nbsp;
&nbsp;import java.io.InputStream;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.Hashtable;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.Map;
&nbsp;import java.util.StringTokenizer;
&nbsp;import java.util.Vector;
&nbsp;
&nbsp;import javax.xml.parsers.DocumentBuilder;
&nbsp;
&nbsp;import megamek.MegaMek;
&nbsp;import megamek.client.generator.RandomNameGenerator;
&nbsp;import megamek.common.enums.Gender;
&nbsp;import megamek.common.weapons.infantry.InfantryWeapon;
&nbsp;import org.w3c.dom.Document;
&nbsp;import org.w3c.dom.Element;
&nbsp;import org.w3c.dom.Node;
&nbsp;import org.w3c.dom.NodeList;
&nbsp;
&nbsp;import megamek.common.loaders.EntityLoadingException;
&nbsp;import megamek.utils.MegaMekXmlUtil;
&nbsp;
&nbsp;/**
&nbsp; * Class for reading in and parsing MUL XML files.  The MUL xsl is defined in
&nbsp; * the docs directory.
&nbsp; *
&nbsp; * @author arlith
&nbsp; *
&nbsp; */
&nbsp;public class MULParser {
&nbsp;
&nbsp;    public static final String VERSION = &quot;version&quot;;
&nbsp;
&nbsp;    /**
&nbsp;     * The names of the various elements recognized by this parser.
&nbsp;     */
&nbsp;    private static final String RECORD = &quot;record&quot;;
&nbsp;    private static final String SURVIVORS = &quot;survivors&quot;;
&nbsp;    private static final String ALLIES = &quot;allies&quot;;
&nbsp;    private static final String SALVAGE = &quot;salvage&quot;;
&nbsp;    private static final String RETREATED = &quot;retreated&quot;;
&nbsp;    private static final String DEVASTATED = &quot;devastated&quot;;
&nbsp;    private static final String UNIT = &quot;unit&quot;;
&nbsp;    private static final String ENTITY = &quot;entity&quot;;
&nbsp;    private static final String PILOT = &quot;pilot&quot;;
&nbsp;    private static final String CREW = &quot;crew&quot;;
&nbsp;    private static final String CREWTYPE = &quot;crewType&quot;;
&nbsp;    private static final String CREWMEMBER = &quot;crewMember&quot;;
&nbsp;    private static final String KILLS = &quot;kills&quot;;
&nbsp;    private static final String KILL = &quot;kill&quot;;
&nbsp;    private static final String LOCATION = &quot;location&quot;;
&nbsp;    private static final String ARMOR = &quot;armor&quot;;
&nbsp;    private static final String SLOT = &quot;slot&quot;;
&nbsp;    private static final String MOVEMENT = &quot;motive&quot;;
&nbsp;    private static final String TURRETLOCK = &quot;turretlock&quot;;
&nbsp;    private static final String TURRET2LOCK = &quot;turret2lock&quot;;
&nbsp;    private static final String SI = &quot;structural&quot;;
&nbsp;    private static final String HEAT = &quot;heat&quot;;
&nbsp;    private static final String FUEL = &quot;fuel&quot;;
&nbsp;    private static final String KF = &quot;KF&quot;;
&nbsp;    private static final String SAIL = &quot;sail&quot;;
&nbsp;    private static final String AEROCRIT = &quot;acriticals&quot;;
&nbsp;    private static final String DROPCRIT = &quot;dcriticals&quot;;
&nbsp;    private static final String TANKCRIT = &quot;tcriticals&quot;;
&nbsp;    private static final String STABILIZER = &quot;stabilizer&quot;;
&nbsp;    private static final String BREACH = &quot;breached&quot;;
&nbsp;    private static final String BLOWN_OFF = &quot;blownOff&quot;;
&nbsp;    private static final String C3I = &quot;c3iset&quot;;
&nbsp;    private static final String C3ILINK = &quot;c3i_link&quot;;
&nbsp;    private static final String NC3 = &quot;NC3set&quot;;
&nbsp;    private static final String NC3LINK = &quot;NC3_link&quot;;
&nbsp;    private static final String LINK = &quot;link&quot;;
&nbsp;    private static final String RFMG = &quot;rfmg&quot;;
&nbsp;    private static final String ESCCRAFT = &quot;EscapeCraft&quot;;
&nbsp;    private static final String ID = &quot;id&quot;;
&nbsp;    private static final String ESCCREW = &quot;EscapedCrew&quot;;
&nbsp;    private static final String ESCPASS = &quot;EscapedPassengers&quot;;
&nbsp;    private static final String NUMBER = &quot;number&quot;;
&nbsp;    private static final String ORIG_PODS = &quot;ONumberOfPods&quot;;
&nbsp;    private static final String ORIG_MEN = &quot;ONumberOfMen&quot;;
&nbsp;    private static final String CONVEYANCE = &quot;Conveyance&quot;;
&nbsp;    private static final String GAME = &quot;Game&quot;;
&nbsp;
&nbsp;    /**
&nbsp;     * The names of attributes generally associated with Entity tags
&nbsp;     */
&nbsp;    private static final String CHASSIS = &quot;chassis&quot;;
&nbsp;    private static final String MODEL = &quot;model&quot;;
&nbsp;    private static final String CAMO_CATEGORY = &quot;camoCategory&quot;;
&nbsp;    private static final String CAMO_FILENAME = &quot;camoFileName&quot;;
&nbsp;
&nbsp;    /**
&nbsp;     * The names of the attributes recognized by this parser. Not every
&nbsp;     * attribute is valid for every element.
&nbsp;     */
&nbsp;
&nbsp;    private static final String NAME = &quot;name&quot;;
&nbsp;    private static final String SIZE = &quot;size&quot;;
&nbsp;    private static final String CURRENTSIZE = &quot;currentsize&quot;;
&nbsp;
&nbsp;    private static final String EXT_ID = &quot;externalId&quot;;
&nbsp;    private static final String PICKUP_ID = &quot;pickUpId&quot;;
&nbsp;    private static final String NICK = &quot;nick&quot;;
&nbsp;    private static final String GENDER = &quot;gender&quot;;
&nbsp;    private static final String CAT_PORTRAIT = &quot;portraitCat&quot;;
&nbsp;    private static final String FILE_PORTRAIT = &quot;portraitFile&quot;;
&nbsp;    private static final String GUNNERY = &quot;gunnery&quot;;
&nbsp;    private static final String GUNNERYL = &quot;gunneryL&quot;;
&nbsp;    private static final String GUNNERYM = &quot;gunneryM&quot;;
&nbsp;    private static final String GUNNERYB = &quot;gunneryB&quot;;
&nbsp;    private static final String PILOTING = &quot;piloting&quot;;
&nbsp;    private static final String ARTILLERY = &quot;artillery&quot;;
&nbsp;    private static final String TOUGH = &quot;toughness&quot;;
&nbsp;    private static final String INITB = &quot;initB&quot;;
&nbsp;    private static final String COMMANDB = &quot;commandB&quot;;
&nbsp;    private static final String HITS = &quot;hits&quot;;
&nbsp;    private static final String ADVS = &quot;advantages&quot;;
&nbsp;    private static final String EDGE = &quot;edge&quot;;
&nbsp;    private static final String IMPLANTS = &quot;implants&quot;;
&nbsp;    private static final String QUIRKS = &quot;quirks&quot;;
&nbsp;    private static final String TROOPER_MISS = &quot;trooperMiss&quot;;
&nbsp;    private static final String DRIVER = &quot;driver&quot;;
&nbsp;    private static final String COMMANDER = &quot;commander&quot;;
&nbsp;    private static final String OFFBOARD = &quot;offboard&quot;;
&nbsp;    private static final String OFFBOARD_DISTANCE = &quot;offboard_distance&quot;;
&nbsp;    private static final String OFFBOARD_DIRECTION = &quot;offboard_direction&quot;;
&nbsp;    private static final String HIDDEN = &quot;hidden&quot;;
&nbsp;    public static final String DEPLOYMENT = &quot;deployment&quot;;
&nbsp;    private static final String DEPLOYMENT_ZONE = &quot;deploymentZone&quot;;
&nbsp;    private static final String NEVER_DEPLOYED = &quot;neverDeployed&quot;;
&nbsp;    private static final String VELOCITY = &quot;velocity&quot;;
&nbsp;    private static final String ALTITUDE = &quot;altitude&quot;;
&nbsp;    private static final String AUTOEJECT = &quot;autoeject&quot;;
&nbsp;    private static final String CONDEJECTAMMO = &quot;condejectammo&quot;;
&nbsp;    private static final String CONDEJECTENGINE = &quot;condejectengine&quot;;
&nbsp;    private static final String CONDEJECTCTDEST = &quot;condejectctdest&quot;;
&nbsp;    private static final String CONDEJECTHEADSHOT = &quot;condejectheadshot&quot;;
&nbsp;    private static final String EJECTED = &quot;ejected&quot;;
&nbsp;    private static final String INDEX = &quot;index&quot;;
&nbsp;    private static final String IS_DESTROYED = &quot;isDestroyed&quot;;
&nbsp;    private static final String IS_REPAIRABLE = &quot;isRepairable&quot;;
&nbsp;    private static final String POINTS = &quot;points&quot;;
&nbsp;    private static final String TYPE = &quot;type&quot;;
&nbsp;    private static final String SHOTS = &quot;shots&quot;;
&nbsp;    private static final String CAPACITY = &quot;capacity&quot;;
&nbsp;    private static final String IS_HIT = &quot;isHit&quot;;
&nbsp;    private static final String MUNITION = &quot;munition&quot;;
&nbsp;    private static final String STANDARD = &quot;standard&quot;;
&nbsp;    private static final String INFERNO = &quot;inferno&quot;;
&nbsp;    private static final String DIRECTION = &quot;direction&quot;;
&nbsp;    private static final String INTEGRITY = &quot;integrity&quot;;
&nbsp;    private static final String SINK = &quot;sinks&quot;;
&nbsp;    private static final String LEFT = &quot;left&quot;;
&nbsp;    private static final String AVIONICS = &quot;avionics&quot;;
&nbsp;    private static final String SENSORS = &quot;sensors&quot;;
&nbsp;    private static final String ENGINE = &quot;engine&quot;;
&nbsp;    private static final String FCS = &quot;fcs&quot;;
&nbsp;    private static final String CIC = &quot;cic&quot;;
&nbsp;    private static final String LEFT_THRUST = &quot;leftThrust&quot;;
&nbsp;    private static final String RIGHT_THRUST = &quot;rightThrust&quot;;
&nbsp;    private static final String LIFE_SUPPORT = &quot;lifeSupport&quot;;
&nbsp;    private static final String GEAR = &quot;gear&quot;;
&nbsp;    private static final String DOCKING_COLLAR = &quot;dockingcollar&quot;;
&nbsp;    private static final String KFBOOM = &quot;kfboom&quot;;
&nbsp;    private static final String BAYDOORS = &quot;doors&quot;;
&nbsp;    private static final String BAY = &quot;transportBay&quot;;
&nbsp;    private static final String LOADED = &quot;loaded&quot;;
&nbsp;    private static final String BAYDAMAGE = &quot;damage&quot;;
&nbsp;    private static final String WEAPONS_BAY_INDEX = &quot;weaponsBayIndex&quot;;
&nbsp;    private static final String MDAMAGE = &quot;damage&quot;;
&nbsp;    private static final String MPENALTY = &quot;penalty&quot;;
&nbsp;    private static final String C3MASTERIS = &quot;c3MasterIs&quot;;
&nbsp;    private static final String C3UUID = &quot;c3UUID&quot;;
&nbsp;    private static final String BOMBS = &quot;bombs&quot;;
&nbsp;    private static final String BOMB = &quot;bomb&quot;;
&nbsp;    private static final String LOAD = &quot;load&quot;;
&nbsp;    private static final String BA_MEA = &quot;modularEquipmentMount&quot;;
&nbsp;    private static final String BA_APM = &quot;antiPersonnelMount&quot;;
&nbsp;    private static final String BA_APM_MOUNT_NUM = &quot;baAPMMountNum&quot;;
&nbsp;    private static final String BA_APM_TYPE_NAME = &quot;baAPMTypeName&quot;;
&nbsp;    private static final String BA_MEA_MOUNT_LOC = &quot;baMEAMountLoc&quot;;
&nbsp;    private static final String BA_MEA_TYPE_NAME = &quot;baMEATypeName&quot;;
&nbsp;    private static final String KILLED = &quot;killed&quot;;
&nbsp;    private static final String KILLER = &quot;killer&quot;;
&nbsp;    private static final String EXTRA_DATA = &quot;extraData&quot;;
&nbsp;
&nbsp;    public static final String ARMOR_DIVISOR = &quot;armorDivisor&quot;;
&nbsp;    public static final String ARMOR_ENC = &quot;armorEncumbering&quot;;
&nbsp;    public static final String DEST_ARMOR = &quot;destArmor&quot;;
&nbsp;    public static final String SPACESUIT = &quot;spacesuit&quot;;
&nbsp;    public static final String SNEAK_CAMO = &quot;sneakCamo&quot;;
&nbsp;    public static final String SNEAK_IR = &quot;sneakIR&quot;;
&nbsp;    public static final String SNEAK_ECM = &quot;sneakECM&quot;;
&nbsp;    public static final String INF_SPEC = &quot;infantrySpecializations&quot;;
&nbsp;    public static final String INF_SQUAD_NUM = &quot;squadNum&quot;;
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Special values recognized by this parser.
&nbsp;     */
&nbsp;    private static final String DEAD = &quot;Dead&quot;;
&nbsp;    private static final String NA = &quot;N/A&quot;;
&nbsp;    private static final String DESTROYED = &quot;Destroyed&quot;;
&nbsp;    private static final String FRONT = &quot;Front&quot;;
&nbsp;    private static final String REAR = &quot;Rear&quot;;
&nbsp;    private static final String INTERNAL = &quot;Internal&quot;;
&nbsp;    private static final String EMPTY = &quot;Empty&quot;;
&nbsp;    private static final String SYSTEM = &quot;System&quot;;
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Stores all of the  Entity&#39;s read in. This is for general use saving and loading to the chat lounge
&nbsp;     */
&nbsp;    Vector&lt;Entity&gt; entities;
&nbsp;
&nbsp;    /**
&nbsp;     * Stores all of the  surviving Entity&#39;s read in.
&nbsp;     */
&nbsp;    Vector&lt;Entity&gt; survivors;
&nbsp;
&nbsp;    /**
&nbsp;     * Stores all of the allied Entity&#39;s read in.
&nbsp;     */
&nbsp;    Vector&lt;Entity&gt; allies;
&nbsp;
&nbsp;    /**
&nbsp;     * Stores all of the enemy retreated entities read in.
&nbsp;     */
&nbsp;    Vector&lt;Entity&gt; retreated;
&nbsp;
&nbsp;    /**
&nbsp;     * Stores all the salvage entities read in
&nbsp;     */
&nbsp;    Vector&lt;Entity&gt; salvage;
&nbsp;
&nbsp;    /**
&nbsp;     * Stores all the devastated entities read in
&nbsp;     */
&nbsp;    Vector&lt;Entity&gt; devastated;
&nbsp;
&nbsp;    /**
&nbsp;     * Keep a separate list of pilot/crews parsed because dismounted pilots may
&nbsp;     * need to be read separately
&nbsp;     */
&nbsp;    private Vector&lt;Crew&gt; pilots;
&nbsp;
&nbsp;    /**
&nbsp;     * A hashtable containing the names of killed units as the key and the external id
&nbsp;     * of the killer as the value
&nbsp;     */
&nbsp;    private Hashtable&lt;String, String&gt; kills;
&nbsp;
&nbsp;
&nbsp;    StringBuffer warning;
&nbsp;
<b class="nc">&nbsp;    public MULParser(){</b>
<b class="nc">&nbsp;        warning = new StringBuffer();</b>
<b class="nc">&nbsp;        entities = new Vector&lt;&gt;();</b>
<b class="nc">&nbsp;        survivors = new Vector&lt;&gt;();</b>
<b class="nc">&nbsp;        allies = new Vector&lt;&gt;();</b>
<b class="nc">&nbsp;        salvage = new Vector&lt;&gt;();</b>
<b class="nc">&nbsp;        retreated = new Vector&lt;&gt;();</b>
<b class="nc">&nbsp;        devastated = new Vector&lt;&gt;();</b>
<b class="nc">&nbsp;        kills = new Hashtable&lt;&gt;();</b>
<b class="nc">&nbsp;        pilots = new Vector&lt;&gt;();</b>
&nbsp;    }
&nbsp;
&nbsp;    public MULParser(InputStream fin){
<b class="nc">&nbsp;        this();</b>
<b class="nc">&nbsp;        parse(fin);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void parse(InputStream fin){
&nbsp;        // Reset the warning message.
<b class="nc">&nbsp;        warning = new StringBuffer();</b>
&nbsp;
&nbsp;        // Clear the entities.
<b class="nc">&nbsp;        entities.removeAllElements();</b>
<b class="nc">&nbsp;        survivors.removeAllElements();</b>
<b class="nc">&nbsp;        allies.removeAllElements();</b>
<b class="nc">&nbsp;        salvage.removeAllElements();</b>
<b class="nc">&nbsp;        retreated.removeAllElements();</b>
<b class="nc">&nbsp;        devastated.removeAllElements();</b>
<b class="nc">&nbsp;        pilots.removeAllElements();</b>
<b class="nc">&nbsp;        kills.clear();</b>
&nbsp;
&nbsp;        Document xmlDoc;
&nbsp;
&nbsp;        try {
&nbsp;            // Using factory get an instance of document builder
<b class="nc">&nbsp;            DocumentBuilder db = MegaMekXmlUtil.newSafeDocumentBuilder();</b>
&nbsp;
&nbsp;            // Parse using builder to get DOM representation of the XML file
<b class="nc">&nbsp;            xmlDoc = db.parse(fin);</b>
<b class="nc">&nbsp;        } catch (Exception ex) {</b>
<b class="nc">&nbsp;            System.err.println(ex.getMessage());</b>
<b class="nc">&nbsp;            ex.printStackTrace(System.err);</b>
<b class="nc">&nbsp;            warning.append(&quot;Error parsing MUL file!\n&quot;);</b>
&nbsp;            return;
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        Element element = xmlDoc.getDocumentElement();</b>
&nbsp;
&nbsp;        // Get rid of empty text nodes and adjacent text nodes...
&nbsp;        // Stupid weird parsing of XML. At least this cleans it up.
<b class="nc">&nbsp;        element.normalize();</b>
&nbsp;
<b class="nc">&nbsp;        parse(element);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void parse(Element element) {
<b class="nc">&nbsp;        String version = element.getAttribute(VERSION);</b>
<b class="nc">&nbsp;        if (version.equals(&quot;&quot;)){</b>
<b class="nc">&nbsp;            warning.append(&quot;Warning: No version specified, correct parsing &quot;)</b>
<b class="nc">&nbsp;                    .append(&quot;not guaranteed!\n&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        String nodeName = element.getNodeName();</b>
<b class="nc">&nbsp;        if(nodeName.equalsIgnoreCase(RECORD)) {</b>
<b class="nc">&nbsp;            parseRecord(element);</b>
<b class="nc">&nbsp;        } else if (nodeName.equalsIgnoreCase(UNIT)){</b>
<b class="nc">&nbsp;            parseUnit(element, entities);</b>
<b class="nc">&nbsp;        } else if (nodeName.equalsIgnoreCase(ENTITY)){</b>
<b class="nc">&nbsp;            parseEntity(element, entities);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            warning.append(&quot;Error: root element isn&#39;t a Record, Unit, or Entity tag! &quot;)</b>
<b class="nc">&nbsp;                    .append(&quot;Nothing to parse!\n&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a Unit tag.  Unit tags will contain a list of Entity tags.
&nbsp;     * @param unitNode
&nbsp;     */
&nbsp;    private void parseRecord(Element unitNode){
<b class="nc">&nbsp;        NodeList nl = unitNode.getChildNodes();</b>
&nbsp;
&nbsp;        // Iterate through the children, looking for Entity tags
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
&nbsp;
<b class="nc">&nbsp;            if (currNode.getParentNode() != unitNode) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                String nodeName = currNode.getNodeName();</b>
<b class="nc">&nbsp;                if (nodeName.equalsIgnoreCase(UNIT)){</b>
<b class="nc">&nbsp;                    parseUnit((Element)currNode, entities);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(SURVIVORS)){</b>
<b class="nc">&nbsp;                    parseUnit((Element)currNode, survivors);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(ALLIES)){</b>
<b class="nc">&nbsp;                    parseUnit((Element)currNode, allies);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(SALVAGE)){</b>
<b class="nc">&nbsp;                    parseUnit((Element)currNode, salvage);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(RETREATED)){</b>
<b class="nc">&nbsp;                    parseUnit((Element)currNode, retreated);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(DEVASTATED)){</b>
<b class="nc">&nbsp;                    parseUnit((Element)currNode, devastated);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(KILLS)){</b>
<b class="nc">&nbsp;                    parseKills((Element)currNode);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(ENTITY)){</b>
<b class="nc">&nbsp;                    parseUnit((Element)currNode, entities);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(PILOT)){</b>
<b class="nc">&nbsp;                    parsePilot((Element)currNode);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(CREW)){</b>
<b class="nc">&nbsp;                    parseCrew((Element)currNode);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a Unit tag.  Unit tags will contain a list of Entity tags.
&nbsp;     * @param unitNode
&nbsp;     * @param list - which list to add found entities too
&nbsp;     */
&nbsp;    private void parseUnit(Element unitNode, Vector&lt;Entity&gt; list){
<b class="nc">&nbsp;        NodeList nl = unitNode.getChildNodes();</b>
&nbsp;
&nbsp;        // Iterate through the children, looking for Entity tags
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
&nbsp;
<b class="nc">&nbsp;            if (currNode.getParentNode() != unitNode) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                String nodeName = currNode.getNodeName();</b>
<b class="nc">&nbsp;                if (nodeName.equalsIgnoreCase(ENTITY)) {</b>
<b class="nc">&nbsp;                    parseEntity((Element)currNode, list);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(PILOT)) {</b>
<b class="nc">&nbsp;                    parsePilot((Element)currNode);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(CREW)) {</b>
<b class="nc">&nbsp;                    parseCrew((Element)currNode);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a kills tag.
&nbsp;     * @param killNode
&nbsp;     */
&nbsp;    private void parseKills(Element killNode){
<b class="nc">&nbsp;        NodeList nl = killNode.getChildNodes();</b>
&nbsp;
&nbsp;        // Iterate through the children, looking for Entity tags
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
&nbsp;
<b class="nc">&nbsp;            if (currNode.getParentNode() != killNode) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                String nodeName = currNode.getNodeName();</b>
<b class="nc">&nbsp;                if (nodeName.equalsIgnoreCase(KILL)){</b>
<b class="nc">&nbsp;                    String killed =  ((Element)currNode).getAttribute(KILLED);</b>
<b class="nc">&nbsp;                    String killer = ((Element)currNode).getAttribute(KILLER);</b>
<b class="nc">&nbsp;                    if(null != killed &amp;&amp; null != killer &amp;&amp; !killed.isEmpty() &amp;&amp; !killer.isEmpty()) {</b>
<b class="nc">&nbsp;                        kills.put(killed, killer);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse an Entity tag.  Entity tags will have a number of attributes such
&nbsp;     * as model, chassis, type, etc.  They should also have a child Pilot tag
&nbsp;     * and they may also contain some number of location tags.
&nbsp;     *
&nbsp;     * @param entityNode
&nbsp;     * @param list - which list to add found entities too
&nbsp;     */
&nbsp;    private void parseEntity(Element entityNode, Vector&lt;Entity&gt; list) {
<b class="nc">&nbsp;        Entity entity = null;</b>
&nbsp;
&nbsp;        // We need to get a new Entity, use the chassis and model to create one
<b class="nc">&nbsp;        String chassis =  entityNode.getAttribute(CHASSIS);</b>
<b class="nc">&nbsp;        String model = entityNode.getAttribute(MODEL);</b>
&nbsp;
&nbsp;        // Create a new entity
<b class="nc">&nbsp;        entity = getEntity(chassis, model);</b>
&nbsp;
&nbsp;        // Make sure we&#39;ve got an Entity
<b class="nc">&nbsp;        if (entity == null) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Failed to load entity!&quot;);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Set the attributes for the entity
<b class="nc">&nbsp;        parseEntityAttributes(entity, entityNode);</b>
&nbsp;
&nbsp;        // Deal with any child nodes
<b class="nc">&nbsp;        NodeList nl = entityNode.getChildNodes();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
<b class="nc">&nbsp;            if (currNode.getParentNode() != entityNode) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                Element currEle = (Element) currNode;</b>
<b class="nc">&nbsp;                String nodeName = currNode.getNodeName();</b>
<b class="nc">&nbsp;                if (nodeName.equalsIgnoreCase(PILOT)) {</b>
<b class="nc">&nbsp;                    parsePilot(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(CREW)) {</b>
<b class="nc">&nbsp;                    parseCrew(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(LOCATION)) {</b>
<b class="nc">&nbsp;                    parseLocation(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(MOVEMENT)) {</b>
<b class="nc">&nbsp;                    parseMovement(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(TURRETLOCK)) {</b>
<b class="nc">&nbsp;                    parseTurretLock(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(TURRET2LOCK)) {</b>
<b class="nc">&nbsp;                    parseTurret2Lock(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(SI)) {</b>
<b class="nc">&nbsp;                    parseSI(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(HEAT)) {</b>
<b class="nc">&nbsp;                    parseHeat(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(FUEL)) {</b>
<b class="nc">&nbsp;                    parseFuel(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(KF)) {</b>
<b class="nc">&nbsp;                    parseKF(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(SAIL)) {</b>
<b class="nc">&nbsp;                    parseSail(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(BAY)) {</b>
<b class="nc">&nbsp;                    parseTransportBay(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(AEROCRIT)) {</b>
<b class="nc">&nbsp;                    parseAeroCrit(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(DROPCRIT)) {</b>
<b class="nc">&nbsp;                    parseDropCrit(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(TANKCRIT)) {</b>
<b class="nc">&nbsp;                    parseTankCrit(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(BOMBS)) {</b>
<b class="nc">&nbsp;                    parseBombs(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(C3I)) {</b>
<b class="nc">&nbsp;                    parseC3I(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(NC3)) {</b>
<b class="nc">&nbsp;                    parseNC3(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(BA_MEA)) {</b>
<b class="nc">&nbsp;                    parseBAMEA(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(BA_APM)) {</b>
<b class="nc">&nbsp;                    parseBAAPM(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(ESCCRAFT)) {</b>
<b class="nc">&nbsp;                    parseEscapeCraft(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(ESCPASS)) {</b>
<b class="nc">&nbsp;                    parseEscapedPassengers(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(ESCCREW)) {</b>
<b class="nc">&nbsp;                    parseEscapedCrew(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(ORIG_PODS)) {</b>
<b class="nc">&nbsp;                    parseOSI(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(ORIG_MEN)) {</b>
<b class="nc">&nbsp;                    parseOMen(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(CONVEYANCE)) {</b>
<b class="nc">&nbsp;                    parseConveyance(currEle, entity);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(GAME)) {</b>
<b class="nc">&nbsp;                    parseId(currEle, entity);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        //Now we should be done setting up the Entity, add it to the list
<b class="nc">&nbsp;        list.add(entity);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Create a new &lt;code&gt;Entity&lt;/code&gt; instance given a mode and chassis name.
&nbsp;     *
&nbsp;     * @param chassis
&nbsp;     * @param model
&nbsp;     * @return
&nbsp;     */
&nbsp;    private Entity getEntity(String chassis, String model){
<b class="nc">&nbsp;        Entity newEntity = null;</b>
&nbsp;
&nbsp;        //first check for ejected mechwarriors, vee crews, escape pods and spacecraft crews
<b class="nc">&nbsp;        if (chassis.equals(EjectedCrew.VEE_EJECT_NAME) </b>
<b class="nc">&nbsp;                || chassis.equals(EjectedCrew.SPACE_EJECT_NAME)) {</b>
<b class="nc">&nbsp;            return new EjectedCrew();</b>
<b class="nc">&nbsp;        } else if (chassis.equals(EjectedCrew.PILOT_EJECT_NAME)</b>
<b class="nc">&nbsp;                    || chassis.equals(EjectedCrew.MW_EJECT_NAME)) {</b>
<b class="nc">&nbsp;            return new MechWarrior();</b>
<b class="nc">&nbsp;        } else if (chassis.equals(EscapePods.POD_EJECT_NAME)) {</b>
<b class="nc">&nbsp;            return new EscapePods();</b>
&nbsp;        }
&nbsp;
&nbsp;        // Did we find required attributes?
<b class="nc">&nbsp;        if ((chassis == null) || (chassis.length() == 0)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Could not find chassis for Entity.\n&quot;);</b>
&nbsp;        } else {
&nbsp;            // Try to find the entity.
<b class="nc">&nbsp;            MechSummary ms = null;</b>
<b class="nc">&nbsp;            StringBuffer key = new StringBuffer(chassis);</b>
<b class="nc">&nbsp;            ms = MechSummaryCache.getInstance().getMech(key.toString());</b>
<b class="nc">&nbsp;            if ((model != null) &amp;&amp; (model.length() &gt; 0)) {</b>
<b class="nc">&nbsp;                key.append(&quot; &quot;).append(model);</b>
<b class="nc">&nbsp;                ms = MechSummaryCache.getInstance().getMech(</b>
<b class="nc">&nbsp;                        key.toString());</b>
&nbsp;                // That didn&#39;t work. Try swaping model and chassis.
<b class="nc">&nbsp;                if (ms == null) {</b>
<b class="nc">&nbsp;                    key = new StringBuffer(model);</b>
<b class="nc">&nbsp;                    key.append(&quot; &quot;).append(chassis);</b>
<b class="nc">&nbsp;                    ms = MechSummaryCache.getInstance().getMech(</b>
<b class="nc">&nbsp;                            key.toString());</b>
&nbsp;                }
&nbsp;            }
&nbsp;            // We should have found the mech.
<b class="nc">&nbsp;            if (ms == null) {</b>
<b class="nc">&nbsp;                warning.append(&quot;Could not find Entity with chassis: &quot;).append(chassis);</b>
<b class="nc">&nbsp;                if ((model != null) &amp;&amp; (model.length() &gt; 0)) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;, and model: &quot;).append(model);</b>
&nbsp;                }
<b class="nc">&nbsp;                warning.append(&quot;.\n&quot;);</b>
&nbsp;            } else {
&nbsp;                // Try to load the new mech.
&nbsp;                try {
<b class="nc">&nbsp;                    newEntity = new MechFileParser(ms.getSourceFile(),</b>
<b class="nc">&nbsp;                            ms.getEntryName()).getEntity();</b>
<b class="nc">&nbsp;                } catch (EntityLoadingException excep) {</b>
<b class="nc">&nbsp;                    excep.printStackTrace(System.err);</b>
<b class="nc">&nbsp;                    warning.append(&quot;Unable to load mech: &quot;)</b>
<b class="nc">&nbsp;                            .append(ms.getSourceFile()).append(&quot;: &quot;)</b>
<b class="nc">&nbsp;                            .append(ms.getEntryName()).append(&quot;: &quot;)</b>
<b class="nc">&nbsp;                            .append(excep.getMessage());</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            } // End found-MechSummary
&nbsp;        }
<b class="nc">&nbsp;        return newEntity;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * An Entity tag can define numerous attributes for the &lt;code&gt;Entity&lt;/code&gt;,
&nbsp;     * check and set all of the relevant attributes.
&nbsp;     *
&nbsp;     * @param entity    The newly created Entity that we are setting state for
&nbsp;     * @param entityTag The Entity tag that defines the attributes
&nbsp;     */
&nbsp;    private void parseEntityAttributes(Entity entity, Element entityTag){
&nbsp;        // commander
<b class="nc">&nbsp;        boolean commander =</b>
<b class="nc">&nbsp;                Boolean.parseBoolean(entityTag.getAttribute(COMMANDER));</b>
<b class="nc">&nbsp;        entity.setCommander(commander);</b>
&nbsp;
&nbsp;        // hidden
&nbsp;        try {
<b class="nc">&nbsp;            boolean isHidden =</b>
<b class="nc">&nbsp;                    Boolean.parseBoolean(entityTag.getAttribute(HIDDEN));</b>
<b class="nc">&nbsp;            entity.setHidden(isHidden);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            entity.setHidden(false);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // deploy offboard
&nbsp;        try {
<b class="nc">&nbsp;            boolean offBoard =</b>
<b class="nc">&nbsp;                    Boolean.parseBoolean(entityTag.getAttribute(OFFBOARD));</b>
<b class="nc">&nbsp;            if (offBoard) {</b>
<b class="nc">&nbsp;                int distance = Integer.parseInt(entityTag</b>
<b class="nc">&nbsp;                        .getAttribute(OFFBOARD_DISTANCE));</b>
<b class="nc">&nbsp;                OffBoardDirection dir = OffBoardDirection.getDirection(Integer</b>
<b class="nc">&nbsp;                        .parseInt(entityTag.getAttribute(OFFBOARD_DIRECTION)));</b>
<b class="nc">&nbsp;                entity.setOffBoard(distance, dir);</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (Exception ignored) {</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // deployment round
&nbsp;        try {
<b class="nc">&nbsp;            int deployRound = Integer.parseInt(entityTag.getAttribute(DEPLOYMENT));</b>
<b class="nc">&nbsp;            entity.setDeployRound(deployRound);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            entity.setDeployRound(0);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // deployment zone
&nbsp;        try {
<b class="nc">&nbsp;            int deployZone = Integer.parseInt(entityTag.getAttribute(DEPLOYMENT_ZONE));</b>
<b class="nc">&nbsp;            entity.setStartingPos(deployZone);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            entity.setStartingPos(Board.START_NONE);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;        // Was never deployed
&nbsp;        try {
<b class="nc">&nbsp;            String ndeploy = entityTag.getAttribute(NEVER_DEPLOYED);</b>
<b class="nc">&nbsp;            boolean wasNeverDeployed =</b>
<b class="nc">&nbsp;                    Boolean.parseBoolean(entityTag.getAttribute(NEVER_DEPLOYED));</b>
<b class="nc">&nbsp;            if(null == ndeploy || ndeploy.isEmpty()) {</b>
&nbsp;                //this will default to false above, but we want it to default to true
<b class="nc">&nbsp;                wasNeverDeployed = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            entity.setNeverDeployed(wasNeverDeployed);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            entity.setNeverDeployed(true);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if (entity.isAero()) {</b>
<b class="nc">&nbsp;            String velString = entityTag.getAttribute(VELOCITY);</b>
<b class="nc">&nbsp;            String altString = entityTag.getAttribute(ALTITUDE);</b>
&nbsp;
<b class="nc">&nbsp;            IAero a = (IAero) entity;</b>
<b class="nc">&nbsp;            if (velString.length() &gt; 0){</b>
<b class="nc">&nbsp;                int velocity = Integer.parseInt(velString);</b>
<b class="nc">&nbsp;                a.setCurrentVelocity(velocity);</b>
<b class="nc">&nbsp;                a.setNextVelocity(velocity);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (altString.length() &gt; 0){</b>
<b class="nc">&nbsp;                int altitude = Integer.parseInt(altString);</b>
<b class="nc">&nbsp;                if (altitude &lt;= 0) {</b>
<b class="nc">&nbsp;                    a.land();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    a.liftOff(altitude);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Camo
&nbsp;        // Must be a null, and not an empty string, if it isn&#39;t being used. - Dylan 2014-04-04
<b class="nc">&nbsp;        entity.setCamoCategory(entityTag.getAttribute(CAMO_CATEGORY).equals(&quot;&quot;) ? null : entityTag.getAttribute(CAMO_CATEGORY));</b>
<b class="nc">&nbsp;        entity.setCamoFileName(entityTag.getAttribute(CAMO_FILENAME).equals(&quot;&quot;) ? null : entityTag.getAttribute(CAMO_FILENAME));</b>
&nbsp;
&nbsp;        // external id
<b class="nc">&nbsp;        String extId = entityTag.getAttribute(EXT_ID);</b>
<b class="nc">&nbsp;        if ((null == extId) || (extId.length() == 0)) {</b>
<b class="nc">&nbsp;            extId = &quot;-1&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        entity.setExternalIdAsString(extId);</b>
&nbsp;
&nbsp;        // external id
<b class="nc">&nbsp;        if(entity instanceof MechWarrior) {</b>
<b class="nc">&nbsp;            String pickUpId = entityTag.getAttribute(PICKUP_ID);</b>
<b class="nc">&nbsp;            if ((null == pickUpId) || (pickUpId.length() == 0)) {</b>
<b class="nc">&nbsp;                pickUpId = &quot;-1&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            ((MechWarrior)entity).setPickedUpByExternalId(pickUpId);</b>
&nbsp;        }
&nbsp;
&nbsp;
&nbsp;        // quirks
<b class="nc">&nbsp;        String quirks = entityTag.getAttribute(QUIRKS);</b>
<b class="nc">&nbsp;        if ((null != quirks) &amp;&amp; (quirks.trim().length() &gt; 0)) {</b>
<b class="nc">&nbsp;            StringTokenizer st = new StringTokenizer(quirks, &quot;::&quot;);</b>
<b class="nc">&nbsp;            while (st.hasMoreTokens()) {</b>
<b class="nc">&nbsp;                String quirk = st.nextToken();</b>
<b class="nc">&nbsp;                String quirkName = Crew.parseAdvantageName(quirk);</b>
<b class="nc">&nbsp;                Object value = Crew.parseAdvantageValue(quirk);</b>
&nbsp;
&nbsp;                try {
<b class="nc">&nbsp;                    entity.getQuirks().getOption(quirkName)</b>
<b class="nc">&nbsp;                            .setValue(value);</b>
<b class="nc">&nbsp;                } catch (Exception e) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;Error restoring quirk: &quot;)</b>
<b class="nc">&nbsp;                            .append(quirk).append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
&nbsp;        // Setup for C3 Relinking
<b class="nc">&nbsp;        String c3masteris = entityTag.getAttribute(C3MASTERIS);</b>
<b class="nc">&nbsp;        if (c3masteris.length() &gt; 0) {</b>
<b class="nc">&nbsp;            entity.setC3MasterIsUUIDAsString(c3masteris);</b>
&nbsp;        }
<b class="nc">&nbsp;        String c3uuid = entityTag.getAttribute(C3UUID);</b>
<b class="nc">&nbsp;        if (c3uuid.length() &gt; 0) {</b>
<b class="nc">&nbsp;            entity.setC3UUIDAsString(c3uuid);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Load some values for conventional infantry
<b class="nc">&nbsp;        if ((entity instanceof Infantry)</b>
&nbsp;                &amp;&amp; !(entity instanceof BattleArmor)) {
<b class="nc">&nbsp;            Infantry inf = (Infantry) entity;</b>
<b class="nc">&nbsp;            String armorDiv = entityTag.getAttribute(ARMOR_DIVISOR);</b>
<b class="nc">&nbsp;            if (armorDiv.length() &gt; 0) {</b>
<b class="nc">&nbsp;                inf.setArmorDamageDivisor(Double.parseDouble(armorDiv));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (entityTag.getAttribute(ARMOR_ENC).length() &gt; 0) {</b>
<b class="nc">&nbsp;                inf.setArmorEncumbering(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (entityTag.getAttribute(SPACESUIT).length() &gt; 0) {</b>
<b class="nc">&nbsp;                inf.setSpaceSuit(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (entityTag.getAttribute(DEST_ARMOR).length() &gt; 0) {</b>
<b class="nc">&nbsp;                inf.setDEST(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (entityTag.getAttribute(SNEAK_CAMO).length() &gt; 0) {</b>
<b class="nc">&nbsp;                inf.setSneakCamo(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (entityTag.getAttribute(SNEAK_IR).length() &gt; 0) {</b>
<b class="nc">&nbsp;                inf.setSneakIR(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (entityTag.getAttribute(SNEAK_ECM).length() &gt; 0) {</b>
<b class="nc">&nbsp;                inf.setSneakECM(true);</b>
&nbsp;            }
<b class="nc">&nbsp;            String infSpec = entityTag.getAttribute(INF_SPEC);</b>
<b class="nc">&nbsp;            if (infSpec.length() &gt; 0) {</b>
<b class="nc">&nbsp;                inf.setSpecializations(Integer.parseInt(infSpec));</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            String infSquadNum = entityTag.getAttribute(INF_SQUAD_NUM);</b>
<b class="nc">&nbsp;            if(infSquadNum.length() &gt; 0) {</b>
<b class="nc">&nbsp;                inf.setSquadN(Integer.parseInt(infSquadNum));</b>
<b class="nc">&nbsp;                inf.autoSetInternal();</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Convenience function that calls &lt;code&gt;parsePilot&lt;/code&gt; with a null
&nbsp;     * Entity.
&nbsp;     *
&nbsp;     * @param pilotNode The Pilot tag to create a &lt;code&gt;Crew&lt;/code&gt; from
&nbsp;     */
&nbsp;    private void parsePilot(Element pilotNode){
<b class="nc">&nbsp;        parsePilot(pilotNode, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Given a pilot tag, read the attributes and create a new &lt;code&gt;Crew&lt;/code&gt;
&nbsp;     * instance.  If a non-null &lt;code&gt;Entity&lt;/code&gt; is passed, the new crew will
&nbsp;     * be set as the crew for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param pilotNode The Pilot tag to create a &lt;code&gt;Crew&lt;/code&gt; from
&nbsp;     * @param entity    If non-null, the new &lt;code&gt;Crew&lt;/code&gt; will be set as
&nbsp;     *                  the crew of this &lt;code&gt;Entity&lt;/code&gt;
&nbsp;     */
&nbsp;    private void parsePilot(Element pilotNode, Entity entity) {
<b class="nc">&nbsp;        Map&lt;String,String&gt; attributes = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; pilotNode.getAttributes().getLength(); i++) {</b>
<b class="nc">&nbsp;            final Node node = pilotNode.getAttributes().item(i);</b>
<b class="nc">&nbsp;            attributes.put(node.getNodeName(), node.getTextContent());</b>
&nbsp;        }
&nbsp;
&nbsp;        Crew crew;
<b class="nc">&nbsp;        if (null != entity) {</b>
<b class="nc">&nbsp;            crew = new Crew(entity.getCrew().getCrewType());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            crew = new Crew(CrewType.SINGLE);</b>
&nbsp;        }
<b class="nc">&nbsp;        setCrewAttributes(crew, attributes, entity);</b>
<b class="nc">&nbsp;        setPilotAttributes(crew, 0, attributes);</b>
&nbsp;        // LAMs have a second set of gunnery and piloting stats, so we create a dummy crew
&nbsp;        // and parse a copy of the attributes with the aero stats altered to their non-aero keys,
&nbsp;        // then copy the results into the aero skills of the LAMPilot.
<b class="nc">&nbsp;        if (entity instanceof LandAirMech) {</b>
<b class="nc">&nbsp;            crew = LAMPilot.convertToLAMPilot((LandAirMech)entity, crew);</b>
<b class="nc">&nbsp;            Crew aeroCrew = new Crew(CrewType.SINGLE);</b>
<b class="nc">&nbsp;            Map&lt;String,String&gt; aeroAttributes = new HashMap&lt;&gt;(attributes);</b>
<b class="nc">&nbsp;            for (String key : attributes.keySet()) {</b>
<b class="nc">&nbsp;                if (key.contains(&quot;Aero&quot;)) {</b>
<b class="nc">&nbsp;                    aeroAttributes.put(key.replace(&quot;Aero&quot;, &quot;&quot;), attributes.get(key));</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            setPilotAttributes(aeroCrew, 0, aeroAttributes);</b>
<b class="nc">&nbsp;            ((LAMPilot)crew).setGunneryAero(aeroCrew.getGunnery());</b>
<b class="nc">&nbsp;            ((LAMPilot)crew).setGunneryAeroM(aeroCrew.getGunneryM());</b>
<b class="nc">&nbsp;            ((LAMPilot)crew).setGunneryAeroB(aeroCrew.getGunneryB());</b>
<b class="nc">&nbsp;            ((LAMPilot)crew).setGunneryAeroL(aeroCrew.getGunneryL());</b>
<b class="nc">&nbsp;            ((LAMPilot)crew).setPilotingAero(aeroCrew.getPiloting());</b>
<b class="nc">&nbsp;            entity.setCrew(crew);</b>
&nbsp;        }
<b class="nc">&nbsp;        pilots.add(crew);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;    /**
&nbsp;     * Convenience function that calls &lt;code&gt;parseCrew&lt;/code&gt; with a null
&nbsp;     * Entity.
&nbsp;     *
&nbsp;     * @param crewNode The crew tag to create a &lt;code&gt;Crew&lt;/code&gt; from
&nbsp;     */
&nbsp;    private void parseCrew(Element crewNode) {
<b class="nc">&nbsp;        parseCrew(crewNode, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Used for multi-crew cockpits.
&nbsp;     * Given a tag, read the attributes and create a new &lt;code&gt;Crew&lt;/code&gt;
&nbsp;     * instance.  If a non-null &lt;code&gt;Entity&lt;/code&gt; is passed, the new crew will
&nbsp;     * be set as the crew for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param crewNode The crew tag to create a &lt;code&gt;Crew&lt;/code&gt; from
&nbsp;     * @param entity   If non-null, the new &lt;code&gt;Crew&lt;/code&gt; will be set as
&nbsp;     *                 the crew of this &lt;code&gt;Entity&lt;/code&gt;
&nbsp;     */
&nbsp;    private void parseCrew(Element crewNode, Entity entity) {
<b class="nc">&nbsp;        final Map&lt;String, String&gt; crewAttr = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; crewNode.getAttributes().getLength(); i++) {</b>
<b class="nc">&nbsp;            final Node node = crewNode.getAttributes().item(i);</b>
<b class="nc">&nbsp;            crewAttr.put(node.getNodeName(), node.getTextContent());</b>
&nbsp;        }
&nbsp;        //Do not assign crew attributes until after individual crew members have been processed because
&nbsp;        //we cannot assign hits to ejected crew.
&nbsp;
&nbsp;        Crew crew;
<b class="nc">&nbsp;        CrewType crewType = null;</b>
<b class="nc">&nbsp;        if (crewAttr.containsKey(CREWTYPE)) {</b>
<b class="nc">&nbsp;            for (CrewType ct : CrewType.values()) {</b>
<b class="nc">&nbsp;                if (ct.toString().equalsIgnoreCase(crewAttr.get(CREWTYPE))) {</b>
<b class="nc">&nbsp;                    crewType = ct;</b>
<b class="nc">&nbsp;                    break;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (null != crewType) {</b>
<b class="nc">&nbsp;            crew = new Crew(crewType);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            crew = new Crew(CrewType.SINGLE);</b>
&nbsp;        }
<b class="nc">&nbsp;        pilots.add(crew);</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; crew.getSlotCount(); i++) {</b>
<b class="nc">&nbsp;            crew.setMissing(true, i);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        for (int n = 0; n &lt; crewNode.getChildNodes().getLength(); n++) {</b>
<b class="nc">&nbsp;            final Node pilotNode = crewNode.getChildNodes().item(n);</b>
<b class="nc">&nbsp;            if (pilotNode.getNodeName().equalsIgnoreCase(CREWMEMBER)) {</b>
<b class="nc">&nbsp;                final Map&lt;String, String&gt; pilotAttr = new HashMap&lt;&gt;(crewAttr);</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt; pilotNode.getAttributes().getLength(); i++) {</b>
<b class="nc">&nbsp;                    final Node node = pilotNode.getAttributes().item(i);</b>
<b class="nc">&nbsp;                    pilotAttr.put(node.getNodeName(), node.getTextContent());</b>
&nbsp;                }
<b class="nc">&nbsp;                int slot = -1;</b>
<b class="nc">&nbsp;                if (pilotAttr.containsKey(SLOT) &amp;&amp; pilotAttr.get(SLOT).length() &gt; 0) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        slot = Integer.parseInt(pilotAttr.get(SLOT));</b>
<b class="nc">&nbsp;                    } catch (NumberFormatException ex) {</b>
<b class="nc">&nbsp;                        warning.append(&quot;Illegal crew slot index: &quot;).append(pilotAttr.get(SLOT));</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
<b class="nc">&nbsp;                if (slot &lt; 0 &amp;&amp; slot &gt;= crew.getSlotCount()) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;Illegal crew slot index for &quot;).append(crewType)</b>
<b class="nc">&nbsp;                            .append(&quot; cockpit: &quot;).append(slot);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    crew.setMissing(false, slot);</b>
<b class="nc">&nbsp;                    setPilotAttributes(crew, slot, pilotAttr);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        setCrewAttributes(crew, crewAttr, entity);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Helper method that sets field values for the crew as a whole, either from a &lt;pilot&gt; element
&nbsp;     * (single/collective crews) or a &lt;crew&gt; element (multi-crew cockpits). If an &lt;code&gt;Entity&lt;/code&gt;
&nbsp;     * is provided, the crew will be assigned to it.
&nbsp;     *
&nbsp;     * @param crew       The crew to set fields for.
&nbsp;     * @param attributes Attribute values of the &lt;code&gt;pilot&lt;/code&gt; or &lt;code&gt;crew&lt;/code&gt;
&nbsp;     *                   element mapped to the attribute name.
&nbsp;     * @param entity     The &lt;code&gt;Entity&lt;/code&gt; for this crew (or null if the crew has abandoned the unit).
&nbsp;     */
&nbsp;    private void setCrewAttributes(Crew crew, Map&lt;String,String&gt; attributes, Entity entity) {
&nbsp;        // init bonus
<b class="nc">&nbsp;        int initBVal = 0;</b>
<b class="nc">&nbsp;        if ((attributes.containsKey(INITB)) &amp;&amp; (attributes.get(INITB).length() &gt; 0)) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                initBVal = Integer.parseInt(attributes.get(INITB));</b>
<b class="nc">&nbsp;            } catch (NumberFormatException excep) {</b>
&nbsp;                // Handled by the next if test.
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        int commandBVal = 0;</b>
<b class="nc">&nbsp;        if ((attributes.containsKey(COMMANDB)) &amp;&amp; (attributes.get(COMMANDB).length() &gt; 0)) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                commandBVal = Integer.parseInt(attributes.get(COMMANDB));</b>
<b class="nc">&nbsp;            } catch (NumberFormatException ignored) {</b>
&nbsp;                // Handled by the next if test.
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (attributes.containsKey(SIZE)) {</b>
<b class="nc">&nbsp;            if (attributes.get(SIZE).length() &gt; 0) {</b>
<b class="nc">&nbsp;                int crewSize = 1;</b>
&nbsp;                try {
<b class="nc">&nbsp;                    crewSize = Integer.parseInt(attributes.get(SIZE));</b>
<b class="nc">&nbsp;                } catch (NumberFormatException ignored) {</b>
&nbsp;                    // Do nothing, this field isn&#39;t required
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                crew.setSize(crewSize);</b>
<b class="nc">&nbsp;            } else if (null != entity) {</b>
<b class="nc">&nbsp;                crew.setSize(Compute.getFullCrewSize(entity));</b>
&nbsp;                //Reset the currentSize equal to the max size
<b class="nc">&nbsp;                crew.setCurrentSize(Compute.getFullCrewSize(entity));</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (attributes.containsKey(CURRENTSIZE)) {</b>
<b class="nc">&nbsp;            if (attributes.get(CURRENTSIZE).length() &gt; 0) {</b>
<b class="nc">&nbsp;                int crewCurrentSize = 1;</b>
&nbsp;                try {
<b class="nc">&nbsp;                    crewCurrentSize = Integer.parseInt(attributes.get(CURRENTSIZE));</b>
<b class="nc">&nbsp;                } catch (NumberFormatException e) {</b>
&nbsp;                    // Do nothing, this field isn&#39;t required
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                crew.setCurrentSize(crewCurrentSize);</b>
<b class="nc">&nbsp;            } else if (null != entity) {</b>
&nbsp;                //Reset the currentSize equal to the max size
<b class="nc">&nbsp;                crew.setCurrentSize(Compute.getFullCrewSize(entity));</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        crew.setInitBonus(initBVal);</b>
<b class="nc">&nbsp;        crew.setCommandBonus(commandBVal);</b>
<b class="nc">&nbsp;        if (attributes.containsKey(ADVS) &amp;&amp; (attributes.get(ADVS).trim().length() &gt; 0)) {</b>
<b class="nc">&nbsp;            StringTokenizer st = new StringTokenizer(attributes.get(ADVS), &quot;::&quot;);</b>
<b class="nc">&nbsp;            while (st.hasMoreTokens()) {</b>
<b class="nc">&nbsp;                String adv = st.nextToken();</b>
<b class="nc">&nbsp;                String advName = Crew.parseAdvantageName(adv);</b>
<b class="nc">&nbsp;                Object value = Crew.parseAdvantageValue(adv);</b>
&nbsp;
&nbsp;                try {
<b class="nc">&nbsp;                    crew.getOptions().getOption(advName).setValue(value);</b>
<b class="nc">&nbsp;                } catch (Exception e) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;Error restoring advantage: &quot;).append(adv).append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;        }
<b class="nc">&nbsp;        if (attributes.containsKey(EDGE) &amp;&amp; (attributes.get(EDGE).trim().length() &gt; 0)) {</b>
<b class="nc">&nbsp;            StringTokenizer st = new StringTokenizer(attributes.get(EDGE), &quot;::&quot;);</b>
<b class="nc">&nbsp;            while (st.hasMoreTokens()) {</b>
<b class="nc">&nbsp;                String edg = st.nextToken();</b>
<b class="nc">&nbsp;                String edgeName = Crew.parseAdvantageName(edg);</b>
<b class="nc">&nbsp;                Object value = Crew.parseAdvantageValue(edg);</b>
&nbsp;
&nbsp;                try {
<b class="nc">&nbsp;                    crew.getOptions().getOption(edgeName).setValue(value);</b>
<b class="nc">&nbsp;                } catch (Exception e) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;Error restoring edge: &quot;).append(edg).append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
<b class="nc">&nbsp;        if (attributes.containsKey(IMPLANTS) &amp;&amp; (attributes.get(IMPLANTS).trim().length() &gt; 0)) {</b>
<b class="nc">&nbsp;            StringTokenizer st = new StringTokenizer(attributes.get(IMPLANTS), &quot;::&quot;);</b>
<b class="nc">&nbsp;            while (st.hasMoreTokens()) {</b>
<b class="nc">&nbsp;                String implant = st.nextToken();</b>
<b class="nc">&nbsp;                String implantName = Crew.parseAdvantageName(implant);</b>
<b class="nc">&nbsp;                Object value = Crew.parseAdvantageValue(implant);</b>
&nbsp;
&nbsp;                try {
<b class="nc">&nbsp;                    crew.getOptions().getOption(implantName).setValue(value);</b>
<b class="nc">&nbsp;                } catch (Exception e) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;Error restoring implants: &quot;).append(implant).append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (attributes.containsKey(EJECTED) &amp;&amp; attributes.get(EJECTED).length() &gt; 0) {</b>
<b class="nc">&nbsp;            crew.setEjected(Boolean.parseBoolean(attributes.get(EJECTED)));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (null != entity) {</b>
&nbsp;            // Set the crew for this entity.
<b class="nc">&nbsp;            entity.setCrew(crew);</b>
&nbsp;
<b class="nc">&nbsp;            if (attributes.containsKey(AUTOEJECT) &amp;&amp; attributes.get(AUTOEJECT).length() &gt; 0) {</b>
<b class="nc">&nbsp;                ((Mech)entity).setAutoEject(Boolean.parseBoolean(attributes.get(AUTOEJECT)));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (attributes.containsKey(CONDEJECTAMMO) &amp;&amp; attributes.get(CONDEJECTAMMO).length() &gt; 0) {</b>
<b class="nc">&nbsp;                ((Mech)entity).setCondEjectAmmo(Boolean.parseBoolean(attributes.get(CONDEJECTAMMO)));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (attributes.containsKey(CONDEJECTENGINE) &amp;&amp; attributes.get(CONDEJECTENGINE).length() &gt; 0) {</b>
<b class="nc">&nbsp;                ((Mech)entity).setCondEjectEngine(Boolean.parseBoolean(attributes.get(CONDEJECTENGINE)));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (attributes.containsKey(CONDEJECTCTDEST) &amp;&amp; attributes.get(CONDEJECTCTDEST).length() &gt; 0) {</b>
<b class="nc">&nbsp;                ((Mech)entity).setCondEjectCTDest(Boolean.parseBoolean(attributes.get(CONDEJECTCTDEST)));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (attributes.containsKey(CONDEJECTHEADSHOT) &amp;&amp; attributes.get(CONDEJECTHEADSHOT).length() &gt; 0) {</b>
<b class="nc">&nbsp;                ((Mech)entity).setCondEjectHeadshot(Boolean.parseBoolean(attributes.get(CONDEJECTHEADSHOT)));</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *      * Helper method that parses attributes common to both single/collective crews and individual
&nbsp;     * slots of a unit with a multi-crew cockpit.
&nbsp;     *
&nbsp;     * @param crew The crew object for set values for
&nbsp;     * @param slot The slot of the crew object that corresponds to these attributes.
&nbsp;     * @param attributes A map of attribute values keyed to the attribute names.
&nbsp;     */
&nbsp;    private void setPilotAttributes(Crew crew, int slot, Map&lt;String, String&gt; attributes) {
<b class="nc">&nbsp;        final boolean hasGun = attributes.containsKey(GUNNERY) &amp;&amp; (attributes.get(GUNNERY).length() &gt; 0);</b>
<b class="nc">&nbsp;        final boolean hasRpgGun = attributes.containsKey(GUNNERYL) &amp;&amp; (attributes.get(GUNNERYL).length() &gt; 0) &amp;&amp;</b>
<b class="nc">&nbsp;                attributes.containsKey(GUNNERYM) &amp;&amp; (attributes.get(GUNNERYM).length() &gt; 0) &amp;&amp;</b>
<b class="nc">&nbsp;                attributes.containsKey(GUNNERYB) &amp;&amp; (attributes.get(GUNNERYB).length() &gt; 0);</b>
&nbsp;
&nbsp;        // Did we find required attributes?
<b class="nc">&nbsp;        if (!hasGun &amp;&amp; !hasRpgGun) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Could not find gunnery for pilot.\n&quot;);</b>
<b class="nc">&nbsp;        } else if (!attributes.containsKey(PILOTING) || (attributes.get(PILOTING).length() == 0)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Could not find piloting for pilot.\n&quot;);</b>
&nbsp;        } else {
&nbsp;            // Try to get a good gunnery value.
<b class="nc">&nbsp;            int gunVal = -1;</b>
<b class="nc">&nbsp;            if (hasGun) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    gunVal = Integer.parseInt(attributes.get(GUNNERY));</b>
<b class="nc">&nbsp;                } catch (NumberFormatException ignored) {</b>
&nbsp;                    // Handled by the next if test.
<b class="nc">&nbsp;                }</b>
&nbsp;
<b class="nc">&nbsp;                if ((gunVal &lt; 0)</b>
&nbsp;                        || (gunVal &gt; Crew.MAX_SKILL)) {
<b class="nc">&nbsp;                    warning.append(&quot;Found invalid gunnery value: &quot;)</b>
<b class="nc">&nbsp;                            .append(attributes.get(GUNNERY)).append(&quot;.\n&quot;);</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // get RPG skills
<b class="nc">&nbsp;            int gunneryLVal = -1;</b>
<b class="nc">&nbsp;            int gunneryMVal = -1;</b>
<b class="nc">&nbsp;            int gunneryBVal = -1;</b>
<b class="nc">&nbsp;            if (hasRpgGun) {</b>
<b class="nc">&nbsp;                if ((attributes.containsKey(GUNNERYL)) &amp;&amp; (attributes.get(GUNNERYL).length() &gt; 0)) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        gunneryLVal = Integer.parseInt(attributes.get(GUNNERYL));</b>
<b class="nc">&nbsp;                    } catch (NumberFormatException ignored) {</b>
&nbsp;                        // Handled by the next if test.
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    if ((gunneryLVal &lt; 0)</b>
&nbsp;                            || (gunneryLVal &gt; Crew.MAX_SKILL)) {
<b class="nc">&nbsp;                        warning.append(&quot;Found invalid piloting value: &quot;)</b>
<b class="nc">&nbsp;                                .append(attributes.get(GUNNERYL)).append(&quot;.\n&quot;);</b>
&nbsp;                        return;
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if ((attributes.containsKey(GUNNERYM)) &amp;&amp; (attributes.get(GUNNERYM).length() &gt; 0)) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        gunneryMVal = Integer.parseInt(attributes.get(GUNNERYM));</b>
<b class="nc">&nbsp;                    } catch (NumberFormatException ignored) {</b>
&nbsp;                        // Handled by the next if test.
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    if ((gunneryMVal &lt; 0)</b>
&nbsp;                            || (gunneryMVal &gt; Crew.MAX_SKILL)) {
<b class="nc">&nbsp;                        warning.append(&quot;Found invalid piloting value: &quot;)</b>
<b class="nc">&nbsp;                                .append(attributes.get(GUNNERYM)).append(&quot;.\n&quot;);</b>
&nbsp;                        return;
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if ((attributes.containsKey(GUNNERYB)) &amp;&amp; (attributes.get(GUNNERYB).length() &gt; 0)) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        gunneryBVal = Integer.parseInt(attributes.get(GUNNERYB));</b>
<b class="nc">&nbsp;                    } catch (NumberFormatException ignored) {</b>
&nbsp;                        // Handled by the next if test.
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    if ((gunneryBVal &lt; 0)</b>
&nbsp;                            || (gunneryBVal &gt; Crew.MAX_SKILL)) {
<b class="nc">&nbsp;                        warning.append(&quot;Found invalid piloting value: &quot;)</b>
<b class="nc">&nbsp;                                .append(attributes.get(GUNNERYB)).append(&quot;.\n&quot;);</b>
&nbsp;                        return;
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!hasGun) {</b>
<b class="nc">&nbsp;                gunVal = (gunneryLVal + gunneryMVal + gunneryBVal) / 3;</b>
<b class="nc">&nbsp;            } else if (!hasRpgGun) {</b>
<b class="nc">&nbsp;                gunneryLVal = gunVal;</b>
<b class="nc">&nbsp;                gunneryMVal = gunVal;</b>
<b class="nc">&nbsp;                gunneryBVal = gunVal;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Try to get a good piloting value.
<b class="nc">&nbsp;            int pilotVal = -1;</b>
&nbsp;            try {
<b class="nc">&nbsp;                pilotVal = Integer.parseInt(attributes.get(PILOTING));</b>
<b class="nc">&nbsp;            } catch (NumberFormatException ignored) {</b>
&nbsp;                // Handled by the next if test.
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if ((pilotVal &lt; 0) || (pilotVal &gt; Crew.MAX_SKILL)) {</b>
<b class="nc">&nbsp;                warning.append(&quot;Found invalid piloting value: &quot;)</b>
<b class="nc">&nbsp;                        .append(attributes.get(PILOTING)).append(&quot;.\n&quot;);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            // toughness
<b class="nc">&nbsp;            int toughVal = 0;</b>
<b class="nc">&nbsp;            if ((attributes.containsKey(TOUGH)) &amp;&amp; (attributes.get(TOUGH).length() &gt; 0)) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    toughVal = Integer.parseInt(attributes.get(TOUGH));</b>
<b class="nc">&nbsp;                } catch (NumberFormatException ignored) {</b>
&nbsp;                    // Handled by the next if test.
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            int artVal = gunVal;</b>
<b class="nc">&nbsp;            if ((attributes.containsKey(ARTILLERY)) &amp;&amp; (attributes.get(ARTILLERY).length() &gt; 0)) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    artVal = Integer.parseInt(attributes.get(ARTILLERY));</b>
<b class="nc">&nbsp;                } catch (NumberFormatException ignored) {</b>
&nbsp;                    // Handled by the next if test.
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                if ((artVal &lt; 0) || (artVal &gt; Crew.MAX_SKILL)) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;Found invalid artillery value: &quot;)</b>
<b class="nc">&nbsp;                            .append(attributes.get(ARTILLERY)).append(&quot;.\n&quot;);</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            crew.setGunnery(gunVal, slot);</b>
<b class="nc">&nbsp;            crew.setGunneryL(gunneryLVal, slot);</b>
<b class="nc">&nbsp;            crew.setGunneryM(gunneryMVal, slot);</b>
<b class="nc">&nbsp;            crew.setGunneryB(gunneryBVal, slot);</b>
<b class="nc">&nbsp;            crew.setArtillery(artVal, slot);</b>
<b class="nc">&nbsp;            crew.setPiloting(pilotVal, slot);</b>
<b class="nc">&nbsp;            crew.setToughness(toughVal, slot);</b>
&nbsp;
<b class="nc">&nbsp;            if ((attributes.containsKey(NAME)) &amp;&amp; (attributes.get(NAME).length() &gt; 0)) {</b>
<b class="nc">&nbsp;                crew.setName(attributes.get(NAME), slot);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                crew.setName(RandomNameGenerator.UNNAMED_FULL_NAME, slot);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if ((attributes.containsKey(NICK)) &amp;&amp; (attributes.get(NICK).length() &gt; 0)) {</b>
<b class="nc">&nbsp;                crew.setNickname(attributes.get(NICK), slot);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if ((attributes.containsKey(GENDER)) &amp;&amp; (attributes.get(GENDER).length() &gt; 0)){</b>
<b class="nc">&nbsp;                crew.setGender(Gender.parseFromString(attributes.get(GENDER)), slot);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if ((attributes.containsKey(CAT_PORTRAIT)) &amp;&amp; (attributes.get(CAT_PORTRAIT).length() &gt; 0)) {</b>
<b class="nc">&nbsp;                crew.setPortraitCategory(attributes.get(CAT_PORTRAIT), slot);</b>
&nbsp;            }
<b class="nc">&nbsp;            if ((attributes.containsKey(FILE_PORTRAIT)) &amp;&amp; (attributes.get(FILE_PORTRAIT).length() &gt; 0)) {</b>
<b class="nc">&nbsp;                crew.setPortraitFileName(attributes.get(FILE_PORTRAIT), slot);</b>
&nbsp;            }
&nbsp;
&nbsp;            // Was the crew wounded?
<b class="nc">&nbsp;            if (attributes.containsKey(HITS) &amp;&amp; attributes.get(HITS).length() &gt; 0) {</b>
&nbsp;                // Try to get a good hits value.
<b class="nc">&nbsp;                int hitVal = -1;</b>
&nbsp;                try {
<b class="nc">&nbsp;                    hitVal = Integer.parseInt(attributes.get(HITS));</b>
<b class="nc">&nbsp;                } catch (NumberFormatException ignored) {</b>
&nbsp;                    // Handled by the next if test.
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                if (attributes.get(HITS).equals(DEAD)) {</b>
<b class="nc">&nbsp;                    crew.setDead(true, slot);</b>
<b class="nc">&nbsp;                    warning.append(crew.getNameAndRole(slot)).append(&quot; is dead.\n&quot;);</b>
<b class="nc">&nbsp;                } else if ((hitVal &lt; 0) || (hitVal &gt; 5)) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;Found invalid hits value: &quot;)</b>
<b class="nc">&nbsp;                            .append(attributes.get(HITS)).append(&quot;.\n&quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    crew.setHits(hitVal, slot);</b>
&nbsp;                }
&nbsp;
&nbsp;            } // End have-hits
&nbsp;
<b class="nc">&nbsp;            if ((attributes.containsKey(EXT_ID)) &amp;&amp; (attributes.get(EXT_ID).length() &gt; 0)) {</b>
<b class="nc">&nbsp;                crew.setExternalIdAsString(attributes.get(EXT_ID), slot);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (attributes.containsKey(EXTRA_DATA)) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    Map&lt;String, String&gt; extraData = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                    String[] valuePairs = attributes.get(EXTRA_DATA).split(&quot;\\|&quot;);</b>
&nbsp;                    String[] values;
<b class="nc">&nbsp;                    for (String valuePair : valuePairs) {</b>
<b class="nc">&nbsp;                        values = valuePair.split(&quot;=&quot;);</b>
<b class="nc">&nbsp;                        extraData.put(values[0], values[1]);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    crew.setExtraDataForCrewMember(slot, extraData);</b>
<b class="nc">&nbsp;                } catch (Exception e) {</b>
<b class="nc">&nbsp;                    MegaMek.getLogger().error(&quot;Error in loading MUL, issues with extraData elements!&quot;);</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;        } // End have-required-fields
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a location tag and update the given &lt;code&gt;Entity&lt;/code&gt; based on
&nbsp;     * the contents.
&nbsp;     *
&nbsp;     * @param locationTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseLocation(Element locationTag, Entity entity) {
&nbsp;        // Look for the element&#39;s attributes.
<b class="nc">&nbsp;        String index = locationTag.getAttribute(INDEX);</b>
<b class="nc">&nbsp;        String destroyed = locationTag.getAttribute(IS_DESTROYED);</b>
&nbsp;
&nbsp;        int loc;
&nbsp;        // Some units, like tanks and protos, keep track as Ammo slots as N/A
&nbsp;        // Since they don&#39;t have slot indices, they are accessed in order so
&nbsp;        // we keep track of the number of ammo slots processed for a loc
<b class="nc">&nbsp;        int locAmmoCount = 0;</b>
&nbsp;        // Did we find required attributes?
<b class="nc">&nbsp;        if ((index == null) || (index.length() == 0)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Could not find index for location.\n&quot;);</b>
&nbsp;            return;
&nbsp;        } else {
&nbsp;            // Try to get a good index value.
<b class="nc">&nbsp;            loc = -1;</b>
&nbsp;            try {
<b class="nc">&nbsp;                loc = Integer.parseInt(index);</b>
<b class="nc">&nbsp;            } catch (NumberFormatException excep) {</b>
&nbsp;                // Handled by the next if test.
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (loc &lt; 0) {</b>
<b class="nc">&nbsp;                warning.append(</b>
&nbsp;                        &quot;Found invalid index value for location: &quot;)
<b class="nc">&nbsp;                        .append(index).append(&quot;.\n&quot;);</b>
&nbsp;                return;
<b class="nc">&nbsp;            } else if (loc &gt;= entity.locations()) {</b>
<b class="nc">&nbsp;                warning.append(&quot;The entity, &quot;)</b>
<b class="nc">&nbsp;                        .append(entity.getShortName())</b>
<b class="nc">&nbsp;                        .append(&quot; does not have a location at index: &quot;)</b>
<b class="nc">&nbsp;                        .append(loc).append(&quot;.\n&quot;);</b>
&nbsp;                return;
&nbsp;            } else {
&nbsp;                try {
<b class="nc">&nbsp;                    if (Boolean.parseBoolean(destroyed)) {</b>
<b class="nc">&nbsp;                        destroyLocation(entity, loc);</b>
&nbsp;                    }
<b class="nc">&nbsp;                } catch (Throwable excep) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;Found invalid isDestroyed value: &quot;)</b>
<b class="nc">&nbsp;                            .append(destroyed).append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            } // End have-valid-index
&nbsp;        } // End have-required-fields
&nbsp;
&nbsp;        // Handle children
<b class="nc">&nbsp;        NodeList nl = locationTag.getChildNodes();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
&nbsp;
<b class="nc">&nbsp;            if (currNode.getParentNode() != locationTag) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                Element currEle = (Element)currNode;</b>
<b class="nc">&nbsp;                String nodeName = currNode.getNodeName();</b>
<b class="nc">&nbsp;                if (nodeName.equalsIgnoreCase(ARMOR)){</b>
<b class="nc">&nbsp;                    parseArmor(currEle, entity, loc);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(BREACH)){</b>
<b class="nc">&nbsp;                    breachLocation(entity, loc);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(BLOWN_OFF)){</b>
<b class="nc">&nbsp;                    blowOffLocation(entity, loc);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(SLOT)){</b>
<b class="nc">&nbsp;                    locAmmoCount = parseSlot(currEle, entity, loc, locAmmoCount);</b>
<b class="nc">&nbsp;                } else if (nodeName.equalsIgnoreCase(STABILIZER)){</b>
<b class="nc">&nbsp;                    String hit = currEle.getAttribute(IS_HIT);</b>
<b class="nc">&nbsp;                    if (!hit.equals(&quot;&quot;)) {</b>
<b class="nc">&nbsp;                        ((Tank) entity).setStabiliserHit(loc);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse an armor tag for the given Entity and location.
&nbsp;     *
&nbsp;     * @param armorTag
&nbsp;     * @param entity
&nbsp;     * @param loc
&nbsp;     */
&nbsp;    private void parseArmor(Element armorTag, Entity entity, int loc){
&nbsp;     // Look for the element&#39;s attributes.
<b class="nc">&nbsp;        String points = armorTag.getAttribute(POINTS);</b>
<b class="nc">&nbsp;        String type = armorTag.getAttribute(TYPE);</b>
&nbsp;
&nbsp;        // Did we find required attributes?
<b class="nc">&nbsp;        if ((points == null) || (points.length() == 0)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Could not find points for armor.\n&quot;);</b>
&nbsp;        } else {
&nbsp;
&nbsp;            // Try to get a good points value.
<b class="nc">&nbsp;            int pointsVal = -1;</b>
&nbsp;            try {
<b class="nc">&nbsp;                pointsVal = Integer.parseInt(points);</b>
<b class="nc">&nbsp;            } catch (NumberFormatException excep) {</b>
&nbsp;                // Handled by the next if test.
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (points.equals(NA)) {</b>
<b class="nc">&nbsp;                pointsVal = IArmorState.ARMOR_NA;</b>
<b class="nc">&nbsp;            } else if (points.equals(DESTROYED)) {</b>
<b class="nc">&nbsp;                pointsVal = IArmorState.ARMOR_DESTROYED;</b>
<b class="nc">&nbsp;            } else if ((pointsVal &lt; 0) || (pointsVal &gt; 2000)) {</b>
<b class="nc">&nbsp;                warning.append(&quot;Found invalid points value: &quot;)</b>
<b class="nc">&nbsp;                        .append(points).append(&quot;.\n&quot;);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            // Assign the points to the correct location.
&nbsp;            // Sanity check the armor value before setting it.
<b class="nc">&nbsp;            if ((type.length() == 0) || type.equals(FRONT)) {</b>
<b class="nc">&nbsp;                if (entity.getOArmor(loc) &lt; pointsVal) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;The entity, &quot;)</b>
<b class="nc">&nbsp;                            .append(entity.getShortName())</b>
<b class="nc">&nbsp;                            .append(&quot; does not start with &quot;)</b>
<b class="nc">&nbsp;                            .append(pointsVal)</b>
<b class="nc">&nbsp;                            .append(&quot; points of armor for location: &quot;)</b>
<b class="nc">&nbsp;                            .append(loc).append(&quot;.\n&quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    entity.setArmor(pointsVal, loc);</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (type.equals(INTERNAL)) {</b>
<b class="nc">&nbsp;                if (entity.getOInternal(loc) &lt; pointsVal) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;The entity, &quot;)</b>
<b class="nc">&nbsp;                            .append(entity.getShortName())</b>
<b class="nc">&nbsp;                            .append(&quot; does not start with &quot;)</b>
<b class="nc">&nbsp;                            .append(pointsVal)</b>
<b class="nc">&nbsp;                            .append(&quot; points of internal structure for &quot; +</b>
&nbsp;                                    &quot;location: &quot;)
<b class="nc">&nbsp;                            .append(loc).append(&quot;.\n&quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    entity.setInternal(pointsVal, loc);</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (type.equals(REAR)) {</b>
<b class="nc">&nbsp;                if (!entity.hasRearArmor(loc)) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;The entity, &quot;)</b>
<b class="nc">&nbsp;                            .append(entity.getShortName())</b>
<b class="nc">&nbsp;                            .append(&quot; has no rear armor for location: &quot;)</b>
<b class="nc">&nbsp;                            .append(loc).append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                } else if (entity.getOArmor(loc, true) &lt; pointsVal) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;The entity, &quot;)</b>
<b class="nc">&nbsp;                            .append(entity.getShortName())</b>
<b class="nc">&nbsp;                            .append(&quot; does not start with &quot;)</b>
<b class="nc">&nbsp;                            .append(pointsVal)</b>
<b class="nc">&nbsp;                            .append(&quot; points of rear armor for location: &quot;)</b>
<b class="nc">&nbsp;                            .append(loc).append(&quot;.\n&quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    entity.setArmor(pointsVal, loc, true);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a slot tag for the given Entity and location.
&nbsp;     *
&nbsp;     * @param slotTag
&nbsp;     * @param entity
&nbsp;     * @param loc
&nbsp;     */
&nbsp;    private int parseSlot(Element slotTag, Entity entity, int loc,
&nbsp;            int locAmmoCount) {
&nbsp;        // Look for the element&#39;s attributes.
<b class="nc">&nbsp;        String index = slotTag.getAttribute(INDEX);</b>
<b class="nc">&nbsp;        String type = slotTag.getAttribute(TYPE);</b>
&nbsp;        // String rear = slotTag.getAttribute( IS_REAR ); // is never read.
<b class="nc">&nbsp;        String shots = slotTag.getAttribute(SHOTS);</b>
<b class="nc">&nbsp;        String capacity = slotTag.getAttribute(CAPACITY);</b>
<b class="nc">&nbsp;        String hit = slotTag.getAttribute(IS_HIT);</b>
<b class="nc">&nbsp;        String destroyed = slotTag.getAttribute(IS_DESTROYED);</b>
<b class="nc">&nbsp;        String repairable = (slotTag.getAttribute(IS_REPAIRABLE).equals(&quot;&quot;) ? &quot;true&quot; : slotTag.getAttribute(IS_REPAIRABLE));</b>
<b class="nc">&nbsp;        String munition = slotTag.getAttribute(MUNITION);</b>
<b class="nc">&nbsp;        String standard = slotTag.getAttribute(STANDARD);</b>
<b class="nc">&nbsp;        String inferno = slotTag.getAttribute(INFERNO);</b>
<b class="nc">&nbsp;        String quirks = slotTag.getAttribute(QUIRKS);</b>
<b class="nc">&nbsp;        String trooperMiss = slotTag.getAttribute(TROOPER_MISS);</b>
<b class="nc">&nbsp;        String rfmg = slotTag.getAttribute(RFMG);</b>
<b class="nc">&nbsp;        String bayIndex = slotTag.getAttribute(WEAPONS_BAY_INDEX);</b>
&nbsp;
&nbsp;        // Did we find required attributes?
<b class="nc">&nbsp;        if ((index == null) || (index.length() == 0)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Could not find index for slot.\n&quot;);</b>
<b class="nc">&nbsp;            return locAmmoCount;</b>
<b class="nc">&nbsp;        } else if ((type == null) || (type.length() == 0)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Could not find type for slot.\n&quot;);</b>
<b class="nc">&nbsp;            return locAmmoCount;</b>
&nbsp;        } else {
&nbsp;            // Try to get a good index value.
&nbsp;            // Remember, slot index starts at 1.
<b class="nc">&nbsp;            int indexVal = -1;</b>
&nbsp;            try {
<b class="nc">&nbsp;                indexVal = Integer.parseInt(index);</b>
<b class="nc">&nbsp;                indexVal -= 1;</b>
<b class="nc">&nbsp;            } catch (NumberFormatException excep) {</b>
&nbsp;                // Handled by the next if test.
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            if (index.equals(NA)) {</b>
<b class="nc">&nbsp;                indexVal = IArmorState.ARMOR_NA;</b>
&nbsp;
&nbsp;                // Protomechs only have system slots,
&nbsp;                // so we have to handle the ammo specially.
<b class="nc">&nbsp;                if (entity instanceof Protomech || entity instanceof GunEmplacement) {</b>
&nbsp;                    // Get the saved ammo load.
<b class="nc">&nbsp;                    EquipmentType newLoad = EquipmentType.get(type);</b>
<b class="nc">&nbsp;                    if (newLoad instanceof AmmoType) {</b>
<b class="nc">&nbsp;                        int counter = -1;</b>
<b class="nc">&nbsp;                        Iterator&lt;Mounted&gt; ammo = entity.getAmmo()</b>
<b class="nc">&nbsp;                                .iterator();</b>
<b class="nc">&nbsp;                        while (ammo.hasNext()</b>
&nbsp;                                &amp;&amp; (counter &lt; locAmmoCount)) {
&nbsp;
&nbsp;                            // Is this mounted in the current location?
<b class="nc">&nbsp;                            Mounted mounted = ammo.next();</b>
<b class="nc">&nbsp;                            if (mounted.getLocation() == loc) {</b>
&nbsp;
&nbsp;                                // Increment the loop counter.
<b class="nc">&nbsp;                                counter++;</b>
&nbsp;
&nbsp;                                // Is this the one we want to handle?
<b class="nc">&nbsp;                                if (counter == locAmmoCount) {</b>
&nbsp;
&nbsp;                                    // Increment the counter of ammo
&nbsp;                                    // handled for this location.
<b class="nc">&nbsp;                                    locAmmoCount++;</b>
&nbsp;
&nbsp;                                    // Reset transient values.
<b class="nc">&nbsp;                                    mounted.restore();</b>
&nbsp;
&nbsp;                                    // Try to get a good shots value.
<b class="nc">&nbsp;                                    int shotsVal = -1;</b>
&nbsp;                                    try {
<b class="nc">&nbsp;                                        shotsVal = Integer</b>
<b class="nc">&nbsp;                                                .parseInt(shots);</b>
<b class="nc">&nbsp;                                    } catch (NumberFormatException excep) {</b>
&nbsp;                                        // Handled by the next if test.
<b class="nc">&nbsp;                                    }</b>
<b class="nc">&nbsp;                                    if (shots.equals(NA)) {</b>
<b class="nc">&nbsp;                                        shotsVal = IArmorState.ARMOR_NA;</b>
<b class="nc">&nbsp;                                        warning.append(</b>
&nbsp;                                                &quot;Expected to find number of &quot; +
&nbsp;                                                &quot;shots for &quot;)
<b class="nc">&nbsp;                                                .append(type)</b>
<b class="nc">&nbsp;                                                .append(&quot;, but found &quot;)</b>
<b class="nc">&nbsp;                                                .append(shots)</b>
<b class="nc">&nbsp;                                                .append(&quot; instead.\n&quot;);</b>
<b class="nc">&nbsp;                                    } else if ((shotsVal &lt; 0)</b>
&nbsp;                                            || (shotsVal &gt; 200)) {
<b class="nc">&nbsp;                                        warning.append(</b>
&nbsp;                                                &quot;Found invalid shots value &quot; +
&nbsp;                                                &quot;for slot: &quot;)
<b class="nc">&nbsp;                                                .append(shots)</b>
<b class="nc">&nbsp;                                                .append(&quot;.\n&quot;);</b>
&nbsp;                                    } else {
&nbsp;
&nbsp;                                        // Change to the saved
&nbsp;                                        // ammo type and shots.
<b class="nc">&nbsp;                                        mounted.changeAmmoType((AmmoType)</b>
&nbsp;                                                newLoad);
<b class="nc">&nbsp;                                        mounted.setShotsLeft(shotsVal);</b>
&nbsp;
&nbsp;                                    } // End have-good-shots-value
&nbsp;
&nbsp;                                    // Stop looking for a match.
<b class="nc">&nbsp;                                    break;</b>
&nbsp;
&nbsp;                                } // End found-match-for-slot
&nbsp;
&nbsp;                            } // End ammo-in-this-loc
&nbsp;
<b class="nc">&nbsp;                        } // Check the next ammo.</b>
&nbsp;
<b class="nc">&nbsp;                    } else {</b>
&nbsp;                        // Bad XML equipment.
<b class="nc">&nbsp;                        warning.append(&quot;XML file lists &quot;)</b>
<b class="nc">&nbsp;                                .append(type)</b>
<b class="nc">&nbsp;                                .append(&quot; equipment at location &quot;)</b>
<b class="nc">&nbsp;                                .append(loc)</b>
<b class="nc">&nbsp;                                .append(&quot;.  XML parser expected ammo.\n&quot;);</b>
&nbsp;                    } // End not-ammo-type
&nbsp;
&nbsp;                } // End is-tank
&nbsp;
&nbsp;                // TODO: handle slotless equipment.
<b class="nc">&nbsp;                return locAmmoCount;</b>
<b class="nc">&nbsp;            } else if ((indexVal &lt; 0)) {</b>
<b class="nc">&nbsp;                warning.append(&quot;Found invalid index value for slot: &quot;)</b>
<b class="nc">&nbsp;                        .append(index).append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                return locAmmoCount;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Is this index valid for this entity?
<b class="nc">&nbsp;            if (indexVal &gt; entity.getNumberOfCriticals(loc)) {</b>
<b class="nc">&nbsp;                warning.append(&quot;The entity, &quot;)</b>
<b class="nc">&nbsp;                        .append(entity.getShortName())</b>
<b class="nc">&nbsp;                        .append(&quot; does not have &quot;).append(index)</b>
<b class="nc">&nbsp;                        .append(&quot; slots in location &quot;).append(loc)</b>
<b class="nc">&nbsp;                        .append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                return locAmmoCount;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Try to get a good isHit value.
<b class="nc">&nbsp;            boolean hitFlag = Boolean.parseBoolean(hit);</b>
&nbsp;
&nbsp;            // Is the location destroyed?
<b class="nc">&nbsp;            boolean destFlag = Boolean.parseBoolean(destroyed);</b>
&nbsp;
&nbsp;            // Is the location repairable?
<b class="nc">&nbsp;            boolean repairFlag = Boolean.parseBoolean(repairable);</b>
&nbsp;
&nbsp;            // Try to get the critical slot.
<b class="nc">&nbsp;            CriticalSlot slot = entity.getCritical(loc, indexVal);</b>
&nbsp;
&nbsp;            // If we couldn&#39;t find a critical slot,
&nbsp;            // it&#39;s possible that this is &quot;extra&quot; ammo in a weapons bay, so we may attempt
&nbsp;            // to shove it in there
<b class="nc">&nbsp;            if (slot == null) {</b>
<b class="nc">&nbsp;                if((entity.usesWeaponBays() </b>
&nbsp;                        || entity instanceof Dropship) 
<b class="nc">&nbsp;                        &amp;&amp; !bayIndex.isEmpty()) {</b>
<b class="nc">&nbsp;                    addExtraAmmoToBay(entity, loc, type, bayIndex);</b>
<b class="nc">&nbsp;                    slot = entity.getCritical(loc, indexVal);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (slot == null) {</b>
<b class="nc">&nbsp;                if (!type.equals(EMPTY)) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;Could not find the &quot;)</b>
<b class="nc">&nbsp;                            .append(type)</b>
<b class="nc">&nbsp;                            .append(&quot; equipment that was expected at index &quot;)</b>
<b class="nc">&nbsp;                            .append(indexVal).append(&quot; of location &quot;)</b>
<b class="nc">&nbsp;                            .append(loc).append(&quot;.\n&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                return locAmmoCount;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Is the slot for a critical system?
<b class="nc">&nbsp;            if (slot.getType() == CriticalSlot.TYPE_SYSTEM) {</b>
&nbsp;
&nbsp;                // Does the XML file have some other kind of equipment?
<b class="nc">&nbsp;                if (!type.equals(SYSTEM)) {</b>
<b class="nc">&nbsp;                    warning.append(&quot;XML file expects to find &quot;)</b>
<b class="nc">&nbsp;                            .append(type)</b>
<b class="nc">&nbsp;                            .append(&quot; equipment at index &quot;)</b>
<b class="nc">&nbsp;                            .append(indexVal).append(&quot; of location &quot;)</b>
<b class="nc">&nbsp;                            .append(loc)</b>
<b class="nc">&nbsp;                            .append(&quot;, but Entity has a system.\n&quot;);</b>
&nbsp;                }
&nbsp;
&nbsp;            } else {
&nbsp;
&nbsp;                // Nope, we&#39;ve got equipment. Get this slot&#39;s mounted.
<b class="nc">&nbsp;                Mounted mounted = slot.getMount();</b>
&nbsp;
&nbsp;                // Reset transient values.
<b class="nc">&nbsp;                mounted.restore();</b>
&nbsp;
&nbsp;                // quirks
<b class="nc">&nbsp;                if ((null != quirks) &amp;&amp; (quirks.trim().length() &gt; 0)) {</b>
<b class="nc">&nbsp;                    StringTokenizer st = new StringTokenizer(quirks,</b>
&nbsp;                            &quot;::&quot;);
<b class="nc">&nbsp;                    while (st.hasMoreTokens()) {</b>
<b class="nc">&nbsp;                        String quirk = st.nextToken();</b>
<b class="nc">&nbsp;                        String quirkName = Crew</b>
<b class="nc">&nbsp;                                .parseAdvantageName(quirk);</b>
<b class="nc">&nbsp;                        Object value = Crew.parseAdvantageValue(quirk);</b>
&nbsp;
&nbsp;                        try {
<b class="nc">&nbsp;                            mounted.getQuirks().getOption(quirkName)</b>
<b class="nc">&nbsp;                                    .setValue(value);</b>
<b class="nc">&nbsp;                        } catch (Exception e) {</b>
<b class="nc">&nbsp;                            warning.append(&quot;Error restoring quirk: &quot;)</b>
<b class="nc">&nbsp;                                    .append(quirk).append(&quot;.\n&quot;);</b>
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;
&nbsp;                // trooper missing equipment
<b class="nc">&nbsp;                if ((null != trooperMiss) &amp;&amp; (trooperMiss.trim().length() &gt; 0)) {</b>
<b class="nc">&nbsp;                    StringTokenizer st = new StringTokenizer(trooperMiss,</b>
&nbsp;                            &quot;::&quot;);
<b class="nc">&nbsp;                    int i = BattleArmor.LOC_TROOPER_1;</b>
<b class="nc">&nbsp;                    while (st.hasMoreTokens() &amp;&amp; i &lt;= BattleArmor.LOC_TROOPER_6) {</b>
<b class="nc">&nbsp;                        String tmiss = st.nextToken();</b>
<b class="nc">&nbsp;                        mounted.setMissingForTrooper(i, Boolean.parseBoolean(tmiss));</b>
<b class="nc">&nbsp;                        i++;</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;
&nbsp;                // Hit and destroy the mounted, according to the flags.
<b class="nc">&nbsp;                mounted.setDestroyed(hitFlag || destFlag);</b>
&nbsp;
<b class="nc">&nbsp;                mounted.setRepairable(repairFlag);</b>
&nbsp;
<b class="nc">&nbsp;                mounted.setRapidfire(Boolean.parseBoolean(rfmg));</b>
&nbsp;
&nbsp;                // Is the mounted a type of ammo?
<b class="nc">&nbsp;                if (mounted.getType() instanceof AmmoType) {</b>
&nbsp;
&nbsp;                    // Get the saved ammo load.
<b class="nc">&nbsp;                    EquipmentType newLoad = EquipmentType.get(type);</b>
<b class="nc">&nbsp;                    if (newLoad instanceof AmmoType) {</b>
&nbsp;
&nbsp;                        // Try to get a good shots value.
<b class="nc">&nbsp;                        int shotsVal = -1;</b>
&nbsp;                        try {
<b class="nc">&nbsp;                            shotsVal = Integer.parseInt(shots);</b>
<b class="nc">&nbsp;                        } catch (NumberFormatException excep) {</b>
&nbsp;                            // Handled by the next if test.
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                        if (shots.equals(NA)) {</b>
<b class="nc">&nbsp;                            shotsVal = IArmorState.ARMOR_NA;</b>
<b class="nc">&nbsp;                            warning.append(</b>
&nbsp;                                    &quot;Expected to find number of shots for &quot;)
<b class="nc">&nbsp;                                    .append(type)</b>
<b class="nc">&nbsp;                                    .append(&quot;, but found &quot;)</b>
<b class="nc">&nbsp;                                    .append(shots)</b>
<b class="nc">&nbsp;                                    .append(&quot; instead.\n&quot;);</b>
<b class="nc">&nbsp;                        } else if ((shotsVal &lt; 0) || (shotsVal &gt; 200)) {</b>
<b class="nc">&nbsp;                            warning.append(</b>
&nbsp;                                    &quot;Found invalid shots value for slot: &quot;)
<b class="nc">&nbsp;                                    .append(shots).append(&quot;.\n&quot;);</b>
&nbsp;                        } else {
&nbsp;
&nbsp;                            // Change to the saved ammo type and shots.
<b class="nc">&nbsp;                            mounted.changeAmmoType((AmmoType) newLoad);</b>
<b class="nc">&nbsp;                            mounted.setShotsLeft(shotsVal);</b>
&nbsp;
&nbsp;                        } // End have-good-shots-value
&nbsp;                        try {
<b class="nc">&nbsp;                            double capVal = Double.parseDouble(capacity);</b>
<b class="nc">&nbsp;                            mounted.setAmmoCapacity(capVal);</b>
<b class="nc">&nbsp;                        } catch (NumberFormatException excep) {</b>
&nbsp;                            // Handled by the next if test.
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                        if (capacity.equals(NA)) {</b>
<b class="nc">&nbsp;                            if (entity.hasETypeFlag(Entity.ETYPE_BATTLEARMOR)</b>
<b class="nc">&nbsp;                                    || entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</b>
<b class="nc">&nbsp;                                mounted.setAmmoCapacity(mounted.getOriginalShots()</b>
<b class="nc">&nbsp;                                         * ((AmmoType) mounted.getType()).getKgPerShot() * 1000);</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                mounted.setAmmoCapacity(mounted.getOriginalShots()</b>
<b class="nc">&nbsp;                                        * mounted.getTonnage()</b>
<b class="nc">&nbsp;                                        / ((AmmoType) mounted.getType()).getShots());</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;
&nbsp;
<b class="nc">&nbsp;                    } else {</b>
&nbsp;                        // Bad XML equipment.
<b class="nc">&nbsp;                        warning.append(&quot;XML file expects &quot;)</b>
<b class="nc">&nbsp;                                .append(type)</b>
<b class="nc">&nbsp;                                .append(&quot; equipment at index &quot;)</b>
<b class="nc">&nbsp;                                .append(indexVal)</b>
<b class="nc">&nbsp;                                .append(&quot; of location &quot;)</b>
<b class="nc">&nbsp;                                .append(loc)</b>
<b class="nc">&nbsp;                                .append(&quot;, but Entity has &quot;)</b>
<b class="nc">&nbsp;                                .append(mounted.getType()</b>
<b class="nc">&nbsp;                                        .getInternalName())</b>
<b class="nc">&nbsp;                                .append(&quot;there .\n&quot;);</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                } // End slot-for-ammo</b>
&nbsp;
&nbsp;                // Not an ammo slot... does file agree with template?
<b class="nc">&nbsp;                else if (!mounted.getType().getInternalName()</b>
<b class="nc">&nbsp;                        .equals(type)) {</b>
&nbsp;                    // Bad XML equipment.
<b class="nc">&nbsp;                    warning.append(&quot;XML file expects &quot;)</b>
<b class="nc">&nbsp;                            .append(type)</b>
<b class="nc">&nbsp;                            .append(&quot; equipment at index &quot;)</b>
<b class="nc">&nbsp;                            .append(indexVal)</b>
<b class="nc">&nbsp;                            .append(&quot; of location &quot;)</b>
<b class="nc">&nbsp;                            .append(loc)</b>
<b class="nc">&nbsp;                            .append(&quot;, but Entity has &quot;)</b>
<b class="nc">&nbsp;                            .append(mounted.getType().getInternalName())</b>
<b class="nc">&nbsp;                            .append(&quot;there .\n&quot;);</b>
&nbsp;                }
&nbsp;
&nbsp;                // Check for munition attribute.
<b class="nc">&nbsp;                if (munition.length() &gt; 0) {</b>
&nbsp;                    // Retrieve munition by name.
<b class="nc">&nbsp;                    EquipmentType munType = EquipmentType.get(munition);</b>
&nbsp;
&nbsp;                    // Make sure munition is a type of ammo.
<b class="nc">&nbsp;                    if (munType instanceof AmmoType) {</b>
&nbsp;                        // Change to the saved munition type.
<b class="nc">&nbsp;                        mounted.getLinked().changeAmmoType(</b>
&nbsp;                                (AmmoType) munType);
&nbsp;                    } else {
&nbsp;                        // Bad XML equipment.
<b class="nc">&nbsp;                        warning.append(&quot;XML file expects&quot;)</b>
<b class="nc">&nbsp;                                .append(&quot; ammo for munition argument of&quot;)</b>
<b class="nc">&nbsp;                                .append(&quot; slot tag.\n&quot;);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (entity.isSupportVehicle() &amp;&amp; (mounted.getType() instanceof InfantryWeapon)) {</b>
<b class="nc">&nbsp;                    int clipSize = ((InfantryWeapon) mounted.getType()).getShots();</b>
<b class="nc">&nbsp;                    for (Mounted ammo = mounted.getLinked(); ammo != null; ammo = ammo.getLinked()) {</b>
<b class="nc">&nbsp;                        if (((AmmoType) ammo.getType()).getMunitionType() == AmmoType.M_INFERNO) {</b>
<b class="nc">&nbsp;                            if (!inferno.isEmpty()) {</b>
<b class="nc">&nbsp;                                String[] fields = inferno.split(&quot;:&quot;);</b>
<b class="nc">&nbsp;                                ammo.setShotsLeft(Integer.parseInt(fields[0]));</b>
<b class="nc">&nbsp;                                ammo.setOriginalShots(Integer.parseInt(fields[1]));</b>
<b class="nc">&nbsp;                            }</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            if (!standard.isEmpty()) {</b>
<b class="nc">&nbsp;                                String[] fields = standard.split(&quot;:&quot;);</b>
<b class="nc">&nbsp;                                ammo.setShotsLeft(Integer.parseInt(fields[0]));</b>
<b class="nc">&nbsp;                                ammo.setOriginalShots(Integer.parseInt(fields[1]));</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;
&nbsp;            } // End have-equipment
&nbsp;
&nbsp;            // Hit and destroy the slot, according to the flags.
<b class="nc">&nbsp;            slot.setHit(hitFlag);</b>
<b class="nc">&nbsp;            slot.setDestroyed(destFlag);</b>
<b class="nc">&nbsp;            slot.setRepairable(repairFlag);</b>
&nbsp;
&nbsp;        } // End have-required-fields
<b class="nc">&nbsp;        return locAmmoCount;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a movement tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param movementTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseMovement(Element movementTag, Entity entity){
<b class="nc">&nbsp;        String value = movementTag.getAttribute(MDAMAGE);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int motiveDamage = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Tank) entity).setMotiveDamage(motiveDamage);</b>
<b class="nc">&nbsp;            if (motiveDamage &gt;= ((Tank) entity).getOriginalWalkMP()) {</b>
<b class="nc">&nbsp;                ((Tank) entity).immobilize();</b>
<b class="nc">&nbsp;                ((Tank) entity).applyDamage();</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid motive damage value in movement tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        value = movementTag.getAttribute(MPENALTY);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int motivePenalty = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Tank) entity).setMotivePenalty(motivePenalty);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid motive penalty value in movement tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a turretlock tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param turretLockTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseTurretLock(Element turretLockTag, Entity entity){
<b class="nc">&nbsp;        String value = turretLockTag.getAttribute(DIRECTION);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int turDir = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Tank) entity).setSecondaryFacing(turDir);</b>
<b class="nc">&nbsp;            ((Tank) entity).lockTurret(((Tank)entity).getLocTurret());</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            System.err.println(e);</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid turret lock direction value in &quot; +</b>
&nbsp;                    &quot;movement tag.\n&quot;);
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a turret2lock tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param turret2LockTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseTurret2Lock(Element turret2LockTag, Entity entity){
<b class="nc">&nbsp;        String value = turret2LockTag.getAttribute(DIRECTION);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int turDir = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Tank) entity).setDualTurretOffset(turDir);</b>
<b class="nc">&nbsp;            ((Tank) entity).lockTurret(((Tank)entity).getLocTurret2());</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            System.err.println(e);</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid turret2 lock direction value in &quot; +</b>
&nbsp;                    &quot;movement tag.\n&quot;);
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a si tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param siTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseSI(Element siTag, Entity entity){
<b class="nc">&nbsp;        String value = siTag.getAttribute(INTEGRITY);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int newSI = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Aero) entity).setSI(newSI);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid SI value in structural integrity tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a heat tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param heatTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseHeat(Element heatTag, Entity entity){
<b class="nc">&nbsp;        String value = heatTag.getAttribute(SINK);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int newSinks = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Aero) entity).setHeatSinks(newSinks);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid heat sink value in heat sink tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a fuel tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param fuelTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseFuel(Element fuelTag, Entity entity){
<b class="nc">&nbsp;        String value = fuelTag.getAttribute(LEFT);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int newFuel = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((IAero) entity).setFuel(newFuel);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid fuel value in fuel tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a kf tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param kfTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseKF(Element kfTag, Entity entity){
<b class="nc">&nbsp;        String value = kfTag.getAttribute(INTEGRITY);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int newIntegrity = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Jumpship) entity).setKFIntegrity(newIntegrity);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid KF integrity value in KF integrity tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a sail tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param sailTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseSail(Element sailTag, Entity entity){
<b class="nc">&nbsp;        String value = sailTag.getAttribute(INTEGRITY);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int newIntegrity = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Jumpship) entity).setSailIntegrity(newIntegrity);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid sail integrity value in sail &quot; +</b>
&nbsp;                    &quot;integrity tag.\n&quot;);
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse an aeroCrit tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param aeroCritTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseAeroCrit(Element aeroCritTag, Entity entity){
<b class="nc">&nbsp;        String avionics = aeroCritTag.getAttribute(AVIONICS);</b>
<b class="nc">&nbsp;        String sensors = aeroCritTag.getAttribute(SENSORS);</b>
<b class="nc">&nbsp;        String engine = aeroCritTag.getAttribute(ENGINE);</b>
<b class="nc">&nbsp;        String fcs = aeroCritTag.getAttribute(FCS);</b>
<b class="nc">&nbsp;        String cic = aeroCritTag.getAttribute(CIC);</b>
<b class="nc">&nbsp;        String leftThrust = aeroCritTag.getAttribute(LEFT_THRUST);</b>
<b class="nc">&nbsp;        String rightThrust = aeroCritTag.getAttribute(RIGHT_THRUST);</b>
<b class="nc">&nbsp;        String lifeSupport = aeroCritTag.getAttribute(LIFE_SUPPORT);</b>
<b class="nc">&nbsp;        String gear = aeroCritTag.getAttribute(GEAR);</b>
&nbsp;
<b class="nc">&nbsp;        Aero a = (Aero) entity;</b>
&nbsp;
<b class="nc">&nbsp;        if (avionics.length() &gt; 0) {</b>
<b class="nc">&nbsp;            a.setAvionicsHits(Integer.parseInt(avionics));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (sensors.length() &gt; 0) {</b>
<b class="nc">&nbsp;            a.setSensorHits(Integer.parseInt(sensors));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (engine.length() &gt; 0) {</b>
<b class="nc">&nbsp;            a.setEngineHits(Integer.parseInt(engine));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (fcs.length() &gt; 0) {</b>
<b class="nc">&nbsp;            a.setFCSHits(Integer.parseInt(fcs));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (cic.length() &gt; 0) {</b>
<b class="nc">&nbsp;            a.setCICHits(Integer.parseInt(cic));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (leftThrust.length() &gt; 0) {</b>
<b class="nc">&nbsp;            a.setLeftThrustHits(Integer.parseInt(leftThrust));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (rightThrust.length() &gt; 0) {</b>
<b class="nc">&nbsp;            a.setRightThrustHits(Integer.parseInt(rightThrust));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (lifeSupport.length() &gt; 0) {</b>
<b class="nc">&nbsp;            a.setLifeSupport(false);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (gear.length() &gt; 0) {</b>
<b class="nc">&nbsp;            a.setGearHit(true);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Parse a dropCrit tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *  @param dropCritTag
&nbsp;     *  @param entity
&nbsp;     */
&nbsp;    private void parseDropCrit(Element dropCritTag, Entity entity){
<b class="nc">&nbsp;    	String dockingcollar = dropCritTag.getAttribute(DOCKING_COLLAR);</b>
<b class="nc">&nbsp;    	String kfboom = dropCritTag.getAttribute(KFBOOM);</b>
&nbsp;
<b class="nc">&nbsp;    	Dropship d = (Dropship) entity;</b>
&nbsp;
<b class="nc">&nbsp;    	if (dockingcollar.length() &gt; 0) {</b>
<b class="nc">&nbsp;    		d.setDamageDockCollar(true);</b>
&nbsp;    	}
<b class="nc">&nbsp;    	if (kfboom.length() &gt; 0) {</b>
<b class="nc">&nbsp;    		d.setDamageKFBoom(true);</b>
&nbsp;    	}
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     *  Parse cargo bay and door the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *  Borrowed all this from the code that handles vehicle stabilizer crits by location.
&nbsp;     *
&nbsp;     *  @param entity
&nbsp;     */
&nbsp;    private void parseTransportBay (Element bayTag, Entity entity) {
&nbsp;    	// Look for the element&#39;s attributes.
<b class="nc">&nbsp;    	String index = bayTag.getAttribute(INDEX);</b>
&nbsp;
&nbsp;    	int bay;
&nbsp;    	// Did we find the required index?
<b class="nc">&nbsp;    	if ((index == null) || (index.length() == 0)) {</b>
<b class="nc">&nbsp;    		warning.append(&quot;Could not find index for bay.\n&quot;);</b>
&nbsp;    		return;
&nbsp;    	} else {
&nbsp;    	// Try to get a good index value.
<b class="nc">&nbsp;    		bay = -1;</b>
&nbsp;    		try {
<b class="nc">&nbsp;    			bay = Integer.parseInt(index);</b>
<b class="nc">&nbsp;    		} catch (NumberFormatException excep) {</b>
&nbsp;    			// Handled by the next if test
<b class="nc">&nbsp;    		}</b>
<b class="nc">&nbsp;    		if (bay &lt; 0) {</b>
<b class="nc">&nbsp;    			warning.append(&quot;Found invalid index value for bay: &quot;).append(index).append(&quot;.\n&quot;);</b>
&nbsp;    			return;
<b class="nc">&nbsp;    		} else if (entity.getBayById(bay) == null) {</b>
<b class="nc">&nbsp;    			warning.append(&quot;The entity, &quot;)</b>
<b class="nc">&nbsp;    			.append(entity.getShortName())</b>
<b class="nc">&nbsp;    			.append(&quot; does not have a bay at index: &quot;)</b>
<b class="nc">&nbsp;    			.append(bay).append(&quot;.\n&quot;);</b>
&nbsp;    			return;
&nbsp;    		}
&nbsp;    	} // End check for required fields
&nbsp;
<b class="nc">&nbsp;    	Bay currentbay = entity.getBayById(bay);</b>
&nbsp;
&nbsp;    	// Handle children for each bay.
<b class="nc">&nbsp;    	NodeList nl = bayTag.getChildNodes();</b>
<b class="nc">&nbsp;    	for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;    		Node currNode = nl.item(i);</b>
&nbsp;
<b class="nc">&nbsp;    		if (currNode.getParentNode() != bayTag) {</b>
<b class="nc">&nbsp;    			continue;</b>
&nbsp;    		}
<b class="nc">&nbsp;    		int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;    		if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;    			String nodeName = currNode.getNodeName();</b>
<b class="nc">&nbsp;    			if (nodeName.equalsIgnoreCase(BAYDAMAGE)) {</b>
<b class="nc">&nbsp;    				currentbay.setBayDamage(Double.parseDouble(currNode.getTextContent()));</b>
<b class="nc">&nbsp;    			} else if (nodeName.equalsIgnoreCase(BAYDOORS)) {</b>
<b class="nc">&nbsp;                    currentbay.setCurrentDoors(Integer.parseInt(currNode.getTextContent()));</b>
<b class="nc">&nbsp;    		    } else if (nodeName.equalsIgnoreCase(LOADED)) {</b>
<b class="nc">&nbsp;                    currentbay.troops.add(Integer.parseInt(currNode.getTextContent()));</b>
&nbsp;                }
&nbsp;    	    }
&nbsp;        }
&nbsp;    } // End parseTransportBay
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a tankCrit tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param tankCrit
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseTankCrit(Element tankCrit, Entity entity){
<b class="nc">&nbsp;        String sensors = tankCrit.getAttribute(SENSORS);</b>
<b class="nc">&nbsp;        String engine = tankCrit.getAttribute(ENGINE);</b>
<b class="nc">&nbsp;        String driver = tankCrit.getAttribute(DRIVER);</b>
<b class="nc">&nbsp;        String commander = tankCrit.getAttribute(COMMANDER);</b>
&nbsp;
<b class="nc">&nbsp;        Tank t = (Tank) entity;</b>
&nbsp;
<b class="nc">&nbsp;        if (sensors.length() &gt; 0) {</b>
<b class="nc">&nbsp;            t.setSensorHits(Integer.parseInt(sensors));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (engine.equalsIgnoreCase(&quot;hit&quot;)) {</b>
<b class="nc">&nbsp;            t.engineHit();</b>
<b class="nc">&nbsp;            t.applyDamage();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (driver.equalsIgnoreCase(&quot;hit&quot;)) {</b>
<b class="nc">&nbsp;            t.setDriverHit(true);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (commander.equalsIgnoreCase(&quot;console&quot;)) {</b>
<b class="nc">&nbsp;            t.setUsingConsoleCommander(true);</b>
<b class="nc">&nbsp;        } else if (commander.equalsIgnoreCase(&quot;hit&quot;)) {</b>
<b class="nc">&nbsp;            t.setCommanderHit(true);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a bombs tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param bombsTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseBombs(Element bombsTag, Entity entity){
<b class="nc">&nbsp;        if (!(entity instanceof IBomber)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Found a bomb but Entity cannot carry bombs.\n&quot;);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Deal with any child nodes
<b class="nc">&nbsp;        NodeList nl = bombsTag.getChildNodes();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
&nbsp;
<b class="nc">&nbsp;            if (currNode.getParentNode() != bombsTag) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                Element currEle = (Element)currNode;</b>
<b class="nc">&nbsp;                String nodeName = currNode.getNodeName();</b>
<b class="nc">&nbsp;                if (nodeName.equalsIgnoreCase(BOMB)){</b>
<b class="nc">&nbsp;                    int[] bombChoices = ((IBomber) entity).getBombChoices();</b>
<b class="nc">&nbsp;                    String type = currEle.getAttribute(TYPE);</b>
<b class="nc">&nbsp;                    String load = currEle.getAttribute(LOAD);</b>
<b class="nc">&nbsp;                    if (type.length() &gt; 0 &amp;&amp; load.length() &gt; 0){</b>
<b class="nc">&nbsp;                        int bombType = BombType.getBombTypeFromInternalName(type);</b>
<b class="nc">&nbsp;                        if(bombType &lt;= BombType.B_NONE || bombType &gt;= BombType.B_NUM) {</b>
<b class="nc">&nbsp;                            continue;</b>
&nbsp;                        }
&nbsp;
<b class="nc">&nbsp;                        bombChoices[bombType] += Integer.parseInt(load);</b>
<b class="nc">&nbsp;                        ((IBomber) entity).setBombChoices(bombChoices);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            } else {
&nbsp;                continue;
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse a c3i tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param c3iTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseC3I(Element c3iTag, Entity entity){
&nbsp;        // Deal with any child nodes
<b class="nc">&nbsp;        NodeList nl = c3iTag.getChildNodes();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
&nbsp;
<b class="nc">&nbsp;            if (currNode.getParentNode() != c3iTag) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                Element currEle = (Element)currNode;</b>
<b class="nc">&nbsp;                String nodeName = currNode.getNodeName();</b>
<b class="nc">&nbsp;                if (nodeName.equalsIgnoreCase(C3ILINK)){</b>
<b class="nc">&nbsp;                    String link = currEle.getAttribute(LINK);</b>
<b class="nc">&nbsp;                    int pos = entity.getFreeC3iUUID();</b>
<b class="nc">&nbsp;                    if ((link.length() &gt; 0) &amp;&amp; (pos != -1)) {</b>
<b class="nc">&nbsp;                        System.out.println(&quot;Loading C3i UUID &quot; + pos +</b>
&nbsp;                                &quot;: &quot; + link);
<b class="nc">&nbsp;                        entity.setC3iNextUUIDAsString(pos, link);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            } else {
&nbsp;                continue;
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parse an NC3 tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param nc3Tag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseNC3(Element nc3Tag, Entity entity){
&nbsp;        // Deal with any child nodes
<b class="nc">&nbsp;        NodeList nl = nc3Tag.getChildNodes();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
&nbsp;
<b class="nc">&nbsp;            if (currNode.getParentNode() != nc3Tag) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                Element currEle = (Element)currNode;</b>
<b class="nc">&nbsp;                String nodeName = currNode.getNodeName();</b>
<b class="nc">&nbsp;                if (nodeName.equalsIgnoreCase(NC3LINK)){</b>
<b class="nc">&nbsp;                    String link = currEle.getAttribute(LINK);</b>
<b class="nc">&nbsp;                    int pos = entity.getFreeNC3UUID();</b>
<b class="nc">&nbsp;                    if ((link.length() &gt; 0) &amp;&amp; (pos != -1)) {</b>
<b class="nc">&nbsp;                        System.out.println(&quot;Loading NC3 UUID &quot; + pos +</b>
&nbsp;                                &quot;: &quot; + link);
<b class="nc">&nbsp;                        entity.setNC3NextUUIDAsString(pos, link);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            } else {
&nbsp;                continue;
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Parse an EscapeCraft tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param escCraftTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseEscapeCraft(Element escCraftTag, Entity entity){
<b class="nc">&nbsp;        if (!(entity instanceof SmallCraft || entity instanceof Jumpship)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Found an EscapeCraft tag but Entity is not a &quot; +</b>
&nbsp;                    &quot;Crewed Spacecraft!\n&quot;);
&nbsp;            return;
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            String id = escCraftTag.getAttribute(ID);</b>
<b class="nc">&nbsp;            ((Aero) entity).addEscapeCraft(id);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid external entity id in EscapeCraft tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Parse an EscapedPassengers tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param escPassTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseEscapedPassengers(Element escPassTag, Entity entity){
<b class="nc">&nbsp;        if (!(entity instanceof EjectedCrew || entity instanceof SmallCraft)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Found an EscapedPassengers tag but Entity is not a &quot; +</b>
&nbsp;                    &quot;Spacecraft Crew or Small Craft!\n&quot;);
&nbsp;            return;
&nbsp;        }
&nbsp;        // Deal with any child nodes
<b class="nc">&nbsp;        NodeList nl = escPassTag.getChildNodes();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                Element currEle = (Element)currNode;</b>
<b class="nc">&nbsp;                String id = currEle.getAttribute(ID);</b>
<b class="nc">&nbsp;                String number = currEle.getAttribute(NUMBER);</b>
<b class="nc">&nbsp;                int value = Integer.parseInt(number);</b>
<b class="nc">&nbsp;                if (entity instanceof EjectedCrew) {</b>
<b class="nc">&nbsp;                    ((EjectedCrew) entity).addPassengers(id, value);</b>
<b class="nc">&nbsp;                } else if (entity instanceof SmallCraft) {</b>
<b class="nc">&nbsp;                    ((SmallCraft) entity).addPassengers(id, value);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Parse an EscapedCrew tag for the given &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param escCrewTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseEscapedCrew(Element escCrewTag, Entity entity){
<b class="nc">&nbsp;        if (!(entity instanceof EjectedCrew || entity instanceof SmallCraft)) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Found an EscapedCrew tag but Entity is not a &quot; +</b>
&nbsp;                    &quot;Spacecraft Crew or Small Craft!\n&quot;);
&nbsp;            return;
&nbsp;        }
&nbsp;        // Deal with any child nodes
<b class="nc">&nbsp;        NodeList nl = escCrewTag.getChildNodes();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; nl.getLength(); i++) {</b>
<b class="nc">&nbsp;            Node currNode = nl.item(i);</b>
<b class="nc">&nbsp;            int nodeType = currNode.getNodeType();</b>
<b class="nc">&nbsp;            if (nodeType == Node.ELEMENT_NODE) {</b>
<b class="nc">&nbsp;                Element currEle = (Element)currNode;</b>
<b class="nc">&nbsp;                String id = currEle.getAttribute(ID);</b>
<b class="nc">&nbsp;                String number = currEle.getAttribute(NUMBER);</b>
<b class="nc">&nbsp;                int value = Integer.parseInt(number);</b>
<b class="nc">&nbsp;                if (entity instanceof EjectedCrew) {</b>
<b class="nc">&nbsp;                    ((EjectedCrew) entity).addNOtherCrew(id, value);</b>
<b class="nc">&nbsp;                } else if (entity instanceof SmallCraft) {</b>
<b class="nc">&nbsp;                    ((SmallCraft) entity).addNOtherCrew(id, value);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Parse an original si tag for the given &lt;code&gt;Entity&lt;/code&gt;. Used by Escape Pods
&nbsp;     *
&nbsp;     * @param OsiTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseOSI(Element OsiTag, Entity entity){
<b class="nc">&nbsp;        String value = OsiTag.getAttribute(NUMBER);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int newSI = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Aero) entity).set0SI(newSI);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid SI value in original structural integrity tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Parse an original men tag for the given &lt;code&gt;Entity&lt;/code&gt;. Used by Escaped spacecraft crew
&nbsp;     *
&nbsp;     * @param OMenTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseOMen(Element OMenTag, Entity entity){
<b class="nc">&nbsp;        String value = OMenTag.getAttribute(NUMBER);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int newMen = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            ((Infantry) entity).initializeInternal(newMen, Infantry.LOC_INFANTRY);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid internal value in original number of men tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Parse a conveyance tag for the given &lt;code&gt;Entity&lt;/code&gt;. Used to resolve crew damage to transported entities
&nbsp;     *
&nbsp;     * @param conveyanceTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseConveyance(Element conveyanceTag, Entity entity){
<b class="nc">&nbsp;        String value = conveyanceTag.getAttribute(ID);</b>
&nbsp;        try {
<b class="nc">&nbsp;            int id = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            entity.setTransportId(id);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid transport id in conveyance tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Parse an id tag for the given &lt;code&gt;Entity&lt;/code&gt;. Used to resolve crew damage to transported entities
&nbsp;     *
&nbsp;     * @param idTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseId(Element idTag, Entity entity){
<b class="nc">&nbsp;        String value = idTag.getAttribute(ID);</b>
&nbsp;        //Safety. We don&#39;t want to mess with autoassigned game Ids
<b class="nc">&nbsp;        if (entity.getGame() != null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            int id = Integer.parseInt(value);</b>
<b class="nc">&nbsp;            entity.setId(id);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            warning.append(&quot;Invalid id in conveyance tag.\n&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parase a modularEquipmentMount tag for the supplied &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param meaTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseBAMEA(Element meaTag, Entity entity){
<b class="nc">&nbsp;        if (!(entity instanceof BattleArmor)){</b>
<b class="nc">&nbsp;            warning.append(&quot;Found a BA MEA tag but Entity is not &quot; +</b>
&nbsp;                    &quot;BattleArmor!\n&quot;);
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        String meaMountLocString = meaTag.getAttribute(BA_MEA_MOUNT_LOC);</b>
<b class="nc">&nbsp;        String manipTypeName = meaTag.getAttribute(BA_MEA_TYPE_NAME);</b>
&nbsp;
&nbsp;        // Make sure we got a mount number
<b class="nc">&nbsp;        if (meaMountLocString.length() == 0){</b>
<b class="nc">&nbsp;            warning.append(&quot;antiPersonnelMount tag does not specify &quot; +</b>
&nbsp;                    &quot;a baMeaMountLoc!\n&quot;);
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // We could have no mounted manipulator
<b class="nc">&nbsp;        EquipmentType manipType = null;</b>
<b class="nc">&nbsp;        if (manipTypeName.length() &gt; 0){</b>
<b class="nc">&nbsp;            manipType = EquipmentType.get(manipTypeName);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Find the Mounted instance for the MEA
<b class="nc">&nbsp;        Mounted mountedManip = null;</b>
<b class="nc">&nbsp;        int meaMountLoc = Integer.parseInt(meaMountLocString);</b>
<b class="nc">&nbsp;        boolean foundMea = false;</b>
<b class="nc">&nbsp;        for (Mounted m : entity.getEquipment()){</b>
<b class="nc">&nbsp;            if (m.getBaMountLoc() != meaMountLoc){</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (m.getType().hasFlag(MiscType.F_BA_MEA)){</b>
<b class="nc">&nbsp;                foundMea = true;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (!foundMea){</b>
<b class="nc">&nbsp;            warning.append(&quot;No modular equipment mount found in specified &quot; + &quot;location! Location: &quot;)</b>
<b class="nc">&nbsp;                    .append(meaMountLoc).append(&quot;\n&quot;);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (meaMountLoc == BattleArmor.MOUNT_LOC_LARM){</b>
<b class="nc">&nbsp;            mountedManip = ((BattleArmor)entity).getLeftManipulator();</b>
<b class="nc">&nbsp;        } else if (meaMountLoc == BattleArmor.MOUNT_LOC_RARM){</b>
<b class="nc">&nbsp;            mountedManip = ((BattleArmor)entity).getRightManipulator();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (mountedManip != null){</b>
<b class="nc">&nbsp;            entity.getEquipment().remove(mountedManip);</b>
<b class="nc">&nbsp;            entity.getMisc().remove(mountedManip);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Was no manipulator selected?
<b class="nc">&nbsp;        if (manipType == null){</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Add the newly mounted maniplator
&nbsp;        try{
<b class="nc">&nbsp;            int baMountLoc = mountedManip.getBaMountLoc();</b>
<b class="nc">&nbsp;            mountedManip = entity.addEquipment(manipType,</b>
<b class="nc">&nbsp;                    mountedManip.getLocation());</b>
<b class="nc">&nbsp;            mountedManip.setBaMountLoc(baMountLoc);</b>
<b class="nc">&nbsp;        } catch (LocationFullException ex){</b>
&nbsp;            // This shouldn&#39;t happen for BA...
<b class="nc">&nbsp;            ex.printStackTrace();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Parase a antiPersonnelMount tag for the supplied &lt;code&gt;Entity&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @param apmTag
&nbsp;     * @param entity
&nbsp;     */
&nbsp;    private void parseBAAPM(Element apmTag, Entity entity){
<b class="nc">&nbsp;        if (!(entity instanceof BattleArmor)){</b>
<b class="nc">&nbsp;            warning.append(&quot;Found a BA APM tag but Entity is not &quot; +</b>
&nbsp;                    &quot;BattleArmor!\n&quot;);
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        String mountNumber = apmTag.getAttribute(BA_APM_MOUNT_NUM);</b>
<b class="nc">&nbsp;        String apTypeName = apmTag.getAttribute(BA_APM_TYPE_NAME);</b>
&nbsp;
&nbsp;        // Make sure we got a mount number
<b class="nc">&nbsp;        if (mountNumber.length() == 0){</b>
<b class="nc">&nbsp;            warning.append(&quot;antiPersonnelMount tag does not specify &quot; +</b>
&nbsp;                    &quot;a baAPMountNum!\n&quot;);
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Mounted apMount = entity.getEquipment(Integer.parseInt(mountNumber));</b>
&nbsp;        // We may mount no AP weapon
<b class="nc">&nbsp;        EquipmentType apType = null;</b>
<b class="nc">&nbsp;        if (apTypeName.length() &gt; 0){</b>
<b class="nc">&nbsp;            apType = EquipmentType.get(apTypeName);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Remove any currently mounted AP weapon
<b class="nc">&nbsp;        if (apMount.getLinked() != null</b>
<b class="nc">&nbsp;                &amp;&amp; apMount.getLinked().getType() != apType){</b>
<b class="nc">&nbsp;            Mounted apWeapon = apMount.getLinked();</b>
<b class="nc">&nbsp;            entity.getEquipment().remove(apWeapon);</b>
<b class="nc">&nbsp;            entity.getWeaponList().remove(apWeapon);</b>
<b class="nc">&nbsp;            entity.getTotalWeaponList().remove(apWeapon);</b>
&nbsp;            // We need to make sure that the weapon has been removed
&nbsp;            //  from the criticals, otherwise it can cause issues
<b class="nc">&nbsp;            for (int loc = 0; loc &lt; entity.locations(); loc++) {</b>
<b class="nc">&nbsp;                for (int c = 0;</b>
<b class="nc">&nbsp;                        c &lt; entity.getNumberOfCriticals(loc); c++) {</b>
<b class="nc">&nbsp;                    CriticalSlot crit = entity.getCritical(loc, c);</b>
<b class="nc">&nbsp;                    if (crit != null &amp;&amp; crit.getMount() != null</b>
<b class="nc">&nbsp;                            &amp;&amp; crit.getMount().equals(apWeapon)) {</b>
<b class="nc">&nbsp;                        entity.setCritical(loc, c, null);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Did the selection not change, or no weapon was selected
<b class="nc">&nbsp;        if ((apMount.getLinked() != null</b>
<b class="nc">&nbsp;                &amp;&amp; apMount.getLinked().getType() == apType)</b>
&nbsp;                || (apType == null)){
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Add the newly mounted weapon
&nbsp;        try{
<b class="nc">&nbsp;            Mounted newWeap =  entity.addEquipment(apType,</b>
<b class="nc">&nbsp;                    apMount.getLocation());</b>
<b class="nc">&nbsp;            apMount.setLinked(newWeap);</b>
<b class="nc">&nbsp;            newWeap.setLinked(apMount);</b>
<b class="nc">&nbsp;            newWeap.setAPMMounted(true);</b>
<b class="nc">&nbsp;        } catch (LocationFullException ex){</b>
&nbsp;            // This shouldn&#39;t happen for BA...
<b class="nc">&nbsp;            ex.printStackTrace();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Worker function that takes an entity, a location, an ammo type string and the critical index
&nbsp;     * of a weapons bay in the given location and attempts to add the ammo type there.
&nbsp;     * @param entity The entity we&#39;re working on loading
&nbsp;     * @param loc The location index on the entity
&nbsp;     * @param type The ammo type string
&nbsp;     * @param bayIndex The crit index of the bay where we want to load the ammo on the location where the bay is
&nbsp;     */
&nbsp;    private void addExtraAmmoToBay(Entity entity, int loc, String type, String bayIndex) {
&nbsp;        // here, we need to do the following:
&nbsp;        // 1: get the bay to which this ammo belongs, and add it to said bay
&nbsp;        // 2: add the ammo to the entity as a &quot;new&quot; piece of equipment
&nbsp;        // 3: add the ammo to a crit slot on the bay&#39;s location
&nbsp;
<b class="nc">&nbsp;        int bayCritIndex = Integer.parseInt(bayIndex);</b>
<b class="nc">&nbsp;        Mounted bay = entity.getCritical(loc, bayCritIndex - 1).getMount();</b>
&nbsp;
<b class="nc">&nbsp;        Mounted ammo = new Mounted(entity, AmmoType.get(type));</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            entity.addEquipment(ammo, loc, bay.isRearMounted());</b>
<b class="nc">&nbsp;        } catch(LocationFullException lfe) {</b>
&nbsp;            // silently swallow it, since dropship locations have about a hundred crit slots
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        bay.addAmmoToBay(entity.getEquipmentNum(ammo));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Determine if unexpected XML entities were encountered during parsing.
&nbsp;     *
&nbsp;     * @return &lt;code&gt;true&lt;/code&gt; if a non-fatal warning occured.
&nbsp;     */
&nbsp;    public boolean hasWarningMessage() {
<b class="nc">&nbsp;        return (warning.length() &gt; 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the warning message from the last parse.
&nbsp;     *
&nbsp;     * @return The &lt;code&gt;String&lt;/code&gt; warning message from the last parse. If
&nbsp;     *         there is no warning message, then an &lt;code&gt;null&lt;/code&gt; value is
&nbsp;     *         returned.
&nbsp;     */
&nbsp;    public String getWarningMessage() {
<b class="nc">&nbsp;        if (warning.length() &gt; 0) {</b>
<b class="nc">&nbsp;            return warning.toString();</b>
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a list of all of the  Entity&#39;s parsed from the input, should be
&nbsp;     * called after &lt;code&gt;parse&lt;/code&gt;. This is for entities that we want to be loaded
&nbsp;     * into the chat lounge, so functional
&nbsp;     * @return
&nbsp;     */
&nbsp;    public Vector&lt;Entity&gt; getEntities(){
<b class="nc">&nbsp;        Vector&lt;Entity&gt; toReturn = entities;</b>
<b class="nc">&nbsp;        for(Entity e : survivors) {</b>
<b class="nc">&nbsp;            if(e instanceof EjectedCrew) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            toReturn.add(e);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return toReturn;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a list of all of the salvaged Entity&#39;s parsed from the input, should be
&nbsp;     * called after &lt;code&gt;parse&lt;/code&gt;.
&nbsp;     * @return
&nbsp;     */
&nbsp;    public Vector&lt;Entity&gt; getSurvivors(){
<b class="nc">&nbsp;        return survivors;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a list of all of the allied Entity&#39;s parsed from the input, should be
&nbsp;     * called after &lt;code&gt;parse&lt;/code&gt;.
&nbsp;     * @return
&nbsp;     */
&nbsp;    public Vector&lt;Entity&gt; getAllies(){
<b class="nc">&nbsp;        return allies;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a list of all of the salvaged Entity&#39;s parsed from the input, should be
&nbsp;     * called after &lt;code&gt;parse&lt;/code&gt;.
&nbsp;     * @return
&nbsp;     */
&nbsp;    public Vector&lt;Entity&gt; getSalvage(){
<b class="nc">&nbsp;        return salvage;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a list of all of the enemy retreated entities parsed from the input, should be
&nbsp;     * called after &lt;code&gt;parse&lt;/code&gt;.
&nbsp;     * @return
&nbsp;     */
&nbsp;    public Vector&lt;Entity&gt; getRetreated(){
<b class="nc">&nbsp;        return retreated;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a list of all of the devastated Entity&#39;s parsed from the input, should be
&nbsp;     * called after &lt;code&gt;parse&lt;/code&gt;.
&nbsp;     * @return
&nbsp;     */
&nbsp;    public Vector&lt;Entity&gt; getDevastated(){
<b class="nc">&nbsp;        return devastated;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a list of all of the Pilots parsed from the input, should be
&nbsp;     * called after &lt;code&gt;parse&lt;/code&gt;.
&nbsp;     *
&nbsp;     * @return
&nbsp;     */
&nbsp;    public Vector&lt;Crew&gt; getPilots() {
<b class="nc">&nbsp;        return pilots;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns the kills hashtable
&nbsp;     *
&nbsp;     * @return
&nbsp;     */
&nbsp;    public Hashtable&lt;String, String&gt; getKills() {
<b class="nc">&nbsp;        return kills;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Marks all equipment in a location on an &lt;code&gt;Entity&lt;code&gt; as destroyed.
&nbsp;     *
&nbsp;     * @param en
&nbsp;     *            - the &lt;code&gt;Entity&lt;/code&gt; whose location is destroyed.
&nbsp;     * @param loc
&nbsp;     *            - the &lt;code&gt;int&lt;/code&gt; index of the destroyed location.
&nbsp;     */
&nbsp;    private void destroyLocation(Entity en, int loc) {
&nbsp;
&nbsp;        // mark armor, internal as destroyed
<b class="nc">&nbsp;        en.setArmor(IArmorState.ARMOR_DESTROYED, loc, false);</b>
<b class="nc">&nbsp;        en.setInternal(IArmorState.ARMOR_DESTROYED, loc);</b>
<b class="nc">&nbsp;        if (en.hasRearArmor(loc)) {</b>
<b class="nc">&nbsp;            en.setArmor(IArmorState.ARMOR_DESTROYED, loc, true);</b>
&nbsp;        }
&nbsp;        // equipment marked missing
<b class="nc">&nbsp;        for (Mounted mounted : en.getEquipment()) {</b>
<b class="nc">&nbsp;            if (mounted.getLocation() == loc) {</b>
<b class="nc">&nbsp;                mounted.setDestroyed(true);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // all critical slots set as missing
<b class="nc">&nbsp;        for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</b>
<b class="nc">&nbsp;            final CriticalSlot cs = en.getCritical(loc, i);</b>
<b class="nc">&nbsp;            if (cs != null) {</b>
<b class="nc">&nbsp;                cs.setDestroyed(true);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void breachLocation(Entity en, int loc) {
&nbsp;        // equipment marked breached
<b class="nc">&nbsp;        for (Mounted mounted : en.getEquipment()) {</b>
<b class="nc">&nbsp;            if (mounted.getLocation() == loc) {</b>
<b class="nc">&nbsp;                mounted.setBreached(true);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // all critical slots set as breached
<b class="nc">&nbsp;        for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</b>
<b class="nc">&nbsp;            final CriticalSlot cs = en.getCritical(loc, i);</b>
<b class="nc">&nbsp;            if (cs != null) {</b>
<b class="nc">&nbsp;                cs.setBreached(true);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        en.setLocationStatus(loc, ILocationExposureStatus.BREACHED);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void blowOffLocation(Entity en, int loc) {
<b class="nc">&nbsp;        en.setLocationBlownOff(loc, true);</b>
<b class="nc">&nbsp;        for (Mounted mounted : en.getEquipment()) {</b>
<b class="nc">&nbsp;            if (mounted.getLocation() == loc) {</b>
<b class="nc">&nbsp;                mounted.setMissing(true);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</b>
<b class="nc">&nbsp;            final CriticalSlot cs = en.getCritical(loc, i);</b>
<b class="nc">&nbsp;            if (cs != null) {</b>
<b class="nc">&nbsp;                cs.setMissing(true);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
