


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > BattleForceElement</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.common</a>
</div>

<h1>Coverage Summary for Class: BattleForceElement (megamek.common)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">BattleForceElement</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/41)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/367)
  </span>
</td>
</tr>
  <tr>
    <td class="name">BattleForceElement$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BattleForceElement$WeaponLocation</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/62)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/66)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/430)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; *  MegaMek - Copyright (C) 2016 The MegaMek Team
&nbsp; *
&nbsp; *  This program is free software; you can redistribute it and/or modify it
&nbsp; *  under the terms of the GNU General Public License as published by the Free
&nbsp; *  Software Foundation; either version 2 of the License, or (at your option)
&nbsp; *  any later version.
&nbsp; *
&nbsp; *  This program is distributed in the hope that it will be useful, but
&nbsp; *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
&nbsp; *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
&nbsp; *  for more details.
&nbsp; */
&nbsp;
&nbsp;package megamek.common;
&nbsp;
&nbsp;import java.io.BufferedWriter;
&nbsp;import java.io.IOException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.EnumMap;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;import java.util.StringJoiner;
&nbsp;import java.util.stream.Collectors;
&nbsp;import java.util.stream.IntStream;
&nbsp;
&nbsp;import megamek.common.weapons.bayweapons.ArtilleryBayWeapon;
&nbsp;import megamek.common.weapons.InfantryAttack;
&nbsp;import megamek.common.weapons.bayweapons.BayWeapon;
&nbsp;import megamek.common.weapons.missiles.MissileWeapon;
&nbsp;
&nbsp;/**
&nbsp; * Primarily concerned with calculating BattleForce values for an undamaged entity, and exporting
&nbsp; * stats in csv form.
&nbsp; * 
&nbsp; * @author Neoancient
&nbsp; *
&nbsp; */
&nbsp;public class BattleForceElement {
&nbsp;    
&nbsp;    static final int RANGE_BAND_SHORT = 0;
&nbsp;    static final int RANGE_BAND_MEDIUM = 1;
&nbsp;    static final int RANGE_BAND_LONG = 2;
&nbsp;    static final int RANGE_BAND_EXTREME = 3;
&nbsp;    static final int RANGE_BAND_NUM_GROUND = 3;
&nbsp;    static final int RANGE_BAND_NUM_AERO = 4;
&nbsp;    
<b class="nc">&nbsp;    static final int[] STANDARD_RANGES = {0, 4, 16, 24};</b>
<b class="nc">&nbsp;    static final int[] CAPITAL_RANGES = {0, 13, 25, 41};</b>
&nbsp;    
<b class="nc">&nbsp;    public static final int SHORT_RANGE = STANDARD_RANGES[RANGE_BAND_SHORT];</b>
<b class="nc">&nbsp;    public static final int MEDIUM_RANGE = STANDARD_RANGES[RANGE_BAND_MEDIUM];</b>
<b class="nc">&nbsp;    public static final int LONG_RANGE = STANDARD_RANGES[RANGE_BAND_LONG];</b>
<b class="nc">&nbsp;    public static final int EXTREME_RANGE = STANDARD_RANGES[RANGE_BAND_EXTREME];</b>
&nbsp;    
&nbsp;    protected String name;
&nbsp;    protected int size;
<b class="nc">&nbsp;    protected LinkedHashMap&lt;String,Integer&gt; movement = new LinkedHashMap&lt;&gt;();</b>
&nbsp;    protected double armor;
<b class="nc">&nbsp;    protected double threshold = -1;</b>
&nbsp;    protected int structure;
<b class="nc">&nbsp;    protected int rangeBands = RANGE_BAND_NUM_GROUND;</b>
&nbsp;    protected WeaponLocation[] weaponLocations;
&nbsp;    protected String[] locationNames;
&nbsp;    protected int[] heat;
&nbsp;    protected double points;
<b class="nc">&nbsp;    protected EnumMap&lt;BattleForceSPA,Integer&gt; specialAbilities = new EnumMap&lt;&gt;(BattleForceSPA.class);</b>
&nbsp;    
<b class="nc">&nbsp;    public BattleForceElement(Entity en) {</b>
<b class="nc">&nbsp;        name = en.getShortName();</b>
<b class="nc">&nbsp;        size = en.getBattleForceSize();</b>
<b class="nc">&nbsp;        computeMovement(en);</b>
<b class="nc">&nbsp;        armor = en.getBattleForceArmorPointsRaw();</b>
<b class="nc">&nbsp;        if (en instanceof Aero) {</b>
<b class="nc">&nbsp;            threshold = armor / 10.0;</b>
&nbsp;        }
<b class="nc">&nbsp;        structure = en.getBattleForceStructurePoints();</b>
<b class="nc">&nbsp;        if (en instanceof Aero) {</b>
<b class="nc">&nbsp;        	rangeBands = RANGE_BAND_NUM_AERO;</b>
&nbsp;        }
<b class="nc">&nbsp;        initWeaponLocations(en);</b>
<b class="nc">&nbsp;        heat = new int[rangeBands];</b>
<b class="nc">&nbsp;        computeDamage(en);</b>
<b class="nc">&nbsp;        points = calculatePointValue(en);</b>
<b class="nc">&nbsp;        en.addBattleForceSpecialAbilities(specialAbilities);</b>
&nbsp;    }
&nbsp;    
&nbsp;    protected void initWeaponLocations(Entity en) {
<b class="nc">&nbsp;        weaponLocations = new WeaponLocation[en.getNumBattleForceWeaponsLocations()];</b>
<b class="nc">&nbsp;        locationNames = new String[weaponLocations.length];</b>
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; locationNames.length; loc++) {</b>
<b class="nc">&nbsp;            weaponLocations[loc] = new WeaponLocation();</b>
<b class="nc">&nbsp;            locationNames[loc] = en.getBattleForceLocationName(loc);</b>
<b class="nc">&nbsp;            if (locationNames[loc].length() &gt; 0) {</b>
<b class="nc">&nbsp;                locationNames[loc] += &quot;:&quot;;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    protected void computeMovement(Entity en) {
<b class="nc">&nbsp;    	en.setBattleForceMovement(movement);    	</b>
&nbsp;    }
&nbsp;    
&nbsp;    public String getName() {
<b class="nc">&nbsp;        return name;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public int getSize() {
<b class="nc">&nbsp;        return size;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public Set&lt;String&gt; getMovementModes() {
<b class="nc">&nbsp;    	return movement.keySet();</b>
&nbsp;    }
&nbsp;    
&nbsp;    public int getMovement(String mode) {
<b class="nc">&nbsp;    	return movement.get(mode);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public int getPrimaryMovementValue() {
<b class="nc">&nbsp;    	return movement.values().iterator().next();</b>
&nbsp;    }
&nbsp;    
&nbsp;    public String getMovementAsString() {
<b class="nc">&nbsp;    	return movement.entrySet().stream()</b>
<b class="nc">&nbsp;    			.map(e -&gt; (e.getKey().equals(&quot;k&quot;)?&quot;0.&quot; + e.getValue():e.getValue())</b>
<b class="nc">&nbsp;    					+ e.getKey())</b>
<b class="nc">&nbsp;    			.collect(Collectors.joining(&quot;/&quot;));    	</b>
&nbsp;    }
&nbsp;    
&nbsp;    public int getFinalArmor() {
<b class="nc">&nbsp;        return (int)Math.round(armor);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public double getArmor() {
<b class="nc">&nbsp;        return armor;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public int getFinalThreshold() {
<b class="nc">&nbsp;        return (int)Math.ceil(threshold);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public double getThreshold() {
<b class="nc">&nbsp;        return threshold;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public int getStructure() {
<b class="nc">&nbsp;        return structure;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public double getDamage(int loc, int rangeIndex, int damageClass) {
<b class="nc">&nbsp;    	return weaponLocations[loc].getDamage(damageClass, rangeIndex);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public double getDamage(int rangeIndex) {
<b class="nc">&nbsp;    	return weaponLocations[0].getDamage(rangeIndex);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public double getDamage(int rangeIndex, int damageClass) {
<b class="nc">&nbsp;    	return getDamage(0, rangeIndex, damageClass);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public double getIndirectFire() {
<b class="nc">&nbsp;    	return getIndirectFire(0);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public double getIndirectFire(int loc) {
<b class="nc">&nbsp;    	return weaponLocations[loc].getIF();</b>
&nbsp;    }
&nbsp;    
&nbsp;    public String getLocationName(int loc) {
<b class="nc">&nbsp;        return locationNames[loc];</b>
&nbsp;    }
&nbsp;    
&nbsp;    public Integer getSPA(BattleForceSPA spa) {
<b class="nc">&nbsp;    	return specialAbilities.get(spa);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public boolean hasSPA(BattleForceSPA spa) {
<b class="nc">&nbsp;    	return specialAbilities.containsKey(spa);</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getFinalPoints() {
<b class="nc">&nbsp;        return Math.max(1, (int)Math.round(points));</b>
&nbsp;    }
&nbsp;    
&nbsp;    public double getPoints() {
<b class="nc">&nbsp;        return points;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public void computeDamage(Entity en) {
<b class="nc">&nbsp;        double[] baseDamage = new double[rangeBands];</b>
<b class="nc">&nbsp;        boolean hasTC = en.hasTargComp();</b>
&nbsp;        int[] ranges;
<b class="nc">&nbsp;        double pointDefense = 0;</b>
<b class="nc">&nbsp;        int bombRacks = 0;</b>
&nbsp;        //Track weapons we&#39;ve already calculated ammunition for
<b class="nc">&nbsp;        HashMap&lt;String,Boolean&gt; ammoForWeapon = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        ArrayList&lt;Mounted&gt; weaponsList = en.getWeaponList();</b>
&nbsp;
<b class="nc">&nbsp;        for (int pos = 0; pos &lt; weaponsList.size(); pos++) {</b>
<b class="nc">&nbsp;            Arrays.fill(baseDamage, 0);</b>
<b class="nc">&nbsp;            double damageModifier = 1;</b>
<b class="nc">&nbsp;            Mounted mount = weaponsList.get(pos);</b>
<b class="nc">&nbsp;            if ((mount == null)</b>
<b class="nc">&nbsp;                    || (en.getEntityType() == Entity.ETYPE_INFANTRY</b>
<b class="nc">&nbsp;                        &amp;&amp; mount.getLocation() == Infantry.LOC_INFANTRY)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            WeaponType weapon = (WeaponType) mount.getType();</b>
&nbsp;            
<b class="nc">&nbsp;            ranges = weapon.isCapital()? CAPITAL_RANGES : STANDARD_RANGES;</b>
&nbsp;            
<b class="nc">&nbsp;            if (weapon.getAmmoType() == AmmoType.T_INARC) {</b>
<b class="nc">&nbsp;               specialAbilities.merge(BattleForceSPA.INARC, 1, Integer::sum);</b>
<b class="nc">&nbsp;               continue;</b>
<b class="nc">&nbsp;            } else if (weapon.getAmmoType() == AmmoType.T_NARC) {</b>
<b class="nc">&nbsp;                if (weapon.hasFlag(WeaponType.F_BA_WEAPON)) {</b>
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.CNARC, 1, Integer::sum);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.SNARC, 1, Integer::sum);</b>
&nbsp;                }
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if (weapon.getAtClass() == WeaponType.CLASS_SCREEN) {</b>
<b class="nc">&nbsp;                specialAbilities.merge(BattleForceSPA.SCR, 1, Integer::sum);</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (weapon.hasFlag(WeaponType.F_AMS)) {</b>
<b class="nc">&nbsp;                specialAbilities.put(BattleForceSPA.AMS, null);</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (weapon.hasFlag(WeaponType.F_TAG)) {</b>
<b class="nc">&nbsp;                if (weapon.hasFlag(WeaponType.F_C3MBS)) {</b>
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.C3BSM, 1, Integer::sum);</b>
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.MHQ, 12, Integer::sum); //count half-tons</b>
<b class="nc">&nbsp;                } else if (weapon.hasFlag(WeaponType.F_C3M)) {</b>
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.C3M, 1, Integer::sum);</b>
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.MHQ, 10, Integer::sum);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (weapon.getShortRange() &lt; 5) {</b>
<b class="nc">&nbsp;                    specialAbilities.put(BattleForceSPA.LTAG, null);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    specialAbilities.put(BattleForceSPA.TAG, null);</b>
&nbsp;                }
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if (weapon.getDamage() == WeaponType.DAMAGE_ARTILLERY) {</b>
<b class="nc">&nbsp;                addArtillery(weapon);</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (weapon instanceof ArtilleryBayWeapon) {</b>
<b class="nc">&nbsp;                for (int index : mount.getBayWeapons()) {</b>
<b class="nc">&nbsp;                    Mounted m = en.getEquipment(index);</b>
<b class="nc">&nbsp;                    if (m.getType() instanceof WeaponType) {</b>
<b class="nc">&nbsp;                        addArtillery((WeaponType)m.getType());</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if (weapon.getAmmoType() == AmmoType.T_BA_MICRO_BOMB) {</b>
<b class="nc">&nbsp;                bombRacks++;</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if (weapon.getAmmoType() == AmmoType.T_TASER) {</b>
<b class="nc">&nbsp;                if (en instanceof BattleArmor) {</b>
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.BTA, 1, Integer::sum);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.MTA, 1, Integer::sum);</b>
&nbsp;                }
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if (weapon.hasFlag(WeaponType.F_TSEMP)) {</b>
<b class="nc">&nbsp;                if (weapon.hasFlag(WeaponType.F_ONESHOT)) {</b>
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.TSEMPO, 1, Integer::sum);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    specialAbilities.merge(BattleForceSPA.TSEMP, 1, Integer::sum);</b>
&nbsp;                }
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if (weapon instanceof InfantryAttack) {</b>
<b class="nc">&nbsp;                specialAbilities.put(BattleForceSPA.AM, null);</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
&nbsp;            // Check ammo weapons first since they had a hidden modifier
<b class="nc">&nbsp;            if ((weapon.getAmmoType() != AmmoType.T_NA)</b>
<b class="nc">&nbsp;                    &amp;&amp; !weapon.hasFlag(WeaponType.F_ONESHOT)</b>
&nbsp;                    &amp;&amp; (!(en instanceof BattleArmor) || weapon instanceof MissileWeapon)) {
<b class="nc">&nbsp;                if (!ammoForWeapon.containsKey(weapon.getName())) {</b>
<b class="nc">&nbsp;                    int weaponsForAmmo = 1;</b>
<b class="nc">&nbsp;                    for (int nextPos = 0; nextPos &lt; weaponsList.size(); nextPos++) {</b>
<b class="nc">&nbsp;                        if (nextPos == pos) {</b>
<b class="nc">&nbsp;                            continue;</b>
&nbsp;                        }
&nbsp;                        
<b class="nc">&nbsp;                        Mounted nextWeapon = weaponsList.get(nextPos);</b>
&nbsp;    
<b class="nc">&nbsp;                        if (nextWeapon == null) {</b>
<b class="nc">&nbsp;                            continue;</b>
&nbsp;                        }
&nbsp;    
<b class="nc">&nbsp;                        if (nextWeapon.getType().equals(weapon)) {</b>
<b class="nc">&nbsp;                            weaponsForAmmo++;</b>
&nbsp;                        }
&nbsp;    
&nbsp;                    }
<b class="nc">&nbsp;                    int ammoCount = 0;</b>
&nbsp;                    // Check if they have enough ammo for all the guns to last at
&nbsp;                    // least 10 rounds
<b class="nc">&nbsp;                    for (Mounted ammo : en.getAmmo()) {</b>
&nbsp;    
<b class="nc">&nbsp;                        AmmoType at = (AmmoType) ammo.getType();</b>
<b class="nc">&nbsp;                        if ((at.getAmmoType() == weapon.getAmmoType())</b>
<b class="nc">&nbsp;                                &amp;&amp; (at.getRackSize() == weapon.getRackSize())) {</b>
&nbsp;                            // RACs are always fired on 6 shot so that means you
&nbsp;                            // need 6 times the ammo to avoid the ammo damage
&nbsp;                            // modifier
<b class="nc">&nbsp;                            if (at.getAmmoType() == AmmoType.T_AC_ROTARY) {</b>
<b class="nc">&nbsp;                                ammoCount += at.getShots() / 6;</b>
<b class="nc">&nbsp;                            } else if (at.getAmmoType() == AmmoType.T_AC_ULTRA</b>
<b class="nc">&nbsp;                                    || at.getAmmoType() == AmmoType.T_AC_ULTRA_THB) {</b>
<b class="nc">&nbsp;                                ammoCount += at.getShots() / 2;</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                ammoCount += at.getShots();</b>
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
&nbsp;    
<b class="nc">&nbsp;                    ammoForWeapon.put(weapon.getName(), (ammoCount / weaponsForAmmo) &gt;= 10);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!ammoForWeapon.get(weapon.getName())) {</b>
<b class="nc">&nbsp;                    damageModifier *= 0.75;</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (weapon.hasFlag(WeaponType.F_ONESHOT)) {</b>
<b class="nc">&nbsp;                damageModifier *= .1;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            if (weapon instanceof BayWeapon) {</b>
<b class="nc">&nbsp;                for (int index : mount.getBayWeapons()) {</b>
<b class="nc">&nbsp;                    Mounted m = en.getEquipment(index);</b>
<b class="nc">&nbsp;                    if (m.getType() instanceof WeaponType) {</b>
<b class="nc">&nbsp;                        for (int r = 0; r &lt; rangeBands; r++) {</b>
<b class="nc">&nbsp;                            baseDamage[r] += ((WeaponType)m.getType()).getBattleForceDamage(ranges[r], m.getLinkedBy());</b>
<b class="nc">&nbsp;                            heat[r] += ((WeaponType)m.getType()).getBattleForceHeatDamage(ranges[r]);</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            } else {
<b class="nc">&nbsp;                for (int r = 0; r &lt; rangeBands; r++) {</b>
<b class="nc">&nbsp;                    if (en instanceof BattleArmor) {</b>
<b class="nc">&nbsp;                        baseDamage[r] = getBattleArmorDamage(weapon, ranges[r], ((BattleArmor)en),</b>
<b class="nc">&nbsp;                                mount.isAPMMounted());</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        baseDamage[r] = weapon.getBattleForceDamage(ranges[r], mount.getLinkedBy());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    heat[r] += weapon.getBattleForceHeatDamage(ranges[r]);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // Targetting Computer
<b class="nc">&nbsp;            if (hasTC &amp;&amp; weapon.hasFlag(WeaponType.F_DIRECT_FIRE)</b>
<b class="nc">&nbsp;                    &amp;&amp; (weapon.getAmmoType() != AmmoType.T_AC_LBX)</b>
<b class="nc">&nbsp;                    &amp;&amp; (weapon.getAmmoType() != AmmoType.T_AC_LBX_THB)) {</b>
<b class="nc">&nbsp;                damageModifier *= 1.10;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            for (int loc = 0; loc &lt; weaponLocations.length; loc++) {</b>
<b class="nc">&nbsp;                double locMultiplier = locationMultiplier(en, loc, mount);</b>
<b class="nc">&nbsp;                if (locMultiplier == 0) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                for (int r = 0; r &lt; rangeBands; r++) {</b>
<b class="nc">&nbsp;                    double dam = baseDamage[r] * damageModifier * locMultiplier;</b>
<b class="nc">&nbsp;                    if (!weapon.isCapital()) {</b>
<b class="nc">&nbsp;                        weaponLocations[loc].addDamage(r, dam);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (weapon.getBattleForceClass() == WeaponType.BFCLASS_MML) {</b>
<b class="nc">&nbsp;                        if (r == RANGE_BAND_SHORT) {</b>
<b class="nc">&nbsp;                            weaponLocations[loc].addDamage(WeaponType.BFCLASS_SRM, r, dam);</b>
<b class="nc">&nbsp;                        } else if (r == RANGE_BAND_MEDIUM) {</b>
<b class="nc">&nbsp;                            weaponLocations[loc].addDamage(WeaponType.BFCLASS_SRM, r, dam / 2.0);</b>
<b class="nc">&nbsp;                            weaponLocations[loc].addDamage(WeaponType.BFCLASS_LRM, r, dam / 2.0);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            weaponLocations[loc].addDamage(WeaponType.BFCLASS_LRM, r, dam);                            </b>
&nbsp;                        }
&nbsp;                    } else {
<b class="nc">&nbsp;                        weaponLocations[loc].addDamage(weapon.getBattleForceClass(), r, dam);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (r == RANGE_BAND_LONG &amp;&amp; !(en instanceof Aero) &amp;&amp; weapon.hasIndirectFire()) {</b>
<b class="nc">&nbsp;                        weaponLocations[loc].addIF(dam);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (en instanceof Aero &amp;&amp; weapon.getAtClass() == WeaponType.CLASS_POINT_DEFENSE) {</b>
<b class="nc">&nbsp;                pointDefense += baseDamage[RANGE_BAND_SHORT] * damageModifier;</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (en.getEntityType() == Entity.ETYPE_INFANTRY) {</b>
<b class="nc">&nbsp;            int baseRange = 0;</b>
<b class="nc">&nbsp;            if (((Infantry)en).getSecondaryWeapon() != null &amp;&amp; ((Infantry)en).getSecondaryN() &gt;= 2) {</b>
<b class="nc">&nbsp;                baseRange = ((Infantry)en).getSecondaryWeapon().getInfantryRange();</b>
<b class="nc">&nbsp;            } else if (((Infantry)en).getPrimaryWeapon() != null){</b>
<b class="nc">&nbsp;                baseRange = ((Infantry)en).getPrimaryWeapon().getInfantryRange();</b>
&nbsp;            }
<b class="nc">&nbsp;            int range = baseRange * 3;</b>
<b class="nc">&nbsp;            for (int r = 0; r &lt; STANDARD_RANGES.length; r++) {</b>
<b class="nc">&nbsp;                if (range &gt;= STANDARD_RANGES[r]) {</b>
<b class="nc">&nbsp;                    weaponLocations[0].addDamage(r, getConvInfantryStandardDamage(STANDARD_RANGES[r],</b>
&nbsp;                            (Infantry)en));
&nbsp;                } else {
&nbsp;                    break;
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (en instanceof BattleArmor) {</b>
<b class="nc">&nbsp;            int vibroClaws = en.countWorkingMisc(MiscType.F_VIBROCLAW);</b>
<b class="nc">&nbsp;            if (vibroClaws &gt; 0) {</b>
<b class="nc">&nbsp;                weaponLocations[0].addDamage(0, vibroClaws);</b>
<b class="nc">&nbsp;                weaponLocations[0].addDamage(WeaponType.BFCLASS_STANDARD, 0, vibroClaws);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (bombRacks &gt; 0) {</b>
<b class="nc">&nbsp;                specialAbilities.put(BattleForceSPA.BOMB,</b>
<b class="nc">&nbsp;                        (bombRacks * ((BattleArmor)en).getShootingStrength()) / 5);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (en instanceof Aero &amp;&amp; pointDefense &gt; 0) {</b>
<b class="nc">&nbsp;            specialAbilities.put(BattleForceSPA.PNT, (int)Math.ceil(pointDefense / 10.0));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        adjustForHeat(en);</b>
&nbsp;        //Rules state that all flamer and plasma weapons on the unit contribute to the heat rating, so we don&#39;t separate by arc
<b class="nc">&nbsp;        if (heat[RANGE_BAND_SHORT] &gt; 10) {</b>
<b class="nc">&nbsp;            specialAbilities.put(BattleForceSPA.HT, 2);</b>
<b class="nc">&nbsp;        } else if (heat[RANGE_BAND_SHORT] &gt; 5) {</b>
<b class="nc">&nbsp;            specialAbilities.put(BattleForceSPA.HT, 1);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    protected double locationMultiplier(Entity en, int loc, Mounted mount) {
<b class="nc">&nbsp;    	return en.getBattleForceLocationMultiplier(loc, mount.getLocation(), mount.isRearMounted());</b>
&nbsp;    }
&nbsp;    
&nbsp;    protected void addArtillery(WeaponType weapon) {
<b class="nc">&nbsp;        BattleForceSPA artType = null;</b>
<b class="nc">&nbsp;        switch (weapon.getAmmoType()) {</b>
&nbsp;        case AmmoType.T_ARROW_IV:
<b class="nc">&nbsp;            if (weapon.getInternalName().substring(0, 1).equals(&quot;C&quot;)) {</b>
<b class="nc">&nbsp;                artType = BattleForceSPA.ARTAC;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                artType = BattleForceSPA.ARTAIS;</b>
&nbsp;            }
<b class="nc">&nbsp;            break;</b>
&nbsp;        case AmmoType.T_LONG_TOM:
<b class="nc">&nbsp;            artType = BattleForceSPA.ARTLT;</b>
<b class="nc">&nbsp;            break;</b>
&nbsp;        case AmmoType.T_SNIPER:
<b class="nc">&nbsp;            artType = BattleForceSPA.ARTS;</b>
<b class="nc">&nbsp;            break;</b>
&nbsp;        case AmmoType.T_THUMPER:
<b class="nc">&nbsp;            artType = BattleForceSPA.ARTT;</b>
<b class="nc">&nbsp;            break;</b>
&nbsp;        case AmmoType.T_LONG_TOM_CANNON:
<b class="nc">&nbsp;            artType = BattleForceSPA.ARTLTC;</b>
<b class="nc">&nbsp;            break;</b>
&nbsp;        case AmmoType.T_SNIPER_CANNON:
<b class="nc">&nbsp;            artType = BattleForceSPA.ARTSC;</b>
<b class="nc">&nbsp;            break;</b>
&nbsp;        case AmmoType.T_THUMPER_CANNON:
<b class="nc">&nbsp;            artType = BattleForceSPA.ARTTC;</b>
<b class="nc">&nbsp;            break;</b>
&nbsp;        case AmmoType.T_CRUISE_MISSILE:
<b class="nc">&nbsp;            switch(weapon.getRackSize()) {</b>
&nbsp;            case 50:
<b class="nc">&nbsp;                artType = BattleForceSPA.ARTCM5;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case 70:
<b class="nc">&nbsp;                artType = BattleForceSPA.ARTCM7;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case 90:
<b class="nc">&nbsp;                artType = BattleForceSPA.ARTCM9;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case 120:
<b class="nc">&nbsp;                artType = BattleForceSPA.ARTCM12;</b>
&nbsp;                break;
&nbsp;            }
&nbsp;        case AmmoType.T_BA_TUBE:
<b class="nc">&nbsp;            artType = BattleForceSPA.ARTBA;</b>
&nbsp;            break;
&nbsp;        }
<b class="nc">&nbsp;        if (artType != null) {</b>
<b class="nc">&nbsp;            specialAbilities.merge(artType, 1, Integer::sum);</b>
&nbsp;        }        
&nbsp;    }
&nbsp;    
&nbsp;    /* BattleForce and AlphaStrike calculate infantry damage differently */
&nbsp;    protected double getConvInfantryStandardDamage(int range, Infantry inf) {
<b class="nc">&nbsp;        if (inf.getPrimaryWeapon() == null) {</b>
<b class="nc">&nbsp;            int baseDamage = (int)Math.ceil(inf.getDamagePerTrooper() * inf.getShootingStrength());</b>
<b class="nc">&nbsp;            return Compute.calculateClusterHitTableAmount(7, baseDamage) / 10.0;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    protected double getBattleArmorDamage(WeaponType weapon, int range, BattleArmor ba,
&nbsp;            boolean apmMounted) {
<b class="nc">&nbsp;        return weapon.getBattleForceDamage(range,</b>
<b class="nc">&nbsp;                ba.getShootingStrength());        </b>
&nbsp;    }
&nbsp;    
&nbsp;    protected void adjustForHeat(Entity en) {
&nbsp;        double totalHeat;
<b class="nc">&nbsp;        totalHeat = en.getBattleForceTotalHeatGeneration(false) - 4;</b>
<b class="nc">&nbsp;        int heatCapacity = calcHeatCapacity(en);</b>
<b class="nc">&nbsp;        if (totalHeat &gt; heatCapacity) {</b>
<b class="nc">&nbsp;            double adjustment = heatCapacity / totalHeat;</b>
<b class="nc">&nbsp;            for (int loc = 0; loc &lt; weaponLocations.length; loc++) {</b>
<b class="nc">&nbsp;                if (en.isBattleForceRearLocation(loc)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (en instanceof Mech || en.getEntityType() == Entity.ETYPE_AERO) {</b>
<b class="nc">&nbsp;                    int rangeIndex = 1;</b>
<b class="nc">&nbsp;                    int base = (int)Math.round(weaponLocations[loc].getDamage(1));</b>
<b class="nc">&nbsp;                    if (base == 0) {</b>
<b class="nc">&nbsp;                        rangeIndex = 0;</b>
<b class="nc">&nbsp;                        base = (int)Math.round(weaponLocations[loc].getDamage(0));                        </b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (base == 0) {</b>
<b class="nc">&nbsp;                        continue;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    int heatAdjusted = (int)Math.round(weaponLocations[loc].getDamage(rangeIndex) * adjustment);</b>
<b class="nc">&nbsp;                    if (heatAdjusted &lt; base) {</b>
<b class="nc">&nbsp;                        weaponLocations[loc].overheat = Math.min(base - heatAdjusted, 4);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                weaponLocations[loc].adjustForHeat(adjustment);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (weaponLocations[0].getOverheat() &gt; 0</b>
<b class="nc">&nbsp;                &amp;&amp; (en instanceof Mech || en.getEntityType() == Entity.ETYPE_AERO)) {</b>
<b class="nc">&nbsp;            int heatLong = en.getWeaponList().stream()</b>
<b class="nc">&nbsp;                    .filter(m -&gt; m.getType() instanceof WeaponType</b>
<b class="nc">&nbsp;                            &amp;&amp; !m.isRearMounted()</b>
<b class="nc">&nbsp;                            &amp;&amp; !en.isBattleForceRearLocation(m.getLocation()))</b>
<b class="nc">&nbsp;                    .map(m -&gt; (WeaponType)m.getType())</b>
<b class="nc">&nbsp;                    .filter(w -&gt; w.getLongRange() &gt;= MEDIUM_RANGE)</b>
<b class="nc">&nbsp;                    .mapToInt(WeaponType::getHeat)</b>
<b class="nc">&nbsp;                    .sum();</b>
<b class="nc">&nbsp;            if (heatLong - 4 &gt; heatCapacity) {</b>
<b class="nc">&nbsp;                specialAbilities.put(BattleForceSPA.OVL, null);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public int calcHeatCapacity(Entity en) {
<b class="nc">&nbsp;        int capacity = en.getHeatCapacity();</b>
<b class="nc">&nbsp;        for (Mounted mounted : en.getEquipment()) {</b>
<b class="nc">&nbsp;            if (mounted.getType() instanceof AmmoType</b>
<b class="nc">&nbsp;                    &amp;&amp; ((AmmoType)mounted.getType()).getAmmoType() == AmmoType.T_COOLANT_POD) {</b>
<b class="nc">&nbsp;                capacity++;</b>
<b class="nc">&nbsp;            } else if (mounted.getType() instanceof MiscType</b>
<b class="nc">&nbsp;                    &amp;&amp; mounted.getType().hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</b>
<b class="nc">&nbsp;                capacity += 1;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return capacity;</b>
&nbsp;    }
&nbsp;
&nbsp;    public double calculatePointValue(Entity en) {
<b class="nc">&nbsp;        return en.calculateBattleValue(true, true) / 100.0;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public String getBFDamageString(int loc) {
<b class="nc">&nbsp;        StringBuilder str = new StringBuilder(locationNames[loc]);</b>
<b class="nc">&nbsp;        if (locationNames[loc].length() &gt; 0) {</b>
<b class="nc">&nbsp;            str.append(&quot;(&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        str.append(weaponLocations[loc].formatDamageUp(WeaponType.BFCLASS_STANDARD));</b>
<b class="nc">&nbsp;        for (int i = WeaponType.BFCLASS_CAPITAL; i &lt; WeaponType.BFCLASS_NUM; i++) {</b>
<b class="nc">&nbsp;            if (weaponLocations[loc].hasDamageClass(i)) {</b>
<b class="nc">&nbsp;                str.append(&quot;;&quot;).append(WeaponType.BF_CLASS_NAMES[i])</b>
<b class="nc">&nbsp;                    .append(weaponLocations[loc].formatDamageUp(i));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        for (int i = 1; i &lt; WeaponType.BFCLASS_CAPITAL; i++) {</b>
<b class="nc">&nbsp;            if (weaponLocations[loc].hasDamageClassRounded(i)) {</b>
<b class="nc">&nbsp;                str.append(&quot;;&quot;).append(WeaponType.BF_CLASS_NAMES[i])</b>
<b class="nc">&nbsp;                    .append(weaponLocations[loc].formatDamageRounded(i, false));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (weaponLocations[loc].getIF() &gt;= 0.5) {</b>
<b class="nc">&nbsp;            str.append(&quot;;IF&quot;).append((int)Math.round(weaponLocations[loc].getIF()));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (locationNames[loc].length() &gt; 0) {</b>
<b class="nc">&nbsp;            str.append(&quot;)&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return str.toString();</b>
&nbsp;    }
&nbsp;    
&nbsp;    protected String getASRangeString(double[] damage) {
<b class="nc">&nbsp;        return IntStream.range(0, damage.length).mapToDouble(i -&gt; damage[i] / 10.0)</b>
<b class="nc">&nbsp;                .mapToObj(d -&gt; {</b>
<b class="nc">&nbsp;                    if (d &gt; 0.5) {</b>
<b class="nc">&nbsp;                        return Integer.toString((int)Math.round(d));</b>
<b class="nc">&nbsp;                    } else if (d &gt; 0) {</b>
<b class="nc">&nbsp;                        return &quot;0*&quot;;</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        return &quot;0&quot;;</b>
&nbsp;                    }
<b class="nc">&nbsp;                }).collect(Collectors.joining(&quot;/&quot;));</b>
&nbsp;    }
&nbsp;    
&nbsp;    public void writeCsv(BufferedWriter w) throws IOException {
<b class="nc">&nbsp;        w.write(name);</b>
<b class="nc">&nbsp;        w.write(&quot;\t&quot;);</b>
<b class="nc">&nbsp;        w.write(Integer.toString(size));</b>
<b class="nc">&nbsp;        w.write(&quot;\t&quot;);</b>
<b class="nc">&nbsp;        w.write(getMovementAsString());</b>
<b class="nc">&nbsp;        w.write(&quot;\t&quot;);</b>
<b class="nc">&nbsp;        w.write(Integer.toString(getFinalArmor()));</b>
<b class="nc">&nbsp;        if (threshold &gt;= 0) {</b>
<b class="nc">&nbsp;            w.write(&quot;-&quot; + (int)Math.ceil(threshold));//TODO: threshold</b>
&nbsp;        }
<b class="nc">&nbsp;        w.write(&quot;\t&quot;);</b>
<b class="nc">&nbsp;        w.write(Integer.toString(structure));</b>
<b class="nc">&nbsp;        w.write(&quot;\t&quot;);</b>
<b class="nc">&nbsp;        StringJoiner sj = new StringJoiner(&quot;, &quot;);</b>
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; weaponLocations.length; loc++) {</b>
<b class="nc">&nbsp;            StringBuilder str = new StringBuilder();</b>
<b class="nc">&nbsp;            String damStr = getBFDamageString(loc);</b>
<b class="nc">&nbsp;            if (weaponLocations[loc].hasDamageRounded()) {</b>
<b class="nc">&nbsp;                str.append(damStr);</b>
<b class="nc">&nbsp;                sj.add(str.toString());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (sj.length() &gt; 0) {</b>
<b class="nc">&nbsp;            w.write(sj.toString());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            w.write(rangeBands &gt; 3? &quot;0/0/0/0&quot; : &quot;0/0/0&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        w.write(&quot;\t&quot;);</b>
<b class="nc">&nbsp;        sj = new StringJoiner(&quot;, &quot;);</b>
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; weaponLocations.length; loc++) {</b>
<b class="nc">&nbsp;            if (weaponLocations[loc].getOverheat() &gt;= 1) {</b>
<b class="nc">&nbsp;                sj.add(locationNames[loc] + Math.max(4, (int)Math.round(weaponLocations[loc].getOverheat())));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (sj.length() &gt; 0) {</b>
<b class="nc">&nbsp;            w.write(sj.toString());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            w.write(&quot;-&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        w.write(&quot;\t&quot;);</b>
<b class="nc">&nbsp;        w.write(Integer.toString(getFinalPoints()));</b>
<b class="nc">&nbsp;        w.write(&quot;\t&quot;);</b>
<b class="nc">&nbsp;        w.write(specialAbilities.keySet().stream()</b>
<b class="nc">&nbsp;                .filter(spa -&gt; spa.usedByBattleForce()</b>
<b class="nc">&nbsp;                        &amp;&amp; !spa.isDoor())</b>
<b class="nc">&nbsp;                .map(spa -&gt; formatSPAString(spa))</b>
<b class="nc">&nbsp;                .collect(Collectors.joining(&quot;, &quot;)));</b>
<b class="nc">&nbsp;        w.newLine();</b>
&nbsp;    }
&nbsp;    
&nbsp;    protected String formatSPAString(BattleForceSPA spa) {
<b class="nc">&nbsp;        Integer val = specialAbilities.get(spa);</b>
<b class="nc">&nbsp;        if (val == null) {</b>
<b class="nc">&nbsp;            return spa.toString();</b>
&nbsp;        }
<b class="nc">&nbsp;        switch (spa) {</b>
&nbsp;        case AT:
&nbsp;        case MT:
&nbsp;        case PT:
&nbsp;        case ST:
&nbsp;        case VTM:
&nbsp;        case VTH:
<b class="nc">&nbsp;            return spa.toString() + val + &quot;D&quot; + specialAbilities.get(spa.getDoor());</b>
&nbsp;        case CT:
<b class="nc">&nbsp;            if (val &gt;= 1000) {</b>
<b class="nc">&nbsp;                return &quot;CK&quot; + (val / 1000.0) + &quot;D&quot; + specialAbilities.get(spa.getDoor());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return spa.toString() + val + &quot;D&quot; + specialAbilities.get(spa.getDoor());</b>
&nbsp;            }
&nbsp;        case MHQ:
<b class="nc">&nbsp;            return spa.toString() + (val / 2);</b>
&nbsp;        default:
<b class="nc">&nbsp;            return spa.toString() + val;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    protected class WeaponLocation {</b>
<b class="nc">&nbsp;        List&lt;Double&gt; standardDamage = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        Map&lt;Integer,List&lt;Double&gt;&gt; specialDamage = new HashMap&lt;&gt;();</b>
&nbsp;        double indirect;
&nbsp;        double overheat;
&nbsp;        
&nbsp;        public boolean hasStandardDamage() {
<b class="nc">&nbsp;            return standardDamage.stream().mapToDouble(Double::doubleValue).sum() &gt; 0;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public boolean hasStandardDamageRounded() {
<b class="nc">&nbsp;            return standardDamage.stream()</b>
<b class="nc">&nbsp;                    .filter(d -&gt; d &gt;= 0.5)</b>
<b class="nc">&nbsp;                    .mapToDouble(Double::doubleValue).sum() &gt; 0;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public boolean hasDamage() {
<b class="nc">&nbsp;        	return hasStandardDamage()</b>
<b class="nc">&nbsp;        			|| specialDamage.keySet().stream().anyMatch(dc -&gt; hasDamageClass(dc));</b>
&nbsp;        }
&nbsp;        
&nbsp;        public boolean hasDamageRounded() {
<b class="nc">&nbsp;        	return hasStandardDamageRounded()</b>
<b class="nc">&nbsp;        			|| specialDamage.keySet().stream().anyMatch(dc -&gt; hasDamageClassRounded(dc));</b>
&nbsp;        }
&nbsp;        
&nbsp;        public boolean hasDamageClass(int damageClass) {
<b class="nc">&nbsp;            return specialDamage.containsKey(damageClass)</b>
<b class="nc">&nbsp;                    &amp;&amp; specialDamage.get(damageClass).stream().mapToDouble(Double::doubleValue).sum() &gt; 0;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public boolean hasDamageClassRounded(int damageClass) {
<b class="nc">&nbsp;            return specialDamage.containsKey(damageClass)</b>
<b class="nc">&nbsp;                    &amp;&amp; specialDamage.get(damageClass).stream()</b>
<b class="nc">&nbsp;                    .filter(d -&gt; d &gt;= 0.5)</b>
<b class="nc">&nbsp;                    .mapToDouble(Double::doubleValue).sum() &gt; 0;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public void addDamage(int rangeIndex, double val) {
<b class="nc">&nbsp;            addDamage(standardDamage, rangeIndex, val);</b>
&nbsp;        }
&nbsp;        
&nbsp;        public void addDamage(int damageClass, int rangeIndex, double val) {
<b class="nc">&nbsp;            if (!specialDamage.containsKey(damageClass)) {</b>
<b class="nc">&nbsp;                specialDamage.put(damageClass, new ArrayList&lt;Double&gt;());</b>
&nbsp;            }
<b class="nc">&nbsp;            addDamage(specialDamage.get(damageClass), rangeIndex, val);</b>
&nbsp;        }
&nbsp;        
&nbsp;        public double getDamage(int rangeIndex) {
<b class="nc">&nbsp;            if (standardDamage.size() &gt; rangeIndex) {</b>
<b class="nc">&nbsp;                return standardDamage.get(rangeIndex);</b>
&nbsp;            }
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public double getDamage(int damageClass, int rangeIndex) {
<b class="nc">&nbsp;            if (specialDamage.containsKey(damageClass)</b>
<b class="nc">&nbsp;                    &amp;&amp; specialDamage.get(damageClass).size() &gt; rangeIndex) {</b>
<b class="nc">&nbsp;                return specialDamage.get(damageClass).get(rangeIndex);</b>
&nbsp;            }
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public String formatDamageUp() {
<b class="nc">&nbsp;            return formatDamageUp(standardDamage);</b>
&nbsp;        }
&nbsp;
&nbsp;        public String formatDamageUp(int damageClass) {
<b class="nc">&nbsp;            if (specialDamage.containsKey(damageClass)) {</b>
<b class="nc">&nbsp;                return formatDamageUp(specialDamage.get(damageClass));</b>
&nbsp;            }
<b class="nc">&nbsp;            return rangeBands &gt; 3? &quot;0/0/0/0&quot; : &quot;0/0/0&quot;;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public String formatDamageRounded(boolean showMinDamage) {
<b class="nc">&nbsp;            return formatDamageRounded(standardDamage, showMinDamage);</b>
&nbsp;        }
&nbsp;
&nbsp;        public String formatDamageRounded(int damageClass, boolean showMinDamage) {
<b class="nc">&nbsp;            if (specialDamage.containsKey(damageClass)) {</b>
<b class="nc">&nbsp;                return formatDamageRounded(specialDamage.get(damageClass), showMinDamage);</b>
&nbsp;            }
<b class="nc">&nbsp;            return rangeBands &gt; 3? &quot;0/0/0/0&quot; : &quot;0/0/0&quot;;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public double getIF() {
<b class="nc">&nbsp;            return indirect;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public void addIF(double val) {
<b class="nc">&nbsp;            indirect += val;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public double getOverheat() {
<b class="nc">&nbsp;            return overheat;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public void setOverheat(double val) {
<b class="nc">&nbsp;            overheat = val;</b>
&nbsp;        }
&nbsp;        
&nbsp;        public void adjustForHeat(double mul) {
<b class="nc">&nbsp;            for (int i = 0; i &lt; standardDamage.size(); i++) {</b>
<b class="nc">&nbsp;                standardDamage.set(i, standardDamage.get(i) * mul);</b>
&nbsp;            }
<b class="nc">&nbsp;            for (List&lt;Double&gt; damage : specialDamage.values()) {</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt; damage.size(); i++) {</b>
<b class="nc">&nbsp;                    damage.set(i, damage.get(i) * mul);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;        
&nbsp;        private void addDamage(List&lt;Double&gt; damage, int rangeIndex, double val) {
<b class="nc">&nbsp;            while (damage.size() &lt;= rangeIndex) {</b>
<b class="nc">&nbsp;                damage.add(0.0);</b>
&nbsp;            }
<b class="nc">&nbsp;            damage.set(rangeIndex, damage.get(rangeIndex) + val);</b>
&nbsp;        }
&nbsp;        
&nbsp;        private String formatDamageUp(List&lt;Double&gt; damage) {
<b class="nc">&nbsp;            while (damage.size() &lt; rangeBands) {</b>
<b class="nc">&nbsp;                damage.add(0.0);</b>
&nbsp;            }
<b class="nc">&nbsp;            return damage.stream().map(d -&gt; String.valueOf((int)Math.ceil(d)))</b>
<b class="nc">&nbsp;                    .collect(Collectors.joining(&quot;/&quot;));</b>
&nbsp;        }
&nbsp;
&nbsp;        private String formatDamageRounded(List&lt;Double&gt; damage, boolean showMinDamage) {
<b class="nc">&nbsp;            while (damage.size() &lt; rangeBands) {</b>
<b class="nc">&nbsp;                damage.add(0.0);</b>
&nbsp;            }
<b class="nc">&nbsp;            return damage.stream().map(d -&gt; {</b>
<b class="nc">&nbsp;                if (d == 0) {</b>
<b class="nc">&nbsp;                    return &quot;0&quot;;</b>
<b class="nc">&nbsp;                } else if (d &lt; 0.5 &amp;&amp; showMinDamage) {</b>
<b class="nc">&nbsp;                    return &quot;0*&quot;;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return String.valueOf((int)Math.round(d));</b>
&nbsp;                }
<b class="nc">&nbsp;            }).collect(Collectors.joining(&quot;/&quot;));</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-05-16 16:28</div>
</div>
</body>
</html>
